<html>
<head><meta charset="utf-8"><title>`tt::TokenTree` to `ast::TokenTree` · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html">`tt::TokenTree` to `ast::TokenTree`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="220381254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381254" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381254">(Dec 18 2020 at 14:58)</a>:</h4>
<p>I need to go from the types in the <code>tt</code> crate, back to CST nodes, in order to reparse an attribute. Is there any preexisting way to do so? If not, what would be the best place to put this functionality? Do we even want to allow this?</p>
<p>I've seen <code>ast::Path::parse</code> etc., but those only work with macro fragments.</p>



<a name="220381311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381311">(Dec 18 2020 at 14:59)</a>:</h4>
<p>Hm....</p>



<a name="220381327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381327" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381327">(Dec 18 2020 at 14:59)</a>:</h4>
<p>My gut feeling is that we should do exactly the opposite</p>



<a name="220381346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381346" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381346">(Dec 18 2020 at 14:59)</a>:</h4>
<p>Attributes should be parasable out of <code>tt</code>s</p>



<a name="220381363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381363" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381363">(Dec 18 2020 at 14:59)</a>:</h4>
<p>(I think they actually are?)</p>



<a name="220381478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381478" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381478">(Dec 18 2020 at 15:00)</a>:</h4>
<p>I could make them parseable from <code>tt</code> types, I think</p>



<a name="220381509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381509" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381509">(Dec 18 2020 at 15:00)</a>:</h4>
<p>They only contain <code>tt</code> types, at least, so it should be possible</p>



<a name="220381625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381625" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381625">(Dec 18 2020 at 15:01)</a>:</h4>
<p>Could you tell why you need that?</p>



<a name="220381654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381654" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381654">(Dec 18 2020 at 15:01)</a>:</h4>
<p>Is this <code>cfg_attr</code>?</p>



<a name="220381721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381721" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381721">(Dec 18 2020 at 15:01)</a>:</h4>
<p>Yeah</p>



<a name="220381810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381810" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381810">(Dec 18 2020 at 15:02)</a>:</h4>
<p>I'm trying to avoid having two parsers for this syntax, so I wanted to reuse the existing one</p>



<a name="220381910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381910" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381910">(Dec 18 2020 at 15:03)</a>:</h4>
<p>Uhu...</p>



<a name="220381972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220381972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220381972">(Dec 18 2020 at 15:03)</a>:</h4>
<p>Hm, otoh, making a <code>fragment</code> for that would also work</p>



<a name="220383092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220383092" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220383092">(Dec 18 2020 at 15:12)</a>:</h4>
<p>The <code>make</code> API also <em>sometimes</em> provides raw parsers, maybe it should be added there? Not entirely sure what the difference between that and the <code>parse</code> functions is, the latter look macro-specific</p>



<a name="220383238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220383238" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220383238">(Dec 18 2020 at 15:13)</a>:</h4>
<p>Looks like this is not going to work with <code>None</code> delimiters in any case</p>



<a name="220384556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220384556" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220384556">(Dec 18 2020 at 15:25)</a>:</h4>
<p><span class="user-mention" data-user-id="211727">@Jonas Schievink</span> all raw parsers in <code>make</code> should be private</p>



<a name="220384609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220384609" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220384609">(Dec 18 2020 at 15:25)</a>:</h4>
<p>Currently there's these:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">name</span><span class="p">(</span><span class="n">text</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ast</span>::<span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ast_from_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">"mod {};"</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">name_ref</span><span class="p">(</span><span class="n">text</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ast</span>::<span class="n">NameRef</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ast_from_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">"fn f() {{ {}; }}"</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ty</span><span class="p">(</span><span class="n">text</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ast</span>::<span class="n">Type</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ast_from_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">"impl {} for D {{}};"</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="220385075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385075" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385075">(Dec 18 2020 at 15:29)</a>:</h4>
<p>The last one is a bug</p>



<a name="220385136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385136" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385136">(Dec 18 2020 at 15:29)</a>:</h4>
<p>The first two are not really parsers -- they produce a single indivisible node</p>



<a name="220385419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385419" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385419">(Dec 18 2020 at 15:31)</a>:</h4>
<p>I guess, <span class="user-mention" data-user-id="133169">@matklad</span> needs to document the invariants of <code>make</code>  module somewhere</p>



<a name="220385428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385428" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385428">(Dec 18 2020 at 15:32)</a>:</h4>
<p>Ah, right</p>



<a name="220385529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385529" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385529">(Dec 18 2020 at 15:32)</a>:</h4>
<p>Also, urgh, I wish there was some way to enforce "this shouldn't happen" properties in code...</p>



<a name="220385591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385591" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385591">(Dec 18 2020 at 15:33)</a>:</h4>
<p>keeping raw text methods of <code>make</code> priviate is a constant struggle</p>



<a name="220385649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385649" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385649">(Dec 18 2020 at 15:33)</a>:</h4>
<p>See also comment on <code>Name::new_text</code></p>



<a name="220385760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385760" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385760">(Dec 18 2020 at 15:34)</a>:</h4>
<p>yeah I did see that one</p>



<a name="220385791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220385791" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220385791">(Dec 18 2020 at 15:34)</a>:</h4>
<p>but <code>make::name("bla").as_name()</code> sidesteps that</p>



<a name="220386112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386112" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386112">(Dec 18 2020 at 15:36)</a>:</h4>
<p>Not really, <code>AsName</code> shouldn't exported to the IDE</p>



<a name="220386119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386119" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386119">(Dec 18 2020 at 15:36)</a>:</h4>
<p>(I think...)</p>



<a name="220386208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386208" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386208">(Dec 18 2020 at 15:37)</a>:</h4>
<p>(but also enforcing <code>AsName</code> should be inaccessible in <code>crates/ide</code> is hard)</p>



<a name="220386297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386297">(Dec 18 2020 at 15:38)</a>:</h4>
<p>Right, so we don't expose text parsers in <code>make</code> to prevent the IDE from parsing raw strings, not the compiler crates?</p>



<a name="220386368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386368" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386368">(Dec 18 2020 at 15:38)</a>:</h4>
<p>Not really</p>



<a name="220386408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386408" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386408">(Dec 18 2020 at 15:38)</a>:</h4>
<p>The primary goal here is that we want to switch to a fully-typed API in the future</p>



<a name="220386410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386410" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386410">(Dec 18 2020 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133169">matklad</span> <a href="#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60/near/220386208">said</a>:</p>
<blockquote>
<p>(but also enforcing <code>AsName</code> should be inaccessible in <code>crates/ide</code> is hard)</p>
</blockquote>
<p>I feel like adding a comment that explains this would already go a long way</p>



<a name="220386464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386464" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386464">(Dec 18 2020 at 15:39)</a>:</h4>
<p>Where we just assemble AST nodes from smaller AST nodes</p>



<a name="220386530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386530">(Dec 18 2020 at 15:39)</a>:</h4>
<p>We don't do this today because that's a whole lot of code to write by hand, and <code>parse . format!</code> is just shorter</p>



<a name="220386620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386620">(Dec 18 2020 at 15:40)</a>:</h4>
<p>THere' WIP PR by <span class="user-mention" data-user-id="300586">@Lukas Wirth</span> which uses ungrammar for that.</p>



<a name="220386732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220386732" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220386732">(Dec 18 2020 at 15:40)</a>:</h4>
<p><em>if</em> we expose raw text API, then refactoring later will be more painful. And we'll add a bunch of stringly-typed code patterns, which I think we should try to avoid.</p>



<a name="220394846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220394846" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220394846">(Dec 18 2020 at 16:35)</a>:</h4>
<p>So it seems like the <code>ast::Path::parse</code> et al should also be removed, since it parses a raw <code>&amp;str</code>, right?</p>



<a name="220395244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395244" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395244">(Dec 18 2020 at 16:38)</a>:</h4>
<p>Well, not really</p>



<a name="220395277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395277" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395277">(Dec 18 2020 at 16:38)</a>:</h4>
<p>Parsing a <code>Path</code> from string is a valid operation to ahve</p>



<a name="220395306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395306">(Dec 18 2020 at 16:38)</a>:</h4>
<p>(and, for example, intra-doc links fundamentally require it)</p>



<a name="220395377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395377" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395377">(Dec 18 2020 at 16:39)</a>:</h4>
<p>It's just the connection of making new AST nodes and parsing is a hack which shouldn't be exposed</p>



<a name="220395492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395492" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395492">(Dec 18 2020 at 16:39)</a>:</h4>
<p>Hmm, okay, not sure I understand</p>



<a name="220395740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395740" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395740">(Dec 18 2020 at 16:41)</a>:</h4>
<p>So imaging a <code>make</code> API which allows only creating tokens from strings</p>



<a name="220395771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395771" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395771">(Dec 18 2020 at 16:41)</a>:</h4>
<p>and all composite nodes require constituent elements</p>



<a name="220395829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395829">(Dec 18 2020 at 16:41)</a>:</h4>
<p>SO, to create <code>(A, B)</code>, you write <code>make::tuple_type(vec![a, b])</code></p>



<a name="220395909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395909" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395909">(Dec 18 2020 at 16:42)</a>:</h4>
<p>and that internallly assembles a tree using existing trees</p>



<a name="220395910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395910" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395910">(Dec 18 2020 at 16:42)</a>:</h4>
<p>Yeah, that does makes sense to me</p>



<a name="220395995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220395995" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220395995">(Dec 18 2020 at 16:42)</a>:</h4>
<p>In that world, the operation <code>parsre this bit of text as type</code> isn't really expressible and necessary.  If you want to create a type, you create it from smaller types</p>



<a name="220396022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396022" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396022">(Dec 18 2020 at 16:43)</a>:</h4>
<p>I just wonder why going from <code>&amp;str</code> to <code>ast::Path</code> is fine, since that's clearly not a token</p>



<a name="220396060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396060">(Dec 18 2020 at 16:43)</a>:</h4>
<p>Becausee that's parsing and not node creation</p>



<a name="220396147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396147" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396147">(Dec 18 2020 at 16:44)</a>:</h4>
<p>Hm, where <code>Path::parse</code> is actually defined?</p>



<a name="220396172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396172" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396172">(Dec 18 2020 at 16:44)</a>:</h4>
<p>It shoudl allow to return an error</p>



<a name="220396191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396191">(Dec 18 2020 at 16:44)</a>:</h4>
<p>while all <code>make</code> functions are infailable.</p>



<a name="220396215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396215" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396215">(Dec 18 2020 at 16:44)</a>:</h4>
<p>Ah, okay, so it needs to return a <code>Result</code></p>



<a name="220396224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396224">(Dec 18 2020 at 16:44)</a>:</h4>
<p>It does, I mean</p>



<a name="220396243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396243" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396243">(Dec 18 2020 at 16:44)</a>:</h4>
<p>Or a <code>ParseResult</code> would also work, I suppose</p>



<a name="220396247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396247" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396247">(Dec 18 2020 at 16:44)</a>:</h4>
<p>Ah, here it is</p>



<a name="220396250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396250">(Dec 18 2020 at 16:44)</a>:</h4>
<p><code>pub fn parse(text: &amp;str) -&gt; Result&lt;Self, ()&gt; {</code></p>



<a name="220396274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396274" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396274">(Dec 18 2020 at 16:45)</a>:</h4>
<p>Yeah, it needs some way to signal an error</p>



<a name="220396299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396299" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396299">(Dec 18 2020 at 16:45)</a>:</h4>
<p>This is one of the "won't fix " bugs today</p>



<a name="220396311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396311">(Dec 18 2020 at 16:45)</a>:</h4>
<p>Alright, yeah, that <em>does</em> make sense</p>



<a name="220396365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396365" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396365">(Dec 18 2020 at 16:45)</a>:</h4>
<p>Sometimes nodes are syntactically invalid. If you use invalid type to make, say, a <code>let x: ty = todo!()</code> expressions, and you go via <code>format!</code> in the middle</p>



<a name="220396421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396421" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396421">(Dec 18 2020 at 16:46)</a>:</h4>
<p>you might not parse <code>let x: </code> as a proper let statement</p>



<a name="220396436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396436" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396436">(Dec 18 2020 at 16:46)</a>:</h4>
<p>Node base editing should fix that problem</p>



<a name="220396522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396522" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396522">(Dec 18 2020 at 16:47)</a>:</h4>
<p>So, that sounds like we should replace calls to <code>make::ty</code> with <code>ast::Type::parse</code> then, right?</p>



<a name="220396692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396692" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396692">(Dec 18 2020 at 16:48)</a>:</h4>
<p>Not exactly</p>



<a name="220396722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396722" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396722">(Dec 18 2020 at 16:48)</a>:</h4>
<p>rather, with <code>make::ty_unit</code>, <code>make::ty_path</code>, etc</p>



<a name="220396782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396782" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396782">(Dec 18 2020 at 16:49)</a>:</h4>
<p>let me show a quick pr...</p>



<a name="220396946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396946">(Dec 18 2020 at 16:50)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/6931">https://github.com/rust-analyzer/rust-analyzer/pull/6931</a></p>



<a name="220396956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396956" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396956">(Dec 18 2020 at 16:50)</a>:</h4>
<p>Something like this</p>



<a name="220396965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396965" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396965">(Dec 18 2020 at 16:50)</a>:</h4>
<p>Basically, strongly-type the thing</p>



<a name="220396992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396992" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396992">(Dec 18 2020 at 16:50)</a>:</h4>
<p>rather than stringly-type the thing</p>



<a name="220396999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220396999" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220396999">(Dec 18 2020 at 16:50)</a>:</h4>
<p>yeah, that makes sense when possible</p>



<a name="220397138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397138" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397138">(Dec 18 2020 at 16:51)</a>:</h4>
<p>but this use here goes from <code>Type</code> to <code>ast::Type</code> <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/assists/src/ast_transform.rs#L109">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/assists/src/ast_transform.rs#L109</a></p>



<a name="220397196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397196" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397196">(Dec 18 2020 at 16:52)</a>:</h4>
<p>yeah...</p>



<a name="220397199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397199" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397199">(Dec 18 2020 at 16:52)</a>:</h4>
<p>I suppose we could make that a method on <code>Type</code></p>



<a name="220397209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397209" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397209">(Dec 18 2020 at 16:52)</a>:</h4>
<p>or something</p>



<a name="220397211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397211">(Dec 18 2020 at 16:52)</a>:</h4>
<p>Looking at that now, and urgh.</p>



<a name="220397239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397239" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397239">(Dec 18 2020 at 16:52)</a>:</h4>
<p>I <em>think</em> dispaly source code should return a SyntaxNode / ast::Something</p>



<a name="220397248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397248">(Dec 18 2020 at 16:52)</a>:</h4>
<p>probably</p>



<a name="220397303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397303" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397303">(Dec 18 2020 at 16:52)</a>:</h4>
<p><code>HirDispaly::    fn display_source_code&lt;'a&gt;</code> is the culprit here</p>



<a name="220397383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220397383" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220397383">(Dec 18 2020 at 16:53)</a>:</h4>
<p>ah, yeah</p>



<a name="220398029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220398029" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220398029">(Dec 18 2020 at 16:57)</a>:</h4>
<p>Well, I think it's fine to call <code>parse</code> inside <code>display_source_code</code> :D</p>



<a name="220398062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220398062" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220398062">(Dec 18 2020 at 16:57)</a>:</h4>
<p>and plan to think about this propertly later</p>



<a name="220398211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220398211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220398211">(Dec 18 2020 at 16:58)</a>:</h4>
<p>but yeah, I <em>think</em> that we probably should describe hir rendering in terms of syntax trees. This shoudl be more composable with complex refactors</p>



<a name="220775418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%60tt%3A%3ATokenTree%60%20to%20%60ast%3A%3ATokenTree%60/near/220775418" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://rust-lang.github.io/zulip_archive/stream/185405-t-compiler/rust-analyzer/topic/.60tt.3A.3ATokenTree.60.20to.20.60ast.3A.3ATokenTree.60.html#220775418">(Dec 23 2020 at 10:03)</a>:</h4>
<p><span class="user-mention" data-user-id="211727">@Jonas Schievink</span> submitted <a href="https://github.com/rust-analyzer/rust-analyzer/pull/7017">https://github.com/rust-analyzer/rust-analyzer/pull/7017</a> with doc clarifications</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>