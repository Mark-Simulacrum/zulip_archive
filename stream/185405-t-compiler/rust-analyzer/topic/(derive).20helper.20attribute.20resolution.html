<html>
<head><meta charset="utf-8"><title>(derive) helper attribute resolution · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html">(derive) helper attribute resolution</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263763005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263763005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263763005">(Dec 05 2021 at 11:09)</a>:</h4>
<p>So, a few days ago I removed logic that always highlighted attributes as attributes even if they didn't resolve, as we no resolve builtin(inert) attributes, but it turns out this is still required due to (derive) helper attributes, as these will now not get mapped down into the macro expansion resulting in unresolved references.<br>
This can be easily fixed for derive helpers specifically, as derive attributes actually have to declare these upfront, but for general attributes we don't have this, example being salsa using a bunch of helper attributes in its input for the query configurations.<br>
Now I was wondering if it would make sense to nudge proc-macro authors to expose or map these helper attributes down to aid IDEs. What I mean with this is, taking salsa as an example again, when you have the following snippet here:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[salsa::query_group(HirDatabaseStorage)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">HirDatabase</span>: <span class="nc">DefDatabase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Upcast</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">DefDatabase</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[salsa::invoke(infer_wait)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[salsa::transparent]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">infer</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">def</span>: <span class="nc">DefWithBodyId</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">InferenceResult</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Salsa could expose a dummy attribute that doesn't do anything under the paths <code>salsa::invoke</code> and <code>salsa::transparent</code> which we would simply resolve as we can't map them down to anything other in the macro expansion. This has the nice side benefit that the helpers can even be documented, providing docs on hover at the expense of having to expose more attributes from the main crate(in this case on the top level even).</p>
<p>cc <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10935">rust-analyzer#10935</a></p>



<a name="263763132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263763132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263763132">(Dec 05 2021 at 11:13)</a>:</h4>
<p>We might want to check on the IntelliJ folks here though and check what they do with these unresolved helper attributes and whether they could make use of this as well.</p>



<a name="263764345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263764345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263764345">(Dec 05 2021 at 11:44)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I surely would love <code>#[salsa::]</code> to get code completion as well...</p>



<a name="263764796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263764796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263764796">(Dec 05 2021 at 11:57)</a>:</h4>
<p>That's another aspect that might <em>just</em> work then as well? Since we can't downmap those attributes we will do completion inside the attribute input which is just a well formed item, so that should just work. I'll try experimenting with that.</p>



<a name="263772362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263772362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263772362">(Dec 05 2021 at 15:01)</a>:</h4>
<p>Apparently we never even had completions for attributes in the first place? <span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span></p>



<a name="263772634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263772634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263772634">(Dec 05 2021 at 15:07)</a>:</h4>
<p>Well after adding attribute completions to r-a, this seems to work together with an adjustment to salsa that makes it not error out on unknown helper attributes <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <a href="/user_uploads/4715/s2Ww506HVr1wq6ipTgjXVBzg/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/s2Ww506HVr1wq6ipTgjXVBzg/image.png" title="image.png"><img src="/user_uploads/4715/s2Ww506HVr1wq6ipTgjXVBzg/image.png"></a></div>



<a name="263772666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/%28derive%29%20helper%20attribute%20resolution/near/263772666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/(derive).20helper.20attribute.20resolution.html#263772666">(Dec 05 2021 at 15:07)</a>:</h4>
<p>(Note that r-a doesn't seem to take <code>compile_error!</code> spans into account here properly <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> )</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>