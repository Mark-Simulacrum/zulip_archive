<html>
<head><meta charset="utf-8"><title>Adjusting code completion to account for raw string literals · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html">Adjusting code completion to account for raw string literals</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251213327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/251213327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#251213327">(Aug 30 2021 at 11:09)</a>:</h4>
<p>Hey guys! First, happy to be a part of the rust-analyzer community! This is my first time using Zulip or the rust-analyzer channel for that matter so forgive me if I'm posting in the wrong place or not following proper convention.</p>
<p>I noticed rust-analyzer in VSCode isn't properly completing fields with raw string literals. For example, if you have a struct defined like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span>#<span class="k">type</span>: <span class="nb">String</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and you try to type out the code for reading the field in VSCode like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span>#<span class="k">type</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"example"</span><span class="p">)</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">t</span><span class="w"></span>
</code></pre></div>
<p>rust-analyzer and VSCode will show that the field <code>type</code> is an option. When pressing enter to auto complete, the text <code>type</code> will be inserted so that our code now looks like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span>#<span class="k">type</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"example"</span><span class="p">)</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="k">type</span>
</code></pre></div>
<p>but there is a problem here. <code>type</code> is a reserved identifier and so this is actually invalid rust code. I'd like to fix this so that when enter is pressed, raw string literals are used instead. The resulting code would instead be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Example</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span>#<span class="k">type</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"example"</span><span class="p">)</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">r</span>#<span class="k">type</span>
</code></pre></div>
<p>which would be valid rust.</p>
<p>My question is, where do I start? Is this something that should be handled in the VSCode extension? In the main rust-analyzer codebase?<br>
Also, do we actually want this feature in the first place? I see no problem with it but maybe someone else does.</p>
<p>Thanks!</p>



<a name="251213512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/251213512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#251213512">(Aug 30 2021 at 11:11)</a>:</h4>
<p>That's the right place for this, yeah!</p>



<a name="251213579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/251213579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#251213579">(Aug 30 2021 at 11:12)</a>:</h4>
<p>Completion lives around <a href="https://github.com/rust-analyzer/rust-analyzer/tree/master/crates/ide_completion/src/completions">https://github.com/rust-analyzer/rust-analyzer/tree/master/crates/ide_completion/src/completions</a></p>



<a name="251213665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/251213665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#251213665">(Aug 30 2021 at 11:13)</a>:</h4>
<p>Terminology note, those are raw identifiers, not raw string literals</p>



<a name="251213841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/251213841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#251213841">(Aug 30 2021 at 11:14)</a>:</h4>
<p>Relevant code for that is here <a href="https://github.com/rust-analyzer/rust-analyzer/blob/cbae5969417eba9c9fbaee0337c8f57e566fd286/crates/ide_completion/src/render.rs#L86">https://github.com/rust-analyzer/rust-analyzer/blob/cbae5969417eba9c9fbaee0337c8f57e566fd286/crates/ide_completion/src/render.rs#L86</a></p>



<a name="251213935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/251213935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#251213935">(Aug 30 2021 at 11:15)</a>:</h4>
<p>we should actually move that (and related test) to a sumbodule, so that it's easier to find</p>



<a name="252010668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252010668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252010668">(Sep 04 2021 at 16:15)</a>:</h4>
<p>I found some time to work on this, setup my developer environment for working on rust-analyzer, and have figured out how to replace all <code>type</code> fields with <code>r#type</code> on text completion. Atm, it's a single string comparison check for <code>type</code> like so</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"type"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">item</span><span class="p">.</span><span class="n">insert_text</span><span class="p">(</span><span class="s">"r#type"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>at line 92 of the code Lukas pointed out (thank you by the way!). Is there a way to properly do this for all identifiers? I imagine doing string comparisons on all possible identifiers (if, struct, etc) wouldn't be the best way to implement this feature and if new identifiers are added to the Rust compiler, the code would have to be manually updated each time.</p>



<a name="252010836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252010836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252010836">(Sep 04 2021 at 16:18)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/fd30bd179ce7920f660488ae3ea53c9c2ace3bbd/crates/syntax/src/ast/make.rs#L74-L82">https://github.com/rust-analyzer/rust-analyzer/blob/fd30bd179ce7920f660488ae3ea53c9c2ace3bbd/crates/syntax/src/ast/make.rs#L74-L82</a></p>



<a name="252010863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252010863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252010863">(Sep 04 2021 at 16:19)</a>:</h4>
<p>I think you need the same SyntaxKind::from_keyword logic</p>



<a name="252010988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252010988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252010988">(Sep 04 2021 at 16:21)</a>:</h4>
<p>I'll look into this, thanks!</p>



<a name="252011178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252011178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252011178">(Sep 04 2021 at 16:24)</a>:</h4>
<p>Random request for feedback -- was setting the dev environment for ra easy? Anything you've spend time on you feel could be better handled? :)</p>



<a name="252012666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252012666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252012666">(Sep 04 2021 at 16:52)</a>:</h4>
<p>It was <em>extremely</em> easy! I forked the RA repo, cloned my fork, installed it as mentioned <a href="https://rust-analyzer.github.io/manual.html">here</a>, and was able to start writing/compiling code no problem! The only part that took some time was figuring out how to log information. From the same url, I learned how to read logs through VSCode but I had to experiment to figure out how to log things (like the <code>name</code> variable). My first attempt to log was with <code>println!("{}", name)</code>. Whenever I triggered the print statement to run, rust-analyzer would crash. It refused to respond to changes written in the code. There were no error messages I could find with <code>RA_LOG=info</code> either. As a quick fix, I've been using <code>panic</code> to log things. This brings up an error message in VSCode that is easy to see and prints whatever I need. I'm sure there's an easy way to do it without using <code>panic</code> and with rust-analyzer's logging solution, but I'm not sure what that is. I think it would be helpful to note whatever it is at <a href="https://rust-analyzer.github.io/manual.html#troubleshooting">https://rust-analyzer.github.io/manual.html#troubleshooting</a></p>



<a name="252013448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252013448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252013448">(Sep 04 2021 at 17:06)</a>:</h4>
<p>Yeah, you need <code>eprintln!</code>. stdout is what we use to communicate with LSP, so printing there breaks things.</p>



<a name="252013463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252013463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252013463">(Sep 04 2021 at 17:07)</a>:</h4>
<p>what OS are you on? I wonder if there's some ungraceful hack we can employ here.</p>



<a name="252013541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252013541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252013541">(Sep 04 2021 at 17:08)</a>:</h4>
<p>Folks, can we, from within the program:</p>
<ul>
<li>duplicate redirect stdout to stderr, so that <code>eprintln!</code> and <code>println</code> are equivalent</li>
<li>move the original stdout to another fd</li>
</ul>
<p>?</p>



<a name="252013956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252013956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252013956">(Sep 04 2021 at 17:17)</a>:</h4>
<p>Oh that makes sense! I didn't realize <code>eprintln!</code> existed either! I'm on Windows</p>



<a name="252014435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252014435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252014435">(Sep 04 2021 at 17:26)</a>:</h4>
<p>Heh, I use <code>tracing::error!</code></p>



<a name="252014664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252014664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252014664">(Sep 04 2021 at 17:31)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/10148">https://github.com/rust-analyzer/rust-analyzer/pull/10148</a> might help a bit -- the <code>println!</code> gotcha is documented in our dev docs, liked those from the troubleshooting section</p>



<a name="252020169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252020169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252020169">(Sep 04 2021 at 19:14)</a>:</h4>
<p>Looks good!</p>



<a name="252020290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252020290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252020290">(Sep 04 2021 at 19:17)</a>:</h4>
<p>I think I'm done implementing completion for raw identifiers. Should I add tests for this small of a change? I don't see any existing tests for the <code>render_field</code> function</p>



<a name="252022014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252022014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252022014">(Sep 04 2021 at 19:49)</a>:</h4>
<p>Yeah, I think you'd want a <code>check_edit</code> test here: <a href="https://github.com/rust-analyzer/rust-analyzer/blob/cbae5969417eba9c9fbaee0337c8f57e566fd286/crates/ide_completion/src/render.rs#L807">https://github.com/rust-analyzer/rust-analyzer/blob/cbae5969417eba9c9fbaee0337c8f57e566fd286/crates/ide_completion/src/render.rs#L807</a></p>



<a name="252034429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Adjusting%20code%20completion%20to%20account%20for%20raw%20string%20literals/near/252034429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Wyatt <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Adjusting.20code.20completion.20to.20account.20for.20raw.20string.20literals.html#252034429">(Sep 04 2021 at 23:40)</a>:</h4>
<p>Submitted a PR <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10152">https://github.com/rust-analyzer/rust-analyzer/pull/10152</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>