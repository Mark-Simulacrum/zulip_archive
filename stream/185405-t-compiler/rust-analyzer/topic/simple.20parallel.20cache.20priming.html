<html>
<head><meta charset="utf-8"><title>simple parallel cache priming · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html">simple parallel cache priming</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251260693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251260693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251260693">(Aug 30 2021 at 17:07)</a>:</h4>
<p><span class="user-mention" data-user-id="211727">@Jonas Schievink  [he/him]</span> I am looking at the <a href="https://github.com/rust-analyzer/rust-analyzer/blob/5c704f11d2ef82d7517680bba6dd0015d750fca2/crates/ide/src/prime_caches.rs#L24-L26">https://github.com/rust-analyzer/rust-analyzer/blob/5c704f11d2ef82d7517680bba6dd0015d750fca2/crates/ide/src/prime_caches.rs#L24-L26</a> and I am having a crazy idea!</p>



<a name="251260902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251260902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251260902">(Aug 30 2021 at 17:08)</a>:</h4>
<p>Recently, I've been thinking that it's in general bad for code to <em>do</em> work in parallel or concurrently. It's much better if the code just <em>returns</em> the work (packaged up as closures or something), and lets the caller to schedule the work over multiple threads</p>



<a name="251261026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251261026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251261026">(Aug 30 2021 at 17:09)</a>:</h4>
<p>So, what if we split the <code>prime_caches</code> thing into two functions:</p>
<ul>
<li>give me a toposort list of crates</li>
<li>prime caches for crate i</li>
</ul>



<a name="251261123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251261123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251261123">(Aug 30 2021 at 17:10)</a>:</h4>
<p>Than, in the main loop, we put the toposorted list into <code>Arc&lt;ConcurrentQueue&lt;Crate&gt;&gt;</code>, and spawn 4 tasks onto a theradpool which share the queue and just pull items off it</p>



<a name="251261284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251261284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251261284">(Aug 30 2021 at 17:10)</a>:</h4>
<p>(the actual idea here I guess is "let's not use rayon, lets use our own thread pool")</p>



<a name="251262121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251262121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251262121">(Aug 30 2021 at 17:16)</a>:</h4>
<p>Interesting idea</p>



<a name="251262230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251262230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251262230">(Aug 30 2021 at 17:17)</a>:</h4>
<p>Although I'm not sure that FIXME comment about rayon is really accurate, I feel like we should be able to make it work with rayon too</p>



<a name="251263347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251263347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251263347">(Aug 30 2021 at 17:24)</a>:</h4>
<p>An interesting side-effect of such inversion of concurrency API is that the progress becomes a non-issue -- rather than accepting this weird dyn Sync closure, you let the caller to iterate</p>



<a name="251289404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251289404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251289404">(Aug 30 2021 at 20:24)</a>:</h4>
<p>I think we also want a better topological sort, with ready sets.</p>



<a name="251289546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251289546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251289546">(Aug 30 2021 at 20:24)</a>:</h4>
<p>Like in this Python API <a href="https://docs.python.org/3/library/graphlib.html">https://docs.python.org/3/library/graphlib.html</a></p>



<a name="251289660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251289660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251289660">(Aug 30 2021 at 20:25)</a>:</h4>
<p>Otherwise it seems harder to use a thread pool</p>



<a name="251326475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251326475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251326475">(Aug 31 2021 at 03:25)</a>:</h4>
<p>Would it make sense to allow preemption such that you can skip the topo-sorting or allow it to be a heuristic sort? If workers can ask for the result of another item and suspend themselves to an "in progress but paused" pool, you may be able to skip sorting entirely, or operate on incomplete topology information.</p>



<a name="251335942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251335942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251335942">(Aug 31 2021 at 05:58)</a>:</h4>
<p>Toposort is needed for accurate progress reports as priming one crate will automatically at least partially prime all dependencies first as the information is necessary for analysis of the to be primed crate.</p>



<a name="251352329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251352329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251352329">(Aug 31 2021 at 08:55)</a>:</h4>
<p><span class="user-mention" data-user-id="211727">@Jonas Schievink  [he/him]</span> am I correct in assuming that you'd want to look into this once you have time?</p>



<a name="251352626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251352626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251352626">(Aug 31 2021 at 08:58)</a>:</h4>
<p>Will this still be useful once salsa can do parallelization internally? Then we could make this a query</p>



<a name="251353157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/251353157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#251353157">(Aug 31 2021 at 09:03)</a>:</h4>
<p>I think it'll still be useful regardless, yes, as we get eagerness and progress report that way. It's also the case that "salsa will be parallel soon"  for at least a year now I think? Maybe more -- I think we discussed that on the call with Niko in Ferrous office :)</p>



<a name="252008052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252008052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252008052">(Sep 04 2021 at 15:29)</a>:</h4>
<p><span class="user-mention" data-user-id="211727">@Jonas Schievink  [he/him]</span> did you by any chance started hacking here? My hands are itching to try this out</p>



<a name="252008111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252008111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252008111">(Sep 04 2021 at 15:30)</a>:</h4>
<p>not yet, I might be able to make some time next week, but feel free to take this on if you want to!</p>



<a name="252008258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252008258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252008258">(Sep 04 2021 at 15:32)</a>:</h4>
<p>Will try to hack something together than!</p>



<a name="252011596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252011596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252011596">(Sep 04 2021 at 16:32)</a>:</h4>
<p>Preliminary results:</p>
<ul>
<li>it works</li>
<li>it's not embarrassingly parallel</li>
<li>it is significant</li>
</ul>
<p>For nearcore, I was able to cut the time down from 18 seconds to 10 seconds</p>



<a name="252011764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252011764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252011764">(Sep 04 2021 at 16:35)</a>:</h4>
<p>It seems that we actually pick the worst topological order for this though. For <code>a &lt;- b &lt;- c  d &lt;-e &lt;-f</code>we more or less generate <code>abcdef</code>, while we want <code>adbecf</code></p>



<a name="252012485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252012485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252012485">(Sep 04 2021 at 16:49)</a>:</h4>
<p>Ok, so with better toposort it goes from 18 secs to 8 secs, which is a solid 2x improvement!</p>



<a name="252012579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252012579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252012579">(Sep 04 2021 at 16:50)</a>:</h4>
<p>Interestingly, for rust-analyzer the win is not as much pronounced</p>



<a name="252014219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252014219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252014219">(Sep 04 2021 at 17:22)</a>:</h4>
<p>Does it process a and d in parallel?</p>



<a name="252014724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252014724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252014724">(Sep 04 2021 at 17:32)</a>:</h4>
<p>In the second tobosort, yest, in the first, not really</p>



<a name="252015028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015028">(Sep 04 2021 at 17:38)</a>:</h4>
<p>Intersting bit of info: <code>db.import_map</code> is ridiculously fast? <code>7.08ms 68.29µs</code> the first number is crate_def_map, the second is <code>import_map</code>, and that's the general pimture for more or less every crate</p>



<a name="252015053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015053">(Sep 04 2021 at 17:38)</a>:</h4>
<p>yeah, import map is a fairly simple shim</p>



<a name="252015063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015063">(Sep 04 2021 at 17:39)</a>:</h4>
<p>hmm, but it also builds FSTs, I'd expect that to take a bit longer</p>



<a name="252015116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015116">(Sep 04 2021 at 17:40)</a>:</h4>
<p>Well, crate def map we've written ourselves, and fst is by <span class="user-mention silent" data-user-id="222471">BurntSushi</span>  :D</p>



<a name="252015146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015146">(Sep 04 2021 at 17:40)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/10149">https://github.com/rust-analyzer/rust-analyzer/pull/10149</a></p>



<a name="252015152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015152">(Sep 04 2021 at 17:40)</a>:</h4>
<p>is that number for a crate_def_map without any macros?</p>



<a name="252015170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015170">(Sep 04 2021 at 17:41)</a>:</h4>
<p>no, it's just <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10149/files#diff-862bfe71a267bd484b625a7399105f4d89e5357cbf90e83c612e700d85a5297fR31">https://github.com/rust-analyzer/rust-analyzer/pull/10149/files#diff-862bfe71a267bd484b625a7399105f4d89e5357cbf90e83c612e700d85a5297fR31</a></p>



<a name="252015180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015180">(Sep 04 2021 at 17:41)</a>:</h4>
<p>so as this is one of the larger times, I suspect it has some amount of macros</p>



<a name="252015239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015239">(Sep 04 2021 at 17:42)</a>:</h4>
<p>I was trying to profile that yesterday, but I feel like I need a PhD to make sense of it with the existing tooling on linux</p>



<a name="252015352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015352">(Sep 04 2021 at 17:44)</a>:</h4>
<p>how many parallel jobs are you using for prime caches?</p>



<a name="252015785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015785">(Sep 04 2021 at 17:52)</a>:</h4>
<p>Hmm, can we use the tracing infra to do some cool reporting?</p>



<a name="252015984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252015984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252015984">(Sep 04 2021 at 17:56)</a>:</h4>
<p>8</p>



<a name="252016013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016013">(Sep 04 2021 at 17:57)</a>:</h4>
<p>lol yes. I'd love PhD in memory profiling for sure</p>



<a name="252016051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016051">(Sep 04 2021 at 17:58)</a>:</h4>
<p>What <em>is</em> infuriating is not profiling per se, but the fact that we don't have a baseline. Like, is 2X speedup more or less the best we could have, or is 20X possible, and we are just doing something stupid?</p>



<a name="252016288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016288">(Sep 04 2021 at 18:01)</a>:</h4>
<p>I'm pretty sure you could compute that in this case</p>



<a name="252016331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016331">(Sep 04 2021 at 18:02)</a>:</h4>
<p>I'm on my phone, but I'm not sure I get that topo sort</p>



<a name="252016493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016493">(Sep 04 2021 at 18:06)</a>:</h4>
<p>In the draft PR? </p>
<p>the idea is to return the full toposort (sort of equivalence class of toposorts) -- rather than returning a single specific order, <code>Vec&lt;Node&gt;</code>, we compute the list of layers, <code>Vec&lt;Vec&lt;Node&gt;&gt;</code>, where all nodes at layer n have  a critical path on lenght n</p>



<a name="252016494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016494">(Sep 04 2021 at 18:06)</a>:</h4>
<p>For a -&gt; b, b -&gt; c, a -&gt; d, does c start before d is ready?</p>



<a name="252016539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016539">(Sep 04 2021 at 18:06)</a>:</h4>
<p>yaeh</p>



<a name="252016544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016544">(Sep 04 2021 at 18:06)</a>:</h4>
<p>Ah, okay</p>



<a name="252016558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016558">(Sep 04 2021 at 18:06)</a>:</h4>
<p>both c and d are leaves, so thel will be in the first layer, and will be picked up by the two first threads</p>



<a name="252016651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016651">(Sep 04 2021 at 18:08)</a>:</h4>
<p>I meant the other way around, with c and d being the last</p>



<a name="252016686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016686">(Sep 04 2021 at 18:08)</a>:</h4>
<p>But yeah, I believe you</p>



<a name="252016724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016724">(Sep 04 2021 at 18:09)</a>:</h4>
<p>Yeah, I am not sure the approach is optimal -- it sounds resonable though, and the impl did bring the speed up in comparison to usual toposort</p>



<a name="252016822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016822">(Sep 04 2021 at 18:11)</a>:</h4>
<p>ah, you only parallelize within a layer then?</p>



<a name="252016919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252016919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252016919">(Sep 04 2021 at 18:13)</a>:</h4>
<p>I was worried about missed parallelism when the graph is not a neat tree with edges only from one level to the next but rather a DAG</p>



<a name="252017134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252017134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252017134">(Sep 04 2021 at 18:16)</a>:</h4>
<p>I mentioned this API <a href="https://docs.python.org/3/library/graphlib.html">https://docs.python.org/3/library/graphlib.html</a> where you don't get a static order, but a set of runnable tasks</p>



<a name="252017152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252017152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252017152">(Sep 04 2021 at 18:17)</a>:</h4>
<p>After each finished one</p>



<a name="252017614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252017614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252017614">(Sep 04 2021 at 18:25)</a>:</h4>
<p>Yeah, that potentially could be smarter... It's a bit of a pain in the back to track progress over several threads</p>



<a name="252018090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018090">(Sep 04 2021 at 18:34)</a>:</h4>
<p>WAIT WAT? that graphlib is standard Python? that's such a different design approach than rust's!</p>



<a name="252018115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018115">(Sep 04 2021 at 18:35)</a>:</h4>
<p>Well, it's only the topo sort, I think</p>



<a name="252018196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018196">(Sep 04 2021 at 18:37)</a>:</h4>
<p>but it's not just toposort, it's the whole paralel scheduler thing! Like, its cool, but weird, but cool!</p>



<a name="252018200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018200">(Sep 04 2021 at 18:37)</a>:</h4>
<p>But yeah, it's like they say. It has everything in the standard library, though the APIs are often terrible</p>



<a name="252018225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018225">(Sep 04 2021 at 18:37)</a>:</h4>
<p>I sort of thought that all crazy things there are for historical reasons, but TopoSorter is legit a new crazyness</p>



<a name="252018234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018234">(Sep 04 2021 at 18:37)</a>:</h4>
<p>Modern Python's wild</p>



<a name="252018301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018301">(Sep 04 2021 at 18:38)</a>:</h4>
<p>At least this one seems well-designed. I actually looked for a topo sort implementation like this in the Rust ecosystem and couldn't find any. Not that it's hard to do, but..</p>



<a name="252018621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018621">(Sep 04 2021 at 18:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133169">matklad</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/simple.20parallel.20cache.20priming/near/252018196">said</a>:</p>
<blockquote>
<p>but it's not just toposort, it's the whole paralel scheduler thing! Like, its cool, but weird, but cool!</p>
</blockquote>
<p>It's just a toposort if you implement it the right way. I learned to write it using a list of successors and predecessor count per node, and the scheduling part comes naturally out of that.</p>



<a name="252018669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018669">(Sep 04 2021 at 18:45)</a>:</h4>
<p>Is there a short code for algo somewhere? I love learning about the <em>right</em> way to code algo</p>



<a name="252018955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252018955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252018955">(Sep 04 2021 at 18:51)</a>:</h4>
<p>For this one? It's easy, you keep an adjacency list (direct successors, is that what it's called?) and when a task is ready you go through its neighbours and decrease their predecessor count. If it's 0, the neighbour is runnable.</p>



<a name="252023023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/252023023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Mcnab <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#252023023">(Sep 04 2021 at 20:07)</a>:</h4>
<p>I think bevy_ecs has something similar tucked away somewhere.</p>



<a name="259483666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/259483666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#259483666">(Oct 29 2021 at 05:13)</a>:</h4>
<p>so, i picked this PR up out of boredom &amp; implemented the more ideal topological sort and allowed it to use 32 threads. it's still VERY rough code-wise, just hacked it together, but... it goes from taking ~60 seconds to ~20 (on my rather large work workspace, ~3900 crates). With like 98% of the crates completing in the first 4-8 seconds...</p>



<a name="259484627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/259484627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#259484627">(Oct 29 2021 at 05:33)</a>:</h4>
<p>Was it 60s with the draft PR or with <code>master</code>? And what do you mean by the "more ideal" sort?</p>



<a name="259493777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/259493777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#259493777">(Oct 29 2021 at 08:05)</a>:</h4>
<p>No sorry, 60s with master! And the "more ideal sort" being the same algorithm that the python lib mentioned earlier uses. </p>
<p>Essentially I just have a controller thread that receives events from the worker threads, and queues more work as other work finishes. by using 2 crossbeam channels, a work channel and a result channel. So initially it enqueues as much work as it can (crates that have no dependencies). As those complete, the controller thread is notified over the result . When a work item completes, it can unlock more work to be done, and it submits the "ready" work to the queue until there is no more work left to do, and then the indexing is complete.</p>
<p>One optimization I could make is to prioritize work (insert work into the queue first that would unlock the most work if it completes.)</p>



<a name="259494578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/259494578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#259494578">(Oct 29 2021 at 08:15)</a>:</h4>
<p>Oh, that sounds great. Would you mind also trying the draft PR? I'm curious how much of a difference it makes.</p>



<a name="259495571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/259495571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#259495571">(Oct 29 2021 at 08:27)</a>:</h4>
<p>Takes a little longer ~5 secs longer, but since progress reporting doesn't work I have no idea if it's progressing on the initial work faster or slower</p>



<a name="259508052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/259508052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#259508052">(Oct 29 2021 at 10:49)</a>:</h4>
<p>Exciting! I would probably try to avoid spawning an extra concurrent thread if possible. Also would love to see this pushed over the finished line!</p>



<a name="263181812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263181812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263181812">(Nov 30 2021 at 17:47)</a>:</h4>
<p>So one of my concerns with this is that we should only prime the caches for the workspace crates and probably their direct dependencies. Otherwise we're including in the analysis private dependencies, which seems wasteful. In practice it didn't seem to use a lot of extra memory, though.</p>



<a name="263182076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263182076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263182076">(Nov 30 2021 at 17:49)</a>:</h4>
<p>I actually disable cache priming now, not because it's slow (that doesn't matter), but because it tends to spin up the computer fans. And in Code, the syntax highlighting and inlay hints tend to have the same effect anyway.</p>



<a name="263197549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263197549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263197549">(Nov 30 2021 at 19:41)</a>:</h4>
<p>It probably still worth doing the topo sort and parallel thing, but only on the direct dependencies</p>



<a name="263240147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263240147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263240147">(Dec 01 2021 at 03:26)</a>:</h4>
<p>that's what <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10743">https://github.com/rust-analyzer/rust-analyzer/pull/10743</a> aimed to do, right? if so, my plan is to still only cache those subset of crates</p>



<a name="263254756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263254756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263254756">(Dec 01 2021 at 07:52)</a>:</h4>
<p>No, that one only excluded the examples and other targets:</p>
<blockquote>
<p>This PR instead makes us index only the transitive dependencies of all workspace crates.</p>
</blockquote>



<a name="263254772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263254772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263254772">(Dec 01 2021 at 07:53)</a>:</h4>
<p>We still don't want the transitive dependencies</p>



<a name="263261217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263261217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263261217">(Dec 01 2021 at 09:07)</a>:</h4>
<p>ah yeah i see. so in this case, we'd want to resolve all local roots and then everything those local roots depend on?</p>



<a name="263272907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/263272907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#263272907">(Dec 01 2021 at 10:56)</a>:</h4>
<p>Yeah, that's what I was thinking</p>



<a name="267988504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267988504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267988504">(Jan 14 2022 at 09:15)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/11281">https://github.com/rust-analyzer/rust-analyzer/pull/11281</a> !!</p>



<a name="267988939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267988939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267988939">(Jan 14 2022 at 09:20)</a>:</h4>
<p>It still touches 107 crates on RA itself, right?</p>



<a name="267989154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267989154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267989154">(Jan 14 2022 at 09:22)</a>:</h4>
<p>108 now since i guess i added one, but yes.</p>



<a name="267989991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267989991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267989991">(Jan 14 2022 at 09:31)</a>:</h4>
<p>8909ms 8823ms 8853ms before<br>
5262ms 5222ms 5254ms after</p>



<a name="267990112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267990112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267990112">(Jan 14 2022 at 09:32)</a>:</h4>
<p>what cmd are u running to compute that</p>



<a name="267990586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267990586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267990586">(Jan 14 2022 at 09:37)</a>:</h4>
<p><code>"RA_PROFILE": "*&gt;4000"</code></p>



<a name="267990621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267990621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267990621">(Jan 14 2022 at 09:37)</a>:</h4>
<p>And <code>Developer: Reload Window</code></p>



<a name="267990874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267990874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267990874">(Jan 14 2022 at 09:40)</a>:</h4>
<p>I think we can remove the old version and use the number of CPUs</p>



<a name="267991070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267991070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267991070">(Jan 14 2022 at 09:42)</a>:</h4>
<p>on our workspace at work, which has many more crates...</p>
<p>38953ms 38799ms ... before<br>
15280ms 14077ms 13766ms after</p>



<a name="267991102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267991102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267991102">(Jan 14 2022 at 09:42)</a>:</h4>
<p>not bad at all...!</p>



<a name="267991520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267991520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267991520">(Jan 14 2022 at 09:46)</a>:</h4>
<p>I have a 16C32T</p>



<a name="267991799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/simple%20parallel%20cache%20priming/near/267991799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/simple.20parallel.20cache.20priming.html#267991799">(Jan 14 2022 at 09:49)</a>:</h4>
<p>But I generally keep cache priming disabled, it's not that noticeable.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>