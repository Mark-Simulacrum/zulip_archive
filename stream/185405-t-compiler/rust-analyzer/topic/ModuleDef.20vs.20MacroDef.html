<html>
<head><meta charset="utf-8"><title>ModuleDef vs MacroDef · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html">ModuleDef vs MacroDef</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261003210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261003210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261003210">(Nov 10 2021 at 15:10)</a>:</h4>
<p>We make a distinction between MacroDefs and ModuleDefs and I don't think I ever asked or found out about the reasoning behind this. Isn't a macro technically just a module definition? Or is this due to macros not necessarily being considered a proper item in scope where it is defined?<br>
(And I think I recall a comment somewhere questioning this differentiation as well in the source but I don't remember where)</p>



<a name="261003717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261003717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261003717">(Nov 10 2021 at 15:14)</a>:</h4>
<p>Good question. I don't know :D  I think ModuleDef <em>should</em> contain MacroDef as one of the variants. </p>
<p>I think this stems from macro call/macro def confustion.</p>



<a name="261004016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261004016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261004016">(Nov 10 2021 at 15:16)</a>:</h4>
<p>At least originally, we treated <code>macro_rules! foo {}</code> as a macro call (a call to macro named <code>macro_rules</code>). And it is indeed an invariant that modules should not contain macro calls. </p>
<p>For somethin like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">enum</span> <span class="nc">E</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">m</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span> <span class="nc">S</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">foo</span><span class="o">!</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>m</code> should contain <code>E</code> and <code>S</code> as children, but it shouldnt' know about <code>foo!()</code>, as macro calls are fully expanded at this level of semantics.</p>



<a name="261004161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261004161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261004161">(Nov 10 2021 at 15:17)</a>:</h4>
<p>But now macros can be proper items, and they can be proper partsof the scope, so I think we should fix it. That is, we shouldn't add <code>foo!();</code> as a "child" of module, but <code>macro_rules! foo</code> should be a child of the parent one. z</p>



<a name="261004405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261004405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261004405">(Nov 10 2021 at 15:19)</a>:</h4>
<p>I see, will consider exploring this then as getting rid of that differentiation should make some things simpler I feel like.</p>



<a name="261004506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261004506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261004506">(Nov 10 2021 at 15:20)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug, Default, PartialEq, Eq)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ItemScope</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_c</span>: <span class="nc">Count</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="sd">/// Defs visible in this scope. This includes `declarations`, but also</span>
<span class="w">    </span><span class="sd">/// imports.</span>
<span class="w">    </span><span class="n">types</span>: <span class="nc">FxHashMap</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ModuleDefId</span><span class="p">,</span><span class="w"> </span><span class="n">Visibility</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">values</span>: <span class="nc">FxHashMap</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ModuleDefId</span><span class="p">,</span><span class="w"> </span><span class="n">Visibility</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">macros</span>: <span class="nc">FxHashMap</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">MacroDefId</span><span class="p">,</span><span class="w"> </span><span class="n">Visibility</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>I think here at some point we also tried to have strong types between value/type/macro namespaces</p>



<a name="261004597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261004597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261004597">(Nov 10 2021 at 15:20)</a>:</h4>
<p>Such that we can say things like "modules are never values", but we def dropped the ball on values/types at least</p>



<a name="261004672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261004672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261004672">(Nov 10 2021 at 15:21)</a>:</h4>
<p>Yeah, and </p>
<div class="codehilite"><pre><span></span><code>#[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]
pub struct PerNs {
    pub types: Option&lt;(ModuleDefId, Visibility)&gt;,
    pub values: Option&lt;(ModuleDefId, Visibility)&gt;,
    pub macros: Option&lt;(MacroDefId, Visibility)&gt;,
}
</code></pre></div>
<p>probably needs fixing as well</p>



<a name="261005303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005303">(Nov 10 2021 at 15:25)</a>:</h4>
<p>Would we gain anything from discerning values types and macros over one single <code>ModuleDef</code> type even? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="261005315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005315">(Nov 10 2021 at 15:25)</a>:</h4>
<p>well, having the fact that everything in the macro namespace is a macro baked into the types makes sense, for types/values it's less valuable since they have so much overlap anyway</p>



<a name="261005590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005590">(Nov 10 2021 at 15:26)</a>:</h4>
<p>I mean we could technically have both, <code>ModuleDef</code> to rule them all, then <code>MacroDef</code>, <code>TypeDef</code> and <code>ValueDef</code> where the latter two hold variants only for the things applicable. If desired</p>



<a name="261005825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005825">(Nov 10 2021 at 15:28)</a>:</h4>
<p>I think we have those already at least in hir_ty: <code>TyDefId</code> and <code>ValueTyDefId</code></p>



<a name="261005880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005880">(Nov 10 2021 at 15:28)</a>:</h4>
<p><code>MacroDef</code> not being part of <code>ModuleDef </code>tends to be annoying for some IDE features usually, <code>doc_links.rs</code> for example has some stuff that only cares about module items as a whole and then requires the use of<code> Either</code> to handle that nicely, ex: <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide/src/doc_links.rs#L499-L527">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide/src/doc_links.rs#L499-L527</a></p>



<a name="261005882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005882">(Nov 10 2021 at 15:28)</a>:</h4>
<p>Yeah, i feel there are intersecting things here:</p>
<ul>
<li>there are items defined in a module</li>
<li>and there are scope entries, which bind to a specific namespace</li>
</ul>



<a name="261005890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261005890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261005890">(Nov 10 2021 at 15:28)</a>:</h4>
<p>hm ok they're not exactly the same</p>



<a name="261006009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006009">(Nov 10 2021 at 15:29)</a>:</h4>
<p>we need enum subset types <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="261006099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006099">(Nov 10 2021 at 15:30)</a>:</h4>
<p>I do feel that <code>hir::ModuleDef</code> should probably include macros, not so suher about <code>hir_def</code>.</p>



<a name="261006133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006133">(Nov 10 2021 at 15:30)</a>:</h4>
<p>yeah, let's rewrite the thing in OCaml!</p>



<a name="261006155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006155">(Nov 10 2021 at 15:30)</a>:</h4>
<p>Back to the roots</p>



<a name="261006378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006378">(Nov 10 2021 at 15:32)</a>:</h4>
<p>but maybe a bunch of enums with <code>Into</code> implementations between them is actually good enough</p>



<a name="261006476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006476">(Nov 10 2021 at 15:33)</a>:</h4>
<p>OTOH, I feel that IDE functionality maybe wants to work with <code>Definition</code> more? Like, if you want to handle macros and structs, than maybe you want to handle fields as well?</p>



<a name="261006699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006699">(Nov 10 2021 at 15:34)</a>:</h4>
<p>In my example at least, probably ye</p>



<a name="261006799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006799">(Nov 10 2021 at 15:35)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> yeah, maybe <code>ModuleDef</code>, for IDE, is a somewhat arbitrary grouping to begin with? Ie, maybe we should just inline it here: </p>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/04f03a360ab8fef3d9c0ff84de2d39b8a196c717/crates/ide_db/src/defs.rs#L21-L27">https://github.com/rust-analyzer/rust-analyzer/blob/04f03a360ab8fef3d9c0ff84de2d39b8a196c717/crates/ide_db/src/defs.rs#L21-L27</a></p>



<a name="261006802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006802">(Nov 10 2021 at 15:35)</a>:</h4>
<p>I think it already does, but then splits up how it works on them before it calls into the linked code</p>



<a name="261006943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006943">(Nov 10 2021 at 15:36)</a>:</h4>
<p>yeah I actually feel we should usually inline those grouping enums and not nest them anyway</p>



<a name="261006956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006956">(Nov 10 2021 at 15:36)</a>:</h4>
<p>yeah, <code>get_symbol_filename</code> definitelly should work with Definiton and not with ModuleDef</p>



<a name="261006972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261006972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261006972">(Nov 10 2021 at 15:36)</a>:</h4>
<p>it <em>should</em> work for fields</p>



<a name="261161359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261161359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261161359">(Nov 11 2021 at 17:19)</a>:</h4>
<p>Ah right, <code>MacroDefId</code> doesn't track the module where it comes from, only the crate as it is defined in <code>hir_expand</code> where modules don't exist, that makes this a bit more tricky to move it into <code>ModuleDefId</code></p>



<a name="261268543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261268543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261268543">(Nov 12 2021 at 15:30)</a>:</h4>
<p>So I've been working on bringing <code>MacroDef{Id}</code> into <code>ModuleDef{Id}</code>, for which we need to first resolve the problem that we currently don't remember the module a macro is defined is. This can be easily fixed by adding a side table to the crate def map, but this of course fails to work for when a macro is defined in a block and since a <code>MacroDefId</code> has no access to anything other than crate id this approach falls down here. Now I was wondering if it would make sense to add a <code>MacroDefData</code> or something similar like we have for a other items and add a query for it to the <code>DefDatabase</code>. If we were to do this we could also save a macro's name inside this with the benefit that we no longer have to parse the source file of a macro to fetch its name. For macro 2.0 we can also then save the visibility which we don't do yet(I think?).</p>



<a name="261274549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261274549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261274549">(Nov 12 2021 at 16:13)</a>:</h4>
<p>hmm yeah, that seems useful</p>



<a name="261276230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261276230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261276230">(Nov 12 2021 at 16:25)</a>:</h4>
<p>Gonna be tricking dealing with the <code>ItemTree</code> and <code>MacroDefId </code>though, since we can't use the interning things we do for all the other item  types. So we have to save the ItemTreeIdx somewhere(as the ItemTree can be queried through the ast pointers in <code>MacroDefId</code>).<br>
Will give that another look tomorrow.</p>



<a name="261420889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef%20vs%20MacroDef/near/261420889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/ModuleDef.20vs.20MacroDef.html#261420889">(Nov 14 2021 at 14:38)</a>:</h4>
<p>I just realized this won' work either, since module ids and the like don't exist for the item tree hmm</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>