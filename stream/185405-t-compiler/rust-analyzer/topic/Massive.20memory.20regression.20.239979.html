<html>
<head><meta charset="utf-8"><title>Massive memory regression #9979 · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html">Massive memory regression #9979</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250284363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250284363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250284363">(Aug 22 2021 at 17:23)</a>:</h4>
<p>In <a href="https://github.com/rust-analyzer/rust-analyzer/pull/9979">https://github.com/rust-analyzer/rust-analyzer/pull/9979</a> I fixed the issue of us incorrectly mapping tokens up in derive macro invocations by simply replacing the derive attribute that is being expanded in the item node instead of removing it, as removing the attribute will offset the text ranges. This <em>somehow</em> had a massive effect on memory usage but I have no idea how this can be. Does anything non ide related in RA depends on token upmapping(hygiene I guess?) that could explain this?.</p>



<a name="250284548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250284548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250284548">(Aug 22 2021 at 17:28)</a>:</h4>
<p>Only slightly related, but <code>splice_children</code> looks odd. It inserts one child at a time, but does a <code>splice_children</code> on the <code>GreenNodeData</code> and a <code>respine</code> for every one of those. It doesn't matter here, though, since we only insert one child.</p>



<a name="250286404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250286404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250286404">(Aug 22 2021 at 18:16)</a>:</h4>
<p>Hmm, what if we try that trick of doubling the whitespace? It will break the mapping, but it should show us how much memory the whitespace itself takes.</p>



<a name="250286445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250286445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250286445">(Aug 22 2021 at 18:17)</a>:</h4>
<p>What are the memory usage stats saying?</p>



<a name="250287227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287227">(Aug 22 2021 at 18:37)</a>:</h4>
<p>For that commit:</p>
<div class="codehilite"><pre><span></span><code>Database loaded:     1.37s, 139mb
  crates: 38, mods: 777, decls: 17074, fns: 12749
Item Collection:     19.70s, 729mb
  exprs: 339340, ??ty: 489 (0%), ?ty: 436 (0%), !ty: 288
Inference:           58.44s, 638mb
Total:               78.13s, 1368mb
</code></pre></div>
<p>For the previous commit:</p>
<div class="codehilite"><pre><span></span><code>Database loaded:     10.52s, 139mb
  crates: 38, mods: 777, decls: 17073, fns: 12748
Item Collection:     19.66s, 557mb
  exprs: 339310, ??ty: 489 (0%), ?ty: 436 (0%), !ty: 288
Inference:           58.62s, 638mb
Total:               78.28s, 1196mb
</code></pre></div>



<a name="250287314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287314">(Aug 22 2021 at 18:39)</a>:</h4>
<p>The commit introduced one new function hence the difference in <code>decls</code> and <code>fns</code></p>



<a name="250287324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287324">(Aug 22 2021 at 18:39)</a>:</h4>
<p>Maybe the verbose ones (per-query)?</p>



<a name="250287334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287334">(Aug 22 2021 at 18:39)</a>:</h4>
<p>Ah right that exists</p>



<a name="250287437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287437">(Aug 22 2021 at 18:42)</a>:</h4>
<p>How do I run it per query actually?</p>



<a name="250287471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287471">(Aug 22 2021 at 18:42)</a>:</h4>
<p>Just pass -v I guess?</p>



<a name="250287550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287550">(Aug 22 2021 at 18:44)</a>:</h4>
<p>Does the cli even offer per query statistics? I don't think it does</p>



<a name="250287581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287581">(Aug 22 2021 at 18:45)</a>:</h4>
<p>I thought it was there, but I might be wrong. Can't check right now.</p>



<a name="250287635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287635">(Aug 22 2021 at 18:46)</a>:</h4>
<p>I don't see anything like that and verbosity only enables things for inference it seems which is unrelated here</p>



<a name="250287732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287732">(Aug 22 2021 at 18:48)</a>:</h4>
<p>Did you pass --nemory-usage? See line 155 in <a href="http://analysis_stats.rs">analysis_stats.rs</a>. also needs -v.</p>



<a name="250287896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287896">(Aug 22 2021 at 18:53)</a>:</h4>
<p>Oh I was passing <code>-q</code> by accident again <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="250287951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287951">(Aug 22 2021 at 18:54)</a>:</h4>
<p>but those per query stats are only relevant for inference as said</p>



<a name="250287953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250287953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250287953">(Aug 22 2021 at 18:54)</a>:</h4>
<p>so ye what i got there is all we have from what i can see</p>



<a name="250347428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250347428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250347428">(Aug 23 2021 at 12:58)</a>:</h4>
<p>Hm, no idea what's going on here. I suggest running with <code>RA_COUNT=1</code> maybe?</p>



<a name="250347654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250347654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250347654">(Aug 23 2021 at 13:00)</a>:</h4>
<p>Also, I must say I am not a huge fan of tree mutation during macro exapsion -- the original idea was that we won't mutate trees during macro expansion. But It's not like I can suggest a better alternative :)</p>



<a name="250348023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250348023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250348023">(Aug 23 2021 at 13:03)</a>:</h4>
<p>would it be better to mutate the created token trees while we create them?</p>



<a name="250348205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250348205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250348205">(Aug 23 2021 at 13:04)</a>:</h4>
<p>Yeah, withoug thinking too much about this, it seems the more natrual approach is to patch syntax_node_to_token_tree</p>



<a name="250348232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250348232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250348232">(Aug 23 2021 at 13:04)</a>:</h4>
<p>we just skip some nodes while converting to tt</p>



<a name="250348337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250348337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250348337">(Aug 23 2021 at 13:05)</a>:</h4>
<p>The way I see it, syntax trees are a strictly immutable reprensentation of the code. Macro expansion uses token trees as both inputs and outputs. All shenanigans are happening in the explicit translation layer.</p>



<a name="250348892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250348892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250348892">(Aug 23 2021 at 13:09)</a>:</h4>
<p>Before the PR</p>
<div class="codehilite"><pre><span></span><code>Database loaded:     13.02s, 119mb
  crates: 38, mods: 777, decls: 17073, fns: 12748
Item Collection:     29.73s, 557mb
  exprs: 343094, ??ty: 406 (0%), ?ty: 436 (0%), !ty: 147
Inference:           63.09s, 640mb
Total:               92.83s, 1197mb
hir_def::body::Body                                                                             13_688       13_688       13_688
hir_def::item_scope::ItemScope                                                                  13_126       13_126       13_126
hir_def::item_tree::ItemTree                                                                    56_078       55_649       55_649
hir_def::nameres::DefMap                                                                        10_109       10_109       10_109
hir_expand::ast_id_map::AstIdMap                                                               124_433       64_146       64_145
rowan::green::node::GreenNode                                                               11_868_588    1_365_968    1_226_934
rowan::green::token::GreenToken                                                              5_286_789      729_519      723_837
rowan::utility_types::NodeOrToken&lt;rowan::cursor::SyntaxNode, rowan::cursor::SyntaxToken&gt;   119_134_074       31_495       22_566
                                                                                                 total     max_live         live
</code></pre></div>
<p>After</p>
<div class="codehilite"><pre><span></span><code>post
Database loaded:     1.79s, 119mb
  crates: 38, mods: 777, decls: 17074, fns: 12749
Item Collection:     29.53s, 728mb
  exprs: 343124, ??ty: 406 (0%), ?ty: 436 (0%), !ty: 147
Inference:           60.48s, 640mb
Total:               90.01s, 1369mb
hir_def::body::Body                                                                             13_689       13_689       13_689
hir_def::item_scope::ItemScope                                                                  13_128       13_128       13_128
hir_def::item_tree::ItemTree                                                                    56_080       55_651       55_651
hir_def::nameres::DefMap                                                                        10_111       10_111       10_111
hir_expand::ast_id_map::AstIdMap                                                               124_439       64_148       64_147
rowan::green::node::GreenNode                                                               11_924_215    2_430_066    2_292_216
rowan::green::token::GreenToken                                                              5_300_564    1_058_056    1_052_374
rowan::utility_types::NodeOrToken&lt;rowan::cursor::SyntaxNode, rowan::cursor::SyntaxToken&gt;   119_461_412       52_374       50_498
                                                                                                 total     max_live         live
</code></pre></div>



<a name="250348962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250348962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250348962">(Aug 23 2021 at 13:10)</a>:</h4>
<p>So looks like it is indeed the syntax nodes that eat the memory?</p>



<a name="250349388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250349388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250349388">(Aug 23 2021 at 13:13)</a>:</h4>
<p>That's curious! Now the question is, why do we have more live nodes in this case?</p>



<a name="250349573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250349573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250349573">(Aug 23 2021 at 13:14)</a>:</h4>
<p>Perhaps we haven't plugged all the leaks in rowan? <span class="user-mention" data-user-id="300586">@Lukas Wirth</span> would you like to debug this from here? I fear this might be one of those cursed issues, which can teach a lot :D</p>



<a name="250349656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250349656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250349656">(Aug 23 2021 at 13:15)</a>:</h4>
<p>Also, observability <span aria-label="rock on" class="emoji emoji-1f918" role="img" title="rock on">:rock_on:</span> <span aria-label="rock on" class="emoji emoji-1f918" role="img" title="rock on">:rock_on:</span> <span aria-label="rock on" class="emoji emoji-1f918" role="img" title="rock on">:rock_on:</span> </p>
<p>Notice how having the metrics published and the <code>RA_COUNT</code> available makes it easier to even notices that something fishy is happening!</p>



<a name="250350732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250350732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250350732">(Aug 23 2021 at 13:25)</a>:</h4>
<p>That does look like its leaking somewhere, I can try to investigate.</p>



<a name="250350761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250350761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250350761">(Aug 23 2021 at 13:25)</a>:</h4>
<p>Always fun finding new bugs by fixing bugs.</p>



<a name="250351032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250351032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250351032">(Aug 23 2021 at 13:27)</a>:</h4>
<p>Rowan itself doesn't really have tests does it?</p>



<a name="250360762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250360762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250360762">(Aug 23 2021 at 14:38)</a>:</h4>
<p>So how would I go about debugging this ideally? I haven't really done much debugging for memory leaks yet</p>



<a name="250362626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250362626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250362626">(Aug 23 2021 at 14:51)</a>:</h4>
<p>Well, the latest ERA episode might be relevant: <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/ERA.20series/near/250362548">https://rust-lang.zulipchat.com/#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/ERA.20series/near/250362548</a></p>



<a name="250362746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250362746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250362746">(Aug 23 2021 at 14:52)</a>:</h4>
<p>But i'd go for just debugging "why counts are different" -- ie, a usual difference in behavior debugging</p>



<a name="250373434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250373434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250373434">(Aug 23 2021 at 16:10)</a>:</h4>
<p>I can't seem to figure out the problem nor make any progress in figuring it out<br>
I don't see a place where we are messing up refcounts either</p>



<a name="250373695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250373695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250373695">(Aug 23 2021 at 16:12)</a>:</h4>
<p>Did you manage to minimize the test? Or is <code>analysis-stats</code> the best we have?</p>



<a name="250374002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250374002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250374002">(Aug 23 2021 at 16:14)</a>:</h4>
<p>So far no luck in minimizing</p>



<a name="250374183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250374183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250374183">(Aug 23 2021 at 16:16)</a>:</h4>
<p>Tried building a few nested nodes and then splicing them but the live count stays at 0 after dropping the nodes</p>



<a name="250374429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250374429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250374429">(Aug 23 2021 at 16:18)</a>:</h4>
<p>Huh, I am out of specific ideas then...</p>
<p>I'd try to minize this from the big repro (what's the smallers project where analysis stats shows a diff), and I'd also try playing with DEFAULT_LRU_CAPACITY value (feels like it might be relevant)</p>



<a name="250374514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250374514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250374514">(Aug 23 2021 at 16:18)</a>:</h4>
<p>I guess, you can start with something like <code>integrated_highlighting_bench</code> for that</p>



<a name="250376356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376356">(Aug 23 2021 at 16:32)</a>:</h4>
<p>Also out of curiosity I tried printing the counts after dropping the <code>AnalysisHost</code> in <code>AnalysisStats</code>/</p>
<div class="codehilite"><pre><span></span><code>Database loaded:     1.53s, 119mb
  crates: 38, mods: 777, decls: 17073, fns: 12748
Item Collection:     29.65s, 556mb
Total:               29.65s, 556mb
hir_def::item_scope::ItemScope                                                                   3_503        3_503        3_503
hir_def::item_tree::ItemTree                                                                    33_922       33_922       33_922
hir_def::nameres::DefMap                                                                           606          606          606
hir_expand::ast_id_map::AstIdMap                                                                33_988       33_929       33_928
rowan::green::node::GreenNode                                                                7_215_242    1_167_422    1_152_523
rowan::green::token::GreenToken                                                              3_189_421      546_565      542_921
rowan::utility_types::NodeOrToken&lt;rowan::cursor::SyntaxNode, rowan::cursor::SyntaxToken&gt;    83_537_620       31_495       22_554
                                                                                                 total     max_live         live

hir_def::item_scope::ItemScope                                                                   3_503        3_503            0
hir_def::item_tree::ItemTree                                                                    33_922       33_922            0
hir_def::nameres::DefMap                                                                           606          606            0
hir_expand::ast_id_map::AstIdMap                                                                33_988       33_929            0
rowan::green::node::GreenNode                                                                7_215_242    1_167_422      903_983
rowan::green::token::GreenToken                                                              3_189_421      546_565      286_893
rowan::utility_types::NodeOrToken&lt;rowan::cursor::SyntaxNode, rowan::cursor::SyntaxToken&gt;    83_537_620       31_495       22_554
                                                                                                 total     max_live         live
</code></pre></div>
<p>first batch is before dropping, second is after dropping</p>



<a name="250376383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376383">(Aug 23 2021 at 16:32)</a>:</h4>
<p>And this is for the commit prior to this PR</p>



<a name="250376411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376411">(Aug 23 2021 at 16:32)</a>:</h4>
<p>so we are already leaking a bunch as is it seems(ah well we are doing the replacement for attributes already so maybe thats the cause here already)?</p>



<a name="250376583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376583">(Aug 23 2021 at 16:34)</a>:</h4>
<p>If it's a detectable leak you might be able to find it with <code>-Zsanitizer=leak</code></p>



<a name="250376611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376611">(Aug 23 2021 at 16:34)</a>:</h4>
<p>that has worked very well in the past for me</p>



<a name="250376741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376741">(Aug 23 2021 at 16:35)</a>:</h4>
<p>That isn't supported on windows is it <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="250376846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376846">(Aug 23 2021 at 16:36)</a>:</h4>
<p>Ah, it might not be</p>



<a name="250376875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250376875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250376875">(Aug 23 2021 at 16:36)</a>:</h4>
<p>Doesn't seem like it according to the llvm docs</p>



<a name="250377190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250377190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250377190">(Aug 23 2021 at 16:39)</a>:</h4>
<p>Anything I can test? :D</p>



<a name="250377451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250377451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250377451">(Aug 23 2021 at 16:41)</a>:</h4>
<p>Just running <code>cargo +nightly run --bin rust-analyzer --release -- -q analysis-stats --memory-usage . --skip-inference</code> with <code>-Zsanitizer=leak</code>set in your <code>RUSTFLAGS</code>(thats how you use them for cargo right?)</p>



<a name="250377518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250377518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250377518">(Aug 23 2021 at 16:41)</a>:</h4>
<p>Can be done on latest master or the commit of this PR</p>



<a name="250377553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250377553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250377553">(Aug 23 2021 at 16:41)</a>:</h4>
<p>doesn't really matter as we are already leaking prior to this PR a bit</p>



<a name="250377921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250377921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250377921">(Aug 23 2021 at 16:44)</a>:</h4>
<p>Yeah, I can confirm the leaked nodes at the end of <code>run</code></p>



<a name="250377927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250377927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250377927">(Aug 23 2021 at 16:44)</a>:</h4>
<p>(someday I'll set up a linux machine/dual boot)</p>



<a name="250378047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378047">(Aug 23 2021 at 16:45)</a>:</h4>
<p>Let me try LSAN, I didn't even know it was working for Rust programs. Do the other sanitizers work too?</p>



<a name="250378232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378232">(Aug 23 2021 at 16:46)</a>:</h4>
<div class="codehilite"><pre><span></span><code>                                                                                                 total     max_live         live

hir_def::item_scope::ItemScope                                                                   3_503        3_503            0
hir_def::item_tree::ItemTree                                                                    33_922       33_922            0
hir_def::nameres::DefMap                                                                           606          606            0
hir_expand::ast_id_map::AstIdMap                                                                33_988       33_929            0
rowan::green::node::GreenNode                                                                7_141_607      601_759           48
rowan::green::token::GreenToken                                                              3_163_887      386_171           57
rowan::utility_types::NodeOrToken&lt;rowan::cursor::SyntaxNode, rowan::cursor::SyntaxToken&gt;    83_349_913       30_383           18
                                                                                                 total     max_live         live
</code></pre></div>
<p>okay so this is the count after dropping with the <code>splice_children</code> for attributes replaced with a <code>detach</code>. So we are still leaking a few nodes without that but almost all the leakage comes from splice_children it seems(or all if we do use it somewhere else)</p>



<a name="250378418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378418">(Aug 23 2021 at 16:47)</a>:</h4>
<p>Hmm, might be a good idea to enable debug info.</p>



<a name="250378660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378660">(Aug 23 2021 at 16:49)</a>:</h4>
<p><span class="user-mention" data-user-id="133169">@matklad</span> any opinion on my question about the <code>splice_children</code> implementation? It splices one children at a time, but ends up calling another <code>splice_function</code> for each of them. I mean, I can't say I understand the code, but that's usually a red flag.</p>



<a name="250378749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378749">(Aug 23 2021 at 16:50)</a>:</h4>
<p>Ah we have a use of <code>ted::replace</code>(which uses <code>splice_children</code>) in <code>hir_expand::eager_macro_recur</code> so I imagine thats where the last 100 nodes leak</p>



<a name="250378813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378813">(Aug 23 2021 at 16:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Database loaded:     460.32ms, 357minstr, 0b
  crates: 38, mods: 776, decls: 17106, fns: 12763
Item Collection:     14.43s, 140ginstr, 0b
Total:               14.43s, 140ginstr, 0b
error: address range table at offset 0x114af0 has a premature terminator entry at offset 0x114b60
error: address range table at offset 0x1757b0 has a premature terminator entry at offset 0x1757f0

=================================================================
==163209==ERROR: LeakSanitizer: detected memory leaks

Direct leak of 384 byte(s) in 6 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d54d9f2 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d54d9f2 in alloc::alloc::Global::alloc_impl::h731f7a4e8793124e /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:166:73
    #3 0x55735d54d9f2 in _$LT$alloc..alloc..Global$u20$as$u20$core..alloc..Allocator$GT$::allocate::hd3fe441267c55200 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:226:9
    #4 0x55735d54d9f2 in alloc::alloc::exchange_malloc::h22967bfd6b4e59e1 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:316:11
    #5 0x55735d54d9f2 in alloc::boxed::Box$LT$T$GT$::new::hb724f00f2f577867 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/boxed.rs:191:9
    #6 0x55735d54d9f2 in rowan::cursor::NodeData::new::h621527caf1d19cc0 ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:246:41
    #7 0x55735d54d9f2 in rowan::cursor::SyntaxNode::new_root_mut::h2249f231610da5dd ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:517:27
    #8 0x55735d54d9f2 in rowan::cursor::SyntaxNode::clone_for_update::h81c7d27489db140b ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:538:21

Indirect leak of 147435728 byte(s) in 1953780 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d550516 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d550516 in rowan::arc::ThinArc$LT$H$C$T$GT$::from_header_and_iter::h2b979b557c611a7f ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/arc.rs:353:26

Indirect leak of 77072576 byte(s) in 28264 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d550d41 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d550d41 in rowan::arc::ThinArc$LT$H$C$T$GT$::from_header_and_iter::hc5c94a72b3fba627 ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/arc.rs:353:26

Indirect leak of 28057704 byte(s) in 639306 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d551222 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d551222 in rowan::arc::ThinArc$LT$H$C$T$GT$::from_header_and_iter::hf9116a6332561942 ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/arc.rs:353:26

Indirect leak of 4683600 byte(s) in 20654 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d550913 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d550913 in rowan::arc::ThinArc$LT$H$C$T$GT$::from_header_and_iter::h3f10cca8f8fdda98 ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/arc.rs:353:26

Indirect leak of 1809664 byte(s) in 28276 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d54d2a4 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d54d2a4 in alloc::alloc::Global::alloc_impl::h731f7a4e8793124e /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:166:73
    #3 0x55735d54d2a4 in _$LT$alloc..alloc..Global$u20$as$u20$core..alloc..Allocator$GT$::allocate::hd3fe441267c55200 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:226:9
    #4 0x55735d54d2a4 in alloc::alloc::exchange_malloc::h22967bfd6b4e59e1 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:316:11
    #5 0x55735d54d2a4 in alloc::boxed::Box$LT$T$GT$::new::hb724f00f2f577867 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/boxed.rs:191:9
    #6 0x55735d54d2a4 in rowan::cursor::NodeData::new::h621527caf1d19cc0 (.llvm.16586132102640410163) ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:246:41

Indirect leak of 1321472 byte(s) in 20648 object(s) allocated from:
    #0 0x55735c625798 in malloc /rustc/llvm/src/llvm-project/compiler-rt/lib/lsan/lsan_interceptors.cpp:56:3
    #1 0x55735d54d9f2 in alloc::alloc::alloc::h36afbbfc57da00da /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:86:14
    #2 0x55735d54d9f2 in alloc::alloc::Global::alloc_impl::h731f7a4e8793124e /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:166:73
    #3 0x55735d54d9f2 in _$LT$alloc..alloc..Global$u20$as$u20$core..alloc..Allocator$GT$::allocate::hd3fe441267c55200 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:226:9
    #4 0x55735d54d9f2 in alloc::alloc::exchange_malloc::h22967bfd6b4e59e1 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/alloc.rs:316:11
    #5 0x55735d54d9f2 in alloc::boxed::Box$LT$T$GT$::new::hb724f00f2f577867 /rustc/5ad7389bdd1abe7d2c6f73a233af1a7a69e96285/library/alloc/src/boxed.rs:191:9
    #6 0x55735d54d9f2 in rowan::cursor::NodeData::new::h621527caf1d19cc0 ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:246:41
    #7 0x55735d54d9f2 in rowan::cursor::SyntaxNode::new_root_mut::h2249f231610da5dd ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:517:27
    #8 0x55735d54d9f2 in rowan::cursor::SyntaxNode::clone_for_update::h81c7d27489db140b ~/.cargo/registry/src/github.com-1ecc6299db9ec823/rowan-0.13.0/src/cursor.rs:538:21

SUMMARY: LeakSanitizer: 260381128 byte(s) leaked in 2690934 allocation(s).
</code></pre></div>



<a name="250378850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250378850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250378850">(Aug 23 2021 at 16:50)</a>:</h4>
<p>I don't have anything better than that. And wow, 260 MB.</p>



<a name="250379108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250379108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250379108">(Aug 23 2021 at 16:52)</a>:</h4>
<p><span class="user-mention" data-user-id="203546">@Laurențiu</span> yeah, thats "TODO: optimize later". I wanted to get the right API which operates with bulk changes, but was lazy on the implementation side and impled only the simple case for one node chang</p>



<a name="250379461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250379461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250379461">(Aug 23 2021 at 16:55)</a>:</h4>
<p>ye 260MB sounds correct given we already leaked the same way before this regression <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="250381512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250381512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250381512">(Aug 23 2021 at 17:09)</a>:</h4>
<p><code>ast::edit::test_increase_indent</code> leaks too, maybe it helps with a minimization (not sure why it would, though).</p>



<a name="250385364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250385364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250385364">(Aug 23 2021 at 17:38)</a>:</h4>
<p>So if I understand this correctly, root green nodes have an increased ref count of one right?</p>



<a name="250385559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250385559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250385559">(Aug 23 2021 at 17:40)</a>:</h4>
<p>That would mean when attaching a child we have to decrease the ref count of the child by one as the child is always rooted and once attached it loses its "root status"</p>



<a name="250385580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250385580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250385580">(Aug 23 2021 at 17:40)</a>:</h4>
<p>Which I don't think attach_child does?</p>



<a name="250385745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250385745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250385745">(Aug 23 2021 at 17:41)</a>:</h4>
<p>Yeah, this seems reasonable!</p>



<a name="250387029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250387029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250387029">(Aug 23 2021 at 17:52)</a>:</h4>
<p>Hmm nope, now im getting panics</p>



<a name="250387053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250387053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250387053">(Aug 23 2021 at 17:52)</a>:</h4>
<p><code>GreenNode/GreenToken::from_raw</code> would be the way to decrease the ref count right?</p>



<a name="250387143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250387143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250387143">(Aug 23 2021 at 17:53)</a>:</h4>
<p>I don't think so. You want to decrease the ref count <em>after</em> you attach the node. That code path seems to create the <code>GreenNode</code> before inserting it.</p>



<a name="250388862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250388862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250388862">(Aug 23 2021 at 18:07)</a>:</h4>
<p>Tried doing that as well with no luck</p>



<a name="250388890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250388890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250388890">(Aug 23 2021 at 18:07)</a>:</h4>
<p><span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span> really thought that would be the issue</p>



<a name="250389460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250389460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250389460">(Aug 23 2021 at 18:12)</a>:</h4>
<p>"This crate is primarily tested by various integration tests in rust-analyzer." <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="250390144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250390144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250390144">(Aug 23 2021 at 18:18)</a>:</h4>
<p>After today, I should add "and by recording videos of <span class="user-mention" data-user-id="133169">@matklad</span> coding"</p>



<a name="250390268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250390268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250390268">(Aug 23 2021 at 18:19)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/10003">https://github.com/rust-analyzer/rust-analyzer/pull/10003</a></p>



<a name="250390561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250390561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250390561">(Aug 23 2021 at 18:20)</a>:</h4>
<p>Clawed back some bytes when fixing an unrelated issue. Curious -- can we go OOM by running <code>ast::edit::test_increase_indent</code> in a loop?  <code>loop {}</code> is my fav leak detector!</p>



<a name="250390727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250390727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250390727">(Aug 23 2021 at 18:21)</a>:</h4>
<p>I have some small set of unit tests in <code>cstree</code> that has been really helpful. As I made tree nodes <code>Send</code> and <code>Sync</code> again, I've been through a lot of ref count shenanigans between different threads, and used sanitizers extensively. The tests are useful for that, and can also run the sanitizers in CI. The basic tests should be easy to translate back to <code>rowan</code> and the CI config could be used directly if that'd help you</p>



<a name="250391133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391133">(Aug 23 2021 at 18:23)</a>:</h4>
<p><code>cstree</code> doesn't have the cursed mutable trees does it, cause the issue lies in some logic with those</p>



<a name="250391259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391259">(Aug 23 2021 at 18:24)</a>:</h4>
<p>So it actually looks like we aren't leaking the inserted children, but the thing we are inserting into(I think) <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="250391403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391403">(Aug 23 2021 at 18:25)</a>:</h4>
<p>No, I've not had enough time to thing about how one would make that work in a threadsafe way (and that's probably a good thing <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>)</p>



<a name="250391589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391589">(Aug 23 2021 at 18:26)</a>:</h4>
<p>but from what I read this seems to likely be a refcount issue, which could be detected earlier in CI sanitizer runs</p>



<a name="250391615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391615">(Aug 23 2021 at 18:26)</a>:</h4>
<p>it is most certainly a ref coutn issue</p>



<a name="250391628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391628">(Aug 23 2021 at 18:26)</a>:</h4>
<p>it also happens in a very specfic function only</p>



<a name="250391629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391629">(Aug 23 2021 at 18:26)</a>:</h4>
<p>though you'd need tests that exercise the mutability to cover that path</p>



<a name="250391644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391644">(Aug 23 2021 at 18:27)</a>:</h4>
<p>but i cannot figure out the problem</p>



<a name="250391674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391674">(Aug 23 2021 at 18:27)</a>:</h4>
<p>and i cant seem to reproduce it in a simple test either <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="250391982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250391982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250391982">(Aug 23 2021 at 18:29)</a>:</h4>
<p>you mean one specific function of <code>rowan</code> or of r-a processing?</p>



<a name="250392001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250392001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250392001">(Aug 23 2021 at 18:29)</a>:</h4>
<p>rowan</p>



<a name="250392090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250392090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250392090">(Aug 23 2021 at 18:29)</a>:</h4>
<p>basically all usages of <code>SyntaxNode::splice_children</code> inside RA causes leaks</p>



<a name="250392258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250392258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250392258">(Aug 23 2021 at 18:30)</a>:</h4>
<p>but a simple test with that function doesnt cause it for some reason so there seems to be one more thing to this</p>



<a name="250392936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250392936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250392936">(Aug 23 2021 at 18:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133169">matklad</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Massive.20memory.20regression.20.239979/near/250390561">said</a>:</p>
<blockquote>
<p>Curious -- can we go OOM by running <code>ast::edit::test_increase_indent</code> in a loop?  <code>loop {}</code> is my fav leak detector!</p>
</blockquote>
<p>Of course we can!</p>
<div class="codehilite"><pre><span></span><code>SUMMARY: LeakSanitizer: 944000000 byte(s) leaked in 18000000 allocation(s).
</code></pre></div>



<a name="250393181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250393181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250393181">(Aug 23 2021 at 18:36)</a>:</h4>
<p>hm <code>detach</code> does indeed increase the <code>rc</code></p>



<a name="250393229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250393229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250393229">(Aug 23 2021 at 18:37)</a>:</h4>
<p>and <code>attach_child</code> does as well because it calls <code>detach</code></p>



<a name="250393300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250393300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250393300">(Aug 23 2021 at 18:37)</a>:</h4>
<p>but it does not seem to decrease it again... so what you said earlier does make some sense <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="250394047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394047">(Aug 23 2021 at 18:43)</a>:</h4>
<p>Decreasing it doesn't work though as I get random crashes or panics <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="250394066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394066">(Aug 23 2021 at 18:44)</a>:</h4>
<p>Thinking a bit more about this, I don't think that is the issue</p>



<a name="250394118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394118">(Aug 23 2021 at 18:44)</a>:</h4>
<p>Ye I have a similar feeling by now</p>



<a name="250394125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394125">(Aug 23 2021 at 18:44)</a>:</h4>
<p>but I don't see what else it could be</p>



<a name="250394186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394186">(Aug 23 2021 at 18:44)</a>:</h4>
<p>The increased ref count for detached nodes represents a kind of "external" reference that is justified by the element's root-ness</p>



<a name="250394189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394189">(Aug 23 2021 at 18:44)</a>:</h4>
<p>(That caching fix wins back 29 MB)</p>



<a name="250394273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394273">(Aug 23 2021 at 18:45)</a>:</h4>
<p>Yes but when we attach this new rooted node as a child it should lose that ref again should it not?</p>



<a name="250394299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394299">(Aug 23 2021 at 18:45)</a>:</h4>
<p>If you have an element that is a root and you attach it, you loose this root-ness, but you gain a reference from the new parent to the element</p>



<a name="250394312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394312">(Aug 23 2021 at 18:45)</a>:</h4>
<p>so +- 0</p>



<a name="250394438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394438">(Aug 23 2021 at 18:46)</a>:</h4>
<p>hmm right, we point in both directions I suppose</p>



<a name="250394505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394505">(Aug 23 2021 at 18:47)</a>:</h4>
<p>In other words, the increased ref count is the regular or normal state, and a decreased count of root elements would be out of the ordinary</p>



<a name="250394529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394529">(Aug 23 2021 at 18:47)</a>:</h4>
<p>Do we <code>self.inc_rc()</code> in <code>attach_child</code> because there's a reference from the child to the current node?</p>



<a name="250394580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394580">(Aug 23 2021 at 18:47)</a>:</h4>
<p><code>self</code> is the parent, and children point to the parent so we increase due to the new child pointing to <code>self</code></p>



<a name="250394600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250394600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250394600">(Aug 23 2021 at 18:47)</a>:</h4>
<p>would make sense yeah</p>



<a name="250395396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250395396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250395396">(Aug 23 2021 at 18:53)</a>:</h4>
<p>Maybe the issue is that sometimes it is wrong to grant elements special root-ness protection?</p>



<a name="250395545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250395545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250395545">(Aug 23 2021 at 18:54)</a>:</h4>
<p>I'm not familiar from before with the mutability code, since that was after <code>cstree</code>, but <code>splice_children</code> looks like the children it calls <code>detached</code> on are supposed to actually be deleted and go away</p>



<a name="250395751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250395751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250395751">(Aug 23 2021 at 18:56)</a>:</h4>
<p>direct calls to the public <code>detach</code>s go through a ref to a syntax thing. So <code>NodeData::detach</code> assumes that you are holding onto the detached node</p>



<a name="250395773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250395773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250395773">(Aug 23 2021 at 18:56)</a>:</h4>
<p>but in case of <code>splice_chidren</code>, you aren't?</p>



<a name="250395905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250395905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250395905">(Aug 23 2021 at 18:57)</a>:</h4>
<p>In <code>splice_children</code> we are holding onto the original item though in the for loops body</p>



<a name="250395944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250395944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250395944">(Aug 23 2021 at 18:58)</a>:</h4>
<p>the <code>child</code> local is owned</p>



<a name="250396039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250396039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250396039">(Aug 23 2021 at 18:59)</a>:</h4>
<p>will run the thing with <code>attach_child</code> commented out thought, if it still leaks then we know its detach inside splice_children at least</p>



<a name="250396122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250396122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250396122">(Aug 23 2021 at 18:59)</a>:</h4>
<p><span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="250396131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250396131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250396131">(Aug 23 2021 at 18:59)</a>:</h4>
<p>it actually does still leak</p>



<a name="250396332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250396332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250396332">(Aug 23 2021 at 19:00)</a>:</h4>
<p>oh wait no somethings odd</p>



<a name="250396416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250396416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250396416">(Aug 23 2021 at 19:01)</a>:</h4>
<p>Hmm, I think it might leak only if there's more than one token</p>



<a name="250397008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250397008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250397008">(Aug 23 2021 at 19:05)</a>:</h4>
<p>Okay so it actually does seem to be the detach in <code>splice_children</code></p>



<a name="250397133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250397133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250397133">(Aug 23 2021 at 19:06)</a>:</h4>
<p>with <code>attach_child</code> commented out we still seem to leak the same amount</p>



<a name="250398489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250398489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250398489">(Aug 23 2021 at 19:16)</a>:</h4>
<p>Do you have a test case?</p>



<a name="250398498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250398498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250398498">(Aug 23 2021 at 19:16)</a>:</h4>
<p>This one seems to work for me:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_increase_indent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">whitespace</span><span class="p">(</span><span class="n">text</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">SyntaxToken</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SourceFile</span>::<span class="n">parse</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">ok</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">sf</span><span class="p">.</span><span class="n">syntax</span><span class="p">().</span><span class="n">clone_for_update</span><span class="p">().</span><span class="n">first_child_or_token</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">into_token</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">new_ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">whitespace</span><span class="p">(</span><span class="s">" "</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">whitespace</span><span class="p">(</span><span class="s">" "</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ted</span>::<span class="n">replace</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_ws</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="250398562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250398562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250398562">(Aug 23 2021 at 19:17)</a>:</h4>
<p>It leaks exactly 2*1000 + 1 allocations.</p>



<a name="250398618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250398618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250398618">(Aug 23 2021 at 19:17)</a>:</h4>
<p>Oh sweet, I did not have one yet</p>



<a name="250398631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250398631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250398631">(Aug 23 2021 at 19:17)</a>:</h4>
<p>Thought I tried to make one for rowan specifically</p>



<a name="250399012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250399012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250399012">(Aug 23 2021 at 19:21)</a>:</h4>
<p>That number is very sus <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="250399638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250399638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250399638">(Aug 23 2021 at 19:26)</a>:</h4>
<p>Sweet that does reproduce in rowan itself</p>



<a name="250399842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250399842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250399842">(Aug 23 2021 at 19:28)</a>:</h4>
<p>Now I can run miri over this</p>



<a name="250399860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250399860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250399860">(Aug 23 2021 at 19:28)</a>:</h4>
<p>and it also reports a leak <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> not sure if this will be helpful, probably not</p>



<a name="250399918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250399918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250399918">(Aug 23 2021 at 19:28)</a>:</h4>
<p>was hoping it might find some unsoundness but it doesnt seem like it</p>



<a name="250399952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250399952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250399952">(Aug 23 2021 at 19:29)</a>:</h4>
<p>But ye this confirms the leak is indeed in detach somewhere</p>



<a name="250400093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250400093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250400093">(Aug 23 2021 at 19:30)</a>:</h4>
<p>Also, if I make a single <code>token</code> and clone it, it only leaks 136 bytes in 3 allocations.</p>



<a name="250400570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250400570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250400570">(Aug 23 2021 at 19:34)</a>:</h4>
<p>Interesting, so the detach leaks 1000 out of 2001 Greenodes and 1000 out of 4003 NodeData</p>



<a name="250400577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250400577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250400577">(Aug 23 2021 at 19:34)</a>:</h4>
<p>while the attach_node leaks a single GreenToken</p>



<a name="250400786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250400786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250400786">(Aug 23 2021 at 19:36)</a>:</h4>
<p>I think we're mainly leaking <code>token</code> there (as opposed to <code>new_ws.clone()</code>)</p>



<a name="250400888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250400888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250400888">(Aug 23 2021 at 19:37)</a>:</h4>
<p>Valgrind points to the allocation done by <code>clone_for_update()</code> for that</p>



<a name="250401718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250401718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250401718">(Aug 23 2021 at 19:44)</a>:</h4>
<p>Ye that one is obvious since this only happens on mutable trees</p>



<a name="250401740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250401740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250401740">(Aug 23 2021 at 19:44)</a>:</h4>
<p><code>clone_for_update</code> is the only location where we create such trees</p>



<a name="250402065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402065">(Aug 23 2021 at 19:47)</a>:</h4>
<p>Yeah, it wasn't obvious to me that we weren't (also) leaking the replacement node</p>



<a name="250402104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402104">(Aug 23 2021 at 19:47)</a>:</h4>
<p>ah ye, so we seem to have two different leaks here</p>



<a name="250402301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402301">(Aug 23 2021 at 19:49)</a>:</h4>
<p>Valgrind puts it like "definitely lost: 640,000 bytes in 10,000 blocks (the mutable stuff), indirectly lost: 720,000 bytes in 20,000 blocks"</p>



<a name="250402364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402364">(Aug 23 2021 at 19:49)</a>:</h4>
<p>So on each iteration we're leaking one mutable node and two other allocations linked to them. Why two? No idea.</p>



<a name="250402485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402485">(Aug 23 2021 at 19:50)</a>:</h4>
<p>so</p>



<a name="250402495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402495">(Aug 23 2021 at 19:50)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="n">children_with_tokens</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">child</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this leaks</p>



<a name="250402504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402504">(Aug 23 2021 at 19:50)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">old</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>this doesnt</p>



<a name="250402584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402584">(Aug 23 2021 at 19:51)</a>:</h4>
<p>oh, just iterating <code>children_with_tokens</code> leaks already</p>



<a name="250402595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402595">(Aug 23 2021 at 19:52)</a>:</h4>
<p>not the detach</p>



<a name="250402889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402889">(Aug 23 2021 at 19:54)</a>:</h4>
<p>does <code>token_at_offset</code> leak?</p>



<a name="250402905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250402905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250402905">(Aug 23 2021 at 19:55)</a>:</h4>
<p>that's the only other place that uses that</p>



<a name="250403050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250403050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250403050">(Aug 23 2021 at 19:56)</a>:</h4>
<p>Oh, you don't even have to iterate over it.</p>



<a name="250403076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250403076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250403076">(Aug 23 2021 at 19:56)</a>:</h4>
<p>Ye jsut noticed that too</p>



<a name="250403217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250403217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250403217">(Aug 23 2021 at 19:57)</a>:</h4>
<p>Then it's from <code>first_child_or_token</code></p>



<a name="250403242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250403242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250403242">(Aug 23 2021 at 19:57)</a>:</h4>
<p>Yep, trying to figure out where it touches the rc though</p>



<a name="250403435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250403435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250403435">(Aug 23 2021 at 19:59)</a>:</h4>
<p>ah the NodeData constructor has a special branch that modifies it for when its mutable</p>



<a name="250405890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250405890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250405890">(Aug 23 2021 at 20:19)</a>:</h4>
<p>Found the issue</p>



<a name="250405893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250405893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250405893">(Aug 23 2021 at 20:19)</a>:</h4>
<p>or at least one</p>



<a name="250405894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250405894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250405894">(Aug 23 2021 at 20:19)</a>:</h4>
<p>finally</p>



<a name="250408354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408354">(Aug 23 2021 at 20:40)</a>:</h4>
<p>do tell</p>



<a name="250408819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408819">(Aug 23 2021 at 20:43)</a>:</h4>
<p>Still working on properly fixing it but I think this is the entire problem</p>



<a name="250408820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408820">(Aug 23 2021 at 20:43)</a>:</h4>
<p>one sec</p>



<a name="250408878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408878">(Aug 23 2021 at 20:44)</a>:</h4>
<p><a href="https://github.com/Veykril/rowan/blob/ea763c97c64830c4f16016d5e9576ee2efd9d5f5/src/cursor.rs#L222-L271">https://github.com/Veykril/rowan/blob/ea763c97c64830c4f16016d5e9576ee2efd9d5f5/src/cursor.rs#L222-L271</a></p>



<a name="250408904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408904">(Aug 23 2021 at 20:44)</a>:</h4>
<p>We are leaking <code>parent: Option&lt;SyntaxNode&gt;</code> in the mutable path</p>



<a name="250408941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408941">(Aug 23 2021 at 20:44)</a>:</h4>
<p>the <code>Box::from_raw(res);</code> only prevents the heap alloc from being leaked</p>



<a name="250408958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250408958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250408958">(Aug 23 2021 at 20:44)</a>:</h4>
<p>but the code doesnt run the syntaxnode destructor</p>



<a name="250409163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409163">(Aug 23 2021 at 20:46)</a>:</h4>
<p>Okay running RA with a fix now lets see if this works</p>



<a name="250409165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409165">(Aug 23 2021 at 20:46)</a>:</h4>
<p><span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="250409293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409293">(Aug 23 2021 at 20:48)</a>:</h4>
<p>I somehow completely overlooked that <code>ManuallyDrop</code> lol</p>



<a name="250409354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409354">(Aug 23 2021 at 20:48)</a>:</h4>
<p>same I looked at this pretty early Im pretty sure</p>



<a name="250409363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409363">(Aug 23 2021 at 20:48)</a>:</h4>
<p>the Box::from_raw made it look like all is well</p>



<a name="250409452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409452">(Aug 23 2021 at 20:49)</a>:</h4>
<p>dammit gotta restart the compilation forgot my debug prints</p>



<a name="250409460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409460">(Aug 23 2021 at 20:49)</a>:</h4>
<p>yeah also cause the struct init looks like, well, just some struct init, and one assumes the interesting stuff is in the <code>unsafe</code></p>



<a name="250409476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409476">(Aug 23 2021 at 20:49)</a>:</h4>
<p>Really aint fun when you have to rebuild 20 crates for this</p>



<a name="250409507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409507">(Aug 23 2021 at 20:49)</a>:</h4>
<p>Ye the code looks completely fine unfortunately</p>



<a name="250409703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409703">(Aug 23 2021 at 20:51)</a>:</h4>
<div class="codehilite"><pre><span></span><code>hir_def::item_scope::ItemScope                                                                   3_503        3_503            0
hir_def::item_tree::ItemTree                                                                    33_922       33_922            0
hir_def::nameres::DefMap                                                                           606          606            0
hir_expand::ast_id_map::AstIdMap                                                                33_988       33_929            0
rowan::green::node::GreenNode                                                                7_234_717      601_467            0
rowan::green::token::GreenToken                                                              3_185_267      407_472            0
rowan::utility_types::NodeOrToken&lt;rowan::cursor::SyntaxNode, rowan::cursor::SyntaxToken&gt;    83_766_530       30_383            0
                                                                                                 total     max_live         live
</code></pre></div>



<a name="250409759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250409759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250409759">(Aug 23 2021 at 20:51)</a>:</h4>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="250410049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250410049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250410049">(Aug 23 2021 at 20:53)</a>:</h4>
<p>Are you running the same thing as before? The totals are much lower (7/3M vs. 11/5).</p>



<a name="250410269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250410269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250410269">(Aug 23 2021 at 20:55)</a>:</h4>
<p>that is on the commit of this PR</p>



<a name="250410362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250410362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250410362">(Aug 23 2021 at 20:56)</a>:</h4>
<p>And Im not using the newest rowan i think</p>



<a name="250410379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250410379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250410379">(Aug 23 2021 at 20:56)</a>:</h4>
<p><span aria-label="popcorn" class="emoji emoji-1f37f" role="img" title="popcorn">:popcorn:</span></p>



<a name="250410381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250410381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250410381">(Aug 23 2021 at 20:56)</a>:</h4>
<p>im missing matklads latest commit I think?</p>



<a name="250411509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250411509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250411509">(Aug 23 2021 at 21:04)</a>:</h4>
<div class="codehilite"><pre><span></span><code>hir_def::item_scope::ItemScope           3_504        3_504            0
hir_def::item_tree::ItemTree            33_924       33_924            0
hir_def::nameres::DefMap                   606          606            0
hir_expand::ast_id_map::AstIdMap        33_990       33_931            0
rowan::cursor::_SyntaxElement       83_602_911       30_383            0
rowan::green::node::GreenNode        6_158_073      542_569            0
rowan::green::token::GreenToken      2_151_427      319_055            0
                                         total     max_live         live
</code></pre></div>



<a name="250411512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250411512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250411512">(Aug 23 2021 at 21:04)</a>:</h4>
<p>with newest rowan master</p>



<a name="250411852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250411852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250411852">(Aug 23 2021 at 21:07)</a>:</h4>
<p>It looks great, but I don't understand why so much fewer nodes than before</p>



<a name="250412127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412127">(Aug 23 2021 at 21:09)</a>:</h4>
<p>I'm not sure I understand, I was having 7/3 mil before as well</p>



<a name="250412161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412161">(Aug 23 2021 at 21:09)</a>:</h4>
<p>oh huh not at the very beginning</p>



<a name="250412173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412173">(Aug 23 2021 at 21:09)</a>:</h4>
<p>oh</p>



<a name="250412219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412219">(Aug 23 2021 at 21:10)</a>:</h4>
<p>(deleted)</p>



<a name="250412260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412260">(Aug 23 2021 at 21:10)</a>:</h4>
<p>the 5/11 was with crates io pre 13 rowan</p>



<a name="250412282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412282">(Aug 23 2021 at 21:10)</a>:</h4>
<p>the 3/7 was with 13.0 rowan</p>



<a name="250412287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412287">(Aug 23 2021 at 21:10)</a>:</h4>
<p>and 2/6 is with 13.1</p>



<a name="250412711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250412711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250412711">(Aug 23 2021 at 21:13)</a>:</h4>
<p>Actually the first numbers might be due to me running inference there still?</p>



<a name="250413192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250413192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250413192">(Aug 23 2021 at 21:17)</a>:</h4>
<p>Maybe. I don't think these any difference between pre.8 and 13.0</p>



<a name="250413406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250413406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250413406">(Aug 23 2021 at 21:19)</a>:</h4>
<p>Ye pre8 and 13.0 dont really have differences</p>



<a name="250413610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250413610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250413610">(Aug 23 2021 at 21:20)</a>:</h4>
<p>Want to bump the RA dep?</p>



<a name="250413841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250413841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250413841">(Aug 23 2021 at 21:22)</a>:</h4>
<p>about to</p>



<a name="250413875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250413875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250413875">(Aug 23 2021 at 21:23)</a>:</h4>
<p>had to fight git just now because it wasn't agreeing with me</p>



<a name="250413979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250413979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250413979">(Aug 23 2021 at 21:24)</a>:</h4>
<p>Thanks a lot for that small repro btw, that was immensely helpful in figuring this out <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="250414180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250414180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250414180">(Aug 23 2021 at 21:25)</a>:</h4>
<p>Yeah, looks like I'm spending a bit of time minimizing test cases. But great find there, I don't think I would have noticed it.</p>



<a name="250414350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250414350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250414350">(Aug 23 2021 at 21:27)</a>:</h4>
<p>Excited to see the memory usage after this now</p>



<a name="250414381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250414381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250414381">(Aug 23 2021 at 21:27)</a>:</h4>
<p>This + the aching fix should give us quite some improvements again, especially since we were already leaking memory due to this bug for attributes</p>



<a name="250414412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250414412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250414412">(Aug 23 2021 at 21:27)</a>:</h4>
<p>and assists were leaking memory as well on each use due to this</p>



<a name="250414418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250414418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250414418">(Aug 23 2021 at 21:28)</a>:</h4>
<p>Probably back to what it was before, plus some 29 MB from the caching</p>



<a name="250414759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250414759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250414759">(Aug 23 2021 at 21:30)</a>:</h4>
<p>This should claim back a bit more  since attributes node rewriting already used the buggy code, but ye I guess not too much since attributes arent used as much</p>



<a name="250418462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250418462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250418462">(Aug 23 2021 at 22:07)</a>:</h4>
<p>We are down to 1018mb now <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="250444060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Massive%20memory%20regression%20%239979/near/250444060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Massive.20memory.20regression.20.239979.html#250444060">(Aug 24 2021 at 05:31)</a>:</h4>
<p>And we pass LSAN</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>