<html>
<head><meta charset="utf-8"><title>Statements inside for loop body · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html">Statements inside for loop body</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269414662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269414662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269414662">(Jan 26 2022 at 13:58)</a>:</h4>
<p>Hi, I'm working on enhancing a rust-analyzer code assist, and running into a problem with statements. How come that upon analyzing the following code, for_expr.loop_body().statements() (where for_expr is a ForExpr) retrieves only the <code>let</code> statement and not the <code>if</code> one?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(btw not sure if it is the right streams for this kind of question)</p>



<a name="269415368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269415368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269415368">(Jan 26 2022 at 14:02)</a>:</h4>
<p>the simple answer is that the loop body is a block expression, and the <code>if</code> expression in there is the trailing expression of the block. If you were to add a semicolon after that closing brace of the <code>if</code> it would get included in the statements.</p>



<a name="269415427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269415427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269415427">(Jan 26 2022 at 14:03)</a>:</h4>
<p>So you need to iterate the bodies statements <em>and</em> check the tail expression of the body to get everything here</p>



<a name="269415691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269415691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269415691">(Jan 26 2022 at 14:04)</a>:</h4>
<p>thx!</p>



<a name="269426079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269426079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269426079">(Jan 26 2022 at 15:08)</a>:</h4>
<p>Same topic but not really the same question, I am now looking to extract the pattern (Pat) from the for loop, and if it is an IdentPat (the only case I am covering here), to remove any mut token and then to put it somewhere in the refactored code. I can't find how to remove a mut token from a (Ident)Pat (I can see if there is one, but can't remove it), how would I do that? (There's <a href="http://remove_mut.rs">remove_mut.rs</a> which does that but in a way I can't reproduce easily in my specific case)</p>



<a name="269426812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269426812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269426812">(Jan 26 2022 at 15:13)</a>:</h4>
<p>what you can do is <code>clone_for_update()</code> the pattern node, then fetch the mut token of that clone and do <code>mut_tok.syntax().detach()</code> iirc, though that will leave you with an extra whitespace in the node</p>



<a name="269426880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269426880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269426880">(Jan 26 2022 at 15:14)</a>:</h4>
<p>The simplest way would most likely be to just reconstruct the <code>IdentPat</code> without the mut token</p>



<a name="269427221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269427221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269427221">(Jan 26 2022 at 15:16)</a>:</h4>
<p>that is change <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/syntax/src/ast/make.rs#L448-L459">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/syntax/src/ast/make.rs#L448-L459</a> so that it supports the inner pattern by changing its current signature and impl to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">ident_pat</span><span class="p">(</span><span class="n">ref_</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">mut_</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>: <span class="nc">ast</span>::<span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">inner</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">ast</span>::<span class="n">Pat</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ast</span>::<span class="n">IdentPat</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"fn f("</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ref_</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">"ref "</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">mut_</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">"mut "</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">format_to</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inner</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">format_to</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">inner</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">push_str</span><span class="p">(</span><span class="s">": ())"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">ast_from_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="269427302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269427302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269427302">(Jan 26 2022 at 15:16)</a>:</h4>
<p>then you should be able to just take your current ident pat apart, and reconstruct it with that function always passing <code>false</code> for <code>mut_</code></p>



<a name="269427405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269427405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269427405">(Jan 26 2022 at 15:17)</a>:</h4>
<p>Will that eat the comments, though?</p>



<a name="269429452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269429452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269429452">(Jan 26 2022 at 15:30)</a>:</h4>
<p>it would(also any attributes that may appear there), thats a general downside of the reconstruction stuff(while the mutable api retains them)</p>



<a name="269430676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269430676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269430676">(Jan 26 2022 at 15:38)</a>:</h4>
<p>Hmm I don't understand the thing about adding an inner argument to ident_pat<br>
Is there no way to just get the name from an IdentPat? That way I could <code>make::ident_pat(false,false,name)</code> (not sure I even need to keep ref too, I need this pattern in a .filter() closure)</p>



<a name="269430789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269430789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269430789">(Jan 26 2022 at 15:38)</a>:</h4>
<p>That would work but not if you have a pattern like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">baz</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="269430796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269430796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269430796">(Jan 26 2022 at 15:38)</a>:</h4>
<p>Otherwise I'll just go for cloning and updating, regardless of the extraneous whitespace (or is it a way to remove that whitespace too?)</p>



<a name="269430869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269430869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269430869">(Jan 26 2022 at 15:39)</a>:</h4>
<p>What does this code do ? I don't know about the @ pattern</p>



<a name="269431058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269431058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269431058">(Jan 26 2022 at 15:40)</a>:</h4>
<p>My current test against which I'm compiling is this: <br>
Transform</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>into this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="n">filter</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">).</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>



<a name="269431105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269431105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269431105">(Jan 26 2022 at 15:40)</a>:</h4>
<p>Actually, you should be able to do something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mut_token</span><span class="p">.</span><span class="n">syntax</span><span class="p">().</span><span class="n">next_token</span><span class="p">().</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="n">it</span><span class="o">|</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WHITESPACE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ws</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">mut_token</span><span class="p">.</span><span class="n">syntax</span><span class="p">().</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>which should get rid of extra whitespace following the mut token(this is with the <code>clone_for_update</code> version)</p>



<a name="269431299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269431299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269431299">(Jan 26 2022 at 15:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="474550">AppCoder1234</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Statements.20inside.20for.20loop.20body/near/269430869">말함</a>:</p>
<blockquote>
<p>What does this code do ? I don't know about the @ pattern</p>
</blockquote>
<p>@ allows you to bind a matched pattern to an identifier, a better example is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_optional_value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="c1">// this branch only gets taken if `some_optional_value` is `Some`, `foo` has the value of `some_optional_value`  though, not the inner part of the Option</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(I wonder if there is a even a good resource on the @ operator, when I learned rust it wasnt really well explained in the book, in fact it only had one small paragraph I think <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span>)</p>



<a name="269431731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269431731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269431731">(Jan 26 2022 at 15:44)</a>:</h4>
<p>Oh I see, well it won't ease my refactoring code ^^. I'll guess I'll save that for later, through is there really a case where this (@ patterns) would be useful inside for loops?</p>



<a name="269432030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269432030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269432030">(Jan 26 2022 at 15:46)</a>:</h4>
<p>very rarely if at all I imagine, people tend to not use <code>@</code> that much in general from what I've seen, though with nested or-patterns it is more useful now.<br>
Note that if you go with the <code>clone_for_update</code> thing you automatically support the <code>@</code> construct since you modify the original node</p>



<a name="269432766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269432766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269432766">(Jan 26 2022 at 15:50)</a>:</h4>
<p>An aside: if interested the rust book part explaining @ patterns -&gt; <a href="https://doc.rust-lang.org/stable/book/ch18-03-pattern-syntax.html#-bindings">ch18-03-pattern-syntax.html#-bindings</a></p>



<a name="269436105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436105">(Jan 26 2022 at 16:07)</a>:</h4>
<p>Can I get the (optional) mut token from any kind of Pat? It seems like I can get it only forPatIdent ones, but somehow I  thought you implied I could get it from any Pat. Did I miss something?<br>
Btw I find it hard to understand what the other variants of Pat stand for (except for Ident and Wildcard), for example would your @ pattern be classified as a IdentPat ?</p>



<a name="269436283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436283">(Jan 26 2022 at 16:08)</a>:</h4>
<p>No, only <code>IdentPat</code> uses the <code>mut</code> token, as it is the only pattern that introduces new locals. @ pattern is part of <code>IdentPat</code> yes</p>



<a name="269436353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436353">(Jan 26 2022 at 16:08)</a>:</h4>
<p>You can take a look at the ungrammar file(which we generate our AST from) <a href="https://github.com/rust-analyzer/ungrammar/blob/master/rust.ungram#L578-L660">https://github.com/rust-analyzer/ungrammar/blob/master/rust.ungram#L578-L660</a><br>
That should help you understand what the variants stand for</p>



<a name="269436414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436414">(Jan 26 2022 at 16:09)</a>:</h4>
<p>So it means I couldn't handle cases like (a,b) right? Or I would have to recursively check for mut inside there parenthesized patterns to remove it too</p>



<a name="269436420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436420">(Jan 26 2022 at 16:09)</a>:</h4>
<p>The top of the file describes the ungrammar format itself: <a href="https://github.com/rust-analyzer/ungrammar/blob/master/rust.ungram#L1-L17">https://github.com/rust-analyzer/ungrammar/blob/master/rust.ungram#L1-L17</a></p>



<a name="269436516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436516">(Jan 26 2022 at 16:09)</a>:</h4>
<p>Yes if you want to touch nested <code>IdentPat</code>s you would have to recurse the node fully</p>



<a name="269436678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436678">(Jan 26 2022 at 16:10)</a>:</h4>
<p>We should have a visitor function for that already though one sec</p>



<a name="269436760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436760">(Jan 26 2022 at 16:10)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_db/src/helpers/node_ext.rs#L145-L169">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_db/src/helpers/node_ext.rs#L145-L169</a></p>



<a name="269436800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436800">(Jan 26 2022 at 16:11)</a>:</h4>
<p>What's quite hard when implementing code assists is to thing about every code there could exist ^^</p>



<a name="269436936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269436936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269436936">(Jan 26 2022 at 16:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Statements.20inside.20for.20loop.20body/near/269436760">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_db/src/helpers/node_ext.rs#L145-L169">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_db/src/helpers/node_ext.rs#L145-L169</a></p>
</blockquote>
<p>Is there a mutable one?</p>



<a name="269437016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269437016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269437016">(Jan 26 2022 at 16:12)</a>:</h4>
<p>So what yo ucould do is <code>clone_for_update</code> the pattern node, then walk it with that function, record all the tokens you want to remove in a vec, then iterate the vec and call detach on all the tokens in there.</p>
<p>The reason for the vec is that if you were to detach while walking the tree you'd ruin the indices, either removing things you dont want to remove or panic.</p>



<a name="269437101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269437101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269437101">(Jan 26 2022 at 16:12)</a>:</h4>
<p>(so basically avoiding the problem of iterating and modifying a collection at the same time, which rust itself protects you against usually, the mutable tree api unfortunately does not)</p>



<a name="269437134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269437134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269437134">(Jan 26 2022 at 16:13)</a>:</h4>
<p>Okay I'll do it that way then thanks</p>



<a name="269437242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/269437242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#269437242">(Jan 26 2022 at 16:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="474550">AppCoder1234</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Statements.20inside.20for.20loop.20body/near/269436800">말함</a>:</p>
<blockquote>
<p>What's quite hard when implementing code assists is to thing about every code there could exist ^^</p>
</blockquote>
<p>Ye depending on the assist there is a lot to keep in mind unfortunately</p>



<a name="272127280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/272127280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#272127280">(Feb 16 2022 at 15:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Statements.20inside.20for.20loop.20body/near/269437016">said</a>:</p>
<blockquote>
<p>So what yo ucould do is <code>clone_for_update</code> the pattern node, then walk it with that function, record all the tokens you want to remove in a vec, then iterate the vec and call detach on all the tokens in there.</p>
<p>The reason for the vec is that if you were to detach while walking the tree you'd ruin the indices, either removing things you dont want to remove or panic.</p>
</blockquote>
<p>I'm trying to implement what you advised me to do. I cloned the pattern, walked through it with walk_pat to detect and pushed mutable tokens into a Vec&lt;SyntaxToken&lt;RustLanguage&gt;&gt;  for them to be removed later. Unfortunately it is not doing anything (mut tokens are still there in my cloned-for-update pattern after I seemingly <code>detach</code>ed them while iterating my vec). I think I'm missing something because I've got the impression that I could be removing these mut tokens directly in the closure since the borrow checker is not complaining against it. So it seems like I don't work on references when walking through the Pattern Tree but likely on clones. What can I do to modify (remove) the mut tokens directly? And by the way, what do SyntaxToken truly stand for (I've been looking on <a href="http://docs.rs">docs.rs</a> but it doesn't give me much info), ie what is the difference btw having a SyntaxToken and a &amp;SyntaxToken?</p>



<a name="272129637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/272129637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#272129637">(Feb 16 2022 at 15:21)</a>:</h4>
<p>Iterating and detaching at the same time won't be caught at compile time as our syntax trees use interior mutability. So it is likely that you will either panic or not see all changes properly if you iterate and modify at the same time.<br>
There isnt really a difference between SyntaxToken and &amp;SyntaxToken, SyntaxToken is just a ref counted pointer to the actual token-data.</p>



<a name="272129965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/272129965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#272129965">(Feb 16 2022 at 15:24)</a>:</h4>
<p>In very rough pseudo-code all you wanna do should basically be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">cloned_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">clone_for_update</span><span class="p">();</span><span class="w"></span>
<span class="c1">// iter cloned_node for mut tokens to remove</span>
<span class="c1">// remove the tokens via detach</span>
<span class="c1">// cloned_node should now no longer have the mut tokens</span>
</code></pre></div>
<p>important part being to basically not use the original node for anything at this point as the non-<code>clone_for_update</code> node won't be changed from this.<br>
To debug this behaviour you could first check if detaching a single token works at all.</p>



<a name="272131143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Statements%20inside%20for%20loop%20body/near/272131143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AppCoder1234 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Statements.20inside.20for.20loop.20body.html#272131143">(Feb 16 2022 at 15:32)</a>:</h4>
<p>My bad, it's working as intended, I just somehow got the filter closure and for_each closure mixed up and turned out wondering why mut weren't removed from my for_each closure <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>