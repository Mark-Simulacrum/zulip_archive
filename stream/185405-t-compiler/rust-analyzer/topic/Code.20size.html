<html>
<head><meta charset="utf-8"><title>Code size · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html">Code size</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258078947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258078947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258078947">(Oct 18 2021 at 18:44)</a>:</h4>
<p>Looks like our <code>text</code> size is about 16 MB on Linux, that seems a bit excessive. Out of curiosity, I commented out the assists and it dropped by 1.15 MB.</p>



<a name="258079555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258079555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258079555">(Oct 18 2021 at 18:48)</a>:</h4>
<p>Fun fact: Windows 3.11 was around 10-15 MB (all of it, not just the code, of course).</p>



<a name="258152075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258152075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258152075">(Oct 19 2021 at 07:18)</a>:</h4>
<p>Dropped <em>by</em>, not dropped <em>to</em>, right? That is, without asists is 13.45?</p>



<a name="258152349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258152349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258152349">(Oct 19 2021 at 07:20)</a>:</h4>
<p>Yeah, it's not like we can do miracles here :D</p>



<a name="258152703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258152703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258152703">(Oct 19 2021 at 07:24)</a>:</h4>
<p>I wouldn't be surprised if we have a couple of more things like <a href="https://github.com/rust-lang/rust/issues/88438">https://github.com/rust-lang/rust/issues/88438</a>. </p>
<p>I guess, what would be fun is to get LLVM IR after linking (can we get that with LTO?) and analyze the size of functions</p>



<a name="258163982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258163982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258163982">(Oct 19 2021 at 09:13)</a>:</h4>
<p>We can also at the binary size, but I'm not sure it's actionable. For example <code>maybe_collect_expr</code> is 52 KB which seems huge, but it's not like making it smaller would help with anything.</p>



<a name="258174130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258174130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258174130">(Oct 19 2021 at 10:49)</a>:</h4>
<p>also <a href="https://prog21.dadgum.com/116.html">https://prog21.dadgum.com/116.html</a></p>



<a name="258175355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258175355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258175355">(Oct 19 2021 at 11:00)</a>:</h4>
<p>I also tried <code>-Oz</code> (it's 10.5 MB but 2x slower) and <code>-Os</code> (11.5 MB but 1.5x slower). No easy wins there either.</p>



<a name="258175433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/258175433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#258175433">(Oct 19 2021 at 11:00)</a>:</h4>
<p>But yeah, 1 MB for the assists seems like a lot</p>



<a name="264411283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264411283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264411283">(Dec 10 2021 at 07:36)</a>:</h4>
<p>Fun thing I noticed: a PGO, non-LTO  RA is 1 MB smaller and 23% faster than a plain one</p>



<a name="264432530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264432530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264432530">(Dec 10 2021 at 11:17)</a>:</h4>
<p>23%, wew that's quite something</p>



<a name="264432707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264432707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264432707">(Dec 10 2021 at 11:19)</a>:</h4>
<p>Yeah, I think we enable LTO on CI and I gave <a href="https://github.com/facebookincubator/BOLT/">https://github.com/facebookincubator/BOLT/</a> a try a while back</p>



<a name="264551328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264551328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264551328">(Dec 11 2021 at 09:02)</a>:</h4>
<p>phoronix had some benchmarking article about bolt recently <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=BOLT-Inches-To-LLVM">https://www.phoronix.com/scan.php?page=news_item&amp;px=BOLT-Inches-To-LLVM</a><br>
lto + pgo + bolt seems to be not so bad :)</p>



<a name="264554651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264554651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264554651">(Dec 11 2021 at 10:24)</a>:</h4>
<p>I know, only it's not clear to me in which order LTO, PGO and BOLT should be applied. And I can't run it in sampling mode because I don't have an Intel CPU.</p>



<a name="264555750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264555750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264555750">(Dec 11 2021 at 10:53)</a>:</h4>
<p>I think lto + pgo work together and then you use bolt on top...? I not studied bolt yet though</p>



<a name="264561257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264561257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264561257">(Dec 11 2021 at 12:53)</a>:</h4>
<p>If you do LTO and PGO, you have to enable LTO for the profile generation phase of PGO in addition to the creation of the final executable. Otherwise PGO won't be able to generate a profile for the LTOed functions and thus will likely ignore a large part of the profile. As for PGO sampling mode  I'm not sure if rustc even supports it in the first place.</p>



<a name="264561525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/264561525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#264561525">(Dec 11 2021 at 12:59)</a>:</h4>
<p>No, I meant the BOLT sampling mode. It uses LBR, which is Intel-only</p>



<a name="266495267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266495267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266495267">(Dec 31 2021 at 10:29)</a>:</h4>
<div class="codehilite"><pre><span></span><code>-rwxr-xr-x 2 grayshade grayshade 1.4G Dec 31 12:28 target/release/rust-analyzer
</code></pre></div>
<p>Woah.</p>



<a name="266495269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266495269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266495269">(Dec 31 2021 at 10:29)</a>:</h4>
<p>(That's <code>debug = 2</code>)</p>



<a name="266495427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266495427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266495427">(Dec 31 2021 at 10:33)</a>:</h4>
<p>And 335 MB with <code>debug = 1</code>.  There's a comment in <code>xtask/src/dist.rs</code> saying something about 43 MB. I guess that's no longer up to date.</p>



<a name="266500430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266500430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266500430">(Dec 31 2021 at 12:14)</a>:</h4>
<p>did you see <code>cargo-bloat</code> btw? :)</p>
<div class="codehilite"><pre><span></span><code>    Analyzing target/release/rust-analyzer

 File  .text     Size Crate
 5.1%  12.8%   2.0MiB rust_analyzer
 4.8%  12.0%   1.8MiB hir_ty
 3.5%   8.7%   1.3MiB hir_def
 2.6%   6.6%   1.0MiB ide_assists
 2.5%   6.3% 990.1KiB std
 2.1%   5.2% 817.5KiB ide_db
 2.0%   4.9% 772.2KiB ide
 1.9%   4.7% 735.8KiB proc_macro_srv
 1.4%   3.4% 530.5KiB salsa
 1.1%   2.9% 445.9KiB hir
 1.1%   2.7% 423.8KiB ide_completion
 0.9%   2.2% 344.8KiB project_model
 0.9%   2.1% 331.9KiB serde_json
 0.8%   2.0% 315.4KiB hir_expand
 0.7%   1.7% 264.3KiB syntax
 0.7%   1.7% 259.2KiB ide_ssr
 0.5%   1.3% 197.3KiB hashbrown
 0.5%   1.2% 191.3KiB flycheck
 0.4%   1.1% 165.9KiB regex_syntax
 0.4%   1.1% 165.5KiB ide_diagnostics
 5.4%  13.3%   2.0MiB And 91 more crates. Use -n N to show more.
40.2% 100.0%  15.3MiB .text section size, the file size is 38.0MiB

Note: numbers above are a result of guesswork. They are not 100% correct and never will be.
</code></pre></div>



<a name="266500452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266500452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266500452">(Dec 31 2021 at 12:15)</a>:</h4>
<div class="codehilite"><pre><span></span><code> File  .text    Size          Crate Name
 0.1%   0.2% 30.9KiB         hir_ty hir_ty::infer::expr::&lt;impl hir_ty::infer::InferenceContext&gt;::infer_expr_inner
 0.1%   0.2% 27.9KiB        hir_def hir_def::body::lower::ExprCollector::maybe_collect_expr
 0.1%   0.1% 21.2KiB         ide_db ide_db::apply_change::&lt;impl ide_db::RootDatabase&gt;::per_query_memory_usage
 0.1%   0.1% 20.7KiB    chalk_solve &lt;chalk_solve::rust_ir::AssociatedTyDatum&lt;I&gt; as chalk_solve::clauses::program_clauses::ToProgramClauses&lt;I&gt;&gt;::to_program_clauses::{{closure}}
 0.1%   0.1% 20.6KiB        hir_def hir_def::nameres::collector::ModCollector::collect
 0.1%   0.1% 20.1KiB        hir_def hir_def::nameres::path_resolution::&lt;impl hir_def::nameres::DefMap&gt;::resolve_path_fp_with_macro_single
 0.1%   0.1% 20.0KiB proc_macro_srv &lt;proc_macro_srv::abis::abi_1_58::proc_macro::bridge::server::Dispatcher&lt;proc_macro_srv::abis::abi_1_58::proc_macro::bridge::server::MarkedTypes&lt;S&gt;&gt; as proc_macro_srv::abis::abi_1_58::proc_macro::bridge::server::DispatcherTrait&gt;::dispatch
 0.1%   0.1% 20.0KiB            std addr2line::ResDwarf&lt;R&gt;::parse
 0.1%   0.1% 19.8KiB         notify notify::inotify::EventLoop::event_loop_thread
 0.1%   0.1% 19.7KiB  rust_analyzer rust_analyzer::main_loop::&lt;impl rust_analyzer::global_state::GlobalState&gt;::handle_event
 0.1%   0.1% 19.5KiB            mbe mbe::expander::matcher::match_loop
 0.0%   0.1% 19.3KiB proc_macro_srv &lt;proc_macro_srv::abis::abi_1_56::proc_macro::bridge::server::Dispatcher&lt;proc_macro_srv::abis::abi_1_56::proc_macro::bridge::server::MarkedTypes&lt;S&gt;&gt; as proc_macro_srv::abis::abi_1_56::proc_macro::bridge::server::DispatcherTrait&gt;::dispatch
 0.0%   0.1% 18.2KiB proc_macro_srv &lt;proc_macro_srv::abis::abi_1_55::proc_macro::bridge::server::Dispatcher&lt;proc_macro_srv::abis::abi_1_55::proc_macro::bridge::server::MarkedTypes&lt;S&gt;&gt; as proc_macro_srv::abis::abi_1_55::proc_macro::bridge::server::DispatcherTrait&gt;::dispatch
 0.0%   0.1% 18.1KiB pulldown_cmark pulldown_cmark::parse::Parser::handle_inline_pass1
 0.0%   0.1% 18.0KiB proc_macro_srv &lt;proc_macro_srv::abis::abi_1_47::proc_macro::bridge::server::Dispatcher&lt;proc_macro_srv::abis::abi_1_47::proc_macro::bridge::server::MarkedTypes&lt;S&gt;&gt; as proc_macro_srv::abis::abi_1_47::proc_macro::bridge::server::DispatcherTrait&gt;::dispatch
 0.0%   0.1% 17.8KiB            std std::backtrace_rs::symbolize::gimli::resolve::{{closure}}
 0.0%   0.1% 16.6KiB  rust_analyzer rust_analyzer::config::field_props
 0.0%   0.1% 16.2KiB pulldown_cmark pulldown_cmark::parse::Parser::new_with_broken_link_callback
 0.0%   0.1% 16.2KiB        hir_def hir_def::nameres::collector::collect_defs
 0.0%   0.1% 15.8KiB  project_model project_model::workspace::ProjectWorkspace::to_crate_graph
38.3%  95.4% 14.6MiB                And 42372 smaller methods. Use -n N to show more.
</code></pre></div>



<a name="266501241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266501241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266501241">(Dec 31 2021 at 12:34)</a>:</h4>
<p>Yeah, this is strictly about debug symbols. Though 23.8 MB of <code>text</code> is nothing to sneer at.</p>



<a name="266620892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266620892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266620892">(Jan 02 2022 at 16:13)</a>:</h4>
<p>I wonder what that <code>text</code> is.... Would be cool to have <code>cargo llvm-lines flamegraph</code>!</p>



<a name="266621049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266621049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266621049">(Jan 02 2022 at 16:16)</a>:</h4>
<p>Or if <code>cargo bloat</code> could group across monomorphizations</p>



<a name="266621324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266621324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266621324">(Jan 02 2022 at 16:22)</a>:</h4>
<p><a href="https://github.com/dtolnay/cargo-llvm-lines/issues/25">https://github.com/dtolnay/cargo-llvm-lines/issues/25</a></p>



<a name="266621327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266621327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266621327">(Jan 02 2022 at 16:23)</a>:</h4>
<p>I wonder if there's some way to get that with <code>lto=full</code>?</p>



<a name="266621415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266621415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266621415">(Jan 02 2022 at 16:25)</a>:</h4>
<p>And <a href="https://github.com/RazrFalcon/cargo-bloat/issues/19">https://github.com/RazrFalcon/cargo-bloat/issues/19</a></p>



<a name="266621709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266621709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266621709">(Jan 02 2022 at 16:31)</a>:</h4>
<p>Summon <span class="user-mention" data-user-id="133247">@bjorn3</span> :0) </p>
<p>Question: </p>
<p>The way <code>cargo llvm-lines</code> works is by passing <code>--emit=llvm-ir</code> to <code>cargo rustc</code>, which gives llvm output for the leaf crate which is being compiled. I would love to get that rather for all the crates together. </p>
<p>My understanding is that <code>lto=full</code> does do that internally somehow -- with <code>lto=full</code>, <code>rlib</code>s embedded llvm bitcode, and than at the final linking step the linker/compiler combines them all togethre into a single giant CU. Is there some magic flag somewhere which I can pass to the LLVM linker, which would instruct it to emit humongous file with LLVM IR for the whole of the final artifact, rather than compile that down to machine code?</p>



<a name="266624294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266624294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266624294">(Jan 02 2022 at 17:31)</a>:</h4>
<blockquote>
<p>My understanding is that lto=full does do that internally somehow -- with lto=full, rlibs embedded llvm bitcode, and than at the final linking step the linker/compiler combines them all togethre into a single giant CU.</p>
</blockquote>
<p>Correct.</p>
<blockquote>
<p>Is there some magic flag somewhere which I can pass to the LLVM linker, which would instruct it to emit humongous file with LLVM IR for the whole of the final artifact, rather than compile that down to machine code?</p>
</blockquote>
<p>Doesn't <code>--emit=llvm-ir</code> output the post LTO llvm ir when compiling the final executable?</p>



<a name="266624304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266624304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266624304">(Jan 02 2022 at 17:31)</a>:</h4>
<p><span class="user-mention" data-user-id="133169">@matklad</span></p>



<a name="266628308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Code%20size/near/266628308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Code.20size.html#266628308">(Jan 02 2022 at 19:06)</a>:</h4>
<p>Wow, it seems that indeed just works, many thanks! </p>
<div class="codehilite"><pre><span></span><code>$ CARGO_PROFILE_RELEASE_LTO=fat cargo llvm-lines -p rust-analyzer --bin rust-analyzer --release | head -n 100
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>