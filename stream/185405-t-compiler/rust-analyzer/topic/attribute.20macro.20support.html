<html>
<head><meta charset="utf-8"><title>attribute macro support · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html">attribute macro support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253249087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253249087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253249087">(Sep 14 2021 at 13:22)</a>:</h4>
<p>With <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10232">https://github.com/rust-analyzer/rust-analyzer/pull/10232</a> merged, all the tasks in <a href="https://github.com/rust-analyzer/rust-analyzer/issues/9868">https://github.com/rust-analyzer/rust-analyzer/issues/9868</a> are now checked. Adding those ide tests revealed a lot of small problems which are now fixed as well.<br>
Would be good to maybe brainstorm once more for things that still need testing. Pretty much everything macro related in the <code>ide</code> crate has tests now, <code>ide_completion</code> also has a few tests now. <code>ide_assists</code> doesn't really though since all of the <code>ide</code> and <code>ide_assists</code> stuff goes through semantics which is the main entry point for descension and ascension logic it is technically also pretty much tested I believe.</p>



<a name="253249250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253249250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253249250">(Sep 14 2021 at 13:23)</a>:</h4>
<p>wow, amazing work <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="253249876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253249876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253249876">(Sep 14 2021 at 13:27)</a>:</h4>
<p>Might be a good opportunity to re-visit <a href="https://github.com/rust-analyzer/rust-analyzer/issues/9403">https://github.com/rust-analyzer/rust-analyzer/issues/9403</a></p>



<a name="253297039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253297039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253297039">(Sep 14 2021 at 18:13)</a>:</h4>
<p><a href="/user_uploads/4715/hZ42lgF20VXOW5gdAZ6GKPF1/image.png">image.png</a> <br>
I think enabling inlay hints wasn't such a great idea after all <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>
<div class="message_inline_image"><a href="/user_uploads/4715/hZ42lgF20VXOW5gdAZ6GKPF1/image.png" title="image.png"><img src="/user_uploads/4715/hZ42lgF20VXOW5gdAZ6GKPF1/image.png"></a></div>



<a name="253297875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253297875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253297875">(Sep 14 2021 at 18:18)</a>:</h4>
<p>do we ignore where the identifier is located in the input when displaying the hints?</p>



<a name="253298098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253298098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253298098">(Sep 14 2021 at 18:19)</a>:</h4>
<p>Not really, I made a logic mistake. The inlay hint logic is traversing the expansion now, then I'm mapping the generated inlay hints up out of the macro again which then of course lifts up all the inlay hints of generated code from the macro.</p>



<a name="253298212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253298212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253298212">(Sep 14 2021 at 18:20)</a>:</h4>
<p>Should instead descend the expressions we can see in the original body only and try to compute the inlay hints for the descended note.</p>



<a name="253298376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253298376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253298376">(Sep 14 2021 at 18:21)</a>:</h4>
<p>So the inlay hints visible there are all from the expressions generated by salsa in that attribute invocation that arent visible in the input <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="253299631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253299631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253299631">(Sep 14 2021 at 18:28)</a>:</h4>
<p>This might be tricky to do though, since this requires descending a syntax node, but we only really have infra for descending tokens  currently. Is this something we would be able to do with a different token mapping abstraction?<br>
Will revert for now until I give that another look.</p>



<a name="253301874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253301874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253301874">(Sep 14 2021 at 18:43)</a>:</h4>
<p>hm. could we do something like only add the inlay hint if the token it's attached to is actually in the original code?</p>



<a name="253302342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253302342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253302342">(Sep 14 2021 at 18:46)</a>:</h4>
<p>That might work.<br>
Thinking this again, for inlay hints this is a bit odd anyways, because we want to inspect the structure of the nodes in the (non-descended) macro input but we also need to inspect the descended expansion for some things as well, like type fetching. Since some inlay hints, like type hints for example do not trigger if the type is already annotated, but if the attribute expansion annotates it we still wanna show it in the input if there is no annotation there.</p>



<a name="253395541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253395541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kirill Bulatov <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253395541">(Sep 15 2021 at 11:06)</a>:</h4>
<p>If important, I've also noted the same for runnables: once include!d the bindgen output with tests and got a lot of "Run test" lens.</p>



<a name="253396297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253396297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253396297">(Sep 15 2021 at 11:12)</a>:</h4>
<p>That is intentional, just unfortunate when a macro creates <em>a lot</em> of tests like including bindgen output</p>



<a name="253397755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253397755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253397755">(Sep 15 2021 at 11:26)</a>:</h4>
<p>maybe we could have some way of having just one lens that prompts you for the test to run if there are multiple on the same place</p>



<a name="253398376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253398376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253398376">(Sep 15 2021 at 11:32)</a>:</h4>
<p>Oh that sounds like a good idea <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="253400105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/attribute%20macro%20support/near/253400105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/attribute.20macro.20support.html#253400105">(Sep 15 2021 at 11:49)</a>:</h4>
<p>Opened <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10244">https://github.com/rust-analyzer/rust-analyzer/issues/10244</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>