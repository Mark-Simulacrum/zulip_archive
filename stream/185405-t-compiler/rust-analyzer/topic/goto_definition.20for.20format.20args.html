<html>
<head><meta charset="utf-8"><title>goto_definition for format args · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html">goto_definition for format args</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265071415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265071415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> VitalyR <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265071415">(Dec 15 2021 at 20:33)</a>:</h4>
<p>Hi! I found that after this <a href="https://github.com/rust-lang/rust/pull/90473">PR</a>, rust-analyzer can't go to definition or declaration for a format arg, like <a href="/user_uploads/4715/VqjFx_grGXD6y4Ao3uygcpZY/2021-12-15_01-11.png">2021-12-15_01-11.png</a>. </p>
<div class="message_inline_image"><a href="/user_uploads/4715/VqjFx_grGXD6y4Ao3uygcpZY/2021-12-15_01-11.png" title="2021-12-15_01-11.png"><img src="/user_uploads/4715/VqjFx_grGXD6y4Ao3uygcpZY/2021-12-15_01-11.png"></a></div><div class="codehilite"><pre><span></span><code>fn main() {
    let a = String::from(&quot;a&quot;);
    println!(&quot;{a}&quot;);
}
</code></pre></div>
<p>I'm trying to fix this. I'm new to rust-analyzer and it seems that I need some guidance. I figured out that the function <code>ide_db::defs::Definition::from_node()</code> and related things need to be updated. Is this right?</p>



<a name="265072026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265072026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265072026">(Dec 15 2021 at 20:39)</a>:</h4>
<p><code>Definition::from_node</code> won't help you here since the <code>a</code> is inside a string node. what you need to do is parse the string as a format string, figure out what part of the string the cursor is on and then do a look up for the name in the functions locals, that is in a <code>SemanticsScope</code> for the current position</p>



<a name="265072201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265072201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265072201">(Dec 15 2021 at 20:41)</a>:</h4>
<p><code>crates\ide\src\syntax_highlighting\format.rs</code> already has things to figure out what the format string consists of so that is probably a good starting point</p>



<a name="265073241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265073241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> VitalyR <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265073241">(Dec 15 2021 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> Thanks!</p>



<a name="265126683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265126683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265126683">(Dec 16 2021 at 08:55)</a>:</h4>
<p>I wonder if it makes sense to do this on a lower-level, and just write macro expansion for format?</p>



<a name="265126845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265126845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265126845">(Dec 16 2021 at 08:57)</a>:</h4>
<p>Ah, no, that won't work, because we assueme that tokens come out of tokens, not out of string literals. That is, even before we get to a semantic analysis, we just bail out because "of course there can't be a definition in a string literal". Holly karp, how would one even handle this in a proper way</p>



<a name="265128118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265128118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265128118">(Dec 16 2021 at 09:10)</a>:</h4>
<p>Ah, I know remember thinking about this as a theoretical problem for HIR2.0. Now I realise that this is very practical already.</p>



<a name="265141307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265141307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265141307">(Dec 16 2021 at 11:19)</a>:</h4>
<p>This is also related to the "better <code>TokenMap</code>" issue that we never got to</p>



<a name="265141403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265141403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265141403">(Dec 16 2021 at 11:20)</a>:</h4>
<p>I suppose instead of mapping down tokens we'd walk the whole <code>TokenMap</code> and piece together ranges or something</p>



<a name="265141495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/goto_definition%20for%20format%20args/near/265141495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/goto_definition.20for.20format.20args.html#265141495">(Dec 16 2021 at 11:21)</a>:</h4>
<p>Regarding format args capture, that's not even restricted to locals, it works with any name in value namespace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">a</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{a:?}"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>