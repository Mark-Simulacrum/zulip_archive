<html>
<head><meta charset="utf-8"><title>Optimizing source_to_def · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html">Optimizing source_to_def</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249584895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249584895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249584895">(Aug 16 2021 at 12:59)</a>:</h4>
<p>Hey, <span class="user-mention" data-user-id="300586">@Lukas Wirth</span> , <span class="user-mention" data-user-id="211727">@Jonas Schievink  [he/him]</span>, <a href="https://github.com/rust-analyzer/rust-analyzer/issues/9919">https://github.com/rust-analyzer/rust-analyzer/issues/9919</a> sounds like a fun issue. I think I <em>can</em> fix it myself, but I am wondering if it makes sense for me to mentor one of you on this one? That's a relatively more cursed part of the code base, so I'd love someone else to learn more about it</p>



<a name="249585196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249585196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249585196">(Aug 16 2021 at 13:01)</a>:</h4>
<p>That's definitely a part I know very little about(next to nothing honestly). I wouldn't mind trying to learn about it.</p>



<a name="249585718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249585718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249585718">(Aug 16 2021 at 13:06)</a>:</h4>
<p>Feel free to self-assign then!</p>



<a name="249594918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249594918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249594918">(Aug 16 2021 at 14:22)</a>:</h4>
<p>So if I get this right, we want to only populate the DynMap with <code>impl</code>s coming from the same macro file if what we search comes from a macrofile?</p>



<a name="249595327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249595327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249595327">(Aug 16 2021 at 14:25)</a>:</h4>
<p>I also don't see where we even expand macros in <code>source_to_def</code>(or the call-chains from there)</p>



<a name="249595545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249595545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249595545">(Aug 16 2021 at 14:27)</a>:</h4>
<p>I think we probably want to compute a DynMap per HirFileId</p>



<a name="249595629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249595629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249595629">(Aug 16 2021 at 14:28)</a>:</h4>
<p>Probably adding a file_id to <code>fn child_by_source(self, db: &amp;dyn HirDatabase)</code> with the semantics: "child by source from this file"</p>



<a name="249595709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249595709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249595709">(Aug 16 2021 at 14:28)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/785bc57a3dc87527dc97a747298ccf566ff20da4/crates/hir_def/src/child_by_source.rs#L34">https://github.com/rust-analyzer/rust-analyzer/blob/785bc57a3dc87527dc97a747298ccf566ff20da4/crates/hir_def/src/child_by_source.rs#L34</a></p>



<a name="249595918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249595918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249595918">(Aug 16 2021 at 14:30)</a>:</h4>
<p>and this is the place where macro expansion happens -- the <code>.source</code> will expand. I think we want something along these lines there:</p>
<div class="codehilite"><pre><span></span><code>                    let loc = func.lookup(db);
                    if loc.id.file_id() == current_id {
                        let src = loc.source(db);
                        res[keys::FUNCTION].insert(src, func)
                    }
</code></pre></div>



<a name="249597579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249597579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249597579">(Aug 16 2021 at 14:43)</a>:</h4>
<p>So for the cache we currently have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">type</span> <span class="nc">SourceToDefCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FxHashMap</span><span class="o">&lt;</span><span class="n">ChildContainer</span><span class="p">,</span><span class="w"> </span><span class="n">DynMap</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>This should be a double hashmap then if I see this right? Would the order matter here, that is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">type</span> <span class="nc">SourceToDefCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FxHashMap</span><span class="o">&lt;</span><span class="n">ChildContainer</span><span class="p">,</span><span class="w"> </span><span class="n">FxHashMap</span><span class="o">&lt;</span><span class="n">HirFileId</span><span class="p">,</span><span class="w"> </span><span class="n">DynMap</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>vs</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">type</span> <span class="nc">SourceToDefCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FxHashMap</span><span class="o">&lt;</span><span class="n">HirFileId</span><span class="p">,</span><span class="w"> </span><span class="n">FxHashMap</span><span class="o">&lt;</span><span class="n">ChildContainer</span><span class="p">,</span><span class="w"> </span><span class="n">DynMap</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="249598688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249598688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249598688">(Aug 16 2021 at 14:51)</a>:</h4>
<p>I think we want the first one</p>



<a name="249598743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249598743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249598743">(Aug 16 2021 at 14:51)</a>:</h4>
<p>we also can do <code>Map&lt;(ChildContainer, HirFlieId), DynMap&gt;</code></p>



<a name="249598785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249598785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249598785">(Aug 16 2021 at 14:52)</a>:</h4>
<p>(never internalized the tradeoffs between nested hashmaps vs pair-keyed hashmaps)</p>



<a name="249598864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249598864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249598864">(Aug 16 2021 at 14:52)</a>:</h4>
<p>Oh that's also an interesting thought <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="249598915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Optimizing%20source_to_def/near/249598915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Optimizing.20source_to_def.html#249598915">(Aug 16 2021 at 14:52)</a>:</h4>
<p>it also might be that the overal infra doesn't make a lot of sense -- the dynmap stuff is too complicated for the job it does</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>