<html>
<head><meta charset="utf-8"><title>using crate def map for symbol index · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html">using crate def map for symbol index</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262868657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/262868657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#262868657">(Nov 27 2021 at 11:34)</a>:</h4>
<p>i am trying to take a stab at solving this... <a href="https://github.com/rust-analyzer/rust-analyzer/compare/master...jhgg:ide/symbol-index-from-def-map?expand=1">https://github.com/rust-analyzer/rust-analyzer/compare/master...jhgg:ide/symbol-index-from-def-map?expand=1</a></p>
<p>but i'm running into a snag, which is that Semantics does not seem to know about nodes from the expanded macros, so I get panics like:</p>
<div class="codehilite"><pre><span></span><code>Failed to lookup STRUCT@0..24 in this Semantics.
Make sure to use only query nodes, derived from this instance of Semantics.
root node:   MACRO_ITEMS@0..24
known nodes: SOURCE_FILE@0..302

&#39;, crates/hir/src/semantics.rs:977:13
stack backtrace:
   0: rust_begin_unwind
             at /rustc/09c42c45858d5f3aedfa670698275303a3d19afa/library/std/src/panicking.rs:517:5
   1: core::panicking::panic_fmt
             at /rustc/09c42c45858d5f3aedfa670698275303a3d19afa/library/core/src/panicking.rs:101:14
   2: hir::semantics::SemanticsImpl::find_file::{{closure}}
   3: hir::semantics::SemanticsImpl::find_file
   4: hir::semantics::Semantics&lt;DB&gt;::to_def
   5: ide_db::defs::NameClass::classify
   6: ide_db::items_locator::get_name_definition
   7: &lt;core::iter::adapters::chain::Chain&lt;A,B&gt; as core::iter::traits::iterator::Iterator&gt;::fold
   8: &lt;hashbrown::map::HashMap&lt;K,V,S,A&gt; as core::iter::traits::collect::Extend&lt;(K,V)&gt;&gt;::extend
   9: ide_db::helpers::import_assets::path_applicable_imports
  10: ide_db::helpers::import_assets::ImportAssets::search_for
  11: ide_db::helpers::import_assets::ImportAssets::search_for_imports
  12: ide_assists::handlers::auto_import::auto_import
  13: ide_assists::assists
  14: ide::Analysis::assists_with_fixes::{{closure}}
  15: std::panicking::try
  16: ide::Analysis::assists_with_fixes
  17: rust_analyzer::handlers::handle_code_action
  18: std::panicking::try
  19: &lt;F as threadpool::FnBox&gt;::call_box
</code></pre></div>
<p>am i going in the wrong direction, any pointers? <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="262869243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/262869243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#262869243">(Nov 27 2021 at 11:50)</a>:</h4>
<p>i think i got it... <a href="https://github.com/rust-analyzer/rust-analyzer/commit/a69af9daa3e9b3f61ce83d904b0b27022d759869">https://github.com/rust-analyzer/rust-analyzer/commit/a69af9daa3e9b3f61ce83d904b0b27022d759869</a></p>



<a name="262968639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/262968639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#262968639">(Nov 29 2021 at 05:30)</a>:</h4>
<p>assuming my pr isn't absolute garbage, I'm just about done with this, but with one oustanding question: <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10872#issuecomment-980818333">https://github.com/rust-analyzer/rust-analyzer/pull/10872#issuecomment-980818333</a> - when anyone has the time to answer!!</p>



<a name="262998224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/262998224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#262998224">(Nov 29 2021 at 11:57)</a>:</h4>
<blockquote>
<p>it looks like library_symbols is a bit bespoke, insofar as it operates directly on re-parsed source text. is there a specific reason for this? would changing it to use a def map be problematic?</p>
</blockquote>
<p>Wasn't that the point of this rewrite? Making it be dependent on the DefMap instead of source files?</p>
<blockquote>
<p>it looks like library_symbols additionally does not seem to have a way to access RootDatabase? if not, what would be the advisable strategy to parallelize. (i figure i need a RootDatabase to do a snapshot to distribute to worker threads)</p>
</blockquote>
<p>You might be able to add a <code>Send</code> bound to the <code>SymbolsDatabase</code> trait which would allow you to parallelize it potentially. Though I am not sure whether that would be the correct way to go about this.</p>



<a name="263088653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/263088653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#263088653">(Nov 30 2021 at 00:46)</a>:</h4>
<blockquote>
<p>Wasn't that the point of this rewrite? Making it be dependent on the DefMap instead of source files?</p>
</blockquote>
<p>Yeah it was. This code path is a bit awkward because it does not try to use the source syntax nodes from salsa, but instead grabs the source text from salsa and re-parses it. Hence why I was a bit suspect.  (<a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_db/src/symbol_index.rs#L118-L121">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_db/src/symbol_index.rs#L118-L121</a>). My question was mainly as to the <em>why</em> it was done this way. And whether that had any significance when it comes to this code path. </p>
<blockquote>
<p>You might be able to add a Send bound to the SymbolsDatabase trait which would allow you to parallelize it potentially. Though I am not sure whether that would be the correct way to go about this.</p>
</blockquote>
<p>Hmm, yeah that might work. I don't think it's too necessary though, I was able to get it parallel on the crate level. But it is not parallel on the module level (like it is for local_roots). I think this is OK for now. If it's too slow in practice we can always speed it up.</p>
<p>FWIW: I still want to land my parallel indexing branch too, probably this week/weekend, I think it'll help pre-populate the def maps for indexing. The code is pretty messy and I understood much less about r-a when I started, so gonna start from scratch again with all I know.</p>



<a name="263089569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/263089569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#263089569">(Nov 30 2021 at 00:55)</a>:</h4>
<blockquote>
<p>My question was mainly as to the why it was done this way. And whether that had any significance when it comes to this code path.</p>
</blockquote>
<p>Ah I see now, judging from the commit that introduced that it looks like an oversight from refactoring to me.</p>



<a name="263181485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/263181485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#263181485">(Nov 30 2021 at 17:45)</a>:</h4>
<blockquote>
<p>FWIW: I still want to land my parallel indexing branch too, probably this week/weekend, I think it'll help pre-populate the def maps for indexing.</p>
</blockquote>
<p>TBH I'm not so sure those changes are a good idea.</p>



<a name="263193033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/263193033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#263193033">(Nov 30 2021 at 19:07)</a>:</h4>
<p>Oh yeah? Why so? My tests so far have shown like 2-3x indexing speed increase ?</p>



<a name="263193130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/using%20crate%20def%20map%20for%20symbol%20index/near/263193130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/using.20crate.20def.20map.20for.20symbol.20index.html#263193130">(Nov 30 2021 at 19:07)</a>:</h4>
<p>Oh I see your msg in other thread</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>