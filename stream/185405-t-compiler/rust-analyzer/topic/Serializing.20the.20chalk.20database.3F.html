<html>
<head><meta charset="utf-8"><title>Serializing the chalk database? · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html">Serializing the chalk database?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250642098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250642098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Kuhn <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250642098">(Aug 25 2021 at 16:15)</a>:</h4>
<p>I'm pretty sure this is nontrivial, but does anyone have a good intuition about how hard it would be to save out the salsa db to some binary format in order to make starting ra faster? My thought was that you save the db + vfs contents, and then do a diff on startup to detect changes from disk and apply them to the vfs.</p>
<p>Also open to comments like "This is completely misguided because X"</p>



<a name="250642412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250642412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250642412">(Aug 25 2021 at 16:17)</a>:</h4>
<p>I guess you've seen <a href="https://github.com/rust-analyzer/rust-analyzer/issues/4712">https://github.com/rust-analyzer/rust-analyzer/issues/4712</a>?</p>



<a name="250642565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250642565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250642565">(Aug 25 2021 at 16:18)</a>:</h4>
<p>I don't think there's been any work in that direction, so the answer is probably "we're not sure yet"</p>



<a name="250642712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250642712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250642712">(Aug 25 2021 at 16:19)</a>:</h4>
<p>In parcitular, see <a href="https://github.com/rust-analyzer/rust-analyzer/issues/4712#issuecomment-899411567">https://github.com/rust-analyzer/rust-analyzer/issues/4712#issuecomment-899411567</a> -- I think the best way to approach this is by not adding caching to the DB, but allowing the build system to supply ra with some sort of precompiled artifacts.</p>



<a name="250642772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250642772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250642772">(Aug 25 2021 at 16:19)</a>:</h4>
<p>Practically, I'd expect the biggest shoudt term win would be from salsa parallelisation</p>



<a name="250642988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250642988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Kuhn <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250642988">(Aug 25 2021 at 16:21)</a>:</h4>
<p>Doh. I just searched zulip, I should have searched github too.<br>
Ok, but this is exactly the kind of context I was hoping for. Thanks</p>



<a name="250643135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250643135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250643135">(Aug 25 2021 at 16:22)</a>:</h4>
<p>But we can't get out of the build system a lot of the things we want in the IDE</p>



<a name="250643448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250643448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250643448">(Aug 25 2021 at 16:24)</a>:</h4>
<p>I mean, build system can run <code>rust-analyzer</code> with some special flags. I guess, by build system I mean "that which computes some data on a different machine and downloads it locally", I am eyeing the discributed case in particular. We shouldn't make cache local to machine</p>



<a name="250644165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250644165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250644165">(Aug 25 2021 at 16:30)</a>:</h4>
<p>It sounds like a big can of worms. Sure, we could get stuff out of <code>rlib</code>s, but between <code>#[cfg]</code>, non-published code and not being necessarily easy to add stuff to <code>rustc</code>, that's pretty far away.</p>



<a name="250644419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250644419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250644419">(Aug 25 2021 at 16:33)</a>:</h4>
<p>In the meanwhile, if we could dump (store?) the <code>salsa</code> database to disk, that would help with both load times and memory usage on large workspaces, with only some intrusive <code>salsa</code> changes and having to double-check that nothing has changed while we weren't running.</p>



<a name="250644437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250644437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250644437">(Aug 25 2021 at 16:33)</a>:</h4>
<p>We won't be using <code>rustc</code>, we would be using <code>rust-analyzer</code>. Silimarly, we won't be using rlibs, but ra-specific format. But what we will do is allowing to, eg, distribute "prealanized" caches for <a href="http://crates.io">crates.io</a> crates and such.</p>



<a name="250644484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250644484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250644484">(Aug 25 2021 at 16:33)</a>:</h4>
<p>Not to say that it's easy :)</p>



<a name="250644581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Serializing%20the%20chalk%20database%3F/near/250644581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Serializing.20the.20chalk.20database.3F.html#250644581">(Aug 25 2021 at 16:34)</a>:</h4>
<p>If we can upload analysis info to <a href="http://crates.io">crates.io</a> we could also store it locally, so that's a logical first step in that direction</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>