<html>
<head><meta charset="utf-8"><title>multiple cargo configs causes full rebuilds with rust-ana... · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html">multiple cargo configs causes full rebuilds with rust-ana...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271876064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271876064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271876064">(Feb 14 2022 at 19:26)</a>:</h4>
<p>Sounds like we're not picking up one of the config files. Does a <code>cargo clean</code> fix it? I've seen this happen before after toolchain upgrades.</p>



<a name="271876194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271876194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271876194">(Feb 14 2022 at 19:27)</a>:</h4>
<p>I'll try, the full rebuilds take a while for my project though, so i'll let you know in 5 minutes or so <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="271879870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271879870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271879870">(Feb 14 2022 at 19:54)</a>:</h4>
<p>Cargo clean hasn't fixed it :(</p>
<p>I did try copying my cargo config to a fresh project, but I can't seem to reproduce the issue there. If you want I can send you my repo though, since it's public on gitlab.</p>



<a name="271884665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271884665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271884665">(Feb 14 2022 at 20:35)</a>:</h4>
<p>I'll try it tomorrow</p>



<a name="271885948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271885948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271885948">(Feb 14 2022 at 20:47)</a>:</h4>
<p>Here's my project, It's specifically the server subproject that's giving me problems since I have the .cargo/config.toml in there</p>
<p><a href="https://gitlab.com/freddyb/scuddb">https://gitlab.com/freddyb/scuddb</a></p>



<a name="271886072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271886072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271886072">(Feb 14 2022 at 20:48)</a>:</h4>
<p>and my init.vim, i'm using neovim <a href="/user_uploads/4715/ySXeXrJcou__l17b-WOtKMuO/init.vim">init.vim</a></p>



<a name="271886112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271886112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271886112">(Feb 14 2022 at 20:48)</a>:</h4>
<p>rust-analyzer 17afa2e77 2022-01-24 stable</p>



<a name="271886158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271886158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271886158">(Feb 14 2022 at 20:49)</a>:</h4>
<p>rust 1.58.1</p>



<a name="271905981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271905981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271905981">(Feb 14 2022 at 23:45)</a>:</h4>
<p>Just tried it on another laptop, with the latest rust-analyzer, and i managed to reproduce it.</p>



<a name="271906755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271906755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271906755">(Feb 14 2022 at 23:55)</a>:</h4>
<p><a href="/user_uploads/4715/2XSZgvIi9Ip1QaNnI2ZJOVVR/Screencast-from-02-15-2022-124343-AM.webm">Screencast-from-02-15-2022-124343-AM.webm</a> A short recording of what I have to do to trigger the bug. video ends with cargo blocking on build directory, but the proceeding build, after a few minutes, was a full rebuild.</p>



<a name="271911637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271911637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271911637">(Feb 15 2022 at 00:51)</a>:</h4>
<p>Apparently the shared config in ~/.cargo/config.toml isn't even necessary <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="271914883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271914883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271914883">(Feb 15 2022 at 01:33)</a>:</h4>
<p>Ok so I managed to make a reproducer: <a href="https://github.com/Frederik-Baetens/RA_rebuild">https://github.com/Frederik-Baetens/RA_rebuild</a></p>
<p>I think the fact that it's in a workspace is irrelevant (just something I tried to try &amp; reproduce, but that didn't end up triggering it)</p>
<p>What ended up triggering it, is adding <code>console-subscriber = "~0.1.2"</code> to my dependencies.</p>



<a name="271918246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/271918246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#271918246">(Feb 15 2022 at 02:21)</a>:</h4>
<p>I don't even need to use that dependency, just having it in my cargo.toml seems to be enough. It's not a surprise that it's that specific dependency causing problems though, because the rustflags in the .cargo/config.toml are for that specific dependency.</p>



<a name="272004151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272004151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272004151">(Feb 15 2022 at 17:00)</a>:</h4>
<p><a href="/user_uploads/4715/2pxhJS1ILwZtXvNiMJSlBZCT/2022-02-15-18-57-18_na.mp4">2022-02-15-18-57-18_na.mp4</a></p>



<a name="272004250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272004250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272004250">(Feb 15 2022 at 17:01)</a>:</h4>
<p>I don't seem to be able to reproduce this in VS Code</p>



<a name="272005176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272005176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272005176">(Feb 15 2022 at 17:06)</a>:</h4>
<p>Yes, i'm using nvim, are you open to attempting this with the init.vim I posted above?</p>



<a name="272005351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272005351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272005351">(Feb 15 2022 at 17:07)</a>:</h4>
<p>And I'm not sure that vs code invokes rust-analyzer in exactly the same way as my init.vim does.</p>
<p>If you're not familliar, the init.vim goes in ~/.config/nvim/init.vim</p>



<a name="272005499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272005499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272005499">(Feb 15 2022 at 17:08)</a>:</h4>
<p>You need to run :PlugInstall first in nvim to set everything up</p>



<a name="272008458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272008458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272008458">(Feb 15 2022 at 17:26)</a>:</h4>
<p>are you running your <code>cargo build</code> from a different terminal, or from inside vim?</p>



<a name="272008606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272008606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272008606">(Feb 15 2022 at 17:27)</a>:</h4>
<p>ah, there's a video</p>



<a name="272008757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272008757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272008757">(Feb 15 2022 at 17:28)</a>:</h4>
<p>maybe it'd be interesting to try running it from inside vim, to see whether there's a difference in environments there</p>



<a name="272046763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272046763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272046763">(Feb 15 2022 at 22:21)</a>:</h4>
<p><span class="user-mention" data-user-id="129457">@Florian Diebold</span>  This also happens when invoking cargo build from inside vim with :!cargo build.</p>
<p>I understand that this being unreproducable in vs-code makes it seem like this is my problem, but I copied the <a href="https://sharksforarms.dev/posts/neovim-rust/">https://sharksforarms.dev/posts/neovim-rust/</a> config, which was mentioned on <a href="https://rust-analyzer.github.io/manual.html#vimneovim">https://rust-analyzer.github.io/manual.html#vimneovim</a>, so I hope that my setup isn't all that weird. Does VSCode also run cargo clippy for every file save? Maybe that makes a difference?</p>
<p>Come to think of it, I should try if i can reproduce this without using RA, by just invoking cargo clippy <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="272046975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272046975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272046975">(Feb 15 2022 at 22:23)</a>:</h4>
<p>Just tried it, manually invoking cargo clippy doesn't cause a rebuild afterwards.</p>



<a name="272047277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272047277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272047277">(Feb 15 2022 at 22:26)</a>:</h4>
<p>Alternatively, is there a more "supported" way of using RA with neovim? (not to imply that a fantastic volunteer project such as this should provide support, but just a config that's assumed to work better)</p>



<a name="272047698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272047698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272047698">(Feb 15 2022 at 22:30)</a>:</h4>
<p>what does running <code>cargo build -v</code> say (when it does the rebuild)?</p>



<a name="272052287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272052287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272052287">(Feb 15 2022 at 23:20)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I ran :PlugUpdate and that seems to have fixed my problem? I don't know if that was actually the fix, but I can't seem to reproduce it for now.</p>
<p>I also briefly swapped to another vim config, closed all my vim instances, swapped back to my rust-analyzer vim config and now everything works <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="272052306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272052306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272052306">(Feb 15 2022 at 23:20)</a>:</h4>
<p>Sorry for bothering you, will update if I manage to encounter this problem again.</p>



<a name="272059940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272059940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272059940">(Feb 16 2022 at 00:44)</a>:</h4>
<p>Never mind, forgot to include the .cargo/config.toml in the reproducer repository apparently? Apologies.</p>
<p><span class="user-mention" data-user-id="203546">@Laurențiu</span> could you try again, I pushed the config to the repo. perhaps it's reproducible now in VS code as well?</p>



<a name="272060255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272060255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272060255">(Feb 16 2022 at 00:48)</a>:</h4>
<p><span class="user-mention" data-user-id="129457">@Florian Diebold</span> Here's the output of build -v when the rebuild issue occurs: <a href="https://pastebin.com/CKepFS21">https://pastebin.com/CKepFS21</a></p>



<a name="272061421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272061421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272061421">(Feb 16 2022 at 01:04)</a>:</h4>
<p>Just installed vscode myself with rust-analyzer, and I managed to reproduce this problem with the full rebuilds there as well.</p>



<a name="272064812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272064812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272064812">(Feb 16 2022 at 01:59)</a>:</h4>
<p>I managed to reproduce it again. apparently I had forgotten to include the .cargo config in the repo, apologies.</p>
<p>So I tried reproducing it in rust-analyzer, and I can't get it to reproduce there, but I can trigger it by running rust-analyzer in vscode, and then running cargo build manually in my terminal</p>



<a name="272065000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272065000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272065000">(Feb 16 2022 at 02:01)</a>:</h4>
<p><span class="user-mention" data-user-id="129457">@Florian Diebold</span> here's the build -v output from when the rebuild happens <a href="https://pastebin.com/CKepFS21">https://pastebin.com/CKepFS21</a></p>



<a name="272065058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272065058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272065058">(Feb 16 2022 at 02:02)</a>:</h4>
<p>Running a manual cargo build, also seems to trigger a full rebuild when running in vscode again.</p>



<a name="272065207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272065207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272065207">(Feb 16 2022 at 02:05)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> this makes me suspect that RA and cargo build are running with different working directories which may not include the .cargo config even though i'm launching nvim and cargo build from the same directory. Is that possible?</p>



<a name="272066037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272066037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272066037">(Feb 16 2022 at 02:19)</a>:</h4>
<p>I think that's it. Moving my .cargo config to the top of the workspace makes this no longer occur. I think rust-analyzer commands are launched from the top level of the workspace, where the cargo config didn't get included.</p>



<a name="272066113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272066113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272066113">(Feb 16 2022 at 02:20)</a>:</h4>
<p>This issue doesn't occur in VSCode itself, because it also runs its build commands in the top level of the workspace, thereby also avoiding the .cargo config lower down in the workspace.</p>



<a name="272066346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272066346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frederik Baetens <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272066346">(Feb 16 2022 at 02:24)</a>:</h4>
<p>Is the working directory where rust-analyzer gets run something rust-analyzer has control over? Could rust analyzer run starting from the location of the file being edited instead of the top of the workspace?</p>



<a name="272079205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272079205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272079205">(Feb 16 2022 at 06:52)</a>:</h4>
<p>I think we mostly avoid changing the current directory. But doesn't <code>cargo build -p path/to/manifest</code> pick up the config file?</p>



<a name="272079223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272079223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272079223">(Feb 16 2022 at 06:53)</a>:</h4>
<p>I think I also noticed some CWD-related weirdness in other editors</p>



<a name="272079347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272079347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272079347">(Feb 16 2022 at 06:55)</a>:</h4>
<blockquote>
<p>apparently I had forgotten to include the .cargo config in the repo</p>
</blockquote>
<p>I could have sworn I saw the <code>config.toml</code> there, but it was under <code>subproj/src/.cargo</code>. <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> But I still can't reproduce it.</p>



<a name="272079521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272079521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272079521">(Feb 16 2022 at 06:58)</a>:</h4>
<p>Ooh, you're running <code>cargo build</code> in <code>subproj</code>.</p>



<a name="272079648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272079648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272079648">(Feb 16 2022 at 07:00)</a>:</h4>
<p>I think <code>subproj/cargo.toml</code> only applies when you run <code>cargo build</code> in <code>subproj</code>, and it's not picked up by <code>cargo build</code> from the workspace root.</p>



<a name="272079711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272079711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272079711">(Feb 16 2022 at 07:01)</a>:</h4>
<p>Try this:</p>
<div class="codehilite"><pre><span></span><code>cargo build
cd subproj
cargo build
cd ..
cargo build
</code></pre></div>



<a name="272080542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272080542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272080542">(Feb 16 2022 at 07:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="398861">Frederik Baetens</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E/near/272066037">said</a>:</p>
<blockquote>
<p>I think that's it. Moving my .cargo config to the top of the workspace makes this no longer occur.</p>
</blockquote>
<p>Oh, you've already figured it out.</p>



<a name="272083350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/multiple%20cargo%20configs%20causes%20full%20rebuilds%20with%20rust-ana.../near/272083350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E.html#272083350">(Feb 16 2022 at 07:58)</a>:</h4>
<p>The problem is that we simply run <code>cargo check</code> to get the workspace diagnostics. Otherwise we'd need to run <code>cargo check</code> on each project in the workspace.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>