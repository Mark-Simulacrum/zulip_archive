<html>
<head><meta charset="utf-8"><title>Infinitely recursing  duplicating empty expansions · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html">Infinitely recursing  duplicating empty expansions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258392649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258392649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258392649">(Oct 20 2021 at 15:53)</a>:</h4>
<p>So in <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10544">https://github.com/rust-analyzer/rust-analyzer/issues/10544</a> we get a hang due to specific macro invocations(caused by parser recovery),<br>
ignoring the parser part, for the following macro</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>rust analyzer will hang and just eat more and more memory, this obviously creates a <a href="https://www.wolframalpha.com/input/?i=sum+2%5Ei%2C+i%3D1+to+128"><strong><em>lot</em></strong></a>(if my math isn't wrong) of expansions with a depth limit of 128(this is basically a fork bomb is it not?).</p>
<p>And since these macros don't emit more tokens than whats in the expander we also never hit the <code>TOKEN_LIMIT</code></p>



<a name="258392819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258392819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258392819">(Oct 20 2021 at 15:54)</a>:</h4>
<p>rustc hits a recursion limit here but we don't which I assume is due to us doing things differently here</p>



<a name="258393600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258393600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258393600">(Oct 20 2021 at 15:58)</a>:</h4>
<p>Interestingly the hang can be observed when putting that snippet into a test, but for</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>a test expands this once and then finishes while putting that snippet into RA also hangs for me</p>



<a name="258395435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258395435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258395435">(Oct 20 2021 at 16:09)</a>:</h4>
<p>This should hit macro depth limit</p>



<a name="258395613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258395613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258395613">(Oct 20 2021 at 16:10)</a>:</h4>
<p>I think what might be happening here is that we have two infras for macro expansion. One "normal expanision" during lowering, and one "let me guess it " expansion for IDE features. And we had a bug once where the second kind of expanion didn't enforce recursion limit</p>



<a name="258396045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258396045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258396045">(Oct 20 2021 at 16:12)</a>:</h4>
<p><code>const EXPANSION_RECURSION_LIMIT: Limit = Limit::new(32);</code> is what I am talking about.</p>



<a name="258396573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258396573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258396573">(Oct 20 2021 at 16:15)</a>:</h4>
<p>For the item case it hits the <code>EXPANSION_DEPTH_LIMIT</code> but in that case we only stop expanding the macros that are at that depth if I see this right, so we still try to expand them all(at least thats what logging me the depth tells). And for the expression case ye I guess some ide layer thing is doing something wonky there since the test doesn't even try to expand it past the first level.</p>



<a name="258396785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258396785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258396785">(Oct 20 2021 at 16:16)</a>:</h4>
<p>So there are multiple problems at work here I imagine</p>



<a name="258396865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258396865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258396865">(Oct 20 2021 at 16:17)</a>:</h4>
<p><del>(Oh dear I assume <code>descend_into_macros</code> is the IDE level problem)</del></p>



<a name="258396956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258396956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258396956">(Oct 20 2021 at 16:17)</a>:</h4>
<p>Ahh.... So we need to check the limit for <em>both</em> <code>error!()</code> calls? On every level? Oh dear</p>



<a name="258397198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258397198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258397198">(Oct 20 2021 at 16:19)</a>:</h4>
<p>Ye the depth logs for item collection are basically</p>
<div class="codehilite"><pre><span></span><code>[crates\hir_def\src\nameres\collector.rs:1207] depth = 1
[crates\hir_def\src\nameres\collector.rs:1207] depth = 2
[crates\hir_def\src\nameres\collector.rs:1207] depth = 3
[crates\hir_def\src\nameres\collector.rs:1207] depth = 4
...
[crates\hir_def\src\nameres\collector.rs:1207] depth = 125
[crates\hir_def\src\nameres\collector.rs:1207] depth = 126
[crates\hir_def\src\nameres\collector.rs:1207] depth = 127
[crates\hir_def\src\nameres\collector.rs:1207] depth = 128
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 128
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 127
[crates\hir_def\src\nameres\collector.rs:1207] depth = 128
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 128
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 126
[crates\hir_def\src\nameres\collector.rs:1207] depth = 127
[crates\hir_def\src\nameres\collector.rs:1207] depth = 128
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 129
[crates\hir_def\src\nameres\collector.rs:1207] depth = 128
...
</code></pre></div>



<a name="258397358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258397358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258397358">(Oct 20 2021 at 16:20)</a>:</h4>
<p>Because we only stop looking at that depth, then we go back up one and look at the second branch. Back out there again go up one even further and repeat visiting all branches until depth 128</p>



<a name="258398445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258398445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258398445">(Oct 20 2021 at 16:26)</a>:</h4>
<p>feels pretty bad. Like we have to add some kind of <em>global</em> limit here, which is hard to square with inremental expansion of a single macro</p>



<a name="258491259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258491259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258491259">(Oct 21 2021 at 05:46)</a>:</h4>
<p>You could decrease the limit in the DefCollector for <em>every</em> macro you expand, not just while descending into one</p>



<a name="258508773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258508773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258508773">(Oct 21 2021 at 08:45)</a>:</h4>
<p>We could, but then the limit becomes a part of MacroCallLoc -- you need to be able to get the limit in the <code>expand_macro(MacroCallId)</code> query. And the limit is volatile (unlike depth)</p>



<a name="258510907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258510907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258510907">(Oct 21 2021 at 09:02)</a>:</h4>
<p>Hmm, I think I broke the test case here. <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10585#issuecomment-946678952">Last time I tried</a>, I needed an <code>#[error]</code> on the struct for it to trigger. Are we looking at MBE macros there?</p>



<a name="258514111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258514111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258514111">(Oct 21 2021 at 09:30)</a>:</h4>
<p>This is solely about MBE macros yes</p>



<a name="258514202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258514202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258514202">(Oct 21 2021 at 09:30)</a>:</h4>
<p>I wasn't able to reproduce this with an attribute like in your snippet</p>



<a name="258514226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258514226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258514226">(Oct 21 2021 at 09:30)</a>:</h4>
<p>Uh-oh..</p>



<a name="258514398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258514398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258514398">(Oct 21 2021 at 09:32)</a>:</h4>
<p>My theory was that we're doing something with the <code>error</code> MBE when we see <code>#[error]</code>. And in the original test case there was a <code>#[thiserror]</code> on the type, so I don't think we should have been doing anything with the attribute</p>



<a name="258514535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258514535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258514535">(Oct 21 2021 at 09:33)</a>:</h4>
<p>Just checked again, it hangs iff I have the attribute on the struct.</p>



<a name="258514770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258514770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258514770">(Oct 21 2021 at 09:35)</a>:</h4>
<p>Yeah, the logs look the same, we hang around depth 128. Can I print a human-readable <code>MacroCallLoc</code>?</p>



<a name="258515405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258515405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258515405">(Oct 21 2021 at 09:40)</a>:</h4>
<p>Oh, now I get the behaviour for the attribute as well</p>



<a name="258515736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258515736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258515736">(Oct 21 2021 at 09:42)</a>:</h4>
<div class="codehilite"><pre><span></span><code>[DEBUG hir_def::nameres::collector] non-builtin attribute error
[DEBUG hir_def::nameres::path_resolution] resolving Name(Text(&quot;error&quot;)) in module
[crates/hir_def/src/nameres/collector.rs:1207] depth = 1
[WARN hir_expand::db] fail on macro_parse: (reason: BindingError(&quot;leftover tokens&quot;) macro_call: #[error]
struct LoadSourcesError;) parents:
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[crates/hir_def/src/nameres/collector.rs:1207] depth = 2
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 3
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 4
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 5
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 6
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 7
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 8
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
[crates/hir_def/src/nameres/collector.rs:1207] depth = 9
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[DEBUG hir_expand::db] parse = MACRO_ITEMS
</code></pre></div>



<a name="258515866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258515866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258515866">(Oct 21 2021 at 09:43)</a>:</h4>
<p>Ye so thats basically the same problem, just that we we use an attribute invocation with an mbe macro</p>



<a name="258515968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258515968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258515968">(Oct 21 2021 at 09:44)</a>:</h4>
<p>vs.</p>
<div class="codehilite"><pre><span></span><code>[DEBUG hir_def::nameres::collector] non-builtin attribute error2
[DEBUG hir_def::nameres::path_resolution] resolving Name(Text(&quot;error2&quot;)) in module
</code></pre></div>



<a name="258516003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258516003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258516003">(Oct 21 2021 at 09:44)</a>:</h4>
<p>Yeah, but why do we try to expand the macro?</p>



<a name="258516146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258516146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258516146">(Oct 21 2021 at 09:45)</a>:</h4>
<p>Because attributes can be specified as macro 2.0 macros at least with the <code>rustc_builtin_macro</code> attribute, and I assume this was the case for mbe macros before as well? I imagine we just don't check for the attribute maybe</p>



<a name="258516565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258516565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258516565">(Oct 21 2021 at 09:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions/near/258516146">said</a>:</p>
<blockquote>
<p>Because attributes can be specified as macro 2.0 macros at least with the <code>rustc_builtin_macro</code> attribute, and I assume this was the case for mbe macros before as well? I imagine we just don't check for the attribute maybe</p>
</blockquote>
<p>Huh, TIL.</p>



<a name="258516589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258516589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258516589">(Oct 21 2021 at 09:49)</a>:</h4>
<p>I think so at least? or was this only for derives</p>



<a name="258516616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258516616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258516616">(Oct 21 2021 at 09:49)</a>:</h4>
<p>I'm not sure anymroe actually but maybe we are also just forgetting to do this check in general then</p>



<a name="258516904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258516904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258516904">(Oct 21 2021 at 09:52)</a>:</h4>
<p>Ye that's only the case for derives, so we are just missing a check for the macro kind when resolving for attributes I guess</p>



<a name="258517060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517060">(Oct 21 2021 at 09:53)</a>:</h4>
<p>I'm also looking at the original case (with <code>#[derive(Error)] #[error] struct ...</code>). I didn't expect it, but ever <code>cargo expand</code>  shows:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[error(</span><span class="s">"xxx"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">LoadSourcesError</span><span class="p">;</span><span class="w"></span>
<span class="cp">#[automatically_derived]</span><span class="w"></span>
<span class="cp">#[allow(unused_qualifications)]</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">LoadSourcesError</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; ::<span class="n">core</span>::<span class="n">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="o">*</span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadSourcesError</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Formatter</span>::<span class="n">write_str</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">"LoadSourcesError"</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[allow(unused_qualifications)]</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">LoadSourcesError</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="c1">// ...</span>
</code></pre></div>



<a name="258517117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517117">(Oct 21 2021 at 09:53)</a>:</h4>
<p>For some reason, it doesn't strip the <code>#[error]</code> attribute. Of course, if I try to compile that, <code>rustc</code> complains.</p>



<a name="258517233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517233">(Oct 21 2021 at 09:54)</a>:</h4>
<p>That's because <code>error</code> is a registered derive helper there right? Those don't get stripped on expansion</p>



<a name="258517290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517290">(Oct 21 2021 at 09:54)</a>:</h4>
<p>They don't? The proc macro needs to see them, but shouldn't they be stripped from the original item?</p>



<a name="258517383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517383">(Oct 21 2021 at 09:55)</a>:</h4>
<p>They don't because multiple derives can see the same helpers, or rather all macros can see the helper attributes <a href="https://doc.rust-lang.org/reference/procedural-macros.html#derive-macro-helper-attributes">https://doc.rust-lang.org/reference/procedural-macros.html#derive-macro-helper-attributes</a></p>



<a name="258517498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517498">(Oct 21 2021 at 09:56)</a>:</h4>
<p>and since a derive doesn't modify the original item they stay due to derive helpers being so called <code>inert</code> attributes</p>



<a name="258517631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517631">(Oct 21 2021 at 09:57)</a>:</h4>
<p><span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span> macros are hard</p>



<a name="258517668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258517668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258517668">(Oct 21 2021 at 09:57)</a>:</h4>
<p>Yes they are <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="258518066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518066">(Oct 21 2021 at 10:00)</a>:</h4>
<p>Oh, and originally it failed because we can't expand <code>error</code> when it's an attribute? I mean here:</p>



<a name="258518082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518082">(Oct 21 2021 at 10:01)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">thiserror</span>::<span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$error</span>:<span class="nc">ident</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Debug, Error)]</span><span class="w"></span>
<span class="cp">#[error(</span><span class="s">"xxx"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">LoadSourcesError</span><span class="p">;</span><span class="w"></span>

<span class="n">error</span><span class="o">!</span><span class="p">(</span><span class="n">Foo</span><span class="p">);</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="258518133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518133">(Oct 21 2021 at 10:01)</a>:</h4>
<div class="codehilite"><pre><span></span><code>#[derive(Debug, Error)]
#[error(&quot;xxx&quot;)]
struct LoadSourcesError;
[DEBUG hir_expand::db] expanded =  struct$error{}impl$error{}
[DEBUG hir_expand::db] kind = Items
[WARN hir_expand::db] fail on macro_parse: (reason: BindingError(&quot;expected ident&quot;) macro_call: error{}) parents: error{}
</code></pre></div>



<a name="258518367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518367">(Oct 21 2021 at 10:03)</a>:</h4>
<p>I imagine that caused the problem because we invoked the <code>error</code> macro through the attribute with an invalid input(either the item or the string literal) causing us not to bind $error fragment, giving us the raw expansion with <code>$error</code> in there. Which then kicked off the recursion since the parsers fallback creates two new macro invocations there</p>



<a name="258518442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518442">(Oct 21 2021 at 10:04)</a>:</h4>
<p>Yeah, sounds reasonable.</p>



<a name="258518454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518454">(Oct 21 2021 at 10:04)</a>:</h4>
<p>And because of the <code>error</code> mbe macro definition we probably didn't resolve the derive helper as a derive helper</p>



<a name="258518558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518558">(Oct 21 2021 at 10:05)</a>:</h4>
<p>There's also this case:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$error</span>:<span class="nc">ident</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//error!(Foo);</span>
<span class="n">error</span><span class="o">!</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>Here <code>rustc</code> complains that the invocation is incorrect, but we hang.</p>



<a name="258518607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518607">(Oct 21 2021 at 10:05)</a>:</h4>
<p>Ah, that's our error recovery? Instead of rejecting it from the start, we still try to expand it?</p>



<a name="258518640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518640">(Oct 21 2021 at 10:05)</a>:</h4>
<p>So we still expand macros even if we don't match any arms?</p>



<a name="258518725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518725">(Oct 21 2021 at 10:06)</a>:</h4>
<p>How do we know which arm to pick if we don't match any? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="258518765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518765">(Oct 21 2021 at 10:06)</a>:</h4>
<p>Even hangs with <code>error!("xxx")</code>.</p>



<a name="258518795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518795">(Oct 21 2021 at 10:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions/near/258518725">said</a>:</p>
<blockquote>
<p>How do we know which arm to pick if we don't match any? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>Well, none of them?</p>



<a name="258518875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518875">(Oct 21 2021 at 10:07)</a>:</h4>
<p>Well we have to pick an arm to get this expansion, if we didn't we wouldn't be expanding the macrocall no?</p>



<a name="258518972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258518972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258518972">(Oct 21 2021 at 10:08)</a>:</h4>
<p>How can we expand it if there's no match? <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="258519010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519010">(Oct 21 2021 at 10:08)</a>:</h4>
<p>Macros are cursed.</p>



<a name="258519024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519024">(Oct 21 2021 at 10:09)</a>:</h4>
<p>I don't know but we are hanging as you said so that means we are expanding that one arm for some reason <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="258519043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519043">(Oct 21 2021 at 10:09)</a>:</h4>
<p>So there are two issues here:</p>
<ul>
<li>we try to expand a declarative macro when there's no matching arm</li>
<li>we try to expand attributes as declarative macros</li>
<li>bonus: we somehow hang in recursive macros</li>
</ul>



<a name="258519200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519200">(Oct 21 2021 at 10:10)</a>:</h4>
<ul>
<li>we are vulnerable to this macro expansion </li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">error</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="258519202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519202">(Oct 21 2021 at 10:10)</a>:</h4>
<p>I think we try to expand the best-matching arm</p>



<a name="258519220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519220">(Oct 21 2021 at 10:10)</a>:</h4>
<p>even if it doesn't match without errors</p>



<a name="258519403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519403">(Oct 21 2021 at 10:12)</a>:</h4>
<p>But this one isn't recursive, is it? And we still hang.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$error</span>:<span class="nc">ident</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258519446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519446">(Oct 21 2021 at 10:12)</a>:</h4>
<p>It is is recursive</p>



<a name="258519454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519454">(Oct 21 2021 at 10:12)</a>:</h4>
<p>because of parser recovery</p>



<a name="258519487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519487">(Oct 21 2021 at 10:13)</a>:</h4>
<p>the <code>$</code> causes the parser to recover, then we parse the <code>error {}</code> as a macro invocation</p>



<a name="258519558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519558">(Oct 21 2021 at 10:13)</a>:</h4>
<p>Shouldn't we parse it as <code>$error</code> instead of thinking it's a call even without the <code>!</code>?</p>



<a name="258519650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519650">(Oct 21 2021 at 10:14)</a>:</h4>
<p>there is nothing in rust outside of macros that parses with the $ token</p>



<a name="258519696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519696">(Oct 21 2021 at 10:14)</a>:</h4>
<p>and at the sourcefile/module level we parse an identifier/path as a macro call</p>



<a name="258519715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519715">(Oct 21 2021 at 10:14)</a>:</h4>
<p>as all items start with a keyword</p>



<a name="258519724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519724">(Oct 21 2021 at 10:15)</a>:</h4>
<p>Yeah.. so how does <code>$x</code> work, for some placeholder <code>x</code>?</p>



<a name="258519776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519776">(Oct 21 2021 at 10:15)</a>:</h4>
<p><code>$x</code> currently gets pasted into the expansion if we didn't bind it to any input(which happens here as florian said by taking the best matching arm)</p>



<a name="258519799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519799">(Oct 21 2021 at 10:15)</a>:</h4>
<p>so calling that macro gives us the literal</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">struct</span> <span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="cp">$error</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>expansion</p>



<a name="258519897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519897">(Oct 21 2021 at 10:16)</a>:</h4>
<p>No, assuming<code>$x</code> is a valid input</p>



<a name="258519901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519901">(Oct 21 2021 at 10:16)</a>:</h4>
<div class="codehilite"><pre><span></span><code>SOURCE_FILE@0..31
  STRUCT@0..8
    STRUCT_KW@0..6 &quot;struct&quot;
    WHITESPACE@6..7 &quot; &quot;
    ERROR@7..8
      DOLLAR@7..8 &quot;$&quot;
  MACRO_CALL@8..16
    PATH@8..13
      PATH_SEGMENT@8..13
        NAME_REF@8..13
          IDENT@8..13 &quot;error&quot;
    WHITESPACE@13..14 &quot; &quot;
    TOKEN_TREE@14..16
      L_CURLY@14..15 &quot;{&quot;
      R_CURLY@15..16 &quot;}&quot;
  WHITESPACE@16..17 &quot;\n&quot;
  IMPL@17..23
    IMPL_KW@17..21 &quot;impl&quot;
    WHITESPACE@21..22 &quot; &quot;
    ERROR@22..23
      DOLLAR@22..23 &quot;$&quot;
  MACRO_CALL@23..31
    PATH@23..28
      PATH_SEGMENT@23..28
        NAME_REF@23..28
          IDENT@23..28 &quot;error&quot;
    WHITESPACE@28..29 &quot; &quot;
    TOKEN_TREE@29..31
      L_CURLY@29..30 &quot;{&quot;
      R_CURLY@30..31 &quot;}&quot;
</code></pre></div>



<a name="258519908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519908">(Oct 21 2021 at 10:16)</a>:</h4>
<p>corresponding rast</p>



<a name="258519948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519948">(Oct 21 2021 at 10:17)</a>:</h4>
<p>assuming its valid we replace it with the matched input token</p>



<a name="258519958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519958">(Oct 21 2021 at 10:17)</a>:</h4>
<p>We see <code>$x</code>, first try to expand an <code>x</code> macro, don't find it, give up and emit <code>$x</code>, then go over this and replace <code>$x</code> with the macro input?</p>



<a name="258519960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258519960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258519960">(Oct 21 2021 at 10:17)</a>:</h4>
<p>(deleted)</p>



<a name="258520254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258520254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258520254">(Oct 21 2021 at 10:19)</a>:</h4>
<p>No, we first replace all fragments with their matched inputs, if any fragment doesn't have a matched input we keep it as <code>$fragment_name</code> in the tree. Then we do name resolution on this new tree.<br>
So if <code>$x</code> has an input we replace it with it and all is well, if it doesn't we keep it as the <code>$x</code> tokens in the tree, which could cause parser recovery causing it to be parsed as a macro invocation depending on the surrounding syntax which then could be resolved in in name res</p>



<a name="258520738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258520738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258520738">(Oct 21 2021 at 10:23)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/pull/10603">https://github.com/rust-analyzer/rust-analyzer/pull/10603</a> fixes the attribute problem</p>



<a name="258520918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258520918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258520918">(Oct 21 2021 at 10:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="129457">Florian Diebold</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions/near/258519202">said</a>:</p>
<blockquote>
<p>I think we try to expand the best-matching arm</p>
</blockquote>
<p>Doing this makes sense I suppose but I wonder if we should try to replace unmatched fragments with defaults so that we don't literally paste <code>$fragment</code> into the expansion.</p>



<a name="258521929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Infinitely%20recursing%20%20duplicating%20empty%20expansions/near/258521929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Infinitely.20recursing.20.20duplicating.20empty.20expansions.html#258521929">(Oct 21 2021 at 10:35)</a>:</h4>
<p>And maybe we shouldn't try to expand macros which are missing <code>!</code>?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>