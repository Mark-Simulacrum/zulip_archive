<html>
<head><meta charset="utf-8"><title>replace_match_with_if_let behaviour · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let.20behaviour.html">replace_match_with_if_let behaviour</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273257413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let%20behaviour/near/273257413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ole Strohm <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let.20behaviour.html#273257413">(Feb 25 2022 at 17:19)</a>:</h4>
<p>I'm working on <a href="https://github.com/rust-analyzer/rust-analyzer/issues/11547">https://github.com/rust-analyzer/rust-analyzer/issues/11547</a><br>
And I think I've realized that the line mentioned by Veykril should probably be removed all together.<br>
The line in question is (with pat renamed to pat2)<br>
<code>(_pat, pat2) =&gt; if is_empty_expr(&amp;expr) =&gt; (pat2, expr2, expr)</code></p>
<p>Which matches</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pat</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">expr</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">pat2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">expr2</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>To save you having to read the code, this code basically says that if the first match arm is an empty expression (like <code>{}</code>), then the resulting if let should be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">pat2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">expr2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>However this is only true if pat and pat2 are mutually exclusive. In the issue linked above pat = <code>'{'</code> and pat2 = <code>_</code>, and so they're not mutually exclusive, which is why the resulting code is wrong.<br>
So I'm wondering if I should just remove this branch altogether, or find a way to check if the two patterns are mutually exclusive, which seems difficult, or slow. An even more difficult method would be to somehow generate the pattern that would be mutually exclusive. That would let it handle cases like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>by generating a None(_) pattern for the if let. but this wouldn't be easy in cases like matching numbers, so I'm not sure it's worth it.</p>
<p>What are your thoughts?</p>



<a name="273258338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let%20behaviour/near/273258338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let.20behaviour.html#273258338">(Feb 25 2022 at 17:26)</a>:</h4>
<p>Right , that branch is correct actually(made a mistake when looking at it earlier it seems). So the problem here is actually as you've said the pattern in that if the pattern with the empty arm is more specific than the arm with the actual body we can't create an if let out of that.<br>
In this case we should just make the assist not be applicable here.(We could do some special stuff for option as you've said but that is just extra functionality that can be added on top)</p>



<a name="273258448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let%20behaviour/near/273258448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let.20behaviour.html#273258448">(Feb 25 2022 at 17:26)</a>:</h4>
<p>Is removing the second arm enough to have it keep on working for all the other tests? Then I'd say ye just remove it.</p>



<a name="273258484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let%20behaviour/near/273258484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let.20behaviour.html#273258484">(Feb 25 2022 at 17:27)</a>:</h4>
<p>Otherwise we probably want to look into addressing this specific problem by adding some extra checks</p>



<a name="273261616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let%20behaviour/near/273261616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/replace_match_with_if_let.20behaviour.html#273261616">(Feb 25 2022 at 17:51)</a>:</h4>
<p>I <em>think</em> the match checking algorithm can actually decide whether two patterns overlap, though I haven't thought about it in detail. it would also probably require a low-level API for the match check though</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>