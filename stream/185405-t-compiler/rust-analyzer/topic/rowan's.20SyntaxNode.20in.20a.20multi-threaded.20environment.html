<html>
<head><meta charset="utf-8"><title>rowan&#x27;s SyntaxNode in a multi-threaded environment · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html">rowan&#x27;s SyntaxNode in a multi-threaded environment</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268005009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268005009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Irina Shestak (they/she) <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268005009">(Jan 14 2022 at 12:05)</a>:</h4>
<p>hello! My library is using rowan and returns an AST which is a rowan SyntaxNode,  like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SyntaxTree</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">ast</span>: <span class="nc">rowan</span>::<span class="n">SyntaxNode</span><span class="o">&lt;</span><span class="n">GraphQLLanguage</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">errors</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="k">crate</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>SyntaxNode is !Send, so my ast is !Send also, but my team is wanting to use it in a multithreaded environment. If I understand correctly, rust-analyzer is also multithreaded (maybe I am wrong!), and I wanted to ask how you are managing to get your ast being passed around multiple threads?</p>



<a name="268005564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268005564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268005564">(Jan 14 2022 at 12:12)</a>:</h4>
<p>The core of rowan is actually threadsafe, <code>SyntaxNode</code> is just a non threadsafe wrapper with extra ref counting around the actual threadsafe <code>GreenNode</code>s, see <a href="https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/syntax/src/lib.rs#L71-L76">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/syntax/src/lib.rs#L71-L76</a> for some example usages. When we need a threadsafe tree we actually use the <code>GreenNode</code> and construct a <code>SyntaxNode</code> on demand with <code>SyntaxNode::new_root</code> from the <code>GreenNode</code></p>



<a name="268005713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268005713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268005713">(Jan 14 2022 at 12:14)</a>:</h4>
<p>To go from <code>SyntaxNode</code> to <code>GreenNode</code> its just a <code>syntax.green().to_owned()</code></p>



<a name="268006288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268006288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Irina Shestak (they/she) <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268006288">(Jan 14 2022 at 12:20)</a>:</h4>
<p>ah! I already use the <code>GreenNodeBuilder</code> when constructing the tree, and create the <code>SyntaxNode</code> on demand with <code>SyntaxNode::new_root</code>, so it seems all I am really missing is getting the GreenNode out with <code>syntax.green().to_owned()</code>.  Amazing!</p>



<a name="268014770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268014770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Irina Shestak (they/she) <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268014770">(Jan 14 2022 at 13:43)</a>:</h4>
<p>hmm passing around <code>GreenNodeData</code> between threads becomes possible if doing <code>green().to_owned()</code>, but getting the data out / "querying" the tree becomes a lot more difficult. All my nice types are tied to the <code>SyntaxNode</code>. I guess this problem goes away for rust-analyzer once the hir is created from the ast?</p>



<a name="268016030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268016030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268016030">(Jan 14 2022 at 13:53)</a>:</h4>
<p>ye our HIR doesn't really care about the syntax tree once created. We have machinery in place to fetch the source of a HIR node if required for things, which basically looks up a <code>SyntaxNodePtr</code>(a file id and a file offset) from which we (re-)parse the file and do a lookup at the offset for the node of interest again. So our HIR is only weakly connected via this file id, offset pair. But the main interest points should usually be exposed in the HIR in some form.</p>



<a name="268040271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%27s%20SyntaxNode%20in%20a%20multi-threaded%20environment/near/268040271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Irina Shestak (they/she) <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan&#x27;s.20SyntaxNode.20in.20a.20multi-threaded.20environment.html#268040271">(Jan 14 2022 at 16:49)</a>:</h4>
<p>right, that makes sense! I don't think it'd make a lot of sense for the HIR to be super closely tied to the syntax tree.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>