<html>
<head><meta charset="utf-8"><title>identities for TypeRefs, Paths, Exprs · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html">identities for TypeRefs, Paths, Exprs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278313786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278313786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278313786">(Apr 08 2022 at 14:39)</a>:</h4>
<p>soo I've been thinking about the old problem of identities for TypeRefs again.</p>
<p>right now our hir_def layer (which is actually pretty close to a traditional AST?) has two approaches for its various parts:</p>
<ul>
<li>
<p>Exprs and Pats (and items) are stored in Arenas, with each node having its own ID. E.g. if we have the expression <code>1 + 1</code>, we have two expressions <code>1</code> with separate IDs.<br>
   This allows us e.g. to have diagnostics pointing to specific expressions by their IDs.</p>
</li>
<li>
<p>Paths, TypeRefs etc. are just a simple tree structure using boxes or interned pointers.<br>
   They don't have identities, so in a type <code>(Foo, Foo)</code> both <code>Foo</code> could potentially be represented by the same <code>TypeRef</code> (except we don't intern them right now).<br>
   This makes lots of things simpler, but makes it hard to point to specific types or paths.<br>
   This is for example a problem for <code>impl Trait</code>, where we kind of need to uniquely identify each separate <code>impl Trait</code> (if you have <code>fn foo(x: (impl Trait, impl Trait))</code>, those two tuple elements are different types!). Also, now that we're adding more diagnostics, it would be good to be able to point to specific types.</p>
</li>
</ul>
<p>Note that TypeRefs, Paths and Exprs are quite interleaved:<br>
One kind of TypeRef is of course a path (<code>some::Type</code>);<br>
paths can be qualified, referring to a type (<code>&lt;(u32, bool)&gt;::bar</code>);<br>
paths can contain const parameters, which are expressions (<code>foo::&lt;{ 1 + 2 }&gt;</code>);<br>
expressions can of course contain paths and types.</p>
<p>This means that even in the current state, where exprs have identity and paths don't, we would actually need to have an arena (of exprs) when dealing with paths. We only avoid this because we don't lower const params yet; I expect <span class="user-mention" data-user-id="401078">@hkalbasi</span> has run into this problem by now.<br>
This also means that paths will have a 'tiny bit' of identity, just not 'fully', since they will need to refer to expressions:<br>
two instances of <code>foo::&lt;{1 + 2}&gt;</code> have to be distinguished by the identities of the expressions.</p>
<p>Soo my conclusion is that we should probably just bite the bullet and at least bring <code>TypeRef</code> on the same level as <code>Expr</code>, i.e. give them identity and store them in an arena, and have some common 'store' for the arenas of TypeRefs, Exprs and Pats (one per item probably).<br>
Maybe we don't need identities for Paths since they'll just be part of some TypeRef or Expr (or Pat).</p>
<p>Any thoughts or comments?<br>
<span class="user-mention" data-user-id="401078">@hkalbasi</span> how far along are you with lowering const exprs? I don't want to start working on this if it will just lead to giant conflicts with your work.</p>



<a name="278314426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278314426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278314426">(Apr 08 2022 at 14:44)</a>:</h4>
<blockquote>
<p>Maybe we don't need identities for Paths since they'll just be part of some TypeRef or Expr (or Pat).</p>
</blockquote>
<p>on that note, not sure how relevant but it would be great if we didn't have to re-resolve paths in the IDE layer :) <a href="https://github.com/rust-analyzer/rust-analyzer/issues/3407">r-a#3407</a></p>



<a name="278314589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278314589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278314589">(Apr 08 2022 at 14:46)</a>:</h4>
<blockquote>
<p>Soo my conclusion is that we should probably just bite the bullet and at least bring TypeRef on the same level as Expr, i.e. give them identity and store them in an arena, and have some common 'store' for the arenas of TypeRefs, Exprs and Pats (one per item probably).</p>
</blockquote>
<p>general <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> from me though</p>



<a name="278314751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278314751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278314751">(Apr 08 2022 at 14:47)</a>:</h4>
<p>yeah. I think some re-resolving might be necessary though since we probably don't want to store every partial resolution. It'd be a great start if at least the IDE / HIR layer didn't replicate a lot of resolution logic (e.g. looking at <code>resolve_hir_path_</code> in source_analyzer)</p>



<a name="278315270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278315270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278315270">(Apr 08 2022 at 14:50)</a>:</h4>
<blockquote>
<p>It'd be a great start if at least the IDE / HIR layer didn't replicate a lot of resolution logic (e.g. looking at resolve_hir_path_ in source_analyzer)</p>
</blockquote>
<p>Ye certainly, that also reminds me of <a href="https://github.com/rust-analyzer/rust-analyzer/issues/9694">https://github.com/rust-analyzer/rust-analyzer/issues/9694</a> which fails since we don't re-implement that part either (and didn't need to so far since we used the results from inference otherwise). I remember looking into that trying to lift out some duplication from <code>hir_ty</code> but I failed with that. Can't quite remember why.</p>



<a name="278315339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278315339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278315339">(Apr 08 2022 at 14:51)</a>:</h4>
<p>maybe also an interesting difference to note is that expression macros get expanded while lowering from AST to <code>Expr</code>, while type macros get expanded while lowering from <code>TypeRef</code> to <code>Ty</code>. not sure whether there's a reason why we can't expand while lowering to <code>TypeRef</code></p>



<a name="278315521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278315521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278315521">(Apr 08 2022 at 14:52)</a>:</h4>
<p>When do we lower <code>Pattern</code> macros? I think there were also some oddities around those if I remember correctly/</p>



<a name="278315641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278315641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278315641">(Apr 08 2022 at 14:52)</a>:</h4>
<p>patterns are generally handled the same as <code>Expr</code>s, so also during body lowering</p>



<a name="278315696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278315696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278315696">(Apr 08 2022 at 14:53)</a>:</h4>
<p>I think it would be nice to have a uniform approach to <code>Expr</code>, <code>Pat</code> and <code>TypeRef</code></p>



<a name="278315966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278315966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278315966">(Apr 08 2022 at 14:55)</a>:</h4>
<p>Ye definitely</p>



<a name="278317671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278317671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hkalbasi <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278317671">(Apr 08 2022 at 15:06)</a>:</h4>
<p>Bringing <code>TypeRef</code> at the level of <code>Expr</code> was my idea as well, it will lead to many changes in many places. What I currently have is a total mess, no where near a working state, and I wanted to declare my give up even before your message. So feel free to start working on this <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="278320080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278320080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278320080">(Apr 08 2022 at 15:25)</a>:</h4>
<p>old resolve vs record architercute issue about that: <a href="https://github.com/rust-analyzer/rust-analyzer/issues/3407">https://github.com/rust-analyzer/rust-analyzer/issues/3407</a></p>



<a name="278427033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278427033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278427033">(Apr 09 2022 at 19:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="129457">Florian Diebold</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs/near/278315339">said</a>:</p>
<blockquote>
<p>maybe also an interesting difference to note is that expression macros get expanded while lowering from AST to <code>Expr</code>, while type macros get expanded while lowering from <code>TypeRef</code> to <code>Ty</code>. not sure whether there's a reason why we can't expand while lowering to <code>TypeRef</code></p>
</blockquote>
<p>well, I found the reason -- <code>ItemTree</code> uses <code>TypeRef</code>s and is pre-expansion <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span></p>



<a name="278427716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278427716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278427716">(Apr 09 2022 at 19:58)</a>:</h4>
<p>I think we might end up needing another TypeRef IR <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="278430041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278430041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278430041">(Apr 09 2022 at 20:53)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I wonder if anyone wants to spend a weekend prototyping salsa-based compiler where everything has global, tree-shaped IDs?</p>



<a name="278430099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278430099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278430099">(Apr 09 2022 at 20:54)</a>:</h4>
<p>Seems it'll be much easier if we said that <strong>everything</strong> is identified by an <code>u32</code></p>



<a name="278430137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278430137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278430137">(Apr 09 2022 at 20:55)</a>:</h4>
<p>In other words, fp with its "everything is a value" is just a giant scam in compiler land -- everything needs to be an object with identity, with a potential exception of syntax trees</p>



<a name="278474219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278474219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278474219">(Apr 10 2022 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="129457">Florian Diebold</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs/near/278427033">said</a>:</p>
<blockquote>
<p>well, I found the reason -- <code>ItemTree</code> uses <code>TypeRef</code>s and is pre-expansion <span aria-label="confounded" class="emoji emoji-1f616" role="img" title="confounded">:confounded:</span></p>
</blockquote>
<p>hmm this of course also means we need a pre-expansion IR for expressions (e.g. if we have <code>fn foo() -&gt; [u32; { 1 + some_macro!() }]</code> how do we represent that in the ItemTree?)</p>
<p>one idea I had was to use a common polymorphic enum to represent the pre- and post-expansion IRs -- e.g. we'd have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Expr</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.,</span><span class="w"></span>
<span class="w">    </span><span class="n">MacroCall</span><span class="p">(</span><span class="n">M</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">type</span> <span class="nc">PreExpansionExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Expr</span><span class="o">&lt;</span><span class="n">AstId</span><span class="o">&lt;</span><span class="n">ast</span>::<span class="n">MacroCall</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="k">type</span> <span class="nc">PostExpansionExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Expr</span><span class="o">&lt;!&gt;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>not sure if that's overengineered (the other options would be just using the same enum and assuming at runtime there are no macro calls post expansion, or using fully separate enums)</p>



<a name="278474421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278474421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278474421">(Apr 10 2022 at 15:39)</a>:</h4>
<p>another option would be to do full* name resolution while we're expanding macros, like I think rustc does <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> </p>
<p>(* except for type-based resolution, of course)</p>



<a name="278475095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278475095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278475095">(Apr 10 2022 at 15:54)</a>:</h4>
<p>Isn't this gonna cost us a bunch of memory again? <span aria-label="sweat" class="emoji emoji-1f613" role="img" title="sweat">:sweat:</span></p>



<a name="278475179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278475179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278475179">(Apr 10 2022 at 15:56)</a>:</h4>
<blockquote>
<p>if we have fn foo() -&gt; [u32; { 1 + some_macro!() }] how do we represent that in the ItemTree?</p>
</blockquote>
<p>If the macro call isn't on the item level its not directly stored in the item tree. So that would only be part of the <code>TypeRef</code> stored for the return type I imagine</p>



<a name="278475291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278475291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278475291">(Apr 10 2022 at 15:58)</a>:</h4>
<p>well, yes. but the TypeRef is in the item tree, and the expression is part of the TypeRef</p>



<a name="278475317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278475317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278475317">(Apr 10 2022 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs/near/278475095">said</a>:</p>
<blockquote>
<p>Isn't this gonna cost us a bunch of memory again? <span aria-label="sweat" class="emoji emoji-1f613" role="img" title="sweat">:sweat:</span></p>
</blockquote>
<p>it's probably going to cost some memory, but we don't necessarily need to cache all these IRs</p>



<a name="278475463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278475463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278475463">(Apr 10 2022 at 16:01)</a>:</h4>
<blockquote>
<p>another option would be to do full* name resolution while we're expanding macros, like I think rustc does <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>Aren't we doing this already?</p>



<a name="278475515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278475515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278475515">(Apr 10 2022 at 16:02)</a>:</h4>
<p>well for TypeRefs we're doing both at the same time right now, but for expressions we're expanding macros when we lower to Expr but resolve other names during type inference</p>



<a name="278480392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278480392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278480392">(Apr 10 2022 at 17:39)</a>:</h4>
<p>Doesn't rustc only do name resolution for macros during expansion?</p>



<a name="278482298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278482298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278482298">(Apr 10 2022 at 18:19)</a>:</h4>
<p>I may very likely be misremembering</p>



<a name="278546686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/identities%20for%20TypeRefs%2C%20Paths%2C%20Exprs/near/278546686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/identities.20for.20TypeRefs.2C.20Paths.2C.20Exprs.html#278546686">(Apr 11 2022 at 12:36)</a>:</h4>
<p>rustc does run a pass to resolve <em>everything</em>, I believe, after early name resolution and macro expansion is done</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>