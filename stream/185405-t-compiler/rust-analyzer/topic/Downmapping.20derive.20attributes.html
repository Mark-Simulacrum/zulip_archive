<html>
<head><meta charset="utf-8"><title>Downmapping derive attributes · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Downmapping.20derive.20attributes.html">Downmapping derive attributes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271635798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Downmapping%20derive%20attributes/near/271635798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Downmapping.20derive.20attributes.html#271635798">(Feb 11 2022 at 20:56)</a>:</h4>
<p>So I once again looked into fixing some resolution things around derive macros(search/reference search specifically), like usual this requires a lot of special casing as the identifiers in <code>derive(...)</code> input token trees are not downmapped into the invocation onto <code>NameRef</code>s. Now I was wondering, since we can't change the parse for <code>derive</code> attribute invocations due to <code>derive</code> being a generic attribute in the language now. Could we somehow change things up to have the input tokens in the derive input, that is the <code>Foo</code> in <code>#[derive(Foo)]</code>, downmap into a special macro expansion file instead? That is have derive attributes expand to an extra expansion file(aside of all their single derive expansions) that just contains <code>NameRef</code>s of the invoked derives</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>MACRO_DERIVE_OUTPUT@0..3
    NAME_REF@0..3
</code></pre></div>
<p>That way resolving these identifiers would give us ordinary <code>NameRef</code>s we can properly use(at the cost of a bit more memory, how much I am not sure) like we do with all other names, removing a lot of complexity/moving all the complexity for looking up derives to one point(name ref classification).(This idea could maybe be expanded to other builtin macros where applicable as well).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>