<html>
<head><meta charset="utf-8"><title>implementing 10970 (diagnostic for trailing `return;`) · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html">implementing 10970 (diagnostic for trailing `return;`)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264587951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/implementing%2010970%20%28diagnostic%20for%20trailing%20%60return%3B%60%29/near/264587951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Skyler Ross <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html#264587951">(Dec 11 2021 at 22:12)</a>:</h4>
<p>... diagnostic for trailing:<br>
<code>return</code>, <code>return;</code> <code>return &lt;expr&gt;</code>, <code>return &lt;expr&gt;;</code><br>
in function bodies and closure bodies, since, those are all the same thing (not literally, but, they'd be expected to behave the same)</p>
<p>So, trying to read through the related code, specifically for actually _emitting_ the diagnostic</p>
<p>It looks like what I have to _somewhere_ (<code>hir_ty/src/diagnostics/decl_check.rs</code>? adjacent to it in <code>expr.rs</code>?) check all functions and closures- recursively- for if the last statement or tail (if there's a block at all), or the expr (ie, <code>|| return 2</code>) is a <code>return</code>, emit a diagnostic for that expression (<code>RemoveTrailingReturn</code>, open to bikeshedding), then, properly emit that diagnostic to the client over in <code>ide_diagnostics</code> as a weak warning(?) and with a fix to remove the <code>return</code> (and semicolon, if any)?</p>
<p>The umm, thing I'm having trouble with is _where_ to put the emission code, and if I might be missing something major, like "maybe just start with function bodies, and then make a second pr for closures, and a third for recursion"</p>



<a name="264589830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/implementing%2010970%20%28diagnostic%20for%20trailing%20%60return%3B%60%29/near/264589830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html#264589830">(Dec 11 2021 at 22:49)</a>:</h4>
<p>You can definitely start small and only do it for functions first, no need to do it all at once if you don't want to.</p>



<a name="264589986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/implementing%2010970%20%28diagnostic%20for%20trailing%20%60return%3B%60%29/near/264589986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html#264589986">(Dec 11 2021 at 22:52)</a>:</h4>
<p>So what you want to do is make a <code>BodyValidationDiagnostic</code>, so the emission of the diagnostic should probably live here <a href="https://github.com/Veykril/rust-analyzer/blob/d03397fe1173eaeb2e04c9e55ac223289e7e08ee/crates/hir_ty/src/diagnostics/expr.rs#L76">https://github.com/Veykril/rust-analyzer/blob/d03397fe1173eaeb2e04c9e55ac223289e7e08ee/crates/hir_ty/src/diagnostics/expr.rs#L76</a><br>
(forgot to mention that part in the issue comment)</p>



<a name="264589991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/implementing%2010970%20%28diagnostic%20for%20trailing%20%60return%3B%60%29/near/264589991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html#264589991">(Dec 11 2021 at 22:52)</a>:</h4>
<p>and the rest should be straight forward in copying from what the other diagnostics do</p>



<a name="264590001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/implementing%2010970%20%28diagnostic%20for%20trailing%20%60return%3B%60%29/near/264590001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html#264590001">(Dec 11 2021 at 22:53)</a>:</h4>
<p>(if not feel free to ask of course)</p>



<a name="264590075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/implementing%2010970%20%28diagnostic%20for%20trailing%20%60return%3B%60%29/near/264590075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/implementing.2010970.20(diagnostic.20for.20trailing.20.60return.3B.60).html#264590075">(Dec 11 2021 at 22:54)</a>:</h4>
<p>You will probably have to iterate the expressions again separately just for this diagnostic, like its done in <a href="https://github.com/Veykril/rust-analyzer/blob/d03397fe1173eaeb2e04c9e55ac223289e7e08ee/crates/hir_ty/src/diagnostics/expr.rs#L144-L193">https://github.com/Veykril/rust-analyzer/blob/d03397fe1173eaeb2e04c9e55ac223289e7e08ee/crates/hir_ty/src/diagnostics/expr.rs#L144-L193</a><br>
We don't have a nice infra for visiting things yet I think</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>