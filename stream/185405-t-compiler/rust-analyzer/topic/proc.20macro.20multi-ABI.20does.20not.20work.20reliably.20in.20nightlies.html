<html>
<head><meta charset="utf-8"><title>proc macro multi-ABI does not work reliably in nightlies · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html">proc macro multi-ABI does not work reliably in nightlies</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276459451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276459451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276459451">(Mar 24 2022 at 11:04)</a>:</h4>
<p>Our multi-ABI code currently decides which ABI to use purely based on the Rust version the proc macro was built with. This usually works fine for stable Rust, but nightlies often break the proc macro ABI without bumping the Rust version (which makes sense).</p>
<p>Ideally, rustc would include some sort of "proc macro ABI hash" in the built DLL, but until something like that exists, I'm tempted to disable proc macro support with nightly Rust versions, unless a setting is enabled to force it on. Thoughts?</p>



<a name="276459814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276459814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276459814">(Mar 24 2022 at 11:08)</a>:</h4>
<p>Maybe we could hash the relevant source files of libproc_macro as found in the rust-src component for nightly?</p>



<a name="276459890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276459890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276459890">(Mar 24 2022 at 11:09)</a>:</h4>
<p>I'm not sure we should be worried. I've seen some people who wanted support for old nightlies and such, but I think they wouldn't have been happy with just turning off proc macro support.</p>



<a name="276459987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276459987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276459987">(Mar 24 2022 at 11:10)</a>:</h4>
<p>I mean, most nightlies work fine anyway, and if we turn them off, we make things worse for everybody.</p>



<a name="276460097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276460097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276460097">(Mar 24 2022 at 11:10)</a>:</h4>
<p>Also <a href="https://github.com/rust-analyzer/rust-analyzer/issues/8925#issuecomment-874312836">https://github.com/rust-analyzer/rust-analyzer/issues/8925#issuecomment-874312836</a></p>



<a name="276460232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276460232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276460232">(Mar 24 2022 at 11:12)</a>:</h4>
<p>And if we do turn them off, we won't find out about changes.</p>



<a name="276461190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276461190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276461190">(Mar 24 2022 at 11:22)</a>:</h4>
<p>I'm not sure I get the problem -- shouldn't we at least be able to support the newest nightly?</p>



<a name="276461840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276461840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276461840">(Mar 24 2022 at 11:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies/near/276459814">said</a>:</p>
<blockquote>
<p>Maybe we could hash the relevant source files of libproc_macro as found in the rust-src component for nightly?</p>
</blockquote>
<p>We can also hash something like <code>with_api!(stringify)</code>, since the whole ABI is generated with a macro. That would at least catch the most common cases where a new API is added there.</p>



<a name="276461863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276461863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276461863">(Mar 24 2022 at 11:29)</a>:</h4>
<p>We don't add the new ABI immediately (sometimes it takes weeks) and some people don't want to use the latest nightly anyway.</p>



<a name="276461932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276461932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276461932">(Mar 24 2022 at 11:30)</a>:</h4>
<p>I agree we don't strictly have to support old nightlies, but then I'd at least like to provide better UX when something doesn't work</p>



<a name="276461986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/proc%20macro%20multi-ABI%20does%20not%20work%20reliably%20in%20nightlies/near/276461986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/proc.20macro.20multi-ABI.20does.20not.20work.20reliably.20in.20nightlies.html#276461986">(Mar 24 2022 at 11:30)</a>:</h4>
<p>Maybe detect the crash and disable them for the current session?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>