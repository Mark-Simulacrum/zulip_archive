<html>
<head><meta charset="utf-8"><title>rowan change syntax node · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html">rowan change syntax node</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261214644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261214644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261214644">(Nov 12 2021 at 05:47)</a>:</h4>
<p><a href="https://github.com/IWANABETHATGUY/rowan-json">https://github.com/IWANABETHATGUY/rowan-json</a>, i write a simple rowan-json parser , now i want to remove the token that equal to "test",</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowan_json</span>::<span class="n">syntax</span>::<span class="n">SyntaxNode</span>::<span class="n">new_root</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">green_node</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// let mutable_root = root.clone_for_update();</span>
<span class="w">    </span><span class="c1">// mutable_root.first_child().unwrap().index();</span>
<span class="w">    </span><span class="c1">// println!("{}", mutable_root);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">preorder_with_tokens</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SyntaxKind</span>::<span class="nb">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">text_range</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">r#""test""#</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">clone_for_update</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// res.splice_children(index..index+1, vec![]);</span>
<span class="w">                    </span><span class="c1">// println!("{}", res);</span>
<span class="w">                    </span><span class="n">res</span><span class="p">.</span><span class="n">splice_children</span><span class="p">(</span><span class="n">index</span><span class="o">..</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[]);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Leave</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// println!("leave {:?}, ", node.kind());</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>you could clone the repo and <code>cargo run</code>, expect to have json string remove all "test", but actual get </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="o">{</span>
  <span class="s2">"test"</span>: <span class="s2">"result"</span>,
  <span class="s2">"that"</span>: <span class="m">2</span>,
  <span class="s2">"array"</span>: <span class="o">[</span><span class="s2">"test"</span>, <span class="s2">"\u2222"</span>, <span class="m">20</span><span class="o">]</span>,
  <span class="s2">"res"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div>
<p>how should I do that?</p>



<a name="261235489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261235489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261235489">(Nov 12 2021 at 10:38)</a>:</h4>
<p>You can straight up remove something by using <code>detach</code> on it</p>



<a name="261242151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261242151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261242151">(Nov 12 2021 at 11:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261235489">said</a>:</p>
<blockquote>
<p>You can straight up remove something by using <code>detach</code> on it</p>
</blockquote>
<p>Some(<a href="mailto:String@4..10">String@4..10</a> "\"test\"")<br>
thread 'main' panicked at 'immutable tree: {<br>
  "test": "result",<br>
  "that": 2,<br>
  "array": ["test", "\u2222", 20],<br>
  "res": {}<br>
}',<br>
new error</p>



<a name="261243379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261243379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261243379">(Nov 12 2021 at 12:10)</a>:</h4>
<p>You need to <code>clone_for_update</code> the tree first</p>



<a name="261243400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261243400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261243400">(Nov 12 2021 at 12:10)</a>:</h4>
<p>by default trees are immutable, with the function you clone a tree into a mutable copy of it that you can modifiy</p>



<a name="261244089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261244089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261244089">(Nov 12 2021 at 12:18)</a>:</h4>
<p>clone_for_update will craete a new tree, but how to patch the change to <br>
<span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261243400">said</a>:</p>
<blockquote>
<p>by default trees are immutable, with the function you clone a tree into a mutable copy of it that you can modifiy</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowan_json</span>::<span class="n">syntax</span>::<span class="n">SyntaxNode</span>::<span class="n">new_root</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">green_node</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// let mutable_root = root.clone_for_update();</span>
<span class="w">    </span><span class="c1">// mutable_root.first_child().unwrap().index();</span>
<span class="w">    </span><span class="c1">// println!("{}", mutable_root);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">preorder_with_tokens</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SyntaxKind</span>::<span class="nb">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">text_range</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">r#""test""#</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">clone_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">clone_for_update</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="n">clone_parent</span><span class="p">.</span><span class="n">children_with_tokens</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// println!("{}", clone_parent);</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Leave</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// println!("leave {:?}, ", node.kind());</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>result shows below</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="o">{</span>
  <span class="s2">"test"</span>: <span class="s2">"result"</span>,
  <span class="s2">"that"</span>: <span class="m">2</span>,
  <span class="s2">"array"</span>: <span class="o">[</span><span class="s2">"test"</span>, <span class="s2">"\u2222"</span>, <span class="m">20</span><span class="o">]</span>,
  <span class="s2">"res"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div>
<p>i clone_for_update for every parent node, but finally tree did't change at all. So how to get a CST tree that delete all  <code>test</code> string node</p>



<a name="261244180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261244180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261244180">(Nov 12 2021 at 12:19)</a>:</h4>
<p>Ah, you need to clone the root tree, and then traverse down to the node you want to delete in <strong><em>the cloned</em></strong> tree</p>



<a name="261244246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261244246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261244246">(Nov 12 2021 at 12:20)</a>:</h4>
<p>basically <code>clone_for_update</code> gives you a completely separate, fresh tree, so cloning multiple nodes will give you nodes of completely separate trees.</p>



<a name="261244371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261244371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261244371">(Nov 12 2021 at 12:21)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowan_json</span>::<span class="n">syntax</span>::<span class="n">SyntaxNode</span>::<span class="n">new_root</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">green_node</span><span class="p">).</span><span class="n">clone_for_update</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// let mutable_root = root.clone_for_update();</span>
<span class="w">    </span><span class="c1">// mutable_root.first_child().unwrap().index();</span>
<span class="w">    </span><span class="c1">// println!("{}", mutable_root);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">preorder_with_tokens</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SyntaxKind</span>::<span class="nb">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">text_range</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">r#""test""#</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="n">parent</span><span class="p">.</span><span class="n">children_with_tokens</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// println!("{}", clone_parent);</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Leave</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// println!("leave {:?}, ", node.kind());</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>should work</p>



<a name="261244456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261244456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261244456">(Nov 12 2021 at 12:22)</a>:</h4>
<p>note though that if you iterate over a mutable tree and modify it like here , you will likely end up with spurious panics(iterating and mutating something at the same time is never a good idea), so ideally if you plan to modify more than one node in this case you should collect all nodes you wanna remove/change first</p>



<a name="261260627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261260627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261260627">(Nov 12 2021 at 14:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261244456">said</a>:</p>
<blockquote>
<p>note though that if you iterate over a mutable tree and modify it like here , you will likely end up with spurious panics(iterating and mutating something at the same time is never a good idea), so ideally if you plan to modify more than one node in this case you should collect(in a vec or something) all nodes you wanna remove/change first, then do the actual removal/mutation in a separate pass</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">include_str!</span><span class="p">(</span><span class="s">"../assets/test.json"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parser</span>::<span class="n">new</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">.</span><span class="n">parse</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowan_json</span>::<span class="n">syntax</span>::<span class="n">SyntaxNode</span>::<span class="n">new_root</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">green_node</span><span class="p">).</span><span class="n">clone_for_update</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// let mutable_root = root.clone_for_update();</span>
<span class="w">    </span><span class="c1">// mutable_root.first_child().unwrap().index();</span>
<span class="w">    </span><span class="c1">// println!("{}", mutable_root);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">range_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">preorder_with_tokens</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SyntaxKind</span>::<span class="nb">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// println!("{}", clone_parent);</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Leave</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">text_range</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">r#""test""#</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">range_list</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">text_range</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="c1">// println!("leave {:?}, ", node.kind());</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">range_list</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">range_list</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">range</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">covering_element</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">as_token</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>I use two pass to mutate the syntax tree, first pass collect range, second pass detach node.<br>
but actual result is :</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="o">{</span>
  : <span class="s2">"result"</span>,
  <span class="s2">"that"</span>: <span class="m">2</span>,
  <span class="s2">"array"</span>: <span class="o">[</span><span class="s2">"test"</span>, <span class="s2">"\u2222"</span>, <span class="m">20</span><span class="o">]</span>,
  <span class="s2">"res"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div>
<p>expected is</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="o">{</span>
  : <span class="s2">"result"</span>,
  <span class="s2">"that"</span>: <span class="m">2</span>,
  <span class="s2">"array"</span>: <span class="o">[</span><span class="s2">"\u2222"</span>, <span class="m">20</span><span class="o">]</span>,
  <span class="s2">"res"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div>
<p>`"test" in array should be remove too.</p>



<a name="261261316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261261316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261261316">(Nov 12 2021 at 14:44)</a>:</h4>
<p>You shouldn't refetch the nodes via the text ranges, you can just save the nodes/tokens themselves in the vector</p>



<a name="261261415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261261415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261261415">(Nov 12 2021 at 14:45)</a>:</h4>
<p>so your range_list should be a Vec of SyntaxNode/SyntaxToken/SyntaxElement, whichever you use here</p>



<a name="261261532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261261532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261261532">(Nov 12 2021 at 14:46)</a>:</h4>
<p>it fails right now because you fetch the first match via range, delete that and that deletion moves the  text ranges so the second range lookup fails, but these lookups are unnecessary</p>



<a name="261261570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261261570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261261570">(Nov 12 2021 at 14:46)</a>:</h4>
<p>Since you already have the nodes before, so no need to convert between text range and node back and forth</p>



<a name="261261691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261261691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261261691">(Nov 12 2021 at 14:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261261415">said</a>:</p>
<blockquote>
<p>so your range_list should be a Vec of SyntaxNode/SyntaxToken/SyntaxElement, whichever you use here</p>
</blockquote>
<p>That was awesome, Thanks a lot</p>



<a name="261263084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261263084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261263084">(Nov 12 2021 at 14:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261261415">said</a>:</p>
<blockquote>
<p>so your range_list should be a Vec of SyntaxNode/SyntaxToken/SyntaxElement, whichever you use here</p>
</blockquote>
<p>forgive me, another stupid question</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">include_str!</span><span class="p">(</span><span class="s">"../assets/test.json"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parser</span>::<span class="n">new</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">.</span><span class="n">parse</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowan_json</span>::<span class="n">syntax</span>::<span class="n">SyntaxNode</span>::<span class="n">new_root</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">green_node</span><span class="p">).</span><span class="n">clone_for_update</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// let mutable_root = root.clone_for_update();</span>
<span class="w">    </span><span class="c1">// mutable_root.first_child().unwrap().index();</span>
<span class="w">    </span><span class="c1">// println!("{}", mutable_root);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">range_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">preorder_with_tokens</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SyntaxKind</span>::<span class="nb">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// println!("{}", clone_parent);</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">rowan</span>::<span class="n">WalkEvent</span>::<span class="n">Leave</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">text_range</span><span class="p">()]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">r#""test""#</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">range_list</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="c1">// println!("leave {:?}, ", node.kind());</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">range_list</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">range_list</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">range</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">.</span><span class="n">as_token</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="n">replace_with</span><span class="p">(</span><span class="n">GreenToken</span>::<span class="n">new</span><span class="p">(</span><span class="n">SyntaxKind</span>::<span class="nb">String</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">r#""that""#</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>what if i want to replace the String token with <code>"test"</code> string token, what should i do?</p>



<a name="261263961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261263961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261263961">(Nov 12 2021 at 15:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261261316">said</a>:</p>
<blockquote>
<p>You shouldn't refetch the nodes via the text ranges, you can just save the nodes/tokens themselves in the vector</p>
</blockquote>
<p>I Would like to add more document about how to mutate the syntax node,  please forgive me.</p>



<a name="261264510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261264510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261264510">(Nov 12 2021 at 15:05)</a>:</h4>
<p>I assume the <code>replace_with</code> panics?</p>



<a name="261264524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261264524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261264524">(Nov 12 2021 at 15:05)</a>:</h4>
<p>or what is the problem here</p>



<a name="261265715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261265715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261265715">(Nov 12 2021 at 15:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261264524">said</a>:</p>
<blockquote>
<p>or what is the problem here</p>
</blockquote>
<p>actually nothing happen, <br>
the finally json stirng is </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="o">{</span>
  <span class="s2">"test"</span>: <span class="s2">"result"</span>,
  <span class="s2">"that"</span>: <span class="m">2</span>,
  <span class="s2">"array"</span>: <span class="o">[</span><span class="s2">"test"</span>, <span class="s2">"\u2222"</span>, <span class="m">20</span><span class="o">]</span>,
  <span class="s2">"res"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div>
<p>the same as original json string, but expected is </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="o">{</span>
  <span class="s2">"that"</span>: <span class="s2">"result"</span>,
  <span class="s2">"that"</span>: <span class="m">2</span>,
  <span class="s2">"array"</span>: <span class="o">[</span><span class="s2">"that"</span>, <span class="s2">"\u2222"</span>, <span class="m">20</span><span class="o">]</span>,
  <span class="s2">"res"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div>



<a name="261266194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261266194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261266194">(Nov 12 2021 at 15:14)</a>:</h4>
<p>Ah, <code>replace_with</code> isnt mutable stuff, that function returns a new modified copy of the tree</p>



<a name="261266325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261266325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261266325">(Nov 12 2021 at 15:15)</a>:</h4>
<p>You need to use splice/splice_children</p>



<a name="261266336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261266336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261266336">(Nov 12 2021 at 15:15)</a>:</h4>
<p>See <a href="https://github.com/Veykril/rust-analyzer/blob/0082fd785536fd94d0a093cd619a8e571167b439\crates\syntax\src\ted.rs#L141">https://github.com/Veykril/rust-analyzer/blob/0082fd785536fd94d0a093cd619a8e571167b439\crates\syntax\src\ted.rs#L141</a></p>



<a name="261270818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261270818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261270818">(Nov 12 2021 at 15:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261266336">said</a>:</p>
<blockquote>
<p>See <a href="https://github.com/Veykril/rust-analyzer/blob/0082fd785536fd94d0a093cd619a8e571167b439\crates\syntax\src\ted.rs#L141">https://github.com/Veykril/rust-analyzer/blob/0082fd785536fd94d0a093cd619a8e571167b439\crates\syntax\src\ted.rs#L141</a></p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">splice_children</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">()</span><span class="o">..</span><span class="n">node</span><span class="p">.</span><span class="n">index</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="fm">vec!</span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="n">NodeOrToken</span>::<span class="n">Token</span><span class="p">(</span><span class="n">SyntaxToken</span><span class="p">),</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// NodeOrToken::Token(node.clone()),</span>
<span class="w">                </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>so how could i create a new SyntaxToken?</p>



<a name="261271898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261271898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261271898">(Nov 12 2021 at 15:54)</a>:</h4>
<p>I think you have to go through <code>SyntaxNode::new_root</code>(<code>SyntaxNode::new_root_mut</code> in your case)then fetch the token through that</p>



<a name="261333798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/rowan%20change%20syntax%20node/near/261333798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> IWANABETHATGUY <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/rowan.20change.20syntax.20node.html#261333798">(Nov 13 2021 at 02:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rowan.20change.20syntax.20node/near/261271898">said</a>:</p>
<blockquote>
<p>I think you have to go through <code>SyntaxNode::new_root</code>(<code>SyntaxNode::new_root_mut</code> in your case)then fetch the token through that</p>
</blockquote>
<p>Thanks again, but I am wonder why there is not a contructor to build a new SyntaxToken, fetch the SyntaxToken from <code>new_root</code> is not efficient.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>