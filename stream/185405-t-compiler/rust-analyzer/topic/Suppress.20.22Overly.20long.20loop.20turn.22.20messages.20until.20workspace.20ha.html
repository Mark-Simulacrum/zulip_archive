<html>
<head><meta charset="utf-8"><title>Suppress &quot;Overly long loop turn&quot; messages until workspace ha · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html">Suppress &quot;Overly long loop turn&quot; messages until workspace ha</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267298112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267298112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267298112">(Jan 08 2022 at 14:20)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/issues/10120">https://github.com/rust-analyzer/rust-analyzer/issues/10120</a></p>
<p>Someone asked about how to address this issue, I don't know the rust-analyzer crate itself too well though to be able to answer. Do we have anything indicating workspace being fully loaded? Is that what <code>is_quiescent</code> tells?</p>



<a name="267298152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267298152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267298152">(Jan 08 2022 at 14:21)</a>:</h4>
<blockquote>
<p>Is that what is_quiescent tells?</p>
</blockquote>
<p>Yes, IIRC</p>



<a name="267438627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267438627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267438627">(Jan 10 2022 at 13:29)</a>:</h4>
<p>We probably can remove that altogether -- the original idea is that we shouldn't be having long loops <em>especially</em> in non-quiescent state, but we've never got to actually fixing that</p>



<a name="267438666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267438666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267438666">(Jan 10 2022 at 13:29)</a>:</h4>
<p>basically, anything that <em>could</em> take more than 16ms <em>should</em> be off the main loop</p>



<a name="267438964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267438964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267438964">(Jan 10 2022 at 13:32)</a>:</h4>
<p>yeah, this can block the <code>onEnter</code> handler for <em>minutes</em>, presumably we block on the build script results or something?</p>



<a name="267439083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267439083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267439083">(Jan 10 2022 at 13:33)</a>:</h4>
<p>Might be that <code>switch_workspaces</code> call</p>



<a name="267442954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267442954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267442954">(Jan 10 2022 at 14:08)</a>:</h4>
<blockquote>
<p>for minutes,</p>
</blockquote>
<p>Oh, that's def a bug which has to be fixed</p>



<a name="267442984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267442984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267442984">(Jan 10 2022 at 14:09)</a>:</h4>
<p>Maybe just increasing the timeout to 1 second would be good?</p>



<a name="267443540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267443540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267443540">(Jan 10 2022 at 14:13)</a>:</h4>
<p>maybe we could only log this if profiling is enabled?</p>



<a name="267460589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267460589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Chin (eminence) <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267460589">(Jan 10 2022 at 16:16)</a>:</h4>
<p>as an end-user of rust-analyzer, am i supposed to do anything when i see a "Overly long loop turn" message?  should I report it as a bug?</p>



<a name="267461188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267461188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267461188">(Jan 10 2022 at 16:21)</a>:</h4>
<p>If it happens when loading or reloading the project, you probably can't do anything about it.</p>



<a name="267461489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267461489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Chin (eminence) <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267461489">(Jan 10 2022 at 16:23)</a>:</h4>
<p>in that case, a <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> to the idea of suppressing a message that should be ignored :)</p>



<a name="267859975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267859975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267859975">(Jan 13 2022 at 12:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="203546">Laurențiu</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha/near/267461188">said</a>:</p>
<blockquote>
<p>If it happens when loading or reloading the project, you probably can't do anything about it.</p>
</blockquote>
<p>oh really? i get 3 overly long loop turns every time i save a file in our work workspace. i figured this was... it working as intended?</p>



<a name="267860947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267860947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267860947">(Jan 13 2022 at 12:20)</a>:</h4>
<p>it only happens when check on save is enabled... hmm</p>



<a name="267860998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267860998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267860998">(Jan 13 2022 at 12:21)</a>:</h4>
<p>Do you have a lot of warnings or something like that?</p>



<a name="267861041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267861041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267861041">(Jan 13 2022 at 12:21)</a>:</h4>
<p>43 in the workspace</p>



<a name="267861407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267861407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267861407">(Jan 13 2022 at 12:25)</a>:</h4>
<p>okay fixed all the warnings and still takes 200-300ms loop turn every time checkOnSave runs</p>



<a name="267861434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267861434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267861434">(Jan 13 2022 at 12:25)</a>:</h4>
<p>Can you check the profile? <a href="https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/dev#profiling">https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/dev#profiling</a></p>



<a name="267861572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267861572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267861572">(Jan 13 2022 at 12:27)</a>:</h4>
<p>E.g. <code>"rust-analyzer.server.extraEnv": { "RA_PROFILE": "*&gt;10" }</code></p>



<a name="267862891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267862891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267862891">(Jan 13 2022 at 12:40)</a>:</h4>
<p>You posted the profile output in the wrong thread, but ye those 180ms would hit that. Are there no other spans in that flycheck one aside from <code>handle_event/flycheck</code>?</p>



<a name="267862962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267862962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267862962">(Jan 13 2022 at 12:41)</a>:</h4>
<p>whoops! yeah there's a lot of spans, here's both: <a href="https://gist.github.com/jhgg/859f0a373bc14107d7f4788b89abbef7">https://gist.github.com/jhgg/859f0a373bc14107d7f4788b89abbef7</a></p>



<a name="267863573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267863573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267863573">(Jan 13 2022 at 12:48)</a>:</h4>
<p>relevant source part is here <a href="https://github.com/rust-analyzer/rust-analyzer/blob/62a13cce9b6356af0dfeeeb6add3432f0e76a19f/crates/rust-analyzer/src/main_loop.rs#L358-L426">https://github.com/rust-analyzer/rust-analyzer/blob/62a13cce9b6356af0dfeeeb6add3432f0e76a19f/crates/rust-analyzer/src/main_loop.rs#L358-L426</a><br>
I don't really see where that comes from if you don't have any diagnostics actually <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="267863958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267863958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267863958">(Jan 13 2022 at 12:51)</a>:</h4>
<p>yeah me neither i read the code. i can probably pop in more spans and try and locate whats the slow part...</p>



<a name="267864057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267864057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267864057">(Jan 13 2022 at 12:52)</a>:</h4>
<p>Maybe a lot(and I mean a ton) of <code>Progress</code> events are being sent? That is the only thing I could see causing this here</p>



<a name="267864297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267864297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267864297">(Jan 13 2022 at 12:54)</a>:</h4>
<p>also, is it expected for trivial character changes in rather small files for semantics/inlay hints to take 250ms to update?</p>



<a name="267864466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267864466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267864466">(Jan 13 2022 at 12:56)</a>:</h4>
<p>Yes and No, we recalculate those for the whole file, but it should still be very fast due to query results being cached in theory. The main problem, which also makes completions currently suffer is apparently query validation. If you take a look at all those things, the majority of the time is spent in <code>infer:wait @ get_session_id</code>.</p>



<a name="267864531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267864531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267864531">(Jan 13 2022 at 12:57)</a>:</h4>
<p>That's type inference for something we already have calculated, but salsa seems to take a long time revalidating that the query result has not changed.</p>



<a name="267866047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267866047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267866047">(Jan 13 2022 at 13:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300586">Lukas Wirth</span> <a href="#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha/near/267864057">said</a>:</p>
<blockquote>
<p>Maybe a lot(and I mean a ton) of <code>Progress</code> events are being sent? That is the only thing I could see causing this here</p>
</blockquote>
<p>27 add diagnostic type messages coming in appears to be.e</p>



<a name="267866471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267866471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267866471">(Jan 13 2022 at 13:14)</a>:</h4>
<p>We're passing <code>--all-targets</code>, maybe you have some warnings in tests?</p>



<a name="267866505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267866505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267866505">(Jan 13 2022 at 13:14)</a>:</h4>
<p>Yeah, I do. They're dead_code warnings in tests because of some cfg feature flags.  heh. but i have them demoted to hints so they dont show up in problem pane</p>



<a name="267866977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267866977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267866977">(Jan 13 2022 at 13:19)</a>:</h4>
<p>It ends on a quadratic path because of <code>add_check_diagnostic</code>, but I'm not sure whether that's the problem</p>



<a name="267867100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267867100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267867100">(Jan 13 2022 at 13:20)</a>:</h4>
<p>it might be interesting to also measure the time we're blocking while sending LSP responses, to see whether it's the case that we're overwhelming the other side with messages (e.g. progress)</p>



<a name="267867241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267867241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267867241">(Jan 13 2022 at 13:21)</a>:</h4>
<p>publishing of the lsp response for diagnostics appears to occur on another thread</p>



<a name="267867621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267867621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267867621">(Jan 13 2022 at 13:24)</a>:</h4>
<p><del>Ah, we actually block when running <code>rustfmt</code>. Or no, we don't?</del></p>



<a name="267868234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267868234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267868234">(Jan 13 2022 at 13:30)</a>:</h4>
<p>the time is spent in DiagnosticCollection::clear_check &gt;_&gt;</p>



<a name="267868287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267868287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267868287">(Jan 13 2022 at 13:31)</a>:</h4>
<div class="codehilite"><pre><span></span><code>102ms - GlobalState::handle_event
      102ms - GlobalState::handle_event/flycheck
          101ms - DiagnosticCollection::clear_check
        0   - GlobalState::process_changes (1 calls)
</code></pre></div>



<a name="267868316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267868316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267868316">(Jan 13 2022 at 13:31)</a>:</h4>
<p>Unrelated, do we publish all the diagnostics every time?</p>



<a name="267868943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267868943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267868943">(Jan 13 2022 at 13:36)</a>:</h4>
<p>Hmm, <code>clear_check</code> looks a bit odd to me, <a href="https://github.com/rust-analyzer/rust-analyzer/blob/09ce5d81d081ddf687dbbff22c6c5dab419e7336/crates/rust-analyzer/src/diagnostics.rs#L38-L41">https://github.com/rust-analyzer/rust-analyzer/blob/09ce5d81d081ddf687dbbff22c6c5dab419e7336/crates/rust-analyzer/src/diagnostics.rs#L38-L41</a><br>
<code>Arc::make_mut</code> might clone the entire hashmap just to clear it if there is more than one outstanding strong ref</p>



<a name="267869001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267869001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267869001">(Jan 13 2022 at 13:37)</a>:</h4>
<p>you'd think its that</p>



<a name="267869013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267869013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267869013">(Jan 13 2022 at 13:37)</a>:</h4>
<p>but the cost i actually think is in dropping the diagnostic</p>



<a name="267869057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267869057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jhgg <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267869057">(Jan 13 2022 at 13:37)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  166ms - GlobalState::handle_event
      165ms - GlobalState::handle_event/flycheck
          165ms - DiagnosticCollection::clear_check @ 9 check_fixes, 9 check
              164ms - extend changes
                0   - clear check fixes (1 calls)
        0   - GlobalState::process_changes (1 calls)
</code></pre></div>
<div class="codehilite"><pre><span></span><code>        {
            let _p = profile::span(&quot;extend changes&quot;);
            self.changes.extend(self.check.drain().map(|(key, _value)| key))
        }
</code></pre></div>



<a name="267869555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267869555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267869555">(Jan 13 2022 at 13:41)</a>:</h4>
<p>Well <code>lsp_types::Diagnostic</code> has a bunch of fields that may allocate, so I guess it's not too surprising there?...</p>



<a name="267870143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267870143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267870143">(Jan 13 2022 at 13:45)</a>:</h4>
<p>I don't see how it can happen, but if I save once, I get 11 <code>textDocument/publishDiagnostics</code> notifications that get progressively larger</p>



<a name="267870201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267870201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267870201">(Jan 13 2022 at 13:45)</a>:</h4>
<p><a href="/user_uploads/4715/czgSqBWTw-dchuj2EszfndXm/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/czgSqBWTw-dchuj2EszfndXm/image.png" title="image.png"><img src="/user_uploads/4715/czgSqBWTw-dchuj2EszfndXm/image.png"></a></div><p>Check out the yellow dots on the right</p>



<a name="267870375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267870375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267870375">(Jan 13 2022 at 13:47)</a>:</h4>
<p>That doesn't seem right</p>



<a name="267870978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Suppress%20%22Overly%20long%20loop%20turn%22%20messages%20until%20workspace%20ha/near/267870978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Suppress.20.22Overly.20long.20loop.20turn.22.20messages.20until.20workspace.20ha.html#267870978">(Jan 13 2022 at 13:52)</a>:</h4>
<p>Well, we insert into <code>check</code> in <code>add_check_diagnostic</code>, return all of them in <code>diagnostics_for</code>, but we don't clear <code>check</code> in <code>take_changes</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>