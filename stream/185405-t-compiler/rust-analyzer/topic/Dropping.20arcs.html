<html>
<head><meta charset="utf-8"><title>Dropping arcs · t-compiler/rust-analyzer · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/index.html">t-compiler/rust-analyzer</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html">Dropping arcs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251079669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079669">(Aug 28 2021 at 20:18)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> are you online by any chance?</p>



<a name="251079684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079684">(Aug 28 2021 at 20:19)</a>:</h4>
<p>want chat about <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10065">https://github.com/rust-analyzer/rust-analyzer/issues/10065</a> I:</p>



<a name="251079694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079694">(Aug 28 2021 at 20:19)</a>:</h4>
<p>So, I've look at the output of <code>cargo rustc --release -- --emit=llvm-ir -Cno-prepopulate-passes -Cpasses=name-anon-globals -o out.ir</code></p>



<a name="251079756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079756">(Aug 28 2021 at 20:20)</a>:</h4>
<p>And apparently what happens is that drops are generated by the <code>drop</code> function from a trait's VTable</p>



<a name="251079770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079770">(Aug 28 2021 at 20:20)</a>:</h4>
<p>Although nothing in this crate I think actually drops <code>dyn</code> values</p>



<a name="251079792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079792">(Aug 28 2021 at 20:20)</a>:</h4>
<p>So, I am wondering how codegen for drops for dyn types works, and if there any way to force the codegen happen upstream?</p>



<a name="251079818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251079818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251079818">(Aug 28 2021 at 20:21)</a>:</h4>
<p>Seems like somethin you might just know :)</p>



<a name="251080023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080023">(Aug 28 2021 at 20:25)</a>:</h4>
<p>let me take a quick look at the source code of the monomorphization collector.</p>



<a name="251080125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080125">(Aug 28 2021 at 20:27)</a>:</h4>
<p>creating a <code>dyn</code> value is enough to create a fully populated vtable including destructor</p>



<a name="251080179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080179">(Aug 28 2021 at 20:28)</a>:</h4>
<p>and I think vtables are always generated in the codegen unit that needs to use it</p>



<a name="251080202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080202">(Aug 28 2021 at 20:28)</a>:</h4>
<p>So that means we generate ~~~ <code>impl Drop for RootDatabase</code> in every crate starting from <code>ide_db</code>?</p>



<a name="251080285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080285">(Aug 28 2021 at 20:30)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/42a2a53ec13b0e6e915acd09a2a9a963e5fa3b92/compiler/rustc_mir/src/monomorphize/collector.rs#L1132">https://github.com/rust-lang/rust/blob/42a2a53ec13b0e6e915acd09a2a9a963e5fa3b92/compiler/rustc_mir/src/monomorphize/collector.rs#L1132</a></p>
<p><a href="https://github.com/rust-lang/rust/blob/42a2a53ec13b0e6e915acd09a2a9a963e5fa3b92/compiler/rustc_mir/src/monomorphize/collector.rs#L942">https://github.com/rust-lang/rust/blob/42a2a53ec13b0e6e915acd09a2a9a963e5fa3b92/compiler/rustc_mir/src/monomorphize/collector.rs#L942</a></p>



<a name="251080286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080286">(Aug 28 2021 at 20:30)</a>:</h4>
<p>Yeah, vtables are always codegened in the local mono item.</p>



<a name="251080287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080287">(Aug 28 2021 at 20:30)</a>:</h4>
<p>(deleted)</p>



<a name="251080303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080303">(Aug 28 2021 at 20:30)</a>:</h4>
<p>not just per-crate, it's per codegen unit</p>



<a name="251080346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080346">(Aug 28 2021 at 20:31)</a>:</h4>
<p>For usual calls, we have this code in salsa:</p>
<p><a href="https://github.com/salsa-rs/salsa/blob/114d6db8f6575de9b991c3ce9944f0a679a24b85/components/salsa-macros/src/query_group.rs#L240-L248">https://github.com/salsa-rs/salsa/blob/114d6db8f6575de9b991c3ce9944f0a679a24b85/components/salsa-macros/src/query_group.rs#L240-L248</a></p>



<a name="251080348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080348">(Aug 28 2021 at 20:31)</a>:</h4>
<p>so if you end up with 16 CGUs and they all contain code that casts <code>&amp;RootDatabase</code> to <code>&amp;dyn HirDatabase</code>, then you get 16 destructors and vtables</p>



<a name="251080357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080357">(Aug 28 2021 at 20:32)</a>:</h4>
<p>I've just verifyied that commenting that out makes rust-analyzer compiled 1.5x slower in for me</p>



<a name="251080415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080415">(Aug 28 2021 at 20:32)</a>:</h4>
<p>Can we write a similar shim for drop glue?</p>



<a name="251080420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080420">(Aug 28 2021 at 20:32)</a>:</h4>
<p>I think drop glue is codegened locally due to <code>drop_in_place</code> technically being generic.</p>



<a name="251080434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080434">(Aug 28 2021 at 20:33)</a>:</h4>
<p>And the <code>Drop</code> impl in question being on a generic type.</p>



<a name="251080447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080447">(Aug 28 2021 at 20:33)</a>:</h4>
<p>maybe you could hack something together with a newtype or something?</p>



<a name="251080449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080449">(Aug 28 2021 at 20:33)</a>:</h4>
<p>There's no Drop impl at all I think, it's just the "drop all the fields" stuff</p>



<a name="251080502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080502">(Aug 28 2021 at 20:34)</a>:</h4>
<p>how do the stats change if you pass <code>-Zshare-generics</code>?</p>



<a name="251080560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080560">(Aug 28 2021 at 20:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  115446 (100%)  4163 (100%)  (TOTAL)
    2611 (2.3%)    13 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::rehash_in_place
    2302 (2.0%)     7 (0.2%)  ide_ssr::parsing::RuleBuilder::try_add
    2286 (2.0%)    13 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::resize
    2029 (1.8%)    16 (0.4%)  core::iter::traits::iterator::Iterator::try_fold
    1861 (1.6%)    35 (0.8%)  &lt;core::result::Result&lt;T,E&gt; as core::ops::try_trait::Try&gt;::branch
    1668 (1.4%)    16 (0.4%)  hashbrown::raw::RawTable&lt;T,A&gt;::find
    1508 (1.3%)    12 (0.3%)  hashbrown::map::HashMap&lt;K,V,S,A&gt;::insert
    1450 (1.3%)     1 (0.0%)  ide_ssr::matching::Matcher::attempt_match_token_tree
    1273 (1.1%)    12 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::insert
    1248 (1.1%)    13 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::rehash_in_place::{{closure}}
    1224 (1.1%)     9 (0.2%)  alloc::raw_vec::RawVec&lt;T,A&gt;::grow_amortized
    1220 (1.1%)    24 (0.6%)  core::option::Option&lt;T&gt;::map
    1161 (1.0%)     3 (0.1%)  ide_ssr::matching::Matcher::attempt_match_opt
    1094 (0.9%)     4 (0.1%)  &lt;core::iter::adapters::flatten::FlattenCompat&lt;I,U&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold
    1042 (0.9%)    20 (0.5%)  core::mem::replace
    1040 (0.9%)    13 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::reserve_rehash
     952 (0.8%)     1 (0.0%)  ide_ssr::matching::Matcher::attempt_match_ufcs_to_method_call
     910 (0.8%)    13 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::drop_elements
     888 (0.8%)    17 (0.4%)  core::option::Option&lt;T&gt;::ok_or_else
     884 (0.8%)    13 (0.3%)  &lt;hashbrown::raw::RawIterRange&lt;T&gt; as core::iter::traits::iterator::Iterator&gt;::next
     882 (0.8%)     1 (0.0%)  ide_ssr::matching::Matcher::attempt_match_record_field_list
</code></pre></div>



<a name="251080599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080599">(Aug 28 2021 at 20:36)</a>:</h4>
<p>in other words, much, much better</p>



<a name="251080639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080639">(Aug 28 2021 at 20:37)</a>:</h4>
<p>lol, that's 4X fewer ir lines</p>



<a name="251080726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080726">(Aug 28 2021 at 20:38)</a>:</h4>
<p>oh</p>
<div class="codehilite"><pre><span></span><code>[profile.release]
incremental = true
</code></pre></div>
<p>that means you don't get 8 or 16 CGUs, but 2 per source-module (I think?), which should be a lot higher still</p>



<a name="251080762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080762">(Aug 28 2021 at 20:39)</a>:</h4>
<p>these might really all be because of <code>&amp;RootDatabase -&gt; &amp;dyn OtherDatabase</code> conversions and duplication of <code>salsa::Storage&lt;RootDatabase&gt;</code> drop glue, which might happen in the majority of CGUs here</p>



<a name="251080888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080888">(Aug 28 2021 at 20:41)</a>:</h4>
<p><code>incremental</code> doesn't change the lines, sadly</p>



<a name="251080945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251080945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251080945">(Aug 28 2021 at 20:42)</a>:</h4>
<p>huh, that is weird</p>



<a name="251081003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081003">(Aug 28 2021 at 20:44)</a>:</h4>
<p>Would it be an idea to have the <code>&amp;RootDatabase -&gt; &amp;dyn OtherDatabases</code> cast inside a non-<code>#[inline]</code> function that is called everywhere?</p>



<a name="251081104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081104">(Aug 28 2021 at 20:45)</a>:</h4>
<p>Aka, non-virtual-interface pattern. I think this might work, and even probably would be a good idea, but I don't see a way to quickly code it up -- we have coercions to dyn everywhere <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="251081591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081591">(Aug 28 2021 at 20:54)</a>:</h4>
<p>I also find all of these <code>Weak::drop</code> calls interesting, where do we use <code>Weak</code>?</p>



<a name="251081729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081729">(Aug 28 2021 at 20:57)</a>:</h4>
<p>wow, it really is all those conversions</p>



<a name="251081755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081755">(Aug 28 2021 at 20:57)</a>:</h4>
<p>using <code>ManuallyDrop</code> in <code>RootDatabase</code> and implementing <code>Drop</code> by hand and we go from 535434 lines in ide_ssr to 295787</p>



<a name="251081828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081828">(Aug 28 2021 at 20:58)</a>:</h4>
<p><span aria-label="weary" class="emoji emoji-1f629" role="img" title="weary">:weary:</span> </p>
<p>Every time I set up to write "... and here's how not to hate Rust build times ", I fall down one of these rabbit holes...</p>



<a name="251081847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081847">(Aug 28 2021 at 20:59)</a>:</h4>
<p><span class="user-mention" data-user-id="211727">@Jonas Schievink  [he/him]</span> that's genious!</p>



<a name="251081872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081872">(Aug 28 2021 at 20:59)</a>:</h4>
<p>rustc's compilation pipeline is incredibly... uh, "naive" I guess? all it does well is optimize to good code once LLVM spends hours chewing though it</p>



<a name="251081878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081878">(Aug 28 2021 at 21:00)</a>:</h4>
<p>Wait, how does that work? I thought that proc-macros add a whole bunch of fields, no? Ah, no, that lives in <code>salsa::Runtime</code></p>



<a name="251081929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081929">(Aug 28 2021 at 21:00)</a>:</h4>
<p><span aria-label="passenger ship" class="emoji emoji-1f6f3" role="img" title="passenger ship">:passenger_ship:</span> it</p>



<a name="251081936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081936">(Aug 28 2021 at 21:00)</a>:</h4>
<p>yeah, I checked the expansion</p>



<a name="251081968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251081968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251081968">(Aug 28 2021 at 21:00)</a>:</h4>
<p>it's just that single generic field that causes the blowup</p>



<a name="251082020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251082020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251082020">(Aug 28 2021 at 21:01)</a>:</h4>
<p>I'll open a PR shortly</p>



<a name="251082032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251082032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251082032">(Aug 28 2021 at 21:01)</a>:</h4>
<p>kinda "bad" that we have to use unsafe code just to work around build time blowup, but whatevs</p>



<a name="251082471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251082471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251082471">(Aug 28 2021 at 21:09)</a>:</h4>
<p>opened <a href="https://github.com/rust-analyzer/rust-analyzer/pull/10069">https://github.com/rust-analyzer/rust-analyzer/pull/10069</a></p>



<a name="251083041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251083041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251083041">(Aug 28 2021 at 21:18)</a>:</h4>
<p>I wonder if something can be done by rustc</p>



<a name="251083064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251083064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251083064">(Aug 28 2021 at 21:19)</a>:</h4>
<p>E.g. calculate the cost of drop_in_place and determine if it's suitable to inlined</p>



<a name="251083159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251083159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251083159">(Aug 28 2021 at 21:20)</a>:</h4>
<p>also opened <a href="https://github.com/rust-lang/rust/issues/88438">https://github.com/rust-lang/rust/issues/88438</a> to hopefully bring some upstream attention to this problem</p>



<a name="251083286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251083286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251083286">(Aug 28 2021 at 21:23)</a>:</h4>
<p>I wounder if we should maybe put <code>MaybeUninit</code> hack into salsa?</p>



<a name="251124407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251124407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251124407">(Aug 29 2021 at 10:53)</a>:</h4>
<p>Is there a standard format for call graphs? I want to take llmv IR and spit out a file such that I can quicly navigatecall-chains</p>



<a name="251124417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251124417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251124417">(Aug 29 2021 at 10:53)</a>:</h4>
<p>It looks like most of <code>ide_ssr</code> is actually chalk</p>



<a name="251124437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251124437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251124437">(Aug 29 2021 at 10:53)</a>:</h4>
<p>at the moment, I am ctrl+F in the .ll file, but I could use a better tool</p>



<a name="251129426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251129426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251129426">(Aug 29 2021 at 12:27)</a>:</h4>
<p>not sure if <code>.dot</code> has better tools, but it looks like <a href="https://github.com/robinmoussu/cargo-callgraph">https://github.com/robinmoussu/cargo-callgraph</a> can output that</p>



<a name="251135398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135398">(Aug 29 2021 at 14:14)</a>:</h4>
<p>Looking more at the llmv ir for ide_ssr, I see thinkgs like</p>
<div class="codehilite"><pre><span></span><code>core::ptr::drop_in_place::&lt;chalk_ir::Substitution&lt;hir_ty::interner::Interner&gt;&gt;
</code></pre></div>
<p>in general, ide_ssr seems to cogeden a lot of chalk stuff, and that stuff causes 200+ instances of fold</p>



<a name="251135433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135433">(Aug 29 2021 at 14:15)</a>:</h4>
<p>I haven't traced this yet, but our interner infra is suspect -- the following is in the call tree:</p>
<div class="codehilite"><pre><span></span><code>&lt;&lt;once_cell::imp::OnceCell&lt;dashmap::DashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::TyData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, (), core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;&gt;&gt;::initialize&lt;&lt;once_cell::sync::OnceCell&lt;dashmap::DashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::TyData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, (), core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;&gt;&gt;::get_or_init&lt;&lt;dashmap::DashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::TyData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, (), core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt; as core::default::Default&gt;::default&gt;::{closure#0}, &lt;once_cell::sync::OnceCell&lt;_&gt;&gt;::get_or_init::Void&gt;::{closure#0} as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once::{shim:vtable#0}
</code></pre></div>



<a name="251135628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135628">(Aug 29 2021 at 14:19)</a>:</h4>
<p>yeah, it's all generic code too</p>



<a name="251135736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135736">(Aug 29 2021 at 14:21)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> it seem to bottom out in some sort of vtable as well</p>
<p>&lt;hir_ty::replace_errors_with_variables::ErrorReplacer as chalk_ir::fold::Folder&lt;hir_ty::interner::Interner&gt;&gt;::fold_goal</p>



<a name="251135743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135743">(Aug 29 2021 at 14:21)</a>:</h4>
<p>this thing is only used by some vtable</p>



<a name="251135800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135800">(Aug 29 2021 at 14:22)</a>:</h4>
<blockquote>
<p>yeah, it's all generic code too</p>
</blockquote>
<p>I think this generic code shouldn't escape beyond <code>hir</code> though</p>



<a name="251135977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251135977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251135977">(Aug 29 2021 at 14:25)</a>:</h4>
<p>Ideally yes, but beyond wrapping everything in non-generic functions or passing <code>-Zshare-generics</code> I don't think there's a way to do that</p>



<a name="251136051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251136051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251136051">(Aug 29 2021 at 14:26)</a>:</h4>
<p>But we <em>are</em> wrapping everything in non-generic functions</p>



<a name="251136057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251136057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251136057">(Aug 29 2021 at 14:27)</a>:</h4>
<p>Everything in <code>hir</code> is fully concrete I belive</p>



<a name="251136082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251136082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251136082">(Aug 29 2021 at 14:27)</a>:</h4>
<p>hmm, right</p>



<a name="251136158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251136158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251136158">(Aug 29 2021 at 14:28)</a>:</h4>
<p><code>-Zprint-mono-items</code> might help in your investigation</p>



<a name="251137031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251137031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251137031">(Aug 29 2021 at 14:44)</a>:</h4>
<div class="codehilite"><pre><span></span><code>&lt;ide_ssr::resolving::Resolver&gt;::resolve
&lt;ide_ssr::resolving::ResolutionScope&gt;::resolve_path
core::ptr::drop_in_place::&lt;hir::Type&gt;
core::ptr::drop_in_place::&lt;alloc::sync::Arc&lt;hir_ty::traits::TraitEnvironment&gt;&gt;
&lt;alloc::sync::Arc&lt;hir_ty::traits::TraitEnvironment&gt; as core::ops::drop::Drop&gt;::drop
&lt;alloc::sync::Arc&lt;hir_ty::traits::TraitEnvironment&gt;&gt;::drop_slow
core::ptr::drop_in_place::&lt;hir_ty::traits::TraitEnvironment&gt;
core::ptr::drop_in_place::&lt;chalk_ir::Environment&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::ProgramClauses&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;hir_def::intern::Interned&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;&gt;
&lt;hir_def::intern::Interned&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt; as core::ops::drop::Drop&gt;::drop
&lt;hir_def::intern::Interned&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;&gt;::drop_slow
&lt;std::collections::hash::map::HashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;&gt;::shrink_to_fit
&lt;hashbrown::map::HashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;&gt;::shrink_to_fit
&lt;hashbrown::raw::RawTable&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;&gt;::shrink_to::&lt;hashbrown::map::make_hasher&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;::{closure#0}&gt;
core::ptr::drop_in_place::&lt;hashbrown::raw::RawTable&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;&gt;
&lt;hashbrown::raw::RawTable&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt; as core::ops::drop::Drop&gt;::drop
&lt;hashbrown::raw::RawTable&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;&gt;::drop_elements
&lt;hashbrown::raw::Bucket&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;&gt;::drop
&lt;*mut (alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;::drop_in_place
core::ptr::drop_in_place::&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;
core::ptr::drop_in_place::&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;&gt;
&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt; as core::ops::drop::Drop&gt;::drop
&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;&gt;::drop_slow
core::ptr::drop_in_place::&lt;hir_ty::interner::InternedWrapper&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;
core::ptr::drop_in_place::&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;&gt;
&lt;alloc::vec::Vec&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt; as core::ops::drop::Drop&gt;::drop
core::ptr::drop_in_place::&lt;[chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;]&gt;
core::ptr::drop_in_place::&lt;chalk_ir::ProgramClause&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::ProgramClauseData&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::Binders&lt;chalk_ir::ProgramClauseImplication&lt;hir_ty::interner::Interner&gt;&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::ProgramClauseImplication&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::Constraints&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;alloc::vec::Vec&lt;chalk_ir::InEnvironment&lt;chalk_ir::Constraint&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;
&lt;alloc::vec::Vec&lt;chalk_ir::InEnvironment&lt;chalk_ir::Constraint&lt;hir_ty::interner::Interner&gt;&gt;&gt; as core::ops::drop::Drop&gt;::drop
core::ptr::drop_in_place::&lt;[chalk_ir::InEnvironment&lt;chalk_ir::Constraint&lt;hir_ty::interner::Interner&gt;&gt;]&gt;
core::ptr::drop_in_place::&lt;chalk_ir::InEnvironment&lt;chalk_ir::Constraint&lt;hir_ty::interner::Interner&gt;&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::Constraint&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;chalk_ir::Lifetime&lt;hir_ty::interner::Interner&gt;&gt;
core::ptr::drop_in_place::&lt;hir_def::intern::Interned&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;
&lt;hir_def::intern::Interned&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt; as core::ops::drop::Drop&gt;::drop
&lt;hir_def::intern::Interned&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;&gt;::drop_slow
&lt;std::collections::hash::map::HashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;&gt;::shrink_to_fit
&lt;hashbrown::map::HashMap&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;&gt;::shrink_to_fit
&lt;hashbrown::raw::RawTable&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;&gt;::shrink_to::&lt;hashbrown::map::make_hasher&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;::{closure#0}&gt;
&lt;hashbrown::raw::RawTable&lt;(alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;)&gt;&gt;::resize::&lt;hashbrown::map::make_hasher&lt;alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, alloc::sync::Arc&lt;hir_ty::interner::InternedWrapper&lt;chalk_ir::LifetimeData&lt;hir_ty::interner::Interner&gt;&gt;&gt;, dashmap::util::SharedValue&lt;()&gt;, core::hash::BuildHasherDefault&lt;rustc_hash::FxHasher&gt;&gt;::{closure#0}&gt;
</code></pre></div>



<a name="251137075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251137075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251137075">(Aug 29 2021 at 14:46)</a>:</h4>
<p>Aka, <code>core::ptr::drop_in_place::&lt;hir::Type&gt;</code> is (one) of the culprits here</p>



<a name="251137404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251137404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251137404">(Aug 29 2021 at 14:51)</a>:</h4>
<p>I smell an <code>outline_drop</code> crate coming that automates the <code>ManuallyDrop</code> hack</p>



<a name="251137636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251137636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251137636">(Aug 29 2021 at 14:55)</a>:</h4>
<p>Using proc macros to improve compile times!</p>



<a name="251138112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251138112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251138112">(Aug 29 2021 at 15:03)</a>:</h4>
<p>The second issue is that we have generic <code>iterate_method_candidates</code> methods on Ty. THey are generic in the closure, but they leak their body, which means that every crate ends up compileing the whole of chalk'd  fold infara</p>



<a name="251138173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251138173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251138173">(Aug 29 2021 at 15:04)</a>:</h4>
<p>I am not a big fan of generic folders. Having read 70 megs of LLVM IR with them, I must say I am even more not a fan of them now</p>



<a name="251142520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142520">(Aug 29 2021 at 16:24)</a>:</h4>
<p>Heh, it's even worse than outline_drop</p>



<a name="251142522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142522">(Aug 29 2021 at 16:24)</a>:</h4>
<p><a href="https://github.com/rust-analyzer/rust-analyzer/blob/d15f646ff17e2da0d4e8dc2754ba83213cf1a8bb/crates/hir/src/lib.rs#L2500-L2510">https://github.com/rust-analyzer/rust-analyzer/blob/d15f646ff17e2da0d4e8dc2754ba83213cf1a8bb/crates/hir/src/lib.rs#L2500-L2510</a></p>



<a name="251142535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142535">(Aug 29 2021 at 16:24)</a>:</h4>
<p>Here, we return an <code>impl Iterator</code>, which internally stores <code>Ty</code></p>



<a name="251142642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142642">(Aug 29 2021 at 16:26)</a>:</h4>
<p><code>Box&lt;dyn Iterator&gt;</code> it is?</p>



<a name="251142648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142648">(Aug 29 2021 at 16:26)</a>:</h4>
<p>And drop of that <code>Ty</code> produces measurable bloat</p>
<div class="codehilite"><pre><span></span><code>before
after
  241007 (100%)  10644 (100%)  (TOTAL)
    4498 (1.9%)     36 (0.3%)  core::iter::traits::iterator::Iterator::try_fold
  261799 (100%)  11670 (100%)  (TOTAL)
    5239 (2.0%)     42 (0.4%)  core::iter::traits::iterator::Iterator::try_fold
</code></pre></div>
<p>There are six folds in one drop</p>



<a name="251142694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142694">(Aug 29 2021 at 16:27)</a>:</h4>
<p>I don't think this helps -- its return postition impl trait, its already monomorphic</p>



<a name="251142709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142709">(Aug 29 2021 at 16:27)</a>:</h4>
<p>and drop for <code>Box&lt;dyn Trait&gt;</code> I belive is codegened in the caller?</p>



<a name="251142776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142776">(Aug 29 2021 at 16:28)</a>:</h4>
<p>wait, no, it <strong>is</strong> codegened into the calle with Box, and does help!</p>



<a name="251142790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251142790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251142790">(Aug 29 2021 at 16:28)</a>:</h4>
<p>it's codegen'd into the code that casts to the trait object</p>



<a name="251189257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251189257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251189257">(Aug 30 2021 at 06:39)</a>:</h4>
<p>Unfortunately, these build time optimizations don't show up on CI, which keeps getting slower and slower.</p>



<a name="251189454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251189454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251189454">(Aug 30 2021 at 06:42)</a>:</h4>
<p>Oh, we don't do caching there, do we?</p>



<a name="251191606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251191606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251191606">(Aug 30 2021 at 07:12)</a>:</h4>
<p>we do use caching</p>



<a name="251191637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251191637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matklad <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251191637">(Aug 30 2021 at 07:12)</a>:</h4>
<p>But we use debug builds for CI, and debugs runs with -Zshare-generics effectively</p>



<a name="251191641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/185405-t-compiler/rust-analyzer/topic/Dropping%20arcs/near/251191641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/185405-t-compiler/rust-analyzer/topic/Dropping.20arcs.html#251191641">(Aug 30 2021 at 07:12)</a>:</h4>
<p>Not in the metrics workflow, but that's probably fine.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>