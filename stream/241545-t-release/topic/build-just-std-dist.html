<html>
<head><meta charset="utf-8"><title>build-just-std-dist · t-release · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/index.html">t-release</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html">build-just-std-dist</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273543794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/273543794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#273543794">(Feb 28 2022 at 19:49)</a>:</h4>
<p>Hey folks! I don't know if this is quite the right place to ask this, but it felt like the closest match. I'm doing some work to replicate the Rust release process (that is, building the various artifacts that go in the release manifest from source), and am trying to figure out if there's a "standard" way to build _just_ <code>rust-std-$version-$target.tar.*</code> if I already have <code>rustc-$version-$host</code>. I _think_ it's going to look something like what upstream does in <a href="https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src/ci/docker/host-x86_64/dist-various-1/Dockerfile#L185-L187">this Dockerfile</a>, but wanted to see if there are any other magical incantations needed.</p>



<a name="273544272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/273544272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#273544272">(Feb 28 2022 at 19:53)</a>:</h4>
<p>so you already have that <code>rustc-$version-$host</code> outside the current build? then something like <code>./configure --local-rust-root=/that</code>, <code>./x.py dist --stage 0 --target $target rust-std</code></p>



<a name="273544361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/273544361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#273544361">(Feb 28 2022 at 19:53)</a>:</h4>
<p>the Dockerfile you quoted will still build the implicit <code>--build</code> toolchain locally</p>



<a name="274721569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274721569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274721569">(Mar 09 2022 at 17:23)</a>:</h4>
<p>Ah, interesting, I didn't realize <code>--stage 0</code> would work for this case — that's a good call. Should <code>local-rebuild</code> be enabled too?</p>



<a name="274748471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274748471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274748471">(Mar 09 2022 at 20:33)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> It looks like that's broken somehow: &lt;<a href="https://github.com/rust-lang/rust/issues/94781">https://github.com/rust-lang/rust/issues/94781</a>&gt;</p>



<a name="274748860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274748860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274748860">(Mar 09 2022 at 20:37)</a>:</h4>
<p>oh weird, it built <code>std</code> fine, but <code>fabricate</code> (rust-installer) failed</p>



<a name="274749003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274749003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274749003">(Mar 09 2022 at 20:38)</a>:</h4>
<p><code>local-rebuild</code> should be inferred automatically</p>



<a name="274749112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274749112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274749112">(Mar 09 2022 at 20:39)</a>:</h4>
<p>does it work in your setup if you don't force the stage? (letting it build the toolchain normally)</p>



<a name="274762282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274762282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274762282">(Mar 09 2022 at 22:30)</a>:</h4>
<p>It starts building LLVM — I'll let you know how that goes once I find a newer CMake version <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> <br>
I tried <code>download-ci-llvm = true</code>, but that hits</p>
<div class="codehilite"><pre><span></span><code>$ ./configure --enable-local-rust --enable-local-rebuild --set llvm.download-ci-llvm=true
configure: processing command line
configure:
configure: build.rustc          := /home/jongje/.cargo/bin//rustc
configure: build.cargo          := /home/jongje/.cargo/bin//cargo
configure: build.local-rebuild  := True
configure: llvm.download-ci-llvm := True
configure: build.configure-args := [&#39;--enable-local-rust&#39;, &#39;--enable-local-rebuil ...
configure:
configure: writing `config.toml` in current directory
configure:
configure: run `python /local/home/jongje/rustc-1.59.0-src/x.py --help`
configure:
$ ./x.py dist rust-std
fatal: not a git repository (or any of the parent directories): .git
Traceback (most recent call last):
  File &quot;./x.py&quot;, line 27, in &lt;module&gt;
    bootstrap.main()
  File &quot;/local/home/jongje/rustc-1.59.0-src/src/bootstrap/bootstrap.py&quot;, line 1313, in main
    bootstrap(help_triggered)
  File &quot;/local/home/jongje/rustc-1.59.0-src/src/bootstrap/bootstrap.py&quot;, line 1279, in bootstrap
    build.download_toolchain()
  File &quot;/local/home/jongje/rustc-1.59.0-src/src/bootstrap/bootstrap.py&quot;, line 507, in download_toolchain
    &quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;,
  File &quot;/usr/lib64/python3.7/subprocess.py&quot;, line 411, in check_output
    **kwargs).stdout
  File &quot;/usr/lib64/python3.7/subprocess.py&quot;, line 512, in run
    output=stdout, stderr=stderr)
subprocess.CalledProcessError: Command &#39;[&#39;git&#39;, &#39;rev-parse&#39;, &#39;--show-toplevel&#39;]&#39; returned non-zero exit status 128.
</code></pre></div>



<a name="274771330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274771330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274771330">(Mar 10 2022 at 00:02)</a>:</h4>
<p>Without <code>--stage 0</code> it fails in the same place (though this time for <code>core</code>, not <code>std</code>): &lt;<a href="https://github.com/rust-lang/rust/issues/94781#issuecomment-1063500462">https://github.com/rust-lang/rust/issues/94781#issuecomment-1063500462</a>&gt;</p>



<a name="274808179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274808179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274808179">(Mar 10 2022 at 09:15)</a>:</h4>
<p>i think download-ci-llvm needs the git repo checked out to find the right commit to download llvm for.</p>



<a name="274849312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274849312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274849312">(Mar 10 2022 at 15:21)</a>:</h4>
<p>Yeah, I think I've run into that in the past. Although it'd be nice if it _also_ worked for release src downloads using something like &lt;<a href="https://github.com/rust-lang/rust/blob/master/src/bootstrap/download-ci-llvm-stamp">https://github.com/rust-lang/rust/blob/master/src/bootstrap/download-ci-llvm-stamp</a>&gt; or some other file that was included in <code>rustc-src</code> that allowed it to find the right commit to fetch without git for that specific (but common) instance.</p>



<a name="274849988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274849988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274849988">(Mar 10 2022 at 15:26)</a>:</h4>
<p>I'd be fine taking a PR, probably. But I'm not sure we copy the LLVM files used for this to <a href="http://static.rust-lang.org">static.rust-lang.org</a> for nightlies etc, and in any case don't track which nightly they would end up in, which means that after ~168 days at best you're going to not work anyway.</p>



<a name="274857438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274857438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274857438">(Mar 10 2022 at 16:13)</a>:</h4>
<p>Yeah, that's true, but 168 days is 24 weeks, which is 4 release cycles, so I feel like in practice that'd turn out okay.</p>



<a name="274861657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/274861657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#274861657">(Mar 10 2022 at 16:42)</a>:</h4>
<p>Yeah, I mean, obviously depends on the use case :)</p>



<a name="275016638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/275016638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#275016638">(Mar 11 2022 at 18:51)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> Another issue I just discovered with building <code>rust-std</code> using <code>--stage 0</code> is that it ends up not hitting &lt;<a href="https://github.com/rust-lang/rust/blob/af8604faddc44b27a59d1a719ff6ceca8bc145eb/src/bootstrap/compile.rs#L333-L343">https://github.com/rust-lang/rust/blob/af8604faddc44b27a59d1a719ff6ceca8bc145eb/src/bootstrap/compile.rs#L333-L343</a>&gt;, and thus not having bitcode embedded.</p>



<a name="275016668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/275016668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#275016668">(Mar 11 2022 at 18:51)</a>:</h4>
<p>Any idea how I might be able to hack around that?</p>



<a name="275018613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/275018613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#275018613">(Mar 11 2022 at 19:01)</a>:</h4>
<p>I'd file an issue, but reading the comment it _seems_ intentional. It also makes me worry that <code>dist --stage 0 rust-std</code> is not actually "the right" way to build _just_ <code>rust-std</code> and may run into other corner cases.. But if it's not, I don't know what is.</p>



<a name="275039754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/275039754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#275039754">(Mar 11 2022 at 22:02)</a>:</h4>
<p>Good catch! I think there is no "right" way to do this, really, because you're treading new ground. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="275039819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/275039819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#275039819">(Mar 11 2022 at 22:03)</a>:</h4>
<p>(yet)</p>



<a name="275042609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/build-just-std-dist/near/275042609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/build-just-std-dist.html#275042609">(Mar 11 2022 at 22:22)</a>:</h4>
<p>Hehe, fair enough. I guess the obvious next question then is what _should_ be the right way to do this? Do we want to "embrace" <code>--stage 0 rust-std</code> with <code>local-rebuild</code>, or do something else?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>