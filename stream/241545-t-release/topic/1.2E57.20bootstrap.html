<html>
<head><meta charset="utf-8"><title>1.57 bootstrap · t-release · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/index.html">t-release</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html">1.57 bootstrap</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258473110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258473110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258473110">(Oct 21 2021 at 01:32)</a>:</h4>
<p>@pietroalbini I tried poking at <a href="https://github.com/rust-lang/rust/issues/90042">#90042</a> to try to figure out the CI error. I was able to reproduce inside the Docker image, but no matter what I did, I couldn't reproduce outside of it (even using the exact same config.toml).</p>
<p>Some other notes:</p>
<ul>
<li>I tried applying <a href="https://github.com/rust-lang/rust/issues/90062">#90062</a> (update to llvm 11/ubuntu 20), but that did not help.</li>
<li>The disassembly of the <code>test_copy_within</code> test looks very wrong (compared to a working version).</li>
</ul>
<p>I might keep trying to mess with it off and on, but thought I'd share what I found so far. It is quite a puzzle!</p>



<a name="258473572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258473572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258473572">(Oct 21 2021 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> did we apply the fix for <a href="https://github.com/rust-lang/rust/issues/90038">https://github.com/rust-lang/rust/issues/90038</a> to bootstrap and test with that yet?</p>



<a name="258473628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258473628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258473628">(Oct 21 2021 at 01:38)</a>:</h4>
<p>that's the most obvious recent miscompilation</p>



<a name="258473948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258473948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258473948">(Oct 21 2021 at 01:42)</a>:</h4>
<p>I'll wait for a beta backport rollup to pickup <a href="https://github.com/rust-lang/rust/pull/90072">https://github.com/rust-lang/rust/pull/90072</a> as well since it seems important</p>



<a name="258473959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258473959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258473959">(Oct 21 2021 at 01:42)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="121055">@Pietro Albini</span> btw, since the earlier ping did not go through</p>



<a name="258474229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258474229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258474229">(Oct 21 2021 at 01:46)</a>:</h4>
<p>No, but that seems like a good candidate.  I can try it later tonight.</p>



<a name="258474437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258474437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258474437">(Oct 21 2021 at 01:49)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/86525">https://github.com/rust-lang/rust/pull/86525</a> also seems <em>possible</em>, I guess</p>
<p>These are stage1 tests so they <em>shouldn't</em> in theory be different depending on the bootstrap compiler</p>



<a name="258474620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258474620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258474620">(Oct 21 2021 at 01:51)</a>:</h4>
<p>Pushed a rebase</p>



<a name="258478648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258478648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258478648">(Oct 21 2021 at 02:42)</a>:</h4>
<p>Narrowed down to the following after an x.py build producing a failing coretests binary</p>
<div class="codehilite"><pre><span></span><code>LD_LIBRARY_PATH=&quot;obj/build/x86_64-unknown-linux-gnu/stage1/lib:obj/build/x86_64-unknown-linux-gnu/stage1-std/release/deps:obj/build/x86_64-unknown-linux-gnu/stage0/lib:obj/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;obj/build/x86_64-unknown-linux-gnu/stage1/bin/rustc&quot; &quot;--crate-name&quot; &quot;coretests&quot; &quot;--edition=2018&quot; &quot;library/core/tests/lib.rs&quot; &quot;-C&quot; &quot;opt-level=3&quot; &quot;-C&quot; &quot;codegen-units=1&quot; &quot;--test&quot; &quot;-C&quot; &quot;extra-filename=-3d1f5816ac8cc923&quot; &quot;--target&quot; &quot;x86_64-unknown-linux-gnu&quot; &quot;-L&quot; &quot;dependency=obj/build/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps&quot; &quot;-L&quot; &quot;dependency=obj/build/x86_64-unknown-linux-gnu/stage1-std/release/deps&quot; &quot;--extern&quot; &quot;core=obj/build/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps/libcore-0286f51ede2a0cbe.rlib&quot; &quot;--sysroot&quot; &quot;obj/build/x86_64-unknown-linux-gnu/stage1&quot;
</code></pre></div>



<a name="258479463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258479463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258479463">(Oct 21 2021 at 02:54)</a>:</h4>
<div class="codehilite"><pre><span></span><code>fn main() {
    // Start to end, with a RangeTo.
    let mut bytes = *b&quot;Hello, World!&quot;;
    bytes.copy_within(..3, 10);

    assert_eq!(bytes, [72, 101, 108, 108, 111, 44, 32, 87, 111, 114, 72, 101, 108]);
}
</code></pre></div>
<p>compiled with a stage1/bin/rustc produced in docker (<code>LD_LIBRARY_PATH="obj/build/x86_64-unknown-linux-gnu/stage1/lib:obj/build/x86_64-unknown-linux-gnu/stage1-std/release/deps:obj/build/x86_64-unknown-linux-gnu/stage0/lib:obj/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib" "obj/build/x86_64-unknown-linux-gnu/stage1/bin/rustc" "--crate-name" "coretests" "library/core/tests/lib.rs" "-C" "opt-level=3" "-C" "codegen-units=1" "-C" "extra-filename=-3d1f5816ac8cc923" "--target" "x86_64-unknown-linux-gnu" "-L" "dependency=obj/build/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps" "-L" "dependency=obj/build/x86_64-unknown-linux-gnu/stage1-std/release/deps" "--extern" "core=obj/build/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps/libcore-0286f51ede2a0cbe.rlib" "--sysroot" "obj/build/x86_64-unknown-linux-gnu/stage1" --emit=link,mir,llvm-ir</code>) is faulty</p>



<a name="258479568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258479568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258479568">(Oct 21 2021 at 02:55)</a>:</h4>
<p>opt-level=1 does not reproduce, opt-level=2 does</p>



<a name="258480456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258480456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258480456">(Oct 21 2021 at 03:06)</a>:</h4>
<p>opt-bisect-limit seems to show the problem is in BISECT: running pass (1883) Global Value Numbering on function (_ZN9coretests4main17h1267663163b17fd4E)</p>



<a name="258480895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258480895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258480895">(Oct 21 2021 at 03:12)</a>:</h4>
<p>including <a href="https://github.com/rust-lang/rust/issues/90040">#90040</a> in the bootstrap compiler didn't help.  I'm a bit confused how an issue with the bootstrap compiler could carry into a stage2 build.</p>



<a name="258481042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481042">(Oct 21 2021 at 03:14)</a>:</h4>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="p">***</span> <span class="err">IR</span> <span class="err">Dump</span> <span class="err">Before</span> <span class="err">Global</span> <span class="err">Value</span> <span class="err">Numbering</span> <span class="p">***</span>
<span class="c">; Function Attrs: nonlazybind uwtable</span>
<span class="k">define</span> <span class="k">internal</span> <span class="k">void</span> <span class="vg">@_ZN9coretests4main17h1267663163b17fd4E</span><span class="p">()</span> <span class="k">unnamed_addr</span> <span class="vg">#1</span> <span class="k">personality</span> <span class="kt">i32</span> <span class="p">(</span><span class="kt">i32</span><span class="p">,</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i64</span><span class="p">,</span> <span class="nv">%"unwind::libunwind::_Unwind_Exception"</span><span class="p">*,</span> <span class="nv">%"unwind::libunwind::_Unwind_Context"</span><span class="p">*)*</span> <span class="vg">@rust_eh_personality</span> <span class="p">{</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">alloca</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.lifetime.start.p0i8</span><span class="p">(</span><span class="kt">i64</span> <span class="m">13</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="nv nv-Anonymous">%3</span><span class="p">)</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.memcpy.p0i8.p0i8.i64</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">8</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="nv nv-Anonymous">%3</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">(&lt;{</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;,</span> <span class="p">&lt;{</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;*</span> <span class="vg">@6</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">),</span> <span class="kt">i64</span> <span class="m">13</span><span class="p">,</span> <span class="kt">i1</span> <span class="k">false</span><span class="p">)</span>
  <span class="nv nv-Anonymous">%4</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span>
  <span class="nv nv-Anonymous">%5</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">10</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.memcpy.p0i8.p0i8.i64</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">2</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">3</span><span class="p">)</span> <span class="nv nv-Anonymous">%5</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">8</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">3</span><span class="p">)</span> <span class="nv nv-Anonymous">%4</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">3</span><span class="p">,</span> <span class="kt">i1</span> <span class="k">false</span><span class="p">)</span> <span class="vg">#10</span>
  <span class="nv nv-Anonymous">%6</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span> <span class="k">to</span> <span class="kt">i104</span><span class="p">*</span>
  <span class="nv nv-Anonymous">%7</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i104</span><span class="p">,</span> <span class="kt">i104</span><span class="p">*</span> <span class="nv nv-Anonymous">%6</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span><span class="p">,</span> <span class="nv">!alias.scope</span> <span class="nv nv-Anonymous">!19</span>
  <span class="nv nv-Anonymous">%8</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="kt">i104</span> <span class="nv nv-Anonymous">%7</span><span class="p">,</span> <span class="m">8587987120595162271403469464904</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%8</span><span class="p">,</span> <span class="kt">label</span> <span class="nv nv-Anonymous">%9</span><span class="p">,</span> <span class="kt">label</span> <span class="nv nv-Anonymous">%10</span>

<span class="nl">9:</span>                                                <span class="c">; preds = %0</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.lifetime.end.p0i8</span><span class="p">(</span><span class="kt">i64</span> <span class="m">13</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="nv nv-Anonymous">%3</span><span class="p">)</span>
  <span class="k">ret</span> <span class="k">void</span>

<span class="nl">10:</span>                                               <span class="c">; preds = %0</span>
  <span class="nv nv-Anonymous">%11</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">*</span> <span class="nv nv-Anonymous">%1</span> <span class="k">to</span> <span class="kt">i8</span><span class="p">*</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.lifetime.start.p0i8</span><span class="p">(</span><span class="kt">i64</span> <span class="m">48</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="nv nv-Anonymous">%11</span><span class="p">)</span>
  <span class="nv nv-Anonymous">%12</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">,</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">*</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span>
  <span class="k">store</span> <span class="p">{}*</span> <span class="k">null</span><span class="p">,</span> <span class="p">{}**</span> <span class="nv nv-Anonymous">%12</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="k">call</span> <span class="k">fastcc</span> <span class="k">void</span> <span class="vg">@_ZN4core9panicking13assert_failed17hb6d9722fa34cdf9fE</span><span class="p">([</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="k">noalias</span> <span class="k">nonnull</span> <span class="k">readonly</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">*</span> <span class="k">noalias</span> <span class="k">nocapture</span> <span class="k">nonnull</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">48</span><span class="p">)</span> <span class="nv nv-Anonymous">%1</span><span class="p">)</span> <span class="vg">#11</span>
  <span class="k">unreachable</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="p">***</span> <span class="err">IR</span> <span class="err">Dump</span> <span class="err">After</span> <span class="err">Global</span> <span class="err">Value</span> <span class="err">Numbering</span> <span class="p">***</span>
<span class="c">; Function Attrs: nonlazybind uwtable</span>
<span class="k">define</span> <span class="k">internal</span> <span class="k">void</span> <span class="vg">@_ZN9coretests4main17h1267663163b17fd4E</span><span class="p">()</span> <span class="k">unnamed_addr</span> <span class="vg">#1</span> <span class="k">personality</span> <span class="kt">i32</span> <span class="p">(</span><span class="kt">i32</span><span class="p">,</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">i64</span><span class="p">,</span> <span class="nv">%"unwind::libunwind::_Unwind_Exception"</span><span class="p">*,</span> <span class="nv">%"unwind::libunwind::_Unwind_Context"</span><span class="p">*)*</span> <span class="vg">@rust_eh_personality</span> <span class="p">{</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">alloca</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">alloca</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.lifetime.start.p0i8</span><span class="p">(</span><span class="kt">i64</span> <span class="m">13</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="nv nv-Anonymous">%3</span><span class="p">)</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.memcpy.p0i8.p0i8.i64</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">8</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="nv nv-Anonymous">%3</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">(&lt;{</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;,</span> <span class="p">&lt;{</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;*</span> <span class="vg">@6</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">),</span> <span class="kt">i64</span> <span class="m">13</span><span class="p">,</span> <span class="kt">i1</span> <span class="k">false</span><span class="p">)</span>
  <span class="nv nv-Anonymous">%4</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">],</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">10</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.memcpy.p0i8.p0i8.i64</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">2</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">3</span><span class="p">)</span> <span class="nv nv-Anonymous">%4</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="k">align</span> <span class="m">8</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">3</span><span class="p">)</span> <span class="nv nv-Anonymous">%3</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">3</span><span class="p">,</span> <span class="kt">i1</span> <span class="k">false</span><span class="p">)</span> <span class="vg">#10</span>
  <span class="nv nv-Anonymous">%5</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="p">[</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="nv nv-Anonymous">%2</span> <span class="k">to</span> <span class="kt">i104</span><span class="p">*</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="k">false</span><span class="p">,</span> <span class="kt">label</span> <span class="nv nv-Anonymous">%6</span><span class="p">,</span> <span class="kt">label</span> <span class="nv nv-Anonymous">%7</span>

<span class="nl">6:</span>                                                <span class="c">; preds = %0</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.lifetime.end.p0i8</span><span class="p">(</span><span class="kt">i64</span> <span class="m">13</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="nv nv-Anonymous">%3</span><span class="p">)</span>
  <span class="k">ret</span> <span class="k">void</span>

<span class="nl">7:</span>                                                <span class="c">; preds = %0</span>
  <span class="nv nv-Anonymous">%8</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">*</span> <span class="nv nv-Anonymous">%1</span> <span class="k">to</span> <span class="kt">i8</span><span class="p">*</span>
  <span class="k">call</span> <span class="k">void</span> <span class="vg">@llvm.lifetime.start.p0i8</span><span class="p">(</span><span class="kt">i64</span> <span class="m">48</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">nonnull</span> <span class="nv nv-Anonymous">%8</span><span class="p">)</span>
  <span class="nv nv-Anonymous">%9</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">,</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">*</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span>
  <span class="k">store</span> <span class="p">{}*</span> <span class="k">null</span><span class="p">,</span> <span class="p">{}**</span> <span class="nv nv-Anonymous">%9</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="k">call</span> <span class="k">fastcc</span> <span class="k">void</span> <span class="vg">@_ZN4core9panicking13assert_failed17hb6d9722fa34cdf9fE</span><span class="p">([</span><span class="m">13</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="k">noalias</span> <span class="k">nonnull</span> <span class="k">readonly</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="nv">%"core::option::Option&lt;core::fmt::Arguments&gt;"</span><span class="p">*</span> <span class="k">noalias</span> <span class="k">nocapture</span> <span class="k">nonnull</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">48</span><span class="p">)</span> <span class="nv nv-Anonymous">%1</span><span class="p">)</span> <span class="vg">#11</span>
  <span class="k">unreachable</span>
<span class="p">}</span>
</code></pre></div>



<a name="258481055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481055">(Oct 21 2021 at 03:14)</a>:</h4>
<p>that's the LLVM IR for my simple main function, across the GVN pass</p>



<a name="258481115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481115">(Oct 21 2021 at 03:16)</a>:</h4>
<p>I think the 2nd memcpy is just broken? It looks like it stopped copying to the 10th index in the function if I'm reading this right</p>



<a name="258481163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481163">(Oct 21 2021 at 03:16)</a>:</h4>
<p>oh, no, wait</p>



<a name="258481188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481188">(Oct 21 2021 at 03:16)</a>:</h4>
<p>not that directly, but something has gone wrong in this pass I'm pretty sure</p>



<a name="258481207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481207">(Oct 21 2021 at 03:17)</a>:</h4>
<p>since before we had a br i1 %8 and now we have unconditional branch</p>



<a name="258481340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481340">(Oct 21 2021 at 03:19)</a>:</h4>
<p>FWIW, I tried with ubuntu's llvm-12 and that passed.</p>



<a name="258481444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481444">(Oct 21 2021 at 03:20)</a>:</h4>
<p>put up raw llvm ir here - <a href="https://gist.github.com/Mark-Simulacrum/748c985c3856a852df01eae58beb4d41">https://gist.github.com/Mark-Simulacrum/748c985c3856a852df01eae58beb4d41</a></p>



<a name="258481462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481462">(Oct 21 2021 at 03:20)</a>:</h4>
<p>before/after this pass specifically</p>



<a name="258481659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258481659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258481659">(Oct 21 2021 at 03:23)</a>:</h4>
<p>it sounds like it's probably llvm 10/11 are broken?</p>



<a name="258482461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258482461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258482461">(Oct 21 2021 at 03:35)</a>:</h4>
<p>i'm off for the night, but I think next steps are probably to ping wg-llvm on an issue with the IR I've provided and ask for help in reducing further</p>



<a name="258482703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258482703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258482703">(Oct 21 2021 at 03:38)</a>:</h4>
<p>a separate thread might be to try and figure out what change in 1.56 vs 1.57 caused this, by bisecting across rustc builds -- I might try to do this inside the docker (to get llvm 10 easily) tomorrow</p>



<a name="258487449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258487449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258487449">(Oct 21 2021 at 04:49)</a>:</h4>
<p>I'm still quite confused on what is happening, or why current master isn't failing.<br>
I'm able to reproduce on latest master (<a href="https://github.com/rust-lang/rust/commit/4626184cafa827e13cc7a71b183a704ee0ec5930">4626184cafa827e13cc7a71b183a704ee0ec5930</a>) without Docker on Ubuntu 20 with these steps from a fresh checkout:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># llvm-11 is installed with `apt install llvm-11-dev`</span>
<span class="c1"># Also fails with llvm-10, but not llvm-12</span>
./configure --llvm-root<span class="o">=</span>/usr/lib/llvm-11 --enable-llvm-link-shared
./x.py build library/std

cat <span class="s">&lt;&lt;EOF &gt;&gt; foo.rs</span>
<span class="s">fn main() {</span>
<span class="s">    let mut bytes = *b"Hello, World!";</span>
<span class="s">    bytes.copy_within(..3, 10);</span>
<span class="s">    assert_eq!(&amp;bytes, b"Hello, WorHel");</span>
<span class="s">}</span>
<span class="s">EOF</span>

./build/x86_64-unknown-linux-gnu/stage1/bin/rustc foo.rs -Copt-level<span class="o">=</span><span class="m">3</span> -Ccodegen-units<span class="o">=</span><span class="m">1</span>
./foo
</code></pre></div>
<p>So that rules out anything specific about the bootstrap bump.</p>



<a name="258530679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258530679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258530679">(Oct 21 2021 at 11:51)</a>:</h4>
<p>That's quite helpful, thanks, will speed up iteration cycle at least</p>



<a name="258530748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258530748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258530748">(Oct 21 2021 at 11:51)</a>:</h4>
<p>I agree that there doesn't seem to be an easy connection to why it started failing with the bootstrap bump yet</p>



<a name="258530893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258530893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258530893">(Oct 21 2021 at 11:52)</a>:</h4>
<p>(as an aside I did note we probably want to make the CGU=1 we set for std in CI not apply to --test compilations since that's not likely to be helpful)</p>



<a name="258548925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258548925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258548925">(Oct 21 2021 at 13:53)</a>:</h4>
<p>LLVM 11 has -Cllvm-args=-opt-bisect-limit=1953 for the simple <a href="http://foo.rs">foo.rs</a> to select GVN on the main function</p>



<a name="258550163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258550163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258550163">(Oct 21 2021 at 14:00)</a>:</h4>
<p>Are you manually going through different values for <code>-opt-bisect-limit</code> to find the offending pass, or is there some automated way?  I've never seen that option before.</p>



<a name="258550207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258550207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258550207">(Oct 21 2021 at 14:00)</a>:</h4>
<p>manually -- it's pretty fast to manually bisect</p>



<a name="258550246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258550246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258550246">(Oct 21 2021 at 14:01)</a>:</h4>
<p>it's still GVN with llvm 11 though so my guess is it's possible there's just a bug fix in llvm 12</p>



<a name="258550319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258550319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258550319">(Oct 21 2021 at 14:01)</a>:</h4>
<p>no clue still why we're not seeing on this matter on the llvm-10 docker builder on master, though</p>



<a name="258563517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258563517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258563517">(Oct 21 2021 at 15:11)</a>:</h4>
<p>omg, I figured out why the error started showing up in the bootstrap PR.</p>
<p>Cargo has changed how profiles are treated for tests.  The test profile now inherits the settings from dev/release profiles.  This means that <code>coretests</code> is now being built with <code>codegen-units=1</code> where previously it was not.  <code>codegen-units=1</code> is necessary to trigger the llvm miscompilation.</p>



<a name="258563719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258563719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258563719">(Oct 21 2021 at 15:12)</a>:</h4>
<p>I had that in the back of my mind this whole time, but for some reason didn't make the connection.</p>



<a name="258564233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258564233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258564233">(Oct 21 2021 at 15:15)</a>:</h4>
<p>I can't offhand think of an easy way to fix that. <span aria-label="big frown" class="emoji emoji-2639" role="img" title="big frown">:big_frown:</span></p>



<a name="258564563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258564563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258564563">(Oct 21 2021 at 15:17)</a>:</h4>
<p>hm</p>



<a name="258564590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258564590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258564590">(Oct 21 2021 at 15:17)</a>:</h4>
<p>can we explicitly not set it for now for the test profile</p>



<a name="258564644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258564644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258564644">(Oct 21 2021 at 15:17)</a>:</h4>
<p>obviously we still need to fix the underlying bug, though maybe it's not worth it and we should bump to llvm 12+ and give up</p>



<a name="258565597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258565597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258565597">(Oct 21 2021 at 15:23)</a>:</h4>
<p>I think changing the profile will trigger a full rebuild.  Profiles are now global, instead of using a mixture.</p>



<a name="258566458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258566458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258566458">(Oct 21 2021 at 15:28)</a>:</h4>
<p>hm :/</p>



<a name="258566460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258566460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258566460">(Oct 21 2021 at 15:28)</a>:</h4>
<p>ok</p>



<a name="258566946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258566946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258566946">(Oct 21 2021 at 15:31)</a>:</h4>
<p>I can think of a few hacks:</p>
<ul>
<li>Disable the test on this builder.</li>
<li>Add some hack to the rustc wrapper to strip codegen-units=1 when --test is present.</li>
<li>Switch to llvm-12.</li>
<li>Revert the profile changes.</li>
</ul>
<p>...none of those sound good. I'm having trouble thinking of anything clever.</p>



<a name="258567138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567138">(Oct 21 2021 at 15:32)</a>:</h4>
<p>hacking the rustc wrapper seems like the best <em>temporary</em> solution</p>



<a name="258567317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567317">(Oct 21 2021 at 15:33)</a>:</h4>
<p>but a miscompilation with an old LLVM is tricky -- we can't really fix it, per se, unless rustc can avoid that scenario</p>



<a name="258567370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567370">(Oct 21 2021 at 15:33)</a>:</h4>
<p>oi, github is picking a good time to go down.</p>



<a name="258567693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567693">(Oct 21 2021 at 15:35)</a>:</h4>
<p>It is true that we have a bunch of miscompiles and such not <em>uncommonly</em> with cgu=1</p>



<a name="258567717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567717">(Oct 21 2021 at 15:35)</a>:</h4>
<p>we can disable cgu=1 on the llvm-10/11 builder, maybe?</p>



<a name="258567763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567763">(Oct 21 2021 at 15:36)</a>:</h4>
<p>that seems not too complicated</p>



<a name="258567874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567874">(Oct 21 2021 at 15:36)</a>:</h4>
<p>Yea, that should be pretty easy.</p>



<a name="258567973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258567973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258567973">(Oct 21 2021 at 15:37)</a>:</h4>
<p>Another thing I wanted to note is that we should monitor the CI build times after the bootstrap bump to make sure there aren't major regressions.  I'm not sure if there's an easy way to do that, though.</p>



<a name="258568165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258568165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258568165">(Oct 21 2021 at 15:38)</a>:</h4>
<p>cgu=1 is currently unconditionally set in <code>src/ci/run.sh</code>, but there could easily be an opt-out env</p>



<a name="258576053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258576053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258576053">(Oct 21 2021 at 16:26)</a>:</h4>
<p>reduced llvm ir which miscompiles to ~200 lines so far - <a href="https://llvm.godbolt.org/z/GEo1WEGas">https://llvm.godbolt.org/z/GEo1WEGas</a></p>



<a name="258605781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258605781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258605781">(Oct 21 2021 at 19:46)</a>:</h4>
<p>I've run into another problem unrelated to the codegen-units thing.</p>
<p>In a fresh checkout of pietro's <code>1.56-master</code> branch, the following fails:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>./configure --enable-debug-assertions
./x.py <span class="nb">test</span> compiler/rustc_mir_dataflow
</code></pre></div>
<p>I'm not really sure where to start on that.  I'm going to take a break investigating for a while, but I might come back to this later.</p>



<a name="258607475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258607475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258607475">(Oct 21 2021 at 19:58)</a>:</h4>
<p><a href="https://llvm.godbolt.org/z/aavPbrzEe">https://llvm.godbolt.org/z/aavPbrzEe</a> -- even smaller</p>



<a name="258607543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258607543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258607543">(Oct 21 2021 at 19:59)</a>:</h4>
<p>I'm worried that we're going to get bugs more widespread than just in rustc with the cgu=1 thing, even on newer llvms</p>



<a name="258607563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258607563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258607563">(Oct 21 2021 at 19:59)</a>:</h4>
<p>maybe they've all been fixed though</p>



<a name="258607986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258607986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258607986">(Oct 21 2021 at 20:01)</a>:</h4>
<p>this particular bug seems definitely llvm-11 related, fixed on llvm 12 I think</p>



<a name="258608076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608076">(Oct 21 2021 at 20:02)</a>:</h4>
<p>with the reduction I'm fairly confident that there's nothing else causing noise and changing behavior</p>



<a name="258608099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608099">(Oct 21 2021 at 20:02)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> do you think it's still worth reporting upstream?</p>



<a name="258608141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608141">(Oct 21 2021 at 20:02)</a>:</h4>
<p>what exactly am I looking for in the output?</p>



<a name="258608211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608211">(Oct 21 2021 at 20:03)</a>:</h4>
<p>commenting call void @panic_fmt2(i8* %bytes_ptr) leads to different behavior</p>



<a name="258608250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608250">(Oct 21 2021 at 20:03)</a>:</h4>
<p>which (I think, unless I messed up) is nonsensical</p>



<a name="258608348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608348">(Oct 21 2021 at 20:03)</a>:</h4>
<p>that branch should be dead code</p>



<a name="258608463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608463">(Oct 21 2021 at 20:04)</a>:</h4>
<p>well, I added windows for 12 and 13 too, and they also change with that comment</p>



<a name="258608655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608655">(Oct 21 2021 at 20:05)</a>:</h4>
<p>yeah, but they optimize to ret i1 false</p>



<a name="258608676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608676">(Oct 21 2021 at 20:05)</a>:</h4>
<p>whereas llvm 11 optimizes to ret i1 true, basically</p>



<a name="258608815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258608815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258608815">(Oct 21 2021 at 20:06)</a>:</h4>
<p>like this? <a href="https://llvm.godbolt.org/z/Th366bMcx">https://llvm.godbolt.org/z/Th366bMcx</a> -- they all go to just <code>ret i1 false</code></p>



<a name="258609251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258609251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258609251">(Oct 21 2021 at 20:09)</a>:</h4>
<p>with the call present, 11 always returns <code>true</code> though, that's weird</p>



<a name="258609344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258609344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258609344">(Oct 21 2021 at 20:10)</a>:</h4>
<p>is that what you mean?</p>



<a name="258610305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258610305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258610305">(Oct 21 2021 at 20:16)</a>:</h4>
<p>yeah</p>



<a name="258610330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258610330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258610330">(Oct 21 2021 at 20:16)</a>:</h4>
<p>the call is important but it shouldn't be</p>



<a name="258620002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258620002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258620002">(Oct 21 2021 at 21:25)</a>:</h4>
<p>I'm wary that the call is still kept alive in newer versions too</p>



<a name="258620912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258620912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258620912">(Oct 21 2021 at 21:33)</a>:</h4>
<p>I think that's probably just pass ordering not running appropriately?</p>



<a name="258620943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258620943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258620943">(Oct 21 2021 at 21:34)</a>:</h4>
<p>Not sure if your "wary" -&gt; my code/assumption of miscompilation is wrong, or "seems like new versions also buggy"</p>



<a name="258621060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258621060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258621060">(Oct 21 2021 at 21:34)</a>:</h4>
<p>new versions look at least plausibly correct, hard to be sure</p>



<a name="258621068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258621068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258621068">(Oct 21 2021 at 21:34)</a>:</h4>
<p>maybe also buggy, or maybe lurking UB in the input</p>



<a name="258621135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258621135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258621135">(Oct 21 2021 at 21:35)</a>:</h4>
<p>In any case, it seems clear that llvm 11 is wrong</p>



<a name="258621188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258621188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258621188">(Oct 21 2021 at 21:36)</a>:</h4>
<p>(regardless of my reduction being correct)</p>



<a name="258627386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258627386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258627386">(Oct 21 2021 at 22:30)</a>:</h4>
<p>I'm trying a <code>git bisect</code> of LLVM</p>



<a name="258640846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258640846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258640846">(Oct 22 2021 at 00:51)</a>:</h4>
<p>bisect says it was commit <a href="https://github.com/llvm/llvm-project/commit/1ddb3a369f7ebdf738486cd60261c3143658c0e6">1ddb3a369f7ebdf738486cd60261c3143658c0e6</a>, <a href="https://reviews.llvm.org/D86815">D86815</a></p>



<a name="258641385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258641385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258641385">(Oct 22 2021 at 00:58)</a>:</h4>
<p><span class="user-mention" data-user-id="133224">@Nikita Popov</span> approved that change, maybe he can say how that was formerly broken on your IR</p>



<a name="258641409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258641409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258641409">(Oct 22 2021 at 00:58)</a>:</h4>
<p>it doesn't look like the memcpy is overlapping to me...</p>



<a name="258644391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258644391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258644391">(Oct 22 2021 at 01:32)</a>:</h4>
<p>Yeah, it shouldn't be.</p>



<a name="258644434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258644434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258644434">(Oct 22 2021 at 01:33)</a>:</h4>
<p>Is it potentially problematic to bump directly to llvm 12 as our baseline? I don't know how comfortable I feel claiming 11 compat when we clearly can't "even" bootstrap</p>



<a name="258652818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258652818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258652818">(Oct 22 2021 at 02:27)</a>:</h4>
<p>OK, I think I have a glimpse as to what is wrong with the rustc_mir_dataflow tests. This is also related to cargo now passing release profile flags to tests (in this case <code>-C debug-assertions</code>). The <a href="https://github.com/rust-lang/rust/blob/547a6ffee0cf4da9929a9e3d49546dc87d607735/compiler/rustc_mir_dataflow/src/framework/tests.rs#L13-L17"><code>mock_body</code></a> test seems to intentionally create a mir body with disconnected basic blocks. However, in <a href="https://github.com/rust-lang/rust/pull/74169">https://github.com/rust-lang/rust/pull/74169</a> an assertion was added to prevent API consumers from visiting those basic blocks by accident. So the assertion is triggering.</p>
<p>I'm obviously unfamiliar with all that code, so I don't know how to fix it. It could be temporarily <code>#[ignore]</code>d if need be.</p>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span>, let me know if it would be helpful to maybe track these problems via GitHub issues. I'm not sure if you want to handle all these issues yourself.</p>



<a name="258652880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258652880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258652880">(Oct 22 2021 at 02:27)</a>:</h4>
<p>yeah I just came to the same conclusion as well</p>



<a name="258653258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653258">(Oct 22 2021 at 02:29)</a>:</h4>
<p>I think an issue as the next step probably makes sense</p>



<a name="258653347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653347">(Oct 22 2021 at 02:29)</a>:</h4>
<p>(well, two, for LLVM 11 CGU=1 difficulties and for this Cargo debug asserts)</p>



<a name="258653497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653497">(Oct 22 2021 at 02:30)</a>:</h4>
<p>I think the fix we have in mind for CGU=1 is to disable setting that on the LLVM 10/11 builder, but I also want us to discuss going direct to LLVM 12 at tomorrow's  release team meeting or what other mitigations we should consider.</p>



<a name="258653548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653548">(Oct 22 2021 at 02:31)</a>:</h4>
<p>For debug asserts I think most people are probably not affected, but I am worried about how non-obvious this is without knowing about this change and understanding it more fully</p>



<a name="258653786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653786">(Oct 22 2021 at 02:34)</a>:</h4>
<p>ok, I'll open some issues.  I didn't really follow the discussion above about the specifics of the optimization issue, so you can fill out more details if you want.</p>



<a name="258653805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653805">(Oct 22 2021 at 02:35)</a>:</h4>
<p>Yeah, thanks. I think the specifics are not that important for making the decision</p>



<a name="258653822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653822">(Oct 22 2021 at 02:35)</a>:</h4>
<p>It's worth noting someone was running into a bunch of problems with our UI test suite when trying to set cgu=1 there, too, I think</p>



<a name="258653834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653834">(Oct 22 2021 at 02:35)</a>:</h4>
<p>So I'm kinda generally worried about the IR we're generating or LLVM bugs</p>



<a name="258653888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258653888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258653888">(Oct 22 2021 at 02:36)</a>:</h4>
<p>Something to discuss, at least; not clear how much we can do. I can try to find relevant links tomorrow.</p>



<a name="258654313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654313">(Oct 22 2021 at 02:43)</a>:</h4>
<p>put up a beta backport rollup as well - <a href="https://github.com/rust-lang/rust/pull/90151">https://github.com/rust-lang/rust/pull/90151</a> - so we can move forward with that hopefully</p>



<a name="258654335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654335">(Oct 22 2021 at 02:43)</a>:</h4>
<p>Ah, can you maybe include cargo in that?</p>



<a name="258654347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654347">(Oct 22 2021 at 02:43)</a>:</h4>
<p>There's a pretty important critical fix on the rust-1.57.0 branch.</p>



<a name="258654353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654353">(Oct 22 2021 at 02:43)</a>:</h4>
<p>ah, sure</p>



<a name="258654397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654397">(Oct 22 2021 at 02:44)</a>:</h4>
<p>Thank you! <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span></p>



<a name="258654643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654643">(Oct 22 2021 at 02:48)</a>:</h4>
<p>Done. I'll probably poke Pietro tomorrow and trigger a manual beta release so we can have artifacts there asap for crater and hopefully a bootstrap bump with some temporary patches in place</p>



<a name="258654859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258654859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258654859">(Oct 22 2021 at 02:51)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<p>Posted <a href="https://github.com/rust-lang/rust/issues/90152">#90152</a> and <a href="https://github.com/rust-lang/rust/issues/90153">#90153</a> to track the issues encountered above, feel free to edit them.</p>



<a name="258655060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258655060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258655060">(Oct 22 2021 at 02:54)</a>:</h4>
<p>Thanks, will do tomorrow</p>



<a name="258655102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258655102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258655102">(Oct 22 2021 at 02:55)</a>:</h4>
<p>Disabling those tests, I was able to get <code>x86_64-gnu-llvm-10</code> to successfully finish, so hopefully there aren't too many other problems that crop up.</p>



<a name="258709118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258709118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258709118">(Oct 22 2021 at 13:10)</a>:</h4>
<p>kicked off a manual beta release</p>



<a name="258748803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241545-t-release/topic/1.57%20bootstrap/near/258748803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/241545-t-release/topic/1.2E57.20bootstrap.html#258748803">(Oct 22 2021 at 17:57)</a>:</h4>
<p>I posted <a href="https://github.com/rust-lang/rust/issues/90175">#90175</a> to update the minimum to LLVM 12 instead</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>