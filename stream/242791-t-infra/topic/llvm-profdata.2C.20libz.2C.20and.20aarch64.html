<html>
<head><meta charset="utf-8"><title>llvm-profdata, libz, and aarch64 · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/llvm-profdata.2C.20libz.2C.20and.20aarch64.html">llvm-profdata, libz, and aarch64</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277311119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/llvm-profdata%2C%20libz%2C%20and%20aarch64/near/277311119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/llvm-profdata.2C.20libz.2C.20and.20aarch64.html#277311119">(Mar 31 2022 at 17:01)</a>:</h4>
<p>Hi folks! I'm not sure if this is quite the right place to ask this, but it was the best fit I could find. For... reasons, I'm working in an environment where I build rustc from source on aarch64 but am using llvm-tools-preview as installed through rustup. This has run me into an interesting issue where running the profraw files from source-based coverage through llvm-profdata gives me a lot of</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">profile</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">zlib</span><span class="w"> </span><span class="n">compression</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">built</span><span class="w"> </span><span class="n">without</span><span class="w"> </span><span class="n">zlib</span><span class="w"> </span><span class="n">support</span><span class="w"></span>
</code></pre></div>
<p>errors. From what I've been able to discern, this is happening because my from-source rustc, is built with libz support, but llvm-tools is built without. I also have the same situation on x86_64, but there everything works fine, which suggests that the x86_64 llvm-tools _is_ build with libz.</p>
<p>I _think_ the issue is that the aarch64 Dockerfile doesn't install libz whereas the x86_64 one does (compare <a href="https://github.com/rust-lang/rust/blob/03314912f1361af6b39383958b5aa1b4aed61c26/src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile#L35">https://github.com/rust-lang/rust/blob/03314912f1361af6b39383958b5aa1b4aed61c26/src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile#L35</a> and <a href="https://github.com/rust-lang/rust/blob/03314912f1361af6b39383958b5aa1b4aed61c26/src/ci/docker/host-aarch64/aarch64-gnu/Dockerfile#L3">https://github.com/rust-lang/rust/blob/03314912f1361af6b39383958b5aa1b4aed61c26/src/ci/docker/host-aarch64/aarch64-gnu/Dockerfile#L3</a>). Is this an oversight or an intentional decision?</p>



<a name="277349696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/llvm-profdata%2C%20libz%2C%20and%20aarch64/near/277349696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/llvm-profdata.2C.20libz.2C.20and.20aarch64.html#277349696">(Mar 31 2022 at 22:42)</a>:</h4>
<p>Pretty sure it's an oversight</p>



<a name="277349769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/llvm-profdata%2C%20libz%2C%20and%20aarch64/near/277349769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/llvm-profdata.2C.20libz.2C.20and.20aarch64.html#277349769">(Mar 31 2022 at 22:43)</a>:</h4>
<p>IIRC it's optional in llvm even when you ask for it or something like that, and we have a really bad story for "all our dist builds should do this"</p>



<a name="277352339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/llvm-profdata%2C%20libz%2C%20and%20aarch64/near/277352339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/llvm-profdata.2C.20libz.2C.20and.20aarch64.html#277352339">(Mar 31 2022 at 23:13)</a>:</h4>
<p>Oh, yeah, it's entirely optional in LLVM, but it does manifest in weird ways when we build with it on one platform but not others. Opened a PR fixing it + explaining a bit more what can go wrong: <a href="https://github.com/rust-lang/rust/pull/95545">https://github.com/rust-lang/rust/pull/95545</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>