<html>
<head><meta charset="utf-8"><title>what happened in july 2020? · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html">what happened in july 2020?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267975624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267975624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267975624">(Jan 14 2022 at 06:00)</a>:</h4>
<p>looking a the prs-merged graph, we used to be able to merge 4-5 PRs a day for a long time (kinda like nowadays), then there was a huge speedup in end of july 2020 where the numbers went up to 8-12 prs a day (!!) and since then it has been slowly degrading back to 5-6 prs a day.</p>
<p>Does anyone remember what happened in july back then and if we could so something  like that again? <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> </p>
<p><a href="/user_uploads/4715/i2qZwtcd-LQ_TiQKOx-Zpxmo/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/i2qZwtcd-LQ_TiQKOx-Zpxmo/image.png" title="image.png"><img src="/user_uploads/4715/i2qZwtcd-LQ_TiQKOx-Zpxmo/image.png"></a></div>



<a name="267983078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983078">(Jan 14 2022 at 08:17)</a>:</h4>
<p>iirc that was when we moved from travis to github actions</p>



<a name="267983518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983518">(Jan 14 2022 at 08:22)</a>:</h4>
<p>the easiest way to speed CI up right now would be to split the apple jobs into multiple ones</p>



<a name="267983608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983608">(Jan 14 2022 at 08:23)</a>:</h4>
<p>so for example create <code>n</code> actual jobs for the dist-x86_64-apple and only create <code>1/n</code> of the dist tarballs in each builder</p>



<a name="267983612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983612">(Jan 14 2022 at 08:23)</a>:</h4>
<p>or splitting tests</p>



<a name="267983613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983613">(Jan 14 2022 at 08:23)</a>:</h4>
<p>CI stores a CPU utilization logfile, right? maybe we should check if that got worse over time, some sequential bottelneck somewhere.</p>



<a name="267983686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983686">(Jan 14 2022 at 08:24)</a>:</h4>
<p>yeah, but like, there's no way the mac builders will be ever as fast as the x86_64 ones</p>



<a name="267983696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983696">(Jan 14 2022 at 08:24)</a>:</h4>
<p>they have 3 cores vs 8 cores</p>



<a name="267983717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983717">(Jan 14 2022 at 08:24)</a>:</h4>
<p>ouch</p>



<a name="267983738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983738">(Jan 14 2022 at 08:24)</a>:</h4>
<p>oh yeah <span class="user-mention" data-user-id="217864">@matthiaskrgr</span>, at some point the gha macos builders went from 4 cores to 3 cores</p>



<a name="267983748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267983748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267983748">(Jan 14 2022 at 08:24)</a>:</h4>
<p>which explains the recent drop</p>



<a name="267985258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267985258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267985258">(Jan 14 2022 at 08:40)</a>:</h4>
<p>anyway, what would help right now is someone trying to rebalance those tasks across multiple parallel builders</p>



<a name="267985287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267985287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267985287">(Jan 14 2022 at 08:41)</a>:</h4>
<p>last time I checked for the apple builders only an hour and something or so was spent building the host compiler</p>



<a name="267985303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267985303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267985303">(Jan 14 2022 at 08:41)</a>:</h4>
<p>all the rest of the things can be probably split in multiple jobs</p>



<a name="267986060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267986060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267986060">(Jan 14 2022 at 08:48)</a>:</h4>
<p>do we have some commits where this has been done in the past as cheatsheet?</p>



<a name="267986381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267986381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267986381">(Jan 14 2022 at 08:52)</a>:</h4>
<p>I don't think we have a split builder anywhere today</p>



<a name="267986386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267986386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267986386">(Jan 14 2022 at 08:52)</a>:</h4>
<p>we had a few in the past though</p>



<a name="267986490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267986490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267986490">(Jan 14 2022 at 08:53)</a>:</h4>
<p>I think a good plan would be to first try to identify <em>how</em> we could do the split</p>



<a name="267986503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267986503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267986503">(Jan 14 2022 at 08:53)</a>:</h4>
<p>aka which jobs should be split and which tasks should run in each job</p>



<a name="267986526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/267986526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#267986526">(Jan 14 2022 at 08:53)</a>:</h4>
<p>and then at monday's infra meeting we can decide how to best handle the split</p>



<a name="268000045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268000045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268000045">(Jan 14 2022 at 11:13)</a>:</h4>
<p>could cargo be taught to give priority boosts to crate-rustcs that are on the critical path? That'd require some some hint file based on previous timings to identify the critical path in advance.</p>



<a name="268002219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268002219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268002219">(Jan 14 2022 at 11:35)</a>:</h4>
<p>hmm what do you mean?</p>



<a name="268002278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268002278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268002278">(Jan 14 2022 at 11:36)</a>:</h4>
<p>different steps are not executed in parallel (while they might have internal parallelism)</p>



<a name="268002920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268002920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268002920">(Jan 14 2022 at 11:43)</a>:</h4>
<p>I mean the rustc instances spawned by cargo within a step, e.g. when building std or rustc. If macos runners are that cpu-starved then getting the crate order wrong might lead to the critical path taking longer than necessary because non-critical crates take up cpu time first</p>



<a name="268004349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004349">(Jan 14 2022 at 11:59)</a>:</h4>
<p>I think there are way easier wins</p>



<a name="268004439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004439">(Jan 14 2022 at 12:00)</a>:</h4>
<p><a href="/user_uploads/4715/4tudxgovFx-SclO3cnXZXVDg/dist-x86_64-apple.html">dist-x86_64-apple.html</a> this for example is the <code>dist-x86_64-apple</code> step</p>



<a name="268004564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004564">(Jan 14 2022 at 12:01)</a>:</h4>
<p>the "serial" (building stage1 + stage2) part ends at around 1.3hr</p>



<a name="268004638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004638">(Jan 14 2022 at 12:01)</a>:</h4>
<p>the remaining 1.7hr part could easily be split into three other builder, turning <code>dist-x86_64-apple</code> into a 2hr job</p>



<a name="268004760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004760">(Jan 14 2022 at 12:03)</a>:</h4>
<p>and same for all the other macos jobs (which have the same stage1+stage2 build at the start)</p>



<a name="268004934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004934">(Jan 14 2022 at 12:04)</a>:</h4>
<p>yeah, I guess that's easier. still, we're leaving 30% cpu time on the table. somewhat consistently somehow.</p>



<a name="268004999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268004999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268004999">(Jan 14 2022 at 12:05)</a>:</h4>
<p>I'm tempted to ask if it runs with -j2 on a 3 core machine.</p>



<a name="268005024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268005024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268005024">(Jan 14 2022 at 12:06)</a>:</h4>
<p>I don't think we configured that</p>



<a name="268005073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268005073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268005073">(Jan 14 2022 at 12:06)</a>:</h4>
<p>anyway, <a href="https://gist.github.com/pietroalbini/5be40788e4d7c8e44c06121b4da0b0ab">the script I used to generate that report</a></p>



<a name="268005428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268005428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268005428">(Jan 14 2022 at 12:10)</a>:</h4>
<p><a href="/user_uploads/4715/2rbLJCBRSs8lY0c4zGfXyg_g/dist-x86_64-apple.png">dist-x86_64-apple.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/2rbLJCBRSs8lY0c4zGfXyg_g/dist-x86_64-apple.png" title="dist-x86_64-apple.png"><img src="/user_uploads/4715/2rbLJCBRSs8lY0c4zGfXyg_g/dist-x86_64-apple.png"></a></div>



<a name="268005433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268005433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268005433">(Jan 14 2022 at 12:10)</a>:</h4>
<p>the graph is pretty suspicious though, I give you that</p>



<a name="268005935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268005935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268005935">(Jan 14 2022 at 12:17)</a>:</h4>
<p>I think it's worth to check what <code>num_cpus</code> thinks the thread count is. And if that reports 3 then run a small test program that burns CPU cycles on three threads for a few seconds and check the reported utilization on that.</p>



<a name="268012800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268012800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268012800">(Jan 14 2022 at 13:26)</a>:</h4>
<div class="message_inline_image"><a href="https://user-images.githubusercontent.com/5047365/148451942-3c38d235-26f5-41ee-a20e-2b40c74260c9.png"><img src="https://uploads.zulipusercontent.net/3f388888ce47408ac5951f0fc22c81f9a433237a/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f353034373336352f3134383435313934322d33633338643233352d323666352d343165652d613230652d3262343063373432363063392e706e67"></a></div>



<a name="268012861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268012861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268012861">(Jan 14 2022 at 13:27)</a>:</h4>
<p>Those are the graphs for apple builders over the last several months, sourced precisely from those cpu utilization files</p>



<a name="268012895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268012895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268012895">(Jan 14 2022 at 13:27)</a>:</h4>
<p><a href="https://user-images.githubusercontent.com/5047365/148460936-776b85ea-5b59-439a-8bd7-d1cec906ab4e.png">https://user-images.githubusercontent.com/5047365/148460936-776b85ea-5b59-439a-8bd7-d1cec906ab4e.png</a> for comparison with a Linux builder included</p>
<div class="message_inline_image"><a href="https://user-images.githubusercontent.com/5047365/148460936-776b85ea-5b59-439a-8bd7-d1cec906ab4e.png"><img src="https://uploads.zulipusercontent.net/0df3dc0036867219eaa0ca3b253d1c03e27d28ae/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f353034373336352f3134383436303933362d37373662383565612d356235392d343339612d386264372d6431636563393036616234652e706e67"></a></div>



<a name="268013949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268013949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268013949">(Jan 14 2022 at 13:36)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> <a href="https://github.com/rust-lang/cargo/issues/7396">https://github.com/rust-lang/cargo/issues/7396</a></p>



<a name="268015339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268015339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268015339">(Jan 14 2022 at 13:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> huh... what's that jump on the linux runner?<br>
osx utilization being higher makes sense if it has fewer cores. at least I'm not seeing any big negatively correlated events where build time went up because utilization got worse.</p>



<a name="268015487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268015487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268015487">(Jan 14 2022 at 13:48)</a>:</h4>
<p>The jump is us starting to build llvm twice(?), for every build, because sccache doesn't support the pgo options yet.</p>



<a name="268015590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268015590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268015590">(Jan 14 2022 at 13:49)</a>:</h4>
<p>Maybe once. Not sure.</p>



<a name="268017322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268017322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268017322">(Jan 14 2022 at 14:04)</a>:</h4>
<p>So the averages don't change all that much over time, maybe 0.4% so </p>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> <a href="#narrow/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F/near/268005428">said</a>:</p>
<blockquote>
<p><a href="/user_uploads/4715/2rbLJCBRSs8lY0c4zGfXyg_g/dist-x86_64-apple.png">dist-x86_64-apple.png</a></p>
</blockquote>
<p>And the way it bottoms out in those more dense sample clusters. That <em>looks</em> suspiciously close to 66.6% (+ a little system load or something). I may just be looking for patterns in clouds, but that's a really weird cloud...</p>
<p>The averages might just change a bit due to the non-bottlenecked parts, so they don't tell us too much.</p>



<a name="268017878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268017878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268017878">(Jan 14 2022 at 14:08)</a>:</h4>
<p>Well, maybe that's just situations where 2 crates building in parallel and they're each stuck on a single-threaded bottleneck and that kind of pattern is common or something? But then shouldn't we see things dropping down to 33% utilization too?</p>
<p>Wait, are those 3C6T or 3C3T?</p>



<a name="268017916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268017916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268017916">(Jan 14 2022 at 14:08)</a>:</h4>
<p>I see at least one <code>2022-01-14T06:40:20.4313850Z running: "cmake" "--build" "." "--target" "install" "--config" "Release" "--" "-j" "3"</code></p>



<a name="268017968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268017968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268017968">(Jan 14 2022 at 14:09)</a>:</h4>
<p>3c3t, I believe</p>



<a name="268018020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268018020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268018020">(Jan 14 2022 at 14:09)</a>:</h4>
<div class="codehilite"><pre><span></span><code>2022-01-14T06:36:50.5397260Z     Hardware Overview:
2022-01-14T06:36:50.5397420Z
2022-01-14T06:36:50.5397600Z       Model Name: Mac
2022-01-14T06:36:50.5397850Z       Model Identifier: VMware7,1
2022-01-14T06:36:50.5398910Z       Processor Name: Unknown
2022-01-14T06:36:50.5399300Z       Processor Speed: 3.33 GHz
2022-01-14T06:36:50.5399550Z       Number of Processors: 1
2022-01-14T06:36:50.5399800Z       Total Number of Cores: 3
2022-01-14T06:36:50.5400100Z       L2 Cache (per Core): 256 KB
2022-01-14T06:36:50.5400420Z       L3 Cache: 12 MB
2022-01-14T06:36:50.5400640Z       Memory: 14 GB
2022-01-14T06:36:50.5400920Z       System Firmware Version: VMW71.00V.13989454.B64.1906190538
2022-01-14T06:36:50.5401320Z       Apple ROM Info: [MS_VM_CERT/SHA1/27d66596a61c48dd3dc7216fd715126e33f59ae7]Welcome to the Virtual Machine
2022-01-14T06:36:50.5401670Z       SMC Version (system): 2.8f0
2022-01-14T06:36:50.5401950Z       Serial Number (system): VMh6VWuHw3oI
2022-01-14T06:36:50.5402690Z       Hardware UUID: 4203018E-580F-C1B5-9525-B745CECA79EB
2022-01-14T06:36:50.5403370Z       Provisioning UDID: 4203018E-580F-C1B5-9525-B745CECA79EB
</code></pre></div>



<a name="268025791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268025791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268025791">(Jan 14 2022 at 15:11)</a>:</h4>
<blockquote>
<p>If macos runners are that cpu-starved then getting the crate order wrong might lead to the critical path taking longer than necessary because non-critical crates take up cpu time first</p>
</blockquote>
<p>Can you run a <code>-Ztimings</code> to demonstrate this behavior?</p>



<a name="268026194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268026194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268026194">(Jan 14 2022 at 15:13)</a>:</h4>
<p>That'd need a reference point to compare to, how fast each crate would be under ideal conditions (-j1 I guess? Assuming cargo only spawns rustc instances when job tokens are available)</p>



<a name="268027594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268027594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268027594">(Jan 14 2022 at 15:23)</a>:</h4>
<p>FWIW, I recently collected these timings for building rustc_query_impl specifically (extracted from CI logs):</p>
<ul>
<li>85 seconds &lt;- ryzen 3600x -j1 + 2 rustc threads (perf.rlo)</li>
<li>153 seconds &lt;- ryzen 3600x -j1 (my local machine)</li>
<li>150 seconds &lt;- ryzen 3950x -j1 (server)</li>
<li>303 seconds &lt;- macbook pro 2015 (2.5GHz -j1, for x86_64-apple-darwin)</li>
<li>640 seconds &lt;- github ci (dist-aarch64-apple, compiling for x86_64-apple-darwin, part of a -j3 build)</li>
</ul>
<p>I'm not sure the extent to which this is helpful/significant though.</p>



<a name="268028245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268028245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268028245">(Jan 14 2022 at 15:27)</a>:</h4>
<p>What's "+ 2 rustc threads"?</p>



<a name="268028285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268028285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268028285">(Jan 14 2022 at 15:27)</a>:</h4>
<p>I thought we're not building parallel rustc</p>



<a name="268028510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268028510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268028510">(Jan 14 2022 at 15:29)</a>:</h4>
<p>Anyway, being slower than a 2015 laptop despite more threads seems wrong. Are those VMs oversubscribed? Or on slow storage?</p>



<a name="268028912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268028912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268028912">(Jan 14 2022 at 15:31)</a>:</h4>
<p>well, one is just building that crate, the other is building other crates in parallel</p>



<a name="268029171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268029171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268029171">(Jan 14 2022 at 15:33)</a>:</h4>
<p>the 2 threads is that we allocate 2 jobserver tokens per rustc (one implicit, one extra)</p>



<a name="268029769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268029769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268029769">(Jan 14 2022 at 15:38)</a>:</h4>
<p>do you happen to know why dist-x86_64-apple appears to be building a bunch of tools twice?  like cargo, clippy, etc?</p>



<a name="268030141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268030141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268030141">(Jan 14 2022 at 15:40)</a>:</h4>
<p>hm</p>



<a name="268030720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268030720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268030720">(Jan 14 2022 at 15:44)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/issues/7437#issuecomment-535543233">https://github.com/rust-lang/cargo/issues/7437#issuecomment-535543233</a></p>
<blockquote>
<p>If I run cargo clean then cargo build -p script, the total time is 319 seconds whereas in the full build graph the script crate finishes after second 560. So as far as I can tell that’s ~240 seconds worth of work that is not a dependency of script, and that could (with different scheduling) be done in parallel with it.</p>
</blockquote>
<p>script is in the critical path in that case.</p>



<a name="268031719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268031719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268031719">(Jan 14 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F/near/268029769">said</a>:</p>
<blockquote>
<p>do you happen to know why dist-x86_64-apple appears to be building a bunch of tools twice?  like cargo, clippy, etc?</p>
</blockquote>
<p>I think we're <em>running</em> that step multiple times due to <code>./x.py dist --exclude rust-docs --exclude extended &amp;&amp; ./x.py dist --target=x86_64-apple-darwin rust-docs &amp;&amp; ./x.py dist extended</code> being the build command</p>



<a name="268031820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268031820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268031820">(Jan 14 2022 at 15:51)</a>:</h4>
<p>where both dist::Cargo and dist::Extended are DEFAULT, so the first --exclude doesn't really skip it</p>



<a name="268031851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268031851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268031851">(Jan 14 2022 at 15:51)</a>:</h4>
<p>why that leads to a re-compile of cargo instead of reusing cached artifacts, not sure</p>



<a name="268031896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268031896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268031896">(Jan 14 2022 at 15:51)</a>:</h4>
<p>it might make sense to just x.py dist and not bother with the excludes</p>



<a name="268032937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268032937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268032937">(Jan 14 2022 at 15:59)</a>:</h4>
<p>I can probably take a look later today or this weekend to come up with a better strategy there.  That could save a significant amount of time.</p>
<p>If we decide to go with <a href="https://github.com/rust-lang/rust/issues/92800">#92800</a>, I'll also follow up afterwards to remove docs from aarch64-apple which I think should save another 5 minutes or so.</p>



<a name="268032999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268032999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268032999">(Jan 14 2022 at 16:00)</a>:</h4>
<p>FWIW, this was 'changed' fairly recently, in <a href="https://github.com/rust-lang/rust/pull/90100">https://github.com/rust-lang/rust/pull/90100</a></p>



<a name="268033053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268033053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268033053">(Jan 14 2022 at 16:00)</a>:</h4>
<p>and looking at the graph it's not obvious that had any impact</p>



<a name="268033210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268033210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268033210">(Jan 14 2022 at 16:00)</a>:</h4>
<p>(it also didn't touch the slowest builder, dist-aarch64-apple, at all)</p>



<a name="268033485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268033485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268033485">(Jan 14 2022 at 16:02)</a>:</h4>
<p>yea, that makes sense.   </p>
<p>I can also comb over dist-aarch64-apple to see if there is anything interesting. My instinct is that it shouldn't be that slow.</p>



<a name="268037857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268037857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268037857">(Jan 14 2022 at 16:32)</a>:</h4>
<p><a href="/user_uploads/4715/sziAhgrfmYRCRgSUY5Ot0QSq/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/sziAhgrfmYRCRgSUY5Ot0QSq/image.png" title="image.png"><img src="/user_uploads/4715/sziAhgrfmYRCRgSUY5Ot0QSq/image.png"></a></div>



<a name="268037877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268037877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268037877">(Jan 14 2022 at 16:32)</a>:</h4>
<p>alt builder is much faster, though it obviously is building less</p>



<a name="268091998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268091998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268091998">(Jan 15 2022 at 00:26)</a>:</h4>
<p>Taking a closer look, it seems like docs are taking about 15 minutes on dist-aarch64-apple.  I'd need to do some real testing, but that would be a good chunk of time.</p>



<a name="268103061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268103061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268103061">(Jan 15 2022 at 04:03)</a>:</h4>
<p>Looking over the log for dist-aarch64-apple, some other thoughts about improving it:</p>
<ul>
<li>LLVM takes 23 minutes. I've never really understood why it uses sccache instead of just downloading an archive.</li>
<li>I'm uncertain if it is necessary to build rustc 3 times. I would expect that it should be sufficient to build for x86_64 once, and then use that to build the final aarch64 rustc. That would cut 24 minutes.</li>
<li>Sanitizers get built for x86_64, cutting that would be about 2.5 minutes.</li>
<li>Building the combined installer takes 7.7 minutes. That seems exceedingly long, and probably worth more investigation.</li>
<li>rustbuild itself could be more parallel. There are a bunch of projects that don't depend on one another that are built serially. Since there are huge chunks of time where they are using just 1 cpu, that's a lot of parallelism wasted. Of course that would make rustbuild substantially more complex. We could entertain using a better build system. <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></li>
</ul>



<a name="268115373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268115373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268115373">(Jan 15 2022 at 09:01)</a>:</h4>
<p>I offered the last point before but there wasn't much appetite for it</p>



<a name="268121852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268121852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268121852">(Jan 15 2022 at 11:49)</a>:</h4>
<p>Did a dumb CPU load test under gnu <code>time</code> on a <code>macos-latest</code> runner</p>
<p>run1:</p>
<div class="codehilite"><pre><span></span><code>Thread 0 finished in 12697 ms
Thread 2 finished in 12695 ms
Thread 1 finished in 12709 ms
Main finished in 12709 ms
37.54user 0.06system 0:12.84elapsed 292%CPU (0avgtext+0avgdata 848maxresident)k
0inputs+0outputs (0major+7493minor)pagefaults 0swaps
</code></pre></div>
<p>run2:</p>
<div class="codehilite"><pre><span></span><code>Thread 1 finished in 28701 ms
Thread 0 finished in 28826 ms
Thread 2 finished in 28890 ms
Main finished in 28891 ms
37.95user 0.40system 0:29.16elapsed 131%CPU (0avgtext+0avgdata 844maxresident)k
0inputs+0outputs (0major+7216minor)pagefaults 0swaps
</code></pre></div>
<p>I guess some machines are oversubscribed? Or maybe the test is too short and there's some background stuff running.<br>
Is there a way to print the equivalent of <em>steal time</em> on macos?</p>



<a name="268404026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268404026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268404026">(Jan 18 2022 at 15:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F/near/268029769">said</a>:</p>
<blockquote>
<p>do you happen to know why dist-x86_64-apple appears to be building a bunch of tools twice?  like cargo, clippy, etc?</p>
</blockquote>
<p>It seems like dependency vendoring changes some dep paths which invalidates fingerpints <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> <br>
<a href="https://github.com/rust-lang/rust/issues/93033">https://github.com/rust-lang/rust/issues/93033</a></p>



<a name="268404113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268404113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268404113">(Jan 18 2022 at 15:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Building stage1 tool cargo (x86_64-unknown-linux-gnu)
[2022-01-18T14:45:58Z INFO  cargo::core::compiler::fingerprint] stale: changed &quot;/home/matthias/.cargo/registry/src/github.com-1ecc6299db9ec823/curl-sys-0.4.51+curl-7.80.0/curl&quot;
[2022-01-18T14:45:58Z INFO  cargo::core::compiler::fingerprint]           (vs) &quot;/home/matthias/vcs/github/rust/build/x86_64-unknown-linux-gnu/stage1-tools/x86_64-unknown-linux-gnu/release/build/curl-sys-92c84ce359fc681e/output&quot;
[2022-01-18T14:45:58Z INFO  cargo::core::compiler::fingerprint]                FileTime { seconds: 1642516164, nanos: 851099564 } != FileTime { seconds: 1642516869, nanos: 931076291 }
</code></pre></div>



<a name="268404277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268404277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268404277">(Jan 18 2022 at 15:06)</a>:</h4>
<p>or at least this is what I suspect..</p>



<a name="268434902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268434902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268434902">(Jan 18 2022 at 18:24)</a>:</h4>
<p>yeah, so it seems that <code>dist::PlainSourceTarball</code> somehow changes how all the the following <code>dist::${tool}</code> steps perceive their deps.<br>
When I comment out the PlainSourceTarball step, tools are not rebuilt a second time.</p>
<p>I'm wondering if we can simply move the PlainSourceTarball step to  when tools are built already or if that would break something.</p>



<a name="268452798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/what%20happened%20in%20july%202020%3F/near/268452798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/what.20happened.20in.20july.202020.3F.html#268452798">(Jan 18 2022 at 20:44)</a>:</h4>
<p>opened <a href="https://github.com/rust-lang/rust/pull/93047">https://github.com/rust-lang/rust/pull/93047</a> to move the PlainSourceTarball lower in the dist pipeline</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>