<html>
<head><meta charset="utf-8"><title>playground ansible deploy · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html">playground ansible deploy</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272698428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272698428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272698428">(Feb 21 2022 at 14:56)</a>:</h4>
<p>Guess that's an ordering issue. Will need to trigger the scheduled job manually.</p>



<a name="272698475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272698475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272698475">(Feb 21 2022 at 14:56)</a>:</h4>
<p>It probably will magically fix itself before I do anything though, as the job will run soonish.</p>



<a name="272698508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272698508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272698508">(Feb 21 2022 at 14:57)</a>:</h4>
<p>hmm ok, could you fix the ansible config so that the job gets executed as part of the initial deploy?</p>



<a name="272700354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272700354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272700354">(Feb 21 2022 at 15:10)</a>:</h4>
<p>That should have set up the <code>shep</code> user and my public key from <a href="https://github.com/rust-lang/simpleinfra/blob/master/ansible/roles/common/files/ssh-keys/shep.pub">https://github.com/rust-lang/simpleinfra/blob/master/ansible/roles/common/files/ssh-keys/shep.pub</a> right?</p>



<a name="272700513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272700513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272700513">(Feb 21 2022 at 15:12)</a>:</h4>
<div class="codehilite"><pre><span></span><code>shep@play-next.infra.rust-lang.org: Permission denied (publickey).
</code></pre></div>



<a name="272705433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272705433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272705433">(Feb 21 2022 at 15:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Feb 21 14:58:35 play-next.infra.rust-lang.org update.sh[1400]: 3465bfb19f73: Download complete
Feb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 1fc18b827f25: Verifying Checksum
Feb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 1fc18b827f25: Download complete
Feb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 4e5154cd88c2: Verifying Checksum
Feb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 4e5154cd88c2: Download complete
Feb 21 14:58:42 play-next.infra.rust-lang.org update.sh[1400]: write /var/lib/docker/tmp/GetImageBlob847869486: no space left on device
</code></pre></div>
<p><span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="272707298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272707298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272707298">(Feb 21 2022 at 16:06)</a>:</h4>
<p>I did see that it was allocated 8GB, which was surprising.</p>



<a name="272707595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272707595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272707595">(Feb 21 2022 at 16:09)</a>:</h4>
<p>what size do you recommend?</p>



<a name="272707644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272707644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272707644">(Feb 21 2022 at 16:09)</a>:</h4>
<p>As the containers themselves total ~8GB, and you'd need an OS on top of that. Plus another few GB to be able to download the next day's containers.</p>



<a name="272707655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272707655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272707655">(Feb 21 2022 at 16:09)</a>:</h4>
<p>My instance is <code>/dev/xvda1       39G   24G   15G  62% /</code></p>



<a name="272707679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272707679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272707679">(Feb 21 2022 at 16:10)</a>:</h4>
<p>ok</p>



<a name="272707699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272707699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272707699">(Feb 21 2022 at 16:10)</a>:</h4>
<p>so 30GB is probably a minimum</p>



<a name="272710175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272710175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272710175">(Feb 21 2022 at 16:32)</a>:</h4>
<p>bumped to 100gb</p>



<a name="272710179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272710179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272710179">(Feb 21 2022 at 16:32)</a>:</h4>
<p>just to be sure</p>



<a name="272710408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272710408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272710408">(Feb 21 2022 at 16:34)</a>:</h4>
<p>started playground-update</p>



<a name="272710992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272710992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272710992">(Feb 21 2022 at 16:39)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Feb 21 16:38:05 play-next.infra.rust-lang.org update.sh[1945]: aws s3 sync --region=us-east-2 s3://playground-artifacts-i32 &quot;${artifacts_path}&quot;
Feb 21 16:38:06 play-next.infra.rust-lang.org update.sh[2614]: fatal error: Unable to locate credentials
</code></pre></div>



<a name="272753246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272753246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272753246">(Feb 22 2022 at 02:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272700513">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>shep@play-next.infra.rust-lang.org: Permission denied (publickey).
</code></pre></div><br>
</p>
</blockquote>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> anything I'm missing here?</p>
<div class="codehilite"><pre><span></span><code>Host playground-next
Hostname  play-next.infra.rust-lang.org
ProxyJump bastion
User shep
</code></pre></div>



<a name="272753450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272753450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272753450">(Feb 22 2022 at 02:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272710992">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>Feb 21 16:38:05 play-next.infra.rust-lang.org update.sh[1945]: aws s3 sync --region=us-east-2 s3://playground-artifacts-i32 &quot;${artifacts_path}&quot;
Feb 21 16:38:06 play-next.infra.rust-lang.org update.sh[2614]: fatal error: Unable to locate credentials
</code></pre></div><br>
</p>
</blockquote>
<p>So these creds should be coming from <code>vars_playground_aws</code> <a href="https://github.com/rust-lang/simpleinfra/blob/421f6a4429c8e6a60349ffd5f5192a89892ff08d/ansible/envs/dev-example/group_vars/playground.yml#L5-L7">e.g.</a> but it doesn't look like the <a href="https://github.com/rust-lang/simpleinfra/blob/master/ansible/envs/prod/group_vars/playground.yml">production file</a> has them</p>



<a name="272753511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272753511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272753511">(Feb 22 2022 at 02:24)</a>:</h4>
<p>but AFAIK I don't have access to the data in <code>ssm_playground: "{{ lookup('aws_ssm', '/prod/ansible/playground/', region='us-west-1', shortnames=true, bypath=true, recursive=true) }}"</code> so I don't think I know what the field(s) should be.</p>



<a name="272770552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272770552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272770552">(Feb 22 2022 at 08:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272753246">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272700513">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>shep@play-next.infra.rust-lang.org: Permission denied (publickey).
</code></pre></div><br>
</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> anything I'm missing here?</p>
<p><div class="codehilite"><pre><span></span><code>Host playground-next
Hostname  play-next.infra.rust-lang.org
ProxyJump bastion
User shep
</code></pre></div><br>
</p>
</blockquote>
<p>looks correct, I'll check what's wrong later today</p>



<a name="272770627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272770627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272770627">(Feb 22 2022 at 08:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272753511">said</a>:</p>
<blockquote>
<p>but AFAIK I don't have access to the data in <code>ssm_playground: "{{ lookup('aws_ssm', '/prod/ansible/playground/', region='us-west-1', shortnames=true, bypath=true, recursive=true) }}"</code> so I don't think I know what the field(s) should be.</p>
</blockquote>
<p>those are not configured in SSM either. the question I have is, what resources do these credentials need to have access to?</p>



<a name="272808045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808045">(Feb 22 2022 at 14:15)</a>:</h4>
<p>I upload the binary and asset files to my S3 bucket (<code>s3://playground-artifacts-i32</code>).</p>
<p>Remembering now, <a href="https://github.com/rust-lang/simpleinfra/pull/78#discussion_r724509310">you said</a> that in production we wouldn't actually set those values as environment variables:</p>
<blockquote>
<p>in production we shouldn't use IAM Users with hardcoded access keys, we should use a IAM Role attached to the EC2 instance.</p>
</blockquote>



<a name="272808249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808249">(Feb 22 2022 at 14:17)</a>:</h4>
<p>yes, but that works if everything is in the same aws account</p>



<a name="272808279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808279">(Feb 22 2022 at 14:17)</a>:</h4>
<p>(you <em>can</em> make that work with cross-account role assumption, but that's more complex)</p>



<a name="272808309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808309">(Feb 22 2022 at 14:17)</a>:</h4>
<p>that data should probably be in a bucket in our aws account</p>



<a name="272808445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808445">(Feb 22 2022 at 14:18)</a>:</h4>
<p>Then I'll need access keys to upload from CI and download to my instance.</p>



<a name="272808621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808621">(Feb 22 2022 at 14:19)</a>:</h4>
<p>Or figure out how to make the assets public for download/sync but somehow prevent some malicious person from putting it in a loop and running up my S3 bill (the only reason I put the download behind auth to start with)</p>



<a name="272808828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272808828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272808828">(Feb 22 2022 at 14:21)</a>:</h4>
<p>I'll think of something later today</p>



<a name="272815395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/272815395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#272815395">(Feb 22 2022 at 15:07)</a>:</h4>
<p>And there's also "grab the creds from the current playground and put them in SSM"</p>



<a name="273405041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273405041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273405041">(Feb 27 2022 at 13:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> ok I think the best solution in this case is for the playground's CI to upload to both the rust bucket and whatever bucket you want to use for your own instances</p>



<a name="273407200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273407200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273407200">(Feb 27 2022 at 14:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> created the <code>rust-playground-artifacts</code> s3 bucket. The instances has read access to it, and GitHub Actions on the <code>master</code> branch in the <a href="https://github.com/integer32llc/rust-playground">https://github.com/integer32llc/rust-playground</a> has access to it as well (through OIDC federation). You can configure credentials on GitHub Actions with:</p>
<div class="codehilite" data-code-language="YAML"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Configure AWS Credentials</span><span class="w"></span>
<span class="w">  </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aws-actions/configure-aws-credentials@v1</span><span class="w"></span>
<span class="w">  </span><span class="nt">with</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">role-to-assume</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::890664054962:role/upload-playground-artifacts</span><span class="w"></span>
<span class="w">    </span><span class="nt">aws-region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-1</span><span class="w"></span>
</code></pre></div>



<a name="273407289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273407289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273407289">(Feb 27 2022 at 14:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> by the way, I created the infra needed to authenticate to AWS from GitHub Actions in <a href="https://github.com/rust-lang/simpleinfra/commit/72524e9668ec27eb1e5d4dff5fa826919f4be647">this commit</a>, and here's an example of <a href="https://github.com/rust-lang/simpleinfra/blob/54d93a21e9d017f9825299e47c06e86c004990a3/terraform/playground/artifacts.tf">a role using that</a></p>



<a name="273407332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273407332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273407332">(Feb 27 2022 at 14:50)</a>:</h4>
<p>I've been using OIDC authentication at work for a while and it's so so so useful, eventually we should migrate most of the things to use it rather than hardcoding credentials in GHA secrets</p>



<a name="273407346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273407346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273407346">(Feb 27 2022 at 14:50)</a>:</h4>
<p>yeah, this looks like quite nice</p>



<a name="273542452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542452">(Feb 28 2022 at 19:39)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> practical question — I've got an environment flag to switch between the two server implementations. The default is the original server, but I've manually tweaked the current playground to have the flag on. What's the appropriate way to toggle that flag on play-next and going forward?</p>



<a name="273542551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542551">(Feb 28 2022 at 19:39)</a>:</h4>
<p>hmm? wouldn't we just switch the dns?</p>



<a name="273542713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542713">(Feb 28 2022 at 19:40)</a>:</h4>
<p>Maybe I was unclear — the environment variable switches between the Iron implementation and the Axum implementation.</p>



<a name="273542735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542735">(Feb 28 2022 at 19:40)</a>:</h4>
<p>oooh</p>



<a name="273542750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542750">(Feb 28 2022 at 19:41)</a>:</h4>
<p>ok got it!</p>



<a name="273542753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542753">(Feb 28 2022 at 19:41)</a>:</h4>
<p>hmm</p>



<a name="273542836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542836">(Feb 28 2022 at 19:41)</a>:</h4>
<p>I'd probably have an <code>env:</code> variable in the playground role that generates an environment file loaded by systemd</p>



<a name="273542918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273542918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273542918">(Feb 28 2022 at 19:42)</a>:</h4>
<p>or well just the <code>Environment</code> systemd directives <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="273543037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543037">(Feb 28 2022 at 19:43)</a>:</h4>
<p>OK, so add it next to the existing env vars in the config file. For actually turning it on and off, would I change my local file and redeploy it?</p>



<a name="273543070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543070">(Feb 28 2022 at 19:43)</a>:</h4>
<p>yes, and commit/push that change</p>



<a name="273543086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543086">(Feb 28 2022 at 19:43)</a>:</h4>
<p>Also:</p>
<div class="codehilite"><pre><span></span><code>% ssh playground-next
shep@play-next.infra.rust-lang.org: Permission denied (publickey).
</code></pre></div>



<a name="273543154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543154">(Feb 28 2022 at 19:44)</a>:</h4>
<p>did you jump through the bastion?</p>



<a name="273543311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543311">(Feb 28 2022 at 19:45)</a>:</h4>
<p>The trick with commit / push is the timing. Like, I want to be able to test it quickly and rollback quickly if needed. More than happy to push it after it being stable for "long enough" (1 hr or whatever). That sound cool?</p>



<a name="273543329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543329">(Feb 28 2022 at 19:45)</a>:</h4>
<p>oh yeah definitely!</p>



<a name="273543369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543369">(Feb 28 2022 at 19:45)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Host playground
HostName ec2-18-221-135-24.us-east-2.compute.amazonaws.com
User ubuntu
IdentityFile ~/.ssh/i32Playground-i32account.pem

Host bastion
Hostname bastion.infra.rust-lang.org
ProxyJump playground
User shep

Host playground-next
Hostname  play-next.infra.rust-lang.org
ProxyJump bastion
User shep
</code></pre></div>



<a name="273543446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543446">(Feb 28 2022 at 19:46)</a>:</h4>
<p>I copy-pasta'd my existing playground ssh config and changed the username to <code>shep</code></p>



<a name="273543541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543541">(Feb 28 2022 at 19:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/273543311">said</a>:</p>
<blockquote>
<p>The trick with commit / push is the timing. Like, I want to be able to test it quickly and rollback quickly if needed. More than happy to push it after it being stable for "long enough" (1 hr or whatever). That sound cool?</p>
</blockquote>
<p>the point is that if anyone needs to redeploy it in a week or a month they have the updated config <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="273543565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543565">(Feb 28 2022 at 19:47)</a>:</h4>
<p>the ssh problem sounds weird, I'll check in a bit</p>



<a name="273543605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273543605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273543605">(Feb 28 2022 at 19:47)</a>:</h4>
<p>Yeah, definitely want the expected state to be what's in GH</p>



<a name="273577377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/273577377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#273577377">(Mar 01 2022 at 00:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> <a href="#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/273407200">said</a>:</p>
<blockquote>
<p>You can configure credentials on GitHub Actions with:</p>
</blockquote>
<p>That's in <a href="https://github.com/integer32llc/rust-playground/pull/784">https://github.com/integer32llc/rust-playground/pull/784</a> but I can't merge because nightly is missing Miri at the moment. Next few days or so.</p>



<a name="274016618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274016618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274016618">(Mar 03 2022 at 18:26)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> <a href="https://github.com/integer32llc/rust-playground/runs/5411551756?check_suite_focus=true#step:12:1">https://github.com/integer32llc/rust-playground/runs/5411551756?check_suite_focus=true#step:12:1</a></p>



<a name="274016661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274016661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274016661">(Mar 03 2022 at 18:27)</a>:</h4>
<p>Looks like not quite right permission?</p>



<a name="274051040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274051040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274051040">(Mar 03 2022 at 22:39)</a>:</h4>
<p>try adding <code>role-skip-session-tagging: true</code>?</p>



<a name="274823147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823147">(Mar 10 2022 at 11:42)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> <a href="https://github.com/integer32llc/rust-playground/runs/5489785033?check_suite_focus=true">https://github.com/integer32llc/rust-playground/runs/5489785033?check_suite_focus=true</a></p>



<a name="274823190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823190">(Mar 10 2022 at 11:43)</a>:</h4>
<p>uff</p>



<a name="274823198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823198">(Mar 10 2022 at 11:43)</a>:</h4>
<p>you might have to unset the existing aws credentials somehow</p>



<a name="274823247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823247">(Mar 10 2022 at 11:43)</a>:</h4>
<p>that error means <code>awscli</code> is trying to authenticate with the existing credentials as the new role, instead of authenticating with the OIDC credentials as the new role</p>



<a name="274823435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823435">(Mar 10 2022 at 11:45)</a>:</h4>
<p>And I guess the environment variables are still set. I’ll have to poke around to see about unsetting them.</p>



<a name="274823497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823497">(Mar 10 2022 at 11:46)</a>:</h4>
<p>Should I undo the skip session tagging setting change?</p>



<a name="274823589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823589">(Mar 10 2022 at 11:47)</a>:</h4>
<p>hmm, I dunno whether that was caused by the same issue or not</p>



<a name="274823610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/274823610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#274823610">(Mar 10 2022 at 11:47)</a>:</h4>
<p>I'd try unsetting the environment variables, seeing whether that work, and then try to unset the session tagging</p>



<a name="277292569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/277292569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#277292569">(Mar 31 2022 at 14:47)</a>:</h4>
<p>Finally able to unset; not better <a href="https://github.com/integer32llc/rust-playground/runs/5772976974?check_suite_focus=true#step:12:14">https://github.com/integer32llc/rust-playground/runs/5772976974?check_suite_focus=true#step:12:14</a></p>



<a name="277292787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/277292787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#277292787">(Mar 31 2022 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> I know you are doing work things this week, but when you have time next week, perhaps you can explain how you expect the authentication to work.</p>



<a name="277749288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/277749288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#277749288">(Apr 04 2022 at 15:35)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> again, no hurry, just doing a weekly ping.</p>



<a name="278698295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278698295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278698295">(Apr 12 2022 at 14:12)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span></p>



<a name="278743078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743078">(Apr 12 2022 at 19:38)</a>:</h4>
<p>huh that's weird</p>



<a name="278743272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743272">(Apr 12 2022 at 19:40)</a>:</h4>
<p>I have a horrible thought <span class="user-mention" data-user-id="116155">@Jake Goulding</span>: I'm fairly sure authenticating to the rust account first, upload there and <em>then</em> authenticating to the i32 account would actually work</p>



<a name="278743360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743360">(Apr 12 2022 at 19:41)</a>:</h4>
<p>I'm willing to try — why do you think it will differ?</p>



<a name="278743395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743395">(Apr 12 2022 at 19:41)</a>:</h4>
<p>the main problem you're encountering is that authenticating to the rust account requires assuming a role, and the aws cli is being "smart" and trying to do that with the credentials currently configured in the VM (the i32 ones) rather than the oidc token provided by github</p>



<a name="278743431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743431">(Apr 12 2022 at 19:41)</a>:</h4>
<p>Should I literally just move the command earlier, keeping all the unsetting of env vars?</p>



<a name="278743438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743438">(Apr 12 2022 at 19:41)</a>:</h4>
<p>while authenticating to the i32 account is just setting these two environment variables</p>



<a name="278743513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743513">(Apr 12 2022 at 19:42)</a>:</h4>
<p>actually, wait</p>



<a name="278743600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743600">(Apr 12 2022 at 19:43)</a>:</h4>
<p>that <em>might</em> work, or aws cli might get even more confused if you then have <code>AWS_ACCESS_KEY_ID</code>/<code>AWS_SECRET_ACCESS_KEY</code> of the i32 account and <code>AWS_SESSION_TOKEN</code> of the rust account :/</p>



<a name="278743762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743762">(Apr 12 2022 at 19:44)</a>:</h4>
<p>I guess, try swapping (removing the <code>env:</code> from the aws action) and if it doesn't work we can think of something else</p>



<a name="278743763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743763">(Apr 12 2022 at 19:44)</a>:</h4>
<p>uff</p>



<a name="278743803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743803">(Apr 12 2022 at 19:45)</a>:</h4>
<p>it certainly feels like there should be a "logout" action, doesn't it?</p>



<a name="278743822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743822">(Apr 12 2022 at 19:45)</a>:</h4>
<p>I didn't see anything directly relevant on the action's issues list</p>



<a name="278743857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743857">(Apr 12 2022 at 19:45)</a>:</h4>
<p>there should indeed be, can't find it</p>



<a name="278743918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278743918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278743918">(Apr 12 2022 at 19:46)</a>:</h4>
<p>fairly sure swapping will work, if it doesn't uff</p>



<a name="278745664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/playground%20ansible%20deploy/near/278745664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/playground.20ansible.20deploy.html#278745664">(Apr 12 2022 at 20:00)</a>:</h4>
<p><a href="https://github.com/integer32llc/rust-playground/pull/795">https://github.com/integer32llc/rust-playground/pull/795</a> — diff look like what you expect?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>