<html>
<head><meta charset="utf-8"><title>cloud dev desktops · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html">cloud dev desktops</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255857049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255857049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255857049">(Oct 02 2021 at 09:35)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="422148">@Joel Marcey</span> <span class="user-mention" data-user-id="224872">@rylev</span> </p>
<p>I have started building the infra for auto-login via github and general cloud dev desktop stuff: <a href="https://github.com/oli-obk/cloud_dev_desktop">https://github.com/oli-obk/cloud_dev_desktop</a></p>



<a name="255857130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255857130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255857130">(Oct 02 2021 at 09:36)</a>:</h4>
<p>I'll continue on Tuesday, but feel free to play with it, poke holes into it or modify it</p>



<a name="255861575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255861575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255861575">(Oct 02 2021 at 10:47)</a>:</h4>
<p>thanks <span class="user-mention" data-user-id="124288">@oli</span>! taking a quick look at it, I have a few comments :)</p>



<a name="255861632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255861632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255861632">(Oct 02 2021 at 10:48)</a>:</h4>
<ul>
<li>we need to handle github users by their id, not their username, otherwise the system will break once someone changes their username</li>
</ul>



<a name="255861684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255861684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255861684">(Oct 02 2021 at 10:49)</a>:</h4>
<ul>
<li>didn't know about <code>AuthorizedKeysCommand</code>, nice!</li>
</ul>



<a name="255861769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255861769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255861769">(Oct 02 2021 at 10:51)</a>:</h4>
<ul>
<li>we should make sure the tool also allows logging in with non-github users, so that infra can have sudo-enabled accounts managed the same way as the other systems</li>
</ul>



<a name="255861791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255861791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255861791">(Oct 02 2021 at 10:51)</a>:</h4>
<ul>
<li>when we deploy this we should probably move everything over to ansible (<a href="https://github.com/rust-lang/simpleinfra/tree/master/ansible">https://github.com/rust-lang/simpleinfra/tree/master/ansible</a>), so that it's managed like all the other VMs infra is managing</li>
</ul>



<a name="255862016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255862016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255862016">(Oct 02 2021 at 10:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> <a href="#narrow/stream/242791-t-infra/topic/cloud.20dev.20desktops/near/255861632">said</a>:</p>
<blockquote>
<ul>
<li>we need to handle github users by their id, not their username, otherwise the system will break once someone changes their username</li>
</ul>
</blockquote>
<p>for this, to avoid having inconvenient access like <code>gh123456@europe.cloud-dev.rust-lang.org</code>, it might be enough to keep a <code>github_id =&gt; local_username</code> mapping, and when it doesn't match anymore rename the local user and move their home directory</p>



<a name="255866463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255866463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255866463">(Oct 02 2021 at 12:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> <a href="#narrow/stream/242791-t-infra/topic/cloud.20dev.20desktops/near/255861769">said</a>:</p>
<blockquote>
<ul>
<li>we should make sure the tool also allows logging in with non-github users, so that infra can have sudo-enabled accounts managed the same way as the other systems</li>
</ul>
</blockquote>
<p>according to the docs of <code>AuthorizedKeysCommand</code> if the script fails, it continues to the regular login</p>



<a name="255866545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255866545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255866545">(Oct 02 2021 at 12:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121055">Pietro Albini</span> <a href="#narrow/stream/242791-t-infra/topic/cloud.20dev.20desktops/near/255861632">said</a>:</p>
<blockquote>
<ul>
<li>we need to handle github users by their id, not their username, otherwise the system will break once someone changes their username</li>
</ul>
</blockquote>
<p>we don't guarantee persistence anyway. my recommendation would be to just not address this and require manual migration if they want to keep their old data</p>



<a name="255874137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255874137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255874137">(Oct 02 2021 at 14:13)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> what if someone changes their username and a new person outside the project creates a new account with that name? The random person shouldn't get access.</p>



<a name="255874860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255874860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255874860">(Oct 02 2021 at 14:25)</a>:</h4>
<p>The random person wouldn't get access in that case -- well, unless they have ssh private keys</p>



<a name="255875449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255875449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255875449">(Oct 02 2021 at 14:35)</a>:</h4>
<p>we can add a cron job that deletes and archives nonexistant accounts</p>



<a name="255875508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255875508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255875508">(Oct 02 2021 at 14:36)</a>:</h4>
<p>they still need to be a team member, too, so it's not that trivial</p>



<a name="255875670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255875670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255875670">(Oct 02 2021 at 14:39)</a>:</h4>
<p>I do think it's worth thinking a little about our security requirements. Most similar services/scripts I've looked at (e.g., <a href="https://goteleport.com/">https://goteleport.com/</a>, <a href="https://www.vaultproject.io/">https://www.vaultproject.io/</a>, <a href="https://www.boundaryproject.io/">https://www.boundaryproject.io/</a>) pursue a path that is a little higher resistance -- temporary ssh credentials, typically based on certificate signing -- and add an extra authentication layer to the service (typically e.g. GitHub or some other provider's "login" action, afaict).</p>
<p>I think at minimum whatever tooling we identify should probably have a basic threat model documented and what we're doing to mitigate the risks. For example, it's worth considering that my guess is we will quickly want some kind of hook for garbage collecting user accounts, because particularly with rustc builds today, it is really easy for the disk space requirements to be quite large -- we can certainly provision large disks, but having multiple terabytes of storage per machine is both costly and may start running up against limitations (e.g., max storage provisioned quotas that we need to bump). It seems like we <em>could</em> do this locally -- the script I saw so far would give us a possible hook to schedule from -- but it seems like it might not be the best architecture.</p>
<p>I think it's also worth adding some kind of monitoring/audit trail for who is logging in to each of these machines. While this doesn't really help directly, I think it will help us understand how people are using them and when (e.g., which regions have the highest demand, how distributed are logins over time or is everyone working in the same "time"). To some extent, we get partial assessment from the grafana dashboards showing CPU util and such, but that is a somewhat distant proxy for this data.</p>



<a name="255875881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255875881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255875881">(Oct 02 2021 at 14:42)</a>:</h4>
<p>Yea, the threat model I have here is that the only thing we need to protect are users' private keys they will end up using to push to github. If we can avoid storing such private keys (e.g. via the "login, get temporary token" method), then to me it seems like we have nothing to protect</p>



<a name="255875979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255875979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255875979">(Oct 02 2021 at 14:44)</a>:</h4>
<p>the only other thing that can be attacked is the machine in order to (ab)use its resources, and that is not too critical I believe. Like... someone will tell us and we'll nuke the machine and then improve our security</p>



<a name="255876566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876566">(Oct 02 2021 at 14:54)</a>:</h4>
<blockquote>
<p>Yea, the threat model I have here is that the only thing we need to protect are users' private keys they will end up using to push to github. If we can avoid storing such private keys (e.g. via the "login, get temporary token" method), then to me it seems like we have nothing to protect</p>
</blockquote>
<p>Hm, not sure I follow -- I think we are explicitly aiming for "no private keys in our possession" currently, right? We <em>could</em> add a temporary token or signature that the user acquires in order to control access, but I think currently we should probably start with just what we have now since it seems like it should mostly be enough.</p>



<a name="255876593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876593">(Oct 02 2021 at 14:55)</a>:</h4>
<p>It does mean that if github is down people can't work -- which seems unfortunate; the certificate model with auth through github avoids that</p>



<a name="255876659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876659">(Oct 02 2021 at 14:56)</a>:</h4>
<p>(with a long enough timeout, say, 3 days)</p>



<a name="255876690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876690">(Oct 02 2021 at 14:56)</a>:</h4>
<p>I can think two projects off top of my head that can achieve this by moving the authentication to some iap/auth/vault implementation.</p>



<a name="255876698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876698">(Oct 02 2021 at 14:57)</a>:</h4>
<p>that is all beyond my abilities</p>



<a name="255876716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876716">(Oct 02 2021 at 14:57)</a>:</h4>
<p>we don't store private keys, but ppl may store them</p>



<a name="255876768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876768">(Oct 02 2021 at 14:58)</a>:</h4>
<p><a href="https://github.com/standard-ai/cog">https://github.com/standard-ai/cog</a> and <a href="https://goteleport.com/">https://goteleport.com/</a></p>



<a name="255876801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876801">(Oct 02 2021 at 14:59)</a>:</h4>
<p>I'll look at these next week... maybe they are not too hard to use</p>



<a name="255876822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876822">(Oct 02 2021 at 14:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/242791-t-infra/topic/cloud.20dev.20desktops/near/255876690">said</a>:</p>
<blockquote>
<p>I can think two projects off top of my head that can achieve this by moving the authentication to some iap/auth/vault implementation.</p>
</blockquote>
<p>Right, I mean, I pointed at one of those and there's a few more in my comment above...</p>



<a name="255876926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876926">(Oct 02 2021 at 15:00)</a>:</h4>
<p>Using them is not that hard; we can certainly provision them. I think we don't necessarily need to do so for the first iteration, but I do think we need some solution for the disk space question</p>



<a name="255876931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876931">(Oct 02 2021 at 15:00)</a>:</h4>
<p>To the best of my knowledge they do require a fair amount of setup that only makes sense for fleets of servers tbh. For something simple I don't see why asking people "please don't store secrets on this machine" and just grabbing the public keys off their github account is insufficient.</p>



<a name="255876969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876969">(Oct 02 2021 at 15:01)</a>:</h4>
<p>I need to figure out how to get them to be able to git push to their forks, other than that, we store no secrets</p>



<a name="255876981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255876981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255876981">(Oct 02 2021 at 15:01)</a>:</h4>
<p>Hm… ssh-agent forwarding?</p>



<a name="255877031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255877031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255877031">(Oct 02 2021 at 15:02)</a>:</h4>
<p>It has its implications, but not as terrible as storing your own private key on the machine.</p>



<a name="255877310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255877310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255877310">(Oct 02 2021 at 15:07)</a>:</h4>
<p>I do think grabbing github keys is probably enough for the first iteration</p>



<a name="255881174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255881174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255881174">(Oct 02 2021 at 16:17)</a>:</h4>
<p>You could limit the key file format to the thing that is commonly used with hardware tokens. ed25519-sk.</p>



<a name="255881182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255881182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255881182">(Oct 02 2021 at 16:17)</a>:</h4>
<p>and recommend that people use one of those</p>



<a name="255881730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255881730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255881730">(Oct 02 2021 at 16:26)</a>:</h4>
<blockquote>
<p>because particularly with rustc builds today, it is really easy for the disk space requirements to be quite large</p>
</blockquote>
<p>btrfs or xfs support offline deduplication. that could at least dedup <a href="http://crates.io">crates.io</a> registry downloads and git repos. idk how sharable build parts are. a shared sccache daemon could help too with non-incremental builds.</p>



<a name="255882932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255882932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255882932">(Oct 02 2021 at 16:46)</a>:</h4>
<p>I don't think those would work well -- most peoples builds aren't going to be the same, binary-wise, since they're in different directories. The <a href="http://crates.io">crates.io</a> registry and git repositories are relatively small, I'm not worried about them.</p>



<a name="255882940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255882940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255882940">(Oct 02 2021 at 16:46)</a>:</h4>
<p>It's possible we just don't try to solve this for now, that's probably fine</p>



<a name="255882949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255882949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255882949">(Oct 02 2021 at 16:46)</a>:</h4>
<p>but it'll likely quickly become a problem is my guess</p>



<a name="255883680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255883680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255883680">(Oct 02 2021 at 16:59)</a>:</h4>
<p>the files don't have to be bit-identical for deduplication. This works on a block-level. But I think blocks need to be aligned so the path-dependent stuff would have to sit towards the end. or ideally in separate files.</p>



<a name="255883853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255883853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255883853">(Oct 02 2021 at 17:01)</a>:</h4>
<p>yep, needs to be aligned</p>



<a name="255883943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255883943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255883943">(Oct 02 2021 at 17:03)</a>:</h4>
<p>give everyone a username of the same length and recommend a specific directory layout, then it might work out :D</p>



<a name="255885912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255885912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255885912">(Oct 02 2021 at 17:36)</a>:</h4>
<p>simpler option: cron job that scans for build dirs and nukes them. that way people get to keep the source</p>



<a name="255890332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255890332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255890332">(Oct 02 2021 at 18:50)</a>:</h4>
<p>Yes, I think we should nuke build directories that haven't changed in a week and maybe just teach x.py to clean the incremental cache if the base commit of the current branch changes.</p>



<a name="255890426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255890426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255890426">(Oct 02 2021 at 18:52)</a>:</h4>
<p>We could try stripping paths to make them all relative to the repository. We do have the logic for this for reproducible builds, maybe we can just enable this in general?</p>



<a name="255891213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255891213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255891213">(Oct 02 2021 at 19:04)</a>:</h4>
<p>Maybe. I doubt we'll get much mileage out of deduplication, but cleaning out unchanged directories for a week seems reasonable and probably essentially equivalent</p>



<a name="255891271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255891271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255891271">(Oct 02 2021 at 19:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ btrfs filesystem du -s *
     Total   Exclusive  Set shared  Filename
  14.00GiB     1.82GiB     8.87GiB  rust1
   7.46GiB     1.20GiB     5.36GiB  rust2
</code></pre></div>
<p>dedup does work, I think. I checked out two different revisions, chose different x.py setup profiles (one building llvm) and performed git maintenance on one but not the other, then ran stage1 ui tests.<br>
then ran <a href="https://github.com/markfasheh/duperemove">duperemove</a></p>



<a name="255891358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255891358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255891358">(Oct 02 2021 at 19:07)</a>:</h4>
<p>is btrfs dedup efficient at all? for zfs enabling dedup is strongly advised against due to extreme memory overheads.</p>



<a name="255891396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255891396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255891396">(Oct 02 2021 at 19:08)</a>:</h4>
<p>And if this is a VM or something we are talking about, it sounds to me like adding more disk would likely give much more straightforward returns than attempting to provision deduplication.</p>



<a name="255891446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255891446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255891446">(Oct 02 2021 at 19:08)</a>:</h4>
<p>btrfs dedup is done in userspace. you provide the program that looks for duplicate blocks and then ask the kernel to dedup them (kernel will doublecheck). no homungous deduplication tables kept in memory, unlike ZFS. but it does increase fragmentation.</p>



<a name="255892420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255892420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255892420">(Oct 02 2021 at 19:24)</a>:</h4>
<p>nevermind. automatic snapshots messed up the shared accounting. dedup only saved 3.6GB out of 14GB for the one with llvm build after rerunning on a subvolume without snapshotting.</p>



<a name="255892901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/255892901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#255892901">(Oct 02 2021 at 19:33)</a>:</h4>
<p>another good way to save some space is to use a filesystem-level compression. lz4 saves me like 30% on my projects dataset. If there's any interest I can try measuring just a typical rust checkout with build artifacts.</p>



<a name="257393525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257393525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257393525">(Oct 13 2021 at 16:16)</a>:</h4>
<p>So... I played around a little, and we cannot use the AuthorizedKeysCommand system, but it turns out this only works for users that already exist. There is nothing built-in to handle non-existing users beyond "have a daemon look at the failed login logs and create the users".</p>



<a name="257393711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257393711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257393711">(Oct 13 2021 at 16:17)</a>:</h4>
<p>I did not look at <a href="https://goteleport.com/">https://goteleport.com/</a>, <a href="https://www.vaultproject.io/">https://www.vaultproject.io/</a>, <a href="https://www.boundaryproject.io/">https://www.boundaryproject.io/</a> yet and won't get to those before next week</p>



<a name="257397483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257397483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257397483">(Oct 13 2021 at 16:41)</a>:</h4>
<p>yea, without writing a new PAM module (<a href="https://serverfault.com/a/990546">https://serverfault.com/a/990546</a>) or the fun daemon above... we need a real system like the three mentioned alternatives</p>



<a name="257398422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257398422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257398422">(Oct 13 2021 at 16:46)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> wouldn't a cronjob that runs every 5 minutes and creates/deletes users also work?</p>



<a name="257398518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257398518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257398518">(Oct 13 2021 at 16:47)</a>:</h4>
<p>it wouldn't be instant but other things take a couple minutes to synchronize with the team repo</p>



<a name="257398753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257398753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257398753">(Oct 13 2021 at 16:48)</a>:</h4>
<p>sure</p>



<a name="257398801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257398801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257398801">(Oct 13 2021 at 16:48)</a>:</h4>
<p>Well, we don't even need that - right? We can have the sync-teams script we already run in a privileged context on aws  do an Ansible deploy to reprovision accounts, which seems like it might be better anyway</p>



<a name="257399024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257399024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257399024">(Oct 13 2021 at 16:50)</a>:</h4>
<p>that sounds reasonable, then the login script doesn't need to check the teams repo anymore, as we can assume the accounts are alright, because the ansible deploy can delete users that are not in the list</p>



<a name="257399171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257399171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257399171">(Oct 13 2021 at 16:51)</a>:</h4>
<p>That seems pretty reasonable to me at least. It might be even less work (since we already mostly have Ansible setup for other machines, just without syncing with team repo)</p>



<a name="257399388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257399388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257399388">(Oct 13 2021 at 16:52)</a>:</h4>
<p>ok... uh... can I either get some guidance or help or outright someone else to do it here? Or is it pretty obvious how stuff works if I just read the scripts repo?</p>



<a name="257400157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400157">(Oct 13 2021 at 16:56)</a>:</h4>
<p>I don't think anyone here is more familiar with ansible than "has run it some times locally and skimmed docs"</p>



<a name="257400204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400204">(Oct 13 2021 at 16:57)</a>:</h4>
<p><a href="https://github.com/rust-lang/sync-team">https://github.com/rust-lang/sync-team</a> is the thing that runs in the privileged context</p>



<a name="257400321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400321">(Oct 13 2021 at 16:57)</a>:</h4>
<p>it's probably not too hard to add an ssh sync to that (just running ssh command likely with an admin account or so...)</p>



<a name="257400465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400465">(Oct 13 2021 at 16:58)</a>:</h4>
<p>hmm, I think it's likely less complex to just have a cronjob/systemd timer for that</p>



<a name="257400570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400570">(Oct 13 2021 at 16:59)</a>:</h4>
<p>afaik there's not really a clean way to take the list of users from the team api and put it into the ansible variables</p>



<a name="257400598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400598">(Oct 13 2021 at 16:59)</a>:</h4>
<p>so we'd need to have ansible run a script into the server that adds and deletes the users</p>



<a name="257400616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400616">(Oct 13 2021 at 16:59)</a>:</h4>
<p>at that point we can just have that script in a timer</p>



<a name="257400681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400681">(Oct 13 2021 at 17:00)</a>:</h4>
<p>yeah, I mean, we don't really need it to be ansible</p>



<a name="257400785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257400785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257400785">(Oct 13 2021 at 17:00)</a>:</h4>
<p>anyway, a cron job also seems fine to me</p>



<a name="257424637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257424637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257424637">(Oct 13 2021 at 19:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/242791-t-infra/topic/cloud.20dev.20desktops/near/257400785">said</a>:</p>
<blockquote>
<p>anyway, a cron job also seems fine to me</p>
</blockquote>
<p>cool, I can do a cron job!</p>



<a name="257536824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257536824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257536824">(Oct 14 2021 at 13:42)</a>:</h4>
<p>ok, everything works <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="257536883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257536883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257536883">(Oct 14 2021 at 13:42)</a>:</h4>
<p>all setup stuff is in <a href="https://github.com/oli-obk/cloud_dev_desktop">https://github.com/oli-obk/cloud_dev_desktop</a></p>



<a name="257538040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257538040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257538040">(Oct 14 2021 at 13:49)</a>:</h4>
<p>great! I think we'll want to see the setup scripts repackaged into an ansible config so we can consistently run them against the (eventual) multiple machines</p>



<a name="257538136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257538136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257538136">(Oct 14 2021 at 13:50)</a>:</h4>
<p>(in particular as a PR against rust-lang/simpleinfra)</p>



<a name="257538192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257538192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257538192">(Oct 14 2021 at 13:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> has recently done the legwork to do that for <a href="http://play.rust-lang.org">play.rust-lang.org</a>, so you can probably look at that PR</p>



<a name="257538250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/257538250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#257538250">(Oct 14 2021 at 13:51)</a>:</h4>
<p><a href="https://github.com/rust-lang/simpleinfra/pull/78">https://github.com/rust-lang/simpleinfra/pull/78</a></p>



<a name="258737630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258737630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Marcey <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258737630">(Oct 22 2021 at 16:38)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> Just catching up here. So we now have all the right scripts to get a general set of AWS machines set up with what is needed for maintainers to access the cloud infra. We have one actual AWS machine running this setup right now, correct? Has the flow been tested yet on it? i.e. a pull request from a maintainer that actually uses the machine?</p>



<a name="258753472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258753472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258753472">(Oct 22 2021 at 18:31)</a>:</h4>
<p>oh right lol, should actually try out more than trivial rustc builds</p>



<a name="258753516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258753516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258753516">(Oct 22 2021 at 18:31)</a>:</h4>
<p>I got a contributor to log on, so that part works</p>



<a name="258753641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258753641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258753641">(Oct 22 2021 at 18:32)</a>:</h4>
<p>I have started the "make more of these machines" PR in <a href="https://github.com/rust-lang/simpleinfra/pull/79">https://github.com/rust-lang/simpleinfra/pull/79</a></p>



<a name="258753666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258753666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258753666">(Oct 22 2021 at 18:32)</a>:</h4>
<p>it is entirely untested tho</p>



<a name="258839322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258839322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Marcey <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258839322">(Oct 23 2021 at 19:43)</a>:</h4>
<p>Is there a current non-critical PR that we can use to test the flow?</p>



<a name="258863389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/258863389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#258863389">(Oct 24 2021 at 06:48)</a>:</h4>
<p>It's less testing it on a real PR that is the problem, I can verify this together with a contributor that everything works, the main problem is replicating the machine, which I haven't figured out how to test yet</p>



<a name="259132723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/259132723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Marcey <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#259132723">(Oct 26 2021 at 17:34)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Could we manually set up 3-4 machines globally and then come up with the right process to replicate more as needed?</p>



<a name="259133138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/259133138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#259133138">(Oct 26 2021 at 17:37)</a>:</h4>
<p>I would prefer we use Ansible to configure the machines from the start, that way all the machines will be standardized and centrally managed</p>



<a name="259133533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/259133533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#259133533">(Oct 26 2021 at 17:39)</a>:</h4>
<p>infra has been trying to migrate away from manually managed machines, and I'd prefer not to regress on that front <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="259133537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/259133537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#259133537">(Oct 26 2021 at 17:39)</a>:</h4>
<p>Yeah, I think that's a necessity. I left another comment on Oli's PR, and am happy to try it out when that's resolved to configure a new machine.</p>
<p>We'll likely also want to manage the machines themselves through terraform so it's easy to spin them up in the appropriate size -- IIRC, we don't yet have configs for that? I might have them in a local branch though, not sure</p>



<a name="259137123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/cloud%20dev%20desktops/near/259137123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Marcey <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/cloud.20dev.20desktops.html#259137123">(Oct 26 2021 at 18:04)</a>:</h4>
<p>Thanks ... I agree with both of you that a centrally managed system to manage the machines is definitely optimal and the way to go. I just wasn't sure how close we were to getting there. And I didn't want to  hold up the potential benefits of this indefinitely. But, if we are close to having a turnkey system, then that's <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>