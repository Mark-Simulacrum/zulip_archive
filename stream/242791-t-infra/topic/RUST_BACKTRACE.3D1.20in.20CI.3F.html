<html>
<head><meta charset="utf-8"><title>RUST_BACKTRACE=1 in CI? · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html">RUST_BACKTRACE=1 in CI?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269835049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269835049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269835049">(Jan 29 2022 at 03:41)</a>:</h4>
<p>I sometimes see test failures in CI that give a panic or similar, mentioning to set RUST_BACKTRACE=1 for a backtrace. Would it make sense for us to set RUST_BACKTRACE=1 in CI, at least for tests that aren't specifically testing the output of a backtrace? (We'd probably have to fix up a few tests, or unset it for a few tests, but that seems worth doing in order to get better error messages from CI.)</p>



<a name="269835821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269835821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269835821">(Jan 29 2022 at 03:57)</a>:</h4>
<p>We already set it on the PR builder (<a href="https://github.com/rust-lang/rust/blob/cbaeec14f90b59a91a6b0f17fc046c66fa811892/src/ci/github-actions/ci.yml#L440">https://github.com/rust-lang/rust/blob/cbaeec14f90b59a91a6b0f17fc046c66fa811892/src/ci/github-actions/ci.yml#L440</a>), so I imagine setting it elsewhere could be done. Not sure how useful it is since most builders don't have debug info, or whether we'd encounter some overhead from setting it</p>



<a name="269835920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269835920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269835920">(Jan 29 2022 at 03:59)</a>:</h4>
<p>Huh. I had a CI failure that just gave a panic with no backtrace.</p>



<a name="269835922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269835922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269835922">(Jan 29 2022 at 03:59)</a>:</h4>
<p>Digging it up...</p>



<a name="269835936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269835936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269835936">(Jan 29 2022 at 03:59)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/runs/4986893650#step:26:14328">https://github.com/rust-lang/rust/runs/4986893650#step:26:14328</a></p>



<a name="269836025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269836025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269836025">(Jan 29 2022 at 04:00)</a>:</h4>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;ArrayVec: capacity exceeded in extend/from_iter&#39;, /cargo/registry/src/github.com-1ecc6299db9ec823/arrayvec-0.7.0/src/arrayvec.rs:988:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

error: internal compiler error: unexpected panic
</code></pre></div>
<p>Would have been helpful to know where that panic came from. I did end up finding and fixing it, but a backtrace would have helped there.</p>



<a name="269860631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269860631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269860631">(Jan 29 2022 at 12:14)</a>:</h4>
<p>Huh. We set it on the PR builder, but for some reason only on auto branch CI - not on the PR CI <a href="https://github.com/rust-lang/rust/blob/cbaeec14f90b59a91a6b0f17fc046c66fa811892/src/ci/github-actions/ci.yml#L291">https://github.com/rust-lang/rust/blob/cbaeec14f90b59a91a6b0f17fc046c66fa811892/src/ci/github-actions/ci.yml#L291</a></p>



<a name="269875251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269875251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269875251">(Jan 29 2022 at 16:54)</a>:</h4>
<p>Would it make sense to set it there too? Happy to send a PR.</p>



<a name="269876500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269876500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269876500">(Jan 29 2022 at 17:16)</a>:</h4>
<p>I think we should try setting it across all builders, probably in src/ci/run.sh, except for one of them (so we don't depend on it being set in tests and such).</p>



<a name="269876529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269876529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269876529">(Jan 29 2022 at 17:17)</a>:</h4>
<p>Or, blanket set it for tests in bootstrap and/or compiletest.</p>



<a name="269876564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269876564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269876564">(Jan 29 2022 at 17:17)</a>:</h4>
<p>Doing it for just both llvm-12 builders is problematic I think since there's likely to be some tests running differently <em>just</em> on those builders.</p>



<a name="269878359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269878359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269878359">(Jan 29 2022 at 17:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F/near/269876529">said</a>:</p>
<blockquote>
<p>Or, blanket set it for tests in bootstrap and/or compiletest.</p>
</blockquote>
<p>That seems like a good idea, so that people also get backtraces when running tests locally, not just in CI.</p>



<a name="269878535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269878535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269878535">(Jan 29 2022 at 17:56)</a>:</h4>
<p>We should be a little careful though - for libtest-style tests, collecting backtraces may slow down should panic tests a good deal, which would be unfortunate.</p>



<a name="269878686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269878686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269878686">(Jan 29 2022 at 17:59)</a>:</h4>
<p>Ideally, the test suite could re-run failed tests with RUST_BACKTRACE=1 if and only if they panic.</p>



<a name="269878691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269878691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269878691">(Jan 29 2022 at 17:59)</a>:</h4>
<p>But that seems harder.</p>



<a name="269879398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269879398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269879398">(Jan 29 2022 at 18:11)</a>:</h4>
<p>For compiletest, panics should be rare, so it should be fine there. For libtest, we can probably adjust the panic hook to turn on backtraces with some threading through of state, I suppose.</p>



<a name="269879669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269879669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269879669">(Jan 29 2022 at 18:16)</a>:</h4>
<p>Well, for now, setting it in compiletest seems like an improvement.</p>



<a name="269880585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269880585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269880585">(Jan 29 2022 at 18:34)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/93460">https://github.com/rust-lang/rust/pull/93460</a></p>



<a name="269880600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269880600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269880600">(Jan 29 2022 at 18:35)</a>:</h4>
<p>(We'll have to see if that breaks any expected test output.)</p>



<a name="269941576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269941576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269941576">(Jan 30 2022 at 16:22)</a>:</h4>
<p>Short of getting a full backtrace is the issue that the location that they reported in arrayvec wasn't actually relevant?</p>



<a name="269941593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269941593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269941593">(Jan 30 2022 at 16:22)</a>:</h4>
<p>I'm wondering if this is something that should have track caller on it.</p>



<a name="269946192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269946192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269946192">(Jan 30 2022 at 17:54)</a>:</h4>
<p><span class="user-mention" data-user-id="220273">@Jane Lusby [she/her]</span> <a href="https://github.com/bluss/arrayvec/issues/212">https://github.com/bluss/arrayvec/issues/212</a> :)</p>



<a name="269946213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269946213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269946213">(Jan 30 2022 at 17:55)</a>:</h4>
<p>Already going that route too, but I also thought backtraces would be useful.</p>



<a name="269946986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/RUST_BACKTRACE%3D1%20in%20CI%3F/near/269946986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/RUST_BACKTRACE.3D1.20in.20CI.3F.html#269946986">(Jan 30 2022 at 18:09)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>