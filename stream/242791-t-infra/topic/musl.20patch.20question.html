<html>
<head><meta charset="utf-8"><title>musl patch question · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html">musl patch question</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259925029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259925029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259925029">(Nov 01 2021 at 21:38)</a>:</h4>
<p>I'm working on fixing <a href="https://github.com/rust-lang/rust/issues/90103">#90103</a>. The gist of it is that if you try to get a backtrace (either from gdb or as part of a crash dump) while a Rust application built with the <code>-musl</code> targets is in the middle of a syscall, gdb can't properly walk the stack and you get garbage. Even after enabling debug info for musl this still doesn't work because we also need <a href="https://sourceware.org/binutils/docs/as/CFI-directives.html">CFI directives</a> to be included in musl's assembly and there is a bug with musl's configure script when invoked from musl-cross-make. <a href="https://www.openwall.com/lists/musl/2021/10/21/2">I've sent a patch upstream for that.</a></p>
<p>To actually close this issue out, we need to start building musl with this patch (and debug info enabled). There's a few different ways I can see us doing that:</p>
<ol>
<li>Fork musl, apply the patch there and update our build scripts to use that fork.</li>
<li>Fork musl-cross-make, add the patch into <a href="https://github.com/richfelker/musl-cross-make/tree/master/patches">their patches folder</a> so it is applied before building musl and update our build scripts to use that fork. </li>
<li>Store <a href="https://github.com/wesleywiser/musl-cross-make/commit/de8303aa6ed5b74e7bfc706330b6eac1ba6490be">the patch</a> in tree (perhaps next to the build script) and copy it into the appropriate folder after cloning musl-cross-make.</li>
</ol>
<p>I don't think any of these will be significantly harder or easier to do than any of the others. Personally, I'm leaning toward option 3 since we don't have to fork and manage another repo. </p>
<p>Do y'all have a preference?</p>



<a name="259930008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259930008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259930008">(Nov 01 2021 at 22:28)</a>:</h4>
<p>Are we expecting a long delay for the patch to be merged upstream and available to us?</p>



<a name="259930046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259930046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259930046">(Nov 01 2021 at 22:29)</a>:</h4>
<p>(that is, why is option 4 - wait on the upstream merge and bump the version we use, not viable?)</p>



<a name="259930189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259930189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259930189">(Nov 01 2021 at 22:31)</a>:</h4>
<p>But yeah option 3 seems ok - we'll want to make sure distros can work well with it, but I suspect that'll amount to them applying that patch to their own build scripts or just accepting not working</p>



<a name="259930339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259930339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259930339">(Nov 01 2021 at 22:33)</a>:</h4>
<p>I am a little worried about us building musl with debuginfo increasing binary sizes in a painful way for folks - I guess stripping will still help.</p>



<a name="259930359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259930359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259930359">(Nov 01 2021 at 22:33)</a>:</h4>
<p>Is glibc just usually built with debuginfo I guess?</p>



<a name="259930433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259930433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259930433">(Nov 01 2021 at 22:34)</a>:</h4>
<p>glibc is usually built with detached debug symbols.</p>



<a name="259932748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259932748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259932748">(Nov 01 2021 at 23:03)</a>:</h4>
<p>And those are installed when (for example) gdb is installed as a suggestion? (Mainly wondering why I haven't seen this failure mode).</p>
<p>How large is the size delta for debuginfo here?</p>



<a name="259967742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259967742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259967742">(Nov 02 2021 at 08:59)</a>:</h4>
<p>No, gdb doesn't forcibly pull in glibc debug symbols, though some distributions have started using a debug-info-on-demand server.</p>



<a name="259968034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259968034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259968034">(Nov 02 2021 at 09:01)</a>:</h4>
<p>Regarding size, on my system the separate debug symbols for glibc are twice as big as the library itself.</p>



<a name="259968225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259968225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259968225">(Nov 02 2021 at 09:03)</a>:</h4>
<p>Oh, but looking at it, it looks like even the stripped glibc still has the .eh_frame section, which has the unwinding information. That's where the CFI information goes.</p>



<a name="259968373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259968373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259968373">(Nov 02 2021 at 09:05)</a>:</h4>
<p>Whereas the musl static library on my system doesn't have a .eh_frame section (though the dynamic library does).</p>



<a name="259969040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259969040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259969040">(Nov 02 2021 at 09:12)</a>:</h4>
<p>And for an idea of size, on my system glibc's <code>/lib/x86_64-linux-gnu/libc-2.32.so</code> is 1839168 bytes, and its <code>.eh_frame</code> is 25244 bytes.</p>



<a name="259969080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259969080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259969080">(Nov 02 2021 at 09:12)</a>:</h4>
<p>For musl I'd expect <code>.eh_frame</code> to be smaller.</p>



<a name="259969285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259969285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259969285">(Nov 02 2021 at 09:15)</a>:</h4>
<p>On my system, musl's <code>/lib/x86_64-linux-musl/libc.so</code> is 707056 bytes, and its <code>.eh_frame</code> is 44  bytes. (That seems surprisingly small, to the point that I wonder if it's actually correct...)</p>



<a name="259969951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/259969951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#259969951">(Nov 02 2021 at 09:22)</a>:</h4>
<p>Ah, I think that <em>is</em> wrong. It's only the eh_frame for some generated code (the PLT, I think), not for the library itself.</p>



<a name="260000112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260000112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260000112">(Nov 02 2021 at 14:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/242791-t-infra/topic/musl.20patch.20question/near/259930008">said</a>:</p>
<blockquote>
<p>Are we expecting a long delay for the patch to be merged upstream and available to us?</p>
</blockquote>
<p>Good question. Looking at their release history, it seems like there's usually a release every ~4 months or so with a fair amount of variation. However, there hasn't been a release this year since January. I'd rather not wait on them to create another release before we can resolve this since a team I'm working with at MS brought it up as an issue they're hitting. </p>
<p>Unless you just mean, it's merged into master upstream? I posted this about a week and half ago and it hasn't been acknowledged yet. I don't have much experience with mailing-list based projects so I'm not sure what their norms are with regards to this kind of thing. I was going to let it sit a few more days before sending a follow up message.</p>



<a name="260000610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260000610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260000610">(Nov 02 2021 at 14:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/242791-t-infra/topic/musl.20patch.20question/near/259930339">said</a>:</p>
<blockquote>
<p>I am a little worried about us building musl with debuginfo increasing binary sizes in a painful way for folks - I guess stripping will still help.</p>
</blockquote>
<p>For people concerned with binary size, I would think they're already stripping their binaries so they shouldn't really be impacted. <span class="user-mention" data-user-id="239881">@Josh Triplett</span>'s numbers seem about right to me but I will do some builds and get exact numbers. I'll also grab numbers for "Rust hello world" in a few different configurations (debug, release, release w/ strip) so we can see what worst case numbers probably look like.</p>



<a name="260006680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260006680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260006680">(Nov 02 2021 at 14:56)</a>:</h4>
<p>OK. Yeah, I don't mind too much if we have our own patch but I also know the musl folks are generally fairly active when poked (or that's been my impression) and would be great to not have an out-of-tree patch. Since it's just build system related I'm not too worried though.</p>



<a name="260007292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260007292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260007292">(Nov 02 2021 at 15:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/242791-t-infra/topic/musl.20patch.20question/near/260006680">said</a>:</p>
<blockquote>
<p>would be great to not have an out-of-tree patch. Since it's just build system related I'm not too worried though.</p>
</blockquote>
<p>100% agree! I just want to minimize the amount of time this continues to be broken for users.</p>



<a name="260326578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260326578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260326578">(Nov 04 2021 at 20:04)</a>:</h4>
<p>So for hello world, the results look like this:</p>
<table>
<thead>
<tr>
<th></th>
<th>debug</th>
<th>release</th>
<th>release + strip</th>
</tr>
</thead>
<tbody>
<tr>
<td>without musl debuginfo</td>
<td>507kb</td>
<td>495kb</td>
<td>410kb</td>
</tr>
<tr>
<td>with musl debuginfo</td>
<td>874kb</td>
<td>862kb</td>
<td>410kb</td>
</tr>
</tbody>
</table>
<p>It's unfortunate that we do see the ~370kb increase in size but it is just debuginfo and stripping the binary puts us right back to where we are currently (down to the byte). For anyone concerned with binary size, stripping the binary is the first and easiest thing to do so this seems acceptable to me.</p>



<a name="260326637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260326637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260326637">(Nov 04 2021 at 20:04)</a>:</h4>
<p>yeah seems ok</p>



<a name="260326935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260326935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260326935">(Nov 04 2021 at 20:06)</a>:</h4>
<p>Cool! I'll open a PR that contains this patch then and I'll also bump that thread upstream to see if they'll merge it.</p>



<a name="260459426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260459426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260459426">(Nov 05 2021 at 20:20)</a>:</h4>
<p>Would it be possible to make it conditional on debug info?</p>



<a name="260459461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260459461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260459461">(Nov 05 2021 at 20:20)</a>:</h4>
<p>As in, if debug info is enabled, include this too?</p>



<a name="260463824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260463824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260463824">(Nov 05 2021 at 20:58)</a>:</h4>
<p>I think that would mean we'd have to switch which crt artifacts we're linking to depending on <code>-g</code>?</p>



<a name="260463951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260463951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260463951">(Nov 05 2021 at 20:58)</a>:</h4>
<p>Actually, I think we've already statically linked musl into libstd for the x86{,_64} musl targets since they default to static linking right?</p>



<a name="260463972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/musl%20patch%20question/near/260463972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/musl.20patch.20question.html#260463972">(Nov 05 2021 at 20:59)</a>:</h4>
<p>So it's too late to link a different one.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>