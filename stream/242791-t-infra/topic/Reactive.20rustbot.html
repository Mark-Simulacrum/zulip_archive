<html>
<head><meta charset="utf-8"><title>Reactive rustbot · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html">Reactive rustbot</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278541217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278541217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278541217">(Apr 11 2022 at 11:46)</a>:</h4>
<p>The <a class="stream" data-stream-id="247081" href="/#narrow/stream/247081-t-compiler.2Fperformance">#t-compiler/performance</a> team would like to start investigating some potential new ways to help compiler performance that could be automated. For example, we'd like to investigate <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Preventing.20bad.20rollups">limiting rollups based on the contents of the PR</a> (e.g., if a PR changes dependencies then we could consider marking the PR as rollup=never). </p>
<p>I believe the best way to accomplish this would be to extend rustbot/triagebot to be able to respond to more than user input. Any thoughts on the right way to experiment here? Any gotchas I should look out for?</p>



<a name="278542917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278542917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278542917">(Apr 11 2022 at 12:02)</a>:</h4>
<p>Triagebot already receives all GitHub sent webhooks, so it should "just" be a matter of writing the right handler. I'm happy to schedule some time to talk about my recommendations for a design if that's helpful.</p>



<a name="278544260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278544260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278544260">(Apr 11 2022 at 12:16)</a>:</h4>
<p>That sounds good. We can schedule a time in DMs. In the meantime, I can get more familiar with the code.</p>



<a name="278550835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278550835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278550835">(Apr 11 2022 at 13:10)</a>:</h4>
<p><span class="user-mention" data-user-id="224872">@rylev</span> you can probably just copy over <a href="https://github.com/rust-lang/triagebot/blob/master/src/handlers/autolabel.rs">https://github.com/rust-lang/triagebot/blob/master/src/handlers/autolabel.rs</a> to be a separate handler for not just labeling but 'comment writing', with configuration living in rust-lang/rust to the tune of "/Cargo.lock" -&gt; "@bors rollup=never".</p>
<p>We'll also want to make sure bors listens to rustbot for rollup=never; I forget if that's a permissionless command or if rustbot has the right ACL. I think making rollup status permissionless is probably OK, or at least making rustbot special in that regard, so I'd go down that road.</p>
<p>There will be some concern over writing this <em>each</em> time the PR is pushed, since that's noisy; we don't currently have an amazing way of dealing with that. Bors doesn't have an API to tell you the rollup state today of a given PR (though it could, maybe the right approach). Alternatively, you can (a) limit to applying this hook just on PR opens, (b) add a database table tracking this information, (c) use the rustbot "github as a database" support (<a href="https://github.com/rust-lang/triagebot/blob/master/src/interactions.rs#L64">https://github.com/rust-lang/triagebot/blob/master/src/interactions.rs#L64</a>).</p>
<p>I think of these I'd probably say (a) and (c) are the current right approach.</p>



<a name="278550915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278550915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278550915">(Apr 11 2022 at 13:11)</a>:</h4>
<p>It may also make sense for bors to just not provide a rollup checkbox on some PRs; that may be an easier change with less moving parts, though also potentially confusing.</p>



<a name="278555772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278555772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278555772">(Apr 11 2022 at 13:48)</a>:</h4>
<p>yeh we could do only when pr opens (the same way highfive works for assignment + submodules)</p>



<a name="278555894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278555894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278555894">(Apr 11 2022 at 13:49)</a>:</h4>
<p>Well, (c) means we can do it always, it's my preference above (a), particularly for something like this.</p>



<a name="278555950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278555950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278555950">(Apr 11 2022 at 13:49)</a>:</h4>
<p>bors doing this on rollup creation also wouldn't be too hard, but it presents a slightly worse interface to those creating rollups of course.</p>



<a name="278561822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278561822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278561822">(Apr 11 2022 at 14:29)</a>:</h4>
<p>(c) sounds better, especially because it'd allow to switch from <code>rollup=maybe</code> to <code>rollup=never</code> only if someone didn't manually override that (i.e. if the rollup=foo rustbot did set before is different than the one currently set)</p>



<a name="278562073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278562073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278562073">(Apr 11 2022 at 14:30)</a>:</h4>
<p>but that'd hardcode handling rollups rather than a generic "comment if file is changed"</p>



<a name="278573841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278573841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278573841">(Apr 11 2022 at 15:46)</a>:</h4>
<p>Ok cool. I'll take a look into this with approach (c) and see how far I can get.</p>



<a name="278574290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278574290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278574290">(Apr 11 2022 at 15:48)</a>:</h4>
<p>(c) doesn't help hugely with user submission of rollup status change, since that's not tracked by rustbot presumably, if we want that I would have bors expose an API endpoint - which shouldn't be too hard, I suspect.</p>



<a name="278574581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278574581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278574581">(Apr 11 2022 at 15:51)</a>:</h4>
<p>If rustbot only tries to determine rollup elligbility when new code is pushed, then perhaps the correct implementation is to always apply the <code>rollup=never</code> regardless of what user input was previously given.</p>



<a name="278574949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/Reactive%20rustbot/near/278574949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/Reactive.20rustbot.html#278574949">(Apr 11 2022 at 15:53)</a>:</h4>
<p>Yeah, that may be right, I'm just saying that leaving that comment regardless of current state is likely noisy. Maybe we can delete our known state on any user comment in the intervening period, or user comment with bors mentioned.... an API starts looking better though the more I think about it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>