<html>
<head><meta charset="utf-8"><title>libunwind changes and fuchsia · t-infra · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/index.html">t-infra</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html">libunwind changes and fuchsia</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251783581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251783581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251783581">(Sep 02 2021 at 20:45)</a>:</h4>
<p>Hi, I'm trying to figure out how to fix a build breakage in fuchsia caused by <a href="https://github.com/rust-lang/rust/pull/85600">https://github.com/rust-lang/rust/pull/85600</a>. We're unable to generate our prebuilts anymore and get the following error:</p>
<div class="codehilite"><pre><span></span><code>running: &quot;/b/s/w/ir/x/w/cipd/bin/llvm-ar&quot; &quot;cq&quot; &quot;/b/s/w/ir/x/w/staging/build/fuchsia-build/x86_64-unknown-linux-gnu/native/libunwind/libunwind.a&quot; ... &lt;lots snipped out&gt;
exit status: 0
running: &quot;/b/s/w/ir/x/w/cipd/bin/llvm-ar&quot; &quot;s&quot; &quot;/b/s/w/ir/x/w/staging/build/fuchsia-build/x86_64-unknown-linux-gnu/native/libunwind/libunwind.a&quot;
exit status: 0
Building stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
   Compiling cc v1.0.69
   Compiling core v0.0.0 (/b/s/w/ir/x/w/rust/library/core)
   Compiling libc v0.2.99
   Compiling memchr v2.4.1
   Compiling std v0.0.0 (/b/s/w/ir/x/w/rust/library/std)
   Compiling compiler_builtins v0.1.49
   Compiling unwind v0.0.0 (/b/s/w/ir/x/w/rust/library/unwind)
   Compiling profiler_builtins v0.0.0 (/b/s/w/ir/x/w/rust/library/profiler_builtins)
   Compiling rustc-std-workspace-core v1.99.0 (/b/s/w/ir/x/w/rust/library/rustc-std-workspace-core)
   Compiling alloc v0.0.0 (/b/s/w/ir/x/w/rust/library/alloc)
   Compiling cfg-if v0.1.10
   Compiling adler v0.2.3
   Compiling rustc-demangle v0.1.21
   Compiling rustc-std-workspace-alloc v1.99.0 (/b/s/w/ir/x/w/rust/library/rustc-std-workspace-alloc)
   Compiling panic_unwind v0.0.0 (/b/s/w/ir/x/w/rust/library/panic_unwind)
   Compiling panic_abort v0.0.0 (/b/s/w/ir/x/w/rust/library/panic_abort)
   Compiling gimli v0.25.0
   Compiling hashbrown v0.11.0
   Compiling object v0.26.1
   Compiling std_detect v0.1.5 (/b/s/w/ir/x/w/rust/library/stdarch/crates/std_detect)
   Compiling miniz_oxide v0.4.0
   Compiling addr2line v0.16.0
error: linking with `/b/s/w/ir/x/w/cipd/bin/clang++` failed: exit status: 1
  |
  = note: &quot;/b/s/w/ir/x/w/cipd/bin/clang++&quot; &quot;-Wl,--version-script=/b/s/w/ir/x/t/rustcPa9TC3/list&quot; ... &lt;lots snipped out&gt;  = note: ld.lld: error: unable to find library -lunwind
          clang-14: error: linker command failed with exit code 1 (use -v to see invocation)
</code></pre></div>



<a name="251783692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251783692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251783692">(Sep 02 2021 at 20:45)</a>:</h4>
<p>Following the PR comments, I added <code>-Clink-self-contained=yes</code> to <code>RUSTFLAGS</code> in our build env.</p>



<a name="251783843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251783843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251783843">(Sep 02 2021 at 20:47)</a>:</h4>
<p>This gets past stage0, but when building stage1, calls to <code>rustc -vV</code> fail with a seg fault. The binary seems much smaller than normal, at 2.2KB, and lldb and gdb both disagree on the assembly line where the crash occurs.</p>



<a name="251793809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251793809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251793809">(Sep 02 2021 at 22:06)</a>:</h4>
<p>This is fixed by in <a href="https://github.com/rust-lang/rust/pull/88483">https://github.com/rust-lang/rust/pull/88483</a>.</p>



<a name="251793985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251793985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251793985">(Sep 02 2021 at 22:08)</a>:</h4>
<p>Could you actually answer the questions from <a href="https://github.com/rust-lang/rust/pull/88483#issuecomment-908567110">https://github.com/rust-lang/rust/pull/88483#issuecomment-908567110</a> but in application to Fuchsia?</p>



<a name="251794503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251794503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251794503">(Sep 02 2021 at 22:13)</a>:</h4>
<blockquote>
<p>calls to <code>rustc -vV</code> fail with a seg fault. The binary seems much smaller than normal, at 2.2KB, and lldb and gdb both disagree on the assembly line where the crash occurs.</p>
</blockquote>
<p>Ok, this looks worse.<br>
Does <a href="https://github.com/rust-lang/rust/issues/88483">#88483</a> fixes the crash? (That would mean some kind of inconsistent use of <code>-Clink-self-contained</code> in the build, or wrong <code>libunwind.a</code> being found).<br>
If the crash is not fixed, it means <code>libunwind.a</code> is built incorrectly now and we need to figure out what is the difference with the old build.</p>



<a name="251888286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251888286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251888286">(Sep 03 2021 at 14:22)</a>:</h4>
<p>Let me build that change locally and see if it fixes the issue</p>



<a name="251894317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251894317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251894317">(Sep 03 2021 at 15:02)</a>:</h4>
<p>It looks like our builders are starting to pass (faster than my local :D). I'll monitor our test suites to see if this introduces any issues.</p>



<a name="251894414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251894414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251894414">(Sep 03 2021 at 15:03)</a>:</h4>
<p>Do you still want me to get someone to comment on the question? I'm on call this week for the rolls but am not very familiar with what the unwind story looks like in our build.</p>



<a name="251941213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251941213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251941213">(Sep 03 2021 at 20:59)</a>:</h4>
<p>Updating: all of our builds are passing again. Thanks <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> !</p>



<a name="251951829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242791-t-infra/topic/libunwind%20changes%20and%20fuchsia/near/251951829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/242791-t-infra/topic/libunwind.20changes.20and.20fuchsia.html#251951829">(Sep 03 2021 at 22:51)</a>:</h4>
<blockquote>
<p>Do you still want me to get someone to comment on the question?</p>
</blockquote>
<p>Yes, that would be nice, we may want to switch to the alternative scheme from <a href="https://github.com/rust-lang/rust/pull/88483#issuecomment-908584797">https://github.com/rust-lang/rust/pull/88483#issuecomment-908584797</a> in the future.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>