<html>
<head><meta charset="utf-8"><title>`asm!` worse than `llvm_asm!` turning params into immediates · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html">`asm!` worse than `llvm_asm!` turning params into immediates</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="225739967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225739967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225739967">(Feb 09 2021 at 19:01)</a>:</h4>
<p>In <a href="https://rust.godbolt.org/z/Ed6GjP">https://rust.godbolt.org/z/Ed6GjP</a> I have a asm string that when passed constant arguments <code>llvm_asm!</code> is able to inline a constant into the instruction where it's used as an immediate, and <code>asm!</code> is not and instead passes it as a register.</p>
<p>Is there a way to fix this? Will there be? It's not the absolute end of the world, but is disappointing (it's still much better than the manual atomic usage produces...)</p>



<a name="225740991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225740991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225740991">(Feb 09 2021 at 19:08)</a>:</h4>
<p>There is no plan to fix this.</p>



<a name="225741301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225741301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225741301">(Feb 09 2021 at 19:10)</a>:</h4>
<p>I'm trying to find the comment where I talked about this, but this is actually much more complicated than it seems.</p>



<a name="225741526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225741526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225741526">(Feb 09 2021 at 19:12)</a>:</h4>
<p>Instructions have different constraints on what values can be accepted as immediates (e.g. 0-255). This is particularly true for architectures like ARM that have a wide variety of instruction formats (7-bit immediate, 12-bit immediate, etc).</p>



<a name="225741641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225741641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225741641">(Feb 09 2021 at 19:13)</a>:</h4>
<p>We would have to define special operand types for each variant and the complexity quickly gets out of hand.</p>



<a name="225742020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225742020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225742020">(Feb 09 2021 at 19:15)</a>:</h4>
<p>hrm, I see. that sucks... but I guess I mostly care because LLVM doesn't exactly do what I want with the fetch_or, and this is still a win. For places where it matters I can find a way to make it a const — that would work right?</p>



<a name="225742066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225742066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225742066">(Feb 09 2021 at 19:16)</a>:</h4>
<p>Fundamentally <code>asm!</code> is more about enabling users to do things that cannot be done in Rust rather than for maximizing performance.</p>



<a name="225742098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225742098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225742098">(Feb 09 2021 at 19:16)</a>:</h4>
<p>E.g. special instructions, constant-time cryptography</p>



<a name="225742164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225742164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225742164">(Feb 09 2021 at 19:16)</a>:</h4>
<p>Yes, const would work but only with compile-time constants (e.g. const generics).</p>



<a name="225742499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225742499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225742499">(Feb 09 2021 at 19:19)</a>:</h4>
<p>Yeah, that's fine then. I'm a little unconvinced by "asm!" isn't for performance (core::arch exists for the use cases you describe, although in a limited fashion still), but at the end of the day it's not like the output here is atrocious by any stretch.</p>



<a name="225748579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225748579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225748579">(Feb 09 2021 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> Is there a fundamental reason we <em>shouldn't</em> support some common subset cases, even if we don't have complete support for every possible variation?</p>



<a name="225748677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225748677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225748677">(Feb 09 2021 at 20:02)</a>:</h4>
<p>I can understand not supporting "N-bit immediate that must be passed in this specific subset of registers" for every possible variation.</p>



<a name="225748727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225748727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225748727">(Feb 09 2021 at 20:02)</a>:</h4>
<p>The full set of GCC/LLVM constraints is <em>extensive</em>.</p>



<a name="225748774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225748774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225748774">(Feb 09 2021 at 20:03)</a>:</h4>
<p>But supporting a few common cases of immediates doesn't seem out of the question.</p>



<a name="225748849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225748849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225748849">(Feb 09 2021 at 20:03)</a>:</h4>
<p>supporting immediate values seems extremely easy on ARM</p>



<a name="225749014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225749014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225749014">(Feb 09 2021 at 20:04)</a>:</h4>
<p>there is literally like, a list of what instructions allow what immediate ranges. i don't expect a particular person to do it, but it's certainly less work than implementing all of avx-512 for example</p>



<a name="225749118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225749118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225749118">(Feb 09 2021 at 20:05)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> Well, it wouldn't be "what instructions", since that's the assembler's job (which means LLVM's job).</p>



<a name="225749278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225749278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225749278">(Feb 09 2021 at 20:06)</a>:</h4>
<p>well if it has to be an llvm change i guess</p>



<a name="225750059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225750059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225750059">(Feb 09 2021 at 20:11)</a>:</h4>
<p>The support that would be needed in rustc would be to encode immediates in the textual format that LLVM's assembler needs for a given architecture.</p>



<a name="225750500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225750500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225750500">(Feb 09 2021 at 20:14)</a>:</h4>
<p>What you are asking for is fundamentally different from the existing <code>const</code> operand type.</p>



<a name="225750571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225750571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225750571">(Feb 09 2021 at 20:14)</a>:</h4>
<p><code>const</code> only accepts compile-time constants and substitutes the number directly into the asm with no operand modifier (<code>$</code>, <code>#</code>, etc).</p>



<a name="225750688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225750688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225750688">(Feb 09 2021 at 20:15)</a>:</h4>
<p>What you want is a variant of <code>in</code> that can emit a constant with a target-specific modifier in place of a register if that value is a compile-time constant.</p>



<a name="225750702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225750702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225750702">(Feb 09 2021 at 20:16)</a>:</h4>
<p>This would have to be supported through LLVM constraint codes.</p>



<a name="225759159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225759159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225759159">(Feb 09 2021 at 21:19)</a>:</h4>
<p>For many cases, I'd expect that <code>const</code> together with <code>$</code> would suffice.</p>



<a name="225759333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225759333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225759333">(Feb 09 2021 at 21:20)</a>:</h4>
<p>Adding some further support for immediates could potentially catch errors earlier than the assembler, while still allowing people to fall back to <code>const</code> and <code>${}</code> if they want to just pass it through and let LLVM handle it or choke on it.</p>



<a name="225759447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225759447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225759447">(Feb 09 2021 at 21:21)</a>:</h4>
<p>I'm wondering if the cases other than "better error handling" would be handled if we have a mechanism for "potentially const" function definitions.</p>



<a name="225759707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225759707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225759707">(Feb 09 2021 at 21:23)</a>:</h4>
<p>I'm lost, could you give an example for what you are proposing?</p>



<a name="225760041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760041">(Feb 09 2021 at 21:25)</a>:</h4>
<p>So, one case I've commonly seen for "immediate if possible, register if not" in C is static inline functions, where if the compiler <em>can</em> compute the argument at compile time it can then emit an immediate, and if it can't it references the register containing the value.</p>



<a name="225760116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760116">(Feb 09 2021 at 21:25)</a>:</h4>
<p>In Rust, there has been various discussion about being able to define traits and methods and similar that work in both const and non-const contexts.</p>



<a name="225760220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760220">(Feb 09 2021 at 21:26)</a>:</h4>
<p>Which leaves me wondering if it <em>might</em> make sense to handle this in a less automatic, more explicit way.</p>



<a name="225760250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760250">(Feb 09 2021 at 21:26)</a>:</h4>
<p>I don't think that applies here. <code>asm!</code> can only run in a non-const context.</p>



<a name="225760282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760282">(Feb 09 2021 at 21:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates/near/225760250">said</a>:</p>
<blockquote>
<p>I don't think that applies here. <code>asm!</code> can only run in a non-const context.</p>
</blockquote>
<p>I wasn't suggesting it was directly applicable, just analogous.</p>



<a name="225760307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760307">(Feb 09 2021 at 21:26)</a>:</h4>
<p>In this case, the distinction is "is my argument a compile-time constant".</p>



<a name="225760367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760367">(Feb 09 2021 at 21:27)</a>:</h4>
<p>Some kind of compile-time "if this is a compile-time constant, emit X, else emit Y" mechanism could potentially solve this without being <code>asm!</code>-specific.</p>



<a name="225760446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760446">(Feb 09 2021 at 21:27)</a>:</h4>
<p>On the other hand, if that doesn't translate well to LLVM, and it's <em>easier</em> to just map something to a small subset of LLVM constraints that handle this during code generation, perhaps that would make more sense.</p>



<a name="225760462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760462">(Feb 09 2021 at 21:27)</a>:</h4>
<p>I'm trying to brainstorm alternatives.</p>



<a name="225760588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760588">(Feb 09 2021 at 21:28)</a>:</h4>
<p>"if this is a compile-time constant" is only known to LLVM after it has applied optimization including inlining. We're basically limited to what we can express with LLVM's asm constraint codes.</p>



<a name="225760665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760665">(Feb 09 2021 at 21:29)</a>:</h4>
<p>We have no way to control that in rustc.</p>



<a name="225760737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760737">(Feb 09 2021 at 21:29)</a>:</h4>
<p>Got it. Thanks for clarifying that.</p>



<a name="225760842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760842">(Feb 09 2021 at 21:30)</a>:</h4>
<p>So, <code>const</code> for cases where Rust can guarantee compile-time computation, LLVM asm constraints for cases where something doesn't look like a guaranteed constant to Rust but it <em>might</em> end up folding down to a constant after LLVM is through with it?</p>



<a name="225760952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225760952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225760952">(Feb 09 2021 at 21:31)</a>:</h4>
<p>Yes. If ever do support that I would like to keep <code>const </code> as it is right now and use a different syntax for immediates.</p>



<a name="225761009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761009">(Feb 09 2021 at 21:31)</a>:</h4>
<p>Maybe <code>in(imm12, reg)</code> for "try to fit it in a 12-bit immediate, otherwise use a register".</p>



<a name="225761104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761104">(Feb 09 2021 at 21:32)</a>:</h4>
<p>In that case, it seems like we don't really <em>need</em> the various LLVM constraints for "<em>must</em> be an immediate" except perhaps as better error-checking constraints than <code>const</code> (e.g. "must be expressible as an ARM immediate"), and the most useful LLVM constraints would be "register or immediate" (or eventually "memory or register or immediate").</p>



<a name="225761155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761155">(Feb 09 2021 at 21:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates/near/225761009">said</a>:</p>
<blockquote>
<p>Maybe <code>in(imm12, reg)</code> for "try to fit it in a 12-bit immediate, otherwise use a register".</p>
</blockquote>
<p>That seems reasonable, but we'd have to make sure all combinations we support actually map to LLVM constraints.</p>



<a name="225761295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761295">(Feb 09 2021 at 21:33)</a>:</h4>
<p>No, we do need those constraints because we LLVM to fall back to a register if the value is constant but doesn't fit in the instruction's immediate field.</p>



<a name="225761331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761331">(Feb 09 2021 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates/near/225761295">said</a>:</p>
<blockquote>
<p>No, we do need those constraints because we LLVM to fall back to a register if the value is constant but doesn't fit in the instruction's immediate field.</p>
</blockquote>
<p>That'd be an "immediate or register" constraint, though, not an "immediate" constraint, right?</p>



<a name="225761481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761481">(Feb 09 2021 at 21:34)</a>:</h4>
<p>Well LLVM expresses that as a pair of constaints, which it tries one after the other until it finds something that matches.</p>



<a name="225761516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761516">(Feb 09 2021 at 21:35)</a>:</h4>
<p>Ah, I didn't know that. GCC tends to combine the constraints and give names to each combination, AFAICT.</p>



<a name="225761546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761546">(Feb 09 2021 at 21:35)</a>:</h4>
<p>For example <code>"irm"</code> means try an immediate (any size), otherwise a register, otherwise a memory address.</p>



<a name="225761556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761556">(Feb 09 2021 at 21:35)</a>:</h4>
<p>GCC does this too.</p>



<a name="225761717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761717">(Feb 09 2021 at 21:36)</a>:</h4>
<blockquote>
<p>After the prefix, there must be one or more additional constraints (see Constraints) that describe where the value resides. Common constraints include ‘r’ for register and ‘m’ for memory. When you list more than one possible location (for example, "=rm"), the compiler chooses the most efficient one based on the current context. If you list as many alternates as the asm statement allows, you permit the optimizers to produce the best possible code.</p>
</blockquote>



<a name="225761969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225761969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225761969">(Feb 09 2021 at 21:38)</a>:</h4>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html</a></p>



<a name="225791379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225791379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225791379">(Feb 10 2021 at 03:50)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> Ah. I don't tend to see that used very often in practice; usually, I see people using <code>g</code> for instance.</p>



<a name="225791408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225791408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225791408">(Feb 10 2021 at 03:51)</a>:</h4>
<p>I think clang actually expands <code>g</code> to <code>irm</code>.</p>



<a name="225791458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60asm%21%60%20worse%20than%20%60llvm_asm%21%60%20turning%20params%20into%20immediates/near/225791458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60asm!.60.20worse.20than.20.60llvm_asm!.60.20turning.20params.20into.20immediates.html#225791458">(Feb 10 2021 at 03:52)</a>:</h4>
<p>That makes sense.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>