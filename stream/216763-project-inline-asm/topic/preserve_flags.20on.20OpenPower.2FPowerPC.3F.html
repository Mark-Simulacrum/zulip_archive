<html>
<head><meta charset="utf-8"><title>preserve_flags on OpenPower/PowerPC? · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html">preserve_flags on OpenPower/PowerPC?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251290639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251290639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251290639">(Aug 30 2021 at 20:33)</a>:</h4>
<p>I've been trying to port code I have to <code>asm</code> that uses <code>xer</code> and <code>cr</code> clobbers with <code>llvm_asm</code>: I created a pull request to add them as clobber-only registers (along with <code>cr[0-7]</code>), but it occurred to me that maybe we should have some of them under preserve_flags instead...</p>



<a name="251290739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251290739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251290739">(Aug 30 2021 at 20:34)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/88350">https://github.com/rust-lang/rust/pull/88350</a></p>



<a name="251291042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251291042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251291042">(Aug 30 2021 at 20:36)</a>:</h4>
<p>Can you point to any documentation about what those registers contain?</p>



<a name="251291271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251291271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251291271">(Aug 30 2021 at 20:38)</a>:</h4>
<p>Nevermind, found it.</p>



<a name="251291375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251291375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251291375">(Aug 30 2021 at 20:39)</a>:</h4>
<p>I'm thinking <code>cr</code>/<code>cr[0-7]</code> shouldn't be part of <code>preserve_flags</code> because they are independently allocatable registers (in fact, <a href="https://libre-soc.org/openpower/sv/">Libre-SOC's WIP extension SimpleV</a> extends them to <code>cr[0-127]</code> and allows operating on vectors of <code>cr</code> registers). <code>xer</code> being part of <code>preserves_flags</code> is more plausible...</p>



<a name="251291449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251291449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251291449">(Aug 30 2021 at 20:39)</a>:</h4>
<p>I think it's fine to have these as separate clobber-only registers.</p>



<a name="251291528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251291528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251291528">(Aug 30 2021 at 20:40)</a>:</h4>
<p>llvm only handles the carry bit in xer as a register, but marks it non-allocatable</p>



<a name="251291606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251291606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251291606">(Aug 30 2021 at 20:40)</a>:</h4>
<p>all of them, or just <code>cr*</code>?</p>



<a name="251292056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251292056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251292056">(Aug 30 2021 at 20:43)</a>:</h4>
<p>All of them. I'm currently looking at Clang and they also seem to have <code>mq</code>, <code>ap</code>, <code>ctr</code> and <code>lr</code> as available registers.</p>



<a name="251292990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251292990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251292990">(Aug 30 2021 at 20:50)</a>:</h4>
<p>hmm, I don't think we should support mq since that was removed from the spec...</p>



<a name="251293071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251293071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251293071">(Aug 30 2021 at 20:51)</a>:</h4>
<p><a href="https://www.ibm.com/docs/en/aix/7.2?topic=faa-special-purpose-register-changes-special-purpose-register-field-handling">https://www.ibm.com/docs/en/aix/7.2?topic=faa-special-purpose-register-changes-special-purpose-register-field-handling</a></p>



<a name="251294428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294428">(Aug 30 2021 at 21:01)</a>:</h4>
<p>LLVM 13 fixed <code>lr</code> clobbering but I think <code>ctr</code> clobbering still isn't handled correctly.</p>



<a name="251294643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294643">(Aug 30 2021 at 21:02)</a>:</h4>
<p>I wasn't able to find docs on ap</p>



<a name="251294682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294682">(Aug 30 2021 at 21:03)</a>:</h4>
<p>Let's just ignore it then.</p>



<a name="251294698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294698">(Aug 30 2021 at 21:03)</a>:</h4>
<p>it isn't in <a href="https://github.com/llvm/llvm-project/blob/main/llvm/lib/Target/PowerPC/PPCRegisterInfo.td">https://github.com/llvm/llvm-project/blob/main/llvm/lib/Target/PowerPC/PPCRegisterInfo.td</a></p>



<a name="251294716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294716">(Aug 30 2021 at 21:03)</a>:</h4>
<p>Can you do some quick tests on godbolt to check that CR/XER clobbering works correctly?</p>



<a name="251294724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294724">(Aug 30 2021 at 21:03)</a>:</h4>
<p>Just test it in clang.</p>



<a name="251294898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294898">(Aug 30 2021 at 21:04)</a>:</h4>
<p>for xer, it's really hard to test since it's hard to get something that needs xer...</p>



<a name="251294987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251294987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251294987">(Aug 30 2021 at 21:05)</a>:</h4>
<p>or, do you just mean checking that xer shows up in llvm ir?</p>



<a name="251295304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251295304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251295304">(Aug 30 2021 at 21:08)</a>:</h4>
<p>Just check CR clobbering then. Check that the LLVM properly spills the CR value across an asm when it is used later.</p>



<a name="251295878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251295878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251295878">(Aug 30 2021 at 21:12)</a>:</h4>
<p><a href="https://gcc.godbolt.org/z/15PvG6G61">https://gcc.godbolt.org/z/15PvG6G61</a></p>



<a name="251295902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251295902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251295902">(Aug 30 2021 at 21:12)</a>:</h4>
<p>it properly spills cr4</p>



<a name="251296005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251296005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251296005">(Aug 30 2021 at 21:13)</a>:</h4>
<p>some other cr*  registers are callee-saved so no save/restore code should be generated</p>



<a name="251296007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251296007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251296007">(Aug 30 2021 at 21:13)</a>:</h4>
<p>LGTM</p>



<a name="251296120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251296120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251296120">(Aug 30 2021 at 21:14)</a>:</h4>
<p>One potential concern is whether we should have <code>cr</code>. Just exposing the individual <code>cr*</code> should be enough.</p>



<a name="251296806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251296806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251296806">(Aug 30 2021 at 21:19)</a>:</h4>
<p>well, often you need to clobber the whole register (such as when using  the <code>mtcr</code> instruction)...listing all 8 cr fields gets repetitive</p>



<a name="251297073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251297073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251297073">(Aug 30 2021 at 21:21)</a>:</h4>
<p>the PR i made has <code>cr</code> conflict with <code>cr[0-7]</code>, so we shouldn't have confusing clobbers like <code>out("cr") _, out("cr3") _</code></p>



<a name="251299512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/preserve_flags%20on%20OpenPower/PowerPC%3F/near/251299512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/preserve_flags.20on.20OpenPower.2FPowerPC.3F.html#251299512">(Aug 30 2021 at 21:41)</a>:</h4>
<p>though, if we were to add clobbering register ranges, I'd be fine removing <code>cr</code> in favor of <code>"cr0"..="cr7"</code>:<br>
<a href="#narrow/stream/216763-project-inline-asm/topic/clobbering.20register.20ranges">https://rust-lang.zulipchat.com/#narrow/stream/216763-project-inline-asm/topic/clobbering.20register.20ranges</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>