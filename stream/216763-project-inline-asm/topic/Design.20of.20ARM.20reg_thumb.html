<html>
<head><meta charset="utf-8"><title>Design of ARM reg_thumb · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html">Design of ARM reg_thumb</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251160939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251160939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251160939">(Aug 29 2021 at 22:01)</a>:</h4>
<p>The chart for what register classes mean on what targets says:</p>
<table>
<thead>
<tr>
<th align="left">Arch</th>
<th align="left">Class</th>
<th align="left">Registers</th>
<th align="left">LLVM Code</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">ARM</td>
<td align="left"><code>reg</code></td>
<td align="left">r[0-12], r14</td>
<td align="left"><code>r</code></td>
</tr>
<tr>
<td align="left">ARM (Thumb)</td>
<td align="left"><code>reg_thumb</code></td>
<td align="left">r[0-r7]</td>
<td align="left"><code>l</code></td>
</tr>
<tr>
<td align="left">ARM (ARM)</td>
<td align="left"><code>reg_thumb</code></td>
<td align="left">r[0-r12], r14</td>
<td align="left"><code>l</code></td>
</tr>
</tbody>
</table>
<p>Question: <code>reg</code> works on Thumb targets, so should I be worried that it'll potentially assign me a high register in my thumb code?</p>
<p>Question 2: If the answer is "yes" then why don't thumb targets default to only using the correct registers? If the answer is "no" then what's the point of <code>reg_thumb</code> at all?</p>



<a name="251168567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251168567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251168567">(Aug 30 2021 at 00:10)</a>:</h4>
<p>1) Yes<br>
2) Some thumb instructions can use all registers, some can only use <code>r[0-7]</code>.</p>



<a name="251174563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174563">(Aug 30 2021 at 02:01)</a>:</h4>
<p>I am aware that some instructions can use high registers, but that's just (approximately) three operations among the (approximately) nineteen that the CPU offers in Thumb code. You would never ever want to be handed a high register on accident in thumb code the same as you would never want to be handed <code>pc</code> or <code>sp</code> on accident even though you can access them in the assembly block.</p>



<a name="251174672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174672">(Aug 30 2021 at 02:02)</a>:</h4>
<p>Also that only applies to Thumb1. Thumb2 has 32-bit encodings for all Thumb1 instructions that accept the full set of registers.</p>



<a name="251174780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174780">(Aug 30 2021 at 02:04)</a>:</h4>
<p>Sure, but since Rust does support Thumb 1 devices, on at least those devices the default for <code>reg</code> should be a low register only.</p>



<a name="251174808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174808">(Aug 30 2021 at 02:05)</a>:</h4>
<p>I don't mean to bring this up so close to stabilization, but this really is kinda a footgun if you're doing Thumb 1 programming.</p>



<a name="251174828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174828">(Aug 30 2021 at 02:05)</a>:</h4>
<p>and I only noticed it today, because in the past I assumed that <code>reg</code> was just "give me any <em>useful</em> register" and that the compiler would know what i mean.</p>



<a name="251174838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174838">(Aug 30 2021 at 02:05)</a>:</h4>
<p>I suppose we could swap the definitions around so <code>reg</code> is r0-r7 on thumb and have a separate register class for the full set. Not sure what to name it though.</p>



<a name="251174932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174932">(Aug 30 2021 at 02:07)</a>:</h4>
<p>I just woke up from a nap but my first inclination is:<br>
<code>reg</code> is r0-r7 on thumb1 and r0-r12/r14 on thumb2 or arm<br>
<code>reg_any</code> is r0-r12/r14 even in thumb1</p>



<a name="251174991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251174991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251174991">(Aug 30 2021 at 02:08)</a>:</h4>
<p>and if you want to specify only a low register even on thumb 2, <code>reg_low</code> perhaps</p>



<a name="251175047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175047">(Aug 30 2021 at 02:09)</a>:</h4>
<p>LLVM only exposes <code>l</code> and <code>r</code> constraints that we can use here.</p>



<a name="251175058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175058">(Aug 30 2021 at 02:09)</a>:</h4>
<p><a href="https://llvm.org/docs/LangRef.html#constraint-codes">https://llvm.org/docs/LangRef.html#constraint-codes</a></p>



<a name="251175134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175134">(Aug 30 2021 at 02:10)</a>:</h4>
<p>Oh actually it seems that <code>r</code> is already r0-r7 in Thumb1 mode.</p>



<a name="251175189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175189">(Aug 30 2021 at 02:12)</a>:</h4>
<p>ah, so just the docs on the Rust side need a fix then</p>



<a name="251175269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175269">(Aug 30 2021 at 02:13)</a>:</h4>
<p>Problem is that now the register set depends on whether the <code>thumb2</code> target feature is enabled...</p>



<a name="251175274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175274">(Aug 30 2021 at 02:13)</a>:</h4>
<p>potentially a shame that we can't allocate registers on our side of things and thus break free of LLVM's grip, but i do understand the complexity there, and the performance fails when two separate groups are each doing part of the register allocation</p>



<a name="251175278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175278">(Aug 30 2021 at 02:13)</a>:</h4>
<p>Which is why I originally specified <code>reg</code> so generally.</p>



<a name="251175643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175643">(Aug 30 2021 at 02:20)</a>:</h4>
<p>Also I just checked and GCC treats <code>r</code> as the full set of registers, even in Thumb1 mode.</p>



<a name="251175697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/251175697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#251175697">(Aug 30 2021 at 02:20)</a>:</h4>
<p>we could call them <code>reg</code>, <code>reg_lo</code>, and <code>reg_hi</code>, but since <code>reg_hi</code> maps to the low registers anyway in thumb1, maybe reject the register class from thumb1</p>



<a name="256393897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256393897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256393897">(Oct 06 2021 at 11:17)</a>:</h4>
<p>I've been thinking about this and in the end I stand by my original decision to have <code>reg</code> return any register <code>r0-r12/r14</code>. It is what you would expect on ARM (give me any register) and what GCC/Clang's <code>r</code> constraint does.</p>



<a name="256393921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256393921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256393921">(Oct 06 2021 at 11:17)</a>:</h4>
<p>For low registers, I'm open to renaming <code>reg_thumb</code> to <code>reg_low</code>, but I'm still unsure about this.</p>



<a name="256393991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256393991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256393991">(Oct 06 2021 at 11:18)</a>:</h4>
<p>My main concern is that in ARM mode <code>reg_thumb</code> will still return any register <code>r0-r12/r14</code> since that's what the LLVM <code>l</code> constraint does.</p>



<a name="256428757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256428757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256428757">(Oct 06 2021 at 15:18)</a>:</h4>
<p>If I'm writing T32 code for a Thumb1 target there is absolutely no justification for "reg", the default register class, to offer me up <code>r8</code>. It's simply not usable to me with any normal instruction. It's exactly as unusable as <code>pc</code>, and <code>lr</code>, and <code>cpsr</code>.</p>



<a name="256428927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256428927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256428927">(Oct 06 2021 at 15:19)</a>:</h4>
<p>Specifically, it is <em>not</em> usable by simply having some two-u16 instruction instead of a single u16.</p>



<a name="256428948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256428948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256428948">(Oct 06 2021 at 15:19)</a>:</h4>
<p>AFAIK you can use it with <code>add</code> and <code>mov</code>, and that's about it.</p>



<a name="256429148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256429148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256429148">(Oct 06 2021 at 15:21)</a>:</h4>
<p>Why can't you just use <code>reg_thumb</code> in that case then?</p>



<a name="256429516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256429516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256429516">(Oct 06 2021 at 15:23)</a>:</h4>
<p>I still think <code>reg</code> is still a good default since it is the most general register class.</p>



<a name="256429638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256429638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256429638">(Oct 06 2021 at 15:23)</a>:</h4>
<p>it is possible to write out "reg_thumb", but less ergonomic.</p>
<p>let me reverse the question: when the entire program is Thumb1 by default because of the target why can't the default register group just do the right thing automatically?</p>



<a name="256429831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256429831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256429831">(Oct 06 2021 at 15:24)</a>:</h4>
<p>I see absolutely zero programmer benefits to the compiler being able to accidentally select an invalid register</p>



<a name="256429996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256429996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256429996">(Oct 06 2021 at 15:25)</a>:</h4>
<p>if you need a high register you can just specify a high register in that exceptional situation.</p>



<a name="256430004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256430004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256430004">(Oct 06 2021 at 15:25)</a>:</h4>
<p>Because then I'd need to add another register class just for "the full register set"</p>



<a name="256430054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256430054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256430054">(Oct 06 2021 at 15:25)</a>:</h4>
<p>...then please do?</p>



<a name="256430160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256430160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256430160">(Oct 06 2021 at 15:26)</a>:</h4>
<p>there's already like 30 of them it's a very small delta to add one more</p>



<a name="256430321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256430321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256430321">(Oct 06 2021 at 15:27)</a>:</h4>
<p>also, i would like to point out that "we would need to change the compiler some" is not a programmer benefit.</p>



<a name="256430498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256430498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256430498">(Oct 06 2021 at 15:28)</a>:</h4>
<p>IMO having the definition of <code>reg</code> change within the same target is already quite a lot of complexity. And I'm still concerned about the precedent from GCC where <code>r</code> gives the full set of register even on thumb1 targets.</p>



<a name="256431040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256431040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256431040">(Oct 06 2021 at 15:31)</a>:</h4>
<p>do you mean between A32 and T32 mode on a target with interworking?</p>



<a name="256432166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432166">(Oct 06 2021 at 15:38)</a>:</h4>
<p>Yes there's that but also in general I feel that it is much clearer for a register class to have a single meaning in a target.</p>



<a name="256432286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432286">(Oct 06 2021 at 15:38)</a>:</h4>
<p>Hmm then again there is a precedent for doing this in RISC-V with the E feature which disables <code>x16</code>-<code>x31</code>.</p>



<a name="256432407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432407">(Oct 06 2021 at 15:39)</a>:</h4>
<p>I think you're in the best position to figure out what is the right thing to do here, so I'll defer to you. Would you be interested in making a PR to fix <code>reg</code>/<code>reg_thumb</code> on ARM targets?</p>



<a name="256432646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432646">(Oct 06 2021 at 15:40)</a>:</h4>
<p>I suppose I could do a PR. It's mostly editing some sort of list of stuff that a macro expands out I'm assuming?</p>



<a name="256432717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432717">(Oct 06 2021 at 15:41)</a>:</h4>
<p>Yes, essentially.</p>



<a name="256432755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432755">(Oct 06 2021 at 15:41)</a>:</h4>
<p>And adjusting the tests in src/test/assembly/asm accordingly.</p>



<a name="256432778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432778">(Oct 06 2021 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb/near/256432286">said</a>:</p>
<blockquote>
<p>Hmm then again there is a precedent for doing this in RISC-V with the E feature which disables <code>x16</code>-<code>x31</code>.</p>
</blockquote>
<p>Technically by RISC-V spec, E is base spec not an extension. So RV32I, RV64I and RV32E are distinct base ISAs</p>



<a name="256432876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256432876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256432876">(Oct 06 2021 at 15:42)</a>:</h4>
<p>Sure, but in LLVM it's implemented as a target feature and we sort of just went along with that.</p>



<a name="256433248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256433248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256433248">(Oct 06 2021 at 15:44)</a>:</h4>
<p>I think RV32E and Thumb are quite different. On RV32E x16-x31 are just non-existent, but IIRC on Thumb r8-r12 still exists.</p>



<a name="256433430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256433430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256433430">(Oct 06 2021 at 15:45)</a>:</h4>
<p>So I think reg returning r8-r12 is okay</p>



<a name="256433444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256433444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256433444">(Oct 06 2021 at 15:45)</a>:</h4>
<p>I think that <code>reg</code> should always give a default usable register, in all situations, all the time. That's simply the convention we pick for ourselves in life, even regardless of what other compilers do.</p>
<p>And then we can have register groups for specific situations when non-default groups are what you'd want.</p>
<p>In other words:<br>
Thumb1: r0-r7<br>
Thumb2 or ARM: r0-r12,r14</p>



<a name="256433704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256433704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256433704">(Oct 06 2021 at 15:47)</a>:</h4>
<blockquote>
<p>So I think reg returning r8-r12 is okay</p>
</blockquote>
<p>it is not allowed, at all, to use r8 and above with most ops in thumb1. It will just turn into a compiler error.</p>



<a name="256434266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/256434266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#256434266">(Oct 06 2021 at 15:49)</a>:</h4>
<p>Specifically, MOV, CMP, and ADD can access high registers. All other operations cannot.</p>



<a name="257093143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/257093143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#257093143">(Oct 11 2021 at 17:16)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> I remember that a few days ago you wanted me to do a PR in this area, but reviewing the thread it doesn't seem to have a clear consensus of what the PR would do specifically</p>



<a name="257105949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/257105949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#257105949">(Oct 11 2021 at 19:19)</a>:</h4>
<p>Yea I still have a preference for the current behavior, despite your arguments.</p>



<a name="257144870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Design%20of%20ARM%20reg_thumb/near/257144870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Design.20of.20ARM.20reg_thumb.html#257144870">(Oct 12 2021 at 03:34)</a>:</h4>
<p>I think your intended design works fine for ARM and thumb2, but is just a broken design for thumb1 code. It should absolutely not be possible for <code>orr {reg}, #1</code> to ever end up selecting to use a register that's not actually allowed, which is what could happen if <code>reg</code> for thumb1 included registers above r7.</p>
<p>LLVM already works in the style I'm suggesting. Rust's <code>reg</code> class maps to the <code>r</code> constraint, which gives only r0 to r7 with Thumb1 code (<a href="https://llvm.org/docs/LangRef.html#supported-constraint-code-list">docs</a>).</p>
<p>So basically we have two choices:<br>
1) Rust can adjust the intent/docs to match what LLVM already does. I could do this if you want, I just need to change a markdown file.<br>
2) Rust can try to fight against LLVM and make thumb1 have the same register selection as thumb2 and ARM. With this path, not only am I not able to do it for lack of LLVM knowledge, but I wouldn't do it even if I could, because I think it's a bad idea that would hurt my own Rust projects (and any other thumb1 users).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>