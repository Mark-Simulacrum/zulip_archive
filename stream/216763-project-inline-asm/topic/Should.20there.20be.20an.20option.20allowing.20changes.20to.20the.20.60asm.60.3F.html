<html>
<head><meta charset="utf-8"><title>Should there be an option allowing changes to the `asm`? · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html">Should there be an option allowing changes to the `asm`?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264445588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264445588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264445588">(Dec 10 2021 at 13:21)</a>:</h4>
<p>Another question, this is more hypothetical. The rules are very explicit that the compiler is forbidden from even peeking inside <code>asm!</code>:</p>
<blockquote>
<p>The compiler cannot assume that the instructions in the asm are the ones that will actually end up executed.</p>
<ul>
<li>This effectively means that the compiler must treat the <code>asm!</code> as a black box and only take the interface specification into account, not the instructions themselves.</li>
<li>Runtime code patching is allowed, via target-specific mechanisms (outside the scope of this RFC).</li>
</ul>
</blockquote>
<p>So FWIW, I'm extremely glad this is present, on by default, and defined in a very robust way — it is hard to imagine even the bravest compiler touching it when runtime patching is allowed.</p>
<p>That said... I don't always need to do something tricky. I might just need to use an instruction with no intrinsic, or to futz with some register that has no high level equivalent. So, I'm wondering if there's intention to add a flag that allows a compiler to parse/optimize the asm (specifcally, to apply some form of "as-if" rule).</p>
<p>I believe GCC (perhaps Clang? IDR) will do some minor optimizations to non-volatile inline asm, such as constant propagation, using a better addressing mode (for example combining pointer arithmetic from outside the asm with a load/store from inside the asm), and that sort of thing.</p>
<p>There doesn't seem to be a flag that corresponds to telling the compiler this kind of thing is okay (unless I'm mistaken?)</p>



<a name="264445833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264445833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264445833">(Dec 10 2021 at 13:23)</a>:</h4>
<p>Admittedly, most of the time the current behavior is nice, and it's never actually <em>wrong</em>.</p>



<a name="264446393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446393">(Dec 10 2021 at 13:27)</a>:</h4>
<p>For example: I notice that there's no support for a <code>mem</code> operand types (like <code>m</code> in classic C-style inline asm) — maybe we'll eventually get something like that... but in some cases it might not be needed if there were a way for less tricky asm blocks to untie the compiler's hands a little bit more... perhaps, anyway.</p>



<a name="264446485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446485">(Dec 10 2021 at 13:27)</a>:</h4>
<p>Neither GCC nor Clang will optimize anything in inline asm. The addressing mode thing is done with special operand constraints which allow memory operands.</p>



<a name="264446498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446498">(Dec 10 2021 at 13:27)</a>:</h4>
<p>Hmm, I see</p>



<a name="264446611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446611">(Dec 10 2021 at 13:28)</a>:</h4>
<p>All that does is change what the compiler is allowed to substitute in for an operand. It doesn't look at the actual assembly text.</p>



<a name="264446664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446664">(Dec 10 2021 at 13:29)</a>:</h4>
<p>I'm almost certain i've seen stuff like constant numbers passed functions with inline asm in the body turned into instructions that use those constants as immediates — that's what I meant by constant propagation</p>



<a name="264446730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446730">(Dec 10 2021 at 13:29)</a>:</h4>
<p>I guess I did imagine it went further than that, though.</p>



<a name="264446822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446822">(Dec 10 2021 at 13:30)</a>:</h4>
<p>That's done with multi-operand constraints in C: <code>"irm"</code> means try to encode this operand as an immediate, otherwise as a register, otherwise as a memory addressing mode. We don't support that.</p>



<a name="264446840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264446840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264446840">(Dec 10 2021 at 13:30)</a>:</h4>
<p>Hmmm</p>



<a name="264447034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Should%20there%20be%20an%20option%20allowing%20changes%20to%20the%20%60asm%60%3F/near/264447034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Should.20there.20be.20an.20option.20allowing.20changes.20to.20the.20.60asm.60.3F.html#264447034">(Dec 10 2021 at 13:31)</a>:</h4>
<p>That'd be a bit surprising, since I've never used <code>i</code> (I believe I just learned about it right now), but it was a while ago and I could be wrong about something or another.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>