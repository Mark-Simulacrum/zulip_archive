<html>
<head><meta charset="utf-8"><title>register specifiers for ARM swp · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html">register specifiers for ARM swp</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255967248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967248">(Oct 03 2021 at 17:47)</a>:</h4>
<p>Hello, I'd like to make sure that I'm providing the maximally flexible register declarations for the ARM <code>swp</code> instruction.<br>
In this case, the general use is like this: <code>swp  dest, src, [address]</code>.</p>
<ul>
<li>address is read to dest</li>
<li>src is written to address</li>
<li>if src and address are equal then it's a perfect swap, neither value is lost.</li>
<li>the output register must <em>not</em> be the address register</li>
</ul>
<p>currently I have the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">a32_swp</span><span class="p">(</span><span class="n">val</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">out</span>: <span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s">"swp {x}, {x}, [{address}]"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inout</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">options</span><span class="p">(</span><span class="n">nostack</span><span class="p">,</span><span class="w"> </span><span class="n">preserves_flags</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">out</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>However, I'm not clear how I would use register specifiers to write it so that the src and destination registers are allowed to possibly be the same without allowing the compiler to assign the address register as the destination (which is illegal).</p>



<a name="255967356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967356">(Oct 03 2021 at 17:49)</a>:</h4>
<p>I don't think it's possible.</p>



<a name="255967359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967359">(Oct 03 2021 at 17:49)</a>:</h4>
<p>Let me double check to be sure.</p>



<a name="255967437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967437">(Oct 03 2021 at 17:50)</a>:</h4>
<p>Yea I don't think it's possible to express what you want.</p>



<a name="255967469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967469">(Oct 03 2021 at 17:50)</a>:</h4>
<p>If it's not possible that's fine, I just wanted to make sure that I wasn't missing something somehow.</p>



<a name="255967487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967487">(Oct 03 2021 at 17:51)</a>:</h4>
<p>Related: excellent work that inline asm interacts properly with the <code>instruction_set</code> attribute</p>



<a name="255967504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967504">(Oct 03 2021 at 17:51)</a>:</h4>
<p>I'm not fully sure it does with inlining.</p>



<a name="255967516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967516">(Oct 03 2021 at 17:51)</a>:</h4>
<p>it does not, but also that's correct anyway</p>



<a name="255967565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967565">(Oct 03 2021 at 17:52)</a>:</h4>
<p>Also I'd like to resolve the <code>reg_thumb</code> situation before stabilizing.</p>



<a name="255967988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255967988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255967988">(Oct 03 2021 at 17:59)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> could you remind me of what's the problem with reg_thumb? My memory is that it all worked out basically like how i expected it to work.</p>



<a name="255968091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255968091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255968091">(Oct 03 2021 at 18:00)</a>:</h4>
<p>When compiling for any target "reg" should be a general purpose register (assuming the target has those), and so when compiling for thumb1 then "reg" should be naturally limited to r0-r7.</p>



<a name="255968307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255968307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255968307">(Oct 03 2021 at 18:03)</a>:</h4>
<p>Would <code>address = inlateout(reg) ptr =&gt; _</code> work?</p>



<a name="255971744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/register%20specifiers%20for%20ARM%20swp/near/255971744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/register.20specifiers.20for.20ARM.20swp.html#255971744">(Oct 03 2021 at 18:59)</a>:</h4>
<p>That would work, but it would also unfortunately mark the address register as being clobbered. This might cause LLVM to insert an extra move instruction to preserve the value in another register that isn't clobbered.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>