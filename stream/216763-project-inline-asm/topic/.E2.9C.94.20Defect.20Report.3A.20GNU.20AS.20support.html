<html>
<head><meta charset="utf-8"><title>✔ Defect Report: GNU AS support · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html">✔ Defect Report: GNU AS support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269354647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269354647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269354647">(Jan 26 2022 at 02:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119239">sky d</span> has marked this topic as resolved.</p>



<a name="269358546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269358546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269358546">(Jan 26 2022 at 03:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support/near/269323624">said</a>:</p>
<blockquote>
<p>They mentioned wanting to avoid an LLVM dependency, so that sounds like not really an ideal option. That said, I think in practice its not as bad as they're making it out. It clearly doesn't need to be bug compatible (the amount of Rust code using asm in the wild is not <em>that</em> large, and probably wont grow to be), and in practice failing to support directives (at least when no external assembler is present) is probably an option, at least at first.</p>
</blockquote>
<p>The llvm dependency is also a non-starter, due to cmake's poor cross-compiling story.</p>



<a name="269358705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269358705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269358705">(Jan 26 2022 at 03:41)</a>:</h4>
<p>I'l  do what I can, though. Most of this is exagerated (I do not yet know how difficult or easy some parts will be), mostly because of timing. It's easier to leave it not-guaranteed early, then increase guarantees later than it is to reverse course after the fact.</p>



<a name="269359867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269359867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269359867">(Jan 26 2022 at 04:00)</a>:</h4>
<p>iirc google's been working on adding bazel support to llvm, it may cross-compile more easily if you use bazel to build it...idk though, i've never looked into bazel</p>



<a name="269360006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360006">(Jan 26 2022 at 04:02)</a>:</h4>
<p><a href="https://github.com/llvm/llvm-project/tree/main/utils/bazel">https://github.com/llvm/llvm-project/tree/main/utils/bazel</a></p>



<a name="269360103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360103">(Jan 26 2022 at 04:03)</a>:</h4>
<p>Nice. I'd still avoid it if at all possible -especially for one argubly minor portion. The submodule is massive and several minutes worth of cloning.</p>



<a name="269360226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360226">(Jan 26 2022 at 04:04)</a>:</h4>
<p>one other option maybe worth considering is compiling binutils to run inside a wasm/wasi runtime -- you may end up needing a wasm runtime anyway for the isolated proc-macros that are maybe getting added to rustc</p>



<a name="269360362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360362">(Jan 26 2022 at 04:06)</a>:</h4>
<p>That wouldn't work if the <code>--build</code> system is windows-msvc, I don't think.</p>



<a name="269360386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360386">(Jan 26 2022 at 04:07)</a>:</h4>
<p>(Also gets excessive when you have n+1 supported targets)</p>



<a name="269360389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360389">(Jan 26 2022 at 04:07)</a>:</h4>
<p>some very cursory googling led to <a href="https://www.npmjs.com/package/wasm-binutils-arm-linux">https://www.npmjs.com/package/wasm-binutils-arm-linux</a></p>



<a name="269360511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360511">(Jan 26 2022 at 04:09)</a>:</h4>
<p>with wasm you'd only need one binary for every supported target, no matter what platform your building on...</p>



<a name="269360645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360645">(Jan 26 2022 at 04:11)</a>:</h4>
<p>binutils only supports one target arch per binary anyway iirc, so if you want to target msvc-x86 and ppc-linux you'd need two binaries...but those two wasm binaries can run on any host</p>



<a name="269360722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269360722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269360722">(Jan 26 2022 at 04:12)</a>:</h4>
<p>Yeah, if you're starting anything new that you have to do non-trivial architectural work on anyway, it seems preferable to avoid the gcc/binutils limitation of "one target per binary" if at all possible, and use some other base that doesn't have that fundamental limitation.</p>



<a name="269362880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269362880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269362880">(Jan 26 2022 at 04:41)</a>:</h4>
<p>Yeah, that's ideal to avoid, especially since the project is designed to avoid that legacy problem.<br>
Going for internal is probably the best bet, the question is how much can be supported easily.</p>



<a name="269378862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269378862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269378862">(Jan 26 2022 at 08:55)</a>:</h4>
<p>I feel that in practice what we say in the spec won't matter much in practice: in the end people will end up using assembler directives since we don't restrict them on the rustc side. You'll end up in a similar situation to Clang having to catch up to GCC in terms of niche features to be able to compile GNU C codebases like the Linux kernel.</p>



<a name="269454163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269454163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269454163">(Jan 26 2022 at 17:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support/near/269378862">said</a>:</p>
<blockquote>
<p>I feel that in practice what we say in the spec won't matter much in practice: in the end people will end up using assembler directives since we don't restrict them on the rustc side.</p>
</blockquote>
<p>What if you did? I agree with Connor that this is a spec nightmare. You should start with a small subset and work your way out to stabilizing more obscure features, not just accept everything and "accidentally" stabilize all of the undocumented quirks of GNU <code>as</code> as part of the rust specification. This is a pattern that has paid off many times in rust history, and it's not clear why asm needs to be so completely opposed in design</p>



<a name="269454858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269454858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269454858">(Jan 26 2022 at 18:02)</a>:</h4>
<p>An asm macro that just passes things directly to LLVM sounds useful for some applications but also sounds like it should be perma-unstable</p>



<a name="269455196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269455196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269455196">(Jan 26 2022 at 18:04)</a>:</h4>
<p>The RFC specifically explains why we don't want to try to validate the assembly code in rustc: <a href="https://rust-lang.github.io/rfcs/2873-inline-asm.html#validate-the-assembly-code-in-rustc">https://rust-lang.github.io/rfcs/2873-inline-asm.html#validate-the-assembly-code-in-rustc</a></p>



<a name="269462557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269462557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269462557">(Jan 26 2022 at 18:55)</a>:</h4>
<p>Isn't it pretty easy to separate directives from instructions? It's already mostly line by line, and the directives start with a <code>.</code></p>



<a name="269462644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269462644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269462644">(Jan 26 2022 at 18:55)</a>:</h4>
<p>you don't have to actually understand any assembly instructions at all</p>



<a name="269463725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269463725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269463725">(Jan 26 2022 at 19:02)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> I recall there being some issues that make it more difficult than just looking for <code>.</code> at the start of a line.</p>



<a name="269463796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269463796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269463796">(Jan 26 2022 at 19:02)</a>:</h4>
<p>Line continuations, comments, something like that.</p>



<a name="269464478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269464478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269464478">(Jan 26 2022 at 19:06)</a>:</h4>
<p>Sure, I don't imagine it would be done in an hour, but I bet it could be done within a fairly short period. And it's largely a one time cost to build, the actual syntax of assembly doesn't change much over the years.</p>



<a name="269464606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269464606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269464606">(Jan 26 2022 at 19:07)</a>:</h4>
<p>And I'm not saying it absolutely must be done  but the amount of effort seems a little exaggerated when we're talking about a language stabilization.</p>



<a name="269662986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269662986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269662986">(Jan 28 2022 at 00:23)</a>:</h4>
<p>I think that any implementation that calls out to any assembler that is not built into the compiler is inherently incompatible with the goals of the RFC as written.</p>
<blockquote>
<p>The intent is that support for asm! should be independent of the rustc back-end used: it should always work, but with lower performance if the backend does not support inline assembly.<br>
This is at odds with any implementation besides an asm parser that is part of rustc and conforms to some specific syntax per target.</p>
</blockquote>
<p>The previous sentence in the RFC is</p>
<blockquote>
<p>If a back-end does not support inline assembly natively then we can fall back to invoking an external assembler.<br>
Which also conflicts with the goal to be backend independent, since any external tools are effectively part of the back-end codegen. So this may be an issue with the RFC as written rather than an implementation issue.</p>
</blockquote>
<p>I think that the only correct implementation that can allow Rust to have <code>asm!</code> that doesn't rely on an exact back-end toolset is to parse the asm and emit the instructions completely via the compiler.  I don't know how rustc can accomplish that, whether it can make an object file and link it in or however that works, but I think it is required that the compiler be an assembly parser to allow asm to be backend independent.</p>
<p><a href="https://rust-lang.github.io/rfcs/2873-inline-asm.html#supporting-back-ends-without-inline-assembly">relevant rfc section</a></p>



<a name="269663520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Defect%20Report%3A%20GNU%20AS%20support/near/269663520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Defect.20Report.3A.20GNU.20AS.20support.html#269663520">(Jan 28 2022 at 00:28)</a>:</h4>
<p>However I think it is important that GNU AS-like syntax is supported because a lot of the directives are used by people and people expect to be able to <code>(global_)asm!(include_str!("file.s"))</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>