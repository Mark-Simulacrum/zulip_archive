<html>
<head><meta charset="utf-8"><title>Can nostack be specified if the stack just doesn&#x27;t need t... · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html">Can nostack be specified if the stack just doesn&#x27;t need t...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254769932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254769932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254769932">(Sep 24 2021 at 20:46)</a>:</h4>
<p>If an inline assembly block uses the stack, but without requiring the full ABI alignment (eg: to temporarily push one value), can it specify <code>nostack</code> in this case if the target is known to not use the red zone?</p>



<a name="254770146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254770146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254770146">(Sep 24 2021 at 20:48)</a>:</h4>
<p>idk, but the red zone might just apply to calls, not inline asm</p>



<a name="254770187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254770187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254770187">(Sep 24 2021 at 20:48)</a>:</h4>
<p>I could be wrong though</p>



<a name="254770246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254770246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254770246">(Sep 24 2021 at 20:48)</a>:</h4>
<p>My answer would be it's okay, not specifying nostack wouldn't hurt.</p>



<a name="254770284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254770284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254770284">(Sep 24 2021 at 20:49)</a>:</h4>
<p>No, you can't use <code>nostack</code> if you push to the stack.</p>



<a name="254770408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254770408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254770408">(Sep 24 2021 at 20:50)</a>:</h4>
<p>I don't think it'll break anything though.</p>



<a name="254770447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254770447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254770447">(Sep 24 2021 at 20:50)</a>:</h4>
<p>The compiler couldn't use the memory below the stack pointer anyway.</p>



<a name="254771214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254771214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254771214">(Sep 24 2021 at 20:56)</a>:</h4>
<p>With nostack the stack pointer may not even point to the stack at all I would guess.</p>



<a name="254771567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254771567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254771567">(Sep 24 2021 at 20:59)</a>:</h4>
<p>Is there a way to add an option for the case where the stack is used but <em>doesn't</em> need to be aligned to the full ABI alignment?</p>



<a name="254780808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254780808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254780808">(Sep 24 2021 at 22:14)</a>:</h4>
<p>The stack pointer is usually always kept aligned on ARM, so it costs nothing.</p>



<a name="254786508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254786508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254786508">(Sep 24 2021 at 23:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn't.20need.20t.2E.2E.2E/near/254771214">said</a>:</p>
<blockquote>
<p>With nostack the stack pointer may not even point to the stack at all I would guess.</p>
</blockquote>
<p>I don't think it's usually allowed, otherwise signal handler wouldn't work.</p>



<a name="254786601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254786601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254786601">(Sep 24 2021 at 23:20)</a>:</h4>
<p>Requiring the stack to be aligned should be of no cost for most (if not all) platforms.</p>



<a name="254837413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254837413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254837413">(Sep 25 2021 at 12:55)</a>:</h4>
<p>With ARM, the stack is aligned to 4 at all times, and aligned to 8 at a public interface.</p>
<p>So what I don't want is for the <code>asm!</code> block to end up asking LLVM for an alignment of 8 and having LLVM possibly pushing/popping extra registers around the block to meet that requirement, when the <code>asm!</code> itself doesn't need the alignment of 8 at all.</p>



<a name="254844984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254844984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254844984">(Sep 25 2021 at 14:43)</a>:</h4>
<p>I'm somewhat hesitant to add yet another option for such a niche use case.</p>



<a name="254861685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254861685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254861685">(Sep 25 2021 at 18:55)</a>:</h4>
<p>Fair enough, it is pretty niche</p>



<a name="254882073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254882073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254882073">(Sep 26 2021 at 00:18)</a>:</h4>
<p><code>clobber_abi("stack")</code></p>



<a name="254882319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254882319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254882319">(Sep 26 2021 at 00:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn't.20need.20t.2E.2E.2E/near/254837413">said</a>:</p>
<blockquote>
<p>So what I don't want is for the <code>asm!</code> block to end up asking LLVM for an alignment of 8 and having LLVM possibly pushing/popping extra registers around the block to meet that requirement, when the <code>asm!</code> itself doesn't need the alignment of 8 at all.</p>
</blockquote>
<p>I doubt if any stack adjustment will actually be generated. It's likely that the stack will just be aligned at the prologue. Do you have a snippet that demonstrates the extra stack adjustment?</p>



<a name="254886612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254886612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254886612">(Sep 26 2021 at 01:37)</a>:</h4>
<p>not on hand i don't. my thought was that the stack would would otherwise contain some odd number of elements before the <code>asm!</code>, and because of the asm an extra element is required to be pushedpopped.</p>
<p>but it's only a 2 cycle total difference. Even if the device in question is only ~16MHz, 2 cycles on a few calls here and there is a pretty small overhead.</p>



<a name="254886697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need%20t.../near/254886697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.20t.2E.2E.2E.html#254886697">(Sep 26 2021 at 01:38)</a>:</h4>
<p>Also, particularly if most functions are the Rust ABI, then there's really no reason for that to enforce align8 on the stack at every function call. I sure hope that it doesn't</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>