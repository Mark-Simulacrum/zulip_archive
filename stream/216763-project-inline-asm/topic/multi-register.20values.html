<html>
<head><meta charset="utf-8"><title>multi-register values · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html">multi-register values</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252961709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252961709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252961709">(Sep 12 2021 at 05:47)</a>:</h4>
<p>On ARM and other 32-bit targets, 64-bit integers take up two registers. Is there any current way for this to be supported with inline-asm, or is there any plan for this to be supported in the future?</p>
<p>(Similarly, 128-bit integers on 64-bit targets use two registers).</p>



<a name="252962494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252962494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252962494">(Sep 12 2021 at 06:02)</a>:</h4>
<p>It's asm so shouldn't it be up to the caller to split their u64 into two u32 before feeding them to asm!()?</p>
<p>Move + shift would be a no-op because the values are already in the 32 wide registers.</p>



<a name="252970862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252970862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252970862">(Sep 12 2021 at 08:42)</a>:</h4>
<p>Libre-SOC's SimpleV requires using ranges of registers for vectors (e.g. 28 registers for a <code>f32x56</code>), so we will be adding inline assembly i/o arguments for PowerPC that are a contiguous range of registers (assuming Rust and LLVM accept our changes).</p>



<a name="252972501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252972501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252972501">(Sep 12 2021 at 09:14)</a>:</h4>
<p>Isn't this something that would be better expressed using LLVM intrinsics via std::arch, or even auto-vectorization?</p>



<a name="252972644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252972644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252972644">(Sep 12 2021 at 09:17)</a>:</h4>
<p>perhaps, but that shouldn't prevent us from passing it to/from inline asm, just like <code>xmm</code> registers can be passed from/to inline asm on x86 even though calling <code>f32x4</code>'s <code>Add</code> impl may be better</p>



<a name="252972736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252972736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252972736">(Sep 12 2021 at 09:19)</a>:</h4>
<p>also, there are instruction sequences we're working on designing that aren't realistically going to be supported by llvm for a while, such as FFT instructions</p>



<a name="252972790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252972790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252972790">(Sep 12 2021 at 09:20)</a>:</h4>
<p>we still want to be able to use them from inline asm</p>



<a name="252973135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252973135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252973135">(Sep 12 2021 at 09:26)</a>:</h4>
<p>If you add LLVM assembler support for FFT instructions, you could add platform specific LLVM intrinsics for said instructions, right? Or are you telling LLVM to emit asm and then run an external assembler?</p>



<a name="252973323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252973323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252973323">(Sep 12 2021 at 09:30)</a>:</h4>
<p>well, like risc-v's LL/SC atomics, the generated instructions would need to be in a specially restricted block (for FFTs), so we would need to add support to LLVM's Register Allocator, Schedulers, etc. to correctly support them. Adding them to LLVM's integrated assembler is trivial by comparison</p>



<a name="252973453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252973453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252973453">(Sep 12 2021 at 09:32)</a>:</h4>
<p>for general traditional vector ops, LLVM's built-in support for vectors is sufficient</p>



<a name="252973491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252973491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252973491">(Sep 12 2021 at 09:33)</a>:</h4>
<p>so, for FFT instructions, adding LLVM intrinsics could easily be done but they wouldn't work right</p>



<a name="252991432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252991432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252991432">(Sep 12 2021 at 14:44)</a>:</h4>
<p>one problem here is that intrinsics and inline asm are naturally at odds with each other. If you wanted to do one or two things, then a long multiply, then one or two other specific things, you'd need an asm block, a single intrinsic call, and then a second asm block. It's not ergonomic in the least.</p>



<a name="252991672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/multi-register%20values/near/252991672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/multi-register.20values.html#252991672">(Sep 12 2021 at 14:49)</a>:</h4>
<blockquote>
<p>Move + shift would be a no-op because the values are already in the 32 wide registers.</p>
</blockquote>
<p>I suspect this is probably the case, but that's also an extra detail that's probably error prone to be doing yourself all the time. Example: we <em>could</em> only accept usize and tell people that want pointers to cast them to and from usize values at asm block bounds, but that's fiddly and error prone, so we just let people pass pointers directly.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>