<html>
<head><meta charset="utf-8"><title>`preserves_flags` for everything *but* the flags register? · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html">`preserves_flags` for everything *but* the flags register?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="197627125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197627125" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197627125">(May 14 2020 at 22:36)</a>:</h4>
<p>Is there a way to mark an assembly block as not clobbering the dirflag or the floating-point status, but still clobbering the flags? That would be a common combination, since it's relatively easy to not accidentally clobber the dirflag and floating-point status, and difficult to not touch the flags unless you save/restore them.</p>



<a name="197627804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197627804" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197627804">(May 14 2020 at 22:45)</a>:</h4>
<p>Honestly it's really not a big deal</p>



<a name="197627828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197627828" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197627828">(May 14 2020 at 22:45)</a>:</h4>
<p>The compiler will generally use the flags immediately after it has generated them (in fact it prefers that since Intel CPUs do instruction fusion in such cases).</p>



<a name="197627894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197627894" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197627894">(May 14 2020 at 22:46)</a>:</h4>
<p>So IMO it's not worth the trouble of adding these.</p>



<a name="197627953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197627953" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197627953">(May 14 2020 at 22:47)</a>:</h4>
<p>I could change the rule for the direction flag to say that it must always be reset to 0 after executing asm code.</p>



<a name="197627977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197627977" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197627977">(May 14 2020 at 22:47)</a>:</h4>
<p>(i.e. effectively remove <code>~dirflag</code> from the LLVM clobbers)</p>



<a name="197628040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628040" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628040">(May 14 2020 at 22:48)</a>:</h4>
<p>dirflag was what I was thinking of, yes. It'd be nice for the compiler to not need to re-set it after every asm block.</p>



<a name="197628043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628043" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628043">(May 14 2020 at 22:48)</a>:</h4>
<p>And most code will never touch it.</p>



<a name="197628057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628057" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628057">(May 14 2020 at 22:48)</a>:</h4>
<p>I think it's reasonable to drop that from the default clobbers, and offer a way to clobber it explicitly.</p>



<a name="197628137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628137">(May 14 2020 at 22:49)</a>:</h4>
<p>OK I'll modify the RFC accordingly. I don't think it's necessary to provide a way to clobber it. Just require that it be reset to 0 should be enough, this is what the x86 function call ABI requires anyways.</p>



<a name="197628252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628252" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628252">(May 14 2020 at 22:50)</a>:</h4>
<p>Clobbering it has the advantage of letting the compiler consolidate setting it.</p>



<a name="197628284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628284" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628284">(May 14 2020 at 22:51)</a>:</h4>
<p>(Or not bother, if it already has to push and pop flags, for instance.)</p>



<a name="197628313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628313" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628313">(May 14 2020 at 22:51)</a>:</h4>
<p>LLVM has a clobber for this; is it just that you don't want to offer a way to name it?</p>



<a name="197628413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628413" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628413">(May 14 2020 at 22:52)</a>:</h4>
<p>(I do appreciate saying "set to 0" rather than "preserve", though; that way the assembly code doesn't have to save its current value.)</p>



<a name="197628486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628486" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628486">(May 14 2020 at 22:53)</a>:</h4>
<p>Also, the floating-point <em>exception</em> status (as opposed to floating-point flags) seems like something the compiler shouldn't need to restore by default. Most assembly will never touch that either.</p>



<a name="197628685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197628685" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197628685">(May 14 2020 at 22:55)</a>:</h4>
<p>Then <code>preserves_flags</code> will just refer to flags, and there could be a combined clobber for the rest (making the compiler restore dirflag and floating-point exception status if it needs them).</p>



<a name="197631793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197631793" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197631793">(May 14 2020 at 23:34)</a>:</h4>
<p>Floating point mode flags (rounding mode, flush to zero, etc) are treated as "global state". Therefore they are not covered by input/output/clobbers.</p>



<a name="197632155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197632155" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197632155">(May 14 2020 at 23:39)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> My rule of thumb for <code>preserves_flags</code> is that it covers any flag that is not preserved by function calls (i.e "volatile" flags)</p>



<a name="197632440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197632440" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197632440">(May 14 2020 at 23:43)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="197632523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197632523" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197632523">(May 14 2020 at 23:44)</a>:</h4>
<p>Then let's focus on dirflag.</p>



<a name="197634045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197634045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197634045">(May 15 2020 at 00:04)</a>:</h4>
<p>Actually I'm not sure it's that simple:</p>
<ul>
<li>Is the dirflag guaranteed to be clear on entry to asm?</li>
<li>If I don't clobber dirflag, am I allowed to clear it?</li>
</ul>



<a name="197634056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197634056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197634056">(May 15 2020 at 00:05)</a>:</h4>
<p>I think the answer is no to both.</p>



<a name="197634069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197634069" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197634069">(May 15 2020 at 00:05)</a>:</h4>
<p>I would rather just keep <code>preserves_flags</code> as it is right now.</p>



<a name="197634088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197634088" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197634088">(May 15 2020 at 00:05)</a>:</h4>
<p>It's not worth the added complexity just to allow the compiler to elide a CLD instruction.</p>



<a name="197777895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197777895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197777895">(May 16 2020 at 05:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F/near/197634056">said</a>:</p>
<blockquote>
<p>I think the answer is no to both.</p>
</blockquote>
<p>I very much hope the answer to "is the dirflag guaranteed to be clear on entry to asm" is <em>yes</em>. I'd like to avoid having to put <code>cld</code> instructions inside the asm every time they use a string instruction.</p>



<a name="197777935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197777935" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197777935">(May 16 2020 at 05:20)</a>:</h4>
<p>Doesn't the ABI guarantee that?</p>



<a name="197777944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197777944" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197777944">(May 16 2020 at 05:21)</a>:</h4>
<p>Because inline assembly in C normally assumes that.</p>



<a name="197777958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197777958" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197777958">(May 16 2020 at 05:22)</a>:</h4>
<p>And it'd be a really subtle trap for inline assembly authors if they couldn't assume that in Rust. I don't think that buys us anything, either.</p>



<a name="197790620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197790620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197790620">(May 16 2020 at 11:10)</a>:</h4>
<p>The function call ABI guarantees that. I am not sure what GCC/LLVM guarantee for inline asm.</p>



<a name="197801626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197801626" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197801626">(May 16 2020 at 15:47)</a>:</h4>
<p>I think that GCC and LLVM never set the direction flag, or if they do they immediately clear it when done.</p>



<a name="197801685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197801685" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197801685">(May 16 2020 at 15:48)</a>:</h4>
<p>So unless some function or assembly violates the ABI, I don't see how it could ever be set.</p>



<a name="197806760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197806760" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197806760">(May 16 2020 at 17:49)</a>:</h4>
<p>So apparently LLVM always assumes the direction flag is clear and never sets it.</p>



<a name="197806847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197806847" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197806847">(May 16 2020 at 17:51)</a>:</h4>
<p>That sounds about right.</p>



<a name="197806859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197806859" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197806859">(May 16 2020 at 17:51)</a>:</h4>
<p>Certainly every bit of inline assembly I've ever seen that uses string instructions makes exactly the same assumption.</p>



<a name="197807479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807479" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807479">(May 16 2020 at 18:05)</a>:</h4>
<p>LLVM also apparently doesn't reset the direction flag after asm has clobbered it :P</p>



<a name="197807534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807534" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807534">(May 16 2020 at 18:06)</a>:</h4>
<p>Even if asm declares it as clobbered?</p>



<a name="197807541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807541">(May 16 2020 at 18:06)</a>:</h4>
<p>That sounds like a bug.</p>



<a name="197807853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807853" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807853">(May 16 2020 at 18:14)</a>:</h4>
<p>Same with GCC.</p>



<a name="197807870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807870">(May 16 2020 at 18:15)</a>:</h4>
<p>Huh. That sounds like a good argument for saying that, at least for now, you <em>must</em> clear the direction flag if you set it.</p>



<a name="197807911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807911" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807911">(May 16 2020 at 18:16)</a>:</h4>
<p>We might be able to lift that restriction if that bug is fixed, but given how <em>rarely</em> the direction flag is set, I don't think it'll be an issue in practice.</p>



<a name="197807920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807920" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807920">(May 16 2020 at 18:16)</a>:</h4>
<p>Yes. However with GCC the direction flag is not guaranteed to be cleared on entry to asm.</p>



<a name="197807930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807930">(May 16 2020 at 18:16)</a>:</h4>
<p>This can only happen in one specific scenario: you are using the x86 interrupt calling convention and the code you interrupted has set the direction flag.</p>



<a name="197807941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197807941" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197807941">(May 16 2020 at 18:17)</a>:</h4>
<p>GCC lazily clears the direction flag only if it is needed in the function.</p>



<a name="197808100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808100" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808100">(May 16 2020 at 18:21)</a>:</h4>
<p>So I'm going to go with: direction flag is undefined on entry, and must be preserved or reset on exit.</p>



<a name="197808240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808240" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808240">(May 16 2020 at 18:24)</a>:</h4>
<p>It sounds like LLVM guarantees that it's cleared on entry, though.</p>



<a name="197808253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808253" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808253">(May 16 2020 at 18:25)</a>:</h4>
<p>And since we actually use LLVM, it seems reasonable to define <code>asm!</code> blocks as such. Otherwise <em>everyone</em> using any string instruction would have to <code>cld</code> first. That'd be a major surprise to anyone writing inline assembly, and a divergence from expectations based on C/C++ inline assembly.</p>



<a name="197808297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808297">(May 16 2020 at 18:26)</a>:</h4>
<p>And in practice, most people will assume it's clear anyway, even if we declared that to be undefined.</p>



<a name="197808307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808307" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808307">(May 16 2020 at 18:26)</a>:</h4>
<p>Could we define it as "clear on entry, must be clear on exit", and then if we need to port to a compiler that doesn't guarantee that, and we can't fix the compiler, we can always put the <code>cld</code> at the beginning of the ASM ourselves?</p>



<a name="197808309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808309" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808309">(May 16 2020 at 18:26)</a>:</h4>
<p>If you look at inline asm in the Linux kernel, they always call <code>cld</code> before using string ops.</p>



<a name="197808311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808311" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808311">(May 16 2020 at 18:27)</a>:</h4>
<p>I did, and they don't.</p>



<a name="197808323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808323" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808323">(May 16 2020 at 18:27)</a>:</h4>
<p><code>arch/x86/lib/string_32.c</code></p>



<a name="197808340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808340" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808340">(May 16 2020 at 18:27)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kt">char</span> <span class="o">*</span><span class="nf">strcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">d0</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">;</span>
        <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;1:</span><span class="se">\t</span><span class="s">lodsb</span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;stosb</span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;testb %%al,%%al</span><span class="se">\n\t</span><span class="s">&quot;</span>
                <span class="s">&quot;jne 1b&quot;</span>
                <span class="o">:</span> <span class="s">&quot;=&amp;S&quot;</span> <span class="p">(</span><span class="n">d0</span><span class="p">),</span> <span class="s">&quot;=&amp;D&quot;</span> <span class="p">(</span><span class="n">d1</span><span class="p">),</span> <span class="s">&quot;=&amp;a&quot;</span> <span class="p">(</span><span class="n">d2</span><span class="p">)</span>
                <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



<a name="197808394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808394" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808394">(May 16 2020 at 18:28)</a>:</h4>
<p>huh</p>



<a name="197808408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808408" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808408">(May 16 2020 at 18:28)</a>:</h4>
<p>They do have <code>cld</code> instructions after calling or otherwise receiving control flow from code they don't trust, like BIOS.</p>



<a name="197808414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808414" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808414">(May 16 2020 at 18:29)</a>:</h4>
<p>But not in general.</p>



<a name="197808426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808426" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808426">(May 16 2020 at 18:29)</a>:</h4>
<p>The only other place I see <code>cld</code> instructions is after they've done an <code>std</code>.</p>



<a name="197808427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808427" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808427">(May 16 2020 at 18:29)</a>:</h4>
<p>I guess they can get away with it since they don't use <code>__attribute__((interrupt))</code>.</p>



<a name="197808480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808480" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808480">(May 16 2020 at 18:30)</a>:</h4>
<p><a href="https://godbolt.org/z/hL2GFJ">https://godbolt.org/z/hL2GFJ</a></p>



<a name="197808489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808489" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808489">(May 16 2020 at 18:31)</a>:</h4>
<p>Notice how LLVM executes <code>cld</code> before any user code, while GCC does it lazily only when it is needed (calling another function).</p>



<a name="197808496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808496" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808496">(May 16 2020 at 18:31)</a>:</h4>
<p>Interesting!</p>



<a name="197808499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808499" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808499">(May 16 2020 at 18:31)</a>:</h4>
<p>Seems like there's at least one bug here.</p>



<a name="197808540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808540" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808540">(May 16 2020 at 18:32)</a>:</h4>
<p>I'm happy to require the direction flag to be 0 for inline asm, but we'll have to change it in GCC when we get a GCC backend.</p>



<a name="197808541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808541">(May 16 2020 at 18:32)</a>:</h4>
<p>That seems fine to me.</p>



<a name="197808548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808548">(May 16 2020 at 18:33)</a>:</h4>
<p>I'm hoping we do so by fixing GCC.</p>



<a name="197808554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808554" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808554">(May 16 2020 at 18:33)</a>:</h4>
<p>But in any case, even if we have to <code>cld</code> explicitly at the beginning of any function containing inline assembly (on GCC, as a workaround), that'd be fine with me.</p>



<a name="197808557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808557" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808557">(May 16 2020 at 18:33)</a>:</h4>
<p>That's better than telling people to do something we know most of them won't do.</p>



<a name="197808600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808600" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808600">(May 16 2020 at 18:34)</a>:</h4>
<p>(And in theory, we might only need to <code>cld</code> at the beginning of a function declared with the interrupt calling convention.)</p>



<a name="197808674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60preserves_flags%60%20for%20everything%20%2Abut%2A%20the%20flags%20register%3F/near/197808674" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216763-project-inline-asm/topic/.60preserves_flags.60.20for.20everything.20*but*.20the.20flags.20register.3F.html#197808674">(May 16 2020 at 18:37)</a>:</h4>
<p><a href="https://github.com/rust-lang/rfcs/pull/2873/commits/3633849ed0d0bf3fe29e729d513d4e812aa1de53">https://github.com/rust-lang/rfcs/pull/2873/commits/3633849ed0d0bf3fe29e729d513d4e812aa1de53</a> looks good, thank you.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>