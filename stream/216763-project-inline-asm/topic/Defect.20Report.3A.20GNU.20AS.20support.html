<html>
<head><meta charset="utf-8"><title>Defect Report: GNU AS support · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html">Defect Report: GNU AS support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269054045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054045">(Jan 24 2022 at 02:32)</a>:</h4>
<p>Currently, <a href="https://doc.rust-lang.org/nightly/reference/inline-assembly.html#template-string-arguments">https://doc.rust-lang.org/nightly/reference/inline-assembly.html#template-string-arguments</a> defines the following:</p>
<blockquote>
<p>Currently, all supported targets follow the assembly code syntax used by LLVM's internal assembler which usually corresponds to that of the GNU assembler (GAS). On x86, the .intel_syntax noprefix mode of GAS is used by default. On ARM, the .syntax unified mode is used. These targets impose an additional restriction on the assembly code: any assembler state (e.g. the current section which can be changed with .section) must be restored to its original value at the end of the asm string. Assembly code that does not conform to the GAS syntax will result in assembler-specific behavior.</p>
</blockquote>
<p>This has an argubly unfortunate side effect of guaranteeing, at least for current targets, the ability to use full macro assembly syntax.<br>
I would ideally like this guarantee reversed, if possible, before it hits stable. In lccc, the current (and likely future) x86 codegen does not function by creating assembly from the ir, then running the result through as or any internal assembler, but rather directly generates x86 machine code (&lt;<a href="https://github.com/LightningCreations/lccc/blob/d262162a46c16d767b5b24aca82715db641bca53/codegen-x86/src/lib.rs#L431">https://github.com/LightningCreations/lccc/blob/d262162a46c16d767b5b24aca82715db641bca53/codegen-x86/src/lib.rs#L431</a>&gt;). The same will likely be true of other codegens written as part of the lccc project that do not go through another IR. This was a deliberate decision to avoid complicating target information, and to allow backends and other plugins to be largely isolated and avoid running system commands (which would allow, for example, the project to host in wasm).<br>
This, however, means that in the future, it will be difficult to support full GNU AS macro assembly syntax, as this would necessitate implementing an assembly parser equivalent to GNU AS within the codegen (heavily complicating an already complicated plugin).</p>
<p>My proposal is to revise the above sentance to the following:</p>
<blockquote>
<p>The format of inline assembly is platform specific, but may contain labels and instructions. The use of directives, if any, are assembler and implementation specific and may not be supported. </p>
</blockquote>
<p>For <code>global_asm</code>, a more relaxed form could be used, allowing simple directives, such as <code>.section</code> and data declaration directives. However, I would be strongly adverse to guaranteeing that macros or conditional assembly directives are guaranteed to be supported.</p>



<a name="269054204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054204">(Jan 24 2022 at 02:37)</a>:</h4>
<p>The <code>asm!</code> feature is specifically designed so that you can pass it to an external assembler and just link to the resulting object file. After that you can just call the assembly code like a normal function and avoid the need for any special handling in the backend. This is the approach used by the cranelift backend which has no plans to support inline assembly.</p>



<a name="269054291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054291">(Jan 24 2022 at 02:39)</a>:</h4>
<p>Implementing any kind of assembler, even a basic one capable of parsing x86 intel syntax, is a massive effort on its own and I certainly don't expect every codegen backend to support it natively.</p>



<a name="269054296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054296">(Jan 24 2022 at 02:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support/near/269054204">said</a>:</p>
<blockquote>
<p>The <code>asm!</code> feature is specifically designed so that you can pass it to an external assembler and just link to the resulting object file. After that you can just call the assembly code like a normal function and avoid the need for any special handling in the backend. This is the approach used by the cranelift backend which has no plans to support inline assembly.</p>
</blockquote>
<p>As mentioned, I would like to avoid running an external assembler, which would bring the advantage of allowing the xlang stack to be run without the benefit of an actual operating system (such as on wasm as I mentioned).</p>



<a name="269054372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054372">(Jan 24 2022 at 02:41)</a>:</h4>
<p>I'm sure it's possible to make an external assembler work in wasm, you'd just need to package it up as a library. I think you can use LLVM's internal assembler this way.</p>



<a name="269054431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054431">(Jan 24 2022 at 02:42)</a>:</h4>
<p>Supporting a basic assembler in it (or rather, the support library it calls out to for x86 code generation - arch-ops) wouldn't be unreasonable. The thing I would like to avoid is writing a fully capable macro assembler.</p>



<a name="269054504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054504">(Jan 24 2022 at 02:44)</a>:</h4>
<p>The other question is, what if there is no GNU AS compatible assembler available, even if an external one is called out to? What if the only assembler on the system is ml.exe?</p>



<a name="269054518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054518">(Jan 24 2022 at 02:45)</a>:</h4>
<p>Then you package one with the compiler.</p>



<a name="269054528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054528">(Jan 24 2022 at 02:45)</a>:</h4>
<p>Ok. I'll just package a binary with the lccc source code... And ship one that works on everything.</p>



<a name="269054573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054573">(Jan 24 2022 at 02:46)</a>:</h4>
<p>I'd ideally like to avoid packaging all of llvm, with a project that's trying to be independant from it.</p>



<a name="269054592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054592">(Jan 24 2022 at 02:47)</a>:</h4>
<p>(And noting that llvm does not support a number of the targets I am intent to support)</p>



<a name="269054776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054776">(Jan 24 2022 at 02:51)</a>:</h4>
<p>I'm not sure what I can say here. There are a number of features from GAS that people are actually using with inline assembly. And really do need these features.</p>
<p>For example, in my own projects I've used:</p>
<ul>
<li><code>.globl</code>, <code>.type</code>, <code>.size</code>, <code>.hidden</code>, <code>.weak</code> directives to define a symbol in <code>global_asm!</code>.</li>
<li><code>.pushsection</code>, <code>.popsection</code> to add data to a section from an <code>asm!</code> which references code locations in the generated assembly.</li>
<li><code>.cfi_*</code>, <code>.seh_*</code> directives to emit specific unwind information for custom functions defined using <code>global_asm!</code>.</li>
</ul>



<a name="269054820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054820">(Jan 24 2022 at 02:52)</a>:</h4>
<p>Just saying that only instructions and labels are supported is not good enough, I need to be able to use assembler directives.</p>



<a name="269054989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054989">(Jan 24 2022 at 02:56)</a>:</h4>
<p>For global_asm, I believe that's still unstable, so that can probably be discussed. <br>
However, asm has basically stabilized the existance of GNU as <em>or</em> LLVM, which, in my opinion, is an unreasonable burden to bear, and I would like that to be avoided before the macro hits stable.</p>



<a name="269054998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269054998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269054998">(Jan 24 2022 at 02:56)</a>:</h4>
<p><code>global_asm!</code> was stabilized at the same time as <code>asm!</code>.</p>



<a name="269055110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269055110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269055110">(Jan 24 2022 at 02:59)</a>:</h4>
<p>Oh brilliant.</p>



<a name="269087965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269087965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269087965">(Jan 24 2022 at 10:55)</a>:</h4>
<p>Speaking of GAS, I think we need to prevent MASM-style integer literals from being used because it's only recognized by LLVM assembler but not GAS.</p>



<a name="269088122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269088122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269088122">(Jan 24 2022 at 10:56)</a>:</h4>
<p>It's also not recognized by LLVM assembler if the Intel syntax is enabled by <code>.intel_syntax</code></p>



<a name="269088348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269088348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269088348">(Jan 24 2022 at 10:58)</a>:</h4>
<p>Essentially the "Intel mode" of LLVM assembler is only there for MSVC compatibility.</p>



<a name="269108963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269108963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269108963">(Jan 24 2022 at 13:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support/near/269087965">said</a>:</p>
<blockquote>
<p>Speaking of GAS, I think we need to prevent MASM-style integer literals from being used because it's only recognized by LLVM assembler but not GAS.</p>
</blockquote>
<p>I don't know if it needs to be prevented, but it could be included in what is excluded from being guaranteed to work.</p>



<a name="269109847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269109847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269109847">(Jan 24 2022 at 14:04)</a>:</h4>
<p>It is already excluded from being guaranteed to work. Only the common subset of LLVM and GCC is guaranteed to work.</p>



<a name="269110030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269110030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269110030">(Jan 24 2022 at 14:06)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/reference/inline-assembly.html">https://doc.rust-lang.org/nightly/reference/inline-assembly.html</a></p>
<blockquote>
<p>Assembly code that does not conform to the GAS syntax will result in assembler-specific behavior.</p>
</blockquote>



<a name="269110228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269110228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269110228">(Jan 24 2022 at 14:07)</a>:</h4>
<p>Yes the MASM-style integer literals are a bug but I'm not sure how to solve it without breaking Clang's use of intel syntax. Keep in mind both rustc and Clang have to share the same LLVM IR when doing cross-language LTO.</p>



<a name="269110273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269110273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269110273">(Jan 24 2022 at 14:07)</a>:</h4>
<p><a href="https://rust-lang.github.io/rfcs/2873-inline-asm.html#validate-the-assembly-code-in-rustc">https://rust-lang.github.io/rfcs/2873-inline-asm.html#validate-the-assembly-code-in-rustc</a></p>
<blockquote>
<p>While it might be possible for rustc to verify that inline assembly code conforms to a minimal stable subset of the assembly syntax supported by LLVM and GAS, doing so would effectively require rustc to parse the assembly code itself. Implementing a full assembler for all target architectures supported by this RFC is a huge amount of work, most of which is redundant with the work that LLVM has already done in implementing an assembler. As such, this RFC does not propose that rustc perform any validation of the generated assembly code.</p>
</blockquote>



<a name="269110705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269110705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269110705">(Jan 24 2022 at 14:10)</a>:</h4>
<p>Yeah. To be clear, I'm proposing no changes to rustc itself, only to what is guaranteed about inline assembly. rustc itself can provide stronger guarantees, or happen to support LLVM assembly itself.</p>



<a name="269114665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269114665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269114665">(Jan 24 2022 at 14:42)</a>:</h4>
<p>(It may not be a good idea to guarantee too much more, as additional rustc codegens may run into the same issue)</p>



<a name="269142457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269142457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269142457">(Jan 24 2022 at 17:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support/near/269110228">said</a>:</p>
<blockquote>
<p>Yes the MASM-style integer literals are a bug but I'm not sure how to solve it without breaking Clang's use of intel syntax. Keep in mind both rustc and Clang have to share the same LLVM IR when doing cross-language LTO.</p>
</blockquote>
<p>In theory, LLVM could add a flag to its inline-assembly IR representation, to say "don't support MASM integer literals", or any number of other things like that. We could set that flag internally, and clang wouldn't have to.</p>



<a name="269142502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269142502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269142502">(Jan 24 2022 at 17:47)</a>:</h4>
<p>That would require an LLVM change, but it seems like a useful one.</p>



<a name="269142560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269142560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269142560">(Jan 24 2022 at 17:47)</a>:</h4>
<p>It's a breaking change to the IR bitcode, so it would require a major LLVM version bump.</p>



<a name="269142786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269142786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269142786">(Jan 24 2022 at 17:49)</a>:</h4>
<p>Is any change that older versions of LLVM can't parse automatically considered a breaking change? There's no mechanism for "compatible extensions", where if the older version doesn't understand something that's acceptable?</p>



<a name="269142846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269142846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269142846">(Jan 24 2022 at 17:49)</a>:</h4>
<p>In this context, since it's just "please prevent X from working", it wouldn't be the end of the world if older LLVM didn't enforce it.</p>



<a name="269143034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269143034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269143034">(Jan 24 2022 at 17:50)</a>:</h4>
<p>(Aside: it wouldn't have to be MASM integer literals in general, it could <em>just</em> fix the ambiguity in <code>b</code> suffixes vs backward labels like 0b, 1b, 10b, etc.)</p>



<a name="269143554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269143554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269143554">(Jan 24 2022 at 17:54)</a>:</h4>
<p>Any flag in the bitcode would need to be understood by both rustc and clang since cross-lang LTO could be done by either of them.</p>



<a name="269144610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269144610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269144610">(Jan 24 2022 at 18:01)</a>:</h4>
<p>would it work to use the <code>.intel_syntax</code> directive instead of the llvm flag?</p>



<a name="269144728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269144728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269144728">(Jan 24 2022 at 18:02)</a>:</h4>
<p>It would, but then it would still break cross-lang LTO.</p>



<a name="269144793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269144793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269144793">(Jan 24 2022 at 18:02)</a>:</h4>
<p>We already only support cross-lang LTO when both rustc and clang use the same LLVM version.</p>



<a name="269144884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269144884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269144884">(Jan 24 2022 at 18:03)</a>:</h4>
<p>Well then we need to ensure that the modified <code>intel_syntax</code> flag is accepted in LLVM upstream first so that it gets into LLVM 14.</p>



<a name="269145028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269145028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269145028">(Jan 24 2022 at 18:04)</a>:</h4>
<p>uuh, how would it break, it shouldn't require any modifications to llvm for rustc to generate <code>.intel_syntax</code> in the llvm asm string</p>



<a name="269145125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269145125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269145125">(Jan 24 2022 at 18:04)</a>:</h4>
<p>We'd need to add something like <code>.intel_syntax no_masm_literals</code>. It would need to be understood by the LLVM assembler.</p>



<a name="269145399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269145399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269145399">(Jan 24 2022 at 18:06)</a>:</h4>
<p>iirc the llvm assembler already doesn't use masm literals if you use <code>.intel_syntax</code> instead of the llvm flag</p>



<a name="269145463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269145463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269145463">(Jan 24 2022 at 18:07)</a>:</h4>
<p>Oh right, it's using some flag from inline assembly to determine that.</p>



<a name="269145536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269145536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269145536">(Jan 24 2022 at 18:07)</a>:</h4>
<p>We still need to use the intel syntax dialect when generating inline assembly since we want LLVM to render register names as <code>rax</code> instead of <code>%rax</code>.</p>



<a name="269146863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269146863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269146863">(Jan 24 2022 at 18:17)</a>:</h4>
<p>On the main topic, would it be possible to determine a subset of assembly that would be acceptable from both sides? One of the main things I'd like to avoid is arbitrary interpolations in the asm string, as well as avoiding macros (<code>if</code> may be reasonable, but I'd have to look into it). The way I'd want handle interpolations would be to just replace them in the codegen with the correct operand, rather than doing a textual replacement (which skips having to parse the string, then rewrite it, then parse it, then rewrite it again, then finally parse it again).</p>



<a name="269146880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269146880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269146880">(Jan 24 2022 at 18:17)</a>:</h4>
<p>Would combining of specifying intel syntax using a flag on the asm statement with adding <code>.intel_syntax noprefix</code> at the start of the asm source work?</p>



<a name="269147824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269147824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269147824">(Jan 24 2022 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> You'd only have to parse the string once after the substitutions have been made. There's no need to parse it before then, it's just treated as a <code>format!</code> string template.</p>



<a name="269148399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269148399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269148399">(Jan 24 2022 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support/near/269147824">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> You'd only have to parse the string once after the substitutions have been made. There's no need to parse it before then, it's just treated as a <code>format!</code> string template.</p>
</blockquote>
<p>Yeah, the first parsing is in the frontend, and that's true for that. Then I have to replace it with the bikesheddable xir syntax for asm declarations (which will probably use positional arguments exclusively). I'm pretty sure I'd still have to parse the string in the backend, perform the interpolation, then reparse everything. Ideally, I can do all 3 of those in one step, and just put in the the right <code>X86Operand</code>s.</p>



<a name="269148650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269148650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269148650">(Jan 24 2022 at 18:29)</a>:</h4>
<p>This is how <code>asm!</code> is currently represented in the various stages of the compiler: <a href="https://rustc-dev-guide.rust-lang.org/asm.html">https://rustc-dev-guide.rust-lang.org/asm.html</a></p>



<a name="269148652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269148652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269148652">(Jan 24 2022 at 18:29)</a>:</h4>
<p>(And it would be hard to pick a generalized syntax that won't be context dependant in at least some architectures)</p>



<a name="269148785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269148785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269148785">(Jan 24 2022 at 18:30)</a>:</h4>
<p>LLVM and GCC interpolate first and only parse the resulting asm. This allows <code>{}</code> to be used for example as part of a symbol name.</p>



<a name="269148855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269148855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269148855">(Jan 24 2022 at 18:31)</a>:</h4>
<p>My point is, apart from the initial parsing which disassembles the template string into an AST structure, no parsing is needed until after register allocation where you need to fill in the placeholders.</p>



<a name="269149616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269149616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269149616">(Jan 24 2022 at 18:36)</a>:</h4>
<p>I may look into that and hold that argument. Macros are still the main thing, though. <br>
Having to track that kind of state is <em>fun</em>.</p>



<a name="269187009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187009">(Jan 24 2022 at 23:20)</a>:</h4>
<p>Also, question. What is rustc supposed to do if it's using !llvm, and on a host where there isn't a GNU compatible assembler available?</p>



<a name="269187040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187040">(Jan 24 2022 at 23:20)</a>:</h4>
<p>Seems like it would run into the same problem of "IDK how to run a GNU Compatible assembler on this code".</p>



<a name="269187193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187193">(Jan 24 2022 at 23:23)</a>:</h4>
<p>package binutils with rustc? alternatively, on the weird archs without binutils support, just declare your assembler to be vacuously compatible with gnu as</p>



<a name="269187223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187223">(Jan 24 2022 at 23:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support/near/269187193">said</a>:</p>
<blockquote>
<p>package binutils with rustc? alternatively, on the weird archs without binutils support, just declare your assembler to be vacuously compatible with gnu as</p>
</blockquote>
<p>What if binutils doesn't run on the host?</p>



<a name="269187365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187365">(Jan 24 2022 at 23:24)</a>:</h4>
<p>then you have one seriously weird host...binutils can be linked into your code as a library iirc</p>



<a name="269187411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187411">(Jan 24 2022 at 23:25)</a>:</h4>
<p>binutils doesn't compile on windows, except mingw (even there, IIRC, it requires some modifications).</p>



<a name="269187633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187633">(Jan 24 2022 at 23:28)</a>:</h4>
<p>(It also can't target windows-msvc)</p>



<a name="269187784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269187784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269187784">(Jan 24 2022 at 23:30)</a>:</h4>
<p>hmm...</p>



<a name="269188113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269188113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269188113">(Jan 24 2022 at 23:34)</a>:</h4>
<p>if your on windows just use a mingw binary?</p>



<a name="269188120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269188120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269188120">(Jan 24 2022 at 23:34)</a>:</h4>
<p>It's the same issue as with lccc, but aggrevated by the additional fact that what lccc distributes is source code (I have no plans for binary distributions). And I think it would be huge defect if lccc had any additional runtime dependencies on a major platform that the main C compiler wouldn't.</p>



<a name="269211423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269211423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269211423">(Jan 25 2022 at 05:27)</a>:</h4>
<p>I would tend to expect that if a code generation backend doesn't want to use LLVM, and (sensibly) doesn't want to shell out to an external assembler, that it'd end up developing its own internal assembly parser and assembler, ideally as a reusable library. Perhaps by extracting some of the relevant code from LLVM for reuse.</p>



<a name="269250381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269250381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269250381">(Jan 25 2022 at 12:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support/near/269211423">said</a>:</p>
<blockquote>
<p>I would tend to expect that if a code generation backend doesn't want to use LLVM, and (sensibly) doesn't want to shell out to an external assembler, that it'd end up developing its own internal assembly parser and assembler, ideally as a reusable library. Perhaps by extracting some of the relevant code from LLVM for reuse.</p>
</blockquote>
<p>That was my issue here: this was my goal, but I don't want to have to write a full on macro assembler in really any lccc backend, as it would further complicate my already complicated job, especially if the assembler has to effectively be bug compatible with GNU as.</p>



<a name="269261245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269261245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269261245">(Jan 25 2022 at 14:08)</a>:</h4>
<p>if you are ok with running a separate assembler, you can use llvm-mc iirc</p>



<a name="269261320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269261320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269261320">(Jan 25 2022 at 14:09)</a>:</h4>
<p>which does compile just fine on msvc and supports gnu as syntax</p>



<a name="269323624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269323624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269323624">(Jan 25 2022 at 21:02)</a>:</h4>
<p>They mentioned wanting to avoid an LLVM dependency, so that sounds like not really an ideal option. That said, I think in practice its not as bad as they're making it out. It clearly doesn't need to be bug compatible (the amount of Rust code using asm in the wild is not <em>that</em> large, and probably wont grow to be), and in practice failing to support directives (at least when no external assembler is present) is probably an option, at least at first.</p>



<a name="269668939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/269668939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#269668939">(Jan 28 2022 at 01:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> has marked this topic as unresolved.</p>



<a name="270332758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Defect%20Report%3A%20GNU%20AS%20support/near/270332758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Defect.20Report.3A.20GNU.20AS.20support.html#270332758">(Feb 02 2022 at 04:35)</a>:</h4>
<p>Being discussed in <a class="stream" data-stream-id="213817" href="/#narrow/stream/213817-t-lang">#t-lang</a> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/asm!.20and.20backends</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>