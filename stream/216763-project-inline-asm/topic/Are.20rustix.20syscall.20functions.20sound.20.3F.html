<html>
<head><meta charset="utf-8"><title>Are rustix syscall functions sound ? · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html">Are rustix syscall functions sound ?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271883369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271883369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271883369">(Feb 14 2022 at 20:25)</a>:</h4>
<p>Hi, after seen other threads here I am now wondering if rustix <code>syscall</code> <a href="https://github.com/bytecodealliance/rustix/blob/4f6c2c398065bb44e2588aab6ec352a5ad80f11f/src/imp/linux_raw/arch/inline/x86_64.rs">functions</a> are sound ?<br>
Below is an example of the syscall6 function (<a href="https://godbolt.org/z/d3fcc8fah">godbolt without rustix safety</a>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline]</span><span class="w"></span>
<span class="cp">#[must_use]</span><span class="w"></span>
<span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">crate</span>::<span class="n">imp</span><span class="p">)</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">syscall6</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">nr</span>: <span class="nc">SyscallNumber</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a0</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a1</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a2</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a3</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A3</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a4</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A4</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a5</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A5</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">RetReg</span><span class="o">&lt;</span><span class="n">R0</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s">"syscall"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">inlateout</span><span class="p">(</span><span class="s">"rax"</span><span class="p">)</span><span class="w"> </span><span class="n">nr</span><span class="p">.</span><span class="n">to_asm</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"rdi"</span><span class="p">)</span><span class="w"> </span><span class="n">a0</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"rsi"</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"rdx"</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"r10"</span><span class="p">)</span><span class="w"> </span><span class="n">a3</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"r8"</span><span class="p">)</span><span class="w"> </span><span class="n">a4</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"r9"</span><span class="p">)</span><span class="w"> </span><span class="n">a5</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">lateout</span><span class="p">(</span><span class="s">"rcx"</span><span class="p">)</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">lateout</span><span class="p">(</span><span class="s">"r11"</span><span class="p">)</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">options</span><span class="p">(</span><span class="n">nostack</span><span class="p">,</span><span class="w"> </span><span class="n">preserves_flags</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">FromAsm</span>::<span class="n">from_asm</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>From what I can see of the generated output if does what is supposed to be the case, but that's not guaranteed because LLVM or GCC could use some of these register internaly ?</p>



<a name="271884446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271884446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271884446">(Feb 14 2022 at 20:33)</a>:</h4>
<p>The compiler can't use these registers internally as they are explicitly specified as input/output/clobber.</p>



<a name="271884692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271884692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271884692">(Feb 14 2022 at 20:35)</a>:</h4>
<p>I think <code>nostack</code> is wrong, though. And maybe <code>preserves_flags</code> as well.</p>



<a name="271884797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271884797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271884797">(Feb 14 2022 at 20:36)</a>:</h4>
<p>IIRC <code>nostack</code> is "Doesn't use the stack at all".</p>



<a name="271884865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271884865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271884865">(Feb 14 2022 at 20:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271884446">said</a>:</p>
<blockquote>
<p>The compiler can't use these registers internally as they are explicitly specified as input/output/clobber.</p>
</blockquote>
<p>So if the compiler does catch itself with anything in those registers, it has to correctly do the fixup around this code, right?</p>



<a name="271885089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271885089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271885089">(Feb 14 2022 at 20:39)</a>:</h4>
<p>Yes. Though in LLVM and GCC afaik these constraints get directly feeded into the register allocator. For cg_clif it indeed saves and restores registers on the stack as necessary.</p>



<a name="271885239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271885239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271885239">(Feb 14 2022 at 20:40)</a>:</h4>
<p>LLVM and GCC and their time traveling optimizations.</p>



<a name="271885424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271885424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271885424">(Feb 14 2022 at 20:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271884692">said</a>:</p>
<blockquote>
<p>I think <code>nostack</code> is wrong, though. And maybe <code>preserves_flags</code> as well.</p>
</blockquote>
<p>May I ask you why ?</p>



<a name="271885579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271885579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271885579">(Feb 14 2022 at 20:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271884446">said</a>:</p>
<blockquote>
<p>The compiler can't use these registers internally as they are explicitly specified as input/output/clobber.</p>
</blockquote>
<p>In that case, why are other peoples doing these <a href="#narrow/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86/near/266568673">hacks</a> ?</p>



<a name="271886338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271886338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271886338">(Feb 14 2022 at 20:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271885424">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271884692">said</a>:</p>
<blockquote>
<p>I think <code>nostack</code> is wrong, though. And maybe <code>preserves_flags</code> as well.</p>
</blockquote>
<p>May I ask you why ?</p>
</blockquote>
<p>I guess it would depend on how the syscall registers are setup, but if it's just using the user stack, that violates the <code>nostack</code> constraint.</p>



<a name="271886551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271886551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271886551">(Feb 14 2022 at 20:52)</a>:</h4>
<p>syscall certainly won't use user stack.</p>



<a name="271886824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271886824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271886824">(Feb 14 2022 at 20:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271886551">said</a>:</p>
<blockquote>
<p>syscall certainly won't use user stack.</p>
</blockquote>
<p>It sometimes does actually, see <code>compat_alloc_user_space</code>. (This has been removed in the latest kernels though)</p>



<a name="271886859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271886859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271886859">(Feb 14 2022 at 20:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271885579">said</a>:</p>
<blockquote>
<p>In that case, why are other peoples doing these <a href="#narrow/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86/near/266568673">hacks</a> ?</p>
</blockquote>
<p>Because esi is reserved in x86 so it couldn't be specified as input.</p>



<a name="271887270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271887270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271887270">(Feb 14 2022 at 20:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271886824">said</a>:</p>
<blockquote>
<p>It sometimes does actually, see <code>compat_alloc_user_space</code>. (This has been removed in the latest kernels though)</p>
</blockquote>
<p>I think these are still not considered "use of stack" though, because redzones are respected. They are not very different from signal handlers' use of stack.</p>



<a name="271887646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271887646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271887646">(Feb 14 2022 at 21:00)</a>:</h4>
<p>Fair enough.</p>



<a name="271889867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271889867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271889867">(Feb 14 2022 at 21:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271886859">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="327095">Urgau</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271885579">said</a>:</p>
<blockquote>
<p>In that case, why are other peoples doing these <a href="#narrow/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86/near/266568673">hacks</a> ?</p>
</blockquote>
<p>Because esi is reserved in x86 so it couldn't be specified as input.</p>
</blockquote>
<p>But the example use <code>rsi</code>, isn't this also a usage of <code>esi</code> ?</p>



<a name="271889911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271889911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271889911">(Feb 14 2022 at 21:18)</a>:</h4>
<p>esi is only reserved on 32-bit x86.</p>



<a name="271890248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271890248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271890248">(Feb 14 2022 at 21:21)</a>:</h4>
<p>oh! I missed that part. thks</p>



<a name="271890258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271890258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271890258">(Feb 14 2022 at 21:21)</a>:</h4>
<p>So they may need to write a different implementation for x86-32, if they don't already have one?</p>



<a name="271890353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271890353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271890353">(Feb 14 2022 at 21:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271890258">said</a>:</p>
<blockquote>
<p>So they may need to write a different implementation for x86-32, if they don't already have one?</p>
</blockquote>
<p>They'd have to anyways, <code>syscall</code> isn't available in Legacy/Compat mode (except on amd64)</p>



<a name="271890435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271890435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271890435">(Feb 14 2022 at 21:22)</a>:</h4>
<p>The x86 <a href="https://github.com/bytecodealliance/rustix/blob/4f6c2c398065bb44e2588aab6ec352a5ad80f11f/src/imp/linux_raw/arch/inline/x86.rs#L448-L485">implementation</a> already different:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline]</span><span class="w"></span>
<span class="cp">#[must_use]</span><span class="w"></span>
<span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">crate</span>::<span class="n">imp</span><span class="p">)</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">syscall6</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">nr</span>: <span class="nc">SyscallNumber</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a0</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a1</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a2</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a3</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A3</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a4</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A4</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a5</span>: <span class="nc">ArgReg</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">A5</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">RetReg</span><span class="o">&lt;</span><span class="n">R0</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Oof. a3 should go in esi, and a5 should go in ebp, and asm! won't</span>
<span class="w">    </span><span class="c1">// let us use either of those registers as operands. And we can't request</span>
<span class="w">    </span><span class="c1">// stack slots. And there are no other registers free. Use eax as a</span>
<span class="w">    </span><span class="c1">// temporary pointer to a slice, since it gets clobbered as the return</span>
<span class="w">    </span><span class="c1">// value anyway.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// This is another reason that syscalls should be compiler intrinsics</span>
<span class="w">    </span><span class="c1">// rather than inline asm.</span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s">"push ebp"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"push esi"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"mov esi, DWORD PTR [eax + 0]"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"mov ebp, DWORD PTR [eax + 4]"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"mov eax, DWORD PTR [eax + 8]"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"int $$0x80"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"pop esi"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"pop ebp"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">inout</span><span class="p">(</span><span class="s">"eax"</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">a3</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"> </span><span class="n">a5</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"> </span><span class="n">nr</span><span class="p">.</span><span class="n">to_asm</span><span class="p">()]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"ebx"</span><span class="p">)</span><span class="w"> </span><span class="n">a0</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"ecx"</span><span class="p">)</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"edx"</span><span class="p">)</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"edi"</span><span class="p">)</span><span class="w"> </span><span class="n">a4</span><span class="p">.</span><span class="n">to_asm</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">options</span><span class="p">(</span><span class="n">preserves_flags</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">FromAsm</span>::<span class="n">from_asm</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271890510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271890510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271890510">(Feb 14 2022 at 21:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271890353">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271890258">said</a>:</p>
<blockquote>
<p>So they may need to write a different implementation for x86-32, if they don't already have one?</p>
</blockquote>
<p>They'd have to anyways, <code>syscall</code> isn't available in Legacy/Compat mode (except on amd64)</p>
</blockquote>
<p>true dat.</p>



<a name="271890561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271890561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271890561">(Feb 14 2022 at 21:24)</a>:</h4>
<p>I keep forgetting that syscall is an x64 thing.</p>



<a name="271897080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271897080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271897080">(Feb 14 2022 at 22:13)</a>:</h4>
<p>syscall works in 32-bit code, it's just that for historical reasons Linux standardized on syscall for 64-bit and sysenter or int 80 for 32-bit.</p>



<a name="271897637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271897637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271897637">(Feb 14 2022 at 22:17)</a>:</h4>
<p>Do you mean the syscall C function?  syscall the assembly instruction seems to get you UD outside of long mode: <a href="https://www.felixcloutier.com/x86/syscall">https://www.felixcloutier.com/x86/syscall</a></p>



<a name="271897924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271897924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271897924">(Feb 14 2022 at 22:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F/near/271897080">said</a>:</p>
<blockquote>
<p>syscall works in 32-bit code, it's just that for historical reasons Linux standardized on syscall for 64-bit and sysenter or int 80 for 32-bit.</p>
</blockquote>
<p>Only on 64-bit AMD processors (and some legacy amd x86 processors).<br>
From the Intel Developers Manual 2021, Volume 2b, syscall</p>
<blockquote>
<p>Compat/Leg Mode<br>
Invalid</p>
</blockquote>



<a name="271991332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/271991332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Gohman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#271991332">(Feb 15 2022 at 15:36)</a>:</h4>
<p>On 32-bit x86, sysenter isn't available on AMD processors, and int 80 is really slow. So  what we actually use is a vDSO call for most syscalls on 32-bit x86. That lets the kernel give us code which is available on the hardware and fast.</p>



<a name="272032885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/272032885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#272032885">(Feb 15 2022 at 20:25)</a>:</h4>
<p>Sorry, I said that poorly. I should have said "could have worked".</p>



<a name="272032888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/272032888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#272032888">(Feb 15 2022 at 20:25)</a>:</h4>
<p>Not "works".</p>



<a name="272032935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/272032935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#272032935">(Feb 15 2022 at 20:25)</a>:</h4>
<p>The whole history around syscall and sysenter is a mess of confusion. :)</p>



<a name="272032946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Are%20rustix%20syscall%20functions%20sound%20%3F/near/272032946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Are.20rustix.20syscall.20functions.20sound.20.3F.html#272032946">(Feb 15 2022 at 20:25)</a>:</h4>
<p>Sorry for adding to that confusion. :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>