<html>
<head><meta charset="utf-8"><title>`xmm` clobbers · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html">`xmm` clobbers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266462997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266462997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266462997">(Dec 30 2021 at 22:19)</a>:</h4>
<p>Does a <code>out("xmm0") _</code> clobber tell the compiler that the entire fpu register is clobbered?</p>



<a name="266465407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465407">(Dec 30 2021 at 23:03)</a>:</h4>
<p>It clobbers <code>ymm0</code> and <code>zmm0</code> as well.</p>



<a name="266465414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465414">(Dec 30 2021 at 23:03)</a>:</h4>
<p>If that's what you're asking.</p>



<a name="266465462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465462">(Dec 30 2021 at 23:04)</a>:</h4>
<p>It has no effect on the x87 registers, which are separate.</p>



<a name="266465574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465574">(Dec 30 2021 at 23:06)</a>:</h4>
<p>Speaking of the x87 registers, is thee a guaranteed state for them entering the asm or would you need to use <code>fninit</code> to do anything with them at all?</p>



<a name="266465602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465602">(Dec 30 2021 at 23:07)</a>:</h4>
<p>If you clobber them then the FP stack is guaranteed to be empty.</p>



<a name="266465613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465613">(Dec 30 2021 at 23:07)</a>:</h4>
<p>Hmm that's not documented though.</p>



<a name="266465666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465666">(Dec 30 2021 at 23:08)</a>:</h4>
<p>That would be good to document. Does that apply if you just clobber st0, or do you need to clobber all 8 of them?</p>



<a name="266465686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465686">(Dec 30 2021 at 23:08)</a>:</h4>
<p>At the moment clobbering one of them will cause all of them to be clobbered.</p>



<a name="266465963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266465963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266465963">(Dec 30 2021 at 23:14)</a>:</h4>
<p>GCC inline assembly has pretty complex rules to deal with the x87 register stack that I frankly do not want to bother with: <a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#x86-Floating-Point-asm-Operands">https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#x86-Floating-Point-asm-Operands</a></p>



<a name="266479553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266479553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266479553">(Dec 31 2021 at 04:02)</a>:</h4>
<p>I think making the rule that if you clobber any x87 floating point register you clobber them all seems reasonable.</p>



<a name="266479584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266479584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266479584">(Dec 31 2021 at 04:03)</a>:</h4>
<p>I don't think we should strive for making it easy or efficient to pass in values via floating point stack state, because if you wanted ease or efficiency you wouldn't use x87.</p>



<a name="266480249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266480249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266480249">(Dec 31 2021 at 04:20)</a>:</h4>
<p>Well, it should be reasonable to call subroutines in x86, most of which, the calling convention requires the stack be empty at entry (and leaves it either empty, or, for 32-bit, with 1 value for a floating-point return value)</p>



<a name="266480722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266480722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266480722">(Dec 31 2021 at 04:33)</a>:</h4>
<p>It also may be useful for such to be able to store values from the fp stack into f32 and f64 values, again, to match the calling conventions of such functions returning float or double. It shouldn't be unreasonable to match well-known calling conventions with rust's inline assembly, especially ones that aren't supported (even unstably). This (actually this entire thread) came up on the Rust Community Discord's dark-arts channel, where a couple of people were trying to wrap the Borland register calling convention.</p>



<a name="266480944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266480944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266480944">(Dec 31 2021 at 04:38)</a>:</h4>
<p>(And these aren't really limited to that convention either, every 32-bit x86 convention I can find returns <code>float</code>, <code>double</code>, and <code>long double</code> in <code>st(0)</code>)</p>



<a name="266482885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266482885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266482885">(Dec 31 2021 at 05:30)</a>:</h4>
<p>To clarify, I absolutely agree that we need to support such calling conventions and other similar things. Rather, I'm saying we don't necessarily need the full complexity of supporting partial clobbers of the x87 floating-point stack, for instance.</p>



<a name="266482903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%60xmm%60%20clobbers/near/266482903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.60xmm.60.20clobbers.html#266482903">(Dec 31 2021 at 05:31)</a>:</h4>
<p><em>Arbitrary</em> floating-point stack state doesn't seem as critical as the portions of that state used by calling conventions.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>