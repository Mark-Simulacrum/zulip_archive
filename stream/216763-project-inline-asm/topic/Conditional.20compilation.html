<html>
<head><meta charset="utf-8"><title>Conditional compilation · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html">Conditional compilation</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248958628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248958628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248958628">(Aug 10 2021 at 09:45)</a>:</h4>
<p>I would like to use cfg attributes with assembly, such as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="c1">// cut</span>
<span class="w">        </span><span class="cp">#[cfg(target_endian = </span><span class="s">"big"</span><span class="cp">)]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="s">"bswap {0}"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// cut</span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>If this is already possible somehow, please add it to The Rust Unstable Book.</p>



<a name="248958763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248958763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248958763">(Aug 10 2021 at 09:46)</a>:</h4>
<p>I don't think this is possible.</p>



<a name="248958811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248958811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248958811">(Aug 10 2021 at 09:47)</a>:</h4>
<p>There is a workaround: you can define a <code>macro_rules!</code> which expands to different things depending on <code>cfg</code> flags.</p>



<a name="248961756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248961756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248961756">(Aug 10 2021 at 10:20)</a>:</h4>
<p>Thanks, macros work</p>
<p>Following the earlier example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(not(target_endian = </span><span class="s">"big"</span><span class="cp">))]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">""</span><span class="w"> </span><span class="c1">// nop</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg(target_endian = </span><span class="s">"big"</span><span class="cp">)]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">$arg</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[cfg(target_endian = </span><span class="s">"little"</span><span class="cp">)]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">$arg</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[cfg(not(target_endian = </span><span class="s">"little"</span><span class="cp">))]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">""</span><span class="w"> </span><span class="c1">// nop</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="248961783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248961783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248961783">(Aug 10 2021 at 10:20)</a>:</h4>
<p>Yep, that looks right.</p>



<a name="248961789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248961789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248961789">(Aug 10 2021 at 10:20)</a>:</h4>
<p>Maybe officially supported solution could be something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cfg_asm</span><span class="p">(</span><span class="n">not</span><span class="p">(</span><span class="n">target_endian</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"big"</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s">"bswap {0}"</span><span class="p">,</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>Or expand scope of cfg! macro with edition upgrade?</p>



<a name="248967404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248967404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248967404">(Aug 10 2021 at 11:38)</a>:</h4>
<p>You can do this though:</p>
<div class="codehilite"><pre><span></span><code>#[cfg(target_endian=&quot;big&quot;)]
asm!(&quot;...&quot;);
</code></pre></div>
<p>or just </p>
<div class="codehilite"><pre><span></span><code>if cfg!(...) { ... }
</code></pre></div>



<a name="248967458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248967458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248967458">(Aug 10 2021 at 11:39)</a>:</h4>
<p>yes, it doesn't allow you to have a single asm statement with something in the middle inserted conditionally, but you could split the asm blocks too...</p>



<a name="248979182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/248979182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#248979182">(Aug 10 2021 at 13:34)</a>:</h4>
<p>Duplication works too but it moves the burden of synchronizing identical bits to humans.</p>
<p>I would consider duplication reasonable only for procedurally generated stuff stored out-of-band.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(target_endian = </span><span class="s">"little"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="fm">include_str!</span><span class="p">(</span><span class="s">"my_l33t_code-le.asm"</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">inout</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// cut</span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(target_endian = </span><span class="s">"big"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="fm">include_str!</span><span class="p">(</span><span class="s">"my_l33t_code-be.asm"</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">inout</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// cut</span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249009261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249009261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249009261">(Aug 10 2021 at 17:24)</a>:</h4>
<p>Another option would be for asm to support compile-time const strings, which in turn could be controlled by cfg.</p>



<a name="249015974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249015974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249015974">(Aug 10 2021 at 18:18)</a>:</h4>
<p>That's much harder: currently we parse the template string during macro expansion.</p>



<a name="249053388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249053388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249053388">(Aug 10 2021 at 23:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Conditional.20compilation/near/248958763">said</a>:</p>
<blockquote>
<p>I don't think this is possible.</p>
</blockquote>
<p>Hmm, just to check, does <code>asm!</code> have any limitations here that aren't shared by the <code>format_args!</code>-likes?</p>



<a name="249053460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249053460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249053460">(Aug 10 2021 at 23:56)</a>:</h4>
<p>It reuses the same parsing logic as <code>format_args!</code> in the compiler.</p>



<a name="249053615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249053615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249053615">(Aug 10 2021 at 23:58)</a>:</h4>
<p>hm, okay. that seems fine then. although i'm surprised it can expand macros but not stuff like <code>#[cfg()]</code>. (but maybe eventually builtin macros will learn how to expand those)</p>



<a name="249053671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249053671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249053671">(Aug 10 2021 at 23:59)</a>:</h4>
<p>The #[cfg] in that example is a bit tricky: there's no precedent for using it to make an item in a comma-separated list disappear.</p>



<a name="249055634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249055634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249055634">(Aug 11 2021 at 00:24)</a>:</h4>
<p>sure, but i'd hope eventually </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(foo)]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">"..."</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(not(foo))]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>would work, but i guess at that point, you might just use a macro approach to avoid duplicating the body of the cfg...</p>



<a name="249055758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Conditional%20compilation/near/249055758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Conditional.20compilation.html#249055758">(Aug 11 2021 at 00:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/216763-project-inline-asm/topic/Conditional.20compilation/near/249053671">said</a>:</p>
<blockquote>
<p>there's no precedent for using it to make an item in a comma-separated list disappear.</p>
</blockquote>
<p>also, this isn't <em>entirely</em> true. or, rather, it depends if you consider the list of fields of a struct / list of variants of an enum a comma-separated list (but yeah, these are not part of the expression grammar)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>