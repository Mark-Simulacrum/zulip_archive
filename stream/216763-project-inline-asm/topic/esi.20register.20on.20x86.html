<html>
<head><meta charset="utf-8"><title>esi register on x86 · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html">esi register on x86</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266567478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266567478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266567478">(Jan 01 2022 at 17:49)</a>:</h4>
<p>If i try to use <code>in("esi")</code> on x86 (32-bit), i get this error:</p>
<div class="codehilite"><pre><span></span><code>error: invalid register `esi`: esi is used internally by LLVM and cannot be used as an operand for inline asm
</code></pre></div>
<p>But if i then add <code>push esi; mov esi, {arg}; ... pop esi</code> and <code>arg = in(reg) arg</code>, it  ends up picking <code>esi</code> anyway, resulting in a useless <code>mov esi, esi</code>. Is that a bug? Should it avoid esi there as well? Or should it allow picking esi explicitly too?</p>



<a name="266567486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266567486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266567486">(Jan 01 2022 at 17:49)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="143274">@Amanieu</span> since you added that error in <a href="https://github.com/rust-lang/rust/issues/84658">#84658</a></p>



<a name="266567860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266567860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266567860">(Jan 01 2022 at 18:00)</a>:</h4>
<p>Esi is reserved by LLVM. Under certain conditions I believe it stores a frame pointer there. If this is not the case, LLVM can use it for inline asm just fine. It isn't possible for rustc to conditionally allow it as it depends on optimizations if esi is used by LLVM.</p>



<a name="266568332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266568332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266568332">(Jan 01 2022 at 18:11)</a>:</h4>
<p><span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="fm">asm!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"int $0x80</span>
<span class="s">        .set _check_esi_is_esi, 0</span>
<span class="s">        .set _check_esi_is_{esi}, 1</span>
<span class="s">        .if _check_esi_is_esi == 0</span>
<span class="s">        .err </span><span class="se">\"</span><span class="s">Selected register {esi} instead of esi.</span><span class="se">\"</span><span class="s"></span>
<span class="s">        .endif"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">esi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">arg4</span><span class="p">,</span><span class="w"> </span><span class="c1">// HACK: We can't explicitly pick esi, but this will implicitly pick esi.</span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"eax"</span><span class="p">)</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"ebx"</span><span class="p">)</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"ecx"</span><span class="p">)</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"edx"</span><span class="p">)</span><span class="w"> </span><span class="n">arg3</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">lateout</span><span class="p">(</span><span class="s">"eax"</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">options</span><span class="p">(</span><span class="n">nostack</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="266568342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266568342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266568342">(Jan 01 2022 at 18:12)</a>:</h4>
<p>(joking, obviously ^^. seems to work fine though ^^')</p>



<a name="266568616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266568616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266568616">(Jan 01 2022 at 18:19)</a>:</h4>
<p>I approve of this hack.</p>



<a name="266568673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266568673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266568673">(Jan 01 2022 at 18:20)</a>:</h4>
<p>improved hack that keeps working if it picks another register:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="fm">asm!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">".set _arg4_is_esi, 0</span>
<span class="s">         .set _arg4_is_{arg4}, 1</span>
<span class="s">         .if _arg4_is_esi</span>
<span class="s">         int $0x80</span>
<span class="s">         .else</span>
<span class="s">         push esi</span>
<span class="s">         mov esi, {arg4}</span>
<span class="s">         int $0x80</span>
<span class="s">         pop esi</span>
<span class="s">         .endif"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">arg4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">arg4</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"eax"</span><span class="p">)</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"ebx"</span><span class="p">)</span><span class="w"> </span><span class="n">arg1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"ecx"</span><span class="p">)</span><span class="w"> </span><span class="n">arg2</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">in</span><span class="p">(</span><span class="s">"edx"</span><span class="p">)</span><span class="w"> </span><span class="n">arg3</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">lateout</span><span class="p">(</span><span class="s">"eax"</span><span class="p">)</span><span class="w"> </span><span class="n">ret</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">options</span><span class="p">(</span><span class="n">nostack</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="266568682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266568682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266568682">(Jan 01 2022 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> thanks for the explanation :)</p>



<a name="266569666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266569666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266569666">(Jan 01 2022 at 18:46)</a>:</h4>
<p>This comment in LLVM explains why 3 different pointers into the stack frame are needed (esp+ebp+esi): <a href="https://github.com/llvm/llvm-project/blob/69ccc96162aa3471389d98184e0d683573edb47d/llvm/lib/Target/X86/X86FrameLowering.cpp#L2361">https://github.com/llvm/llvm-project/blob/69ccc96162aa3471389d98184e0d683573edb47d/llvm/lib/Target/X86/X86FrameLowering.cpp#L2361</a></p>



<a name="266570007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266570007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266570007">(Jan 01 2022 at 18:54)</a>:</h4>
<p>thank you!</p>



<a name="266571830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266571830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266571830">(Jan 01 2022 at 19:39)</a>:</h4>
<p>Note, when making syscalls on 32-bit x86 linux, esi and ebp contain two later (4th and 6th) arguments, so this is a potential issue.</p>



<a name="266572264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266572264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266572264">(Jan 01 2022 at 19:51)</a>:</h4>
<p>I love this solution</p>



<a name="266576297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266576297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266576297">(Jan 01 2022 at 21:30)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> I don't think I understand why LLVM can't just do stack offset tracking, the same way it does when doing without a frame pointer.</p>



<a name="266576377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266576377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266576377">(Jan 01 2022 at 21:32)</a>:</h4>
<p>In any case, esi/rsi is definitely a register people need to be able to use; this seems like something LLVM could save and restore on behalf of the asm block, the same way it arranges to move a variable out of a register if the asm block says it needs that register.</p>



<a name="266578283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266578283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266578283">(Jan 01 2022 at 22:09)</a>:</h4>
<p>The stack size may sometimes be unknown at compile time. Either because of requiring stack aligning or because of alloca. In that case stack adding and substracting fixed amounts from the stack pointer isn't enough. It would be possible to save the pointers at a fixed offset on the stack, but that would quickly get complicated and likely be less performant.</p>



<a name="266584357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266584357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266584357">(Jan 02 2022 at 00:20)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I can definitely understand alloca requiring <em>one</em> stack pointer; I just don't know why it'd need <em>two</em>.</p>



<a name="266584370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266584370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266584370">(Jan 02 2022 at 00:21)</a>:</h4>
<p>Because of stack realignment on function entry.</p>



<a name="266584440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266584440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266584440">(Jan 02 2022 at 00:23)</a>:</h4>
<p>If the incoming stack alignment is 4 but your locals need an alignment of 64 then you need to dynamically align the stack. The frame pointer points to the stack frame <em>before</em> alignment: this is needed to address incoming stack parameters. The base pointer points to your fixed-sized locals. The stack pointer points to the edge of the stack, after any dynamic allocas.</p>



<a name="266584561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266584561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266584561">(Jan 02 2022 at 00:26)</a>:</h4>
<p>Basically you have 2 unknown offsets:</p>
<ul>
<li>the offset between your locals and the parent frame (which contains stack args).</li>
<li>the offset between your locals and the bottom of the stack (due to variable alloca).</li>
</ul>



<a name="266588089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/266588089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#266588089">(Jan 02 2022 at 02:02)</a>:</h4>
<p>example of llvm messing up inline assembly with <code>esi</code>: <a href="https://llvm.godbolt.org/z/MKqTdqvrG">https://llvm.godbolt.org/z/MKqTdqvrG</a></p>



<a name="269051640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/269051640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#269051640">(Jan 24 2022 at 01:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86/near/266568673">said</a>:</p>
<blockquote>
<p>improved hack that keeps working if it picks another register:<br>
...</p>
</blockquote>
<p>i came to reference this because its very cursed (which i like), but in case you didn't notice this and used it as-is, it shouldn't have <code>options(nostack)</code>.</p>



<a name="271482397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/271482397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#271482397">(Feb 10 2022 at 19:31)</a>:</h4>
<p>Is this also fine?</p>
<div class="codehilite"><pre><span></span><code>pub unsafe fn syscall6(mut n: isize, a1: isize, a2: isize, a3: isize, a4: isize, a5: isize, a6: isize) -&gt; isize {
    asm! {&quot;
        .if {a4} != esi
            push esi
            mov esi, {a4}
        .endif
        .if {a6} != ebp
            push ebp
            mov ebp {a6}
        .endif

        int $0x80

        .if {a4} != esi
            pop esi
        .endif
        .if {a6} != ebp
            pop ebp
        .endif
        &quot;,
    a4 = in(reg) a4,
    a6 = in(reg) a6,
    inlateout(&quot;eax&quot;) n,
    in(&quot;ebx&quot;) a1,
    in(&quot;ecx&quot;) a2,
    in(&quot;edx&quot;) a3,
    in(&quot;edi&quot;) a5,
    options(nostack)
    };
    n
}
</code></pre></div>



<a name="271482604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/271482604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#271482604">(Feb 10 2022 at 19:32)</a>:</h4>
<p>What if <code>a6</code> is assigned to <code>esi</code> and <code>a4</code> is assigned to <code>ebp</code>?</p>



<a name="271482703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/esi%20register%20on%20x86/near/271482703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86.html#271482703">(Feb 10 2022 at 19:33)</a>:</h4>
<p>Also if there's any kind of complex stack frame that requires a frame pointer then register allocation is simply going to fail hard.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>