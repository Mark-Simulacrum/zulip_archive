<html>
<head><meta charset="utf-8"><title>✔ Can nostack be specified if the stack just doesn&#x27;t need... · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html">✔ Can nostack be specified if the stack just doesn&#x27;t need...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254887863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/254887863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#254887863">(Sep 26 2021 at 01:56)</a>:</h4>
<p>Anyway, if it can't be added now that's fine. Nothing about the current design would prevent this from being added in the future if more people ended up needing it later.</p>



<a name="254946858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/254946858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#254946858">(Sep 26 2021 at 17:20)</a>:</h4>
<p>register alloc and inlining means it should "just work" anyways.</p>



<a name="254950792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/254950792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#254950792">(Sep 26 2021 at 18:19)</a>:</h4>
<p>I don't follow what inlining you mean.</p>



<a name="254962678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/254962678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#254962678">(Sep 26 2021 at 21:15)</a>:</h4>
<p>If it goes something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">top_fn</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">some_fn</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_with_asm</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">another_fn</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and those all get pulled together and inlined<br>
LLVM shouldn't need to feel the need to align to the ABI before/after <code>fn_with_asm()</code> when it looks at them all together. It should "just work".</p>



<a name="254962758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/254962758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#254962758">(Sep 26 2021 at 21:16)</a>:</h4>
<p>and LLVM's baseline inlining heuristics should mean this basically always happens.</p>



<a name="254969351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/254969351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#254969351">(Sep 26 2021 at 22:59)</a>:</h4>
<p>my concern was more to the effect of:</p>
<div class="codehilite"><pre><span></span><code>// version 1
some_fn() {
  // stuff that requires pushing an odd number of stack values

  inline_asm_call_that_uses_stack_but_only_aligned_to_4()
}
</code></pre></div>
<p>Imagining for a moment that the stack is aligned to 8 the start of all rust calls (which honestly doesn't seems necessary on ARM32, but whatever).<br>
And supposing that <code>some_fn</code> was <em>otherwise</em> going to push an odd number of values to the stack. Say it needs to use a callee save register to have enough space to do all its work for example. So it needs to push one value. This would make the stack aligned to only 4 during the function.<br>
Now we have that inline_asm call, which uses the stack, and technically only requires a stack alignment of 4, but we have no way to communicate that to rustc/LLVM.<br>
This means that some_fn, which was going to push an odd number of registers onto the stack, must now push 1 additional register to the stack to keep it aligned to 8. And pop one additional register after the call as well.<br>
This costs us a whopping 2 sequential accesses, which is probably 2 CPU cycles because your stack is probably in memory fast enough to have no waiting. Which is a very small cost, but not zero.</p>
<p>And enough inline can probably reduce how often you hit the case where the stack was going to have an odd number of registers pushed, but it can still come up.</p>



<a name="255286766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255286766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255286766">(Sep 28 2021 at 19:49)</a>:</h4>
<p>it's true, only a great compiler would always fix this without needing to be explicitly told, and LLVM is merely a pretty good one.</p>



<a name="255287531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255287531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255287531">(Sep 28 2021 at 19:53)</a>:</h4>
<p>Well, usually the stack pointer is adjusted first and values are saved to stack pointer plus offset, rather than individual pushes. So compiler would only need to change the adjustment.</p>



<a name="255289470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255289470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255289470">(Sep 28 2021 at 20:05)</a>:</h4>
<p>I was already assuming just one batch of pushes at the start, and then one batch of pops at the end.</p>



<a name="255289733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255289733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255289733">(Sep 28 2021 at 20:06)</a>:</h4>
<p>But even if all pushes are in one batch at the start of the function it takes an extra sequential access cycle to push an additional register.</p>



<a name="255290225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255290225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255290225">(Sep 28 2021 at 20:09)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> I'm afraid that no amount of compiler smartness can fix the issue. It's like, just a natural consequence of the way that these definitions come together.</p>
<p>The fix, if it were critical, would be a new <code>asm!</code> option that's defined more loosely, or a new compiler target with a different data layout definition.</p>



<a name="255327567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255327567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255327567">(Sep 29 2021 at 01:29)</a>:</h4>
<p>i feel like there are way lower hanging fruit in rust/llvm codegen than this</p>



<a name="255330141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255330141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255330141">(Sep 29 2021 at 02:05)</a>:</h4>
<p>well, sorta. If you go the custom-target path then it's literally just a json file you put in a project for the new target and you're done. Otherwise, yes, it requires an actual rustc/llvm change.</p>



<a name="255333148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255333148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255333148">(Sep 29 2021 at 02:48)</a>:</h4>
<p>if this is just a complaint about the current target file for some target then i feel like it might be a bit off topic.</p>



<a name="255334310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20Can%20nostack%20be%20specified%20if%20the%20stack%20just%20doesn%27t%20need.../near/255334310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20Can.20nostack.20be.20specified.20if.20the.20stack.20just.20doesn&#x27;t.20need.2E.2E.2E.html#255334310">(Sep 29 2021 at 03:04)</a>:</h4>
<p>No. I've tried to be quite clear about this. There's two possible fixes to the potential problem, and one of them is to add an extra option to how <code>asm!</code> works, which is how this thread started.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>