<html>
<head><meta charset="utf-8"><title>.intel_syntax noprefix · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html">.intel_syntax noprefix</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273827914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273827914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273827914">(Mar 02 2022 at 15:54)</a>:</h4>
<p>So, heh, I was playing arround on compiler explorer, and I discovered this problem with GNU AS:<br>
<a href="https://godbolt.org/z/3js4Pfds7">https://godbolt.org/z/3js4Pfds7</a></p>
<p>Currently, the reference (after <a href="https://github.com/rust-lang/rust/issues/1168">#1168</a>) says that <code>.intel_syntax</code> on its own is fine and defaults to <code>.intel_syntax noprefix</code>.<br>
This is true of llvm-mc (<a href="https://godbolt.org/z/rKhqPxKvr">https://godbolt.org/z/rKhqPxKvr</a>), but apparently not of GNU AS as demonstrated above without the option, it seems to default to <code>.intel_syntax prefix</code>.</p>



<a name="273828619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273828619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ray Redondo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273828619">(Mar 02 2022 at 15:58)</a>:</h4>
<p>So <code>rustc</code> could probably fix this by converting it from <code>.intel_syntax\n</code> to <code>.intel_syntax noprefix\n</code></p>



<a name="273829284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273829284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273829284">(Mar 02 2022 at 16:01)</a>:</h4>
<p>The issue is that rustc doesn't want to fix this, as it requires parsing the assembly string, which is <em>fun</em>.</p>



<a name="273829539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273829539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273829539">(Mar 02 2022 at 16:02)</a>:</h4>
<p>TBH that's really an issue on the LLVM side.</p>



<a name="273829754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273829754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273829754">(Mar 02 2022 at 16:03)</a>:</h4>
<p>Well, it's a docs issue as well. The current definition is that <code>.intel_syntax</code> on it's own is supported and equivalent to the default w/o the <code>att_syntax</code> option (<code>.intel_syntax noprefix</code>), which is false on GNU AS.<br>
I'm filling a reference PR to get this fixed ASAP.</p>



<a name="273830285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273830285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273830285">(Mar 02 2022 at 16:06)</a>:</h4>
<p><a href="https://github.com/rust-lang/reference/pull/1174">https://github.com/rust-lang/reference/pull/1174</a></p>



<a name="273841526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273841526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273841526">(Mar 02 2022 at 17:11)</a>:</h4>
<p>So at this point I don't think documenting those directives is worth it anymore.</p>



<a name="273841542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273841542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273841542">(Mar 02 2022 at 17:11)</a>:</h4>
<p>Perhaps we should just drop them.</p>



<a name="273850635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273850635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273850635">(Mar 02 2022 at 18:03)</a>:</h4>
<p>Not documenting things does not fix the situation though. And given that a non-zero amount of people might use gnu-as it's worth making consistent or documenting the inconsistency if we for some reason can't make it consistent.</p>



<a name="273850794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273850794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273850794">(Mar 02 2022 at 18:04)</a>:</h4>
<p>I'm suggesting perhaps we shouldn't actually make them supported directives in the first place, if they're inconsistently supported.</p>



<a name="273850838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273850838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273850838">(Mar 02 2022 at 18:04)</a>:</h4>
<p>But yes, if we do support them we need to document the inconsistency.</p>



<a name="273850857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273850857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273850857">(Mar 02 2022 at 18:04)</a>:</h4>
<p>Though also, I agree that this is an LLVM bug.</p>



<a name="273851115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273851115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273851115">(Mar 02 2022 at 18:06)</a>:</h4>
<p>We already have a lint that discourages the use of <code>.att_syntax/.intel_syntax</code> in favor of <code>option(att_syntax)</code>.</p>



<a name="273851175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273851175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273851175">(Mar 02 2022 at 18:06)</a>:</h4>
<p>Yeah given the option existing, we probably don't need to support it in the assembly itself</p>



<a name="273851293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273851293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273851293">(Mar 02 2022 at 18:07)</a>:</h4>
<p>I did use it at one point to work around some limitations of LLVM's intel syntax support for a single instruction. But I later found a better workaround for that particular bug that doesn't require switching to AT&amp;T syntax.</p>



<a name="273860174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273860174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273860174">(Mar 02 2022 at 19:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix/near/273850794">said</a>:</p>
<blockquote>
<p>I'm suggesting perhaps we shouldn't actually make them supported directives in the first place, if they're inconsistently supported.</p>
</blockquote>
<p>As far as I can tell, if you use an option, it's consistent, so if it's still desirable to support the directive, just removing the no-option form from support (which is what the PR does) should be sufficient.</p>



<a name="273861705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273861705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273861705">(Mar 02 2022 at 19:15)</a>:</h4>
<p>Trying to make sure I understand: you actually have to pass the option to att_syntax, writing <code>.att_syntax prefix</code>?</p>



<a name="273861997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273861997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273861997">(Mar 02 2022 at 19:18)</a>:</h4>
<p>Under the proposed limitations? Yes.</p>



<a name="273862363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273862363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273862363">(Mar 02 2022 at 19:21)</a>:</h4>
<p>I would note that there does not appear to be such an inconsistency for <code>.att_syntax</code> (the issue is with <code>.intel_syntax</code>), but I removed the no-arg form of <code>.att_syntax</code> in the PR for consistency with <code>.intel_syntax</code>).</p>
<p>See: <a href="https://godbolt.org/z/ba3z6PqYT">https://godbolt.org/z/ba3z6PqYT</a> (Demonstrates the equivalence on clang between <code>.att_syntax</code> and <code>.att_syntax prefix</code>)</p>



<a name="273870194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/.intel_syntax%20noprefix/near/273870194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.2Eintel_syntax.20noprefix.html#273870194">(Mar 02 2022 at 20:16)</a>:</h4>
<p>OK, that's good to know. That's consistent with how I previously thought this worked, where people typically write <code>.att_syntax</code> and <code>.intel_syntax noprefix</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>