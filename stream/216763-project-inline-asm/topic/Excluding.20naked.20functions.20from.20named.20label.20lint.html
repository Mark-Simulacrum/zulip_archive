<html>
<head><meta charset="utf-8"><title>Excluding naked functions from named label lint · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html">Excluding naked functions from named label lint</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249781725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249781725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249781725">(Aug 17 2021 at 21:31)</a>:</h4>
<p>I am trying to add an exclusion for named labels in <code>#[naked]</code> functions and I can't think of a good way to do it.  The potential options that I can see are 1. somehow add an implicit <code>#[allow]</code> for the lint with every <code>#[naked]</code> 2. somehow access the containing function from the macro expansion and analyze its attributes, or 3. move to a lint implemented with <code>check_item</code> and walk through the AST to implement the lint.</p>
<p>For 1. it feels ugly and I am not sure where to do it<br>
For 2. I am not sure if that information is available or how to get it<br>
For 3. The data will be the asm template <strong>after</strong> it's expanded, and the spans and template are wrong and I don't think I can work with the span for the source correctly</p>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> <span class="user-mention" data-user-id="133247">@bjorn3</span></p>



<a name="249791148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249791148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249791148">(Aug 17 2021 at 23:18)</a>:</h4>
<p>Well I'd say 2 is right out, I'm not even sure it's possible.</p>



<a name="249792986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249792986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249792986">(Aug 17 2021 at 23:48)</a>:</h4>
<p>Or maybe keep the strings in the AST and move the template expansion to ast lowering? That doesn't sound ideal either tho</p>



<a name="249793032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249793032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249793032">(Aug 17 2021 at 23:50)</a>:</h4>
<p>Yea I was afraid of that, 2 seemed like the nicest and cleanest :(</p>



<a name="249802107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249802107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249802107">(Aug 18 2021 at 02:51)</a>:</h4>
<p>Or maybe even delay the template expansion until MIR build. The template doesn't seem to affect type check?</p>



<a name="249886886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249886886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249886886">(Aug 18 2021 at 17:51)</a>:</h4>
<p>Perhaps you could implement the lint as an AST pass and just add an element to the <code>InlineAsm</code> AST node which includes the spans that you need?</p>



<a name="249913062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249913062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249913062">(Aug 18 2021 at 21:17)</a>:</h4>
<p>I need the spans of the template <em>pieces</em> but the parser only gives spans for lines as a whole or for arguments</p>



<a name="249913202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/249913202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#249913202">(Aug 18 2021 at 21:18)</a>:</h4>
<p>Wait what am I talking about, no I don't, I just need the span as a whole and the original template string</p>



<a name="250045440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/250045440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#250045440">(Aug 19 2021 at 20:34)</a>:</h4>
<p>I have it working using a <code>EarlyLintPass</code> lint that more or less was just a few changes to the <code>ast::InlineAsm</code> to pass the needed data to it</p>



<a name="250045567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/250045567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#250045567">(Aug 19 2021 at 20:36)</a>:</h4>
<p>I think an ideal world would have the entire asm template expansion done later to avoid needing to pass around a sort of half-parsed state, and some of the other lints like the one for syntax directives could be made similar.  But for now I have the immediate issue fixed.</p>



<a name="250049399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/Excluding%20naked%20functions%20from%20named%20label%20lint/near/250049399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/Excluding.20naked.20functions.20from.20named.20label.20lint.html#250049399">(Aug 19 2021 at 21:08)</a>:</h4>
<p>I think the lint doesn't account for nested items. A stack should fix this issue, but I am uncertain how it's done in other lints.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>