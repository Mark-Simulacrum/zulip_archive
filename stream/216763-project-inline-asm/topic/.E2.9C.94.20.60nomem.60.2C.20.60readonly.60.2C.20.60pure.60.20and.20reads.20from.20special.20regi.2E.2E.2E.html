<html>
<head><meta charset="utf-8"><title>✔ `nomem`, `readonly`, `pure` and reads from special regi... · project-inline-asm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/index.html">project-inline-asm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html">✔ `nomem`, `readonly`, `pure` and reads from special regi...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264443060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443060">(Dec 10 2021 at 13:00)</a>:</h4>
<p>Does a block that reads from a special register count as <code>nomem</code>? What about <code>readonly</code>? Some examples of what I mean from aarch64 (at least on darwin):</p>
<ol>
<li>
<p><code>"mov {}, cntvct_el0"</code>? Read the virtual timestamp counter (basically like <code>rdtsc</code> but with an even more abstract freq).</p>
<p>This can return a different value each time, so it's definitely not <code>pure</code>, but it doesn't actually touch "memory", and certainly doesn't <em>write</em> anything...</p>
<p>My gut says that <code>readonly</code> applies, but not <code>nomem</code>, but I am... not sure at all.</p>
</li>
<li>
<p>A bit different (and much harder): <code>"mov {}, tpidrro_el0"</code>? Reads a thread id.</p>
<p>This shouldn't change on this thread, but isn't globally fixed... I guess am unsure about all three of <code>readonly</code>, <code>nomem</code>, and <code>pure</code>, and don't even really have a very good guess.</p>
</li>
</ol>



<a name="264443315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443315">(Dec 10 2021 at 13:03)</a>:</h4>
<p>Yes it is <code>nomem</code>, but it is not <code>pure</code>.</p>



<a name="264443333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443333">(Dec 10 2021 at 13:03)</a>:</h4>
<p>interesting</p>



<a name="264443561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443561">(Dec 10 2021 at 13:05)</a>:</h4>
<p>So, that's the case for both of them? Easy enough</p>



<a name="264443579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443579">(Dec 10 2021 at 13:05)</a>:</h4>
<p>It's definitely the case for the first one.</p>



<a name="264443594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443594">(Dec 10 2021 at 13:05)</a>:</h4>
<p>The second one is harder</p>



<a name="264443602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443602">(Dec 10 2021 at 13:05)</a>:</h4>
<p>For the second one, it <em>might</em> be <code>pure</code> but I'm not sure.</p>



<a name="264443751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443751">(Dec 10 2021 at 13:07)</a>:</h4>
<p>I guess the concern is if the compiler could transform something like <code>thread::spawn(|| { let my_id = &lt;read id with asm&gt;; ...})</code> into something where the ID is computed outside the closure and passed in.</p>



<a name="264443810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443810">(Dec 10 2021 at 13:07)</a>:</h4>
<p>I think it's not pure. Pure means that the output depends only on the inputs, but that's not the case here.</p>



<a name="264443839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443839">(Dec 10 2021 at 13:07)</a>:</h4>
<p>in practice that transform would require some, uh, serious compiler heroics, but seems legal</p>



<a name="264443842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443842">(Dec 10 2021 at 13:07)</a>:</h4>
<p>yeah</p>



<a name="264443944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264443944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264443944">(Dec 10 2021 at 13:08)</a>:</h4>
<p>Okay.</p>



<a name="264450282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264450282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264450282">(Dec 10 2021 at 13:57)</a>:</h4>
<p>FWIW, it doesn't matter for the question, but just in case anybody tries to use the code above: It seems as though <code>tpidrro_el0</code> actually includes a few bits for the CPU number (at least 3 bits, but this machine has 8 cores, so perhaps a system-dependent number of bits) in addition to the thread pointer.</p>
<p>I thought this might be the case, but didn't mention it because I wasn't sure (and was leaning the other way), and it doesn't make <em>that</em> much of a difference (as the asm can just mask these bits away before returning, which would lead to a value thats the same the whole time on the thread). Given the answer to the question, this doesn't matter, just thought I'd note it rather than leave the bug just sitting there.</p>



<a name="264450457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264450457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264450457">(Dec 10 2021 at 13:59)</a>:</h4>
<p>The value of <code>tpidrro_el0</code> is set by the OS, it's RO at EL0 and RW at EL1+.</p>



<a name="264453812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264453812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264453812">(Dec 10 2021 at 14:23)</a>:</h4>
<p>right, i meant read then mask</p>



<a name="264454396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216763-project-inline-asm/topic/%E2%9C%94%20%60nomem%60%2C%20%60readonly%60%2C%20%60pure%60%20and%20reads%20from%20special%20regi.../near/264454396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216763-project-inline-asm/topic/.E2.9C.94.20.60nomem.60.2C.20.60readonly.60.2C.20.60pure.60.20and.20reads.20from.20special.20regi.2E.2E.2E.html#264454396">(Dec 10 2021 at 14:27)</a>:</h4>
<p>as in <code>asm!("mrs {0}, tpidrro_el0", "bic {0}, {0}, 7", out(reg)result, options(...))</code> (my masking is actually done in rust, but to make sense for the quesiton it would have to be done in before exiting the asm)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>