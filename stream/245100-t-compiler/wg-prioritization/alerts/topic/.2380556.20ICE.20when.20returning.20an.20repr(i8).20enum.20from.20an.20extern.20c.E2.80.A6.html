<html>
<head><meta charset="utf-8"><title>#80556 ICE when returning an repr(i8) enum from an extern c… · t-compiler/wg-prioritization/alerts · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/index.html">t-compiler/wg-prioritization/alerts</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html">#80556 ICE when returning an repr(i8) enum from an extern c…</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="221290804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221290804" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221290804">(Dec 31 2020 at 13:41)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="3111">@WG-prioritization/alerts</span> issue <a href="https://github.com/rust-lang/rust/issues/80556">#80556</a> has been requested for prioritization.</p>
<h1><a href="https://forge.rust-lang.org/compiler/prioritization/procedure.html#assign-priority-to-unprioritized-issues-with-i-prioritize-label">Procedure</a></h1>
<ul>
<li>Priority?</li>
<li>Regression?</li>
<li>Notify people/groups?</li>
<li>Needs <code>I-nominated</code>?</li>
</ul>



<a name="221290870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221290870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221290870">(Dec 31 2020 at 13:42)</a>:</h4>
<p>hmm, <code>P-medium</code> or <code>P-high</code> imo.</p>



<a name="221291349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291349" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291349">(Dec 31 2020 at 13:53)</a>:</h4>
<p>IIUC the sample provided is trying to cast to an <code>i8</code> a custom <code>Type</code> that should fit the representation, right?</p>



<a name="221291415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291415" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291415">(Dec 31 2020 at 13:54)</a>:</h4>
<p>I mean, is the code there legal or should return an error?</p>



<a name="221291444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291444" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291444">(Dec 31 2020 at 13:55)</a>:</h4>
<p>also I don't understand if the LLVM error suggests an issue at the llvm level</p>



<a name="221291504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291504" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291504">(Dec 31 2020 at 13:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="250987">apiraino</span> <a href="#narrow/stream/245100-t-compiler.2Fwg-prioritization.2Falerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6/near/221291349">said</a>:</p>
<blockquote>
<p>IIUC the sample provided is trying to cast to an <code>i8</code> a custom <code>Type</code> that should fit the representation, right?</p>
</blockquote>
<p>does it? the example tries to use an ffi safe enum in an extern function afaict</p>



<a name="221291517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291517" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291517">(Dec 31 2020 at 13:56)</a>:</h4>
<p>the issue looks to me like we shouldn't use <code>zeroext</code> for <code>repr(iN)</code> enums</p>



<a name="221291522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291522" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291522">(Dec 31 2020 at 13:56)</a>:</h4>
<p>though i am not too familiar with llvm myself</p>



<a name="221291539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291539" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291539">(Dec 31 2020 at 13:57)</a>:</h4>
<p>so the issue is during codegen and probably a bug on our side</p>



<a name="221291716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221291716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221291716">(Dec 31 2020 at 14:00)</a>:</h4>
<p>make sense, thanks for clarifying (am trying to understand the context)</p>



<a name="221329264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221329264" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221329264">(Jan 01 2021 at 01:34)</a>:</h4>
<p>Seems like maybe P-medium because it's been around since 1.24 (according to <span class="user-mention silent" data-user-id="217864">matthiaskrgr</span>).</p>



<a name="221329267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221329267" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221329267">(Jan 01 2021 at 01:34)</a>:</h4>
<p>So is this code supposed to compile? It seems like yes.</p>



<a name="221329464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221329464" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stu <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221329464">(Jan 01 2021 at 01:40)</a>:</h4>
<p>Yea I agree with medium. Rust Enums are usually not used in a FFI API</p>



<a name="221366983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221366983" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221366983">(Jan 01 2021 at 20:16)</a>:</h4>
<p>The enum is <code>repr(i8)</code>, which (I think?) means it's FFI-safe.</p>



<a name="221367062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221367062" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stu <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221367062">(Jan 01 2021 at 20:18)</a>:</h4>
<p>I'm not sure, but even if it is, it's not often used in FFI (I guess), because it can produce invalid values if the FFI function returns an out of bounds number. So a "constified enum" or "newtyped enum", like bindgen can generate, are more often used.</p>
<blockquote>
<p>Use this with caution, creating this in unsafe code (including FFI) with an invalid value will invoke undefined behaviour. You may want to use the newtype enum style instead.</p>
</blockquote>
<p>Bindgen also warns about it</p>



<a name="221367327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221367327" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221367327">(Jan 01 2021 at 20:26)</a>:</h4>
<p><code>repr(i8)</code> is ffi safe</p>



<a name="221501154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221501154" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221501154">(Jan 04 2021 at 08:56)</a>:</h4>
<p>I would have considered this a <code>P-high</code> but it's been a regression since 1.24... Shall we do <code>P-medium</code>?</p>



<a name="221513586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221513586" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stu <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221513586">(Jan 04 2021 at 11:33)</a>:</h4>
<p>Yea I think <code>P-medium</code> is fine</p>



<a name="221513821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2380556%20ICE%20when%20returning%20an%20repr%28i8%29%20enum%20from%20an%20extern%20c%E2%80%A6/near/221513821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://rust-lang.github.io/zulip_archive/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2380556.20ICE.20when.20returning.20an.20repr(i8).20enum.20from.20an.20extern.20c.E2.80.A6.html#221513821">(Jan 04 2021 at 11:36)</a>:</h4>
<p>Issue <a href="https://github.com/rust-lang/rust/issues/80556">#80556</a>'s prioritization request has been removed.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>