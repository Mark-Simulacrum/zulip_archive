<html>
<head><meta charset="utf-8"><title>#81700 [ICE] With closure on mutable ref · t-compiler/wg-prioritization/alerts · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/index.html">t-compiler/wg-prioritization/alerts</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html">#81700 [ICE] With closure on mutable ref</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="224996691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/224996691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#224996691">(Feb 03 2021 at 10:24)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="3111">@WG-prioritization/alerts</span> issue <a href="https://github.com/rust-lang/rust/issues/81700">#81700</a> has been requested for prioritization.</p>
<h1><a href="https://forge.rust-lang.org/compiler/prioritization/procedure.html#assign-priority-to-unprioritized-issues-with-i-prioritize-label">Procedure</a></h1>
<ul>
<li>Priority?</li>
<li>Regression?</li>
<li>Notify people/groups?</li>
<li>Needs <code>I-nominated</code>?</li>
</ul>



<a name="225040638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225040638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225040638">(Feb 03 2021 at 16:29)</a>:</h4>
<p>beta returns an actionable error, in nightly we have an ICE. So I would say <code>P-medium</code></p>



<a name="225040710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225040710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225040710">(Feb 03 2021 at 16:30)</a>:</h4>
<p>regression-from-beta-to-nightly?</p>



<a name="225040812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225040812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225040812">(Feb 03 2021 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="250987">@apiraino</span> this actually seems P-high</p>



<a name="225041158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225041158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225041158">(Feb 03 2021 at 16:32)</a>:</h4>
<p>Yeah, this seems like a major regression that we wouldn't want on beta (or stable).</p>



<a name="225041314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225041314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225041314">(Feb 03 2021 at 16:33)</a>:</h4>
<p>Issue <a href="https://github.com/rust-lang/rust/issues/81700">#81700</a>'s prioritization request has been removed.</p>



<a name="225041483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225041483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225041483">(Feb 03 2021 at 16:34)</a>:</h4>
<p>(Marked as P-high)</p>



<a name="225041818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225041818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225041818">(Feb 03 2021 at 16:36)</a>:</h4>
<p>I agree but I don't understand the implication. You mean the regression on the error shown is too much or that is there something more behind? I'm afraid I'm missing the context here</p>



<a name="225042468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225042468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225042468">(Feb 03 2021 at 16:41)</a>:</h4>
<p>one sec, I'll explain</p>



<a name="225042629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225042629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225042629">(Feb 03 2021 at 16:42)</a>:</h4>
<p>On stable (and beta), the MCVE gives:</p>
<div class="codehilite"><pre><span></span><code>error[E0596]: cannot borrow `bar` as mutable, as it is not declared as mutable
 --&gt; src/main.rs:3:5
  |
2 |     let bar = || { foo(x); };
  |         --- help: consider changing this to be mutable: `mut bar`
3 |     bar();
  |     ^^^ cannot borrow as mutable

error: aborting due to previous error
</code></pre></div>
<p>On nightly, it gives:</p>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: compiler/rustc_mir/src/borrow_check/diagnostics/mutability_errors.rs:525:22: upvar `x` borrowed, but not mutably

thread &#39;rustc&#39; panicked at &#39;Box&lt;Any&gt;&#39;, compiler/rustc_errors/src/lib.rs:958:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.51.0-nightly (368275062 2021-02-02) running on x86_64-unknown-linux-gnu

note: compiler flags: -C embed-bitcode=no -C codegen-units=1 -C debuginfo=2 --crate-type bin

note: some of the compiler flags provided by cargo are hidden

query stack during panic:
#0 [mir_borrowck] borrow-checking `foo`
#1 [analysis] running analysis passes on this crate
end of query stack
error: aborting due to previous error

error: could not compile `playground`
</code></pre></div>
<p>No user-friendly error whatsoever!</p>



<a name="225042670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225042670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225042670">(Feb 03 2021 at 16:42)</a>:</h4>
<p>This error seems <em>really</em> easy to trigger, and is completely inscrutable.</p>



<a name="225042768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225042768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225042768">(Feb 03 2021 at 16:43)</a>:</h4>
<p>I might even say P-critical, except that that's usually reserved for miscompiles and unwarranted errors.</p>



<a name="225051771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2381700%20%5BICE%5D%20With%20closure%20on%20mutable%20ref/near/225051771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2381700.20.5BICE.5D.20With.20closure.20on.20mutable.20ref.html#225051771">(Feb 03 2021 at 17:41)</a>:</h4>
<p>oh ok, thanks for explaining <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>