<html>
<head><meta charset="utf-8"><title>#94510 regression: hard error on ? in type · t-compiler/wg-prioritization/alerts · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/index.html">t-compiler/wg-prioritization/alerts</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2394510.20regression.3A.20hard.20error.20on.20.3F.20in.20type.html">#94510 regression: hard error on ? in type</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273726263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2394510%20regression%3A%20hard%20error%20on%20%3F%20in%20type/near/273726263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2394510.20regression.3A.20hard.20error.20on.20.3F.20in.20type.html#273726263">(Mar 01 2022 at 23:13)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="3111">@WG-prioritization/alerts</span> issue <a href="https://github.com/rust-lang/rust/issues/94510">#94510</a> has been requested for prioritization.</p>
<h1><a href="https://forge.rust-lang.org/compiler/prioritization/procedure.html#assign-priority-to-unprioritized-issues-with-i-prioritize-label">Procedure</a></h1>
<ul>
<li>Priority?</li>
<li>Regression?</li>
<li>Notify people/groups?</li>
<li>Needs <code>I-nominated</code>?</li>
</ul>



<a name="273951731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2394510%20regression%3A%20hard%20error%20on%20%3F%20in%20type/near/273951731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2394510.20regression.3A.20hard.20error.20on.20.3F.20in.20type.html#273951731">(Mar 03 2022 at 10:23)</a>:</h4>
<p>The regression happens on one crate, last updated in 2018, which - if I'm reading it correctly - is trying to achieve the same thing that the PR <a href="https://github.com/rust-lang/rust/issues/92746">#92746</a> is trying to achieve (i.e. the <code>?</code> operator to handle <code>Option&lt;T&gt;</code> in a more succint way).</p>
<p>I'm not sure about this, but I think this is not a big regression, there <code>p-medium</code> (or even p-low?)</p>



<a name="273969056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2394510%20regression%3A%20hard%20error%20on%20%3F%20in%20type/near/273969056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2394510.20regression.3A.20hard.20error.20on.20.3F.20in.20type.html#273969056">(Mar 03 2022 at 13:05)</a>:</h4>
<p><span class="user-mention" data-user-id="250987">@apiraino</span> not exactly that; the issue is from a quite infamous future-compatibility-wise footgun in macros:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$T</span>:<span class="nc">ty</span><span class="w"> </span><span class="err">…</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$e</span>:<span class="nc">expr</span><span class="w"> </span><span class="err">…</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>* In this instance: <a href="https://docs.rs/fn_block/0.2.1/src/fn_block/lib.rs.html#199-206">https://docs.rs/fn_block/0.2.1/src/fn_block/lib.rs.html#199-206</a></p>
<p>This relies on failure to parse certain tokens as a type prefix to happen early enough for that error to "backtrack" into the macro-arm picking phase; this used to be the case with <code>o?.method…</code> kind of expressions. <a href="https://github.com/rust-lang/rust/issues/92746">#92746</a> changed stuff so that <code>o?</code> was interpreted as an incorrect <code>Ty</code> candidate, leading to a hard error before the macro-arm picking phase could "backtrack".</p>
<hr>
<p>The <code>:ty</code> / <code>:expr</code> branch is a quite common "sad pattern" that comes to mind when writing macros, I personally encountered it when wanting to unify <code>const_assert_impls!</code> with a classic <code>assert!</code> predicate:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="cp">$T</span>:<span class="nc">ty</span><span class="w"> </span>: <span class="cp">$Trait</span>:<span class="nc">path</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="cm">/* const-assert the impl */</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="cp">$predicate</span>:<span class="nc">block</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$msg</span>:<span class="nc">expr</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="cm">/* compile-time assertion of a predicate */</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="cp">$predicate</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="w"> </span><span class="cp">$msg</span>:<span class="nc">expr</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="cm">/* runtime check of a predicate */</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<hr>
<p>With all that said, I'd lean towards saying it deserves to be above <code>p-low</code>, but it should be taken with a grain of salt since I'm not knowledgeable enough of the priority tiers <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="273999772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2394510%20regression%3A%20hard%20error%20on%20%3F%20in%20type/near/273999772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2394510.20regression.3A.20hard.20error.20on.20.3F.20in.20type.html#273999772">(Mar 03 2022 at 16:37)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> wow great comment, more than I could expect :) </p>
<p>As the PR author <a href="https://github.com/rust-lang/rust/issues/94510#issuecomment-1056195334">suggests</a>, it could be wise to revert the change for the moment and then work out a different patch. I'll assign <code>P-medium</code> as I sense this should not reach stable, but maybe does  not warrant  a P-high red flag</p>



<a name="274001031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/245100-t-compiler/wg-prioritization/alerts/topic/%2394510%20regression%3A%20hard%20error%20on%20%3F%20in%20type/near/274001031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/245100-t-compiler/wg-prioritization/alerts/topic/.2394510.20regression.3A.20hard.20error.20on.20.3F.20in.20type.html#274001031">(Mar 03 2022 at 16:45)</a>:</h4>
<p>Issue <a href="https://github.com/rust-lang/rust/issues/94510">#94510</a>'s prioritization request has been removed.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>