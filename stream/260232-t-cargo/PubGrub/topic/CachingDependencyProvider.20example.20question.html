<html>
<head><meta charset="utf-8"><title>CachingDependencyProvider example question · t-cargo/PubGrub · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/index.html">t-cargo/PubGrub</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html">CachingDependencyProvider example question</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255900290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255900290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis Pilfold <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255900290">(Oct 02 2021 at 21:39)</a>:</h4>
<p>Hello all! I've been trying to understand the CachingDependencyProvider and was confused by the way that the <code>choose_package_version</code> method always uses the remote rather than the cache.</p>
<p><a href="https://github.com/pubgrub-rs/pubgrub/blob/717289be5722dd5caaa0d1f4ed13047d11a7f7fd/examples/caching_dependency_provider.rs#L34">https://github.com/pubgrub-rs/pubgrub/blob/717289be5722dd5caaa0d1f4ed13047d11a7f7fd/examples/caching_dependency_provider.rs#L34</a></p>
<p>Forgive me if I'm misunderstanding, but I was under the assumption that this function would be called multiple times per package, so it would be desirable to have caching there too. Is that not the case?</p>
<p>Thanks,<br>
Louis</p>



<a name="255900599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255900599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255900599">(Oct 02 2021 at 21:44)</a>:</h4>
<p>If anything it is more important to have cashing on that function. (and there is some work to reduce the number of times it is called in 0.3) The example does not have that part implemented because it is hard to do generically.</p>



<a name="255901578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255901578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255901578">(Oct 02 2021 at 22:01)</a>:</h4>
<p>In the general case the output may depend on the set of package names or the order of iteration. So in general you need collect the <code>packages</code> iter into a <code>Vec</code> and use that as the cache key, witch means you will have almost no hits.</p>



<a name="255901774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255901774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255901774">(Oct 02 2021 at 22:04)</a>:</h4>
<p>If your impl looks like <code>packages.arg_max(priorty_for_a_package)</code> then it is likely to be efficient to put a cache around the call to <code>priorty_for_a_package</code>.</p>



<a name="255902365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255902365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis Pilfold <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255902365">(Oct 02 2021 at 22:15)</a>:</h4>
<p>Ah fab! That's very helpful, I was worried I was misunderstanding it all. Thank you</p>



<a name="255903456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255903456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255903456">(Oct 02 2021 at 22:34)</a>:</h4>
<p>here are some valid (but nonsensical) <code>choose_package_version</code> that will make a caching example hard:</p>
<p>(I am not going to get all the details correct)</p>
<div class="codehilite"><pre><span></span><code>let v: Vec&lt;_&gt; = packages.collect();
let mut hasher = FxHasher::new();
v.iter().forEatch(|(p, r)| hasher.hash((p.borrow(), v.borrow()));
let hash = hasher.finish();
let (p, r) = v[hash % v.len()];
</code></pre></div>
<p>or</p>



<a name="255903744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255903744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255903744">(Oct 02 2021 at 22:40)</a>:</h4>
<div class="codehilite"><pre><span></span><code>let v: Vec&lt;_&gt; = packages.collect();
let has_a = v..iter().find(|(p, _)| p == package_named_a));
let has_b = v..iter().find(|(p, _)| p == package_named_b));
let has_c = v..iter().find(|(p, _)| p == package_named_c));

if has_a.is_sum() &amp;&amp;  has_b.is_sum() {
   return has_b;
} else if has_b.is_sum() &amp;&amp;  has_c.is_sum() {
   return has_c;
} else if has_a.is_sum() &amp;&amp;  has_c.is_sum() {
   return has_a;
} else {
   return v.last();
}
</code></pre></div>



<a name="255904214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255904214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis Pilfold <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255904214">(Oct 02 2021 at 22:48)</a>:</h4>
<p>I don't really understand the implications of your examples there to be honest. I was thinking I would just cache the HTTP requests so that I make only 1 request to the repository API per package, and share the cache between the two methods.</p>



<a name="255904556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255904556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255904556">(Oct 02 2021 at 22:55)</a>:</h4>
<p>That you should definitely do!</p>



<a name="255904675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255904675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255904675">(Oct 02 2021 at 22:57)</a>:</h4>
<p>The examples were mostly for me, to document why this is hard to do in the general case. In your concrete case, caching a HTTP level definitely makes sense.</p>



<a name="255905216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255905216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Louis Pilfold <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255905216">(Oct 02 2021 at 23:07)</a>:</h4>
<p>Fab, thanks again!</p>



<a name="255906232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider%20example%20question/near/255906232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/260232-t-cargo/PubGrub/topic/CachingDependencyProvider.20example.20question.html#255906232">(Oct 02 2021 at 23:27)</a>:</h4>
<p>Therned the examples into a comment on the PR I linked (<a href="https://github.com/pubgrub-rs/pubgrub/pull/104#issuecomment-932833104">https://github.com/pubgrub-rs/pubgrub/pull/104#issuecomment-932833104</a>). So thank you!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>