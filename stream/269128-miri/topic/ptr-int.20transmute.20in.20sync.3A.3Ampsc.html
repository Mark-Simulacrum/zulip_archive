<html>
<head><meta charset="utf-8"><title>ptr-int transmute in sync::mpsc · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html">ptr-int transmute in sync::mpsc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276739538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739538">(Mar 26 2022 at 18:38)</a>:</h4>
<p>Turns out sync::mpsc has a ptr-int transmute somewhere that Miri failed to detect since I screwed up the check for that (fixed in <a href="https://github.com/rust-lang/rust/pull/95340">https://github.com/rust-lang/rust/pull/95340</a>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">Undefined</span><span class="w"> </span><span class="n">Behavior</span>: <span class="nc">type</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">encountered</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mh">0x2afc8</span><span class="p">[</span><span class="n">alloc1995</span><span class="p">]</span><span class="o">&lt;</span><span class="n">untagged</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="n">plain</span><span class="w"> </span><span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">pointer</span><span class="p">)</span><span class="w"> </span><span class="n">bytes</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="o">/</span><span class="n">mpsc</span><span class="o">/</span><span class="n">blocking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">54</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">54</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="k">type</span> <span class="nc">validation</span><span class="w"> </span><span class="n">failed</span>: <span class="nc">encountered</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mh">0x2afc8</span><span class="p">[</span><span class="n">alloc1995</span><span class="p">]</span><span class="o">&lt;</span><span class="n">untagged</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="n">plain</span><span class="w"> </span><span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">pointer</span><span class="p">)</span><span class="w"> </span><span class="n">bytes</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">this</span><span class="w"> </span><span class="n">indicates</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">program</span>: <span class="nc">it</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">operation</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">caused</span><span class="w"> </span><span class="n">Undefined</span><span class="w"> </span><span class="n">Behavior</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">see</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information</span>

<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">mpsc</span>::<span class="n">blocking</span>::<span class="n">SignalToken</span>::<span class="n">cast_to_usize</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="o">/</span><span class="n">mpsc</span><span class="o">/</span><span class="n">blocking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">54</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">mpsc</span>::<span class="n">oneshot</span>::<span class="n">Packet</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span>::<span class="n">recv</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="o">/</span><span class="n">mpsc</span><span class="o">/</span><span class="n">oneshot</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">129</span>:<span class="mi">32</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">mpsc</span>::<span class="n">Receiver</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span>::<span class="n">recv</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sync</span><span class="o">/</span><span class="n">mpsc</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1161</span>:<span class="mi">49</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">simple_send</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">pass</span><span class="o">/</span><span class="n">concurrency</span><span class="o">/</span><span class="n">channels</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">15</span>:<span class="mi">16</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">tests</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">pass</span><span class="o">/</span><span class="n">concurrency</span><span class="o">/</span><span class="n">channels</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">15</span>:<span class="mi">16</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">rx</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">^^^^^^^^^</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">main</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">tests</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">pass</span><span class="o">/</span><span class="n">concurrency</span><span class="o">/</span><span class="n">channels</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">54</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">tests</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">pass</span><span class="o">/</span><span class="n">concurrency</span><span class="o">/</span><span class="n">channels</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">54</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">54</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">simple_send</span><span class="p">();</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^</span><span class="w"></span>
</code></pre></div>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> FWIW this also means such transmutes would be missed during your Miri runs so far</p>



<a name="276739553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739553">(Mar 26 2022 at 18:39)</a>:</h4>
<p>Very interesting</p>



<a name="276739575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739575">(Mar 26 2022 at 18:39)</a>:</h4>
<p>the comments are very honest about what they are doing though ;)<br>
<a href="https://github.com/rust-lang/rust/blob/828d4ace4dee856b376fa44cc095d490ee799c30/library/std/src/sync/mpsc/blocking.rs#L54">https://github.com/rust-lang/rust/blob/828d4ace4dee856b376fa44cc095d490ee799c30/library/std/src/sync/mpsc/blocking.rs#L54</a></p>



<a name="276739643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739643">(Mar 26 2022 at 18:40)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> ah you are going to love this, this 'casts' an <code>Arc</code> to <code>usize</code> via <code>transmute</code> <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="276739667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739667">(Mar 26 2022 at 18:41)</a>:</h4>
<p><em>WHY</em></p>



<a name="276739712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739712">(Mar 26 2022 at 18:42)</a>:</h4>
<p>There's a PR to replace this module with crossbeam, so I'm much more interested in what transmutes I will find elsewhere</p>



<a name="276739713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739713">(Mar 26 2022 at 18:42)</a>:</h4>
<p>they just don't want the into_raw weird offset semantic??</p>



<a name="276739903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739903">(Mar 26 2022 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137587">Gankra</span> <a href="#narrow/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc/near/276739713">said</a>:</p>
<blockquote>
<p>they just don't want the into_raw weird offset semantic??</p>
</blockquote>
<p>this is OLD code. maybe into_raw didnt exist yet...</p>



<a name="276739912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/276739912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#276739912">(Mar 26 2022 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc/near/276739712">said</a>:</p>
<blockquote>
<p>There's a PR to replace this module with crossbeam, so I'm much more interested in what transmutes I will find elsewhere</p>
</blockquote>
<p>ah fair. we'll have to wait until my PR lands for that I guess.</p>



<a name="277656946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/277656946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#277656946">(Apr 03 2022 at 19:34)</a>:</h4>
<p>Ah, here's where I heard about this problem before.</p>
<p>This is breaking a lot of crates test suites. I think a lot of concurrency crates use <code>std::sync::mpsc</code> to test themselves.</p>
<p>I want to fix this but so far my attempts are going poorly. All I've managed to do is deadlock the stage1 compiler.</p>



<a name="277657954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/277657954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#277657954">(Apr 03 2022 at 19:57)</a>:</h4>
<p>Never mind, I'm a dumdum</p>



<a name="277658052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/277658052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#277658052">(Apr 03 2022 at 19:59)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95621">https://github.com/rust-lang/rust/pull/95621</a></p>



<a name="277658952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/277658952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#277658952">(Apr 03 2022 at 20:19)</a>:</h4>
<p>oh nice :)</p>



<a name="278384677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/278384677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#278384677">(Apr 09 2022 at 03:21)</a>:</h4>
<p>Oh great this is now starting to block other projects</p>



<a name="278384679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/ptr-int%20transmute%20in%20sync%3A%3Ampsc/near/278384679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc.html#278384679">(Apr 09 2022 at 03:21)</a>:</h4>
<p><code>crossbeam</code>'s CI is broken now:<br>
<a href="https://github.com/crossbeam-rs/crossbeam/pull/811#issuecomment-1092879060">https://github.com/crossbeam-rs/crossbeam/pull/811#issuecomment-1092879060</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>