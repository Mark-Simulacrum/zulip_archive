<html>
<head><meta charset="utf-8"><title>prctl · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html">prctl</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278072052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278072052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278072052">(Apr 06 2022 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> FWIW, regarding false positives in <code>prctl</code>, I would accept a PR against Miri that treats <code>prctl</code> like we <a href="https://github.com/rust-lang/miri/blob/fb01df538e30cf63bdcbadad61828940ca8ec578/src/shims/posix/linux/foreign_items.rs#L135">treat <code>syscall</code></a>. probably best to add a <code>check_shim_variadic</code> that does that and gets used (almost) everywhere that we currently use <code>check_abi_and_shim_symbol_clash</code> directly. also that would be a good place to properly treat the first N arguments that are <em>not</em> variadic...</p>
<p>I don't think the <code>check</code> functions even know if the call was variadic or not so I'd punt on checking that for now. (basically, assuming that variadic and non-variadic calls with the same signature are equivalent if all arguments are <code>abi::Scalar</code>.)</p>



<a name="278086968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278086968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278086968">(Apr 06 2022 at 21:13)</a>:</h4>
<p>FWIW I am somewhat surprised that you are saying <code>open</code> lead to a reputation of Miri having many false positives... that was just an unsupported (or partially supported) FFI, right? I dont think we ever got a bug report for that, just a PR fixing it one day. We also never got a bug report about a <code>prctl</code> false positive.</p>



<a name="278087785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278087785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278087785">(Apr 06 2022 at 21:21)</a>:</h4>
<p>I did not mean that <code>open</code> on its own led to this, just that it added to the poor reputation</p>



<a name="278087850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278087850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278087850">(Apr 06 2022 at 21:22)</a>:</h4>
<p>There is a lot more ambient grumbling in the community about Miri than there are bug reports</p>



<a name="278088693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278088693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278088693">(Apr 06 2022 at 21:28)</a>:</h4>
<p>Also, you "just got a PR fixing it one day" because I managed to nerdsnipe someone into making that PR ;)</p>



<a name="278088707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278088707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278088707">(Apr 06 2022 at 21:28)</a>:</h4>
<p>I find it concerning that I know absolutely nothing about that grumbling. I guess I am looking in the wrong spots.</p>



<a name="278088819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278088819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278088819">(Apr 06 2022 at 21:29)</a>:</h4>
<p>specifically for false positives I really would have hoped people report bugs...</p>



<a name="278089165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278089165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278089165">(Apr 06 2022 at 21:32)</a>:</h4>
<p>I think the experimental nature of Miri is a significant obstacle to getting good feedback flowing directly to the project. It seems like way too often when people encounter a problem, be it with Miri's platform support itself or with the fact that they don't understand an error or they don't understand how to make their code conform to Stacked Borrows, they just throw up their hands and hope that a future revision will accommodate their use or that Miri will just go away.</p>



<a name="278089254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278089254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278089254">(Apr 06 2022 at 21:33)</a>:</h4>
<p>With platform/FFI support especially, it seems like people have an impression that the situation is harder to improve than it is. It's not all that hard to write a new shim or to improve a shim. Maybe the error should invite people to do this?</p>



<a name="278089391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278089391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278089391">(Apr 06 2022 at 21:35)</a>:</h4>
<p>it depends heavily on the shim</p>



<a name="278089400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278089400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278089400">(Apr 06 2022 at 21:35)</a>:</h4>
<p>some shims are a lot of work</p>



<a name="278089430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278089430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278089430">(Apr 06 2022 at 21:35)</a>:</h4>
<p>like, I wouldnt even know how to implement the stuff required to make tokio start...</p>



<a name="278090215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278090215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278090215">(Apr 06 2022 at 21:42)</a>:</h4>
<p>Oh dear, I've been thinking of looking into <code>epoll_create1</code></p>



<a name="278094477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278094477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278094477">(Apr 06 2022 at 22:25)</a>:</h4>
<p>I mean I'd be very happy if someone could pull it off :)</p>



<a name="278118741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278118741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278118741">(Apr 07 2022 at 05:21)</a>:</h4>
<p>It's on my todo list for this year</p>



<a name="278128629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278128629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278128629">(Apr 07 2022 at 07:55)</a>:</h4>
<p>That would be really cool. Currently we have to disable the IO driver in all of Tokio's miri tests, but it would be cool to test other stuff with miri too.</p>



<a name="278133731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278133731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278133731">(Apr 07 2022 at 08:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/269128-miri/topic/prctl/near/278088707">said</a>:</p>
<blockquote>
<p>I find it concerning that I know absolutely nothing about that grumbling. I guess I am looking in the wrong spots.<br>
specifically for false positives I really would have hoped people report bugs...</p>
</blockquote>
<p>I ran into this one when I tried to use Miri for something that uses <code>mmap</code>. I never voiced my concerns anywhere, but at the time I had a thought that "I'll revisit this later when more syscalls are added" <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> I don't see an open issue at the moment, but saw this issue that is now closed: <a href="https://github.com/rust-lang/miri/issues/1181">https://github.com/rust-lang/miri/issues/1181</a> I'm planning to revisit my <code>mmap</code> use case in the next few months. I would be happy to create a Github issue, unless it is already supported today? :)</p>



<a name="278197928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278197928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278197928">(Apr 07 2022 at 17:21)</a>:</h4>
<p>it's not supported, no. :) yeah feel free to file wishlist bugs for supporting more shims, might be good for others that are looking for good things to work one :D</p>



<a name="278197965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278197965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278197965">(Apr 07 2022 at 17:21)</a>:</h4>
<p>I hope the error you get when calling <code>mmap</code> is clear enough that this is not a "false positive" but a lack of support?</p>



<a name="278213791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278213791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278213791">(Apr 07 2022 at 19:21)</a>:</h4>
<p>Here's a wishlist <a href="https://github.com/rust-lang/miri/issues/2057">https://github.com/rust-lang/miri/issues/2057</a></p>



<a name="278222141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278222141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278222141">(Apr 07 2022 at 20:30)</a>:</h4>
<p>in exchange, I made prctl more permissive ;)<br>
<a href="https://github.com/rust-lang/miri/pull/2058">https://github.com/rust-lang/miri/pull/2058</a></p>



<a name="278271868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278271868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278271868">(Apr 08 2022 at 08:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/269128-miri/topic/prctl/near/278197965">said</a>:</p>
<blockquote>
<p>I hope the error you get when calling <code>mmap</code> is clear enough that this is not a "false positive" but a lack of support?</p>
</blockquote>
<p>I will give it another try in the next few days and follow up with current status and a new Github issue :)</p>



<a name="278299653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278299653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278299653">(Apr 08 2022 at 12:56)</a>:</h4>
<p>okay. :D<br>
FWIW <code>mmap</code> sounds like one of those that is very tricky to implement since it is an extremely low-level form of cross-process communication. But maybe there are modes of use of <code>mmap</code> that are not that bad?</p>



<a name="278300435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278300435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278300435">(Apr 08 2022 at 13:02)</a>:</h4>
<p>Sometimes its not used to communicate with other processes, but just to read/write to a file.</p>



<a name="278302086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278302086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278302086">(Apr 08 2022 at 13:16)</a>:</h4>
<p>There also exist some flags that make the memory "private" (either through a private copy-on-write mapping, by reserving it for the instantiating program only, optionally even shielded from passing it down to forked child processes).</p>



<a name="278302247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278302247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278302247">(Apr 08 2022 at 13:17)</a>:</h4>
<p>although my use case also includes data structures shared inter-process :D</p>



<a name="278302453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/prctl/near/278302453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/prctl.html#278302453">(Apr 08 2022 at 13:18)</a>:</h4>
<p>(maybe that use case can still be tested through Miri if it maps the same memory twice within the same program and accesses those from different threads)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>