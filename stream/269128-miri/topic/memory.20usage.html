<html>
<head><meta charset="utf-8"><title>memory usage · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html">memory usage</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276493720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276493720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276493720">(Mar 24 2022 at 15:38)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> </p>
<p>we've been talking about miri's memory usage and how sometimes stacked borrows just creates more and more data that will never be relevant</p>



<a name="276494654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276494654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276494654">(Mar 24 2022 at 15:43)</a>:</h4>
<p>Yes, hi. The best demonstration of this is running <code>MIRIFLAGS=-Zmiri-tag-raw-pointers cargo miri test</code> on <code>regex</code>. There are actually multiple stages of memory growth in the test suite, but eventually it exceeds 125 GB. As far as a I can tell, this is primarily due to a single allocation.</p>
<p>I have had theories from time to time about what exactly is causing it, but what strikes me is that the memory growth is pretty fast and I haven't been able to cook up an example that reproduces it.</p>



<a name="276497469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276497469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276497469">(Mar 24 2022 at 16:00)</a>:</h4>
<p>I think we have talked about this on and off from time to time, but I think the only way out of this is to do some kind of garbage collection of <code>Item</code>s or <code>SbTag</code>. And doing that effectively requires _somehow_ communicating to the stacked borrows implementation about ptr-int casts (because we can't remove the associated tag), as well as information about what pointers/references exist in the program at all.</p>
<p>Doing this by reference counting <code>Item</code> or <code>SbTag</code> is tricky because the obvious implementation makes <code>Pointer</code> and <code>Place</code> not <code>Copy</code>, which is a total mess for all of CTFE. Doing it with a tracing GC would fix that issue, but I do not have the skill to even start implementing a tracing GC so I don't know if there are other worse problems down that road.</p>



<a name="276498029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276498029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276498029">(Mar 24 2022 at 16:04)</a>:</h4>
<p>For what it's worth, I tried changing the implementation of a <code>Stack</code> and <code>RangeMap</code> to reference count the common chunk of a range in a <code>RangeMap</code> when it gets split. My implementation is in this poorly-named branch: <a href="https://github.com/saethlin/miri/tree/optimize-sb-2">https://github.com/saethlin/miri/tree/optimize-sb-2</a>. As far as I can tell, it has no/negligible impact on the total memory usage. I suspect this is because the common stack segments that benefit from the reference counting are very small.</p>



<a name="276498738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276498738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276498738">(Mar 24 2022 at 16:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/269128-miri/topic/memory.20usage/near/276497469">said</a>:</p>
<blockquote>
<p>Doing it with a tracing GC would fix that issue, but I do not have the skill to even start implementing a tracing GC so I don't know if there are other worse problems down that road.</p>
</blockquote>
<p>(knowing nothing about SB, I'll just leave this here <a href="https://github.com/mmtk/mmtk-core">https://github.com/mmtk/mmtk-core</a> in case you end up wanting to start implementing a tracing GC :)</p>



<a name="276626781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276626781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276626781">(Mar 25 2022 at 14:30)</a>:</h4>
<blockquote>
<p>And doing that effectively requires _somehow_ communicating to the stacked borrows implementation about ptr-int casts (because we can't remove the associated tag)</p>
</blockquote>
<p>you have been running with raw ptr tagging anyway so I am surprised by this statement. ints cannot be cats back to usable pointers then anyway.<br>
without raw ptr tagging, those tags are easy to recognize: they are <code>Untagged</code>.</p>



<a name="276627607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276627607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276627607">(Mar 25 2022 at 14:36)</a>:</h4>
<p>I'm trying to be accommodating of both variants, though I appreciate that you see my bias <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span> </p>
<p>I thought there was a problem in SB without raw pointer tagging. But I guess thinking over it again, the base tag without raw pointer tagging is Untagged, right? So there's no issue about being overzealous with the GC?</p>



<a name="276627743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276627743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276627743">(Mar 25 2022 at 14:37)</a>:</h4>
<p>you mean 'base tag' for an allocation? depends on the allocation</p>



<a name="276627939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276627939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276627939">(Mar 25 2022 at 14:38)</a>:</h4>
<p>so the key GC challenge is a situation where there are many tags that would still be valid but most of them are unnecessary because no ptr carries them any more?</p>



<a name="276628206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276628206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276628206">(Mar 25 2022 at 14:40)</a>:</h4>
<p>This is what I am assuming, but I have not collected data on it yet</p>



<a name="276629214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276629214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276629214">(Mar 25 2022 at 14:47)</a>:</h4>
<p>The extremely crude thing that I hacked together about a "busy allocation" uses the <code>current_span</code> to emit a NonHaltingDiagnostic when the <code>AllocHistory.creations</code> reaches a certain length. It wouldn't be that hard to revive the work later today. Though what we probably want to know is the sum of the allocated size of the <code>Stacks</code> for the allocation.</p>



<a name="276629422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276629422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276629422">(Mar 25 2022 at 14:49)</a>:</h4>
<p>It also might suffice to log each AllocId and the total capacity of its Stacks when it is deallocated?</p>



<a name="276629657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276629657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276629657">(Mar 25 2022 at 14:50)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> so for that bad case in regex it would be good to get some stats so we have concrete data, even if it is just a single sample</p>



<a name="276629744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276629744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276629744">(Mar 25 2022 at 14:51)</a>:</h4>
<p>like, what actually does that huge borrow stack look like? is it one big stack (maybe for many locations, via <code>RangeMap</code>) or many smaller stacks? which permissions are in there (Unique/SRO/SRW)?</p>



<a name="276629778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276629778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276629778">(Mar 25 2022 at 14:51)</a>:</h4>
<p>my guess is, it might be <em>tons</em> of shared references that are all valid for the exact same memory range</p>



<a name="276629819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276629819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276629819">(Mar 25 2022 at 14:51)</a>:</h4>
<p>and I wonder if they really all need a unique tag, or if we can make many shared refs all use the same tag</p>



<a name="276637538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276637538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276637538">(Mar 25 2022 at 15:41)</a>:</h4>
<p>Ooh, like instead of pushing a new shared ref on the stack, we just grab the top one if the top tag is a shared one?</p>



<a name="276676669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/memory%20usage/near/276676669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/memory.20usage.html#276676669">(Mar 25 2022 at 20:44)</a>:</h4>
<p>well something like that but in a way that is sound and complete ;)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>