<html>
<head><meta charset="utf-8"><title>Cron Job Failure 2022-01-26 · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html">Cron Job Failure 2022-01-26</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269427873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269427873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> miri cronjobs <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269427873">(Jan 26 2022 at 15:20)</a>:</h4>
<p>Dear <span class="user-mention" data-user-id="120791">@RalfJ</span> and <span class="user-mention" data-user-id="124288">@oli</span></p>
<p>It would appear that the Miri cron job build failed. Would you mind investigating this issue?</p>
<p>Thanks in advance!<br>
Sincerely,<br>
The Miri Cronjobs Bot</p>



<a name="269432096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269432096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269432096">(Jan 26 2022 at 15:47)</a>:</h4>
<p>this is like a game of whack-a-mole^^</p>



<a name="269432112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269432112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269432112">(Jan 26 2022 at 15:47)</a>:</h4>
<p>looks to be related to the remove_dir_all fix</p>
<div class="codehilite"><pre><span></span><code>error: unsupported operation: unsupported macOS dlsym: openat
   --&gt; /Users/runner/.rustup/toolchains/master/lib/rustlib/src/rust/library/std/src/sys/unix/weak.rs:150:5
    |
150 |     libc::dlsym(libc::RTLD_DEFAULT, name.as_ptr()) as usize
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ unsupported macOS dlsym: openat
</code></pre></div>



<a name="269432850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269432850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269432850">(Jan 26 2022 at 15:51)</a>:</h4>
<p>Uh, is it expected that the fallback implementation still (seemingly) has the same TOCTOU issue as before?<br>
<a href="https://github.com/rust-lang/rust/blob/2c2c1593acc5479a4b502d51bb5fea239766c235/library/std/src/sys_common/fs.rs#L30">https://github.com/rust-lang/rust/blob/2c2c1593acc5479a4b502d51bb5fea239766c235/library/std/src/sys_common/fs.rs#L30</a></p>



<a name="269433619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269433619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269433619">(Jan 26 2022 at 15:54)</a>:</h4>
<p>this similar code has a reassuring comment at least:<br>
<a href="https://github.com/rust-lang/rust/blob/495c7b31aaef783c583d2a0304002367df0a1474/library/std/src/sys/unix/fs.rs#L1697">https://github.com/rust-lang/rust/blob/495c7b31aaef783c583d2a0304002367df0a1474/library/std/src/sys/unix/fs.rs#L1697</a></p>



<a name="269518743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269518743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269518743">(Jan 27 2022 at 02:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26/near/269432096">said</a>:</p>
<blockquote>
<p>this is like a game of whack-a-mole^^</p>
</blockquote>
<p>and here is the next mole :(<br>
<a href="https://github.com/rust-lang/rust/pull/92778">https://github.com/rust-lang/rust/pull/92778</a></p>



<a name="269519754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269519754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269519754">(Jan 27 2022 at 03:00)</a>:</h4>
<p>Is the fix just adding a readdir impl around here? <a href="https://github.com/rust-lang/miri/blob/master/src/shims/posix/linux/foreign_items.rs#L46-L51">https://github.com/rust-lang/miri/blob/master/src/shims/posix/linux/foreign_items.rs#L46-L51</a></p>



<a name="269520809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269520809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269520809">(Jan 27 2022 at 03:18)</a>:</h4>
<p>I tried running tests locally against /rust head in rust-version and got this error</p>
<div class="codehilite" data-code-language="patch"><pre><span></span><code>+error: unsupported operation: io error Uncategorized cannot be translated into a raw os error
+    --&gt; D:/.rustup/toolchains/miri/lib/rustlib/src/rust/library/std/src/sys/unix/fs.rs:1165:18
+     |
+1165 |     cvt(unsafe { libc::symlink(original.as_ptr(), link.as_ptr()) })?;
+     |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ io error Uncategorized cannot be translated into a raw os error
+     |
+     = help: this is likely not a bug in the program; it indicates that the program performed an operation that the interpreter does not support
+
+     = note: inside `std::sys::unix::fs::symlink` at D:/.rustup/toolchains/miri/lib/rustlib/src/rust/library/std/src/sys/unix/fs.rs:1165:18
+     = note: inside `std::os::unix::fs::symlink::&lt;&amp;std::path::PathBuf, &amp;std::path::PathBuf&gt;` at D:/.rustup/toolchains/miri/lib/rustlib/src/rust/library/std/src/os/unix/fs.rs:900:5
+note: inside `test_symlink` at $DIR/fs.rs:229:5
+    --&gt; $DIR/fs.rs:229:5
+     |
+229  |     std::os::unix::fs::symlink(&amp;path, &amp;symlink_path).unwrap();
+     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
+note: inside `main` at $DIR/fs.rs:24:5
+    --&gt; $DIR/fs.rs:24:5
+     |
+24   |     test_symlink();
+     |     ^^^^^^^^^^^^^^
</code></pre></div>
<p>On <a href="https://github.com/rust-lang/miri/blob/master/src/shims/posix/fs.rs#L818">https://github.com/rust-lang/miri/blob/master/src/shims/posix/fs.rs#L818</a><br>
But I think it's because I am cross-running x86_64-unknown-linux-gnu from windows</p>



<a name="269520915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269520915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269520915">(Jan 27 2022 at 03:20)</a>:</h4>
<p>yeah the fix is adding a readdir impl</p>



<a name="269520952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269520952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269520952">(Jan 27 2022 at 03:21)</a>:</h4>
<p>which could become a bit annoying, in particular managing that memory buffer that it will have to allocate to store the dirent it returns...</p>



<a name="269521014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269521014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269521014">(Jan 27 2022 at 03:22)</a>:</h4>
<p>I was about to say that is a strange error... but we do test cross-running x86_64-unknown-linux-gnu from windows on CI so I wonder why it doesnt work for you</p>



<a name="269521024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269521024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269521024">(Jan 27 2022 at 03:22)</a>:</h4>
<p>possibly the filesystem we run this on supports symlinks but the one you are on does not?</p>



<a name="269521210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269521210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269521210">(Jan 27 2022 at 03:26)</a>:</h4>
<p>Running as admin changed the error to readdir<br>
Creating symlinks on windows requires admin</p>



<a name="269521233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269521233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269521233">(Jan 27 2022 at 03:26)</a>:</h4>
<p>I added a dbg! call to check the error to figure it out</p>
<div class="codehilite"><pre><span></span><code>[src\shims\posix\fs.rs:803] fs::symlink_file(src, dst) = Err(
    Os {
        code: 1314,
        kind: Uncategorized,
        message: &quot;A required privilege is not held by the client.&quot;,
    },
)
</code></pre></div>



<a name="269522128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202022-01-26/near/269522128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26.html#269522128">(Jan 27 2022 at 03:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219940">Nick12</span> <a href="#narrow/stream/269128-miri/topic/Cron.20Job.20Failure.202022-01-26/near/269521210">said</a>:</p>
<blockquote>
<p>Running as admin changed the error to readdir<br>
Creating symlinks on windows requires admin</p>
</blockquote>
<p>ah, joy... and it seems GH CI runs windows jobs as admin then? fun fun.<br>
not sure if there is a good way to disable that test on windows hosts...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>