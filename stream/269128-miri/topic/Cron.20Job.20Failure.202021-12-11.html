<html>
<head><meta charset="utf-8"><title>Cron Job Failure 2021-12-11 · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html">Cron Job Failure 2021-12-11</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264537369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264537369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> miri-test-libstd <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264537369">(Dec 11 2021 at 03:07)</a>:</h4>
<p>Dear <span class="user-mention" data-user-id="120791">@RalfJ</span>,</p>
<p>The standard library test suite is failing under Miri. Would you mind investigating this issue?</p>
<p>Thanks in advance!<br>
Sincerely,<br>
The Miri Cronjobs Bot</p>



<a name="264537928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264537928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264537928">(Dec 11 2021 at 03:20)</a>:</h4>
<p>oh fun, this is a use-after-free</p>
<div class="codehilite"><pre><span></span><code> 0.120626   test string::test_replace_range ... error: Undefined Behavior: pointer to alloc7865928 was dereferenced after this allocation got freed
0.000066      --&gt; /home/runner/work/miri-test-libstd/miri-test-libstd/rust-src-patched/library/core/src/slice/raw.rs:91:14
0.000013       |
0.000007   91  |     unsafe { &amp;*ptr::slice_from_raw_parts(data, len) }
0.000007       |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ pointer to alloc7865928 was dereferenced after this allocation got freed
0.000007       |
0.000006       = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior
</code></pre></div>



<a name="264538304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538304">(Dec 11 2021 at 03:31)</a>:</h4>
<p>I just did <code>git log -Gslice_from_raw_parts</code> and found this recent commit that looks like it might be the source: <a href="https://github.com/rust-lang/rust/commit/2d8a11bdbb2623a4e2983870006cbd00eb210ffb">2d8a11bdbb2623a4e2983870006cbd00eb210ffb</a></p>
<p>EDIT: Never mind, that doesn't actually change <code>slice_from_raw_parts</code> AFAICT</p>
<p>EDIT 2: Actually, the Miri error seems to occur inside a Drop, so this could be it after all!</p>



<a name="264538383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538383">(Dec 11 2021 at 03:32)</a>:</h4>
<p>the test is calling <code>replace_range</code></p>



<a name="264538387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538387">(Dec 11 2021 at 03:32)</a>:</h4>
<p>on a string</p>



<a name="264538388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538388">(Dec 11 2021 at 03:32)</a>:</h4>
<p>But:</p>
<div class="codehilite"><pre><span></span><code>= note: inside `&lt;std::vec::Drain&lt;u8&gt; as std::ops::Drop&gt;::drop` at /home/runner/work/miri-test-libstd/miri-test-libstd/rust-src-patched/library/alloc/src/vec/drain.rs:131:24
</code></pre></div>



<a name="264538399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538399">(Dec 11 2021 at 03:32)</a>:</h4>
<p>not sure if it is a new test though or things called by the test that changed</p>



<a name="264538406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538406">(Dec 11 2021 at 03:33)</a>:</h4>
<p>ah looks like replace_range calls drain</p>



<a name="264538409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538409">(Dec 11 2021 at 03:33)</a>:</h4>
<p>and I think drain changed recently?</p>



<a name="264538412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538412">(Dec 11 2021 at 03:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11/near/264538409">said</a>:</p>
<blockquote>
<p>and I think drain changed recently?</p>
</blockquote>
<p>Yeah, that's the commit I linked to</p>



<a name="264538456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538456">(Dec 11 2021 at 03:34)</a>:</h4>
<p>ah I see</p>



<a name="264538664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538664">(Dec 11 2021 at 03:40)</a>:</h4>
<p>(Currently seeing if I can come up with a smaller repro)</p>



<a name="264538989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264538989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264538989">(Dec 11 2021 at 03:48)</a>:</h4>
<p>Interestingly, this passes Miri (with correct splice range):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but changing the range to <code>1..2</code> causes the use-after-free.</p>



<a name="264539082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264539082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264539082">(Dec 11 2021 at 03:51)</a>:</h4>
<p>Opening a Rust issue: <a href="https://github.com/rust-lang/rust/issues/91772">#91772</a></p>



<a name="264563398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Cron%20Job%20Failure%202021-12-11/near/264563398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Cron.20Job.20Failure.202021-12-11.html#264563398">(Dec 11 2021 at 13:41)</a>:</h4>
<p>Is it possible that this is a false positive for length 0? My understanding is that any aligned, non-null pointer should be valid for zero-length slices.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>