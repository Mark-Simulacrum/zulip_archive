<html>
<head><meta charset="utf-8"><title>Optimizing Stacked Borrows · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html">Optimizing Stacked Borrows</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264240721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264240721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264240721">(Dec 09 2021 at 00:23)</a>:</h4>
<div class="codehilite"><pre><span></span><code>// We *disable* instead of removing `Unique` to avoid &quot;connecting&quot; two neighbouring blocks of SRWs.
</code></pre></div>
<p>Is there anywhere that elaborates on this comment? All I can find is that an SRW is a Windows reader/writer lock, which doesn't seem like the right thing to be commenting on deep in the implementation of stacked borrows.</p>
<p>I'm asking _here_ because the sheer size of borrow stacks are a performance obstacle and this comment seems to suggest I can't remove anything from them, or I can, but only if I'm removing a disabled Item which is adjacent to another disabled one... right?</p>



<a name="264288717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264288717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264288717">(Dec 09 2021 at 11:41)</a>:</h4>
<p>I'm not intimately familiar with the code, but from what I was able to grasp from how SB works, is that removing Unique from the stack as an optimization would be a breaking change.</p>
<p>Imagine this Rust code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">b</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">addr_of_mut</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"> </span><span class="c1">// pushes a SharedReadWrite onto SB's stack</span>
<span class="kd">let</span><span class="w"> </span><span class="n">c</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"> </span><span class="c1">// copies `b`</span>
<span class="kd">let</span><span class="w"> </span><span class="n">d</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// pushes a Unique onto SB's stack</span>
<span class="kd">let</span><span class="w"> </span><span class="n">e</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>
<span class="c1">// this is okay, this is a reborrow of the Unique:</span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="c1">// this is undefined behavior, detected through the Unique on the stack</span>
<span class="c1">// that separates the blocks of SharedReadWrite permissions:</span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>If you'd remove that Unique, then Miri won't be able to detect the UB above.</p>



<a name="264304087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264304087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264304087">(Dec 09 2021 at 13:55)</a>:</h4>
<p>This page has some handy background information btw: <a href="https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md">https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md</a></p>



<a name="264322502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264322502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264322502">(Dec 09 2021 at 16:04)</a>:</h4>
<p>I'm thinking of removing Disabled borrows, not those currently granting Unique permission. But you're right, I should read more about how SB works.</p>
<p>My question is mostly me flailing about, trying to come up with a way to implement this: <a href="https://github.com/rust-lang/miri/issues/1367#issuecomment-619557947">https://github.com/rust-lang/miri/issues/1367#issuecomment-619557947</a></p>



<a name="264322927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264322927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264322927">(Dec 09 2021 at 16:06)</a>:</h4>
<p>The reason SB is currently super-linear is that borrow stacks grow without bound even on simple loops without state. So even with my prototype optimizations, the cloning of stacks still turns execution super-linear</p>



<a name="264393715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264393715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264393715">(Dec 10 2021 at 01:48)</a>:</h4>
<p>SRW = SharedReadWrite, in this context</p>



<a name="264393801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264393801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264393801">(Dec 10 2021 at 01:49)</a>:</h4>
<p>are you sure the <code>Disabled</code> items are even playing a notable role in that slowdown? I think the slowdown usually comes from huge amounts of SharedReadOnly (or SharedReadWrite) when many shared references to the same thing are being created and never invalidated. but that is pure guesswork.</p>



<a name="264397481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264397481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264397481">(Dec 10 2021 at 02:59)</a>:</h4>
<p>I added some instrumentation and yeah, there are precious few Disabled items in the borrow stack. If I continue to have energy for this (which would be great) I'll look into removing unused elements over the next days</p>



<a name="264537945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264537945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264537945">(Dec 11 2021 at 03:21)</a>:</h4>
<p>if there are only few of them then why would removing them make a big difference? I am a bit confused, maybe I misunderstood :)</p>



<a name="264538158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264538158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264538158">(Dec 11 2021 at 03:27)</a>:</h4>
<p>I <em>think</em> <span class="user-mention silent" data-user-id="120827">(Saethlin) Ben Kimock</span> is saying they will look into removing other (e.g., SRW) unused tags in the stack, since trying to remove Disabled tags isn't worth it given their infrequent occurrence.</p>



<a name="264538281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264538281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264538281">(Dec 11 2021 at 03:30)</a>:</h4>
<p>ah okay :)<br>
in that case the hard question is how to define 'unused'</p>



<a name="264580266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264580266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264580266">(Dec 11 2021 at 19:37)</a>:</h4>
<p>Yes, you both understand my intention correctly.</p>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> Do you happen to know what was run under miri to tune the RangeMap block merging code in the iter_mut method? I'm just looking at a workload where the optimal approach is to never merge blocks.</p>



<a name="264581503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20Stacked%20Borrows/near/264581503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20Stacked.20Borrows.html#264581503">(Dec 11 2021 at 20:01)</a>:</h4>
<p>I used the ones at <a href="https://github.com/rust-lang/miri/tree/master/bench-cargo-miri">https://github.com/rust-lang/miri/tree/master/bench-cargo-miri</a>. but I have no idea if they are any good. I am a total beginner when it comes to benchmarking / optimization.^^</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>