<html>
<head><meta charset="utf-8"><title>Reference counted tags? · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html">Reference counted tags?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275844482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275844482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275844482">(Mar 18 2022 at 18:30)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> per your suggestion <a href="https://github.com/rust-lang/miri/pull/2030#issuecomment-1070920868">https://github.com/rust-lang/miri/pull/2030#issuecomment-1070920868</a><br>
I started trying to implement this, but there is a truly massive amount of code in CTFE which relies on pointers/places being Copy :/</p>
<p>Did you have anything in mind that could make this less painful?</p>



<a name="275844957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275844957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275844957">(Mar 18 2022 at 18:34)</a>:</h4>
<p>yeah I dont think we want to actually make tags refcounted, TBH...</p>



<a name="275845705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275845705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275845705">(Mar 18 2022 at 18:40)</a>:</h4>
<p>The current scheme basically leaks memory. We don't have a way to reclaim memory associated with borrow tags which are inaccessible. Do you have a better idea on how to do that?</p>



<a name="275845883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275845883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275845883">(Mar 18 2022 at 18:42)</a>:</h4>
<p>I agree that all options are distasteful, but there are a handful of repos I know of whose tests use in excess of 125 GB when checking stacked borrows</p>



<a name="275847822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275847822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275847822">(Mar 18 2022 at 18:58)</a>:</h4>
<p>is some kind of tracing GC feasible?</p>



<a name="275852871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275852871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275852871">(Mar 18 2022 at 19:39)</a>:</h4>
<p>I see your question and I think it is a good one but I will need some time to think about that, if I can even answer it</p>



<a name="275853398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275853398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275853398">(Mar 18 2022 at 19:44)</a>:</h4>
<p>basically this is a garbage collection problem, and there are other algorithms besides refcounting, and those do allow references to remain <code>Copy</code>, so maybe they are more suited for us here</p>



<a name="275860597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275860597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275860597">(Mar 18 2022 at 20:47)</a>:</h4>
<p>I know precious little about GC, but just thinking through this...<br>
How do we deal with ptr-int-ptr with tracing? If the ptr is currently in an integer, sure we could deal with that by marking the tags as leaked (somehow). That seems a bit annoying but possible to implement. But what if we leak something like a <code>*mut Vec&lt;u8&gt;</code>? We would have to traverse the pointee, discover that it contains a pointer, and leak that one as well. That sounds like a lot of coupling between SB and CTFE.</p>



<a name="275860836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275860836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275860836">(Mar 18 2022 at 20:49)</a>:</h4>
<p>My original thought with cleaning up borrow stacks was to to do some sort of GC of <code>Item</code>s in the borrow stacks, because they're only derived from each other. I think that would keep <code>SbTag</code> simple (thus possibly enabling reference counting), what we'd need from CTFE is some kind of hook when a pointer or reference goes away or is leaked, which is starting to sound to me like a similar level of complexity that we need to implement a tracing GC.</p>



<a name="275861001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275861001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275861001">(Mar 18 2022 at 20:51)</a>:</h4>
<p>The only reason I was interesting in the <code>Rc&lt;SbTag&gt;</code> is that it would be a slick way to add a way for Miri/SB to learn that a pointer has become inaccessible (I want to say dropped, but they aren't Drop).</p>



<a name="275861419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275861419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275861419">(Mar 18 2022 at 20:54)</a>:</h4>
<p>well, a tracing GC assumes there are roots from which you can recursively find everything</p>



<a name="275861443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275861443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275861443">(Mar 18 2022 at 20:55)</a>:</h4>
<p>so worst case for SB, we have to literally go over all the values in the machine everywhere and see which tags are still in use</p>



<a name="275861460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275861460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275861460">(Mar 18 2022 at 20:55)</a>:</h4>
<p>that sounds horrible. but I am also no GC expert.^^</p>



<a name="275861585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275861585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275861585">(Mar 18 2022 at 20:56)</a>:</h4>
<p>due to ptr-int-ptr roundtrips there is not really such a thing as a pointer "going away" for good...</p>



<a name="275863005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275863005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275863005">(Mar 18 2022 at 21:08)</a>:</h4>
<p>If it isn't cast to an int, once all copies are dropped it doesn't make sense for the tag (unless it is Untagged) to be a parent tag of any retag, right?</p>



<a name="275863043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275863043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275863043">(Mar 18 2022 at 21:09)</a>:</h4>
<p>yeah</p>



<a name="275863069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Reference%20counted%20tags%3F/near/275863069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Reference.20counted.20tags.3F.html#275863069">(Mar 18 2022 at 21:09)</a>:</h4>
<p>but keeping track of all copies is pretty hard</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>