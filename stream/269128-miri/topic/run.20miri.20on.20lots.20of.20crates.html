<html>
<head><meta charset="utf-8"><title>run miri on lots of crates · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html">run miri on lots of crates</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276494125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276494125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276494125">(Mar 24 2022 at 15:41)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> you have run miri on many crates. Are your tools available somewhere publicly? I want to run it on a few hundred crates and build a histogram of how long it takes to get a broad picture of how much CPU time we'd need to run it on all of <a href="http://crates.io">crates.io</a></p>



<a name="276495310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276495310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276495310">(Mar 24 2022 at 15:48)</a>:</h4>
<p>The code that I'm running is right here: <a href="https://github.com/saethlin/miri-tools/blob/main/src/main.rs">https://github.com/saethlin/miri-tools/blob/main/src/main.rs</a></p>
<p>If you want to run it as-is, you need to <code>docker build . -t miri:latest</code> then <code>cargo r -- --crates=100</code> or such.</p>
<p>It's rather purpose-built, and I of course cannot endorse the quality of most of it. I started with using <code>rustwide</code> to implement this, but eventually got into a huge argument with it because <code>rustwide</code>'s toolchain management really does not work if you want to use a custom build of Miri.</p>



<a name="276702981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276702981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276702981">(Mar 26 2022 at 03:41)</a>:</h4>
<p>I'm 163 crates in (on account of how many times I've screwed up the setup over the past few days)</p>
<p>Only one crate has OOMed (adler), the next highest is pkg-config at a very neat 4 GB. Perhaps my fears about memory usage weren't backed up by data after all??</p>
<p>I don't cache <em>anything</em> in the builds.<br>
No crate finishes faster than 28 seconds. But 24 crates have hit my 15 minute wall time limit. The average crate uses about 84 seconds of CPU time. I wonder if that statistic will change a lot as I pick up more crates.</p>



<a name="276710359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276710359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276710359">(Mar 26 2022 at 06:59)</a>:</h4>
<p>Thank you! That are great numbers</p>



<a name="276710897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276710897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276710897">(Mar 26 2022 at 07:13)</a>:</h4>
<p>Rounding up to 2 minutes per crate, that's 30 crates per hour or 720 per day. To get to 72000 (simplified from 80000) we need 100 cores. Of course that means we lose every 7th crate due to the 15 min limit. I guess we can try running with a higher limit on a 96 core machine for a few days. And if that becomes a problem I can probably get something bigger.</p>
<p>Going with a mostly worst case assumption of 4GB memory usage, we need 400GB of RAM just to be safe when running 96 crates in parallel. Gotta check what I can requisition.</p>
<p>I'll have a look at your tool. Maybe I could change it into two tools? One generating machine readable data and one generating a webpage from it? That could simplify doing analysis on the results. Would that be something you'd be ok with?</p>
<p>Similarly I'd like to add a flag for parallelism.</p>



<a name="276728127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276728127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276728127">(Mar 26 2022 at 14:14)</a>:</h4>
<p>I just added parallelism</p>



<a name="276728142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276728142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276728142">(Mar 26 2022 at 14:15)</a>:</h4>
<p>(crudely)</p>



<a name="276728313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276728313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276728313">(Mar 26 2022 at 14:19)</a>:</h4>
<p>More than anything, the tool/codebase needs any kind of thought about how it's laid out. Right now it just spits out stdout+stderr and aggressively re-renders everything so that I can adjust the rendering code and restart it to see the effect. This is obviously not great. I feel like there is some place for a database better way to organize build logs.</p>
<p>I'm interested in most things.</p>



<a name="276729345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/run%20miri%20on%20lots%20of%20crates/near/276729345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/run.20miri.20on.20lots.20of.20crates.html#276729345">(Mar 26 2022 at 14:44)</a>:</h4>
<p>You could switch cargo to output json (including colored diagnostics as a field), that could make processing easier. Not sure about storage and databases. I'll think on it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>