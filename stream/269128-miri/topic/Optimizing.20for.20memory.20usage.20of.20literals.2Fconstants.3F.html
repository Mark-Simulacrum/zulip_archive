<html>
<head><meta charset="utf-8"><title>Optimizing for memory usage of literals/constants? · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html">Optimizing for memory usage of literals/constants?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275250366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275250366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275250366">(Mar 14 2022 at 15:16)</a>:</h4>
<p>While working on some SB diagnostics, I realized that I could have Miri emit a diagnostic that identifies allocations which are responsible for a lot of retags. I ran this on the tests for <code>serde-json</code> and got a lot of output that looks like this:</p>
<div class="codehilite"><pre><span></span><code>test test_write_object ... note: tracking was triggered
     |
     = note: This allocation is particularly busy
     = note: (no span available)
help: created here
    --&gt; /tmp/serde_json-1.0.79/src/ser.rs:1752:26
     |
1752 |         writer.write_all(b&quot;\&quot;&quot;)
     |                          ^^^^^

note: tracking was triggered
     |
     = note: This allocation is particularly busy
     = note: (no span available)
help: created here
    --&gt; /tmp/serde_json-1.0.79/src/ser.rs:1944:38
     |
1944 |         PrettyFormatter::with_indent(b&quot;  &quot;)
     |                                      ^^^^^
</code></pre></div>
<p>This seems particularly silly. In addition, a program like this consumes unbounded memory even without stacked borrows:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">"oh dear"</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I understand why creating a new allocation every time is desirable for CTFE, but I don't see how it's beneficial for Miri. And just thinking over the kinds of errors that are even possible to have on a literal or constant, I feel like it should be possible to cut some corners here but I can't seem to come up with what exactly one would do. Thoughts?</p>



<a name="275259631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275259631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275259631">(Mar 14 2022 at 16:14)</a>:</h4>
<p>What does the MIR look like in those case? I don't see any allocations in the loop example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">"oh dear"</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>MIR:</p>
<div class="codehilite"><pre><span></span><code>fn main() -&gt; () {
    let mut _0: ();                      // return place in scope 0 at src/main.rs:1:15: 1:15

    bb0: {
        goto -&gt; bb1;                     // scope 0 at src/main.rs:2:5: 2:24
    }

    bb1: {
        goto -&gt; bb1;                     // scope 0 at src/main.rs:2:5: 2:24
    }
}
</code></pre></div>



<a name="275259745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275259745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275259745">(Mar 14 2022 at 16:15)</a>:</h4>
<p>oh wait, the unbounded memory aspect is not in the MIR, but in how miri keeps track of the stack?</p>



<a name="275266575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275266575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275266575">(Mar 14 2022 at 16:59)</a>:</h4>
<p>There are two memory issues.</p>
<p>One is that in even that trivial example, every loop iteration creates a new allocation. I admit the MIR doesn't seem to line up with that, but if you <code>cargo miri run</code> that program, you can watch the memory usage of the process doubling every so often as the allocation map grows in size. This is probably important for CTFE because in a const eval context, you can't rely on the location of a constant. But since Miri is dealing in runtime semantics, you can rely on string literals being stable. So there could be some sort of caching/interning trick in Miri, perhaps?</p>
<p>The second aspect is specfic to stacked borrows. Every memory offset in every allocation has a borrow stack, but I think for literals/statics/constants, there is a severely restricted number of things you can do with the allocation. For example, I don't think there is any way to invalidate tags. And without raw pointer tracking, every tag either corresponds to a pointer in which case it can access the whole allocation or it corresponds to a reference which can't be moved anyway. So I feel like stacked borrows (without raw pointer tracking) collapses to just rejecting attempts at mutable access.</p>



<a name="275270677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275270677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275270677">(Mar 14 2022 at 17:28)</a>:</h4>
<blockquote>
<p>One is that in even that trivial example, every loop iteration creates a new allocation. I admit the MIR doesn't seem to line up with that, but if you cargo miri run that program, you can watch the memory usage of the process doubling every so often as the allocation map grows in size.</p>
</blockquote>
<p>I suspect this is because miri tracks somehow the path it traversed between MIR basic blocks. Although I never took a that close look at the code, so this is just pure guesswork :)</p>
<blockquote>
<p>The second aspect is specfic to stacked borrows. Every memory offset in every allocation has a borrow stack, but I think for literals/statics/constants, there is a severely restricted number of things you can do with the allocation.</p>
</blockquote>
<p>Ah, so instead of just pushing a tag per borrow, it could just increment a counter per borrow if the borrows are identical? (and decrease it when the borrow expires, kind of like <code>Rc</code>/<code>Arc</code>)</p>



<a name="275274446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275274446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275274446">(Mar 14 2022 at 17:57)</a>:</h4>
<p>Without the string literal I see the same MIR from the "show MIR" option in the playground, but I do not get memory usage growth with Miri. That's interesting.</p>



<a name="275275249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275275249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275275249">(Mar 14 2022 at 18:03)</a>:</h4>
<p>Hmm, maybe miri uses a different MIR export than the Playground, I don't remember how to get to the other MIR versions, though. I saw some other tools do that (e.g. Prusti).</p>



<a name="275275269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275275269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275275269">(Mar 14 2022 at 18:03)</a>:</h4>
<p>Maybe the string literal isn't removed with <code>-Zmir-opt-level=0</code>?</p>



<a name="275275379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275275379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275275379">(Mar 14 2022 at 18:04)</a>:</h4>
<p>Indeed <a href="https://rust.godbolt.org/z/oqTGa3cMj">https://rust.godbolt.org/z/oqTGa3cMj</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_0</span>: <span class="p">();</span><span class="w">                      </span><span class="c1">// return place in scope 0 at /app/example.rs:1:15: 1:15</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_1</span>: <span class="o">!</span><span class="p">;</span><span class="w">                       </span><span class="c1">// in scope 0 at /app/example.rs:2:5: 2:24</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_2</span>: <span class="p">();</span><span class="w">                      </span><span class="c1">// in scope 0 at /app/example.rs:1:1: 3:2</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_3</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">;</span><span class="w">                        </span><span class="c1">// in scope 0 at /app/example.rs:2:12: 2:21</span>

<span class="w">    </span><span class="n">bb0</span>: <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">StorageLive</span><span class="p">(</span><span class="n">_1</span><span class="p">);</span><span class="w">                 </span><span class="c1">// scope 0 at /app/example.rs:2:5: 2:24</span>
<span class="w">        </span><span class="n">goto</span><span class="w"> </span>-&gt; <span class="nc">bb1</span><span class="p">;</span><span class="w">                     </span><span class="c1">// scope 0 at /app/example.rs:2:5: 2:24</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">bb1</span>: <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">StorageLive</span><span class="p">(</span><span class="n">_3</span><span class="p">);</span><span class="w">                 </span><span class="c1">// scope 0 at /app/example.rs:2:12: 2:21</span>
<span class="w">        </span><span class="n">_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="s">"oh dear"</span><span class="p">;</span><span class="w">            </span><span class="c1">// scope 0 at /app/example.rs:2:12: 2:21</span>
<span class="w">        </span><span class="n">StorageDead</span><span class="p">(</span><span class="n">_3</span><span class="p">);</span><span class="w">                 </span><span class="c1">// scope 0 at /app/example.rs:2:21: 2:22</span>
<span class="w">        </span><span class="n">_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">();</span><span class="w">                   </span><span class="c1">// scope 0 at /app/example.rs:2:10: 2:24</span>
<span class="w">        </span><span class="n">goto</span><span class="w"> </span>-&gt; <span class="nc">bb1</span><span class="p">;</span><span class="w">                     </span><span class="c1">// scope 0 at /app/example.rs:2:5: 2:24</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275279375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275279375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275279375">(Mar 14 2022 at 18:33)</a>:</h4>
<blockquote>
<blockquote>
<p>I suspect this is because miri tracks somehow the path it traversed between MIR basic blocks. Although I never took a that close look at the code, so this is just pure guesswork :)</p>
</blockquote>
<p>Without the string literal I see the same MIR from the "show MIR" option in the playground, but I do not get memory usage growth with Miri. That's interesting.</p>
</blockquote>
<p>I took a glance at the code to see if miri "remembers" the basic blocks it traversed, but I don't see any such logic. It's probably related to the opt level that miri ingests and the borrow stack that keeps growing due to new borrows.</p>



<a name="275283077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275283077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275283077">(Mar 14 2022 at 18:59)</a>:</h4>
<p>I guess what miri is trying to do is: remember all the "old" pointers to <code>_3</code> so that it can detect if the loop leaked a pointer and whether it will be accessed after deallocation. Is there a way to also see the lifetimes together with the MIR? Or are these already converted into StorageLive/StorageDead at this point and there is no way to infer that <code>_3</code> could have a static lifetime in this case?</p>



<a name="275285484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275285484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275285484">(Mar 14 2022 at 19:17)</a>:</h4>
<p>This seems to make it worse <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span>  <a href="https://rust.godbolt.org/z/rWcejdMeh">https://rust.godbolt.org/z/rWcejdMeh</a></p>



<a name="275286211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275286211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275286211">(Mar 14 2022 at 19:23)</a>:</h4>
<p>It's probably because that statement in the loop block holds a non-ZST value that it insists on accessing. This also shows a StorageLive/StorageDead but without an access and memory usage stays normal:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275287280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275287280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275287280">(Mar 14 2022 at 19:33)</a>:</h4>
<p>In theory it should be possible to detect whether a (non-pointer) variable was only written to and never read, maybe in that case it wouldn't need to remember the tag when it goes out of scope, because it was never read and a pointer to its contents was never created, so it can't be accessed after de-allocating (barring any out-of-bounds pointers that were derived from a different allocated object - but those will be detected as such already). This should keep the stack nice and small in the presence of infinite loops!</p>



<a name="275287466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275287466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275287466">(Mar 14 2022 at 19:35)</a>:</h4>
<p>That probably won't help in the <code>serde</code> example that was posted earlier though, there the variable is actually accessed for reading :'(</p>



<a name="275300296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275300296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275300296">(Mar 14 2022 at 21:23)</a>:</h4>
<p>Actually, if miri throws out the unaccessed allocations (i.e. "unread") that are entirely within bounds of  the<code>range</code> that is being <a href="https://github.com/rust-lang/miri/blob/dce1a1b94fc633ec9f8e5bbf97f55d282795197b/src/stacked_borrows.rs#L594-L606">deallocated</a>, after calling <code>RangeMap::iter_mut</code> that might still work for the <code>serde</code> example assuming that a <code>move</code> does not count as a <code>memory_read</code>.</p>
<p>I was trying something along these lines: <a href="https://github.com/rust-lang/miri/compare/master...Pointerbender:for-science?expand=1">https://github.com/rust-lang/miri/compare/master...Pointerbender:for-science?expand=1</a> Tests seem to pass and the memory issue is gone for the "oh dear" loop example</p>



<a name="275300536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275300536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275300536">(Mar 14 2022 at 21:25)</a>:</h4>
<p>This is my first time hacking the internals of miri, so I don't know if this idea will hold up to scrutiny, but I could polish it a bit and create a PR if it's viable :)</p>



<a name="275305163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275305163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275305163">(Mar 14 2022 at 22:14)</a>:</h4>
<p>Okay hold up this is kind of making my head spin.</p>
<p>You're adding code in <code>memory_deallocated</code>. We're deallocating. Shouldn't we or the CTFE memory system be cleaning up all the resources associated with the allocation when it goes away? I suppose the fact that this has any impact at all means we aren't? So if I'm understanding this part correctly (and it's not a part of Miri I know well) I think the right patch here is to call <code>clear</code> or whatnot on everything associated with the allocation inside <code>memory_deallocated</code>.</p>



<a name="275307593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275307593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275307593">(Mar 14 2022 at 22:41)</a>:</h4>
<p>I can't reproduce a memory usage improvement with the above patch. I still get the same memory usage increase pattern, as well as peak memory usage for this test program</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">200_000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"oh dear"</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>/usr/bin/time -v cargo +miri miri run</code> tells me that this uses 604120 kbytes (maximum resident set size), give or take a MB or so.</p>



<a name="275349338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275349338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275349338">(Mar 15 2022 at 09:38)</a>:</h4>
<blockquote>
<p>Shouldn't we or the CTFE memory system be cleaning up all the resources associated with the allocation when it goes away? I suppose the fact that this has any impact at all means we aren't?</p>
</blockquote>
<p>I believe that currently by design miri doesn't clean up the stacks when those go away. I'm not sure what the reason for this is. Maybe this is so that it can detect when de-allocated memory is accessed or maybe it yields better performance if it doesn't have to remove elements from <code>Stacks.stacks: RefCell&lt;RangeMap&lt;Stack&gt;&gt;</code>. </p>
<p>In theory the <code>Stack</code>s can be removed at the end of a loop iteration if miri can prove that it's corresponding tag was not leaked to "outside" of the loop (this includes across FFI boundaries). Merely checking if the Stack was accessed as in the diff I posted is not sufficient and is a too naive approach, as nicely demonstrated with your latest example :)  Here it registers the <code>Stack</code> as accessed due to a mutable borrow being taken out on the iterator every loop iteration and calling <code>.next()</code> on it, and this is what prevents it from being cleaned up in my hacked idea.</p>
<p>Two more ideas on how to improve on that idea:</p>
<p>1) Instead of keeping the empty <code>Stack</code> around, we could just always <code>clear</code> it. This would take-away miri's ability to reason about accessing deallocated memory, but the end-result is the same: there exists no valid access tag on the stack (because the stack is missing for the tag).<br>
2) Do some complex analysis where miri finds the cycles between MIR basic blocks, and once it exits the cycle or restarts the cycle (e.g. go to the next loop iteration), then figure out which tags were not leaked to "outside" of the loop and clean those up in order to lower its memory consumption.</p>
<p>Both ideas would not be great for performance, but idea <a href="https://github.com/rust-lang/rust/issues/1">#1</a> is probably the least impacting. Performance impact for idea <a href="https://github.com/rust-lang/rust/issues/1">#1</a> can be somewhat mitigated with a different data structure backing <code>RangeMap</code>, which does less copying when elements are removed and does not allocate upon every insert.</p>



<a name="275349386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275349386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275349386">(Mar 15 2022 at 09:39)</a>:</h4>
<p>Currently <code>RangeMap</code> is backed by a <code>Vec</code>.</p>



<a name="275352893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275352893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275352893">(Mar 15 2022 at 10:13)</a>:</h4>
<p>Another nice aspect of idea <a href="https://github.com/rust-lang/rust/issues/1">#1</a> is that it doesn't need a <code>was_read</code> field on the <code>Stack</code> struct, which is better for the cache locality properties of <code>Stacks</code> :)</p>



<a name="275367568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275367568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275367568">(Mar 15 2022 at 12:48)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> here is another attempt at idea 1, it seems to work well for your last example too: <a href="https://github.com/rust-lang/miri/compare/master...Pointerbender:for-science2?expand=1">https://github.com/rust-lang/miri/compare/master...Pointerbender:for-science2?expand=1</a></p>



<a name="275367643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275367643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275367643">(Mar 15 2022 at 12:49)</a>:</h4>
<p>I ended up keeping the <code>Vec</code> for now and altering <code>RangeMap::iter_mut</code> to also get rid of empty stacks during the optimistic merging.</p>



<a name="275380323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275380323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275380323">(Mar 15 2022 at 14:30)</a>:</h4>
<p><span class="user-mention" data-user-id="400735">@Pointerbender</span> The code in the Miri repo isn't responsible for detecting use after free, that's handled by the rest of the interpreter implementation.</p>
<p>What are you doing to conclude that your changes improve memory usage? I still don't observe an improvement.</p>



<a name="275380912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275380912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275380912">(Mar 15 2022 at 14:35)</a>:</h4>
<p>I'm removing <code>Stack</code> instances from the <code>RangeMap</code> if those <code>Stack</code> are empty (when <code>RangeMap::iter_mut</code> is called). Which example are you running that still gives memory problems? Can you post your output from <code>time -v</code> ?</p>



<a name="275385388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275385388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275385388">(Mar 15 2022 at 15:05)</a>:</h4>
<p>I'm running the same code as before,</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">200_000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"oh dear"</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Output is</p>
<div class="codehilite"><pre><span></span><code>    Command being timed: &quot;cargo +miri miri run&quot;
    User time (seconds): 17.50
    System time (seconds): 0.31
    Percent of CPU this job got: 99%
    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:17.84
    Average shared text size (kbytes): 0
    Average unshared data size (kbytes): 0
    Average stack size (kbytes): 0
    Average total size (kbytes): 0
    Maximum resident set size (kbytes): 610676
    Average resident set size (kbytes): 0
    Major (requiring I/O) page faults: 0
    Minor (reclaiming a frame) page faults: 212202
    Voluntary context switches: 88
    Involuntary context switches: 38
    Swaps: 0
    File system inputs: 0
    File system outputs: 120
    Socket messages sent: 0
    Socket messages received: 0
    Signals delivered: 0
    Page size (bytes): 4096
    Exit status: 0
</code></pre></div>



<a name="275385785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275385785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275385785">(Mar 15 2022 at 15:08)</a>:</h4>
<p>Hmm, I'm getting different numbers, but I'm also running it slightly differently (same example though):</p>
<div class="codehilite"><pre><span></span><code>    Command being timed: &quot;~/git/rust/pointerbender/miri/miri run&quot;
    User time (seconds): 2.20
    System time (seconds): 0.72
    Percent of CPU this job got: 85%
    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:03.42
    Average shared text size (kbytes): 0
    Average unshared data size (kbytes): 0
    Average stack size (kbytes): 0
    Average total size (kbytes): 0
    Maximum resident set size (kbytes): 78712
    Average resident set size (kbytes): 0
    Major (requiring I/O) page faults: 1035
    Minor (reclaiming a frame) page faults: 182814
    Voluntary context switches: 1936
    Involuntary context switches: 32
    Swaps: 0
    File system inputs: 314528
    File system outputs: 312
    Socket messages sent: 0
    Socket messages received: 0
    Signals delivered: 0
    Page size (bytes): 4096
    Exit status: 0
</code></pre></div>
<p>3 seconds seems too short, although maybe it is that much faster with the memory issue gone?</p>



<a name="275387384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275387384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275387384">(Mar 15 2022 at 15:20)</a>:</h4>
<p>Oh wait, I can reproduce your output now with a different command:</p>
<div class="codehilite"><pre><span></span><code>    Command being timed: &quot;./miri run ../example/src/main.rs&quot;
    User time (seconds): 24.29
    System time (seconds): 0.80
    Percent of CPU this job got: 100%
    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:25.10
    Average shared text size (kbytes): 0
    Average unshared data size (kbytes): 0
    Average stack size (kbytes): 0
    Average total size (kbytes): 0
    Maximum resident set size (kbytes): 616348
    Average resident set size (kbytes): 0
    Major (requiring I/O) page faults: 14
    Minor (reclaiming a frame) page faults: 315733
    Voluntary context switches: 409
    Involuntary context switches: 347
    Swaps: 0
    File system inputs: 15552
    File system outputs: 312
    Socket messages sent: 0
    Socket messages received: 0
    Signals delivered: 0
    Page size (bytes): 4096
    Exit status: 0
</code></pre></div>
<p>Why do I get different results when executing the same binary from different working directories? <span aria-label="clown" class="emoji emoji-1f921" role="img" title="clown">:clown:</span></p>



<a name="275388774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275388774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275388774">(Mar 15 2022 at 15:30)</a>:</h4>
<p>I don't fully know why you're seeing what you're seeing. But if you look into the <code>miri</code> script, it runs <code>rustc --print-sysroot</code> which is set by a toolchain override inside the miri repo from <code>./rustup-toolchain</code>.</p>
<p>So I think it's a problem to run the <code>miri</code> script from outside of the repo.</p>



<a name="275390480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275390480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275390480">(Mar 15 2022 at 15:41)</a>:</h4>
<p>Does that imply that the memory consumption issue might be related to the toolchain version and not to miri itself?</p>



<a name="275393458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275393458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275393458">(Mar 15 2022 at 16:01)</a>:</h4>
<p>It seems the problem is not due to the empty <code>Stack</code>s sitting in the <code>RangeMap</code> , removing all the empty stacks on every deallocation is not having any effect on the memory usage :'(</p>



<a name="275393943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275393943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275393943">(Mar 15 2022 at 16:04)</a>:</h4>
<p>the toolchain in the other working directory (where the unbounded memory usage is not visible) is this for me btw:</p>
<div class="codehilite"><pre><span></span><code>active toolchain
----------------

nightly-x86_64-unknown-linux-gnu (default)
rustc 1.58.0-nightly (8b09ba6a5 2021-11-09)
</code></pre></div>



<a name="275396104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275396104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275396104">(Mar 15 2022 at 16:17)</a>:</h4>
<p>do you do shrink_to_fit() or just clear()?</p>



<a name="275397832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275397832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275397832">(Mar 15 2022 at 16:28)</a>:</h4>
<p>FWIW, I tried replacing the whole Option&lt;Stacks&gt; with a None upon deallocation by patching the code in src/machine.rs, and saw no improvement in memory use.</p>



<a name="275417084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275417084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275417084">(Mar 15 2022 at 18:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F/near/275396104">said</a>:</p>
<blockquote>
<p>do you do shrink_to_fit() or just clear()?</p>
</blockquote>
<p>The code I have locally for this is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Clone, Debug)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RangeMap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Elem</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">remove</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RangeMap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">clear</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">T</span>: <span class="nb">PartialEq</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="k">ref</span><span class="w"> </span><span class="n">remove</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">v</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|</span><span class="n">elem</span><span class="o">|</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">elem</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">remove</span><span class="p">.</span><span class="n">as_ref</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275417231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275417231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275417231">(Mar 15 2022 at 18:35)</a>:</h4>
<p>And then call that <code>clear</code> method at the end of <code>Stacks::memory_deallocated</code></p>



<a name="275417317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275417317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275417317">(Mar 15 2022 at 18:35)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Stacks</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">memory_deallocated</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">alloc_id</span>: <span class="nc">AllocId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">tag</span>: <span class="nc">SbTag</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">range</span>: <span class="nc">AllocRange</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">extra</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">MemoryExtra</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">InterpResult</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">"deallocation with tag {:?}: {:?}, size {}"</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">alloc_id</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">bytes</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extra</span><span class="p">.</span><span class="n">get_mut</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">for_each_mut</span><span class="p">(</span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">stack</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">stack</span><span class="p">.</span><span class="n">dealloc</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">Pointer</span>::<span class="n">new</span><span class="p">(</span><span class="n">alloc_id</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">),</span><span class="w"> </span><span class="n">global</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Cleanup empty stacks...</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">stacks</span><span class="p">.</span><span class="n">get_mut</span><span class="p">().</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275417382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275417382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275417382">(Mar 15 2022 at 18:36)</a>:</h4>
<p>Removing elements from a vec doesn't shrink it. You need an explicit <code>.shrink_to_fit()</code> to shrink it.</p>



<a name="275417715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275417715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275417715">(Mar 15 2022 at 18:38)</a>:</h4>
<p>Let me try, I was hoping that would be enough to prevent it from growing that large in the first place, will follow up shortly what the result of this is. :)</p>



<a name="275418182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275418182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275418182">(Mar 15 2022 at 18:42)</a>:</h4>
<p>That doesn't seem to make a significant difference  unfortunately (memory usage and execution time are similar still):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">Command</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">timed</span>: <span class="s">"./miri run ../prusti-example/src/main.rs"</span><span class="w"></span>
<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>: <span class="mf">25.00</span><span class="w"></span>
<span class="w">    </span><span class="n">System</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>: <span class="mf">0.97</span><span class="w"></span>
<span class="w">    </span><span class="n">Percent</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">CPU</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="n">got</span>: <span class="mi">99</span><span class="o">%</span><span class="w"></span>
<span class="w">    </span><span class="n">Elapsed</span><span class="w"> </span><span class="p">(</span><span class="n">wall</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">(</span><span class="n">h</span>:<span class="nc">mm</span>:<span class="nc">ss</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">m</span>:<span class="nc">ss</span><span class="p">)</span>: <span class="mi">0</span>:<span class="mf">25.98</span><span class="w"></span>
<span class="w">    </span><span class="n">Average</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">kbytes</span><span class="p">)</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Average</span><span class="w"> </span><span class="n">unshared</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">kbytes</span><span class="p">)</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Average</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">kbytes</span><span class="p">)</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Average</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">kbytes</span><span class="p">)</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Maximum</span><span class="w"> </span><span class="n">resident</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">kbytes</span><span class="p">)</span>: <span class="mi">616416</span><span class="w"></span>
<span class="w">    </span><span class="n">Average</span><span class="w"> </span><span class="n">resident</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">kbytes</span><span class="p">)</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Major</span><span class="w"> </span><span class="p">(</span><span class="n">requiring</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="p">)</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">faults</span>: <span class="mi">2</span><span class="w"></span>
<span class="w">    </span><span class="n">Minor</span><span class="w"> </span><span class="p">(</span><span class="n">reclaiming</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">faults</span>: <span class="mi">315753</span><span class="w"></span>
<span class="w">    </span><span class="n">Voluntary</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">switches</span>: <span class="mi">433</span><span class="w"></span>
<span class="w">    </span><span class="n">Involuntary</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">switches</span>: <span class="mi">108</span><span class="w"></span>
<span class="w">    </span><span class="n">Swaps</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">inputs</span>: <span class="mi">7720</span><span class="w"></span>
<span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">outputs</span>: <span class="mi">312</span><span class="w"></span>
<span class="w">    </span><span class="n">Socket</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="n">sent</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Socket</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="n">received</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Signals</span><span class="w"> </span><span class="n">delivered</span>: <span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">Page</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>: <span class="mi">4096</span><span class="w"></span>
<span class="w">    </span><span class="n">Exit</span><span class="w"> </span><span class="n">status</span>: <span class="mi">0</span><span class="w"></span>
</code></pre></div>



<a name="275418392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275418392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275418392">(Mar 15 2022 at 18:44)</a>:</h4>
<p>Maybe try massif (part of valgrind) to find which functions allocate the most memory?</p>



<a name="275424763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275424763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275424763">(Mar 15 2022 at 19:37)</a>:</h4>
<p>Hmm I think the version that comes with my OS distribution is too old, it shows mostly "xmalloc" as the culprit :P Compiling the latest valgrind binary results in a non-working binary.</p>



<a name="275425611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275425611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275425611">(Mar 15 2022 at 19:44)</a>:</h4>
<p>I will fiddle some more tomorrow to see if I can get a proper version of valgrind installed</p>



<a name="275425671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275425671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275425671">(Mar 15 2022 at 19:44)</a>:</h4>
<p>(or if anyone already has it installed and beats me to it that's fine too :) )</p>



<a name="275429605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275429605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275429605">(Mar 15 2022 at 20:16)</a>:</h4>
<p>Does it show any backtraces?</p>



<a name="275431331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275431331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275431331">(Mar 15 2022 at 20:32)</a>:</h4>
<p>It does, but something seems off, it only shows ~72kb of heap usage in total, while <code>time -v</code> suggests 9 times as much. I don't think it's showing the full picture on my version:<br>
<a href="/user_uploads/4715/ghS2O4GoMqbj_mDYrgD41hXG/Screenshot_2022-03-15_21-32-02.png">Screenshot_2022-03-15_21-32-02.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/ghS2O4GoMqbj_mDYrgD41hXG/Screenshot_2022-03-15_21-32-02.png" title="Screenshot_2022-03-15_21-32-02.png"><img src="/user_uploads/4715/ghS2O4GoMqbj_mDYrgD41hXG/Screenshot_2022-03-15_21-32-02.png"></a></div>



<a name="275431456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275431456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275431456">(Mar 15 2022 at 20:33)</a>:</h4>
<p>I bet that's a profile of the bash process running the <code>miri</code> script</p>



<a name="275431588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275431588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275431588">(Mar 15 2022 at 20:34)</a>:</h4>
<p>Yeah, the backtrace lists bash, not miri.</p>



<a name="275431942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275431942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275431942">(Mar 15 2022 at 20:37)</a>:</h4>
<p>massif produces 3 different files that all seem to contain data about the bash process</p>



<a name="275432672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275432672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275432672">(Mar 15 2022 at 20:43)</a>:</h4>
<p>Gonna try if i can hack the bash file to call valgrind from there :D</p>



<a name="275432985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275432985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275432985">(Mar 15 2022 at 20:46)</a>:</h4>
<p>hmm it ran but with an error and no output files:</p>
<div class="codehilite"><pre><span></span><code>--11993-- WARNING: unhandled amd64-linux syscall: 332
--11993-- You may be able to write your own handler.
--11993-- Read the file README_MISSING_SYSCALL_OR_IOCTL.
--11993-- Nevertheless we consider this a bug.  Please report
--11993-- it at http://valgrind.org/support/bug_reports.html.
</code></pre></div>



<a name="275433193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275433193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275433193">(Mar 15 2022 at 20:48)</a>:</h4>
<p>Going to try heaptrack instead</p>



<a name="275433628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275433628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275433628">(Mar 15 2022 at 20:52)</a>:</h4>
<p><a href="/user_uploads/4715/hJlizToYGYEAl4HqkOchIiIv/Screenshot_2022-03-15_21-51-02.png">Screenshot_2022-03-15_21-51-02.png</a> <a href="/user_uploads/4715/4Ya2t2KfBdGYmpS2QYJJnkwD/Screenshot_2022-03-15_21-50-20.png">Screenshot_2022-03-15_21-50-20.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/hJlizToYGYEAl4HqkOchIiIv/Screenshot_2022-03-15_21-51-02.png" title="Screenshot_2022-03-15_21-51-02.png"><img src="/user_uploads/4715/hJlizToYGYEAl4HqkOchIiIv/Screenshot_2022-03-15_21-51-02.png"></a></div><div class="message_inline_image"><a href="/user_uploads/4715/4Ya2t2KfBdGYmpS2QYJJnkwD/Screenshot_2022-03-15_21-50-20.png" title="Screenshot_2022-03-15_21-50-20.png"><img src="/user_uploads/4715/4Ya2t2KfBdGYmpS2QYJJnkwD/Screenshot_2022-03-15_21-50-20.png"></a></div><p>Now we're getting somewhere :)</p>



<a name="275433642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275433642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275433642">(Mar 15 2022 at 20:52)</a>:</h4>
<p>regex, interesting!</p>



<a name="275433924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275433924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275433924">(Mar 15 2022 at 20:55)</a>:</h4>
<p>that looks like a profile for the rustup wrapper for miri, not miri itself</p>



<a name="275434070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275434070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275434070">(Mar 15 2022 at 20:56)</a>:</h4>
<p>hmmm, in the <code>miri</code> bash script I updated the command to <code>exec heaptrack cargo run $CARGO_BUILD_FLAGS -- --sysroot "$MIRI_SYSROOT" "$@"</code></p>



<a name="275434132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275434132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275434132">(Mar 15 2022 at 20:57)</a>:</h4>
<p>Might you have any tips for what I could put there instead to directly call miri with all the right flags and env variables? :)</p>



<a name="275434370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275434370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275434370">(Mar 15 2022 at 20:59)</a>:</h4>
<p>Hmm there is a way to attach it to an already running process, let me see if I can grab it that way.</p>



<a name="275434408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275434408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275434408">(Mar 15 2022 at 20:59)</a>:</h4>
<p>I would probably add some -vv flags to Cargo and try to get the final thing it runs (full command) and then copy/paste that</p>



<a name="275436691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275436691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275436691">(Mar 15 2022 at 21:18)</a>:</h4>
<p>that worked, thanks :) going to run it again on the master branch to be sure none of my local hacks are getting in the way, one sec</p>



<a name="275438050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438050">(Mar 15 2022 at 21:29)</a>:</h4>
<p><a href="/user_uploads/4715/11tVA-BNkKHoIb_lvNpuDvjx/Screenshot_2022-03-15_22-29-24.png">Screenshot_2022-03-15_22-29-24.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/11tVA-BNkKHoIb_lvNpuDvjx/Screenshot_2022-03-15_22-29-24.png" title="Screenshot_2022-03-15_22-29-24.png"><img src="/user_uploads/4715/11tVA-BNkKHoIb_lvNpuDvjx/Screenshot_2022-03-15_22-29-24.png"></a></div>



<a name="275438228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438228">(Mar 15 2022 at 21:30)</a>:</h4>
<p><a href="/user_uploads/4715/hRnadiK7Dam2ArZ-3K8oRTxg/Screenshot_2022-03-15_22-30-43.png">Screenshot_2022-03-15_22-30-43.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/hRnadiK7Dam2ArZ-3K8oRTxg/Screenshot_2022-03-15_22-30-43.png" title="Screenshot_2022-03-15_22-30-43.png"><img src="/user_uploads/4715/hRnadiK7Dam2ArZ-3K8oRTxg/Screenshot_2022-03-15_22-30-43.png"></a></div>



<a name="275438349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438349">(Mar 15 2022 at 21:32)</a>:</h4>
<p><code>retag_return_place</code> has the most allocations</p>



<a name="275438399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438399">(Mar 15 2022 at 21:32)</a>:</h4>
<p>and here is the flame graph for peak memory usage:</p>



<a name="275438445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438445">(Mar 15 2022 at 21:32)</a>:</h4>
<p><a href="/user_uploads/4715/vrJpzhHoV8VE6I3ZHXTFY-a9/Screenshot_2022-03-15_22-32-25.png">Screenshot_2022-03-15_22-32-25.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/vrJpzhHoV8VE6I3ZHXTFY-a9/Screenshot_2022-03-15_22-32-25.png" title="Screenshot_2022-03-15_22-32-25.png"><img src="/user_uploads/4715/vrJpzhHoV8VE6I3ZHXTFY-a9/Screenshot_2022-03-15_22-32-25.png"></a></div>



<a name="275438697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438697">(Mar 15 2022 at 21:34)</a>:</h4>
<p>about ~45% of peak memory  usage comes from the <code>stacked_borrows</code> module</p>



<a name="275438896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275438896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275438896">(Mar 15 2022 at 21:36)</a>:</h4>
<p><code>Stacks::new_allocation</code> (14.4%) and <code>EvalContextExt::retag</code> (29.4%) being the biggest</p>



<a name="275443158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275443158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275443158">(Mar 15 2022 at 22:17)</a>:</h4>
<p>the <code>rustc_const_eval::interpret::eval_context::InterpCx::eval_rvalue_into_place</code> method is called quite a lot, too (whenever it does the assignment inside the loop I think)</p>



<a name="275443432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275443432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275443432">(Mar 15 2022 at 22:21)</a>:</h4>
<p><code>rustc_const_eval</code> might be the place to make an optimization for the memory issues it looks like <span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> , if it can do less allocations and deallocations there, then stacked borrows will automatically benefit from that as well in terms of memory usage. The memory usage seems roughly split down the middle between that crate and stacked borrows (which is called by <code>rustc_const_eval</code>).</p>



<a name="275443673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275443673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275443673">(Mar 15 2022 at 22:24)</a>:</h4>
<p>Hopefully such an optimization is possible for const literals :)</p>



<a name="275443924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275443924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275443924">(Mar 15 2022 at 22:26)</a>:</h4>
<p>Yeah, this is what I was trying to call out originally. It's really comforting that your data lines up with what I suspected from just some gdb prodding.</p>
<p>I think we get so many allocations here because in a <code>const fn</code> you can't rely on accessing the same string literal twice and getting the same address for it. If you could rely on that, there could be only a single allocation created in the const eval code for this string literal, and then it could be interned or... something. But Miri is modeling runtime semantics, so it doesn't have any particular reason to make a new allocation every time.</p>



<a name="275443997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275443997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275443997">(Mar 15 2022 at 22:27)</a>:</h4>
<p><span class="user-mention" data-user-id="400735">@Pointerbender</span>  Is there a file or something you can upload so I can look at your results? I've failed completely to operate <code>massif</code> every time I've tried, and I really want to see what is in some of those thinner flames that mention stacked borrows.</p>



<a name="275444479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275444479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275444479">(Mar 15 2022 at 22:32)</a>:</h4>
<p>Sure! Will PM it to you, one sec</p>



<a name="275444800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275444800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275444800">(Mar 15 2022 at 22:35)</a>:</h4>
<p>Even if miri/stacked borrows could deduplicate the literals it gets from <code>rustc_const_eval</code> this would only cut memory usage roughly in half, the space complexity will stay the same, unless this is fully addressed in <code>rustc_const_eval</code> somehow :'(</p>



<a name="275444961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275444961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275444961">(Mar 15 2022 at 22:37)</a>:</h4>
<p><a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_const_eval/interpret/eval_context/struct.InterpCx.html#method.deallocate_local">deallocate_local</a> from the <code>rustc_const_eval</code> crate also takes ~45% of the peak memory usage, this part never goes into miri as far as I can tell.</p>



<a name="275445521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275445521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275445521">(Mar 15 2022 at 22:42)</a>:</h4>
<p>Or maybe it does through a couple of trait indirections that have associated types that miri implements through the <code>Machine</code> trait, not sure now...</p>



<a name="275503218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275503218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275503218">(Mar 16 2022 at 12:27)</a>:</h4>
<p>Oh right, <code>&lt;Evaluator as Machine&gt;::memory_deallocated</code> is marked as <code>#[inline(always)]</code>, so I guess this one doesn't show up in the flamegraph because of that.</p>



<a name="275533425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275533425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275533425">(Mar 16 2022 at 16:03)</a>:</h4>
<p>wow a lot of theories here^^ but also many things are not quite matching how Miri works. miri doesn't keep track of a "trace" of how we got to the current BB, and it does deallocate stack locals when the function returns.<br>
Miri however <em>does</em> keep track of the size and alignment of allocations that have been deallocated. is that the map that is blowing up here?<br>
as for constants, there is indeed a new AllocId each time a constant is copied, so that is more likely the issue here with that <code>loop { "string" }</code> example.</p>



<a name="275533704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275533704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275533704">(Mar 16 2022 at 16:04)</a>:</h4>
<p>but when an allocation is removed, we do deallocate the stacked borrows data for it, so I doubt explicitly clearing/shrinking the rangemap will help</p>



<a name="275533921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275533921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275533921">(Mar 16 2022 at 16:05)</a>:</h4>
<blockquote>
<p>I think we get so many allocations here because in a const fn you can't rely on accessing the same string literal twice and getting the same address for it. If you could rely on that, there could be only a single allocation created in the const eval code for this string literal, and then it could be interned or... something. But Miri is modeling runtime semantics, so it doesn't have any particular reason to make a new allocation every time.</p>
</blockquote>
<p>basically, yes, except that the runtime semantics of Rust are <em>also</em> to make a new copy of that const each time. we just dont guarantee unique addresses, so rustc deduplicates most of those allocations (but with generic associated consts across crate boundaries, duplicates can remain).</p>



<a name="275534120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275534120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275534120">(Mar 16 2022 at 16:06)</a>:</h4>
<p>miri currently does no deduplication for constants. it does perform deduplication for vtables though.</p>



<a name="275534484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275534484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275534484">(Mar 16 2022 at 16:08)</a>:</h4>
<p>we could possibly also do this for constants, but is this really a problem in real code? <code>loop {"string" }</code> does not look realistic^^.<br>
looking at the code that started the thread, the issue there was a single allocation being very "busy" (in terms of SB I assume). deduplication constants will not change that, it will just make that one allocation even more busy.</p>



<a name="275537093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275537093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275537093">(Mar 16 2022 at 16:23)</a>:</h4>
<p>Yeah sorry for being a bit vague. I've been having a lot of fun hacking some stuff together in Miri recently.</p>
<p>My concern is twofold. First, I thought it might be nice to do allocation deduplication. But I didn't have a whole lot of hopes for that because of where allocations are handled, and you've also explained that it's not possible at all, semantically. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
<p>(my "is busy" diagnostic was a very crude way to visualize what parts of code are responsible for tag creation, my concern there is what kinds of code are producing a lot of tags)</p>
<p>My second concern is that in the implementation of stacked borrows inside Miri, we are using memory to store a borrow stack whose state isn't observable. For example, a length-1 string literal. Are there multiple meaningful states for the borrow stack of that allocation? It's only valid for reads, so doesn't checking stacked borrows simplify to just rejecting writes?</p>



<a name="275595055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275595055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275595055">(Mar 17 2022 at 00:37)</a>:</h4>
<blockquote>
<p>My concern is twofold. First, I thought it might be nice to do allocation deduplication. But I didn't have a whole lot of hopes for that because of where allocations are handled, and you've also explained that it's not possible at all, semantically. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>
<p>I think for constants it would be possible with a cache similar to vtables. I am not sure if we want that though. ideally we'd randomize this with the seed so we can find code that relies on address identity either way...</p>



<a name="275595121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275595121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275595121">(Mar 17 2022 at 00:38)</a>:</h4>
<blockquote>
<p>My second concern is that in the implementation of stacked borrows inside Miri, we are using memory to store a borrow stack whose state isn't observable. For example, a length-1 string literal. Are there multiple meaningful states for the borrow stack of that allocation? It's only valid for reads, so doesn't checking stacked borrows simplify to just rejecting writes?</p>
</blockquote>
<p>SB still also checks that the pointer is allowed to do the read -- if it has the wrong tag (a tag not in the borrow stack), the read is rejected</p>



<a name="275595909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275595909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275595909">(Mar 17 2022 at 00:52)</a>:</h4>
<p>Yes, but how does one end up with the wrong tag? I feel like you'd have to do one of</p>
<ul>
<li>Get a pointer that's from another allocation, which is rejected before you get into the stack checking part</li>
<li>Use an invalidated a pointer, which I think is impossible for string literals because you can't be granted Unique</li>
<li>In stacked borrows with raw pointer tagging, attempt to use an untagged pointer, but that again doesn't require touching the borrow stack</li>
</ul>



<a name="275596973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275596973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275596973">(Mar 17 2022 at 01:09)</a>:</h4>
<p>oh you mean for 1-byte allocations the AllocId already basically suffices... maybe? I agree there is some redundancy between SB tag and AllocId, but conceptually I think it is the AllocId that should be removed (but that will likely not be feasible to implement)</p>



<a name="275597775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275597775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275597775">(Mar 17 2022 at 01:24)</a>:</h4>
<p>With raw pointer tagging, I think we can avoid touching the borrow stack for things for 1-byte constants.</p>
<p>But without raw pointer tagging I think we can avoid touching the borrow stack for all operations on constants which are based on an Untagged pointer, regardless of size. The base tag always grants SRO, and only reads are possible.</p>



<a name="275597835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275597835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275597835">(Mar 17 2022 at 01:25)</a>:</h4>
<p>To be clear here, I don't want to suggest that I think this would address the memory blowup problems that Miri has in general. I'm pretty sure some of the catastrophic memory growth we see is fundamental to Stacked Borrows. But it might be nice to have a nice chunk off here and there.</p>



<a name="275598922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Optimizing%20for%20memory%20usage%20of%20literals/constants%3F/near/275598922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Optimizing.20for.20memory.20usage.20of.20literals.2Fconstants.3F.html#275598922">(Mar 17 2022 at 01:46)</a>:</h4>
<p>I am not sure it is worth special-casing 1-byte allocations</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>