<html>
<head><meta charset="utf-8"><title>Box and allocator_api miri failure · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Box.20and.20allocator_api.20miri.20failure.html">Box and allocator_api miri failure</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251825872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Box%20and%20allocator_api%20miri%20failure/near/251825872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DrMeepster <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Box.20and.20allocator_api.20miri.20failure.html#251825872">(Sep 03 2021 at 05:45)</a>:</h4>
<p>The following code (adapted from <a href="https://github.com/rust-lang/miri/issues/1207">https://github.com/rust-lang/miri/issues/1207</a> ) errors in miri</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(alloc_layout_extra, allocator_api, nonnull_slice_from_raw_parts )]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">alloc</span>::<span class="p">{</span><span class="n">Allocator</span><span class="p">,</span><span class="w"> </span><span class="n">Layout</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">,</span><span class="w"> </span><span class="n">AllocError</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">NonNull</span><span class="p">;</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">HEADER</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Alloc</span><span class="p">;</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Allocator</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Alloc</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Allocate a block with a usize sized header, and return a pointer to the</span>
<span class="w">    </span><span class="c1">// next address.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">NonNull</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">AllocError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">new_layout</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Layout</span>::<span class="n">new</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">().</span><span class="n">extend</span><span class="p">(</span><span class="n">layout</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">base_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">new_layout</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">cast</span><span class="p">().</span><span class="n">as_ptr</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">write</span><span class="p">(</span><span class="n">base_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">HEADER</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">NonNull</span>::<span class="n">new</span><span class="p">(</span><span class="n">base_ptr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">NonNull</span>::<span class="n">slice_from_raw_parts</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">cast</span><span class="p">(),</span><span class="w"> </span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">())).</span><span class="n">ok_or</span><span class="p">(</span><span class="n">AllocError</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">deallocate</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span>: <span class="nc">NonNull</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span>: <span class="nc">Layout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">new_layout</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Layout</span>::<span class="n">new</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">().</span><span class="n">extend</span><span class="p">(</span><span class="n">layout</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">.</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">().</span><span class="n">as_ptr</span><span class="p">()).</span><span class="n">wrapping_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="n">deallocate</span><span class="p">(</span><span class="n">NonNull</span>::<span class="n">new</span><span class="p">(</span><span class="n">base_ptr</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="n">new_layout</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Box</span>::<span class="n">new_in</span><span class="p">(</span><span class="mi">123_</span><span class="k">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">Undefined</span><span class="w"> </span><span class="n">Behavior</span>: <span class="nc">no</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="n">granting</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">deallocation</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3250</span><span class="o">&gt;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">alloc1519</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">borrow</span><span class="w"> </span><span class="n">stack</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">alloc</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">42</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">42</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">libc</span>::<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">libc</span>::<span class="n">c_void</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="n">granting</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">deallocation</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3250</span><span class="o">&gt;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">alloc1519</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">borrow</span><span class="w"> </span><span class="n">stack</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">this</span><span class="w"> </span><span class="n">indicates</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">potential</span><span class="w"> </span><span class="n">bug</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">program</span>: <span class="nc">it</span><span class="w"> </span><span class="n">performed</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">operation</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">rules</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">violated</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">experimental</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">see</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information</span>

<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">sys</span>::<span class="n">unix</span>::<span class="n">alloc</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">alloc</span>::<span class="n">GlobalAlloc</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">std</span>::<span class="n">alloc</span>::<span class="n">System</span><span class="o">&gt;</span>::<span class="n">dealloc</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">alloc</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">42</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">alloc</span>::<span class="n">System</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">alloc</span>::<span class="n">Allocator</span><span class="o">&gt;</span>::<span class="n">deallocate</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">alloc</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">218</span>:<span class="mi">22</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="o">&lt;</span><span class="n">Alloc</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">alloc</span>::<span class="n">Allocator</span><span class="o">&gt;</span>::<span class="n">deallocate</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">25</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">25</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">System</span><span class="p">.</span><span class="n">deallocate</span><span class="p">(</span><span class="n">NonNull</span>::<span class="n">new</span><span class="p">(</span><span class="n">base_ptr</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="n">new_layout</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">alloc</span>::<span class="n">alloc</span>::<span class="n">box_free</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">alloc</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">334</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">drop_in_place</span>::<span class="o">&lt;</span><span class="n">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shim</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="o">&gt;</span><span class="p">))</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ptr</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">192</span>:<span class="mi">1</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">main</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">30</span>:<span class="mi">34</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">30</span>:<span class="mi">34</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">30</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="nb">Box</span>::<span class="n">new_in</span><span class="p">(</span><span class="mi">123_</span><span class="k">usize</span><span class="p">,</span><span class="w"> </span><span class="n">Alloc</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                  </span><span class="o">^</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span>::<span class="n">call_once</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shim</span><span class="p">(</span><span class="k">fn</span><span class="p">())</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">227</span>:<span class="mi">5</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span>::<span class="o">&lt;</span><span class="k">fn</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sys_common</span><span class="o">/</span><span class="n">backtrace</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">125</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rt</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">63</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">function</span>::<span class="n">impls</span>::<span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">RefUnwindSafe</span><span class="o">&gt;</span>::<span class="n">call_once</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ops</span><span class="o">/</span><span class="n">function</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">259</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">r</span>#<span class="kr">try</span>::<span class="n">do_call</span>::<span class="o">&lt;&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">RefUnwindSafe</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">403</span>:<span class="mi">40</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">r</span>#<span class="kr">try</span>::<span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">RefUnwindSafe</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">367</span>:<span class="mi">19</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">catch_unwind</span>::<span class="o">&lt;&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">RefUnwindSafe</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">129</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rt</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">45</span>:<span class="mi">48</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">r</span>#<span class="kr">try</span>::<span class="n">do_call</span>::<span class="o">&lt;</span><span class="p">[</span><span class="n">closure</span><span class="o">@</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="p">{</span><span class="n">closure</span>#<span class="mi">2</span><span class="p">}],</span><span class="w"> </span><span class="kt">isize</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">403</span>:<span class="mi">40</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">panicking</span>::<span class="n">r</span>#<span class="kr">try</span>::<span class="o">&lt;</span><span class="kt">isize</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">closure</span><span class="o">@</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="p">{</span><span class="n">closure</span>#<span class="mi">2</span><span class="p">}]</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">367</span>:<span class="mi">19</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">panic</span>::<span class="n">catch_unwind</span>::<span class="o">&lt;</span><span class="p">[</span><span class="n">closure</span><span class="o">@</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span>::<span class="p">{</span><span class="n">closure</span>#<span class="mi">2</span><span class="p">}],</span><span class="w"> </span><span class="kt">isize</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">129</span>:<span class="mi">14</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start_internal</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rt</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">45</span>:<span class="mi">20</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">inside</span><span class="w"> </span><span class="err">`</span><span class="n">std</span>::<span class="n">rt</span>::<span class="n">lang_start</span>::<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">playground</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">nightly</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rt</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">62</span>:<span class="mi">5</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">aborting</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">error</span><span class="w"></span>
</code></pre></div>
<p>This code is not unsound, it does not violate the contract of the Allocator trait. This error only happens with Box, which means it probably has something to do with Box's special cased nature.</p>



<a name="252033245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Box%20and%20allocator_api%20miri%20failure/near/252033245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Box.20and.20allocator_api.20miri.20failure.html#252033245">(Sep 04 2021 at 23:18)</a>:</h4>
<blockquote>
<p>This code is not unsound, it does not violate the contract of the Allocator trait.</p>
</blockquote>
<p>are you sure it does not violate the aliasing model? I think you might be running into <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/256">https://github.com/rust-lang/unsafe-code-guidelines/issues/256</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>