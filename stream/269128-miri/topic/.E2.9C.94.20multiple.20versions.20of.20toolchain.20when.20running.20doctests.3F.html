<html>
<head><meta charset="utf-8"><title>✔ multiple versions of toolchain when running doctests? · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html">✔ multiple versions of toolchain when running doctests?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265495536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495536">(Dec 19 2021 at 19:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/269128-miri/topic/multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F/near/265479862">said</a>:</p>
<blockquote>
<p>The problem is that rustdoc directly invokes rustc and doesn't allow a rustc wrapper like miri. In addition it expects that rustc produces a working executable. Miri directly executes the program and doesn't leave any program to run.</p>
</blockquote>
<p>not entirely... miri invokes rustdoc with some flags so that rustdoc calls back to miri for compilation and execution of doctests</p>



<a name="265495562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495562">(Dec 19 2021 at 19:21)</a>:</h4>
<p>so they <em>should</em> work. but it's all somewhat fragile so I could easily imagine it can easily fall over -- though given that it works on CI and on my machine, I have no idea why...</p>



<a name="265495660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495660">(Dec 19 2021 at 19:23)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@(Saethlin) Ben Kimock</span> doctests should work for miri-test-libstd, how are you invoking it? this works for me: <code>./run-test.sh alloc --doc</code>.</p>



<a name="265495682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495682">(Dec 19 2021 at 19:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">(Saethlin) Ben Kimock</span> <a href="#narrow/stream/269128-miri/topic/multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F/near/265455853">said</a>:</p>
<blockquote>
<p>I just pulled the latest commits and ran the script then ran miri install. Perhaps there's something else awry with my environment.</p>
<p>This isn't the first time I've seen miri be fine then fall over trying to run doctests :/</p>
</blockquote>
<p>ran which script and then miri install? if you mean <code>./rustup-toolchain</code>, then that installs a toolchain so if you want to use the miri you installed that way you need to ensure you have that toolchain set everywhere</p>



<a name="265495734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495734">(Dec 19 2021 at 19:24)</a>:</h4>
<p>Welp, I have definitely not been doing that</p>



<a name="265495741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495741">(Dec 19 2021 at 19:24)</a>:</h4>
<p>e.g. my <code>rustup override list</code> says</p>
<div class="codehilite"><pre><span></span><code>/home/r/src/rust/miri                           miri
/home/r/src/rust/miri-test-libstd               miri
</code></pre></div>
<p>then using the <code>./miri install</code> miri should work for miri-test-libstd</p>



<a name="265495844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495844">(Dec 19 2021 at 19:27)</a>:</h4>
<p>the usual expectation is people install miri via rustup and then rustup takes care that the toolchains match -- <code>./miri install</code> means you have to do that yourself. it is meant only for when one wants to develop miri. that's why <code>./miri install</code> is only explained in the <a href="https://github.com/rust-lang/miri/blob/master/CONTRIBUTING.md">contrib docs</a> and there is says</p>
<blockquote>
<p>Make sure you use the same toolchain when calling cargo miri that you used when installing Miri!</p>
</blockquote>



<a name="265495848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495848">(Dec 19 2021 at 19:27)</a>:</h4>
<p>docs can probably always be improved. :) currently I am still unclear on why you are using <code>./miri install</code> rather than rustup to begin with</p>



<a name="265495937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265495937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265495937">(Dec 19 2021 at 19:29)</a>:</h4>
<p>I definitely didn't read the documentation well enough, and I was only bitten by the rustdoc interaction.<br>
I'm using <code>./miri install</code> because I want to run my branch of miri :)</p>



<a name="265496035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265496035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265496035">(Dec 19 2021 at 19:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">(Saethlin) Ben Kimock</span> has marked this topic as resolved.</p>



<a name="265496048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/%E2%9C%94%20multiple%20versions%20of%20toolchain%20when%20running%20doctests%3F/near/265496048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/.E2.9C.94.20multiple.20versions.20of.20toolchain.20when.20running.20doctests.3F.html#265496048">(Dec 19 2021 at 19:31)</a>:</h4>
<p>I added the directory override for miri-test-libstd and it all works perfectly now.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>