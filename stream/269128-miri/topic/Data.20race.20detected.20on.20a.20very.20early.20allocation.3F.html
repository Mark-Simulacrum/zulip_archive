<html>
<head><meta charset="utf-8"><title>Data race detected on a very early allocation? · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html">Data race detected on a very early allocation?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274634467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274634467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274634467">(Mar 09 2022 at 01:58)</a>:</h4>
<p>I recently dug this error out of my archive of Miri errors:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;called `Result::unwrap()` on an `Err` value: InterpErrorInfo(InterpErrorInfoInner { kind: Data race detected between Deallocate on Thread(id = 1) and Read on Thread(id = 0, name = &quot;main&quot;) at alloc245+0x13 (current vector clock = VClock([10, 2]), conflicting timestamp = VClock([15])), backtrace: None })&#39;, src/tools/miri/src/eval.rs:321:32
</code></pre></div>
<p>It happened when running on <code>bevy_asset</code> 0.6.0 with <code>rustc 1.60.0-nightly (6abb6385b 2022-01-26)</code>. Unfortunately I don't have a lockfile for the run that produced this, and it was some time ago. I can't reproduce it, though I haven't tried winding back my toolchain.</p>
<p>But I'm asking here because that is a <em>really</em> low allocation ID. That's so early that turning on allocation tracking either doesn't print anything for it, or that allocation is solidly part of the Rust runtime, in <code>std::rt::init</code>.</p>
<p>Does anyone know what's going on here? Kinda hoping I'm just running into a bug that was fixed between January 26 and now.</p>



<a name="274747618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274747618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274747618">(Mar 09 2022 at 20:26)</a>:</h4>
<p>do you know which commit of Miri that was with? seems odd that it would show this as a panic</p>



<a name="274749816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274749816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274749816">(Mar 09 2022 at 20:45)</a>:</h4>
<p>Decently sure it was <code>deb9bfd</code></p>



<a name="274770121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274770121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274770121">(Mar 09 2022 at 23:54)</a>:</h4>
<p>so the panic would be at <a href="https://github.com/rust-lang/miri/blob/deb9bfd/src/eval.rs#L321">https://github.com/rust-lang/miri/blob/deb9bfd/src/eval.rs#L321</a></p>



<a name="274770194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274770194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274770194">(Mar 09 2022 at 23:54)</a>:</h4>
<p>so the low alloc_id is probably indeed something related to the runtime, specifically env vars</p>



<a name="274770422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274770422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274770422">(Mar 09 2022 at 23:56)</a>:</h4>
<p>and it says some thread read an env var without being synchronized with program termination. which I guess can happen if there is a background thread still lingering around that has not been joined?</p>



<a name="274772911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/274772911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#274772911">(Mar 10 2022 at 00:20)</a>:</h4>
<p>That sounds possible. A <em>lot</em> of crates leak threads.</p>



<a name="275100748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/275100748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#275100748">(Mar 12 2022 at 14:53)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> could you open an issue for this? Not quite sure what to do about that, but seems worth tracking at least</p>



<a name="275100796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Data%20race%20detected%20on%20a%20very%20early%20allocation%3F/near/275100796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Data.20race.20detected.20on.20a.20very.20early.20allocation.3F.html#275100796">(Mar 12 2022 at 14:54)</a>:</h4>
<p>Will do</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>