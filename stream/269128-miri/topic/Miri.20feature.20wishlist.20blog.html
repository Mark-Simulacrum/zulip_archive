<html>
<head><meta charset="utf-8"><title>Miri feature wishlist blog · miri · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/index.html">miri</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html">Miri feature wishlist blog</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260603682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260603682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260603682">(Nov 08 2021 at 00:04)</a>:</h4>
<p>I wrote a blog post about a few ideas I had for improving miri. Or rather, things i'd like to someday add (or for someone else to) that would catch a lot of issues I've seen before. Anyway, this is probably the only group of people interested in such a thing at all so: <a href="https://shift.click/blog/miri-wishlist">https://shift.click/blog/miri-wishlist</a></p>



<a name="260887118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887118">(Nov 10 2021 at 01:12)</a>:</h4>
<p>Thanks for sharing. :)</p>



<a name="260887261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887261">(Nov 10 2021 at 01:14)</a>:</h4>
<blockquote>
<p>I think miri can help detect it by modifying “int mode” (or adding a variant if thats not possible) so that allocations never have a higher alignment then requested4 — if you request an alignment of 4, you should not happen to get an 8-byte aligned pointer by luck.</p>
</blockquote>
<p>the thing is, in a sense this <em>reduces</em> test coverage... e.g., imagine a repr(C) <code>struct Foo { x: i32, y: i32 }</code>. if we guarantee we will never get 8-aligned allocations for <code>Box&lt;Foo&gt;</code>, we actually guarantee that the 2nd field is 8-aligned!<br>
so, I thought about this and rejected the idea, instead Miri will ensure that for each allocation base address the last 4 bits are random, modulo what is required by alignment. this means a 4-aligned allocation will be 8-aligned half the time and not 8-aligned the other half. that's already a lot less aligned than real allocators.</p>



<a name="260887359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887359">(Nov 10 2021 at 01:16)</a>:</h4>
<p>Hm, is that what it does? I did notice that it was less aligned than real allocators</p>



<a name="260887405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887405">(Nov 10 2021 at 01:17)</a>:</h4>
<p>That's a good argument in favor of not doing it by default. I had considered the alignment of field (as in the later section), but not the interaction.</p>



<a name="260887429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887429">(Nov 10 2021 at 01:17)</a>:</h4>
<p>here's the code doing that: <a href="https://github.com/rust-lang/miri/blob/3f2c9ee17e64c89b1dd89c5970f106f3f74416cc/src/intptrcast.rs#L95">https://github.com/rust-lang/miri/blob/3f2c9ee17e64c89b1dd89c5970f106f3f74416cc/src/intptrcast.rs#L95</a></p>



<a name="260887443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887443">(Nov 10 2021 at 01:17)</a>:</h4>
<p>if you think 16 is too small, I'd be happy to increase that number</p>



<a name="260887541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887541">(Nov 10 2021 at 01:19)</a>:</h4>
<blockquote>
<p>Note that we need to be sure that no two pointers are ever separated by more than isize::MAX for compliance with other properties.</p>
</blockquote>
<p>where does that come from? LLVM requires that no single allocation be larger than isize::MAX, but ptrs into different allocs can be arbitrarily far apart I think.</p>



<a name="260887609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887609">(Nov 10 2021 at 01:20)</a>:</h4>
<p>Hm, good point. I forgot that it's not valid to subtract two unrelated pointers</p>



<a name="260887638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887638">(Nov 10 2021 at 01:20)</a>:</h4>
<p>but I freely admit that the int addresses Miri picks are not the result of a lot of thought (aside from the alignment thing which I did think about), mostly because this is outside my area of expertise. this should be rather easy to tweak though.<br>
(and this affects <em>all</em> allocations. currently miri puts stack and heap allocations next to each other without concern for how real stacks or heaps work. we could change that, too, if there is a good reason to.)</p>



<a name="260887651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887651">(Nov 10 2021 at 01:20)</a>:</h4>
<p>That's probably fine</p>



<a name="260887752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887752">(Nov 10 2021 at 01:22)</a>:</h4>
<p>specifically, what it currently does is to start at <a href="https://github.com/rust-lang/miri/blob/3f2c9ee17e64c89b1dd89c5970f106f3f74416cc/src/machine.rs#L32">32 * 4096</a> and then it just assigns addresses linearly as they are required, leaving small gaps for the above alignment thing.</p>



<a name="260887770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887770">(Nov 10 2021 at 01:22)</a>:</h4>
<p>Isn't it PTRDIFF_MAX, not isize::MAX, to be pedantic?</p>



<a name="260887786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887786">(Nov 10 2021 at 01:23)</a>:</h4>
<p>those miri constants will probably make anyone who actually knows how real addresses spaces are organized laugh out loud. or make them cry.^^</p>



<a name="260887875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260887875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260887875">(Nov 10 2021 at 01:24)</a>:</h4>
<p>so the "More Address Shenanigans" part of the post is rather easy to implement I think</p>



<a name="260889234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/269128-miri/topic/Miri%20feature%20wishlist%20blog/near/260889234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/269128-miri/topic/Miri.20feature.20wishlist.20blog.html#260889234">(Nov 10 2021 at 01:43)</a>:</h4>
<p>I actually had presumed that'd be a harder piece. i guess spurious wakeups have the question of "when" which is challenging</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>