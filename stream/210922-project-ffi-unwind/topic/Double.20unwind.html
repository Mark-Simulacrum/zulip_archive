<html>
<head><meta charset="utf-8"><title>Double unwind · project-ffi-unwind · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/index.html">project-ffi-unwind</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html">Double unwind</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268091732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268091732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268091732">(Jan 15 2022 at 00:22)</a>:</h4>
<p>I opened <a href="https://github.com/rust-lang/rust/issues/92911">#92911</a> to guard against double unwinding case.</p>



<a name="268206896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268206896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268206896">(Jan 16 2022 at 21:07)</a>:</h4>
<p>Another possible approach is to add a <code>foreign_unwind_enter</code> call when an C-unwind function unwinds to Rust code and call <code>foreign_unwind_leave</code> when Rust code unwinds out from an <code>extern "C-unwind"</code> function. The enter function could incremenet a counter and the leave function decrement it. Then PANIC_COUNT plus this counter can be used to determine if unwinding is currently in progress.</p>



<a name="268207061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268207061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268207061">(Jan 16 2022 at 21:10)</a>:</h4>
<p>Could that be at the discretion of the implementation (abort/terminate out of Destructor vs. immediate abort)?</p>



<a name="268207167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268207167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268207167">(Jan 16 2022 at 21:13)</a>:</h4>
<p>What does immediate abort mean here? Second unwinding never takes place instead of unwinding and abort when it reaches Rust code?</p>



<a name="268207228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268207228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268207228">(Jan 16 2022 at 21:14)</a>:</h4>
<p>AFAIK with MSVC SEH it's not possible to do multiple unwinds and it will always cause an immediate abort.</p>



<a name="268214431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268214431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268214431">(Jan 16 2022 at 23:57)</a>:</h4>
<p>I'm personally not too happy about <code>PANIC_COUNT</code> because it prevents things like using <code>catch_unwind</code> in a drop during unwinding. I would much prefer basing the decision of whether to abort immediately on the unwinding information.</p>



<a name="268214510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268214510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268214510">(Jan 16 2022 at 23:59)</a>:</h4>
<p>It's unfortunately needed for <a href="https://doc.rust-lang.org/nightly/std/thread/fn.panicking.html">std::thread::panicking</a> which is stable (and which I am not particularly a fan of either).</p>



<a name="268214628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268214628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268214628">(Jan 17 2022 at 00:00)</a>:</h4>
<p>We used to update PANIC_COUNT in <code>catch_unwind</code> but this was removed because we wanted it to be zero-cost.</p>



<a name="268216058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216058">(Jan 17 2022 at 00:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/Double.20unwind/near/268214431">said</a>:</p>
<blockquote>
<p>I'm personally not too happy about <code>PANIC_COUNT</code> because it prevents things like using <code>catch_unwind</code> in a drop during unwinding. I would much prefer basing the decision of whether to abort immediately on the unwinding information.</p>
</blockquote>
<p>In that case we would definitely need to guard against double unwinding (like <a href="https://github.com/rust-lang/rust/issues/92911">#92911</a> does). <code>PANIC_COUNT</code> does seem like a cheaper option (at least in terms of compile time)</p>



<a name="268216151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216151">(Jan 17 2022 at 00:37)</a>:</h4>
<p>The best way seems to improve LLVM so that it can encode an "terminate" action like GCC does.</p>



<a name="268216377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216377">(Jan 17 2022 at 00:43)</a>:</h4>
<p>There's been discussions about this on the LLVM mailing list, I can't remember what the main issues were.</p>



<a name="268216489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216489">(Jan 17 2022 at 00:46)</a>:</h4>
<p><a href="https://lists.llvm.org/pipermail/llvm-dev/2014-May/072892.html">https://lists.llvm.org/pipermail/llvm-dev/2014-May/072892.html</a></p>



<a name="268216493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216493">(Jan 17 2022 at 00:46)</a>:</h4>
<p>Basically it gets tricky when inlining is involved.</p>



<a name="268216667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216667">(Jan 17 2022 at 00:51)</a>:</h4>
<p>TBH it's only "tricky" when GCC-compatible LSDA needs to be produced. If there is a way to encode arbitrary LSDA then it would be fairly straightforward (but I guess then even a larger scale change is needed for LLVM).</p>



<a name="268216677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216677">(Jan 17 2022 at 00:51)</a>:</h4>
<blockquote>
<p>What does immediate abort mean here? Second unwinding never takes place instead of unwinding and abort when it reaches Rust code?</p>
</blockquote>
<p>Or abort when it does reach rust code, rather than when it exits the destructor.</p>



<a name="268216825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216825">(Jan 17 2022 at 00:54)</a>:</h4>
<p>It's possible if we encode terminate info in LSDA (aka not possible at the moment with LLVM)</p>



<a name="268216834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216834">(Jan 17 2022 at 00:54)</a>:</h4>
<p>To prevent the destructor from running then the info must be available to the personality function</p>



<a name="268216936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268216936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268216936">(Jan 17 2022 at 00:57)</a>:</h4>
<p>Could it be made that an implementation is permitted to do that, though?</p>



<a name="268217244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268217244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268217244">(Jan 17 2022 at 01:03)</a>:</h4>
<p>I don't think we have any specification in that regard yet, so we certainly <em>could</em>. And actually I think it's preferred to abort early.</p>



<a name="268217449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Double%20unwind/near/268217449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Double.20unwind.html#268217449">(Jan 17 2022 at 01:06)</a>:</h4>
<p>Indeed, though by the same, I would also prefer the option to abort when it leaves the destructor.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>