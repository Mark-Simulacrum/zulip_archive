<html>
<head><meta charset="utf-8"><title>Unblocking &quot;C-unwind&quot; · project-ffi-unwind · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/index.html">project-ffi-unwind</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html">Unblocking &quot;C-unwind&quot;</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267694089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267694089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267694089">(Jan 12 2022 at 08:31)</a>:</h4>
<p>It's very unfortunate that "C-unwind" is blocked on an edge case behavior when mixing crates compiled with <code>-C panic=unwind</code> and <code>-C panic=abort</code>. Could we simply say that such a combination is not supported?</p>
<p>The only use case for this at the moment is to allow a pre-built <code>std</code> with <code>-C panic=unwind</code> to link with crates compiled with <code>-C panic=abort</code>, but we could just use an unstable crate attribute on <code>std</code> to override the check in that particular case. The only restriction is that in return, <code>std</code> needs to be careful to not call any <code>"C-unwind"</code> functions that could generate a foreign exception which could get passed on to frames compiled with <code>-C panic=abort</code>.</p>



<a name="267695911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267695911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267695911">(Jan 12 2022 at 08:51)</a>:</h4>
<p>I did some research into the proposed solution of using a personality function that aborts:</p>
<ul>
<li>Unfortunately this require emitting unwinding information for all functions which can have an unacceptable memory cost on embedded platforms that are never going to unwind.</li>
<li>LLVM currently optimizes the personality of a function away if that function has no landing pads. This is normally a perfectly valid optimization that will require changes to LLVM to inhibit. The "proper" way of handling this is to actually emit a landing pad that aborts in <em>all</em> functions and stop using the <code>nounwind</code> attribute, but that pretty much defeats the point of <code>-C panic=abort</code>.</li>
<li>It <em>is</em> possible to do this on Windows, possibly by modifying LLVM to not guess the EH type from the personality function name. However the actual implementation of the personality function can't just abort since that would break longjmp and SEH. I can't see an easy way to only block C++ exceptions without relying on internal implementation details of the MSVC runtime.</li>
</ul>



<a name="267749856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267749856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267749856">(Jan 12 2022 at 16:36)</a>:</h4>
<p>Not allowing mixing panic strategies seems reasonable as a restriction.</p>



<a name="267764503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267764503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267764503">(Jan 12 2022 at 18:16)</a>:</h4>
<p>Does "not supported" mean the combination is effectively UB?</p>



<a name="267776801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267776801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267776801">(Jan 12 2022 at 19:51)</a>:</h4>
<p>I wonder if there are use cases where a library requires unwinding to function correctly internally, but this use case sounds fairly niche.</p>



<a name="267781474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267781474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267781474">(Jan 12 2022 at 20:29)</a>:</h4>
<p>Having a single <code>panic=abort</code> crate already forces panics to abort for all rust crates. It is just that <code>panic=abort</code> and <code>panic=unwind</code> crates codegen <code>extern "C-unwind"</code> differently enough that mixing them currently allows unwinding past <code>panic=abort</code> crates (rather than abort at the <code>extern "C-unwind"</code> boundary) which is UB.</p>



<a name="267786732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267786732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267786732">(Jan 12 2022 at 21:10)</a>:</h4>
<p>I was thinking about the case where a crate depends on foreign exception (e.g. C++) being able to propagate through Rust frames to function properly</p>



<a name="267787386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267787386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267787386">(Jan 12 2022 at 21:16)</a>:</h4>
<blockquote>
<p>LLVM currently optimizes the personality of a function away if that function has no landing pads. This is normally a perfectly valid optimization that will require changes to LLVM to inhibit. The "proper" way of handling this is to actually emit a landing pad that aborts in all functions and stop using the nounwind attribute, but that pretty much defeats the point of <code>-C panic=abort</code>.</p>
</blockquote>
<p>How bad will it be if we only generate <code>nounwind</code> attributes for calls that are known to not unwind? I.e. if the call target is compiled with <code>panic=abort</code>, then generate it; if the call tagret is <code>panic=unwind</code> or it's a indirect Rust-ABI call then omit it and create an aborting landing pad?</p>



<a name="267787811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267787811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267787811">(Jan 12 2022 at 21:20)</a>:</h4>
<p>BTW I think I should also point out that an aborting landing pad is not inherently expensive: it's super cheap in GCC but not so in Clang/LLVM: <a href="https://godbolt.org/z/bK34Wrxj7">https://godbolt.org/z/bK34Wrxj7</a>. I believe that this is GCC encoding the aborting information in LSDA so the personality function calls <code>terminate()</code> (kinda similar to <span class="user-mention" data-user-id="133247">@bjorn3</span> 's proposed solution) while in LLVM you don't have the ability to do this and thus an explicit landing pad is needed.</p>



<a name="267827161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267827161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267827161">(Jan 13 2022 at 05:55)</a>:</h4>
<p>I would prefer to keep things simple and not try to support a weird combination that nobody is using anyways.</p>



<a name="267907916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267907916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267907916">(Jan 13 2022 at 18:07)</a>:</h4>
<p>We haven't had our biweekly checkin for quite some time, but can we discuss this synchronously in about half an hour?</p>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="143274">@Amanieu</span> <span class="user-mention" data-user-id="303710">@Gary Guo</span> <span class="user-mention" data-user-id="133247">@bjorn3</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="257758">@Connor Horman</span></p>



<a name="267911547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/267911547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#267911547">(Jan 13 2022 at 18:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22/near/267694089">said</a>:</p>
<blockquote>
<p>It's very unfortunate that "C-unwind" is blocked on an edge case behavior when mixing crates compiled with <code>-C panic=unwind</code> and <code>-C panic=abort</code>. Could we simply say that such a combination is not supported?</p>
<p>The only use case for this at the moment is to allow a pre-built <code>std</code> with <code>-C panic=unwind</code> to link with crates compiled with <code>-C panic=abort</code>, but we could just use an unstable crate attribute on <code>std</code> to override the check in that particular case. The only restriction is that in return, <code>std</code> needs to be careful to not call any <code>"C-unwind"</code> functions that could generate a foreign exception which could get passed on to frames compiled with <code>-C panic=abort</code>.</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22/near/267781474">said</a>:</p>
<blockquote>
<p>Having a single <code>panic=abort</code> crate already forces panics to abort for all rust crates. It is just that <code>panic=abort</code> and <code>panic=unwind</code> crates codegen <code>extern "C-unwind"</code> differently enough that mixing them currently allows unwinding past <code>panic=abort</code> crates (rather than abort at the <code>extern "C-unwind"</code> boundary) which is UB.</p>
</blockquote>
<p>I'm not certain I'm following. It sounds like <span class="user-mention" data-user-id="143274">@Amanieu</span> is talking about dynamically linking binaries, whereas <span class="user-mention" data-user-id="133247">@bjorn3</span> is talking about the more typical situation of static compilation. Is that correct?</p>



<a name="270449954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/270449954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#270449954">(Feb 02 2022 at 20:11)</a>:</h4>
<p>sorry</p>



<a name="270449959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/Unblocking%20%22C-unwind%22/near/270449959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22.html#270449959">(Feb 02 2022 at 20:11)</a>:</h4>
<p>I've been totally checked out from this</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>