<html>
<head><meta charset="utf-8"><title>meeting 2022-1-13 · project-ffi-unwind · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/index.html">project-ffi-unwind</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html">meeting 2022-1-13</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267911067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911067">(Jan 13 2022 at 18:33)</a>:</h4>
<p>Trying out a sync meeting for the first time in a while...</p>
<p>Context is in the <code>Unblocking "C-unwind"</code> thread.</p>
<p><span class="user-group-mention" data-user-group-id="1866">@WG-ffi-unwind</span></p>



<a name="267911323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911323">(Jan 13 2022 at 18:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/Unblocking.20.22C-unwind.22/near/267776801">said</a>:</p>
<blockquote>
<p>I wonder if there are use cases where a library requires unwinding to function correctly internally, but this use case sounds fairly niche.</p>
</blockquote>
<p>There are; I believe we had some examples brought up before, but unfortunately I'm struggling to remember the specifics.</p>



<a name="267911438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911438">(Jan 13 2022 at 18:36)</a>:</h4>
<p>I do know of one example: libfringe uses unwinding to clean up coroutine stacks when they are dropped.</p>



<a name="267911467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911467">(Jan 13 2022 at 18:36)</a>:</h4>
<p>But I'm not sure that's directly relevant to this topic.</p>



<a name="267911550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911550">(Jan 13 2022 at 18:37)</a>:</h4>
<p>Anyways, what I am proposing is to simply disallow mixing panic=abort crates with panic=unwind crates. With one big exception for the standard library.</p>



<a name="267911623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911623">(Jan 13 2022 at 18:37)</a>:</h4>
<p>Ah, my <a href="https://docs.rs/stackful/latest/stackful/"><code>stackful</code></a> crate also uses unwinding for cancellation. But yeah I don't think this is related to FFI unwind.</p>



<a name="267911636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911636">(Jan 13 2022 at 18:37)</a>:</h4>
<p>How would <code>extern "C-unwind"</code> work in this case for foreign Rust-Rust (Externally linked, but defined in rust and called from rust) unwinding, involving only one implementation, or two unwind-compatible implementations.</p>



<a name="267911711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911711">(Jan 13 2022 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> would that mean that there would be no way for a crate to be "agnostic" about unwinding? That seems very non-desirable.</p>



<a name="267911715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911715">(Jan 13 2022 at 18:38)</a>:</h4>
<p>(Where the caller side is panic=abort, and the calee is panic=unwind)</p>



<a name="267911756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911756">(Jan 13 2022 at 18:38)</a>:</h4>
<p>I would just say that it's UB if a panic happens.</p>



<a name="267911769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911769">(Jan 13 2022 at 18:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267911636">said</a>:</p>
<blockquote>
<p>How would <code>extern "C-unwind"</code> work in this case for foreign Rust-Rust (Externally linked, but defined in rust and called from rust) unwinding, involving only one implementation, or two unwind-compatible implementations.</p>
</blockquote>
<p>Yeah, I have been thinking about this as well.</p>



<a name="267911775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911775">(Jan 13 2022 at 18:38)</a>:</h4>
<blockquote>
<p>I'm not certain I'm following. It sounds like @Amanieu is talking about dynamically linking binaries, whereas @bjorn3 is talking about the more typical situation of static compilation. Is that correct?</p>
</blockquote>
<p>When dynamically linking the <code>panic=...</code> is forced by the dynamic library. If a dynamic library is <code>panic=unwind</code>, it is impossible for a <code>panic=abort</code> crate to depend on it.</p>



<a name="267911878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911878">(Jan 13 2022 at 18:39)</a>:</h4>
<p>That could only apply to dylib crates, though, right?</p>



<a name="267911913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911913">(Jan 13 2022 at 18:40)</a>:</h4>
<p>This is talking about a Rust dynamic library rather than a cdylib, right?</p>



<a name="267911914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911914">(Jan 13 2022 at 18:40)</a>:</h4>
<p>Is this really something that people are relying on right now? I believe it's currently UB to unwind through panic=abort code, so at the very least we're not making the situation worse.</p>



<a name="267911942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911942">(Jan 13 2022 at 18:40)</a>:</h4>
<p>Yes, for static linking using any panic=abort crate forces everything panic=abort.</p>



<a name="267911983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267911983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267911983">(Jan 13 2022 at 18:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267911913">said</a>:</p>
<blockquote>
<p>This is talking about a Rust dynamic library rather than a cdylib, right?</p>
</blockquote>
<p>In my case, it's being <em>used</em> as a cdylib (though it's written in Rust).</p>



<a name="267912040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912040">(Jan 13 2022 at 18:41)</a>:</h4>
<p>Yeah, I think <span class="user-mention" data-user-id="257758">@Connor Horman</span> is talking about a cdylib uses unwinding and something that depends on that cdylib using <code>extern "Rust"</code></p>



<a name="267912069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912069">(Jan 13 2022 at 18:41)</a>:</h4>
<p>In this case I don't UB is desirable if the cdylib panics.</p>



<a name="267912193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912193">(Jan 13 2022 at 18:42)</a>:</h4>
<p>A cdylib should never export an <code>extern "Rust"</code> function. That is unsound as it allows unwinding across multiple unwind runtimes/standard libraries when using <code>panic=unwind</code>.</p>



<a name="267912224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912224">(Jan 13 2022 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267911942">said</a>:</p>
<blockquote>
<p>Yes, for static linking using any panic=abort crate forces everything panic=abort.</p>
</blockquote>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> to be clear -- you're not suggesting that statically linking <code>panic=unwind</code> crates with <code>panic=abort</code> crates would be a problem, are you? <code>panic=unwind</code> should "coerce" to <code>panic=abort</code> in that case.</p>



<a name="267912253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912253">(Jan 13 2022 at 18:43)</a>:</h4>
<p>If you use <code>extern "C"</code>/<code>extern "C-unwind"</code> at module boundaries then everything works fine.</p>



<a name="267912316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912316">(Jan 13 2022 at 18:43)</a>:</h4>
<p>The whole problem is that using a <code>panic=unwind</code> crate calling an <code>extern "C-unwind</code> function from a <code>panic=abort</code>crate is unsound as it doesn't abort at the moment.</p>



<a name="267912388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912388">(Jan 13 2022 at 18:44)</a>:</h4>
<p>It's just <code>extern "Rust"</code> that is a problem since you can't know whether it is <code>nounwind</code> unless you know which <code>-C panic=XXX</code> option was used to compile it.</p>



<a name="267912436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912436">(Jan 13 2022 at 18:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912193">said</a>:</p>
<blockquote>
<p>A cdylib should never export an <code>extern "Rust"</code> function. That is unsound as it allows unwinding across multiple unwind runtimes/standard libraries when using <code>panic=unwind</code>.</p>
</blockquote>
<p>It could, if the crate is aware of how it works. For example, in lccc (host), I have plans to replace the <code>rustcall</code> macro, which controls the ABI according to target, with merely <code>extern "Rust"</code> if the host supports the correct ABI.</p>



<a name="267912480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912480">(Jan 13 2022 at 18:45)</a>:</h4>
<p>Essentially <code>extern "Rust"</code> means "I <strong>know</strong> this function was compiled with the same panic model as me"</p>



<a name="267912519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912519">(Jan 13 2022 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912388">said</a>:</p>
<blockquote>
<p>It's just <code>extern "Rust"</code> that is a problem since you can't know whether it is <code>nounwind</code> unless you know which <code>-C panic=XXX</code> option was used to compile it.</p>
</blockquote>
<p>Ignoring <code>panic=unwind</code> <code>extern "C-unwind"</code>, <code>extern "Rust"</code> can't unwind if any crate in the crate graph is <code>panic=abort</code>. The panic runtime would cause any panic to abort.</p>



<a name="267912742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912742">(Jan 13 2022 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912388">said</a>:</p>
<blockquote>
<p>It's just <code>extern "Rust"</code> that is a problem since you can't know whether it is <code>nounwind</code> unless you know which <code>-C panic=XXX</code> option was used to compile it.</p>
</blockquote>
<p>Sounds like that <code>extern "Rust"</code> couldn't be used correctly in cdylib/staticlib then? Shall we just ban it?</p>



<a name="267912752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912752">(Jan 13 2022 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912436">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912193">said</a>:</p>
<blockquote>
<p>A cdylib should never export an <code>extern "Rust"</code> function. That is unsound as it allows unwinding across multiple unwind runtimes/standard libraries when using <code>panic=unwind</code>.</p>
</blockquote>
<p>It could, if the crate is aware of how it works. For example, in lccc (host), I have plans to replace the <code>rustcall</code> macro, which controls the ABI according to target, with merely <code>extern "Rust"</code> if the host supports the correct ABI.</p>
</blockquote>
<p>The cdylib contains one copy of the panic runtime and the standard library. The user of the cdylib contains another copy. The standard library maintains an internal panic count which isn't shared between the two standard library copies.</p>



<a name="267912818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912818">(Jan 13 2022 at 18:47)</a>:</h4>
<p>That seems like an internal implementation detail here.</p>



<a name="267912884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912884">(Jan 13 2022 at 18:48)</a>:</h4>
<p>Why is the entire standard library included in a dylib? Shouldn't it be dynamically linked?</p>



<a name="267912903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912903">(Jan 13 2022 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912742">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912388">said</a>:</p>
<blockquote>
<p>It's just <code>extern "Rust"</code> that is a problem since you can't know whether it is <code>nounwind</code> unless you know which <code>-C panic=XXX</code> option was used to compile it.</p>
</blockquote>
<p>Sounds like that <code>extern "Rust"</code> couldn't be used correctly in cdylib/staticlib then? Shall we just ban it?</p>
</blockquote>
<p>It can be used correctly for as long as the definition and the user are in the same crate graph. For example libcore and libstd use it for sharing some functions.</p>



<a name="267912953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912953">(Jan 13 2022 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120076">BatmanAoD (Kyle Strand)</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912884">said</a>:</p>
<blockquote>
<p>Why is the entire standard library included in a dylib? Shouldn't it be dynamically linked?</p>
</blockquote>
<p>The standard library is only dynamically linked if you use <code>-Cprefer-dynamic</code>.</p>



<a name="267912965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267912965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267912965">(Jan 13 2022 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120076">BatmanAoD (Kyle Strand)</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267912884">said</a>:</p>
<blockquote>
<p>Why is the entire standard library included in a dylib? Shouldn't it be dynamically linked?</p>
</blockquote>
<p>I think it can still be statically linked, but it would be odd if a dylib or cdylib didn't prefer dynamic linking for the stdlib.</p>



<a name="267913030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913030">(Jan 13 2022 at 18:49)</a>:</h4>
<blockquote>
<p>The standard library maintains an internal panic count which isn't shared between the two standard library copies.</p>
</blockquote>
<p>Sounds like an issue because these different copies use the same signature for the exceptions so they are considered compatible by the unwinding runtime.</p>



<a name="267913069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913069">(Jan 13 2022 at 18:49)</a>:</h4>
<p>For a cdylib you likely don't want to copy around libstd if you distribute it. Also I don't think there is an officially stable way to determine the filename of libstd-*.so.</p>



<a name="267913141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913141">(Jan 13 2022 at 18:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913069">said</a>:</p>
<blockquote>
<p>For a cdylib you likely don't want to copy around libstd if you distribute it.<br>
</p>
</blockquote>
<p>Maybe a stupid question, but why not?</p>



<a name="267913173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913173">(Jan 13 2022 at 18:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913069">said</a>:</p>
<blockquote>
<p>For a cdylib you likely don't want to copy around libstd if you distribute it. Also I don't think there is an officially stable way to determine the filename of libstd-*.so.</p>
</blockquote>
<p>SONAME would do this, at least on ELF platforms.</p>



<a name="267913310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913310">(Jan 13 2022 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913173">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913069">said</a>:</p>
<blockquote>
<p>For a cdylib you likely don't want to copy around libstd if you distribute it. Also I don't think there is an officially stable way to determine the filename of libstd-*.so.</p>
</blockquote>
<p>SONAME would do this, at least on ELF platforms.</p>
</blockquote>
<p>Rust uses a hash in the filename instead of SONAME. It is just that I don't think we guarantee anything about the actual filename. The directory to find it in is accessible on stable though as <code>rustc --print target-libdir</code>.</p>



<a name="267913648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913648">(Jan 13 2022 at 18:54)</a>:</h4>
<p>You could include that full filename in SONAME, and expose it - the DT_NEEDED entry will use the SONAME item, rather than the file name passed to the linker. That's my plan on lccc for dynamic linking of <code>libstd</code> (although the filename for libstd would look more like <code>libstd.so.0.1</code>).</p>



<a name="267913666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913666">(Jan 13 2022 at 18:54)</a>:</h4>
<p>So is it correct to say that any <code>extern "Rust"</code> <em>exported</em> by cdylib or staticlib shouldn't be used?</p>



<a name="267913716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913716">(Jan 13 2022 at 18:54)</a>:</h4>
<p>Yes</p>



<a name="267913834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913834">(Jan 13 2022 at 18:55)</a>:</h4>
<p>Wouldn't the same reasoning given above apply even to <code>dylib</code> crates?</p>



<a name="267913859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913859">(Jan 13 2022 at 18:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913648">said</a>:</p>
<blockquote>
<p>You could include that full filename in SONAME, and expose it - the DT_NEEDED entry will use the SONAME item, rather than the file name passed to the linker. That's my plan on lccc for dynamic linking of <code>libstd</code> (although the filename for libstd would look more like <code>libstd.so.0.1</code>).</p>
</blockquote>
<p>The DT_NEEDED entry already contains something like <code>libstd-7c582493123fc1dd.so</code> as that is the real filename. It is just that I don't think we guarantee that it matches <code>libstd-*.so</code> and not say <code>librust_internal_std-*.so</code>.</p>



<a name="267913861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913861">(Jan 13 2022 at 18:55)</a>:</h4>
<p>(Outside of the unwind-&gt;abort issue)</p>



<a name="267913956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913956">(Jan 13 2022 at 18:56)</a>:</h4>
<p>dylib crates share a single dynamically linked <a href="http://libstd.so">libstd.so</a>, so that's not a problem.</p>



<a name="267913958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913958">(Jan 13 2022 at 18:56)</a>:</h4>
<p>For dylib crates rustc already ensures that the standard library (and any other crate) is only included once.</p>



<a name="267913986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267913986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267913986">(Jan 13 2022 at 18:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913956">said</a>:</p>
<blockquote>
<p>dylib crates share a single dynamically linked <a href="http://libstd.so">libstd.so</a>, so that's not a problem.</p>
</blockquote>
<p>Dylib crates are statically linked to libstd by default too.</p>



<a name="267914073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914073">(Jan 13 2022 at 18:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267913958">said</a>:</p>
<blockquote>
<p>For dylib crates rustc already ensures that the standard library (and any other crate) is only included once.</p>
</blockquote>
<p>It gives a compiler error if you try to include it from two rust dynamic libraries. Rust dynamic libraries (not cdylib) export all symbols from all crates included in the dylib.</p>



<a name="267914116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914116">(Jan 13 2022 at 18:57)</a>:</h4>
<p>This is rustc (cargo?) forcing a library to be dynamic in case of a diamond dependency, is it?</p>



<a name="267914192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914192">(Jan 13 2022 at 18:58)</a>:</h4>
<p>Anyways, what I want to get out of this meeting is to unblock the stabilization of <code>c_unwind</code>. The only blocker is the handling of <code>extern "Rust"</code> functions in a mixed panic=unwind/panic=abort crate graph. Can we simply say that such a configuration is outside the scope of the RFC and just not support it?</p>



<a name="267914264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914264">(Jan 13 2022 at 18:59)</a>:</h4>
<p>In case of a diamond dependency the library has to be dynamic to avoid a compiler error. Unfortunately cargo doesn't force it to be a dynamic library currently, so you often get compiler errors when using dynamic libraries. I really hope that the dynamic linking situation of rust will eventually become better.</p>



<a name="267914304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914304">(Jan 13 2022 at 18:59)</a>:</h4>
<p>We don't have a stable way to create a mixed panic=unwind/panic=abort graph with Cargo (apart from libstd), don't we?</p>



<a name="267914364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914364">(Jan 13 2022 at 18:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914304">said</a>:</p>
<blockquote>
<p>We don't have a stable way to create a mixed panic=unwind/panic=abort graph with Cargo (apart from libstd), don't we?</p>
</blockquote>
<p>Not from cargo I believe. You can by manually invoking rustc or using another build system.</p>



<a name="267914540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914540">(Jan 13 2022 at 19:00)</a>:</h4>
<p>IIRC direct rustc invocation isn't part of stability guarantee?</p>



<a name="267914580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914580">(Jan 13 2022 at 19:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914540">said</a>:</p>
<blockquote>
<p>IIRC direct rustc invocation isn't part of stability guarantee?</p>
</blockquote>
<p>AFAIK it is. I surely hope so for all non-cargo users.</p>



<a name="267914610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914610">(Jan 13 2022 at 19:01)</a>:</h4>
<p>Isn't it? I'd be fairly suprised if it wasn't, especially for the parts that are explicitly exposed to cargo.</p>



<a name="267914612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914612">(Jan 13 2022 at 19:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914192">said</a>:</p>
<blockquote>
<p>Anyways, what I want to get out of this meeting is to unblock the stabilization of <code>c_unwind</code>. The only blocker is the handling of <code>extern "Rust"</code> functions in a mixed panic=unwind/panic=abort crate graph. Can we simply say that such a configuration is outside the scope of the RFC and just not support it?</p>
</blockquote>
<p>The easiest solution is to make <code>extern "C-unwind"</code> abort for panic=unwind crates too if any crate is panic=abort. Just have the personality function check if the panic_abort or panic_unwind runtime is used.</p>



<a name="267914636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914636">(Jan 13 2022 at 19:01)</a>:</h4>
<p>I thought that the issues preventing stabilization apply to normal Rust compilation wherein at least one crate is marked <code>panic=abort</code> but not all are marked that way. That's _certainly_ a use case we don't want to break, I think.</p>



<a name="267914665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914665">(Jan 13 2022 at 19:01)</a>:</h4>
<p>Note that this is only observable with foreign exceptions escaping from panic=unwind code into panic=abort code. Since foreign exceptions in Rust code are currently UB we're not breaking anything stable.</p>



<a name="267914703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914703">(Jan 13 2022 at 19:01)</a>:</h4>
<p>Rust panics will never generate an exception since the panic runtime will abort immediately.</p>



<a name="267914811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914811">(Jan 13 2022 at 19:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914665">said</a>:</p>
<blockquote>
<p>Note that this is only observable with foreign exceptions escaping from panic=unwind code into panic=abort code. Since foreign exceptions in Rust code are currently UB we're not breaking anything stable.</p>
</blockquote>
<p>Yeah, but I am trying to figure out if the mixed panic=unwind/panic=abort graph is currently considered stable.</p>



<a name="267914854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914854">(Jan 13 2022 at 19:02)</a>:</h4>
<p>Or are you suggesting that we only conditionally disallow it if "C-unwind" is being used?</p>



<a name="267914948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914948">(Jan 13 2022 at 19:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914854">said</a>:</p>
<blockquote>
<p>Or are you suggesting that we only conditionally disallow it if "C-unwind" is being used?</p>
</blockquote>
<p>The standard library internally uses it in a couple of places, so that would still be a breaking change.</p>



<a name="267914987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267914987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267914987">(Jan 13 2022 at 19:03)</a>:</h4>
<p>Well, <span class="user-mention" data-user-id="143274">@Amanieu</span> does mention a magic escape hatch for std.</p>



<a name="267915034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915034">(Jan 13 2022 at 19:03)</a>:</h4>
<p>Magic escape hatches sound <em>fun</em> tbh.</p>



<a name="267915214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915214">(Jan 13 2022 at 19:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914612">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267914192">said</a>:</p>
<blockquote>
<p>Anyways, what I want to get out of this meeting is to unblock the stabilization of <code>c_unwind</code>. The only blocker is the handling of <code>extern "Rust"</code> functions in a mixed panic=unwind/panic=abort crate graph. Can we simply say that such a configuration is outside the scope of the RFC and just not support it?</p>
</blockquote>
<p>The easiest solution is to make <code>extern "C-unwind"</code> abort for panic=unwind crates too if any crate is panic=abort. Just have the personality function check if the panic_abort or panic_unwind runtime is used.</p>
</blockquote>
<p>Do you agree <span class="user-mention" data-user-id="143274">@Amanieu</span>?</p>



<a name="267915437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915437">(Jan 13 2022 at 19:06)</a>:</h4>
<p>I prefer to have the personality function being agnostic to the panic runtime. (As I maintain a separate personality function and panic runtime impl myself)</p>



<a name="267915525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915525">(Jan 13 2022 at 19:07)</a>:</h4>
<p>It only needs to be a single <code>static ALLOWS_UNWINDING_ACROSS_C_UNWIND: bool</code>.</p>



<a name="267915534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915534">(Jan 13 2022 at 19:07)</a>:</h4>
<p>Same. In case you missed it, here's my PR moving the personality functions to <code>std</code> so they are independent of the panic runtime: <a href="https://github.com/rust-lang/rust/pull/92845">https://github.com/rust-lang/rust/pull/92845</a></p>



<a name="267915677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915677">(Jan 13 2022 at 19:08)</a>:</h4>
<p>I saw that PR. The personality function in std could read <code>ALLOWS_UNWINDING_ACROSS_C_UNWIND</code> from the panic runtime and abort if it is false <strong>and</strong> we are currently unwinding.</p>



<a name="267915719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915719">(Jan 13 2022 at 19:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267915437">said</a>:</p>
<blockquote>
<p>I prefer to have the personality function being agnostic to the panic runtime. (As I maintain a separate personality function and panic runtime impl myself)</p>
</blockquote>
<p>Same for me. I use replacement in lccc's stdlib inside <code>libproc_macro</code>. That way, panics from proc-macros can be caught inside the host compiler.</p>



<a name="267915822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915822">(Jan 13 2022 at 19:09)</a>:</h4>
<p>You could make sure that the proc macro doesn't see the host <code>ALLOWS_UNWINDING_ACROSS_C_UNWIND</code> static.</p>



<a name="267915833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915833">(Jan 13 2022 at 19:09)</a>:</h4>
<p>I would hope this EH personality eventually be moved into libcore or something that <code>#![no_std]</code> binary could use directly, and having it additionally require a boolean doesn't sound good.</p>



<a name="267915939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915939">(Jan 13 2022 at 19:10)</a>:</h4>
<p>Currently the personality function is completely independent of the panic runtime. It works purely off the DWARF metadata associated with the function.</p>



<a name="267915971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915971">(Jan 13 2022 at 19:10)</a>:</h4>
<p>Yeah, I would love to keep it this way.</p>



<a name="267915978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267915978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267915978">(Jan 13 2022 at 19:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267915822">said</a>:</p>
<blockquote>
<p>You could make sure that the proc macro doesn't see the host <code>ALLOWS_UNWINDING_ACROSS_C_UNWIND</code> static.</p>
</blockquote>
<p>Well that's easy, though that reprevokes the <code>unwind=abort</code> issue, since host could be compiled with RUSTFLAGS="-C panic=abort"`. Possibly something I could solve internally, though.</p>



<a name="267916058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916058">(Jan 13 2022 at 19:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267915833">said</a>:</p>
<blockquote>
<p>I would hope this EH personality eventually be moved into libcore or something that <code>#![no_std]</code> binary could use directly, and having it additionally require a boolean doesn't sound good.</p>
</blockquote>
<p>Initiating a panic to unwind requires the panic runtime anyway.</p>



<a name="267916113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916113">(Jan 13 2022 at 19:11)</a>:</h4>
<p>We can make a (new) panic runtime no_std compatible though.</p>



<a name="267916183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916183">(Jan 13 2022 at 19:12)</a>:</h4>
<p>Not for foreign exception unwinding through Rust frames (as long as it's not caught by Rust)</p>



<a name="267916191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916191">(Jan 13 2022 at 19:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916058">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267915833">said</a>:</p>
<blockquote>
<p>I would hope this EH personality eventually be moved into libcore or something that <code>#![no_std]</code> binary could use directly, and having it additionally require a boolean doesn't sound good.</p>
</blockquote>
<p>Initiating a panic to unwind requires the panic runtime anyway.</p>
</blockquote>
<p>Well, it requires <em>a</em> panic runtime. Which is easy enough to write if you have libgcc/libunwind.</p>



<a name="267916227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916227">(Jan 13 2022 at 19:12)</a>:</h4>
<p>It requires a <em>unwind runtime</em> but not a <em>panic runtime</em></p>



<a name="267916364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916364">(Jan 13 2022 at 19:13)</a>:</h4>
<p>The panic runtime is what determines if a panic unwinds or aborts. <code>-Cpanic=abort</code> works by switching from panic_unwind to panic_abort as panic runtime. Not emitting landingpads is just an optimization.</p>



<a name="267916366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916366">(Jan 13 2022 at 19:13)</a>:</h4>
<p>(I'd be interested to see what happens if I set up an exception frame in <code>#![no_std]</code> panic=unwind, that looks like the one specified in the lcrust abi and let it through rustc generated code... probably nothing good currently)</p>



<a name="267916376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916376">(Jan 13 2022 at 19:13)</a>:</h4>
<p>How about this: if a crate uses both <code>extern "C-unwind"</code> and <code>-C panic=unwind</code> then it cannot be included in the same crate graph as a crate compiled with <code>-C panic=abort</code>. We use a special escape hatch for <code>std</code> and the panic runtimes since know that their uses of <code>extern "C-unwind"</code> are only for Rust panics.</p>



<a name="267916581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916581">(Jan 13 2022 at 19:15)</a>:</h4>
<p>In other words, if a <code>panic=unwind</code> crate can receive a foreign exception then don't allow it to link with <code>panic=abort</code> crates.</p>



<a name="267916681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916681">(Jan 13 2022 at 19:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916191">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916058">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267915833">said</a>:</p>
<blockquote>
<p>I would hope this EH personality eventually be moved into libcore or something that <code>#![no_std]</code> binary could use directly, and having it additionally require a boolean doesn't sound good.</p>
</blockquote>
<p>Initiating a panic to unwind requires the panic runtime anyway.</p>
</blockquote>
<p>Well, it requires <em>a</em> panic runtime. Which is easy enough to write if you have libgcc/libunwind.</p>
</blockquote>
<p>We don't guarantee that the compiler uses DWARF or SEH based unwinding internally. It may just as well use <code>Result&lt;T, E&gt;</code> internally. Only the boundary presented by <code>extern "C-unwind</code> is guaranteed to use the platform default.</p>



<a name="267916815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916815">(Jan 13 2022 at 19:16)</a>:</h4>
<p>True. And even then, I'd imagine rustc doesn't specify <em>how</em> it uses the platform default if it doesn anyways.</p>



<a name="267916855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916855">(Jan 13 2022 at 19:17)</a>:</h4>
<p>Even without mixing unwind types: was this ever resolved? <a href="#narrow/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort/near/251763021">https://rust-lang.zulipchat.com/#narrow/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort/near/251763021</a></p>



<a name="267916949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916949">(Jan 13 2022 at 19:17)</a>:</h4>
<p>Sounds like std acutally just needs "C-unwind-if-unwind"</p>



<a name="267916957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267916957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267916957">(Jan 13 2022 at 19:17)</a>:</h4>
<p>If the platform default isn't used <code>extern "C-unwind"</code> has to call into a function to translate between the two. This function would logically be part of the panic runtime as it determines if it aborts or unwinds.</p>



<a name="267917053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917053">(Jan 13 2022 at 19:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120076">BatmanAoD (Kyle Strand)</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916855">said</a>:</p>
<blockquote>
<p>Even without mixing unwind types: was this ever resolved? <a href="#narrow/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort/near/251763021">https://rust-lang.zulipchat.com/#narrow/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort/near/251763021</a></p>
</blockquote>
<p>Not that I know of.</p>



<a name="267917076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917076">(Jan 13 2022 at 19:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916957">said</a>:</p>
<blockquote>
<p>If the platform default isn't used <code>extern "C-unwind"</code> has to call into a function to translate between the two. This function would logically be part of the panic runtime as it determines if it aborts or unwinds.</p>
</blockquote>
<p>What if the platform default <em>is</em> used?</p>



<a name="267917121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917121">(Jan 13 2022 at 19:19)</a>:</h4>
<p>Then you could still use such a function. It would just either continue unwinding or abort.</p>



<a name="267917162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917162">(Jan 13 2022 at 19:19)</a>:</h4>
<p>Alright.</p>



<a name="267917165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917165">(Jan 13 2022 at 19:19)</a>:</h4>
<p>Specifically: with <code>-Clto -Cpanic=abort</code>, we need to guarantee that <code>extern "C-unwind"</code> functions will actually abort if a foreign exception enters, but as of that post, we didn't, because there was a <code>rustc</code> pass that added <code>nounwind</code> everywhere.</p>



<a name="267917265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917265">(Jan 13 2022 at 19:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267917053">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120076">BatmanAoD (Kyle Strand)</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916855">said</a>:</p>
<blockquote>
<p>Even without mixing unwind types: was this ever resolved? <a href="#narrow/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort/near/251763021">https://rust-lang.zulipchat.com/#narrow/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort/near/251763021</a></p>
</blockquote>
<p>Not that I know of.</p>
</blockquote>
<p>I changed rustc to properly mark symbols are <code>nounwind</code> where appropriate so the LLVM pass shouldn't be necessary anymore.</p>



<a name="267917274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917274">(Jan 13 2022 at 19:20)</a>:</h4>
<p><del>I don't know if it has already been suggested, but could we add an annotation for <code>extern "C-unwind"</code> to the llvm ir and skip <code>nounwind</code> if this annotation is present.</del></p>



<a name="267917341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917341">(Jan 13 2022 at 19:20)</a>:</h4>
<p>^ oh, do you have a link to the PR?</p>



<a name="267917399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917399">(Jan 13 2022 at 19:21)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/88759/files#diff-622328a29486b5640dd0aafa10dfc044e1129408bc0eb1d10bb52cb061685377L514">https://github.com/rust-lang/rust/pull/88759/files#diff-622328a29486b5640dd0aafa10dfc044e1129408bc0eb1d10bb52cb061685377L514</a></p>



<a name="267917591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917591">(Jan 13 2022 at 19:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267916376">said</a>:</p>
<blockquote>
<p>How about this: if a crate uses both <code>extern "C-unwind"</code> and <code>-C panic=unwind</code> then it cannot be included in the same crate graph as a crate compiled with <code>-C panic=abort</code>. We use a special escape hatch for <code>std</code> and the panic runtimes since know that their uses of <code>extern "C-unwind"</code> are only for Rust panics.</p>
</blockquote>
<p>So far I think this is the best solution.</p>



<a name="267917593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917593">(Jan 13 2022 at 19:22)</a>:</h4>
<p>Thank you!</p>



<a name="267917649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917649">(Jan 13 2022 at 19:23)</a>:</h4>
<p>Related to <code>"C-unwind"</code> in general, but is it known whether <code>catch_unwind</code> can catch foreign exceptions? I'd think certainly it would have to if said foreign exception also runs destructors while unwinding the stack (as existing, generic code, currently relies on this to avoid inconsistencies in state caused by panics).</p>



<a name="267917661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917661">(Jan 13 2022 at 19:23)</a>:</h4>
<p>No, it can't</p>



<a name="267917686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917686">(Jan 13 2022 at 19:23)</a>:</h4>
<p>Doing so would cause an abort</p>



<a name="267917703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917703">(Jan 13 2022 at 19:23)</a>:</h4>
<p>Would it be allowed to, is a secondary question?</p>



<a name="267917709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917709">(Jan 13 2022 at 19:23)</a>:</h4>
<p>Yes it can, but right now it just aborts if a foreign exception is caught.</p>



<a name="267917781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917781">(Jan 13 2022 at 19:24)</a>:</h4>
<p>IE. is it guaranteed to do so, or is that a limitation of the implementation.</p>



<a name="267917802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917802">(Jan 13 2022 at 19:24)</a>:</h4>
<p>In my original implementation you could catch a foreign exception as a <code>Box&lt;Any&gt;</code>, but I changed it to abort instead.</p>



<a name="267917827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917827">(Jan 13 2022 at 19:24)</a>:</h4>
<p>It's relatively easy to support.</p>



<a name="267917888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267917888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267917888">(Jan 13 2022 at 19:25)</a>:</h4>
<p>I think it's just that we haven't decided about what it should do.</p>



<a name="267918130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918130">(Jan 13 2022 at 19:27)</a>:</h4>
<p>UB per the RFC, currently</p>



<a name="267918147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918147">(Jan 13 2022 at 19:27)</a>:</h4>
<p>In the abi I specified for lccc, I do mention foreign exceptions. Most of it is handwavy, though it guarantees support of any exceptions that use the same unwinding mechanism, which is almost always the platform default (and the other cases, its unspecified). <br>
Currently, it notes the implementation of the abi <em>may</em> support it, and if so, how to expose it (it does so as an exposition-only type, which can only really be inspected as an opaque blob).</p>



<a name="267918185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918185">(Jan 13 2022 at 19:27)</a>:</h4>
<p>Would that be potentially useful to incorporate into the RFC?</p>



<a name="267918349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918349">(Jan 13 2022 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267917265">said</a>:</p>
<blockquote>
<p>I changed rustc to properly mark symbols are <code>nounwind</code> where appropriate so the LLVM pass shouldn't be necessary anymore.</p>
</blockquote>
<p>To be clear, it's a <code>rustc</code> pass, not an LLVM pass. So we can remove it, but we haven't yet?</p>



<a name="267918389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918389">(Jan 13 2022 at 19:29)</a>:</h4>
<p>It doesn't have to be, since the RFC allows foreign exception to unwind through Rust frames or Rust exceptions to unwind through foreign frames.</p>



<a name="267918406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918406">(Jan 13 2022 at 19:29)</a>:</h4>
<p>Whether it could be caught or not is orthogonal IMO.</p>



<a name="267918635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918635">(Jan 13 2022 at 19:31)</a>:</h4>
<p>I think it should at least be noted, especially if foreign exceptions can cause actual stack unwinding (IE. runs destructors), because of the code I mentioned above (is that even specified itself?).</p>



<a name="267918760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918760">(Jan 13 2022 at 19:32)</a>:</h4>
<p>^ yes, foreign exceptions are guaranteed to run destructors (i.e. intermediate frames are not required to be "POF"s)</p>



<a name="267918768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918768">(Jan 13 2022 at 19:32)</a>:</h4>
<p>A sudden thought, what will happen currently if a destructor panics while the stack is being unwound by a foreign exception?</p>



<a name="267918832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918832">(Jan 13 2022 at 19:32)</a>:</h4>
<p>Panic count doesn't know about foreign exceptions.</p>



<a name="267918846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918846">(Jan 13 2022 at 19:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267918768">said</a>:</p>
<blockquote>
<p>A sudden thought, what will happen currently if a destructor panics while the stack is being unwound by a foreign exception?</p>
</blockquote>
<p>That's another question I had. In the aforementioned ABI, I make it unspecified if it immediately aborts, but guarantee it to abort if the panic/second-exception leaves the destructor.</p>



<a name="267918887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918887">(Jan 13 2022 at 19:33)</a>:</h4>
<p>Currently, "fun" happens. With <code>-Z panic-in-drop=abort</code>, it aborts because <code>drop_in_place</code> is nounwind.</p>



<a name="267918896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918896">(Jan 13 2022 at 19:33)</a>:</h4>
<p>^ that</p>



<a name="267918933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918933">(Jan 13 2022 at 19:33)</a>:</h4>
<p>and from the PR  (linked above), it looks like <code>panic-in-drop=abort</code> is intended to become the default eventually?</p>



<a name="267918959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267918959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267918959">(Jan 13 2022 at 19:33)</a>:</h4>
<p>All right, unfortunately I need to drop</p>



<a name="267919019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919019">(Jan 13 2022 at 19:34)</a>:</h4>
<p>thanks for jumping in everyone - maybe we can get syncs started up again if you're interested</p>



<a name="267919024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919024">(Jan 13 2022 at 19:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120076">BatmanAoD (Kyle Strand)</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267918760">said</a>:</p>
<blockquote>
<p>^ yes, foreign exceptions are guaranteed to run destructors (i.e. intermediate frames are not required to be "POF"s)</p>
</blockquote>
<p>Then it probably needs to be necessary to be able to catch foreign exceptions, otherwise, exsting crates that  use <code>catch_unwind</code> can become unsound in the place of user code that uses C-unwind.</p>



<a name="267919066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919066">(Jan 13 2022 at 19:34)</a>:</h4>
<p>I found my old <code>catch_unwind</code> implementation that catch foreign exceptions. They are returned as a <code>Box&lt;ForeignException&gt;</code> in the panic payload, but <code>ForeignException</code> is a ZST that just indicates that an exception happened. You can't actually rethrow the foreign exception.</p>



<a name="267919213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919213">(Jan 13 2022 at 19:35)</a>:</h4>
<p>It should be pretty easy to just store the exception instead of _Unwind_DeleteException it, and only call _Unwind_DeleteException when <code>ForeignException</code> is dropped.</p>



<a name="267919309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919309">(Jan 13 2022 at 19:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267919066">said</a>:</p>
<blockquote>
<p>I found my old <code>catch_unwind</code> implementation that catch foreign exceptions. They are returned as a <code>Box&lt;ForeignException&gt;</code> in the panic payload, but <code>ForeignException</code> is a ZST that just indicates that an exception happened. You can't actually rethrow the foreign exception.</p>
</blockquote>
<p>This is basically exactly what I had specified (I even gate it an explicit name, though made it <em>exposition-only</em> as mentioned above).</p>



<a name="267919312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919312">(Jan 13 2022 at 19:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267918887">said</a>:</p>
<blockquote>
<p>Currently, "fun" happens.</p>
</blockquote>
<p>I guess this is another blocker then.</p>



<a name="267919467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919467">(Jan 13 2022 at 19:37)</a>:</h4>
<p>Well clearly the solution to that is to make <code>-Z panic-in-drop=abort</code> the default.</p>



<a name="267919577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919577">(Jan 13 2022 at 19:38)</a>:</h4>
<p>I (and others) have some objections to that related to scope guards.</p>



<a name="267919592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919592">(Jan 13 2022 at 19:38)</a>:</h4>
<p>I could link to the appropriate section of the ABI spec (it's designated as WIP, but I doubt many more changes will occur unless I have significant problems when implementing it), if it would help give ideas on how to handle edge cases both  in general, and in rustc specifically.</p>



<a name="267919599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919599">(Jan 13 2022 at 19:38)</a>:</h4>
<p>How does C++ handle this?</p>



<a name="267919643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919643">(Jan 13 2022 at 19:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267919599">said</a>:</p>
<blockquote>
<p>How does C++ handle this?</p>
</blockquote>
<p>C++ <code>std::terminate</code>s if you exit a destructor with an exception if that destructor is called during stack unwinding.</p>



<a name="267919707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919707">(Jan 13 2022 at 19:39)</a>:</h4>
<p>(It specifically allows the second, third, or 10th even exception to be thrown, as long as all of them are caught before the destructor exits, though)</p>



<a name="267919787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919787">(Jan 13 2022 at 19:40)</a>:</h4>
<p>I mean through what mechanism does it know that the destructor is called during unwinding.</p>



<a name="267919903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919903">(Jan 13 2022 at 19:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267919787">said</a>:</p>
<blockquote>
<p>I mean through what mechanism does it know that the destructor is called during unwinding.</p>
</blockquote>
<p><del>In theory (a world with just C++ and just C++ exceptions), <code>std::uncaught_exceptions()</code>.</del> Wait, no, since you can execute a destructor normally in that case, and it gets caught.</p>



<a name="267919939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267919939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267919939">(Jan 13 2022 at 19:41)</a>:</h4>
<p>I am specifically talking about foreign exception case though.</p>



<a name="267920045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267920045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267920045">(Jan 13 2022 at 19:42)</a>:</h4>
<p>I assume on Itanium EH, it would just inject a guard frame for the personality routine in the unwinder.</p>



<a name="267920093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267920093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267920093">(Jan 13 2022 at 19:43)</a>:</h4>
<p>I suppose we could do the same then?</p>



<a name="267920146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267920146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267920146">(Jan 13 2022 at 19:43)</a>:</h4>
<p>Probably. It should work similarily for SEH and SJLJ, IIRC.</p>



<a name="267922344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267922344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267922344">(Jan 13 2022 at 20:00)</a>:</h4>
<p>C++ marks the destructor as <code>nounwind</code> and adds a hidden <code>try {} catch (...)</code> around the destructor that calls <code>std::terminate</code> if an exception tries to escape the destructor. Basically the exact same thing I am doing with <code>-Z panic-in-drop=abort</code>.</p>



<a name="267926841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267926841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267926841">(Jan 13 2022 at 20:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267922344">said</a>:</p>
<blockquote>
<p>C++ marks the destructor as <code>nounwind</code> and adds a hidden <code>try {} catch (...)</code> around the destructor that calls <code>std::terminate</code> if an exception tries to escape the destructor. Basically the exact same thing I am doing with <code>-Z panic-in-drop=abort</code>.</p>
</blockquote>
<p>it doesn't always. By default, destructors are <code>noexcept</code>, but you can explicitly write <code>~Foo() noexcept(false){ throw std::exception{"Heh"};}</code> and it will unwind normally (except if its called during stack unwinding).</p>



<a name="267928019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267928019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267928019">(Jan 13 2022 at 20:48)</a>:</h4>
<p>Poking at Clang's generated code it seems that what clang does is to add a hidden <code>try {} catch (...)</code> that calls terminate around the unwinding part.</p>



<a name="267928042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267928042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267928042">(Jan 13 2022 at 20:48)</a>:</h4>
<p>GCC is again using LSDA to do that with zero overhead.</p>



<a name="267928299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/267928299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#267928299">(Jan 13 2022 at 20:50)</a>:</h4>
<p><a href="https://godbolt.org/z/vG1r6xE5o">https://godbolt.org/z/vG1r6xE5o</a></p>



<a name="269607092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/meeting%202022-1-13/near/269607092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BatmanAoD (Kyle Strand) <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13.html#269607092">(Jan 27 2022 at 17:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267926841">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/210922-project-ffi-unwind/topic/meeting.202022-1-13/near/267922344">said</a>:</p>
<blockquote>
<p>C++ marks the destructor as <code>nounwind</code> and adds a hidden <code>try {} catch (...)</code> around the destructor that calls <code>std::terminate</code> if an exception tries to escape the destructor. Basically the exact same thing I am doing with <code>-Z panic-in-drop=abort</code>.</p>
</blockquote>
<p>it doesn't always. By default, destructors are <code>noexcept</code>, but you can explicitly write <code>~Foo() noexcept(false){ throw std::exception{"Heh"};}</code> and it will unwind normally (except if its called during stack unwinding).</p>
</blockquote>
<p>Wait, really?</p>
<p>I'm so glad to no longer be working with that language.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>