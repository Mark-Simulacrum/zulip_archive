<html>
<head><meta charset="utf-8"><title>mixing -Clto and -Cpanic=abort · project-ffi-unwind · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/index.html">project-ffi-unwind</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html">mixing -Clto and -Cpanic=abort</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251761877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251761877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251761877">(Sep 02 2021 at 18:21)</a>:</h4>
<p>I have questions about LTO and panic=abort that maybe <span class="user-mention" data-user-id="116015">@Alex Crichton</span> or <span class="user-mention" data-user-id="133247">@bjorn3</span> can answer</p>



<a name="251761919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251761919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251761919">(Sep 02 2021 at 18:21)</a>:</h4>
<p>Based on reading <a class="stream-topic" data-stream-id="210922" href="/#narrow/stream/210922-project-ffi-unwind/topic/weekly.20meeting">#project-ffi-unwind &gt; weekly meeting</a> ...</p>



<a name="251761954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251761954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251761954">(Sep 02 2021 at 18:21)</a>:</h4>
<p>I <em>think</em> the problem is that we have some kind of LLVM pass that triggers with <code>-Clto</code></p>



<a name="251761980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251761980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251761980">(Sep 02 2021 at 18:21)</a>:</h4>
<p>which goes and forcibly converts all invoke calls to not invoke</p>



<a name="251762011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762011">(Sep 02 2021 at 18:21)</a>:</h4>
<p>presumably because we may be mixing code from <code>-Cpanic=unwind</code> which was using <code>invoke</code></p>



<a name="251762070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762070">(Sep 02 2021 at 18:22)</a>:</h4>
<p>and the problem here is that there may be some calls to "C-unwind" FFI calls</p>



<a name="251762080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762080">(Sep 02 2021 at 18:22)</a>:</h4>
<p>which may indeed unwind, because we can't stop them</p>



<a name="251762104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762104">(Sep 02 2021 at 18:22)</a>:</h4>
<p>and now the personality function change that <span class="user-mention" data-user-id="133247">@bjorn3</span> proposed doesn't activate</p>



<a name="251762130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762130">(Sep 02 2021 at 18:22)</a>:</h4>
<p>because we are using an LLVM <code>call</code> and not an <code>invoke</code></p>



<a name="251762139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762139">(Sep 02 2021 at 18:22)</a>:</h4>
<p>is that all correct?</p>



<a name="251762167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762167">(Sep 02 2021 at 18:22)</a>:</h4>
<p>if so, is a plausible fix to add some sort of annotation to any call that we generate which is calling a "C-unwind" FFI function</p>



<a name="251762191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762191">(Sep 02 2021 at 18:22)</a>:</h4>
<p>and to modify the -Clto pass not to modify invokes with that annotation?</p>



<a name="251762213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251762213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251762213">(Sep 02 2021 at 18:23)</a>:</h4>
<p>I'm not sure how one adds such annotations :) I'm just assuming it's possible</p>



<a name="251763021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763021">(Sep 02 2021 at 18:28)</a>:</h4>
<p>For this there's not anything baked into LLVM itself, rather rustc manually adds <code>nounwind</code> to all function calls (which will later get optimized from <code>invoke</code> to <code>call</code> by LLVM). The compiler runs the custom pass <a href="https://github.com/rust-lang/rust/blob/fcce644119cf4e8e36001368e514bb5ed67cb855/compiler/rustc_codegen_llvm/src/back/lto.rs#L339-L344">here</a> which is defined <a href="https://github.com/rust-lang/rust/blob/fcce644119cf4e8e36001368e514bb5ed67cb855/compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp#L1267-L1284">here</a>. Put another way, this is all custom rustc code, so one fix is "just delete all that". This is somewhat nontrivial though in that it's not clear how many, if any, users are relying on the behavior today</p>



<a name="251763059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763059">(Sep 02 2021 at 18:28)</a>:</h4>
<p>LLVM afaik here has no issues, it's all about what we're giving LLVM</p>



<a name="251763478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763478">(Sep 02 2021 at 18:30)</a>:</h4>
<p>The problem is that I think, fundamentally, that pass can't be "updated" in some way that adjusts for the new <code>C-unwind</code> ABI. We can't differentiate at the LLVM-IR-level what's a Rust function and what isn't. With that, though, we may be able to patch all the IR to do the right thing (by recording which symbols can actually unwind and having them continue to unwind, just going to landing pads that abort)</p>



<a name="251763652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763652">(Sep 02 2021 at 18:31)</a>:</h4>
<p><span class="user-mention" data-user-id="116015">@Alex Crichton</span> I don't get why the pass can't be adjusted</p>



<a name="251763670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763670">(Sep 02 2021 at 18:31)</a>:</h4>
<p>this is kind of what I was proposing:</p>



<a name="251763735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763735">(Sep 02 2021 at 18:32)</a>:</h4>
<p>don't we only have to modify the <em>exact call</em> to a ffi-unwind function?</p>



<a name="251763757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763757">(Sep 02 2021 at 18:32)</a>:</h4>
<p>(and then it will enter our personality function and abort?)</p>



<a name="251763867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763867">(Sep 02 2021 at 18:32)</a>:</h4>
<p>as I type this out I think it may be able to get updated, yeah</p>



<a name="251763911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763911">(Sep 02 2021 at 18:33)</a>:</h4>
<p>I haven't thought much about specifics though</p>



<a name="251763973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/210922-project-ffi-unwind/topic/mixing%20-Clto%20and%20-Cpanic%3Dabort/near/251763973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/210922-project-ffi-unwind/topic/mixing.20-Clto.20and.20-Cpanic.3Dabort.html#251763973">(Sep 02 2021 at 18:33)</a>:</h4>
<p>but in theory there could be a set of symbols that are the <code>extern "C-unwind"</code> functions, both defined in Rust and in C), and any calls to those functions, with LTO, would immediately go to a landing pad that aborts.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>