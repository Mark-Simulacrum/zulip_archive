<html>
<head><meta charset="utf-8"><title>`Muckable` Shortcomings · project-safe-transmute · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/index.html">project-safe-transmute</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html">`Muckable` Shortcomings</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="216526979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216526979" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216526979">(Nov 12 2020 at 20:53)</a>:</h4>
<p>The <em>Drawbacks</em> section of the RFC is still a TODO, and I'd like to fill it out in the near future. The RFC presents a major design question with two compelling answers:</p>
<ul>
<li>just solve safety, but not stability (i.e., with <code>Here!()</code>)</li>
<li>solve safety in a way that intertwines it with stability (i.e., with <code>Muckable</code>)</li>
</ul>
<p>The drawbacks of the first approach have been well discussed. The drawbacks of the second approach less so, and I want to start documenting them.</p>



<a name="216528486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216528486" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216528486">(Nov 12 2020 at 21:05)</a>:</h4>
<p>Chiefely, I'd like to identify the situations where an all-or-nothing stability promise is prohibitively strong. If the stability constraints of <code>Muckable</code> are prohibitive for a type, then that type cannot be safely transmuted.</p>



<a name="216529318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216529318" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216529318">(Nov 12 2020 at 21:12)</a>:</h4>
<p>Mahkoh <a href="https://github.com/rust-lang/rfcs/pull/2981#issuecomment-720729607">points out</a>:</p>
<blockquote>
<p>The libc crate contains plenty of types that carry a size field at the start so that new fields can be added at the end in future versions. Surely it should be safe to transmute into those types?</p>
</blockquote>
<p>Concretely, with a type like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">FFIType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">size</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">field_1</span>: <span class="nc">Foo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">field_2</span>: <span class="nc">Bar</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* append-only more fields */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>...fields can be non-breakingly appended to this definition over time because the type is marked <code>#[non_exhaustive]</code>. </p>
<p>However, by implementing <code>Muckable</code>, the crate author promises to treat <em>any</em> observable changes to the type's layout as breaking changes. If this type implemented <code>Muckable</code>, any field additions would need to correspond to a major version release of its crate. The stability goals of crates like <code>libc</code> probably rule out implementing <code>Muckable</code>.</p>



<a name="216632313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216632313" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216632313">(Nov 13 2020 at 16:06)</a>:</h4>
<p>I'd like to note that within a C/FFI context, the <code>non_exhaustive</code> part is not considered important and is generally not applied to the structs in question.</p>



<a name="216633736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216633736" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216633736">(Nov 13 2020 at 16:14)</a>:</h4>
<p>If the crate in question is <code>libc</code>, as mahkoh suggests, it <em>would</em> be important—right?</p>



<a name="216659795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216659795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216659795">(Nov 13 2020 at 19:24)</a>:</h4>
<p>No. If the definition of the struct changes you'll have a new value in the size field.</p>



<a name="216659830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216659830" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216659830">(Nov 13 2020 at 19:25)</a>:</h4>
<p>Remember, other langs don't use matching so they don't care</p>



<a name="216660011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216660011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216660011">(Nov 13 2020 at 19:26)</a>:</h4>
<p>Yeah, I got that. But rust <em>does</em>, so you can't semver-nonbreakingly add a field to an exhaustively destructurable type without bumping the major version number.</p>



<a name="216660084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216660084" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216660084">(Nov 13 2020 at 19:26)</a>:</h4>
<p>I mean I guess that rust code could care about it on the rust-only side, yeah.</p>
<p>I should say that "in terms of a C FFI ABI interface it's not considered a break"</p>



<a name="216660377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216660377" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216660377">(Nov 13 2020 at 19:28)</a>:</h4>
<p>(And i suspect libc doesn't use non_exhaustive yet because it supports old compilers)</p>



<a name="216660441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216660441" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216660441">(Nov 13 2020 at 19:28)</a>:</h4>
<p>Yep! I think we're on the same page.</p>
<p>Basically: there's a pattern of abi evolution in C that isn't considered breaking. But to pull off that same pattern in Rust without semver breaking changes, you technically should  mark the type with <code>#[non_exhaustive]</code>.</p>



<a name="216660717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216660717" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216660717">(Nov 13 2020 at 19:30)</a>:</h4>
<p>yet again rust is slightly leaky with abstractions, oh well</p>



<a name="216757695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216757695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216757695">(Nov 14 2020 at 23:57)</a>:</h4>
<p>(cross-linking the discussion <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20semver.20hazard/near/216747469">here</a>! summary follows:)</p>
<p>If <code>Muckable</code> denotes fixed field order in the layout, then <code>Muckable</code> must <em>not</em> be implemented for <code>repr(rust)</code> types. Such types currently do not have many guarantees (and thus are not <code>TransmuteFrom</code> by a longshot), but it's not inconceivable that a future version of Rust <em>could</em> provide guarantees for those types other than field order.</p>
<p>If <code>Muckable</code> implementations on <code>repr(rust)</code> types are puttering around, those implementations go from being harmless (you can't observe their useless guarantee because they're not <code>TransmuteFrom</code>) to dangerous (since you <em>can</em> use them with <code>TransmuteFrom</code>.</p>
<p>We can solve this in a few ways:</p>
<ul>
<li>have <code>Muckable</code> continue to denote field-order stability but prohibit implementations of <code>Muckable</code> on types that aren't <code>#[repr(c)]</code></li>
<li>disentangle layout stability from safety</li>
</ul>



<a name="216865787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216865787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216865787">(Nov 16 2020 at 12:46)</a>:</h4>
<p>I hate to bring up old conversations, but is another possible way to clarify <code>Muckable</code> to break it up into several traits that more clearly mark their guarantees? If you have a <code>StableFieldOrdering</code> + <code>ByteComplete</code> + <code>InvariantFree</code> doesn't it become easier to know which invariants can be placed on which types?</p>



<a name="216907027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216907027" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216907027">(Nov 16 2020 at 17:52)</a>:</h4>
<p>It becomes a little more self-documenting, but we should be able to document what guarantees <code>Muckable</code> gives.</p>



<a name="216907072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216907072" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216907072">(Nov 16 2020 at 17:53)</a>:</h4>
<p>Also, I'd probably combine <code>ByteComplete</code> and <code>InvariantFree</code>, since if you don't have both you can't transmute into.</p>



<a name="216907120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216907120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216907120">(Nov 16 2020 at 17:53)</a>:</h4>
<p>(You could transmute something with aligned fields of the same type, but that doesn't seem worth the split.)</p>



<a name="216907208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216907208" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216907208">(Nov 16 2020 at 17:54)</a>:</h4>
<p>Similarly, for <code>StableFieldOrdering</code>, under what circumstances would you want to guarantee that and nothing else, or conversely, everything else but not that?</p>



<a name="216907214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216907214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216907214">(Nov 16 2020 at 17:54)</a>:</h4>
<p>What would you <em>get</em> by doing so?</p>



<a name="216907274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216907274" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216907274">(Nov 16 2020 at 17:55)</a>:</h4>
<p>I feel like the combination is the most useful, and it seems much rarer to want just some of the pieces.</p>



<a name="216912690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216912690" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216912690">(Nov 16 2020 at 18:34)</a>:</h4>
<p>When you say "you", do you mean the Rust Programming Language, or do you mean a type author making SemVer stability promises about their type?</p>



<a name="216917520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917520" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917520">(Nov 16 2020 at 19:12)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> example: StableFieldOrdering is <em>not</em> part of <code>struct Point2D(i32,i32)</code>, even though the type is byte complete and invariant free.</p>



<a name="216917601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917601" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917601">(Nov 16 2020 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> True (albeit I personally think it <em>should</em> be possible to assume that has the same order as any other <code>(i32,i32)</code>).</p>



<a name="216917625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917625" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917625">(Nov 16 2020 at 19:13)</a>:</h4>
<p>But if you can't assume <code>StableFieldOrdering</code>, what can you do, transmute-wise?</p>



<a name="216917695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917695">(Nov 16 2020 at 19:14)</a>:</h4>
<p>but the <code>(i32,i32)</code> values <em>also</em> don't have a stable field ordering :3 Specifically in the case of StableFieldOrdering you don't particularly "get" much out of a type lacking that trait, but that's also the default state for rust types, so that's just "how it is" for now</p>



<a name="216917720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917720" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917720">(Nov 16 2020 at 19:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/216917695">said</a>:</p>
<blockquote>
<p>but the <code>(i32,i32)</code> values <em>also</em> don't have a stable field ordering :3 Specifically in the case of StableFieldOrdering you don't particularly "get" much out of a type lacking that trait, but that's also the default state for rust types, so that's just "how it is" for now</p>
</blockquote>
<p>Right, but separating the traits would mostly be of benefit if you want to specify some but not all of them. But I don't think you <em>gain</em> anything by doing so.</p>



<a name="216917724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917724" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917724">(Nov 16 2020 at 19:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/216917625">said</a>:</p>
<blockquote>
<p>But if you can't assume <code>StableFieldOrdering</code>, what can you do, transmute-wise?</p>
</blockquote>
<p>Quite a bit, depending on your use-case and what degree of stability you need.</p>



<a name="216917755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917755" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917755">(Nov 16 2020 at 19:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/216912690">said</a>:</p>
<blockquote>
<p>When you say "you", do you mean the Rust Programming Language, or do you mean a type author making SemVer stability promises about their type?</p>
</blockquote>
<p>I mean the latter, but in particular, I mean "what do you gain in terms of capabilities, by specifying some but not all of these promises".</p>



<a name="216917786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917786" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917786">(Nov 16 2020 at 19:15)</a>:</h4>
<p>For language-level stability, see this comment: <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20semver.20hazard/near/216750267">https://rust-lang.zulipchat.com/#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20semver.20hazard/near/216750267</a></p>



<a name="216917832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917832" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917832">(Nov 16 2020 at 19:15)</a>:</h4>
<p>also, traits aren't really about "missing" something to begin with, they're about saying "this type <strong>supports</strong> a thing", so Copy is about "this type is freely copyable (and not all things are!)" and StableFieldOrder is about "this type has a stable field order (and not all types have that!)"</p>



<a name="216917861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917861" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917861">(Nov 16 2020 at 19:16)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> If you can't assume that the fields have the same order as even another type with the same fields, I don't think there's any useful transmute you can do, except perhaps between containers containing the type opaquely.</p>



<a name="216917969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216917969" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216917969">(Nov 16 2020 at 19:16)</a>:</h4>
<p>Ah, I see.</p>



<a name="216918039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918039" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918039">(Nov 16 2020 at 19:17)</a>:</h4>
<blockquote>
<p>except perhaps between containers containing the type opaquely.</p>
</blockquote>
<p>That's nothing to sneeze at, though. That's the extent of Haskell's <code>Coercible</code> machinery.</p>



<a name="216918076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918076" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918076">(Nov 16 2020 at 19:17)</a>:</h4>
<p>I'd forgotten that one of the things you could "ask for" with the safe-transmute trait-based system was whether you cared about stability, and if you don't care then it's fine to transmute the type into bytes and bytes back into the type as long as you don't unserialize them with a different compiled version of the code than you serialized them with.</p>



<a name="216918180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918180" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918180">(Nov 16 2020 at 19:18)</a>:</h4>
<p>It's debatable how "safe" that is (since you have to manually maintain the invariant that you're handing back the same bytes you got in).</p>



<a name="216918207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918207">(Nov 16 2020 at 19:18)</a>:</h4>
<p>But safety aside, it's something you'd be allowed to do.</p>



<a name="216918209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918209" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918209">(Nov 16 2020 at 19:18)</a>:</h4>
<p>which actually makes a lot of network apps "way easier" if you know you're communicating with a particular bit of code on the far side, eg if you've deployed both the server and the client</p>



<a name="216918445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918445" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918445">(Nov 16 2020 at 19:20)</a>:</h4>
<p>Now <em>separately</em> from safe transmute we should probably take some effort and specify more cases of repr(rust) at some point, but that would be a whole separate RFC.</p>



<a name="216918709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918709" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918709">(Nov 16 2020 at 19:22)</a>:</h4>
<p>There are a <em>lot</em> of possible shades of possible language-level layout guarantees that are less extreme than <code>#[repr(C)]</code>, and there are a <em>lot</em> of possible shades of SemVer stability that might be valuable other than all-or-nothing.</p>
<p>I'm very wary of limiting <code>TransmuteFrom</code> in a way that means its basically only usable at these guarantee and stability extremes. That will close doors for us with other reprs, and it will mean that safe transmute isn't available in cases with an all-or-nothing SemVer guarantee about layout is prohibitive.</p>



<a name="216918789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216918789" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216918789">(Nov 16 2020 at 19:23)</a>:</h4>
<p>Honestly, it should just <em>be fine</em> for you to sometimes get garbage nonsense</p>



<a name="216920499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216920499" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216920499">(Nov 16 2020 at 19:37)</a>:</h4>
<p>If we separate stability from safety, as the constructability-aware version of the RFC did, these problems do not arise: we don't need to have very subtle discussions about <code>Muckable</code>'s implications, we don't risk limiting ourselves in the future with other reprs if it turns out we got <code>Muckable</code> wrong, and we don't limit ourselves in the present by imposing a semver stability system that isn't applicable in some situations.</p>
<p>There were some concerns about whether the constructability-aware version is sound, but the discussion on the <em>Type Privacy &amp; Safety</em> topic <a href="#narrow/stream/216762-project-safe-transmute/topic/Type.20Privacy.20.26.20Safety/near/216805918">suggests</a> that the (existing) mechanism that underlies it can be soundly relied on. If the remaining concerns about it are primarily aesthetic, we should weigh those aesthetic cost against the expressive cost of the alternative.</p>



<a name="216923136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216923136" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216923136">(Nov 16 2020 at 19:59)</a>:</h4>
<p>I think it'll be very hard to find a one-size-fits all solution to stability:</p>
<ul>
<li>what sort of stability you value varies widely by use-case</li>
<li>we're unlikely to identify all present use-cases in which a stability system is inadequate</li>
<li>we're unlikely to identify all future use-cases in which a stability system might become inadequate (e.g., through new layout guarantees on other reprs)</li>
</ul>
<p>If transmutation stability and safety are entangled (as is the case for <code>Muckable</code>), all of those use cases in which our stability system is inadequate will be use-cases in which we cannot provide safe transmutation. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="216933201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216933201" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216933201">(Nov 16 2020 at 21:14)</a>:</h4>
<p>Would it be any more involved that just removing the stability part from <code>Muckable</code>?</p>



<a name="216933723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216933723" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216933723">(Nov 16 2020 at 21:19)</a>:</h4>
<p>I certainly wouldn't object to 1) removing the stability parts of <code>Muckable</code>, 2) clearly documenting the "wrapper" pattern that allows having a "private" <code>impl Muckable</code> within a crate, and 3) supporting the development of a <code>private impl</code> mechanism to avoid having to use that wrapper pattern.</p>



<a name="216933738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216933738" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216933738">(Nov 16 2020 at 21:19)</a>:</h4>
<p>I think that'd be a much simpler model.</p>



<a name="216933931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216933931" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216933931">(Nov 16 2020 at 21:21)</a>:</h4>
<p>Trying to encode stability in the type system seems painful, compared to the more orthogonal approach of extending encapsulation to cover traits (and providing a workaround until we do).</p>



<a name="216935903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216935903" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216935903">(Nov 16 2020 at 21:37)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> what do you mean by "extending encapsulation to cover traits"?</p>



<a name="216972612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/216972612" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#216972612">(Nov 17 2020 at 07:23)</a>:</h4>
<p>I mean that today we don't allow private impls, which means that traits break encapsulation in a way. We should fix that if we can.</p>



<a name="217010248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217010248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217010248">(Nov 17 2020 at 14:38)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> we already did! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> Type Privacy provides a compiler-enforced mechanism of implementation privacy.</p>



<a name="217010504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217010504" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217010504">(Nov 17 2020 at 14:40)</a>:</h4>
<p>Trait implementations inherit the minimum visibility of the trait, the implemented type, or their parameters.</p>



<a name="217020714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217020714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217020714">(Nov 17 2020 at 15:52)</a>:</h4>
<p>I would assume Josh is talking about a more direct implementation that doesn't require extra <code>Scope</code> parameters everywhere. Especially since that was the main objection anyway ("reimplementing the visibility system in the trait system")- type privacy only talks about impls insofar as it helps accomplish its goal of making private types actually private.</p>



<a name="217020964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217020964" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217020964">(Nov 17 2020 at 15:53)</a>:</h4>
<p>The type privacy RFC focuses significantly on ensuring that private implementations cannot be used. (E.g., even if you infer access to a private type, you can't use its <code>From</code> implementation.)</p>



<a name="217044986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217044986" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217044986">(Nov 17 2020 at 18:43)</a>:</h4>
<p>Sorry, silly question: Can you link the "type privacy RFC"?</p>



<a name="217045080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217045080" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217045080">(Nov 17 2020 at 18:43)</a>:</h4>
<p>Sure! <a href="https://github.com/rust-lang/rfcs/pull/2145">https://github.com/rust-lang/rfcs/pull/2145</a></p>



<a name="217046726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217046726" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217046726">(Nov 17 2020 at 18:58)</a>:</h4>
<p>Ah, the "statically anonymized" bit is what I was missing.  I'm confused by the "or usual generics" part, though, since it seems like that'd re-open the "Now foreign code can freely define functions like" thing that was just described as a problem.</p>



<a name="217047996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217047996" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217047996">(Nov 17 2020 at 19:08)</a>:</h4>
<p>I'm pretty sure that by "usual generics", the RFC is referring to a situation like <code>From</code>/<code>Into</code>. If you define a private implementation of <code>From</code>; i.e., either:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Private</span><span class="p">;</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Public</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">Private</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Public</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">Public</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Private</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>...then <em>you</em> can still take advantage of the blanket impl on <code>Into</code> provided by libcore. For instance, if a third-party crate defines a function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_convertible</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nb">Into</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p><em>you</em> can call that function with <code>Public</code> and <code>Private</code> <em>even though the implementations of <code>From</code> for those types is private from the perspective of libcore</em> (where the blanket impl of <code>Into</code> is defined generically in terms of <code>From</code>).</p>



<a name="217049202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217049202" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217049202">(Nov 17 2020 at 19:18)</a>:</h4>
<p>Ah, so if _I_ call <code>fn require_trait_value&lt;T: Trait&gt;(arg: T) { ... }</code> then it can use it via that <code>T</code>, but they can't do it if they grabbed the type through some other jiggery-pokery?</p>



<a name="217049419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217049419" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217049419">(Nov 17 2020 at 19:20)</a>:</h4>
<p>Feels like that still allows it to leak if something you're calling bounds by different traits than expected.  And I don't know what it means for specialization...</p>



<a name="217049915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217049915" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217049915">(Nov 17 2020 at 19:24)</a>:</h4>
<p>My understanding is: Whether or not that function is invocable depends on a reachability-based analysis of the visibility of <code>T: Trait</code> from the point where <code>require_trait_value</code> is invoked with a concrete <code>T</code>.</p>



<a name="217050143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217050143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217050143">(Nov 17 2020 at 19:26)</a>:</h4>
<p>Providing these sorts of protections was a <a href="https://internals.rust-lang.org/t/lang-team-minutes-private-in-public-rules/4504">major motivation of type privacy</a> and its enforcement is <a href="#narrow/stream/216762-project-safe-transmute/topic/Type.20Privacy.20.26.20Safety/near/216805918">already relied upon to be airtight</a>.</p>



<a name="217056066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056066" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056066">(Nov 17 2020 at 20:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217020964">said</a>:</p>
<blockquote>
<p>The type privacy RFC focuses significantly on ensuring that private implementations cannot be used. (E.g., even if you infer access to a private type, you can't use its <code>From</code> implementation.)</p>
</blockquote>
<p>Sure, but that doesn't change anything about its <em>intent</em> (or aesthetics, as you put it elsewhere). Regardless of how airtight and/or relied-upon this kind of impl visibility is, it exists solely in service of its primary goal of <em>type</em> privacy.</p>



<a name="217056316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056316" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056316">(Nov 17 2020 at 20:15)</a>:</h4>
<p>From the <a href="https://internals.rust-lang.org/t/lang-team-minutes-private-in-public-rules/4504">internals discussion</a></p>
<blockquote>
<p>Their intention is to ensure that if you have a private struct, then nobody outside of the module can get their hands on an instance of that struct, and nor can they name the type. <strong>This implies that methods defined on that private struct (including methods from public traits like Clone which don’t have privacy protections) cannot be invoked except for within the module that defined it. This is a useful guarantee for unsafe code.</strong></p>
</blockquote>
<p>(emphasis mine)</p>



<a name="217056329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056329" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056329">(Nov 17 2020 at 20:15)</a>:</h4>
<p>I.e., currently the only way to mark an impl as private is to involve a private <em>type</em>, like <code>Scope</code>.</p>



<a name="217056363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056363" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056363">(Nov 17 2020 at 20:15)</a>:</h4>
<p>I really don't understand what point you're trying to make <span aria-label="oh no" class="emoji emoji-1f615" role="img" title="oh no">:oh_no:</span></p>



<a name="217056448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056448" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056448">(Nov 17 2020 at 20:16)</a>:</h4>
<p>You can rely on type privacy to ensure that trait implementations involving private types are private, too.</p>



<a name="217056483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056483" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056483">(Nov 17 2020 at 20:16)</a>:</h4>
<p>Yes? How does that change anything about what I'm saying (about what I assume Josh meant)?</p>



<a name="217056595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056595" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056595">(Nov 17 2020 at 20:17)</a>:</h4>
<p>Sorry, I thought you were saying that private impls were an accidental consequence of type privacy, since it's called "type privacy" and not "trait privacy". Whereas, in actuality, private impls were an underlying motivation.</p>



<a name="217056713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056713" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056713">(Nov 17 2020 at 20:18)</a>:</h4>
<p>I'm saying that private impls were made possible entirely in service of <em>type</em> privacy, and so may not be very fun to use when <em>your</em> primary goal is to hide an impl on a public type.</p>



<a name="217056732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056732" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056732">(Nov 17 2020 at 20:18)</a>:</h4>
<p>I don't know if your interpretation of <span class="user-mention" data-user-id="239881">@Josh Triplett</span>'s comment is correct.</p>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/216972612">said</a>:</p>
<blockquote>
<p>I mean that today we don't allow private impls, which means that traits break encapsulation in a way. We should fix that if we can.</p>
</blockquote>
<p>We <em>do</em> have private impls, traits don't break encapsulation, and this was fixed three years ago.</p>



<a name="217056787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056787">(Nov 17 2020 at 20:19)</a>:</h4>
<p>But you can't write <code>pub(self) impl ...</code>. That's all I'm taking that as.</p>



<a name="217056892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056892" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056892">(Nov 17 2020 at 20:20)</a>:</h4>
<p>Sure. That's not at issue here, though. In the original RFC, the end-user is never writing anything where <code>pub(self) impl</code> would be useful. The compiler is.</p>



<a name="217056920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217056920" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217056920">(Nov 17 2020 at 20:20)</a>:</h4>
<p>That doesn't make it any less weird or unidiomatic.</p>



<a name="217057025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057025" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057025">(Nov 17 2020 at 20:21)</a>:</h4>
<p>My goal isn't to define the funnest API. It's to define an API that automatically exposes a sound and complete analysis of transmutation safety.</p>



<a name="217057140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057140" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057140">(Nov 17 2020 at 20:22)</a>:</h4>
<p>And my (and presumably Josh's) goal is to expose that analysis in a way that fits with the rest of the language.</p>



<a name="217057166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057166" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057166">(Nov 17 2020 at 20:22)</a>:</h4>
<p>Ultimately, "weird" is an aesthetic criticism. The mechanics that underlie the constructability-aware proposal are sound, and <em>already a part of the language</em>.</p>



<a name="217057209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057209" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057209">(Nov 17 2020 at 20:23)</a>:</h4>
<p>Language design is deeply aesthetic.</p>



<a name="217057263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057263" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057263">(Nov 17 2020 at 20:23)</a>:</h4>
<p>They're only part of the language if you are talking about the <code>Scope</code>/<code>Here!()</code> mechanism, which was rejected for purely "aesthetic" reasons.</p>



<a name="217057394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057394" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057394">(Nov 17 2020 at 20:24)</a>:</h4>
<p>No, impl privacy is <em>already</em> a part of the language! <a href="https://github.com/rust-lang/rfcs/pull/2145#issuecomment-727232373">https://github.com/rust-lang/rfcs/pull/2145#issuecomment-727232373</a></p>



<a name="217057440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057440" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057440">(Nov 17 2020 at 20:24)</a>:</h4>
<p>(BTW, <code>Here!()</code> is <em>only</em> for ergonomics. The RFC works without it.)</p>



<a name="217057493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057493" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057493">(Nov 17 2020 at 20:25)</a>:</h4>
<p>You can't make an impl private without a private type...</p>



<a name="217057542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057542" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057542">(Nov 17 2020 at 20:25)</a>:</h4>
<p>I feel like you are really talking past me, I fully agree that impl privacy is part of the language in a technical sense.</p>



<a name="217057689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057689" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057689">(Nov 17 2020 at 20:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="117495">rpjohnst</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217057493">said</a>:</p>
<blockquote>
<p>You can't make an impl private without a private type...</p>
</blockquote>
<p>...which is why <code>Here!()</code> generates a private type.</p>



<a name="217057715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057715" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057715">(Nov 17 2020 at 20:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="117495">rpjohnst</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217057542">said</a>:</p>
<blockquote>
<p>I feel like you are really talking past me, I fully agree that impl privacy is part of the language in a technical sense.</p>
</blockquote>
<p>Then, to reiterate my earlier point:</p>
<blockquote>
<p>If the remaining concerns about it are primarily aesthetic, we should weigh those aesthetic cost against the expressive cost of the alternative.</p>
</blockquote>



<a name="217057732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057732" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057732">(Nov 17 2020 at 20:27)</a>:</h4>
<p>I'm not arguing that language design <em>isn't</em> aesthetic.</p>



<a name="217057779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057779" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057779">(Nov 17 2020 at 20:27)</a>:</h4>
<p>Is that (weighing the costs) not what we are already doing?</p>



<a name="217057853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057853" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057853">(Nov 17 2020 at 20:28)</a>:</h4>
<p>The only reason I said anything at all was that it seemed Josh was suggesting that <em>directly</em> private impls might make the aesthetic cost less.</p>



<a name="217057876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057876" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057876">(Nov 17 2020 at 20:28)</a>:</h4>
<p>And thus perhaps worth pursuing in the future.</p>



<a name="217057965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217057965" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217057965">(Nov 17 2020 at 20:29)</a>:</h4>
<p>And that, in the meantime, the newtype pattern has a lesser aesthetic cost than the <code>Scope</code>/<code>Here!()</code> pattern.</p>



<a name="217058009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058009" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058009">(Nov 17 2020 at 20:29)</a>:</h4>
<p>(To be clear- personally I agree with that as well, but it's not what I was trying to get at.)</p>



<a name="217058089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058089" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058089">(Nov 17 2020 at 20:30)</a>:</h4>
<p>Yeah, that wasn't my reading of Josh's comment about "traits breaking encapsulation"; I assumed he had technical questions.</p>



<a name="217058175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058175" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058175">(Nov 17 2020 at 20:30)</a>:</h4>
<p>I think all that means is "if you just impl a trait on a public type with no other shenanigans, it is automatically public across the entire universe." Which feels a lot like "breaking encapsulation" even if it's technically fine and intentional.</p>



<a name="217058253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058253" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058253">(Nov 17 2020 at 20:31)</a>:</h4>
<p>And further, even if you implement it on a private type, that does not prevent external generic code from working with that private type, if passed the private type from within its module.</p>



<a name="217058336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058336" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058336">(Nov 17 2020 at 20:32)</a>:</h4>
<p>I think you and I are on the same page.</p>



<a name="217058357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058357" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058357">(Nov 17 2020 at 20:32)</a>:</h4>
<p>Which is a sense in which an actual, direct, <code>priv impl</code> might potentially want to differ from existing type privacy.</p>



<a name="217058512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217058512" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217058512">(Nov 17 2020 at 20:34)</a>:</h4>
<p>(And that feels like the direction Scott was pointing.)</p>



<a name="217059400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217059400" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217059400">(Nov 17 2020 at 20:40)</a>:</h4>
<p>It's very possible that the effects of a <code>priv impl</code> syntax might differ from type privacy. (Whether or not that's the case is totally speculation—there are deep questions about how that syntax would integrate into the language.)</p>
<p>However, in the case of safe transmutation, the semantics of type privacy match what we need. Type privacy enforces that impls are only usability if they are visible with respect to the reference point that the impl is being used in.</p>
<p>Likewise, a transmutation is safe if the relevant fields of the involved type are visible with respect to the reference point the transmutation is occuring in. The constructability-aware version introduces a private type that encodes the reference point of the transmutation—thus leveraging the existing mechanism of type privacy.</p>



<a name="217059503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217059503" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217059503">(Nov 17 2020 at 20:41)</a>:</h4>
<p>A <code>priv impl</code> syntax does <em>not</em> improve the ergonomics of a constructability-aware <code>TransmuteFrom</code>, because end users are never <em>implementing</em> <code>TransmuteFrom</code>. Implementations of this trait are generated on-the-fly by the compiler.</p>



<a name="217059903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217059903" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217059903">(Nov 17 2020 at 20:44)</a>:</h4>
<p>A <code>priv impl</code> syntax <em>does</em> improve the ergonomics of <code>Muckable</code>, but not the expressivity issues, nor does it eliminate the footgun imposed by a trait that indicates "you can ignore field encapsulation for this type".</p>



<a name="217063630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063630" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063630">(Nov 17 2020 at 21:13)</a>:</h4>
<p>Following up, because I wasn't around for much of the discussion of my original comment...</p>



<a name="217063695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063695" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063695">(Nov 17 2020 at 21:14)</a>:</h4>
<p>Yes, I know that it's possible to use a newtype wrapper around a private type to hide impls.</p>



<a name="217063707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063707" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063707">(Nov 17 2020 at 21:14)</a>:</h4>
<p>That doesn't mean "the language has private impls".</p>



<a name="217063741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063741" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063741">(Nov 17 2020 at 21:14)</a>:</h4>
<p>Er, it's a technical term from the Type Privacy RFC. It's not just about newtypes.</p>



<a name="217063751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063751" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063751">(Nov 17 2020 at 21:14)</a>:</h4>
<p>It means "it's possible to work around the shortcoming that you can't have private impls for a public type".</p>



<a name="217063860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063860" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063860">(Nov 17 2020 at 21:15)</a>:</h4>
<p>My original point was that I think it <em>should</em> be possible to have private impls for a public type, in the most straightforward way possible, without any kind of wrapper or private internal type.</p>



<a name="217063963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217063963" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217063963">(Nov 17 2020 at 21:16)</a>:</h4>
<p>Ideally it'd be as simple as <code>pub(self) impl Trait for Type</code>.</p>



<a name="217064008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064008" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064008">(Nov 17 2020 at 21:16)</a>:</h4>
<p>Gotcha! Yeah, that would be great! It's not quite helpful to <code>TransmuteFrom</code>, since end-users don't write impls of <code>TransmuteFrom</code>.</p>



<a name="217064026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064026">(Nov 17 2020 at 21:16)</a>:</h4>
<p>(<em>Ideally</em> we eventually require <code>pub impl Trait for Type</code> and make <code>impl Trait for Type</code> private, to avoid a special "public by default" case, but that's a much bigger transition.)</p>



<a name="217064093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064093" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064093">(Nov 17 2020 at 21:17)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> It's helpful for safe transmute insofar as someone might want <code>pub(crate) impl Muckable for Type</code>, as in "I can safe transmute to and from this type because I'm the crate that owns it, but I don't want other crates doing so".</p>



<a name="217064191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064191" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064191">(Nov 17 2020 at 21:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217064008">said</a>:</p>
<blockquote>
<p>Gotcha! Yeah, that would be great! It's not quite helpful to <code>TransmuteFrom</code>, since end-users don't write impls of <code>TransmuteFrom</code>.</p>
</blockquote>
<p>I imagine having it implemented might put compiler-generated private impls on more solid ground, though.</p>



<a name="217064195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064195" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064195">(Nov 17 2020 at 21:18)</a>:</h4>
<p>Yep. That's an ergonomic improvement over wrapping your type's private innards in a newtype.</p>



<a name="217064374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064374" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064374">(Nov 17 2020 at 21:19)</a>:</h4>
<p>It doesn't improve the expressivity issues, though.</p>



<a name="217064863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217064863" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217064863">(Nov 17 2020 at 21:22)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> Suppose you have a crate that, today, has a public type with some (but not all) public fields, but for which you don't want to make all the guarantees of <code>Muckable</code>. You internally use unsafe transmute on that type to implement some things. You'd like to eliminate unsafe by using safe transmute. How would you go about doing that, without allowing code outside your crate to use <code>Muckable</code>? The "newtype wrapper" pattern doesn't work here, because parts of your type are public.</p>



<a name="217065016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065016" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065016">(Nov 17 2020 at 21:23)</a>:</h4>
<p>I stand corrected!</p>



<a name="217065093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065093" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065093">(Nov 17 2020 at 21:24)</a>:</h4>
<p>That wasn't an expressivity issue anyone had pointed out yet. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="217065216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065216" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065216">(Nov 17 2020 at 21:25)</a>:</h4>
<p>Depending on the compiler's guarantees or non-guarantees, would it be possible to do <code>struct InternalWrapper(PublicType); unsafe impl Muckable for InternalWrapper {}</code>?</p>



<a name="217065247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065247" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065247">(Nov 17 2020 at 21:25)</a>:</h4>
<p>And then if you want to safe-transmute, you wrap the type in InternalWrapper first?</p>



<a name="217065317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065317" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065317">(Nov 17 2020 at 21:26)</a>:</h4>
<p>Yes, if we lifted the requirement that types are recursively muckable (a la <code>Copy</code>), which is required to make <code>Muckable</code> safe.</p>



<a name="217065618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065618" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065618">(Nov 17 2020 at 21:29)</a>:</h4>
<p>Doesn't really solve the problem, in any case, since it wouldn't let you forbid unsafe in your crate.</p>



<a name="217065688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217065688" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217065688">(Nov 17 2020 at 21:29)</a>:</h4>
<p>So yeah, private impls seem necessary for full expressiveness. But safe transmute is still quite useful without that.</p>



<a name="217066689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217066689" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217066689">(Nov 17 2020 at 21:38)</a>:</h4>
<p>We don't need to wait on <code>priv impl</code> for full expressivity. The constructability-aware formulation of <code>TransmuteFrom</code> is safe, expressive, and completely automatic. It's not subject to the thorny design considerations of what, exactly, <code>Muckable</code> must denote, or the expressive and ergonomic limitations it imposes, because <code>Muckable</code> doesn't exist. It's not subject to the potential user error of when <code>Muckable</code> should be implemented, because the safety of the system doesn't depend on manual user intervention.</p>
<p>The cost of this formulation is an extra type parameter. However, if somebody someday figures out a sound, <em>implicit</em> mechanism for scoped impls (as has been suggested here), that parameter can perhaps be defaulted.</p>



<a name="217069919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217069919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217069919">(Nov 17 2020 at 22:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217066689">said</a>:</p>
<blockquote>
<p>The cost of this formulation is an extra type parameter. However, if somebody someday figures out a sound, <em>implicit</em> mechanism for scoped impls (as has been suggested here), that parameter can perhaps be defaulted.</p>
</blockquote>
<p>The cost is more than an extra type parameter! It's a whole new design pattern that lifts the visibility system into the trait system, and then introduces and exploits a hole in that system.</p>



<a name="217070109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217070109" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217070109">(Nov 17 2020 at 22:08)</a>:</h4>
<p>What's the hole being introduced and exploited?</p>



<a name="217070382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217070382" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217070382">(Nov 17 2020 at 22:10)</a>:</h4>
<p><code>NeglectStability</code>. I have yet to see a private impl-based formulation that does not also introduce a way to bypass that privacy.</p>



<a name="217070675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217070675" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217070675">(Nov 17 2020 at 22:12)</a>:</h4>
<p><code>NeglectStability</code> is not essential to the original RFC. If that's your primary concern, consider it cut.</p>
<p>We're also at the point where <code>Muckable</code> will cary no stability implications.</p>



<a name="217070803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217070803" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217070803">(Nov 17 2020 at 22:13)</a>:</h4>
<p>Am I misunderstanding the original RFC? I was under the impression that it relied on <code>NeglectStability</code> to address some use cases.</p>



<a name="217071045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217071045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217071045">(Nov 17 2020 at 22:15)</a>:</h4>
<p>Including the archetype pattern</p>



<a name="217071322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217071322" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217071322">(Nov 17 2020 at 22:18)</a>:</h4>
<p>Er, sorry. It was used in the <em>original</em> RFC to accomodate the stability system. Then, that stability system was removed, and with it the need for <code>NeglectStability</code>.</p>
<p>Then, that version of the RFC was replaced by one introducing <code>Muckable</code>, which carried both safety and stability implications. Then, we discovered that those stability implications were overly restrictive. I've yet to update the RFC, but the conversation that occured here yesterday points to <code>Muckable</code> <em>not</em> carrying any semver connotations.</p>
<p>The current situation is thus this: we hope to provide a <code>TransmuteFrom</code> trait that soundly and completely tells you whether a transmutation is safe.</p>



<a name="217071405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217071405" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217071405">(Nov 17 2020 at 22:18)</a>:</h4>
<p>So: no more <code>NelectStability</code> and no more stability (at least for now).</p>



<a name="217073111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217073111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217073111">(Nov 17 2020 at 22:37)</a>:</h4>
<p>If <code>Muckable</code> doesn't need to carry any semver connotations, then the case I mentioned may not be an issue.</p>



<a name="217073173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217073173" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217073173">(Nov 17 2020 at 22:38)</a>:</h4>
<p>What do you mean about "an extra type parameter"?</p>



<a name="217074721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217074721" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217074721">(Nov 17 2020 at 22:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217073173">said</a>:</p>
<blockquote>
<p>What do you mean about "an extra type parameter"?</p>
</blockquote>
<p>An earlier version of the RFC used a <code>Scope</code> type parameter to emulate <code>pub(self) impl</code>- if you saw anything about <code>Here!()</code> that was what that was all about.</p>



<a name="217074790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217074790" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217074790">(Nov 17 2020 at 22:55)</a>:</h4>
<p>A type is safely <code>TransmuteFrom</code> another type if such a transmutation is well-defined (per their layouts) and the appropriate fields are visible. The question is: <em>visible from where</em>?</p>
<p>If we formulate <code>TransmuteFrom</code> like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Dst</span>: <span class="nc">TransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>the reference frame from which we're considering the visibility of <code>Src</code> and <code>Dst</code>'s fields is unclear. We <em>mean</em> to use the scope of wherever we wrote that bound as our reference frame, but there's nothing here the compiler can use to sus that out. It does quite the opposite: it assumes that if it's proven <code>Dst: TransmuteFrom&lt;Src&gt;</code> once, it's proven it everywhere.</p>
<p>So, we add an additional type parameter to <code>TransmuteFrom</code> that encodes this information:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">     </span><span class="n">Dst</span>: <span class="nc">TransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Scope</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>...where <code>Scope</code> is a <em>private</em> type.</p>
<p>To determine whether <code>Dst: TransmuteFrom&lt;Src, Scope&gt;</code>, the compiler both:</p>
<ol>
<li>confirms that the layout of <code>Src</code> is soundly transmutable into the layout of <code>Dst</code></li>
<li>confirms that the appropriate fields of <code>Dst</code> (and sometimes <code>Src</code>) are visible from the defining scope of whatever concrete type is provided by <code>Scope</code>.</li>
</ol>
<p>The RFC suggests providing a <code>Here!()</code> macro that expands to a private type which uniquely identifies its invocation scope—so you don't need to go through the rigamarole of writing <code>struct Here;</code> whenever you transmute two concrete types.</p>
<p>Type Privacy does the work of ensuring this mechanism is foolproof. You cannot "leak" a private type in a way that would provide access to the private impl of <code>TransmuteFrom</code>.</p>



<a name="217074896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217074896" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217074896">(Nov 17 2020 at 22:56)</a>:</h4>
<p>So at this point I've seen at least three different workarounds for a lack of <code>pub(self) impl</code>- there's the newtype approach you mentioned above (<code>struct InternalWrapper(PublicType);</code>), another newtype approach suggested by boats in the RFC thread (<code>struct PublicType(InternalTypeImplementingMuckable);</code>), and the <code>Scope</code>/<code>Here!()</code> approach.</p>



<a name="217074979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217074979" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217074979">(Nov 17 2020 at 22:57)</a>:</h4>
<p><code>Scope</code>+<code>Here!()</code> isn't a workaround for <code>pub(self) impl</code>, since end-users aren't writing impls of <code>TransmuteFrom</code>.</p>



<a name="217075066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217075066" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217075066">(Nov 17 2020 at 22:58)</a>:</h4>
<p>I mean, it kind of is- it's a way to control which scopes <code>TransmuteFrom</code> works in, no?</p>



<a name="217075127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217075127" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217075127">(Nov 17 2020 at 22:59)</a>:</h4>
<p>Doesn't really matter who would be writing (or generating) the <code>impl</code> block, the point is how the client determines if it's allowed to use that impl.</p>



<a name="217075693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217075693" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217075693">(Nov 17 2020 at 23:05)</a>:</h4>
<p>Gotchya. Yes, in that sense it's perhaps related. Whether it's a <em>replacement</em> will depend on the whatever shape that RFC ultimately takes. My hunch is that a "hidden impls" RFC will make some crucial compromises.</p>



<a name="217075966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217075966" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217075966">(Nov 17 2020 at 23:08)</a>:</h4>
<p>Indeed- personally I would rather avoid hidden impls entirely, and rely on the <code>struct PublicNewtype(PrivateTransmutable)</code> pattern, since a) that's already in active use in the ecosystem and b) there seems to be a clearer path forward toward cleaning up some of its associated boilerplate ("delegation").</p>



<a name="217076077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076077" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076077">(Nov 17 2020 at 23:09)</a>:</h4>
<p>The compiler could generate <code>TransmuteFrom</code> impls without any regard for scope, but only in response to a user request, and then the existing visibility of the impl type would control the visibility of those impls.</p>



<a name="217076234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076234" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076234">(Nov 17 2020 at 23:11)</a>:</h4>
<p>I think we've mostly settled the design point that don't want type authors to have to opt-in for a third party to pose questions about the well-definedness (and <em>hopefully</em> safety) of transmuting that type from/to another type.</p>



<a name="217076421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076421" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076421">(Nov 17 2020 at 23:14)</a>:</h4>
<p>Eh? Type authors need to opt in or else we're throwing visibility (and thus semver/stability) out the window. Or am I misunderstanding?</p>



<a name="217076435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076435" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076435">(Nov 17 2020 at 23:14)</a>:</h4>
<p>We're throwing semver stability out the window.</p>



<a name="217076442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076442" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076442">(Nov 17 2020 at 23:14)</a>:</h4>
<p>Sounds bad :P</p>



<a name="217076464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076464" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076464">(Nov 17 2020 at 23:14)</a>:</h4>
<p>The trait might very well be called <code>UnstableTransmuteFrom</code>.</p>



<a name="217076465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076465" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076465">(Nov 17 2020 at 23:14)</a>:</h4>
<p>That's the whole thing I've been complaining about with <code>NeglectStability</code>.</p>



<a name="217076635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076635" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076635">(Nov 17 2020 at 23:16)</a>:</h4>
<p>Flips the entire trait system on its head- if types start implementing internals-exposing traits without their authors' opt in, <em>even</em> if that trait is "wait please don't use this except in ways documented by the author," then we're opening a big can of worms. :/</p>



<a name="217076681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076681" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076681">(Nov 17 2020 at 23:16)</a>:</h4>
<p>Yep. This would be be <strong>loudly</strong> documented.</p>



<a name="217076800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076800" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076800">(Nov 17 2020 at 23:18)</a>:</h4>
<p>I don't feel like any amount of documentation would be sufficient here. :P</p>



<a name="217076891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076891" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076891">(Nov 17 2020 at 23:19)</a>:</h4>
<p>This was the whole reason boats brought up the newtype pattern to begin with- it preserves the visibility system without using any new patterns or language features.</p>



<a name="217076905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076905" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076905">(Nov 17 2020 at 23:19)</a>:</h4>
<p>We don't see a way to define a one-size-fits-all stability system. The kinds of layout stability guarantees that matter vary <em>wildly</em> between use-cases.</p>



<a name="217076995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217076995" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217076995">(Nov 17 2020 at 23:20)</a>:</h4>
<p>From where I stand, the problem is the whole idea of a "stability system" beyond what the language already offers and is already used.</p>



<a name="217077097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077097" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077097">(Nov 17 2020 at 23:21)</a>:</h4>
<p>I liked the idea of the archetype pattern- that seemed to address the layout stability guarantees simply by reusing the set of things already considered (un)stable about <code>#[repr(C)]</code> types.</p>



<a name="217077190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077190" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077190">(Nov 17 2020 at 23:22)</a>:</h4>
<p>But you may be right- and if it comes down to it, at the end of the day, I would prefer a vastly smaller "safe transmute" feature that preserves visibility, to a more flexible one that breaks it.</p>



<a name="217077238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077238" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077238">(Nov 17 2020 at 23:22)</a>:</h4>
<p>So, a couple of things...</p>



<a name="217077288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077288">(Nov 17 2020 at 23:23)</a>:</h4>
<p>First, the second type parameter and <code>Here!()</code> was a substantial point of concern in the lang team about the previous version of the proposal, and everyone strongly prefers the new simpler version.</p>



<a name="217077319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077319" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077319">(Nov 17 2020 at 23:23)</a>:</h4>
<p>Going back to that version doesn't seem like an advancement.</p>



<a name="217077395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077395">(Nov 17 2020 at 23:24)</a>:</h4>
<p>Second, I don't think this kind of opt-in seems like a problem.</p>



<a name="217077443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077443" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077443">(Nov 17 2020 at 23:25)</a>:</h4>
<p>Naming and related bikeshedding aside, the idea of <code>impl Muckable for Type</code> to opt into being able to safe-transmute seems great. And if people want to hide that inside their crate, they can either use the newtype-wrapper pattern with a private type, or wait for private impls.</p>



<a name="217077468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077468" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077468">(Nov 17 2020 at 23:25)</a>:</h4>
<p>We should clearly document what you're promising with a public impl of <code>Muckable</code>, but that's still reasonable.</p>



<a name="217077548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077548">(Nov 17 2020 at 23:26)</a>:</h4>
<p>To clarify: I'm assuming that <code>Muckable</code> would be a necessary but not sufficient condition for <code>TransmuteFrom</code>, and the compiler-generated stuff would do the actual handling of "are these two types compatible".</p>



<a name="217077560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217077560" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217077560">(Nov 17 2020 at 23:26)</a>:</h4>
<p><code>Muckable</code> would be the opt-in for "I don't mind having my type synthesized out of a transmute".</p>



<a name="217078443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217078443" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217078443">(Nov 17 2020 at 23:38)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>  Just to confirm that we're on the same page.</p>
<p>These are the shortcomings that <code>Muckable</code> and the constructability-aware version share:</p>
<ul>
<li><code>TransmuteFrom</code> is SemVer unstable</li>
</ul>
<p>These are the additional shortcomings of the <code>Muckable</code> approach:</p>
<ul>
<li>The safety of the system depends on the user's judgement of when to implement <code>Muckable</code> or not. A user must now reason about the visibility of their type, the visibility of its fields, <em>and</em> the appropriateness of implementing <code>Muckable</code>. Getting any of these wrong can lead to unsafety.</li>
<li><code>Muckable</code> is <em>also</em> not subject to SemVer guarantees.</li>
<li>To make a type with private fields privately safely transmutable, you need newtype its innards. This constitutes a significant refactoring of modules that are likely to <em>already</em> have unsafe code.</li>
<li><code>Muckable</code> is all-or-nothing, and thus is inapplicable for transmutations of partially constructible types.</li>
<li>All cases in which <code>Muckable</code> is insufficient reflects a case where we cannot provide safe transmute.</li>
</ul>



<a name="217078869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217078869" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217078869">(Nov 17 2020 at 23:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217078443">said</a>:</p>
<blockquote>
<ul>
<li><code>Muckable</code> is <em>also</em> not subject to SemVer guarantees.</li>
</ul>
</blockquote>
<p>Why not? If you implement <code>Muckable</code>, you are marking transmutes as public (if the type is public), and thus changes that could break transmuting clients need a major version bump. That's how trait impls work, <em>including</em> auto traits.</p>



<a name="217079011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079011">(Nov 17 2020 at 23:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217078443">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span>  Just to confirm that we're on the same page about the shortcomings of this approach compared to the constructability-aware version:</p>
<ul>
<li>The safety of the system depends on the user's judgement of when to implement <code>Muckable</code> or not. A user must now reason about the visibility of their type, the visibility of its fields, <em>and</em> the appropriateness of implementing <code>Muckable</code>. Getting any of these wrong can lead to unsafety.</li>
</ul>
</blockquote>
<p>True. You should not publicly implement Muckable on a type for which you'd hesitate to make all fields public, for instance.</p>
<blockquote>
<ul>
<li><code>Muckable</code> is <em>also</em> not subject to SemVer guarantees.</li>
</ul>
</blockquote>
<p>What do you mean by this? We can't <em>guarantee</em> semver compatibility; that's up to the crate. Crates can also delete fields or functions and bump only the patch version, but they shouldn't. The crate needs to take semver into account when choosing whether to impl <code>Muckable</code> for a type.</p>
<blockquote>
<ul>
<li>To make a type with private fields privately safely transmutable, you need newtype its innards. This constitutes a significant refactoring of modules that are likely to <em>already</em> have unsafe code.</li>
</ul>
</blockquote>
<p>True, though we could fix that if Rust supported <code>pub(self) impl</code>.</p>
<blockquote>
<ul>
<li><code>Muckable</code> is all-or-nothing, and thus is inapplicable for transmutations of partially constructible types.</li>
</ul>
</blockquote>
<p>Are you referring to the case of a public prefix you want to extract/construct?</p>
<blockquote>
<ul>
<li>All cases in which <code>Muckable</code> is insufficient reflects a case where we cannot provide safe transmute.</li>
</ul>
</blockquote>
<p>For now. We could extend the mechanism in the future to handle other cases.</p>



<a name="217079167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079167">(Nov 17 2020 at 23:49)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>, do you foresee that implementing <code>Muckable</code> implies that if <code>Dst: TransmuteFrom&lt;Src&gt;</code> holds in some set of crate versions, that it should also hold in subsequent minor releases of the involved crates?</p>



<a name="217079390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079390" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079390">(Nov 17 2020 at 23:52)</a>:</h4>
<p>I believe so, yes.</p>



<a name="217079437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079437" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079437">(Nov 17 2020 at 23:53)</a>:</h4>
<p>My biggest concern of all the ones you raised above is the "partially constructable" case.</p>



<a name="217079439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079439" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079439">(Nov 17 2020 at 23:53)</a>:</h4>
<p>Then implementing <code>Muckable</code> doesn't <em>only</em> mean that you deem your type safely constructible via transmute, it <em>also</em> means that you promise to treat most changes to its layout as a breaking change.</p>



<a name="217079500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079500" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079500">(Nov 17 2020 at 23:54)</a>:</h4>
<p>That seems like an extremely fair price to pay for transmuting it, IMO</p>



<a name="217079518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079518" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079518">(Nov 17 2020 at 23:54)</a>:</h4>
<p>True. Alternatively, if you don't want that, you could privately implement <code>Muckable</code>and then publicly expose a limited set of operations powered by safe transmute.</p>



<a name="217079555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079555" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079555">(Nov 17 2020 at 23:55)</a>:</h4>
<p>For instance, you might wish to support transmuting to bytes, but not transmuting <em>from</em> bytes without a validation step.</p>



<a name="217079647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079647" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079647">(Nov 17 2020 at 23:56)</a>:</h4>
<p>You might still handle that by using safe transmute internally, but then checking the fields before returning the type.</p>



<a name="217079682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079682" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079682">(Nov 17 2020 at 23:56)</a>:</h4>
<p>I <em>absolutely</em> believe that this will not solve every single case where people want safe transmute, and I believe we'll want to provide more capabilities in the future, but I think it'll solve many problems for many people.</p>



<a name="217079683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079683" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079683">(Nov 17 2020 at 23:56)</a>:</h4>
<p><code>Muckable</code> is a prohibitive stability promise for this sort of type:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">b</span>: <span class="kt">i32</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The type's author may <em>currently</em> add fields to this type without incrementing major versions. They could not if they implemented <code>Muckable</code>.</p>



<a name="217079795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079795">(Nov 17 2020 at 23:58)</a>:</h4>
<p>We might choose to lint against <code>impl Muckable</code> for a type with <code>#[non_exhaustive]</code>. I'd also love to see a solution for the case of structs with public prefixes, or variable sizes.</p>



<a name="217079799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079799" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079799">(Nov 17 2020 at 23:58)</a>:</h4>
<p>For that matter...</p>



<a name="217079815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079815" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079815">(Nov 17 2020 at 23:58)</a>:</h4>
<p>Hypothetically, suppose we had <code>MuckableFrom</code> (you can turn this into things) and <code>MuckableTo</code> (you can turn things into this).</p>



<a name="217079836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217079836" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217079836">(Nov 17 2020 at 23:59)</a>:</h4>
<p>The former wouldn't prevent you from adding fields at the end, only the latter would, right?</p>



<a name="217080037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080037" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080037">(Nov 18 2020 at 00:00)</a>:</h4>
<p><del><code>MuckableFrom</code> does prevent you from adding fields. If you increase the size of the type, you set a lower bound on the size of types it can be transmuted from.</del></p>



<a name="217080050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080050" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080050">(Nov 18 2020 at 00:01)</a>:</h4>
<p>Oh gotcha</p>



<a name="217080065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080065" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080065">(Nov 18 2020 at 00:01)</a>:</h4>
<p>These names don't quite match up with the direction I'd expect.</p>



<a name="217080068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080068" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080068">(Nov 18 2020 at 00:01)</a>:</h4>
<p>Fair point; not looking to bikeshed.</p>



<a name="217080085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080085" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080085">(Nov 18 2020 at 00:01)</a>:</h4>
<p>The descriptions are the key here: if you can turn the type into things, but you can't turn things into the type, you can add fields all you like.</p>



<a name="217080187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080187" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080187">(Nov 18 2020 at 00:03)</a>:</h4>
<p>Given:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">S</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="n">b</span>: <span class="kt">i32</span> <span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">TurnThisIntoThings</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Type</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>You could safe-transmute S into an <code>i32</code>.</p>



<a name="217080231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080231" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080231">(Nov 18 2020 at 00:03)</a>:</h4>
<p>(grumble grumble <code>#[repr(C)]</code> handwave)</p>



<a name="217080238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080238" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080238">(Nov 18 2020 at 00:03)</a>:</h4>
<p>I think this is an improvement.</p>



<a name="217080315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080315" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080315">(Nov 18 2020 at 00:04)</a>:</h4>
<p>I think many more people would be willing to opt their types into <code>TurnThisIntoThings</code>.</p>



<a name="217080325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080325" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080325">(Nov 18 2020 at 00:04)</a>:</h4>
<p>That only guarantees you won't change the public prefix of the type incompatibly.</p>



<a name="217080360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080360" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080360">(Nov 18 2020 at 00:05)</a>:</h4>
<p>And then types <em>designed</em> for byte-based deserialization will opt into <code>TurnThingsIntoThis</code>.</p>



<a name="217080404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080404" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080404">(Nov 18 2020 at 00:05)</a>:</h4>
<p>It's a better stability system than an omnibus <code>Muckable</code>. (but it's still a system that rules out use-cases)</p>



<a name="217080461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080461" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080461">(Nov 18 2020 at 00:06)</a>:</h4>
<p>It certainly doesn't allow everything; I understand that.</p>



<a name="217080476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080476" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080476">(Nov 18 2020 at 00:06)</a>:</h4>
<p>I think it'll be easier for people to wrap their heads around.</p>



<a name="217080490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080490" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080490">(Nov 18 2020 at 00:06)</a>:</h4>
<p>And I <em>think</em> it could be extended in the future.</p>



<a name="217080492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080492" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080492">(Nov 18 2020 at 00:06)</a>:</h4>
<p>So: you can't make changes that would break whether <code>TransmuteFrom</code> is satisfied or not. Are you allowed to re-order fields?</p>



<a name="217080541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080541">(Nov 18 2020 at 00:07)</a>:</h4>
<p>I would expect the answer to that question to be a bit domain-specific- the same way as whether changing the return value of a function is considered breaking.</p>



<a name="217080549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080549" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080549">(Nov 18 2020 at 00:07)</a>:</h4>
<p>Yep. Nonetheless, we have to answer it.</p>



<a name="217080564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080564" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080564">(Nov 18 2020 at 00:07)</a>:</h4>
<p>We <em>haven't</em> answered the equivalent question about function return values, though.</p>



<a name="217080641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080641" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080641">(Nov 18 2020 at 00:08)</a>:</h4>
<p>We do so on a function-by-function basis. Here, we have a trait and we need to settle what its contract is.</p>



<a name="217080651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080651" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080651">(Nov 18 2020 at 00:09)</a>:</h4>
<p>We can describe the general case. Crates may occasionally document exceptions, and that's up to those crates. I've seen crates do things like "the internal functions called by this macro are public because they have to be, but we make no guarantees and may change those at any time". That's <em>technically</em> a semver violation, but that's up to the crate.</p>



<a name="217080684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080684" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080684">(Nov 18 2020 at 00:09)</a>:</h4>
<p>It seems a bit more pressing in this case, since a <code>TransmuteFrom</code> trait is naturally going to lead to people building abstractions over safe transmutation.</p>



<a name="217080766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080766" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080766">(Nov 18 2020 at 00:10)</a>:</h4>
<p>There's a kind of syntax-vs-semantics distinction here, where you can't change what you can transmute to, but it may be domain-specific if you're allowed to interpret the resulting bytes.</p>



<a name="217080838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080838" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080838">(Nov 18 2020 at 00:11)</a>:</h4>
<p>For instance, you can't change <code>struct S { x: i64, y: i64, z: i16 }</code> to <code>struct S { x: i64, z: i16, y: i64 }</code>.</p>



<a name="217080924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080924" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080924">(Nov 18 2020 at 00:12)</a>:</h4>
<p>But you <em>might</em> be able to get away with changing <code>struct S { x: i64, y: i64, z: i16 }</code> to <code>struct S { y: i64, x: i64, z: i16 }</code> depending on the nature of the struct.</p>



<a name="217080951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080951" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080951">(Nov 18 2020 at 00:12)</a>:</h4>
<p>You can't do that if you implement <code>TurnThingsIntoThis</code>.</p>



<a name="217080970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217080970" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217080970">(Nov 18 2020 at 00:13)</a>:</h4>
<p>(Assume all fields are <code>pub</code> in the above. Or for that matter, assume x and y are pub and z isn't; that would also produce a different valid example.)</p>



<a name="217081081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081081" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081081">(Nov 18 2020 at 00:14)</a>:</h4>
<p>The question is whether it's reasonable, given <code>TurnThisIntoThings</code>, to make certain assumptions about the bytes you get out.</p>



<a name="217081096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081096">(Nov 18 2020 at 00:14)</a>:</h4>
<p>I'd say in <em>most</em> cases, no, you can't reorder the fields.</p>



<a name="217081182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081182" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081182">(Nov 18 2020 at 00:15)</a>:</h4>
<p>To be a little more concrete...</p>



<a name="217081288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081288">(Nov 18 2020 at 00:16)</a>:</h4>
<p>Suppose you had something like <code>FirmwareStructure { header: Header, various: [SomeUnion; 8] }</code> (ignore variable-lengths for a moment for the sake of argument).</p>



<a name="217081314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081314" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081314">(Nov 18 2020 at 00:17)</a>:</h4>
<p>Assume all the structures involved can be safely transmuted to bytes.</p>



<a name="217081434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081434" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081434">(Nov 18 2020 at 00:18)</a>:</h4>
<p>A piece of code might come to rely upon, for instance, that in practice the thing constructing that type always has the <code>various</code> in a specific order; for instance, it always puts <code>SomeUnion { console_info: ... }</code> first, before any <code>SomeUnion { serial_number_info: ... }</code>.</p>



<a name="217081446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081446" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081446">(Nov 18 2020 at 00:19)</a>:</h4>
<p>That's not a reasonable assumption, and it might even be documented that you shouldn't do that.</p>



<a name="217081475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081475" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081475">(Nov 18 2020 at 00:19)</a>:</h4>
<p>If you change that by generating <code>various</code> in a different, you may break people relying on your code.</p>



<a name="217081504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081504" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081504">(Nov 18 2020 at 00:19)</a>:</h4>
<p>That might or might not be a semver violation, depending on your documentation and what was reasonable to assume.</p>



<a name="217081585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081585" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081585">(Nov 18 2020 at 00:20)</a>:</h4>
<p>That's all domain-specific.</p>



<a name="217081606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081606" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081606">(Nov 18 2020 at 00:20)</a>:</h4>
<p>The only guarantee is "things you could transmute to before, you can still transmute to".</p>



<a name="217081654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081654" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081654">(Nov 18 2020 at 00:21)</a>:</h4>
<p>You could even have that problem <em>today</em> if you provided a <code>pub to_bytes(s: &amp;FirmwareStructure) -&gt; &amp;[u8]</code>.</p>



<a name="217081899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081899" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081899">(Nov 18 2020 at 00:24)</a>:</h4>
<p>Summarizing: I think we should document that publicly implementing <code>TurnThisIntoThings</code> means you must not change the struct in ways that would prevent it from being transmuted into anything it could be transmuted into before, you should not in general change the offset of any public field, and you may or may not have additional semantic guarantees depending on what your callers expect to be able to assume about the data they get out.</p>



<a name="217081969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217081969" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217081969">(Nov 18 2020 at 00:25)</a>:</h4>
<p>(I'll have to first do some thinking about how <code>Muckable{From,Into}</code> interacts with generics, but I'll definitely come back to this.)</p>
<p><strong>Separately:</strong> <code>#[repr(C)]</code> is a bit of an extreme in terms of language-level layout well-definedness and stability. We could imagine a repr that guarantees the same layout of a type for the same build, or for different builds within the same compiler version. (E.g., perhaps field order is the aspect that is defined to be unstable.) If <code>Dst: TransmuteFrom&lt;Src&gt;</code> is intended to behave semver-stably, I don't see how it could be used to judge the safety/stability of such transmutations.</p>



<a name="217153722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217153722" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217153722">(Nov 18 2020 at 15:55)</a>:</h4>
<p>If <code>Muckable</code> is really only compatible with <code>#[repr(C)]</code>'s language-level guarantees, <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20semver.20hazard/near/216747469">we're back at this point in the discussion</a>. We'd need to proactively forbid implementations of <code>Muckable</code> for types that aren't recursively <code>repr(C)</code>, <code>repr(transparent)</code>, or the primitive repr.</p>



<a name="217161562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217161562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217161562">(Nov 18 2020 at 16:40)</a>:</h4>
<p>I personally would be very open to making guarantees about <code>repr(Rust)</code>, at least regarding its compatibility with similar types.</p>



<a name="217161662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217161662" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217161662">(Nov 18 2020 at 16:41)</a>:</h4>
<p>For instance, I think <code>struct S(i32, i32)</code> and <code>(i32, i32)</code> and <code>struct S2(i32, i32)</code> and <code>struct S3 { x: i32, y: i32 }</code> ought to be guaranteed compatible.</p>



<a name="217161776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217161776" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217161776">(Nov 18 2020 at 16:42)</a>:</h4>
<p><em>if</em> you impl <code>Muckable</code> for them.</p>



<a name="217161987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217161987" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217161987">(Nov 18 2020 at 16:43)</a>:</h4>
<p>If, in the future, we offered some kind of struct reordering (beyond what we currently do to fill holes if you put fields in a suboptimal order for their sizes), we could potentially say "we don't do this on types that impl <code>Muckable</code>", or we could make it opt-in via an attribute, or similar.</p>



<a name="217164236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217164236" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217164236">(Nov 18 2020 at 16:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217153722">said</a>:</p>
<blockquote>
<p>We'd need to proactively forbid implementations of <code>Muckable</code> for types that aren't recursively <code>repr(C)</code>, <code>repr(transparent)</code>, or the primitive repr.</p>
</blockquote>
<p>Would it alternatively be possible to allow those impls but then not generate <code>TransmuteFrom</code> impls involving those types? Essentially "pretend" that types that aren't <code>repr(C)</code>/etc. all have unique layouts.</p>



<a name="217164664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217164664" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217164664">(Nov 18 2020 at 17:01)</a>:</h4>
<p>Is it possible to allow only recursively <code>#[repr(C)]</code> types for now while leaving the opening for more types to impl <code>Muckable</code> in the future? It seems trivial to reject any types that aren't recursively <code>#[repr(C)]</code>.</p>



<a name="217164857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217164857" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217164857">(Nov 18 2020 at 17:02)</a>:</h4>
<p>We could also (for now) ban structs with generic type parameters. This might be heavy handed but it's not something that's needed for a lot of use cases.</p>



<a name="217180365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217180365" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217180365">(Nov 18 2020 at 18:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="117495">rpjohnst</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217164236">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217153722">said</a>:</p>
<blockquote>
<p>We'd need to proactively forbid implementations of <code>Muckable</code> for types that aren't recursively <code>repr(C)</code>, <code>repr(transparent)</code>, or the primitive repr.</p>
</blockquote>
<p>Would it alternatively be possible to allow those impls but then not generate <code>TransmuteFrom</code> impls involving those types? Essentially "pretend" that types that aren't <code>repr(C)</code>/etc. all have unique layouts.</p>
</blockquote>
<p>Yes, although that rules out a class of safe transmutations for those types.</p>



<a name="217182275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217182275" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217182275">(Nov 18 2020 at 19:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224872">Ryan Levick</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217164857">said</a>:</p>
<blockquote>
<p>We could also (for now) ban structs with generic type parameters. This might be heavy handed but it's not something that's needed for a lot of use cases.</p>
</blockquote>
<p>Unfortunately, a lot of the use-cases I'm most interested in would be ruled out by that. :(</p>



<a name="217182958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217182958" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217182958">(Nov 18 2020 at 19:16)</a>:</h4>
<p>There's a middle-ground where we can provide <em>both</em> the fully-fledged compiler analysis of transmutation safety, <em>and</em> the less-weird-but-less-expressive <code>Muckable{From,Into}</code>-based system.</p>
<p>Given <code>UnstableTransmuteFrom</code>, the <code>Muckable{From,Into}</code>-based <code>TransmuteFrom</code> is just this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">TransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Dst</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Dst</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">Src</span>: <span class="nc">MuckableInto</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Dst</span>: <span class="nc">MuckableFrom</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Dst</span>: <span class="nc">UnstableTransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="p">,</span><span class="w"> </span><span class="n">NeglectConstructability</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>(And we can imagine <em>other</em> SemVer stable facades over <code>UnstableTransmuteFrom</code> that are appropriate for these other niche use-cases we've considered.)</p>



<a name="217186111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217186111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217186111">(Nov 18 2020 at 19:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217080315">said</a>:</p>
<blockquote>
<p>I think many more people would be willing to opt their types into <code>TurnThisIntoThings</code>.</p>
</blockquote>
<p>This is the direction my brain was thinking too.  It also helps this:</p>
<blockquote>
<p>The type's author may currently add fields to this type without incrementing major versions. They could not if they implemented Muckable.</p>
</blockquote>
<p>Because if that's <code>MuckableInto</code> then you can add things at the end (which matches well with the kinds of things C often allows for) and still allow the thing to be transmuted to the same prefixes as worked before.</p>



<a name="217186263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217186263" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217186263">(Nov 18 2020 at 19:40)</a>:</h4>
<p>Yeah, as far as I can tell, it's a strict improvement over just having <code>Muckable</code>.</p>



<a name="217186531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217186531" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217186531">(Nov 18 2020 at 19:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217161776">said</a>:</p>
<blockquote>
<p><em>if</em> you impl <code>Muckable</code> for them.</p>
</blockquote>
<p>Depending on whether the type impled Muckable for that seems odd to me.</p>
<p>I'd expect either "use <code>repr(linear)</code> to get that" or "<code>repr(rust)</code> for a type where all the fields are the same type (maybe the same layout) is defined as <code>repr(linear)</code>".</p>



<a name="217186784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217186784" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217186784">(Nov 18 2020 at 19:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217186263">said</a>:</p>
<blockquote>
<p>Yeah, as far as I can tell, it's a strict improvement over just having <code>Muckable</code>.</p>
</blockquote>
<p>And I think we keep rediscovering some form of the split, which gives me extra confidence in it.  It's similar, in a way, to the very old conversations about "has no padding" vs "all bit patterns are valid", which are roughly directionally the same.</p>



<a name="217187043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187043" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187043">(Nov 18 2020 at 19:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217186531">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217161776">said</a>:</p>
<blockquote>
<p><em>if</em> you impl <code>Muckable</code> for them.</p>
</blockquote>
<p>Depending on whether the type impled Muckable for that seems odd to me.</p>
<p>I'd expect either "use <code>repr(linear)</code> to get that" or "<code>repr(rust)</code> for a type where all the fields are the same type (maybe the same layout) is defined as <code>repr(linear)</code>".</p>
</blockquote>
<p>Question for clarification: by "all the fields are the same type", do you mean "two structures have fields of the same size/layout at the same offsets"? (Many of the examples above used <code>i32</code> everywhere, so I wanted to make sure you weren't attaching significance to the fact that all the fields in the <em>same</em> structure have the same type.)</p>



<a name="217187137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187137">(Nov 18 2020 at 19:47)</a>:</h4>
<p>I feel like <code>repr(linear)</code> has a "fencepost security" problem: it's talking in terms of things we <em>won't</em> do rather than in terms of things we <em>might</em> do. Field order is only one of the things we might conceivably modify with a <code>repr(Rust)</code> type.</p>



<a name="217187296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187296" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187296">(Nov 18 2020 at 19:48)</a>:</h4>
<p>As another example, with a <code>repr(Rust)</code> type, I'd love to be able to say "<em>every</em> instance of this type assigns the same value to this field, and nothing modifies this field, so let's not store the field at all, and just treat accesses to it as returning the constant value we know it'll have".</p>



<a name="217187322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187322" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187322">(Nov 18 2020 at 19:48)</a>:</h4>
<p>I was specifically referring to the fields in the same struct having the same layout, yes.  Because IIRC there has been a bunch of desire in the unsafe code WG to _not_ do the "repr(rust) is the same layout for the same fields between different types".</p>



<a name="217187490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187490" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187490">(Nov 18 2020 at 19:50)</a>:</h4>
<p>Interesting.</p>



<a name="217187545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187545" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187545">(Nov 18 2020 at 19:50)</a>:</h4>
<p>I feel like that "every instance of this type sets this field to the same value" is a counter-example to the "different types with the same fields have the same layout" thing from earlier, for example.</p>



<a name="217187553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187553" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187553">(Nov 18 2020 at 19:50)</a>:</h4>
<p>You're suggesting we might <em>not</em> want to allow transmute between (non-repr(C)) <code>struct S(i64, i32)</code> and <code>(i64, i32)</code> and <code>struct S2 { f1: i64, f2: i32 }</code>?</p>



<a name="217187605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187605" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187605">(Nov 18 2020 at 19:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217182958">said</a>:</p>
<blockquote>
<p>There's a middle-ground where we can provide <em>both</em> the fully-fledged compiler analysis of transmutation safety, <em>and</em> the less-weird-but-less-expressive <code>Muckable{From,Into}</code>-based system.</p>
<p>Given <code>UnstableTransmuteFrom</code>, the <code>Muckable{From,Into}</code>-based <code>TransmuteFrom</code> is just this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">TransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Dst</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Dst</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">Src</span>: <span class="nc">MuckableInto</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Dst</span>: <span class="nc">MuckableFrom</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Dst</span>: <span class="nc">UnstableTransmuteFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="p">,</span><span class="w"> </span><span class="n">NeglectConstructability</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>(And we can imagine <em>other</em> SemVer stable facades over <code>UnstableTransmuteFrom</code> that are appropriate for these other niche use-cases we've considered.)</p>
</blockquote>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span>, <span class="user-mention" data-user-id="239881">@Josh Triplett</span> Would there be any appetite from the lang team of pursuing this dual approach? It would allow us to cover <code>repr(C)</code> types with rigidish semver stability requirements very well via <code>TransmuteFrom</code>, but <em>also</em> provide raw access to a more general and powerful automatic analysis of transmutation safety.</p>



<a name="217187651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187651" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187651">(Nov 18 2020 at 19:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217187545">said</a>:</p>
<blockquote>
<p>I feel like that "every instance of this type sets this field to the same value" is a counter-example to the "different types with the same fields have the same layout" thing from earlier, for example.</p>
</blockquote>
<p>I'm not suggesting it isn't, and it's a good reason why <code>repr(Rust)</code> might not want to allow that, but I'm asking if <code>repr(linear)</code> is the right concept and name to cover not just reordering but "let's omit this field entirely" or other such ideas.</p>



<a name="217187664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187664" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187664">(Nov 18 2020 at 19:51)</a>:</h4>
<p>Personally I'm not sure, but I recall a bunch of people explicitly wanting to have a compiler flag for layout randomization that would make those transmutes definitely not ok.</p>
<p>(Like weak-ASLR, but for fields.)</p>



<a name="217187851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187851" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187851">(Nov 18 2020 at 19:53)</a>:</h4>
<p>Yeah, I don't know that <code>repr(linear)</code> is actually the right answer.  I guess for the case I mentioned it'd be more like <code>repr(array)</code>, which would be more clearly defined (and restricted in applicability, like <code>repr(transparent)</code> is).</p>



<a name="217187893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217187893" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217187893">(Nov 18 2020 at 19:53)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span><br>
1) I think that would depend <em>heavily</em> on the details of <code>UnstableTransmuteFrom</code>'s second and third generic arguments.<br>
2) Just from reading that, I <em>really</em> don't think we should use <code>Into</code> and <code>From</code> in these names, because I'm having to think about them three or four times to get even a little confidence in which direction they mean.</p>



<a name="217188036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217188036" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217188036">(Nov 18 2020 at 19:54)</a>:</h4>
<p>At least <code>From</code> and <code>Into</code> in bounds are usually written like <code>SomeType: From&lt;SomeOtherType&gt;</code> or <code>SomeOtherType: Into&lt;SomeType&gt;</code>, which have the advantage that if you read them in the most natural way you have the semantics right.</p>



<a name="217188078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217188078" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217188078">(Nov 18 2020 at 19:55)</a>:</h4>
<p><code>MuckableFrom</code> and <code>MuckableInto</code> feel very strange to me, partly because there's no "x from y" or "x into y".</p>



<a name="217188197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217188197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217188197">(Nov 18 2020 at 19:56)</a>:</h4>
<p>Something more like <code>ToBytes</code> or <code>FromBytes</code>, or some other name that makes the direction <em>obvious</em> from a casual reading, would help keep them straight.</p>



<a name="217188444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217188444" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217188444">(Nov 18 2020 at 19:58)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> Given that one of the goals is allowing transmuting to prefixes, I'm definitely in favour of the dual approach.  I've always considered it basically necessary for common newtype patterns, too -- <code>struct Even(i32);</code> feels like it's only ever safe-transmute in one of the directions.</p>
<p>Like Josh, though, I'm not sure I follow exactly what <code>UnstableTransmuteFrom</code>'s details are.  If it's unstable, though -- maybe just initially, I don't know -- I might not have to, though.</p>



<a name="217188815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217188815" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217188815">(Nov 18 2020 at 20:00)</a>:</h4>
<p>I'm also wondering how easy it would be to write (and write the type signature for) something like this:<br>
<code>impl ValidatedTransmuteFrom&lt;Src&gt; for Dst where Src: (bikeshedded name), Dst: Validate, Dst: SomethingAboutLayoutCompatibilityOnly&lt;Src&gt;</code>.</p>



<a name="217189062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189062" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189062">(Nov 18 2020 at 20:02)</a>:</h4>
<p>Where <code>Validate</code> is a trait with a function that takes a <code>&amp;Dst</code> that might not meet the requirements of <code>Dst</code> and confirm that it meets the requirements of <code>Dst</code> or returns an error.</p>



<a name="217189302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189302" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189302">(Nov 18 2020 at 20:04)</a>:</h4>
<p>Something like that would allow <code>&amp;str: ValidatedTransmuteFrom&lt;&amp;[u8]&gt;</code> or <code>NonZeroU32: ValidatedTransmuteFrom&lt;u32&gt;</code>.</p>



<a name="217189387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189387" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189387">(Nov 18 2020 at 20:05)</a>:</h4>
<p>The compiler's generated traits would handle questions of layout compatibility, and <code>Validate</code> would <em>only</em> have to check type-specific invariants.</p>



<a name="217189430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189430" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189430">(Nov 18 2020 at 20:05)</a>:</h4>
<p>Hmm, how much is the "transmuteness" essential in situations doing validation?  Vs just using safe-transmute-on-inner-private-type in a <code>TryFrom</code> impl?</p>



<a name="217189589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189589" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189589">(Nov 18 2020 at 20:06)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> The difference is that you usually have to write <em>specific</em> <code>TryFrom</code> impls for particular types you want to support.</p>



<a name="217189621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189621" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189621">(Nov 18 2020 at 20:07)</a>:</h4>
<p>As opposed to an impl saying "anything you can transmute to me I'm happy to validate".</p>



<a name="217189674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189674" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189674">(Nov 18 2020 at 20:07)</a>:</h4>
<p>That does suggest a better name, though: this is <code>TryTransmuteFrom</code>.</p>



<a name="217189701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217189701" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217189701">(Nov 18 2020 at 20:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings/near/217189621">said</a>:</p>
<blockquote>
<p>As opposed to an impl saying "anything you can transmute to me I'm happy to validate".</p>
</blockquote>
<p>Ah, that's the part I'd missed.  Interesting.</p>



<a name="217190005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/%60Muckable%60%20Shortcomings/near/217190005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/216762-project-safe-transmute/topic/.60Muckable.60.20Shortcomings.html#217190005">(Nov 18 2020 at 20:10)</a>:</h4>
<p>Thinking again, though, I'm not sure mixing the two into the same API is the right path.  Transmuting to the archetype and then using a validation API might be ok.  Like you could <code>str::from_utf8(foo.transmute_into())</code>.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>