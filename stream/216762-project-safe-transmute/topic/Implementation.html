<html>
<head><meta charset="utf-8"><title>Implementation · project-safe-transmute · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/index.html">project-safe-transmute</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html">Implementation</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="244265623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/244265623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#244265623">(Jun 29 2021 at 11:28)</a>:</h4>
<p>I've been able to start implementation work in earnest, but could use some mentoring. How do you add a lang item? I've made what I (think) are the necessary modifications to:</p>
<ul>
<li><code>compiler/rustc_hir/src/lang_items.rs</code></li>
<li><code>compiler/rustc_span/src/symbol.rs</code></li>
</ul>
<p>...and then added <code>BikeshedTransmutableFrom</code> to <code>library/core/src/mem/mod.rs</code> and annotated it with <code>#[lang = "transmute_trait"]</code>.</p>
<p>Does this sound generally correct?  <code>./x.py check</code> yields:</p>
<div class="codehilite"><pre><span></span><code>error[E0522]: definition of an unknown language item: `transmute_trait`
 --&gt; library/core/src/mem/transmutability.rs:3:1
  |
3 | #[lang = &quot;transmute_trait&quot;]
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^ definition of unknown language item `transmute_trait`
</code></pre></div>
<p>I'm wondering if there's anything else I need to do, like re-bootstrap the compiler since this change touches both the compiler and libcore?</p>
<p>cc <span class="user-mention" data-user-id="232957">@Jack Huey</span>, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span></p>



<a name="244286224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/244286224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#244286224">(Jun 29 2021 at 14:06)</a>:</h4>
<p>Yeah, as you alluded to, the issue is that for the stage0 compiler, the <code>Transmute</code> trait isn't a lang item. What you'll need to do is conditionally apply the lang item attribute if it isn't the stage0 compiler like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg_attr(not(bootstrap), lang = </span><span class="s">"transmute_trait"</span><span class="cp">)]</span><span class="w"></span>
</code></pre></div>
<p>I think that is all you'll need to do. Whoever updates the beta compiler next will then remove the condition since it will be required in that version.</p>



<a name="244316213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/244316213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#244316213">(Jun 29 2021 at 17:20)</a>:</h4>
<p>If you'd like an example  <span class="user-mention" data-user-id="219211">@Jack Wrenn</span>, my <code>?</code> PR changed some <a href="https://github.com/rust-lang/rust/pull/84767/files#diff-f82976cf19f74035c16523680a66b66ddb6f25220a531a5485b58dada8fb7ccc">https://github.com/rust-lang/rust/pull/84767/files#diff-f82976cf19f74035c16523680a66b66ddb6f25220a531a5485b58dada8fb7ccc</a> and then the bootstrap update PR later updates the <code>cfg(bootstrap)</code>s <a href="https://github.com/rust-lang/rust/pull/86603/files#diff-49412431a58f2ca62539b01666601bb34bcc133f35049a6c6d32c0c1ae891084">https://github.com/rust-lang/rust/pull/86603/files#diff-49412431a58f2ca62539b01666601bb34bcc133f35049a6c6d32c0c1ae891084</a></p>



<a name="245357698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/245357698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#245357698">(Jul 08 2021 at 19:09)</a>:</h4>
<p>Hi all, I've recently started reading up on the safe transmute project and it sounds like an interesting and useful feature. From what I can gather on the status, it seems like most of the design questions are resolved and mostly what's left is implementation. Is that right? Are there areas in the project that could use help?</p>



<a name="245376355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/245376355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pachi <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#245376355">(Jul 08 2021 at 21:44)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> is working on the implementation and I think he expressed that some help would be very welcome!</p>



<a name="245384127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/245384127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#245384127">(Jul 08 2021 at 23:24)</a>:</h4>
<p>Yep! I <em>think</em> I have a decent idea of what an algorithm for checking transmutability might look like, and I'm at the very early stages of implementation. I'm currently in the midst of a stressful move and job search, but will be increasingly working on this again after August 1.</p>



<a name="245384656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/245384656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#245384656">(Jul 08 2021 at 23:31)</a>:</h4>
<p>Sounds good. Good luck on the move and the job search!</p>



<a name="245384769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/245384769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#245384769">(Jul 08 2021 at 23:32)</a>:</h4>
<p>Do you have any notes anywhere, or is any of your implementation available to look at?</p>



<a name="249766865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249766865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249766865">(Aug 17 2021 at 19:29)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="421986">@eholk</span>, sorry for the slow reply; I've been having a painfully hectic summer. I threw some notes together here: <a href="https://hackmd.io/@jswrenn/SyqSHb2zu">https://hackmd.io/@jswrenn/SyqSHb2zu</a></p>
<p>And have a <em>very</em> nascent development branch here: <a href="https://github.com/jswrenn/rust/tree/transmute">https://github.com/jswrenn/rust/tree/transmute</a></p>



<a name="249767846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249767846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249767846">(Aug 17 2021 at 19:34)</a>:</h4>
<p>In the very near term, I'd like to get to the point where <code>BikeshedIntrinsicFrom</code> is <em>actually</em> hooked into the trait system; e.g., just as a stub that unconditionally returns <code>true</code> and debug prints the involved types. I poked around a bit, but it wasn't immediately apparent to me how to add such a "is this trait implemented for these types" hook. (cc <span class="user-mention" data-user-id="232957">@Jack Huey</span>, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span>)</p>
<p>At that point, we can pretty easily start noodling with different algorithmic approaches for transmutability.</p>



<a name="249768254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249768254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249768254">(Aug 17 2021 at 19:38)</a>:</h4>
<p>The algorithms <a href="https://hackmd.io/@jswrenn/SyqSHb2zu">here</a> have a significant limitation: they require the layouts of types to be <em>completely</em> specified. I discuss this limitation at the bottom of the document. It'd be cool to lift it, but probably not a deal breaker. I'd absolutely love to hear ideas for different approaches.</p>



<a name="249779249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249779249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249779249">(Aug 17 2021 at 21:10)</a>:</h4>
<p>Awesome, thanks for the reply! I have some other things I need to look at first, but I'll try to read over your notes soon.</p>



<a name="249783089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249783089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249783089">(Aug 17 2021 at 21:45)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> I <em>think</em> you probably want to look at the <a href="https://rustc-dev-guide.rust-lang.org/traits/resolution.html#candidate-assembly">candidate assembly</a> code. Specifically the code around here seems relevant <a href="https://github.com/rust-lang/rust/blob/d83da1d05dc75ff3452c068299f40e5d99589d71/compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs#L257">https://github.com/rust-lang/rust/blob/d83da1d05dc75ff3452c068299f40e5d99589d71/compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs#L257</a></p>



<a name="249793449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249793449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249793449">(Aug 17 2021 at 23:56)</a>:</h4>
<p>Yeah, that's correct. Those (along with confirmation) basically "define" the behavior of builtin trait impls</p>



<a name="249838161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249838161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249838161">(Aug 18 2021 at 11:58)</a>:</h4>
<blockquote>
<p>It is not well-defined that instances of <code>&amp;'static Foo</code> are bit-valid instances of <code>&amp;'static Bar</code>, where:</p>
<div class="codehilite"><pre><span></span><code>#[repr(C)] struct Foo(i8, [Rust; 0]);
#[repr(C)] struct Bar(i8);
</code></pre></div>
<p>➥ The alignment of Foo is not well-specified because the alignment of Rust is not well-specified.</p>
</blockquote>
<p>Aren't <code>Foo</code> and <code>Bar</code> swapped here? Whatever the alignment of <code>Rust</code> is, <code>Foo</code>'s alignment will always be a multiple of <code>i8</code>'s alignment, which is the same as <code>Bar</code>'s alignment, so any <code>&amp;'static Foo</code> should be a valid <code>&amp;'static Bar</code> but the opposite may not be true.</p>



<a name="249838184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249838184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249838184">(Aug 18 2021 at 11:58)</a>:</h4>
<p>(from the hackmd)</p>



<a name="249878637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249878637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249878637">(Aug 18 2021 at 16:52)</a>:</h4>
<p>I do not know if Step 0 is trying to be exhaustive with "well defined", if so then it should mention arrays and repr transparent and honestly the non-mask simd types</p>



<a name="249879833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249879833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249879833">(Aug 18 2021 at 17:00)</a>:</h4>
<p>also don't forget that Repr(C) actually has varying layout depending on target, <a href="https://github.com/rust-lang/rust/issues/81996">https://github.com/rust-lang/rust/issues/81996</a> so a zero sized type field actually can't be assumed to always contribute zero to the struct size.</p>



<a name="249880047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249880047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249880047">(Aug 18 2021 at 17:02)</a>:</h4>
<p>Can't <em>always</em> be assumed.  :-)</p>



<a name="249880372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249880372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249880372">(Aug 18 2021 at 17:04)</a>:</h4>
<p>honestly that particular part of repr(C) is gonna be suuuuuuper hard for T-lang to somehow fix without maybe breaking people's unsafe code. good thing I'm not them</p>



<a name="249881218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249881218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249881218">(Aug 18 2021 at 17:10)</a>:</h4>
<p>I imagine the compiler could compute both layouts, and warn or error anytime they differed. But yeah, it's a tricky issue.</p>



<a name="249896751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249896751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249896751">(Aug 18 2021 at 19:00)</a>:</h4>
<p>I honestly don't think breakage will be the primary issue there; cases where the layout differs are likely to be cases where the current layout is unusably incompatible and we can fix it without breaking any code that worked before.</p>



<a name="249896870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249896870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249896870">(Aug 18 2021 at 19:00)</a>:</h4>
<p>It's more that someone needs to step up and champion that issue. I'd love to see someone make a proposal to solve that (e.g. an MCP).</p>



<a name="249897005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249897005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249897005">(Aug 18 2021 at 19:01)</a>:</h4>
<p>That presumes that people only use reprC to be C compatible, which is very definitely not the case.</p>



<a name="249906309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/249906309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#249906309">(Aug 18 2021 at 20:19)</a>:</h4>
<p>No argument there. But the question is, will it result in breakage <em>in practice</em>?</p>



<a name="250260016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250260016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250260016">(Aug 22 2021 at 07:14)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> Regarding the hackmd document: I'd remove the greek lettering from the explanation. I don't know what it means, I don't know how to read it out loud, and I don't know how to type it on my desktop or phone. It ends up inaccessible, a thought flow barrier.</p>



<a name="250527444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250527444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250527444">(Aug 24 2021 at 18:30)</a>:</h4>
<p><strong>Update:</strong> Thanks for pointing me to candidate assembly, <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> &amp; <span class="user-mention" data-user-id="232957">@Jack Huey</span>! </p>
<p>I <a href="https://github.com/jswrenn/rust/blob/8946fd357632caf38fcb673732522a606f53997d/compiler/rustc_trait_selection/src/traits/select/mod.rs#L1559-L1619">defined a <code>transmute_conditions</code> helper</a> (a la <code>sized_conditions</code>) that punts with <code>Ambiguous</code> until all of the type parameters for the transmutability trait are fully resolved/evaluated, at which point it calls out to a stub predicate <code>is_transmutable</code> and either:</p>
<ol>
<li>produces <code>Where(ty::Binder::dummy(Vec::new()))</code> if that predicate is satisfied, or</li>
<li>produces <code>None</code> if it is not</li>
</ol>
<p>At a glance, this seems to work, but please lmk if I'm missing the mark with any of this.</p>
<p><strong>Question:</strong> Is there a nice way to grab fields out of an evaluated <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_middle/ty/consts/struct.Const.html"><code>Const</code></a>? The transmutability trait <a href="https://github.com/jswrenn/rust/blob/8946fd357632caf38fcb673732522a606f53997d/library/core/src/mem/transmutability.rs#L4-L24">has a const generic <code>Assume</code> parameter</a>.</p>



<a name="250527791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250527791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250527791">(Aug 24 2021 at 18:33)</a>:</h4>
<p>Quickly looking at <code>transmute_conditions</code>...</p>



<a name="250528489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250528489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250528489">(Aug 24 2021 at 18:38)</a>:</h4>
<p>Just by giving it a quick glance over, looks like a decent start</p>



<a name="250528513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250528513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250528513">(Aug 24 2021 at 18:38)</a>:</h4>
<p>Can't answer much regarding the consts</p>



<a name="250528593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250528593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250528593">(Aug 24 2021 at 18:39)</a>:</h4>
<p>The only comment I have is I'm not sure if it's safe to <code>skip_binder</code> on the obligation</p>



<a name="250529254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250529254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250529254">(Aug 24 2021 at 18:43)</a>:</h4>
<p>Yeah, I wasn't sure about that either. Honestly, I was just copying what <code>sized_conditions</code> does to get the <code>Self</code> type, and doing it to get at the other type parameters, too.</p>



<a name="250529868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250529868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250529868">(Aug 24 2021 at 18:47)</a>:</h4>
<p>For <code>sized_conditions</code>, see the "// NOTE: binder moved to (*)"</p>



<a name="250530382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250530382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250530382">(Aug 24 2021 at 18:50)</a>:</h4>
<p>heh, yeah... I'll swap these out for <code>no_bound_vars().unwrap()</code> and figure out what binders are by way of seeing when it panics. :)</p>
<p>ah, okay, so this panics:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">is_transmutable_hrtb</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="n">Scope</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ASSUME</span>: <span class="nc">Assume</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">dst</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">dst</span><span class="w"> </span><span class="n">Dst</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">src</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BikeshedIntrinsicFrom</span><span class="o">&lt;&amp;'</span><span class="na">dst</span><span class="w"> </span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Scope</span><span class="p">,</span><span class="w"> </span><span class="n">ASSUME</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Bar</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">is_transmutable_hrtb</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">Bar</span><span class="p">,</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="n">Assume</span>::<span class="n">NOTHING</span><span class="p">}</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// ICE</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="250531849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250531849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250531849">(Aug 24 2021 at 18:59)</a>:</h4>
<p>about what I would expect</p>



<a name="250532453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250532453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250532453">(Aug 24 2021 at 19:03)</a>:</h4>
<p>Yeah, so it's <em>definitely</em> not safe to pretend that some lifetimes just don't exist... <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="250534310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250534310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250534310">(Aug 24 2021 at 19:16)</a>:</h4>
<p>Well, I'm not sure (haven't thought much about it) if you could e.g. erase regions here</p>



<a name="250535980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/250535980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#250535980">(Aug 24 2021 at 19:29)</a>:</h4>
<blockquote>
<p>Question: Is there a nice way to grab fields out of an evaluated Const? The transmutability trait has a const generic Assume parameter.</p>
</blockquote>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> I don't think there's a particularly <em>nice</em> way to do that. The only thing I can think of off hand is to go through the normal const eval machinery. At a really high level, you'd do something like:</p>
<ol>
<li>Create a new <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_mir/interpret/struct.InterpCx.html"><code>InterpCx</code></a>, you can probably use the regular <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_mir/const_eval/machine/struct.CompileTimeInterpreter.html"><code>CompileTimeInterpreter</code></a> for the <code>Machine</code>. </li>
<li>Load the const value into the context <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_mir/interpret/struct.InterpCx.html#method.const_val_to_op"><code>InterpCx::const_val_to_op</code></a></li>
<li>Get the field you want to read the value of <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_mir/interpret/struct.InterpCx.html#method.operand_field"><code>InterpCx::operand_field</code></a></li>
<li>Read the resulting value <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_mir/interpret/struct.InterpCx.html#method.read_scalar"><code>InterpCx::read_scalar</code></a>. You should get back a <code>ScalarMaybeUninit::Scalar(Scalar::Int(ScalarInt::TRUE | ScalarInt::FALSE))</code></li>
</ol>
<p>cc <span class="user-mention" data-user-id="124288">@oli</span> if they know a nicer way.</p>



<a name="252094463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252094463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252094463">(Sep 05 2021 at 18:51)</a>:</h4>
<p><span class="user-mention" data-user-id="232957">@Jack Huey</span> [Disclaimer: I'm very new to this and might have some underlying misconceptions...]</p>
<p>I <em>think</em> late bound regions can be erased (iiuc what late regions are and what erasing them means), because the exact relationship of late bound lifetimes often doesn't matter---just their relationship to <code>'static</code>.</p>
<p>E.g., a bound like this is always unsatisfiable, because there exist <code>'a</code> that don't outlive <code>'b</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">always_unsatisfiable</span><span class="p">()</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span>: <span class="nc">TransmuteFrom</span><span class="o">&lt;&amp;'</span><span class="na">b</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>And a bound mixing regular and hrtb can only be satisfied if the regular lifetime is ultimately instantiated as <code>'static</code>; e.g.:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">sat_if_static</span><span class="o">&lt;'</span><span class="na">t</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span>: <span class="nc">TransmuteFrom</span><span class="o">&lt;&amp;'</span><span class="na">t</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>Is this the right line of thinking to assess whether or not late bound regions can be erased?</p>



<a name="252094661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252094661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252094661">(Sep 05 2021 at 18:55)</a>:</h4>
<p>uh, I don't have time right now to dig into this, but maybe ping me later tonight or tomorrow</p>



<a name="252197148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252197148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252197148">(Sep 06 2021 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="232957">@Jack Huey</span> ping at your leisure <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="252197678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252197678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252197678">(Sep 06 2021 at 16:29)</a>:</h4>
<p>So, my instinct is that all lifetimes, late or otherwise can be erased</p>



<a name="252197802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252197802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252197802">(Sep 06 2021 at 16:30)</a>:</h4>
<p>Niko mentioned at one point in regards to something else (I think it was generators) that we might actually theoretically be able to generate different layouts when a type has late bound regions or not</p>



<a name="252197826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252197826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252197826">(Sep 06 2021 at 16:30)</a>:</h4>
<p>That would be <em>surprising</em> to me</p>



<a name="252198032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252198032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252198032">(Sep 06 2021 at 16:33)</a>:</h4>
<p>But, rereading your message above, I'm wondering if we can erase lifetimes at all</p>



<a name="252198100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252198100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252198100">(Sep 06 2021 at 16:33)</a>:</h4>
<p>We obviously don't want to transmute a shorter lifetime into a longer one</p>



<a name="252198527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/252198527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#252198527">(Sep 06 2021 at 16:38)</a>:</h4>
<p>Yeah, I'm not sure erasing lifetimes is the right thing to do</p>



<a name="266035361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266035361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266035361">(Dec 25 2021 at 01:41)</a>:</h4>
<p>I've submitted a PR for an initial, incomplete implementation of the MCP: <a href="https://github.com/rust-lang/rust/pull/92268">https://github.com/rust-lang/rust/pull/92268</a></p>



<a name="266046237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266046237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266046237">(Dec 25 2021 at 07:07)</a>:</h4>
<p>the PR post doesn't mention <code>repr(transparent)</code>, is it also on the short list?</p>



<a name="266065205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266065205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266065205">(Dec 25 2021 at 16:09)</a>:</h4>
<p>Yep! Though I wouldn't call the list of things that remain to be implemented "short". <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="266065207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266065207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266065207">(Dec 25 2021 at 16:09)</a>:</h4>
<p>It'll be really easy to implement support for that, though.</p>



<a name="266084464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266084464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266084464">(Dec 26 2021 at 01:24)</a>:</h4>
<p>Just implemented <code>Assume::VALIDITY</code> support!</p>



<a name="266084471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266084471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266084471">(Dec 26 2021 at 01:24)</a>:</h4>
<p>Next up: visibility checking. I fear it's going to be <em>really</em> tricky, esp. with ZSTs.</p>



<a name="266126356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266126356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266126356">(Dec 26 2021 at 20:29)</a>:</h4>
<p>So <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/enum.Visibility.html#method.is_accessible_from"><code>Visibility:is_accessible_from</code></a> <em>sounds</em> pretty nifty, but I'm not totally sure I understand how to use it.</p>
<p>It consumes:</p>
<ul>
<li><code>Self</code> is the visibility modifier</li>
<li>a <code>module</code> parameter (is this the module the visibility modifier appears in?)</li>
<li>a <code>tree</code> parameter (is this the tree that we're assessing visibility form?)</li>
</ul>



<a name="266126361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266126361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266126361">(Dec 26 2021 at 20:29)</a>:</h4>
<p>(cc <span class="user-mention" data-user-id="124288">@oli</span> <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>)</p>



<a name="266126976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266126976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266126976">(Dec 26 2021 at 20:47)</a>:</h4>
<p>concretely, what I'm trying to accomplish is, given code like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">TransmutableFrom</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_transmutable</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">Dst</span>: <span class="nc">TransmutableFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">src</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Src</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">dst</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Zst</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Dst</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="n">field</span>: <span class="nc">Zst</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">_static_assertion</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">Context</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">crate</span>::<span class="n">assert</span>::<span class="n">is_transmutable</span>::<span class="o">&lt;</span><span class="n">src</span>::<span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span>::<span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">};};</span><span class="w"></span>
</code></pre></div>
<p>...answer:</p>
<ul>
<li>is <code>Zst</code> accessible from the defining scope of <code>Context</code>?</li>
<li>is <code>Dst.field</code> accessible from the defining scope of <code>Context</code>?</li>
<li>is <code>Dst</code> accessible from the defining scope of <code>Context</code>?</li>
</ul>
<p>(the answer to all of these questions should be 'yes'!)</p>



<a name="266180165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266180165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266180165">(Dec 27 2021 at 15:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266126356">said</a>:</p>
<blockquote>
<p>So <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/enum.Visibility.html#method.is_accessible_from"><code>Visibility:is_accessible_from</code></a> <em>sounds</em> pretty nifty, but I'm not totally sure I understand how to use it.</p>
<p>It consumes:</p>
<ul>
<li><code>Self</code> is the visibility modifier</li>
<li>a <code>module</code> parameter (is this the module the visibility modifier appears in?)</li>
<li>a <code>tree</code> parameter (is this the tree that we're assessing visibility form?)</li>
</ul>
</blockquote>
<p>I believe</p>
<ul>
<li><code>module</code> is the place we're accessing visibility from (the defining scope of <code>Context</code> in your examples or perhaps the <code>mod</code> that contains <code>_static_assertion</code>)</li>
<li><code>tree</code> is the way to determine what the relationship between the module specified in <code>Visibility::Restricted(module_def_id)</code> and <code>module</code> is. For the part of the compiler you're working in, you probably just want to pass <code>tcx</code> as this parameter.</li>
</ul>



<a name="266181537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266181537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266181537">(Dec 27 2021 at 15:43)</a>:</h4>
<p>Huh, so there's nothing here that represents <em>where</em> the visibility modifier occurs. Will <code>Visibility:is_accessible_from</code> produce false positives when the pub-in-priv trick is used to create types that are effectively private?</p>



<a name="266182607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266182607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266182607">(Dec 27 2021 at 15:59)</a>:</h4>
<blockquote>
<p>there's nothing here that represents where the visibility modifier occurs</p>
</blockquote>
<p>I'm not quite sure what you mean. Isn't that tracked by <code>Visibility</code> itself? </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w">           </span><span class="c1">// Visibility::Public</span>
<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="p">;</span><span class="w">    </span><span class="c1">// Visibility::Restricted({def id of crate})</span>
<span class="k">pub</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Baz</span><span class="p">;</span><span class="w">     </span><span class="c1">// Visibility::Restricted({def id of local module})</span>
<span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Baa</span><span class="p">;</span><span class="w">    </span><span class="c1">// Visibility::Restricted({def id of parent module})</span>
<span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">a</span>::<span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bab</span><span class="p">;</span><span class="w">  </span><span class="c1">// Visibility::Restricted({def id of a::b})</span>
<span class="n">stuct</span><span class="w"> </span><span class="n">Bac</span><span class="p">;</span><span class="w">                </span><span class="c1">// Visibility::Restricted({def id of local module})</span>
</code></pre></div>



<a name="266182957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266182957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266182957">(Dec 27 2021 at 16:03)</a>:</h4>
<p>Oh, d'oh, yep.</p>



<a name="266183066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266183066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266183066">(Dec 27 2021 at 16:04)</a>:</h4>
<p>Wait, wait, I'm less convinced.</p>



<a name="266183111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266183111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266183111">(Dec 27 2021 at 16:05)</a>:</h4>
<p>If I modify the <code>dst</code> module so the example looks like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">TransmutableFrom</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_transmutable</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">Dst</span>: <span class="nc">TransmutableFrom</span><span class="o">&lt;</span><span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">src</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Src</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">dst</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">mod</span> <span class="nn">trick</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Zst</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Dst</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="n">field</span>: <span class="nc">trick</span>::<span class="n">Zst</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">_static_assertion</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">Context</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">crate</span>::<span class="n">assert</span>::<span class="n">is_transmutable</span>::<span class="o">&lt;</span><span class="n">src</span>::<span class="n">Src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span>::<span class="n">Dst</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">};};</span><span class="w"></span>
</code></pre></div>
<p>then <code>Zst</code> <em>isn't</em> accessible from the defining scope of <code>Context</code>. It's declared <code>pub</code>, but it's effectively private.</p>



<a name="266183337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266183337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266183337">(Dec 27 2021 at 16:08)</a>:</h4>
<p>Yeah, I'm unsure about the pub-in-priv bit. </p>
<p>We convert from a <code>hir::VisibilityKind</code> to <code>Visibility</code> here <a href="https://github.com/rust-lang/rust/blob/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/compiler/rustc_middle/src/ty/mod.rs#L301">https://github.com/rust-lang/rust/blob/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/compiler/rustc_middle/src/ty/mod.rs#L301</a> but that just converts <code>VisbilityKind::Public</code> to <code>Visbility::Public</code>.</p>



<a name="266183460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266183460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266183460">(Dec 27 2021 at 16:10)</a>:</h4>
<p><code>VisibilityKind::Public</code> gets assigned here if we just parse <code>pub</code> (no visibility specifiers). <a href="https://github.com/rust-lang/rust/blob/3d57c61a9e04dcd3df633f41142009d6dcad4399/compiler/rustc_parse/src/parser/mod.rs#L1346">https://github.com/rust-lang/rust/blob/3d57c61a9e04dcd3df633f41142009d6dcad4399/compiler/rustc_parse/src/parser/mod.rs#L1346</a></p>



<a name="266184004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266184004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266184004">(Dec 27 2021 at 16:17)</a>:</h4>
<p>(fyi, those links are broken to people not in the code search beta <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span>)</p>



<a name="266184014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266184014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266184014">(Dec 27 2021 at 16:17)</a>:</h4>
<p>Oh no</p>



<a name="266184074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266184074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266184074">(Dec 27 2021 at 16:18)</a>:</h4>
<p>luckily it's clear what you're linking to, tho <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="266184113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266184113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266184113">(Dec 27 2021 at 16:19)</a>:</h4>
<p>Forgot that wasn't completely available yet. Fixed.</p>



<a name="266302338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266302338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266302338">(Dec 28 2021 at 23:45)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> pub-in-priv are hacks which are quite brittle w.r.t. genuine compiler checks; I wouldn't worry too much about those: to make <code>Zst</code>'s construction clearly private then the author would need to define a genuinely private field</p>



<a name="266302402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266302402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266302402">(Dec 28 2021 at 23:47)</a>:</h4>
<p>In other words, I would expect that transmutation to pass, since technically everything is public as far as the compiler is concerned. In this very specific scenario, the public constructor of zst just happens to be unnameable, but other things could change that</p>



<a name="266302419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266302419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266302419">(Dec 28 2021 at 23:47)</a>:</h4>
<p><em>e.g.</em>, a <code>macro</code> could expose the <code>Zst</code> path</p>



<a name="266302478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266302478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266302478">(Dec 28 2021 at 23:48)</a>:</h4>
<p>(I'm on the phone, but basically try to define <code>pub macro leak() { trick::Zst }</code> inside <code>dst</code> to see what I mean)</p>



<a name="266303187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266303187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266303187">(Dec 29 2021 at 00:02)</a>:</h4>
<p>I get that it's brittle, but the fact remains that unless the author of <code>dst</code> does something to leak <code>Zst</code>, it's externally inaccessible. Before ignoring the priv-in-pub trick, I'd like to see an RFC acknowledging that  "it's sound to unsafely instantiate public-but-inaccessible types to work around not having access to their constructor".</p>
<p>I think such an RFC would either be completely untenable (since existing code might be relying on that sort of privacy for safety), or edition-gated (so as to not retroactively change the meaning of existing code).</p>



<a name="266308466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266308466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266308466">(Dec 29 2021 at 01:48)</a>:</h4>
<p>I don't remember where, but I think rusqlite relies on that sort of privacy for safety somewhere (this might have changed, it was a while since i looked at the part of the code I'm thinking of).</p>
<p>That said, I consider it a bit fragile and like something I should change when I find the time.</p>



<a name="266341499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266341499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266341499">(Dec 29 2021 at 12:33)</a>:</h4>
<p>While <code>pub-in-priv</code> currently makes sense when <em>sealing traits</em> (if anything, <strong>by lack of a better tool</strong>), there is no genuine reason to have a <code>pub-in-priv</code> type <strong>with all of its fields being <code>pub</code> as well</strong>. That's lazy programming, because there is always the option to mark one of the fields as private (or <code>pub (in crate)</code> depending on the needs). While such lazy programming patterns could be supported if doing so were easy, it turns out that having to perform a full-code reachability analysis seems to be way beyond the scope of Rust tools (FWIW, <code>rustdoc</code> already implements such a heuristic): if <code>Zst</code> were <code>Default</code>, for instance, then surely that transmute couldn't be unsound; ditto for a macro and so on.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">lib</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">mod</span> <span class="nn">private</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[derive(Default)]</span><span class="w"> </span><span class="c1">// &lt;- this could be a complex trait system "leaking" the type</span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="n">private</span>::<span class="n">Foo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib</span>::<span class="n">Bar</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span>::<span class="n">default</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=08080a7e7dc87222b99365442ba13e74">Playground</a></li>
</ul>
<div class="spoiler-block"><div class="spoiler-header">
<p>With a macro</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(decl_macro)]</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">lib</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">mod</span> <span class="nn">private</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// leaks the type</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">ty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">private</span>::<span class="n">Foo</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="n">private</span>::<span class="n">Foo</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// from a type to a path (macros can't be called in path position)</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Path</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib</span>::<span class="n">Bar</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">Path</span>::<span class="o">&lt;</span><span class="n">lib</span>::<span class="n">ty</span><span class="o">!</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=2ece4d20d9c49c2a4bab7584730533c6">Playground</a></li>
</ul>
</div></div>
<p>There could be a conservative approach of potentially-leaked-but-never-through-a-<code>use</code>-reexport <em>paths</em> / <em>names</em> to be considered somehow a new form a <em>type</em> privacy, and thus start being given new behavior within the compiler (<em>i.e.</em>, making that <code>rustdoc</code> heuristic become an official part of the compiler). But <em>name</em> privacy affecting <em>type</em> privacy would definitely be a novel thing in Rust. That is, the "burden of RFC" would actually lie in the other direction: the ones having to provide an RFC would be the people having relied on "a pub type with <em>all of its fields being pub as well</em>, but with a <code>in-priv</code> path that isn't <em>nameable</em>, yields a type which cannot be constructed <em>at all</em> since it can't be constructed by path" (similarly to people transmuting wide pointers (<code>&amp;[T]</code> to <code>&amp;[U]</code>) or <code>Vec</code>s, and so on: neither of these things have ever been officially allowed).</p>
<ul>
<li>
<p>I personally find that <code>lang</code> design / policy to be similar to the trait / coherence system on its own: <em>lack of</em> implementations are not usable in the coherence system, since it would be allowed for the crate author to add a trait impl (<em>unless they opted out with a <code>impl !Trait</code></em>, or more generally through a <code>fundamental</code> marker). So, lack of language capabilities should not be relied on unless the language explicitly provides an explicit future-proof guarantee of it.</p>
</li>
<li>
<p>Back to "all the fields are pub", the only exception —but an important one!— would be <code>#[non_exhaustive]</code> types, since it has been designed precisely as the tool to express <code>pub(in crate) ∅</code> trailing lack of extra fields.</p>
</li>
</ul>
<hr>
<p>That's why, <em>in practice</em>, wouldn't bother with that in your implementation for the moment, at least. Keep it as a needs-to-be-clarified question if you want, to see if <code>t-lang</code> wants to chime in and add this new rule / behavior to Rust.</p>



<a name="266514992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266514992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266514992">(Dec 31 2021 at 17:28)</a>:</h4>
<p>Btw, I forgot to mention it, but this whole project, and the fact we already have such an implementation, is simply awesome and outstanding, <span class="user-mention" data-user-id="219211">@Jack Wrenn</span>! <span aria-label="muscle" class="emoji emoji-1f4aa" role="img" title="muscle">:muscle:</span> <br>
If you'd rather go with a "conservatively handle <code>pub</code>-in-<code>priv</code> as <code>priv</code>" approach, then, for all means do so. I just suspect it will be quite hard to implement, and thus, <em>imho</em>, not worth the effort, given that it will pioneer such compiler logic (if we dismiss <code>rustdoc</code>). But that being said, it's true that this generic safe transmutation is quite novel as a whole, so "pioneering stuff" shouldn't be that surprising.</p>
<p>It does look like, whatever T-lang decides to go for, <strong>an RFC clarifying this will be necessary before any form of stabilization</strong>.</p>



<a name="266631971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266631971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266631971">(Jan 02 2022 at 20:40)</a>:</h4>
<p>Thank you so much for the kind words! <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="266632793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266632793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266632793">(Jan 02 2022 at 21:01)</a>:</h4>
<p>Yeahhhh, I don't think my <em>initial</em> support for visibility checking will handle the pub-in-priv situation. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="266884601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266884601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266884601">(Jan 05 2022 at 00:48)</a>:</h4>
<p>Does anyone know how to get the <code>Visibility</code> of an Adt from an <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/struct.AdtDef.html"><code>AdtDef</code></a>?</p>



<a name="266888503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/266888503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#266888503">(Jan 05 2022 at 01:52)</a>:</h4>
<p>Maybe TyCtx::visibility with the DefId? <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.visibility">https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.visibility</a><br>
(I have no idea, I just got that from <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/index.html?search=-%3E%20Visibility">https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/index.html?search=-%3E%20Visibility</a> )</p>



<a name="267940387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/267940387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#267940387">(Jan 13 2022 at 22:27)</a>:</h4>
<p>Visibility checking is now implemented! (The implementation unfortunately does not yet cover the pub-in-priv trick.) Some relevant tests: <a href="https://github.com/jswrenn/rust/blob/transmute/src/test/ui/transmutability/visibility/dst.rs">https://github.com/jswrenn/rust/blob/transmute/src/test/ui/transmutability/visibility/dst.rs</a></p>



<a name="267940980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/267940980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#267940980">(Jan 13 2022 at 22:33)</a>:</h4>
<p>It's kind of mind bending seeing some of the error messages right now (<code>the trait bound `dst_field_private::dst::Dst: BikeshedIntrinsicFrom&lt;dst_field_private::src::Src, dst_field_private::_::{closure#0}::Context, false, false, false, false&gt;` is not satisfied</code> <span aria-label="fear" class="emoji emoji-1f628" role="img" title="fear">:fear:</span>) but it seems like we have all the info we need already to make them actually pretty nice down the road!</p>



<a name="267941190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/267941190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#267941190">(Jan 13 2022 at 22:35)</a>:</h4>
<p>Better error messages are definitely on the horizon! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="267941270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/267941270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#267941270">(Jan 13 2022 at 22:35)</a>:</h4>
<p>Not trying to complain! It's really great seeing the progress here.</p>



<a name="267941394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/267941394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#267941394">(Jan 13 2022 at 22:36)</a>:</h4>
<p>it's so cool that it already works, awesome job Jack!</p>



<a name="267942490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/267942490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#267942490">(Jan 13 2022 at 22:46)</a>:</h4>
<p>I think my next task is going to be making transmutations involving references work. They're gonna be pretty tricky tho. <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="269684559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/269684559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Colin Rofls <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#269684559">(Jan 28 2022 at 04:16)</a>:</h4>
<p>Just popped in here to see how things were coming along and it's looking very encouraging, thank you to everyone involved, I'm excited to play around with this. :)</p>



<a name="277347075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277347075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jad Ghalayini <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277347075">(Mar 31 2022 at 22:13)</a>:</h4>
<p>Hello everyone! Bit of a dumb question but without a tracking issue as far as I can see, how can we check on the progress of this feature?</p>



<a name="277347730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277347730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277347730">(Mar 31 2022 at 22:20)</a>:</h4>
<p>Not a dumb question at all! I can think of two places you could keep an eye on:</p>
<ol>
<li><a href="https://github.com/rust-lang/lang-team/issues/21">**the lang-team has a tracking issue for project-safe-transmute.**</a> I try (and often forget, until I'm poked) to provide updates there.</li>
<li><a href="https://github.com/rust-lang/rust/pull/92268">**the initial implementation has a PR.**</a> this is where all the near-term action is going to happen.</li>
</ol>
<p>And, of course, y'all can feel free to ping me here.</p>



<a name="277347929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277347929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277347929">(Mar 31 2022 at 22:22)</a>:</h4>
<p>Unfortunately, I had to temporarily pause my work on the initial implementation of safe-transmute so I can finish up my PhD. My thesis defense is April 6 (less than a week away!), and I plan on picking work up again on it soon thereafter!</p>



<a name="277423761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277423761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jad Ghalayini <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277423761">(Apr 01 2022 at 14:10)</a>:</h4>
<p>Good luck with your thesis haha! Mine is 3 years away and I'm already stressed...<br>
Any way that I could help?</p>



<a name="277427921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277427921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277427921">(Apr 01 2022 at 14:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="219211">Jack Wrenn</span> <a href="#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277347929">said</a>:</p>
<blockquote>
<p>Unfortunately, I had to temporarily pause my work on the initial implementation of safe-transmute so I can finish up my PhD. My thesis defense is April 6 (less than a week away!), and I plan on picking work up again on it soon thereafter!</p>
</blockquote>
<p>Congratulations! Good luck! What's your dissertation topic?</p>



<a name="277540182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277540182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277540182">(Apr 02 2022 at 17:01)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>  You'll have to promise to not tell the IRB, but my dissertation centers on a longitudinal study of ego depletion in a postgraduate computing education researcher. The ecological validity of the experiment is unsurpassed, though I worry my committee might have gripes with the sample size. <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="277540277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216762-project-safe-transmute/topic/Implementation/near/277540277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/216762-project-safe-transmute/topic/Implementation.html#277540277">(Apr 02 2022 at 17:03)</a>:</h4>
<p>(In actuality, it's about motivating CS students to engage in example-writing <em>before</em> they dive into implementing programming assignments.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>