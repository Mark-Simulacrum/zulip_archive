<html>
<head><meta charset="utf-8"><title>`Rc` without the weak count? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html">`Rc` without the weak count?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278098402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278098402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278098402">(Apr 06 2022 at 23:09)</a>:</h4>
<p>Is there an alternative to <code>Rc</code> that is just like <code>Rc</code> but without the weak count? I have a suspicion (based on a single profile) that it could save a small but non-trivial amount of memory use in the compiler. Also, because the compiler already uses <code>Lrc</code> everywhere instead of <code>Rc</code>, if there is such a thing, changing the compiler to use it would be really easy.</p>



<a name="278099014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278099014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278099014">(Apr 06 2022 at 23:16)</a>:</h4>
<p>For just getting memory numbers, maybe you could change <code>Rc</code> to use <code>u32</code> instead of <code>usize</code>?  A quick scan suggests that might be a ≈8 line change.</p>



<a name="278100859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278100859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278100859">(Apr 06 2022 at 23:39)</a>:</h4>
<p><span class="user-mention" data-user-id="266526">@Jakub Beránek</span> Interested in trying this?  <code>deep-vector</code> is the benchmark that I would start with, I know it'll have a measurable effect there, esp. if you use DHAT and look at the <code>gmax</code> (global max == peak heap memory) numbers.</p>



<a name="278102090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278102090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278102090">(Apr 06 2022 at 23:56)</a>:</h4>
<p>If there are unforeseen complications of temporarily shrinking the field sizes, it might be easier to just temporarily duplicate <code>Rc</code> and then remove everything relating to the weak count</p>



<a name="278102235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278102235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278102235">(Apr 06 2022 at 23:58)</a>:</h4>
<p>there's <a href="https://crates.io/crates/strong_rc">https://crates.io/crates/strong_rc</a></p>



<a name="278102247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278102247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278102247">(Apr 06 2022 at 23:58)</a>:</h4>
<p>but it looks abandoned and unused</p>



<a name="278105693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278105693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278105693">(Apr 07 2022 at 00:53)</a>:</h4>
<p>it was an open question as of Rust 1.0 if the stdlib should support both an Rc that supports weak and an Rc that didn't support weak, so that you could take up less space if you didn't need weak refs. if this does show a significant effect then maybe it's worth adding it to std</p>



<a name="278118728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278118728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278118728">(Apr 07 2022 at 05:20)</a>:</h4>
<p>We could make weakness a generic parameter</p>



<a name="278123933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278123933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278123933">(Apr 07 2022 at 06:58)</a>:</h4>
<p>for <code>Lrc</code> maybe we could do both: a smaller width for the strong count and removing the weak count ?</p>



<a name="278124950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278124950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278124950">(Apr 07 2022 at 07:10)</a>:</h4>
<p>That will only help if the <code>T</code> within the <code>Lrc</code> has an alignment of 4 or less. I would guess that's not so common?</p>



<a name="278125106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278125106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278125106">(Apr 07 2022 at 07:12)</a>:</h4>
<p>ah yes unlikely</p>



<a name="278125125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278125125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278125125">(Apr 07 2022 at 07:13)</a>:</h4>
<p>(the quick test scott suggested looks to be around -1.6% on <code>deep-vector</code> at t-gmax)</p>



<a name="278127185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278127185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278127185">(Apr 07 2022 at 07:38)</a>:</h4>
<p>is <code>deep-vector</code> the most affected benchmark? if so, <code>-1.6%</code> doesn't sound that stellar. <span class="user-mention" data-user-id="120989">@nnethercote</span> do you want me to try something else?</p>
<p>On a slightly related note, I was also experimenting with using thinner versions of <code>Vec</code> and <code>Box&lt;[]&gt;</code> in places where the data doesn't grow in <code>rustdoc</code>. I suppose that there are more places in the compiler where this might make sense. But so far the results have been mostly underwhelming.</p>



<a name="278133269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278133269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278133269">(Apr 07 2022 at 08:42)</a>:</h4>
<p>Ok, 1.6% on deep-vector isn't great.</p>



<a name="278133302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278133302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278133302">(Apr 07 2022 at 08:43)</a>:</h4>
<p><span class="user-mention" data-user-id="266526">@Jakub Beránek</span> There is already this: <a href="https://github.com/rust-lang/rust/blob/b5da80871d5e22401e03ce5ed73200ece8bdc7a6/compiler/rustc_data_structures/src/thin_vec.rs#L9">https://github.com/rust-lang/rust/blob/b5da80871d5e22401e03ce5ed73200ece8bdc7a6/compiler/rustc_data_structures/src/thin_vec.rs#L9</a></p>



<a name="278133311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278133311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278133311">(Apr 07 2022 at 08:43)</a>:</h4>
<p>Which is a quick and dirty version</p>



<a name="278133330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278133330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278133330">(Apr 07 2022 at 08:43)</a>:</h4>
<p><a href="https://docs.rs/thin-vec/latest/thin_vec/">https://docs.rs/thin-vec/latest/thin_vec/</a> is a better version</p>



<a name="278133432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278133432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278133432">(Apr 07 2022 at 08:44)</a>:</h4>
<p>Might be worth replacing the compiler's sub-optimal ThinVec with the proper one</p>



<a name="278133748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278133748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278133748">(Apr 07 2022 at 08:47)</a>:</h4>
<p>I know, but in the <code>rustdoc</code> case, the vecs weren't usually empty, they just were immutable after build. So I was just trying to shorten the size from <code>24</code> (<code>Vec&lt;T&gt;</code>) bytes to <code>16</code>(<code>Box&lt;[T]&gt;</code>), and potentially to <code>8</code> (<code>Box&lt;TypeThatStoresSliceAndSizeOnHeap&gt;</code>).</p>



<a name="278134015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278134015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278134015">(Apr 07 2022 at 08:50)</a>:</h4>
<p>Ok, that sounds like a plan - trying to replace <code>rustc</code> thin_vec with the <code>thin_vec</code> crate. I'll try.</p>



<a name="278138996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278138996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> panstromek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278138996">(Apr 07 2022 at 09:42)</a>:</h4>
<p>Current ThinVec  in <code>rustc</code> allows for cheap converstion to/from Vec. <code>thinvec</code> crate doesn't, but it could be modified to support at least cheap <code>to_vec</code> and then almost-always-cheap <code>from_vec</code>, if the len+cap were stored at the end of the allocation (currently they are stored at the begining). There was a discussion about that some time ago. Not sure how relevant this is for <code>rustc</code>, though.</p>



<a name="278203513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278203513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278203513">(Apr 07 2022 at 18:02)</a>:</h4>
<p>I tried to convert it, out of the box it has a small negative effect (up to 1 % regression in icounts and memory). As <span class="user-mention" data-user-id="208862">@panstromek</span> mentioned, the conversions are not zero-cost, which might explain the regression. However, a more important fact is that <code>ThinVec</code> isn't used almost anywhere.. aside from one usage in rustdoc and one in some query diagnostics, the only real usage that I found is for attributes of expressions. And I guess that 99.9 % of all expressions don't have any attributes. So maybe first a more impactful change would be to actually try to find places where something like a <code>ThinVec</code> might be useful. It should basically be <code>Vec</code>s that are contained in things that are instantiated a lot of times and most of the time the <code>Vec</code> is empty. It would be useful to have some instrumentation framework to find these cases <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="278240381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278240381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278240381">(Apr 07 2022 at 23:41)</a>:</h4>
<p>Oh! Here's one I prepared earlier.</p>



<a name="278240389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278240389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278240389">(Apr 07 2022 at 23:41)</a>:</h4>
<p>You can do this with the "ad hoc profiling" feature of <code>dhat-rs</code>.</p>



<a name="278240450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278240450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278240450">(Apr 07 2022 at 23:42)</a>:</h4>
<p>Here's a diff where I used it to profile all the places where symbols were getting interned:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"></span>
<span class="n">index</span><span class="w"> </span><span class="n">ce3a3f5a3a2</span><span class="o">..</span><span class="mi">1972</span><span class="n">ae3e083</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span><span class="w"></span>
<span class="w"> </span><span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"dylib"</span><span class="p">]</span><span class="w"></span>

<span class="w"> </span><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="o">+</span><span class="n">dhat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/home/njn/dev/dhat-rs"</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">libc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.2"</span><span class="w"></span>
<span class="w"> </span><span class="n">atty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.2"</span><span class="w"></span>
<span class="w"> </span><span class="n">tracing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.1.28"</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">index</span><span class="w"> </span><span class="mi">6</span><span class="n">ff94341142</span><span class="o">..</span><span class="mi">6</span><span class="n">c8a1d8e14a</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">1354</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">1354</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">install</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">profiler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dhat</span>::<span class="n">Profiler</span>::<span class="n">builder</span><span class="p">().</span><span class="n">ad_hoc</span><span class="p">().</span><span class="n">trim_backtraces</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">8</span><span class="p">)).</span><span class="n">file_name</span><span class="p">(</span><span class="s">"/home/njn/rustc-ad-hoc.json"</span><span class="p">).</span><span class="n">build</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instant</span>::<span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">start_rss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_resident_set_size</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="n">init_rustc_env_logger</span><span class="p">();</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">1380</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="mi">1381</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">print_time_passes_entry</span><span class="p">(</span><span class="s">"total"</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">.</span><span class="n">elapsed</span><span class="p">(),</span><span class="w"> </span><span class="n">start_rss</span><span class="p">,</span><span class="w"> </span><span class="n">end_rss</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="o">+</span><span class="w">    </span><span class="nb">drop</span><span class="p">(</span><span class="n">profiler</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">process</span>::<span class="n">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"></span>
<span class="n">index</span><span class="w"> </span><span class="mi">781</span><span class="n">fb8c1e5d</span><span class="o">..</span><span class="mi">72</span><span class="n">b2a6d96bf</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"2021"</span><span class="w"></span>
<span class="w"> </span><span class="n">doctest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>

<span class="w"> </span><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
<span class="o">+</span><span class="n">dhat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/home/njn/dev/dhat-rs"</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">rustc_serialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../rustc_serialize"</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">rustc_macros</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../rustc_macros"</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="n">rustc_data_structures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"../rustc_data_structures"</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">symbol</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">symbol</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">index</span><span class="w"> </span><span class="mi">309</span><span class="n">c305293f</span><span class="o">..</span><span class="mi">1</span><span class="n">fcb50a9f48</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">symbol</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_span</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">symbol</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">1641</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">1641</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">n</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">     </span><span class="sd">/// Maps a string to its interned representation.</span>
<span class="w">     </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">intern</span><span class="p">(</span><span class="n">string</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="n">dhat</span>::<span class="n">ad_hoc_event</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="n">with_session_globals</span><span class="p">(</span><span class="o">|</span><span class="n">session_globals</span><span class="o">|</span><span class="w"> </span><span class="n">session_globals</span><span class="p">.</span><span class="n">symbol_interner</span><span class="p">.</span><span class="n">intern</span><span class="p">(</span><span class="n">string</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278240767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278240767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278240767">(Apr 07 2022 at 23:45)</a>:</h4>
<p>You can reuse most of this, but move the <code>dhat::ad_hoc_event(1)</code> call to the <code>drop</code> fn for <code>Vec</code>, <em>if the length is zero</em>.</p>



<a name="278240854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278240854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278240854">(Apr 07 2022 at 23:46)</a>:</h4>
<p>(This assumes that there aren't too many vecs that have a non-zero length and then get trimmed down to zero.)</p>



<a name="278240877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278240877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278240877">(Apr 07 2022 at 23:47)</a>:</h4>
<p>Then you'll get a profile that shows the locations most responsible for dropping empty vecs</p>



<a name="278319866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278319866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278319866">(Apr 08 2022 at 15:23)</a>:</h4>
<p>That's really cool! I was thinking of heavyweights solutions (Valgrind, Pin, LLVM instrumentation), but something simple like this might actually be enough. I hit a roadblock though, because depending on <code>dhat-rs</code> in <code>alloc</code> (where <code>Vec</code> is located) creates a cycle, since <code>dhat-rs</code> also depends on <code>alloc</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="278320317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278320317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278320317">(Apr 08 2022 at 15:27)</a>:</h4>
<p>But I suppose that I can just use backtrace manually and gather this data by some quick little hack.</p>



<a name="278321086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278321086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278321086">(Apr 08 2022 at 15:33)</a>:</h4>
<p>Hmm, <code>backtrace</code> can't be used in <code>no_std</code> environments easily. The plot thickens.</p>



<a name="278324154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278324154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278324154">(Apr 08 2022 at 15:55)</a>:</h4>
<p>Does anyone have an idea how to (easily) get a backtrace from inside the <code>alloc</code>crate?</p>



<a name="278325633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278325633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278325633">(Apr 08 2022 at 16:05)</a>:</h4>
<p>as a hack maybe you could define some public C function in std and then refer to it as extern function in alloc</p>



<a name="278325853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278325853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278325853">(Apr 08 2022 at 16:06)</a>:</h4>
<p>not sure if that'd work out at link time</p>



<a name="278377246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278377246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ahmed Charles <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278377246">(Apr 09 2022 at 00:28)</a>:</h4>
<p>You can define an <code>Option&lt;fn()&gt;</code> that exists in alloc that is called by code in alloc, but is assigned by code outside alloc.</p>



<a name="278422836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278422836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278422836">(Apr 09 2022 at 18:07)</a>:</h4>
<p><span class="user-mention" data-user-id="336395">@Ahmed Charles</span> thanks, that has worked! it seems that using <code>dhat</code> in the <code>Drop</code> of <code>Vec</code> is not a good idea though, the compilation then gets super slow (like waiting 5 minutes for first output from the compiler). but that should be solvable with another approach.</p>



<a name="278571609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60Rc%60%20without%20the%20weak%20count%3F/near/278571609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60Rc.60.20without.20the.20weak.20count.3F.html#278571609">(Apr 11 2022 at 15:31)</a>:</h4>
<p>Thanks for the hints, I managed to get the instrumentation working and put its description <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Rust.20instrumentation.20data/near/278571548">here</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>