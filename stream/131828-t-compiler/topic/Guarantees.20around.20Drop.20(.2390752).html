<html>
<head><meta charset="utf-8"><title>Guarantees around Drop (#90752) · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html">Guarantees around Drop (#90752)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261950334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950334">(Nov 18 2021 at 16:19)</a>:</h4>
<p>Continuing conversation from compiler team meeting</p>



<a name="261950366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950366">(Nov 18 2021 at 16:19)</a>:</h4>
<p><a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bweekly.5D.202021-11-18.20.2354818/near/261946969">https://rust-lang.zulipchat.com/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bweekly.5D.202021-11-18.20.2354818/near/261946969</a></p>



<a name="261950403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950403">(Nov 18 2021 at 16:19)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span> <span class="user-mention" data-user-id="303710">@Gary Guo</span> <span class="user-mention" data-user-id="116083">@pnkfelix</span></p>



<a name="261950500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950500">(Nov 18 2021 at 16:20)</a>:</h4>
<p>oh <span class="user-mention" data-user-id="123586">@nagisa</span> as well <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261950545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950545">(Nov 18 2021 at 16:20)</a>:</h4>
<p>Also <span class="user-mention" data-user-id="116118">@Matthew Jasper</span>, who wrote this, which I think is overly conservative.</p>
<blockquote>
<p>Not running destructors in Rust is safe even if it has a type that isn't 'static. std::mem::ManuallyDrop provides a wrapper to prevent a variable or field from being dropped automatically.</p>
</blockquote>



<a name="261950667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950667">(Nov 18 2021 at 16:21)</a>:</h4>
<p>The problem with thread-join and the root of the leakopalypse was values that <em>were exposed to API consumers</em>, like <code>JoinHandle</code>.</p>



<a name="261950826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950826">(Nov 18 2021 at 16:22)</a>:</h4>
<p>Is there discussion about this in the unsafe code guidelines WG or something?</p>



<a name="261950868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261950868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261950868">(Nov 18 2021 at 16:22)</a>:</h4>
<p>I've just literally never seen that take before <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261951012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951012">(Nov 18 2021 at 16:23)</a>:</h4>
<p>In contrast to things like</p>
<blockquote>
<p>unsafe code cannot rely on destructors to be run in order to be safe</p>
</blockquote>
<p>from the nomicon <a href="https://doc.rust-lang.org/nomicon/leaking.html">https://doc.rust-lang.org/nomicon/leaking.html</a></p>



<a name="261951014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951014">(Nov 18 2021 at 16:23)</a>:</h4>
<p>But if I construct something on the stack and I never expose it to users or call <code>forget</code> or otherwise leak it, we need to guarantee that it is dropped. Otherwise it becomes impossible (or maybe just very, very hard) to write panic-safe code.</p>



<a name="261951186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951186">(Nov 18 2021 at 16:24)</a>:</h4>
<p>Yeah, whether something is exposed or not makes a huge difference here.</p>



<a name="261951211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951211">(Nov 18 2021 at 16:24)</a>:</h4>
<p>The distinction is between what users are allowed to do, and what is <em>actually</em> done.</p>



<a name="261951351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951351">(Nov 18 2021 at 16:25)</a>:</h4>
<p>And our documentation is actively misleading here, presumably because the leakopalypse left a rather large cultural imprint on Rust developers</p>



<a name="261951492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951492">(Nov 18 2021 at 16:26)</a>:</h4>
<p>Ok. That doesn't seem unreasonable to me other than it's just literally undocumented as far as I can tell. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261951537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951537">(Nov 18 2021 at 16:27)</a>:</h4>
<p>As a guarantee we probably want to say that any local variables are guaranteed to be dropped if they are not moved.</p>



<a name="261951595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951595">(Nov 18 2021 at 16:27)</a>:</h4>
<p>It is documented in <a href="https://doc.rust-lang.org/reference/destructors.html#destructors">https://doc.rust-lang.org/reference/destructors.html#destructors</a> section.</p>



<a name="261951715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951715">(Nov 18 2021 at 16:28)</a>:</h4>
<p>That also says "Not running destructors in Rust is safe even if it has a type that isn't 'static."</p>



<a name="261951805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951805">(Nov 18 2021 at 16:29)</a>:</h4>
<p>The fact that destructor might not be ran means that <em>API design</em> must not depend on destructor is being ran, not that compiler can forget to drop anything.</p>



<a name="261951946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951946">(Nov 18 2021 at 16:30)</a>:</h4>
<p>(Probably could also reference <code>Pin</code> which does have additional guarantee)</p>



<a name="261951993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261951993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261951993">(Nov 18 2021 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261951805">said</a>:</p>
<blockquote>
<p>The fact that destructor might not be ran means that <em>API design</em> must not depend on destructor is being ran, not that compiler can forget to drop anything.</p>
</blockquote>
<p>I think there is consensus on this now. The issue is with the docs. I think <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> is right that the statement at the end is actively misleading, and should be amended.</p>



<a name="261952079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952079">(Nov 18 2021 at 16:30)</a>:</h4>
<p>Yeah, to be clear, I'm not arguing this isn't a bug, that rustc should forget to drop your values, we shouldn't fix this, etc.</p>



<a name="261952081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952081">(Nov 18 2021 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> what changed with <code>Pin</code>? Maybe we can add that too.</p>



<a name="261952145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952145">(Nov 18 2021 at 16:31)</a>:</h4>
<p>I'm just saying I've literally never seen this guaranteed before anywhere. And I've actually seen the opposite.</p>



<a name="261952192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952192">(Nov 18 2021 at 16:31)</a>:</h4>
<p>No, I understand <span class="user-mention silent" data-user-id="125250">Wesley Wiser</span>. I was quite surprised to see that section. I had read it long ago, but didn't internalize how aggressive it was.</p>



<a name="261952244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952244">(Nov 18 2021 at 16:31)</a>:</h4>
<p>So, what's the process to guarantee it?</p>



<a name="261952340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952340">(Nov 18 2021 at 16:32)</a>:</h4>
<p>Since this touches the Reference, it feels like a T-lang question to me.</p>



<a name="261952488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952488">(Nov 18 2021 at 16:33)</a>:</h4>
<p>Okay, should I ask over in their Zulip channel?</p>



<a name="261952491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952491">(Nov 18 2021 at 16:33)</a>:</h4>
<p><code>Pin</code> cannot have memory deallocated without calling destructor.</p>



<a name="261952581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952581">(Nov 18 2021 at 16:34)</a>:</h4>
<p>Or maybe just move this topic there? I don't think we have discussed anything compiler-specific</p>



<a name="261952599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952599">(Nov 18 2021 at 16:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261952081">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> what changed with <code>Pin</code>? Maybe we can add that too.</p>
</blockquote>
<p><code>Pin</code> has drop related guarantees related to movability/validity of data, but I don't see how "forgetting” to call a destructor changes the equation here in a meaningful way – the data doesn't get deallocated either way.</p>



<a name="261952656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952656">(Nov 18 2021 at 16:34)</a>:</h4>
<p>I'm also a bit interested how this interacts with unwinding but I need to think on that more.</p>



<a name="261952689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952689">(Nov 18 2021 at 16:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261952488">said</a>:</p>
<blockquote>
<p>Okay, should I ask over in their Zulip channel?</p>
</blockquote>
<p>Yeah, I think that would be a good way to start this topic.</p>



<a name="261952722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952722">(Nov 18 2021 at 16:35)</a>:</h4>
<p>I think a crucial action item here is to elaborate the <a href="https://doc.rust-lang.org/reference/destructors.html#not-running-destructors">https://doc.rust-lang.org/reference/destructors.html#not-running-destructors</a> section</p>



<a name="261952741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952741">(Nov 18 2021 at 16:35)</a>:</h4>
<p>If they're in agreement already then we may just need to make a PR to update the Reference and Nomicon.</p>



<a name="261952767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952767">(Nov 18 2021 at 16:35)</a>:</h4>
<p>Do <em>something</em> to spell out the boundaries of what the compiler guarantees vs what library authors <em>cannot</em> assume</p>



<a name="261952865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952865">(Nov 18 2021 at 16:36)</a>:</h4>
<p>(I am privately musing if this could benefit from a separate model, focused solely on this part of Rust’s operational semantics…)</p>



<a name="261952945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261952945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261952945">(Nov 18 2021 at 16:37)</a>:</h4>
<p>Such models can be really helpful when they are designed to work with SAT solvers to generate counter-examples to claims that look reasonable at first glance.</p>



<a name="261953163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953163">(Nov 18 2021 at 16:38)</a>:</h4>
<p>In that case we can just remove the confusing sentence.</p>



<a name="261953219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953219">(Nov 18 2021 at 16:38)</a>:</h4>
<p>Then library author cannot assume as a corollary to the fact that forgetting is safe.</p>



<a name="261953285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953285">(Nov 18 2021 at 16:39)</a>:</h4>
<p>I don’t want to remove the sentence until we have something to put in its place.</p>



<a name="261953515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953515">(Nov 18 2021 at 16:41)</a>:</h4>
<p>the leakpocalyspe didn’t come out of nowhere. Smart people who are Rust experts were designing very cool API’s that were, well, unsound.</p>



<a name="261953585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953585">(Nov 18 2021 at 16:41)</a>:</h4>
<p>but I also don’t think it will be too hard to figure out better language</p>



<a name="261953654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953654">(Nov 18 2021 at 16:42)</a>:</h4>
<p>I think the general idea is that arbitrary (unknown) code can forget safely, but you want to be able to rely on <em>known</em> code running destructors</p>



<a name="261953677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953677">(Nov 18 2021 at 16:42)</a>:</h4>
<p>and then guide people to when they need to do the various tricks like what Rayon and Crossbeam do, versus when they can rely on normal RAII patterns.</p>



<a name="261953696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953696">(Nov 18 2021 at 16:42)</a>:</h4>
<p>I mean we don't need anything normative in its place. We just need a informative note.</p>



<a name="261953907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953907">(Nov 18 2021 at 16:44)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="303710">@Gary Guo</span>'s point is that the reference is an accurate description of Rust's semantics with that line removed. Educating library authors is better accomplished through other means.</p>



<a name="261953941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953941">(Nov 18 2021 at 16:44)</a>:</h4>
<p>Don't we abort() if we panic while dropping in the middle of another panic?</p>



<a name="261953955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953955">(Nov 18 2021 at 16:44)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/81895">https://github.com/rust-lang/rust/issues/81895</a></p>



<a name="261953965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261953965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261953965">(Nov 18 2021 at 16:44)</a>:</h4>
<p>Obviously, we're not going to leak memory in this case</p>



<a name="261954010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954010">(Nov 18 2021 at 16:45)</a>:</h4>
<p>But if you're relying on Drop to do something external to the program, you're in for a bad time regardless of how your code looks.</p>



<a name="261954049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954049">(Nov 18 2021 at 16:45)</a>:</h4>
<p>Personally I look to the UCG and the book before I look at the reference, and <span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> indicates that this idea that the compiler can just not call <code>Drop</code> on a whim is pretty widespread.</p>



<a name="261954110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954110">(Nov 18 2021 at 16:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261953941">said</a>:</p>
<blockquote>
<p>Don't we abort() if we panic while dropping in the middle of another panic?</p>
</blockquote>
<p>That part should be in the reference, IMO.</p>



<a name="261954167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954167">(Nov 18 2021 at 16:46)</a>:</h4>
<p>(if it's not already)</p>



<a name="261954380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954380">(Nov 18 2021 at 16:47)</a>:</h4>
<p>Although I guess you have to document no_unwind as well.</p>



<a name="261954438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954438">(Nov 18 2021 at 16:48)</a>:</h4>
<p>Make it part of the language specification I mean</p>



<a name="261954455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954455">(Nov 18 2021 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261954049">said</a>:</p>
<blockquote>
<p>Personally I look to the UCG and the book before I look at the reference, and <span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> indicates that this idea that the compiler can just not call <code>Drop</code> on a whim is pretty widespread.</p>
</blockquote>
<p>I'm not sure I would describe it that way. Frankly the more concerning thing to me is that we seem to be relying on this in the standard library (rightly or wrongly) and I can't find anywhere we actually make this guarantee.</p>



<a name="261954587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954587">(Nov 18 2021 at 16:49)</a>:</h4>
<p>Especially given the fallout of the leakpocalypse, that just seemed <strong>wrong</strong> to me <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261954804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954804">(Nov 18 2021 at 16:50)</a>:</h4>
<p>The specification describes when local variables and temporaries are dropped, so I don't see why you can't rely on it? This seems altogether separate from the fact that leaking is safe.</p>



<a name="261954931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954931">(Nov 18 2021 at 16:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="352985">tm</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261954804">said</a>:</p>
<blockquote>
<p>The specification describes when local variables and temporaries are dropped, so I don't see why you can't rely on it? This seems altogether separate from the fact that leaking is safe.</p>
</blockquote>
<p>That's my understanding (modulo that last section that we've been discussing)</p>



<a name="261954995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261954995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261954995">(Nov 18 2021 at 16:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20.28.2390752.29/near/261954049">said</a>:</p>
<blockquote>
<p>Personally I look to the UCG and the book before I look at the reference, and <span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> indicates that this idea that the compiler can just not call <code>Drop</code> on a whim is pretty widespread.</p>
</blockquote>
<p>Its understandable why its widespread. Its very <em>simple</em> to just say “drop is best-effort”, even if that’s wildly <del>inaccurate</del> imprecise.</p>



<a name="261955171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261955171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261955171">(Nov 18 2021 at 16:52)</a>:</h4>
<p>So, once again, how do we</p>



<a name="261955290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261955290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261955290">(Nov 18 2021 at 16:52)</a>:</h4>
<ul>
<li>Achieve consensus within the Rust team</li>
<li>Publicize any conclusions we reach</li>
</ul>



<a name="261955823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261955823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261955823">(Nov 18 2021 at 16:55)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="116083">@pnkfelix</span> is right and the problematic section in my mind is the "Not running destructors" section. I think it needs to be updated to be more specific. To me it reads like all of the previous behavior is "best effort" when that is clearly not the case. Panics are not even really mentioned at all which is also surprising.</p>



<a name="261955887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261955887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261955887">(Nov 18 2021 at 16:56)</a>:</h4>
<p>panic-in-panic = abort is in some ways a language thing, since its a limitation imposed by what codegen we can possibly muster. But ideally I don't think we really want to make it a language spec thing and instead leave it up to implementation of the panic strategy.</p>



<a name="261956016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261956016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261956016">(Nov 18 2021 at 16:57)</a>:</h4>
<p>The thing with manual ways to make rust not run drop glue is that all of them except for bugs and <code>mem::forget</code> are a library/OS/real world realities.</p>



<a name="261956156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261956156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261956156">(Nov 18 2021 at 16:57)</a>:</h4>
<p>If that section is only referring to <code>std::mem::forget</code> and other such things (whether they live in the stdlib, 3rd party crates or user code) it should say that. Or if we're only guaranteeing destructors run for specific cases, it should say that.</p>



<a name="261956965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261956965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261956965">(Nov 18 2021 at 17:02)</a>:</h4>
<p>I wonder if changing "Not running destructors in Rust is safe" to "Calling <code>forget</code> is safe" (and downgrade it to a note) would suffice.</p>



<a name="261957168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261957168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261957168">(Nov 18 2021 at 17:03)</a>:</h4>
<p>I <em>feel</em> that the ambiguity arise from the overlap between the common sense of "safe" vs the Rust sense of "safe".</p>



<a name="261957687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261957687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261957687">(Nov 18 2021 at 17:06)</a>:</h4>
<p>Also <span class="user-mention" data-user-id="125250">@Wesley Wiser</span>, we've gotten a bit side-tracked here, but <a href="https://github.com/rust-lang/rust/issues/90718">#90718</a> (the fix for <a href="https://github.com/rust-lang/rust/issues/90752">#90752</a>) should really get on nightly ASAP.</p>



<a name="261957726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261957726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261957726">(Nov 18 2021 at 17:06)</a>:</h4>
<p>Agreed! I'll start reviewing today</p>



<a name="261957847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261957847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261957847">(Nov 18 2021 at 17:07)</a>:</h4>
<p>Maybe <span class="user-mention" data-user-id="116083">@pnkfelix</span> wants to take a look as well? Maybe they have an idea for how to do better</p>



<a name="261957864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261957864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261957864">(Nov 18 2021 at 17:07)</a>:</h4>
<p>Er, I assume you mean <a href="https://github.com/rust-lang/rust/issues/90788">#90788</a></p>



<a name="261957982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261957982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261957982">(Nov 18 2021 at 17:08)</a>:</h4>
<p>(let <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> keep it for now, things just got worse at my home )</p>



<a name="261958363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261958363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261958363">(Nov 18 2021 at 17:10)</a>:</h4>
<p>I submitted <a href="https://github.com/rust-lang/reference/pull/1107">https://github.com/rust-lang/reference/pull/1107</a></p>



<a name="261965849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261965849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261965849">(Nov 18 2021 at 18:01)</a>:</h4>
<p>Ah hah <a href="https://github.com/rust-lang/nomicon/issues/135">https://github.com/rust-lang/nomicon/issues/135</a></p>



<a name="261966025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Guarantees%20around%20Drop%20%28%2390752%29/near/261966025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Guarantees.20around.20Drop.20(.2390752).html#261966025">(Nov 18 2021 at 18:03)</a>:</h4>
<p>As usual Ralf has done a better job explaining the issue than I could have <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>