<html>
<head><meta charset="utf-8"><title>Stripping by default ? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html">Stripping by default ?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274951196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274951196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274951196">(Mar 11 2022 at 09:35)</a>:</h4>
<p>Hey everyone,</p>
<p>In recent discussions with <span class="user-mention" data-user-id="120989">@nnethercote</span> the topic of binary sizes and stripping came up, so we were wondering: what are everyone's thoughts on having stripping by default for builds that opt out of debuginfo (that is, <code>-Cstrip=debuginfo</code> when <code>-Cdebuginfo=0</code>) now that <code>-Cstrip</code> is on stable ? </p>
<p>I just tried a Hello World: it's 3.6MB, and we know most of this size comes from the stdlib's debuginfo (which is built at <code>-Cdebuginfo=2</code> IIRC). Does it seem sensible to strip that if one doesn't opt into having debuginfo at all ?  The binary is 364KB when stripped (303K with <code>-Cstrip=symbols</code> if someone wants to know the minimum size easily attainable when users need that).</p>
<p>That change would mean the standard library's frames in backtraces would lose their lineinfo, so it is a visible change. I'm not sure whether that information is used a lot in release builds for instance (maybe by sentry and similar crash reporting tools ? maybe they require users to have debuginfo turned on ?) or how useful it is in practice (but Hyrum's law makes it likely that someone is relying on that).</p>
<p>Is that something that would require an MCP or RFC ? Are there maybe other concerns that would make this default value inconvenient (possibly discussed elsewhere and that I've missed) ? The newly formed <code>wg-debugging</code> could have thoughts about this as well.</p>



<a name="274952360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274952360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274952360">(Mar 11 2022 at 09:46)</a>:</h4>
<p>I think an MCP would be the right level for gathering consensus. It does sound like a reasonable proposal to me.</p>



<a name="274956908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274956908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274956908">(Mar 11 2022 at 10:29)</a>:</h4>
<p>It's worth noting that the current behaviour is inconsistent in one way -- by default <code>std</code> gets debuginfo but nothing else does. This change would eliminate that inconsistency.</p>



<a name="274956998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274956998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274956998">(Mar 11 2022 at 10:30)</a>:</h4>
<p>(Oh, I see now that @lqd already said that)</p>



<a name="274958621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274958621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274958621">(Mar 11 2022 at 10:46)</a>:</h4>
<p>does stripping the binary every time add any significant amount of time to the compilation?</p>



<a name="274959081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274959081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274959081">(Mar 11 2022 at 10:51)</a>:</h4>
<p>@lqd: I think you said it made things slightly faster? (I'm not certain, but I think the stripping happens in memory, before things are written to disk.)</p>



<a name="274959205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274959205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274959205">(Mar 11 2022 at 10:52)</a>:</h4>
<p>I think the disk space effect is significant. It would avoid the case where a newcomer runs <code>rustc helloworld.rs</code>, sees the executable is 4MB and decides that "Rust sucks".</p>



<a name="274960013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274960013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274960013">(Mar 11 2022 at 11:00)</a>:</h4>
<p>For gcc/clang on non-macOS platforms and for wasm-ld we use the <code>--strip-debug</code>/<code>--strip-all</code> linker argument. For macOS we use a separate strip invocation. For msvc we use <code>/DEBUG:NONE</code>.</p>



<a name="274960109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274960109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274960109">(Mar 11 2022 at 11:00)</a>:</h4>
<p>If stripping is done as part of the linker invocation it should be faster as it can omit copying and relocating the debuginfo. If it is done as a separate command it is slower.</p>



<a name="274960205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274960205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274960205">(Mar 11 2022 at 11:01)</a>:</h4>
<p>I think cargo should default to <code>strip=debuginfo</code> if none of the crates are compiled with debuginfo. It shouldn't strip if something like <code>[profile.release.package.foo] debuginfo = 1</code> is used I think.</p>



<a name="274961136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274961136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274961136">(Mar 11 2022 at 11:11)</a>:</h4>
<p>Right, stripping definitely shouldn't happen if debuginfo is requested. But does Cargo need to be involved? This could be default behaviour for rustc.</p>



<a name="274961375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274961375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274961375">(Mar 11 2022 at 11:13)</a>:</h4>
<p>If the single crate for which debuginfo is requested is not the crate that is being linked, how would rustc distinguish between this and libstd having debuginfo that should be stripped? From the perspective of rustc, libstd is just a regular crate for which debuginfo was requested.</p>



<a name="274961397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274961397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274961397">(Mar 11 2022 at 11:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F/near/274959081">said</a>:</p>
<blockquote>
<p>@lqd: I think you said it made things slightly faster? (I'm not certain, but I think the stripping happens in memory, before things are written to disk.)</p>
</blockquote>
<p>yeah, slightly faster on the simpler debug scripts we've seen, like &lt;10% on <code>syn</code>'s IIRC. Within noise in general, regular crate compilation, on the builds I've seen (but haven't looked at projects with huge amounts of debuginfo, or a big number of crates to begin with).</p>



<a name="274961673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stripping%20by%20default%20%3F/near/274961673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stripping.20by.20default.20.3F.html#274961673">(Mar 11 2022 at 11:16)</a>:</h4>
<p>split debuginfo could also be related to this discussion</p>
<p>(and that msvc has external debuginfo, so windows should already have smaller executables by default thanks to that)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>