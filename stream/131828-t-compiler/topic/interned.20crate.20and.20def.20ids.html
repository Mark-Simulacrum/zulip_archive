<html>
<head><meta charset="utf-8"><title>interned crate and def ids · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html">interned crate and def ids</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276539884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276539884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276539884">(Mar 24 2022 at 21:09)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="133247">@bjorn3</span> </p>
<p>Starting a fresh discussion on replacing ids with something stable.</p>
<p>My idea was to intern the information that the id references at creation time. So a DefId now becomes an interned DefPath plus possibly even some other things that we normally have queries for. Similarly a CrateId could become an interned handle to the crate metadata. In the latter case this means it's somewhat mutable due to lazy loading, but I think we can make that work out.</p>
<p>This kind of interning avoids a lot of lookups. I'm not sure how much havoc it'll cause on incremental, but if we avoid putting spans into the interned values it should cause few unwanted invalidations.</p>



<a name="276540005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276540005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276540005">(Mar 24 2022 at 21:10)</a>:</h4>
<p>How is that different from what we already have?</p>



<a name="276540078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276540078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276540078">(Mar 24 2022 at 21:11)</a>:</h4>
<p>The incr comp issues with them are because we leak too much about the intern index itself. That is the order and the actual value.</p>



<a name="276540362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276540362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276540362">(Mar 24 2022 at 21:14)</a>:</h4>
<p>Do you mean using the same interner for all compilation sessions reusing the same incr cache? So holes are never filled?</p>



<a name="276541677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276541677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276541677">(Mar 24 2022 at 21:26)</a>:</h4>
<p>I we are going to remove ids, why not just replace DefId by DefPathHash and CrateNum by StableCrateId?</p>



<a name="276542092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276542092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276542092">(Mar 24 2022 at 21:30)</a>:</h4>
<p>Indexing with the hashes or stable ids requires hashmaps instead of vecs and may not be performant</p>



<a name="276593535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276593535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276593535">(Mar 25 2022 at 09:24)</a>:</h4>
<p>CrateNum, DefIndex, and DefId are basically already interning keys (that unfortunately leak their numeric values). So I think we could probably replace:</p>
<ul>
<li><code>CrateNum</code> with <code>type  CrateId = Interned&lt;(crate-name, disambiguation-info)&gt;</code></li>
<li><code>DefIndex/LocalDefId</code> with <code>type  LocalDefId = Interned&lt;DefPath&gt;</code></li>
<li><code>DefId</code> with <code>type DefId = Interned&lt;(CrateId, DefPath)&gt;</code></li>
</ul>
<p>Of course the interned value could also contain stable hashes to accelerate things. DefPath could be represented as pointers into a tree of DefKeys,  much like we already have in the DefPathTable now.</p>
<p>An approach to make this a bit more efficient could be to not use pointers, but <code>u32</code> IDs that stay <em>stable across compilation sessions</em> (as suggested <a href="https://hackmd.io/T1efvPvUTbSuiKD3mKhvuA#Make-pointer-like-IDs-stable-across-compilation-session-boundaries-STABLE_IDS">here</a>). That would effectively turn interning IDs into constants as far as incr. comp. is concerned, and we would not have to worry about them not implementing Ord or hashing their numeric values verbatim.</p>



<a name="276593991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276593991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276593991">(Mar 25 2022 at 09:29)</a>:</h4>
<blockquote>
<p>CrateNum with type  CrateId = Interned&lt;(crate-name, disambiguation-info)&gt;</p>
</blockquote>
<p>Technically that is missing <code>is-exe</code>: <a href="https://github.com/rust-lang/rust/blob/8a0c55046c7092d9e019dad03729e8d32e38df72/compiler/rustc_span/src/def_id.rs#L152">https://github.com/rust-lang/rust/blob/8a0c55046c7092d9e019dad03729e8d32e38df72/compiler/rustc_span/src/def_id.rs#L152</a></p>



<a name="276594815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276594815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276594815">(Mar 25 2022 at 09:38)</a>:</h4>
<p>that would be part of "disambiguation-info"</p>



<a name="276594960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276594960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276594960">(Mar 25 2022 at 09:40)</a>:</h4>
<p>please read the above as pseudo-code :) It's meant more as a conceptual sketch rather than a strict definition of what I think it could look like.</p>



<a name="276595061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595061">(Mar 25 2022 at 09:41)</a>:</h4>
<p>I also think that it might be a good idea to switch to a regular, pointer-based interning approach before trying out the persistent IDs optimization on top of it.</p>



<a name="276595187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595187">(Mar 25 2022 at 09:43)</a>:</h4>
<p>the advantage of something using pointers, in my opinion, is that it is much more clear that one mustn't fingerprint or persist their numerical values, whereas currently that can happen quite easily by accident.</p>



<a name="276595351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595351">(Mar 25 2022 at 09:45)</a>:</h4>
<p>Both pointer based interning and persistent IDs suffer from the fact that their values are not dense and thus any map keyed by them needs to be a hashmap and not an IndexVec as is currently the case.</p>



<a name="276595360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595360">(Mar 25 2022 at 09:45)</a>:</h4>
<p>If we start with DefId we don't even have the issue of size changes</p>



<a name="276595435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595435">(Mar 25 2022 at 09:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids/near/276595351">said</a>:</p>
<blockquote>
<p>Both pointer based interning and persistent IDs suffer from the fact that their values are not dense and thus any map keyed by them needs to be a hashmap and not an IndexVec as is currently the case.</p>
</blockquote>
<p>That is true. I'm not sure, however, how much of an actual perf impact that has.</p>



<a name="276595628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595628">(Mar 25 2022 at 09:48)</a>:</h4>
<p>At least for persistent IDs, we might win back quite a bit of performance in some cases because we can fingerprint the much smaller values verbatim, without having to look up their corresponding stable version.</p>



<a name="276595911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595911">(Mar 25 2022 at 09:51)</a>:</h4>
<p>That would make incr comp less deterministic though as it now depends on the edit history.</p>



<a name="276595980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595980">(Mar 25 2022 at 09:51)</a>:</h4>
<p>While currently it is a pure function from input to incr comp cache. (ignoring all bugs)</p>



<a name="276595986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276595986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276595986">(Mar 25 2022 at 09:51)</a>:</h4>
<p>Yes, that is the major concern here. It does make me uneasy</p>



<a name="276596065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276596065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276596065">(Mar 25 2022 at 09:52)</a>:</h4>
<p>I think it's the main reason why we didn't do it from the beginning</p>



<a name="276596120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276596120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276596120">(Mar 25 2022 at 09:53)</a>:</h4>
<p>of course back then we didn't anticipate how much trouble the current approach would cause :)</p>



<a name="276596148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276596148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276596148">(Mar 25 2022 at 09:53)</a>:</h4>
<p>Also aren't a large part of the issues caused by spans which your proposal says nothing about?</p>



<a name="276596228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276596228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276596228">(Mar 25 2022 at 09:54)</a>:</h4>
<p>spans are a separate problem, yes</p>



<a name="276596613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/276596613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#276596613">(Mar 25 2022 at 09:58)</a>:</h4>
<p>Another potential problem with persistent IDs is that there still would need to be some translation while importing them from upstream crates. That could turn out to be a source of bugs.</p>



<a name="277114767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/277114767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#277114767">(Mar 30 2022 at 09:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids/near/276593535">said</a>:</p>
<blockquote>
<p>An approach to make this a bit more efficient could be to not use pointers, but <code>u32</code> IDs that stay <em>stable across compilation sessions</em> (as suggested <a href="https://hackmd.io/T1efvPvUTbSuiKD3mKhvuA#Make-pointer-like-IDs-stable-across-compilation-session-boundaries-STABLE_IDS">here</a>). That would effectively turn interning IDs into constants as far as incr. comp. is concerned, and we would not have to worry about them not implementing Ord or hashing their numeric values verbatim.</p>
</blockquote>
<p>Upon further reflection, I think the additional "Persistent IDs" optimization is probably too risky because of the issues already mentioned: (1) the results of incr. comp. will depend on the complete history of compilation sessions, and (2) there's risk of accidentally using IDs from upstream crates verbatim instead of translating them.</p>
<p>However, making IDs interned pointers to something stable, as suggested initially, still seems like something that's definitely worth a try, in my opinion.</p>



<a name="277116114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/277116114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#277116114">(Mar 30 2022 at 09:21)</a>:</h4>
<p>I'll start an experiment with DefId then</p>



<a name="277117364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/277117364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#277117364">(Mar 30 2022 at 09:32)</a>:</h4>
<p>I'm wondering if CrateNum would be easier</p>



<a name="277117525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/277117525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#277117525">(Mar 30 2022 at 09:33)</a>:</h4>
<p>but with DefId you don't have to worry about data type size and indices being contiguous, so nevermind :)</p>



<a name="277119268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/interned%20crate%20and%20def%20ids/near/277119268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/interned.20crate.20and.20def.20ids.html#277119268">(Mar 30 2022 at 09:50)</a>:</h4>
<p>Yea ^^ also if cratenum gets a lifetime, so must DefId, so the annoying part of the work needs to be done anyway</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>