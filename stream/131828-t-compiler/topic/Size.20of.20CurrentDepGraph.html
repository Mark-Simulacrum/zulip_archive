<html>
<head><meta charset="utf-8"><title>Size of CurrentDepGraph · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html">Size of CurrentDepGraph</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262897580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262897580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mike Hommey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262897580">(Nov 27 2021 at 23:03)</a>:</h4>
<p>Does 264MiB sound a lot for an allocation for the rehash of one shard of CurrentDepGraph's new_node_to_index?</p>



<a name="262897746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262897746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262897746">(Nov 27 2021 at 23:07)</a>:</h4>
<p>Which crate are you compiling?</p>



<a name="262898609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262898609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mike Hommey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262898609">(Nov 27 2021 at 23:30)</a>:</h4>
<p>style (from Firefox)</p>



<a name="262898624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262898624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mike Hommey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262898624">(Nov 27 2021 at 23:31)</a>:</h4>
<p>(and I don't know if that's the max size, because it's on a 32-bits platform, and the process is aborted for OOM on that allocation)</p>



<a name="262898630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262898630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mike Hommey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262898630">(Nov 27 2021 at 23:31)</a>:</h4>
<p>(and the point the process OOMs, it has (only) 1.3G RSS)</p>



<a name="262941798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262941798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262941798">(Nov 28 2021 at 18:32)</a>:</h4>
<p>The DepGraph can get massive for large crates. According to perf tracking, the typical on-disk size of the DepGraph for a check build of style is ~126 MB. This on-disk size is ~30% smaller than the in-memory version. Since <code>new_node_to_index</code> only contains part of the information in the DepGraph, I'd say that 264 MB seems like a bit much, but not excessively so. The overallocation for a rehash could explain the size.</p>



<a name="262941971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262941971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262941971">(Nov 28 2021 at 18:36)</a>:</h4>
<p>2.5 million nodes x 22 bytes per node (16 for the fingerprint, 2 for the DepKind, 4 for the DepNodeIndex), seems about right.</p>



<a name="262943894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262943894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262943894">(Nov 28 2021 at 19:20)</a>:</h4>
<p>Is it actually 22 bytes, or is there padding in there?</p>



<a name="262954666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Size%20of%20CurrentDepGraph/near/262954666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Size.20of.20CurrentDepGraph.html#262954666">(Nov 28 2021 at 23:34)</a>:</h4>
<p>DepNode uses a PackedFingerprint to avoid padding. I don't know if there is padding between the DepNodes and between the DepNode and the DepNodeIndex in the hash map layout.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>