<html>
<head><meta charset="utf-8"><title>What to do with trivially-false trivial_bounds · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html">What to do with trivially-false trivial_bounds</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273188912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273188912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273188912">(Feb 25 2022 at 04:54)</a>:</h4>
<p>So <code>#![feature(trivial_bounds)]</code> allows us to declare both trivially true or <strong>trivially false</strong> bounds on items...</p>



<a name="273188918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273188918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273188918">(Feb 25 2022 at 04:54)</a>:</h4>
<p>The latter are problematic, because during codegen (or on the way to codegen, like mir_opt), we <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/codegen.rs#L54">ICE</a> if we cannot resolve a trait bound.</p>



<a name="273188921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273188921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273188921">(Feb 25 2022 at 04:54)</a>:</h4>
<p>I'm trying to solve <a href="https://github.com/rust-lang/rust/issues/93008">#93008</a> (which I thought I fixed in <a href="https://github.com/rust-lang/rust/issues/93024">#93024</a>, but did only partially, and the solution was kinda a hack), but the "right" thing to do is kinda up for debate.</p>



<a name="273188923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273188923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273188923">(Feb 25 2022 at 04:54)</a>:</h4>
<p>So, what do we want to do with trivial bounds if they get to codegen?</p>



<a name="273189243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273189243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273189243">(Feb 25 2022 at 05:00)</a>:</h4>
<p>I guess we can:</p>
<ol>
<li>Only raise an error if that bound is used in a meaningful way (e.g. a method call relies on it)</li>
<li>Always raise an error (perhaps lint against false trivial-bounds before we get to codegen)</li>
<li>Make <code>codegen_fulfill_obligation</code> (where we see ICEs) fallible so we can handle unsatisfiable trivial bounds some other way (?!)</li>
<li>??</li>
</ol>



<a name="273193018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273193018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273193018">(Feb 25 2022 at 06:18)</a>:</h4>
<p>He original example shouldn't compile, right? The bound never holds so the function is not well formes</p>



<a name="273193122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273193122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273193122">(Feb 25 2022 at 06:20)</a>:</h4>
<p>The opt example is more interesting, it should compile, but doesn't after inlining, suggesting to me that we lose the information that allows us to prove it during inlining. Are we inlining param envs into parent param envs during inlining? Do we have to because some part of rustc isn't smart enough to figure things out without a hint?</p>



<a name="273193205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273193205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273193205">(Feb 25 2022 at 06:22)</a>:</h4>
<p>I think we'll want 2, but actually error earlier in well-formendness?</p>



<a name="273195308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273195308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273195308">(Feb 25 2022 at 07:05)</a>:</h4>
<p>It was my understanding that <code>trivial_bounds</code> bounds exists to allow functions with unsatisfied bounds to compile, as long as function isn't actually called.</p>
<p>The had been a similar issue in a constant propagation pass which at the time was resolved by checking for unsatisfiable predicates with <code>impossible_predicates</code> and skipping the optimization. Maybe this approach could be extended to cover the complete MIR optimization phase?</p>



<a name="273195884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273195884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273195884">(Feb 25 2022 at 07:16)</a>:</h4>
<p>yeah, i think it might be easiest to just skip optimization altogether if there are unsatisfiable predicates..</p>



<a name="273196066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273196066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273196066">(Feb 25 2022 at 07:19)</a>:</h4>
<p>the example I gave in <a href="https://github.com/rust-lang/rust/issues/93008">#93008</a> that doesn’t require trivial_bounds actually ICEs _during_ inlining, not after</p>



<a name="273196121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273196121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273196121">(Feb 25 2022 at 07:20)</a>:</h4>
<p>this is because we erase regions while evaluating things during the inlining pass, and that plus ParamEnv being RevealAll causes the unsatisfiable predicate (that was parameterized over 'a) to look like it’s global (since it now references ReErased), and thus be evaluated with an empty ParamEnv</p>



<a name="273203270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273203270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273203270">(Feb 25 2022 at 08:58)</a>:</h4>
<p>Maybe we should keep ICEing, but stop requesting optimized mir for functions that have unsatisfiable bounds, thus avoiding the ICE and the work</p>



<a name="273203485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/What%20to%20do%20with%20trivially-false%20trivial_bounds/near/273203485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/What.20to.20do.20with.20trivially-false.20trivial_bounds.html#273203485">(Feb 25 2022 at 09:00)</a>:</h4>
<p>Side question: is this all easier with chalk as it may emit a wf error?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>