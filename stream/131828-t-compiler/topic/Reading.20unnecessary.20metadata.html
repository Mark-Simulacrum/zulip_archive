<html>
<head><meta charset="utf-8"><title>Reading unnecessary metadata · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html">Reading unnecessary metadata</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270651989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270651989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270651989">(Feb 04 2022 at 00:57)</a>:</h4>
<p>I've noticed this sequence happening a lot in <code>find_library_crate</code>.</p>
<ul>
<li>We're searching for the file for <code>std</code>.</li>
<li>There are two candidates in the directory: <code>libstd_detect-8d6701fb958915ad.rlib</code>, <code>libstd-f3ab5b1dea981f17.rlib</code>.</li>
<li>The first one is clearly not a match, but the search just checks for the prefix <code>libstd</code> and the suffix <code>.rlib</code> and decides they are both candidates.</li>
<li>We read metadata for the first one, see that it's a mismatch, and ignore it.</li>
<li>We read metadata for the second one and succeed.</li>
</ul>



<a name="270652329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270652329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270652329">(Feb 04 2022 at 01:01)</a>:</h4>
<p>I want to avoid reading the <code>libstd_detect</code> rlib, but I'm having trouble seeing how to do it safely. Usually, the bit after the <code>libstd</code> should have the form <code>-&lt;hex-id&gt;</code>, but that <code>-&lt;hex-id&gt;</code> comes from the <code>--extra-filename</code> option and so could take any form.</p>



<a name="270653479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270653479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270653479">(Feb 04 2022 at 01:15)</a>:</h4>
<p>Given that most crates use <code>std</code>, AFAICT we're unnecessarily reading <code>libstd_detect-$ID.rlib</code> for most crates, and it's a 400KB file on my Linux box.</p>



<a name="270653537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270653537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270653537">(Feb 04 2022 at 01:16)</a>:</h4>
<p>So that seems like a non-trivial amount of wasted I/O</p>



<a name="270653818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270653818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270653818">(Feb 04 2022 at 01:20)</a>:</h4>
<p>Instead of checking for a prefix match, could it collect the leading characters <code>[a-z_]+</code> of the filename, and then compare for an equality match?</p>



<a name="270654412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270654412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270654412">(Feb 04 2022 at 01:27)</a>:</h4>
<p>potentially 'easy' option: could we just rename libstd_detect to not have a libstd prefix?</p>



<a name="270654510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270654510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270654510">(Feb 04 2022 at 01:28)</a>:</h4>
<p>I guess it's a <a href="http://crates.io">crates.io</a> library (<a href="https://docs.rs/std_detect/latest/std_detect/">https://docs.rs/std_detect/latest/std_detect/</a>) but I <em>think</em> Cargo supports arbitrarily naming the actual rlib with a [lib] section, regardless of the package name?</p>



<a name="270654608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270654608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270654608">(Feb 04 2022 at 01:29)</a>:</h4>
<p>That might not be a great solution in general (e.g., I imagine there's a similarish problem with serde_{json,derive,...} and serde, but it seems like it might work OK for this specific case</p>



<a name="270655446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270655446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270655446">(Feb 04 2022 at 01:37)</a>:</h4>
<p>I'd certainly prefer a general solution if possible. But the fact that <code>--extra-filename</code> can have anything in it (even if that more or less never happens in practice) makes it hard <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="270655754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270655754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270655754">(Feb 04 2022 at 01:39)</a>:</h4>
<p>TIL <code>rustc -Cextra-filename=foobar a.rs</code> produces an executable called <code>afoobar</code>.</p>



<a name="270655883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270655883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270655883">(Feb 04 2022 at 01:40)</a>:</h4>
<p><span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span>  Oh, I thought the <code>-</code> was added by rustc. That indeed adds a wrinkle.</p>



<a name="270655910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270655910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270655910">(Feb 04 2022 at 01:40)</a>:</h4>
<p><code>libstd</code> is actually an unusual case. Normally we're looking for a crate name + suffix combination like <code>addr2line-176a3e84acbe6734</code>, and it's an exact match (modulo the <code>lib</code> at start and <code>.rlib</code> at the end)</p>



<a name="270655951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270655951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270655951">(Feb 04 2022 at 01:41)</a>:</h4>
<p>Yeah, I see in Cargo's output stuff like <code>-C extra-filename=-48fd7f9efcc4e9e5</code></p>



<a name="270656134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270656134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270656134">(Feb 04 2022 at 01:43)</a>:</h4>
<p>Even doing something ultra-dumb but simple, like hardwiring it to skip over <code>std_detect</code> when searching for <code>std</code>, possibly falls down in the obscure corner case where someone uses <code>-C extra-filename=_detect-ABCD</code>...</p>



<a name="270658910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270658910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270658910">(Feb 04 2022 at 02:15)</a>:</h4>
<p>I tried exactly that hardwired check. On <code>helloworld</code>, which is affected, it reduced the number of instructions executed by a mere ~20,000 instructions, out of about 45M.</p>



<a name="270659013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270659013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270659013">(Feb 04 2022 at 02:16)</a>:</h4>
<p>The comments in <code>locator.rs</code> say "reading metadata is quite slow" but this result suggests otherwise. 20,000 instructions to read metadata from a 400KB rlib seems remarkably little to me.</p>



<a name="270683489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270683489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270683489">(Feb 04 2022 at 08:40)</a>:</h4>
<p>Maybe try an exact match first and only look at the prefix ones if that doesn't work out?</p>



<a name="270703998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270703998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270703998">(Feb 04 2022 at 11:54)</a>:</h4>
<p>We use <code>mmap</code> not <code>read</code> for getting the crate metadata, so only a couple of pages worth of data is actually read. It needs to read the ar archive member headers until <code>lib.rmeta</code>, the header of the <code>lib.rmeta</code> file to check the rustc version and get the crate root offset and then the crate root to get the actual Svh.</p>



<a name="270705006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270705006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270705006">(Feb 04 2022 at 12:04)</a>:</h4>
<p>the mmap manipulation costs are not trivial in some circumstances. UI and rustdoc tests spawn a lot of shortlived rustc instances and the mmap and process teardown spend a few percent in the kernel just doing memory stuff. So if we could avoid mmaping the rlib in the first place it could still save some overhead in those scenarios. For big-and-slow compilation scenarios like rustc itself it won't make much of a difference though.</p>



<a name="270839271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270839271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270839271">(Feb 05 2022 at 17:36)</a>:</h4>
<p>Put the library names into a vector and sort them with a predicate saying how likely entries are to match what's being looked for?</p>



<a name="270839361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270839361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270839361">(Feb 05 2022 at 17:38)</a>:</h4>
<p>Faulting the pages into memory can be quite expensive, files more so, even if its just a few.</p>



<a name="270839373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Reading%20unnecessary%20metadata/near/270839373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Reading.20unnecessary.20metadata.html#270839373">(Feb 05 2022 at 17:38)</a>:</h4>
<p>but since this is only happening for 1 crate once per compilation, the overhead is probably quite minimal overall.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>