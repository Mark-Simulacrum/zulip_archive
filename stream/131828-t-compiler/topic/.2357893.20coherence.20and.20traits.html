<html>
<head><meta charset="utf-8"><title>#57893 coherence and traits · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html">#57893 coherence and traits</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="169073560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169073560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169073560">(Jun 26 2019 at 19:45)</a>:</h4>
<p>hi @RalfJung</p>



<a name="169073608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169073608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169073608">(Jun 26 2019 at 19:46)</a>:</h4>
<p>what do you mean by "assuming coherence" exactly</p>



<a name="169073651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169073651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169073651">(Jun 26 2019 at 19:46)</a>:</h4>
<p>It seems like a basic rule of Rust that we want to keep that it is possible to follow impls. e.g., with IntoIterator, you really want typeck to be able to assume that &lt;T as IntoIterator&gt;::Item = U := T: Iterator, &lt;T as Iterator&gt;::Item = U.</p>



<a name="169077447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169077447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169077447">(Jun 26 2019 at 20:34)</a>:</h4>
<p>(pinging <span class="user-mention" data-user-id="120791">@RalfJ</span> so he sees this ^)</p>



<a name="169078849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169078849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169078849">(Jun 26 2019 at 20:53)</a>:</h4>
<blockquote>
<p>It seems like a basic rule of Rust that we want to keep that it is possible to follow impls. e.g., with IntoIterator, you really want typeck to be able to assume that &lt;T as IntoIterator&gt;::Item = U := T: Iterator, &lt;T as Iterator&gt;::Item = U.</p>
</blockquote>
<p>that's exactly what I mean by "exploiting coherence"</p>



<a name="169078861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169078861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169078861">(Jun 26 2019 at 20:53)</a>:</h4>
<p>it's very useful and very subtle and makes analysis very complicated</p>



<a name="169078895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169078895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169078895">(Jun 26 2019 at 20:53)</a>:</h4>
<p>which is why I wrote</p>
<blockquote>
<p>But there's likely already tons of code out there that exploits this.</p>
</blockquote>



<a name="169078900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169078900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169078900">(Jun 26 2019 at 20:53)</a>:</h4>
<p>so this is likely a moot point</p>



<a name="169078953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169078953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169078953">(Jun 26 2019 at 20:54)</a>:</h4>
<p>but if this were pre-1.0 I would argue fiercly against doing what we are doing ;)</p>



<a name="169079013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169079013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169079013">(Jun 26 2019 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> <span class="user-mention" data-user-id="126804">@Ariel Ben-Yehuda</span>   (also keep pinging me, I have t-compiler muted because there is too much traffic and Zulip does not support unmuting just one topic in a stream)<br>
(also who is the real ariel?^^)</p>



<a name="169079734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169079734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169079734">(Jun 26 2019 at 21:03)</a>:</h4>
<p>Haskell does allow something similar:</p>
<div class="codehilite"><pre><span></span><span class="cm">{-# LANGUAGE TypeFamilies, MultiParamTypeClasses, FlexibleInstances #-}</span>

<span class="kr">class</span> <span class="kt">Object</span> <span class="n">t</span> <span class="n">u</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Output</span> <span class="n">t</span> <span class="n">u</span> <span class="ow">::</span> <span class="o">*</span>

<span class="kr">instance</span> <span class="kt">Object</span> <span class="n">t</span> <span class="n">u</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Output</span> <span class="n">t</span> <span class="n">u</span> <span class="ow">=</span> <span class="n">u</span>

<span class="nf">foo</span> <span class="ow">::</span> <span class="kt">Output</span> <span class="n">t</span> <span class="n">u</span> <span class="ow">-&gt;</span> <span class="n">u</span>
<span class="nf">foo</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">x</span>
</pre></div>



<a name="169081207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081207">(Jun 26 2019 at 21:20)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> <br>
I accidentally created a new zulip account. Probably a github vs. google login problem.</p>



<a name="169081334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081334">(Jun 26 2019 at 21:21)</a>:</h4>
<blockquote>
<p>it's very useful and very subtle and makes analysis very complicated</p>
</blockquote>
<p>I think it's hard to work with associated types without this</p>



<a name="169081506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081506">(Jun 26 2019 at 21:23)</a>:</h4>
<p>unless there is some restricted version of this rule that works, I don't see how you could use associated types in a generic context otherwise</p>



<a name="169081633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081633">(Jun 26 2019 at 21:24)</a>:</h4>
<p>you just have to state the assumptions you are making?</p>



<a name="169081642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081642">(Jun 26 2019 at 21:24)</a>:</h4>
<p>on the function?</p>



<a name="169081655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081655">(Jun 26 2019 at 21:24)</a>:</h4>
<p>we would have stabilized equality constraints much sooner in that alternative universe ;)</p>



<a name="169081657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081657">(Jun 26 2019 at 21:24)</a>:</h4>
<p>but then you can't use "new" associated types</p>



<a name="169081676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081676">(Jun 26 2019 at 21:25)</a>:</h4>
<p><span class="user-mention" data-user-id="126931">@centril</span> wait doesnt haskell also have a flag to allow overlapping instances...?</p>



<a name="169081704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081704">(Jun 26 2019 at 21:25)</a>:</h4>
<p>consider that <code>T: Sized</code> is a bound</p>



<a name="169081706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081706">(Jun 26 2019 at 21:25)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> not sure what you mean</p>



<a name="169081721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081721">(Jun 26 2019 at 21:25)</a>:</h4>
<p>I mean, suppose you have a function that takes a generic <code>T</code></p>



<a name="169081729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081729">(Jun 26 2019 at 21:25)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> Yeah but don't ever use it</p>



<a name="169081733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081733">(Jun 26 2019 at 21:25)</a>:</h4>
<p>it needs to be able to evaluate <code>&lt;Vec&lt;T&gt; as IntoIterator&gt;::Item</code></p>



<a name="169081795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081795">(Jun 26 2019 at 21:26)</a>:</h4>
<p>or <code>&lt;slice::Iter&lt;'a, T&gt; as IntoIterator&gt;::Item</code></p>



<a name="169081801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081801">(Jun 26 2019 at 21:26)</a>:</h4>
<p>that's an opaque type at that point</p>



<a name="169081830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081830">(Jun 26 2019 at 21:26)</a>:</h4>
<p>if you couldn't do <code>&lt;Vec&lt;T&gt; as IntoIterator&gt;::Item = T</code>, then <code>IntoIterator</code> wouldn't be very useful</p>



<a name="169081839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081839">(Jun 26 2019 at 21:26)</a>:</h4>
<p>I mean, for a generic <code>T: Sized</code></p>



<a name="169081860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081860">(Jun 26 2019 at 21:27)</a>:</h4>
<p>then add that as a <code>where</code> clause</p>



<a name="169081882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081882">(Jun 26 2019 at 21:27)</a>:</h4>
<p><em>every function</em> that takes a <code>T: Sized</code> also needs a <code>&lt;Vec&lt;T&gt; as IntoIterator&gt;::Item = T</code> where-clause?</p>



<a name="169081909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081909">(Jun 26 2019 at 21:27)</a>:</h4>
<p>(that's what someone else suggested in the thread, basically interpret our current scheme as adding all those <code>where</code> clauses implicitly)</p>



<a name="169081913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081913">(Jun 26 2019 at 21:27)</a>:</h4>
<p>I suppose you'll also want a <code>Vec&lt;Option&lt;T&gt;&gt; as IntoIterator&gt;::Item = Option&lt;T&gt;</code></p>



<a name="169081978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169081978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169081978">(Jun 26 2019 at 21:28)</a>:</h4>
<p>that would be a very complicated family of where-clauses</p>



<a name="169082016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082016">(Jun 26 2019 at 21:28)</a>:</h4>
<p>hm I see, you are saying that constraint would have to bubble up way beyond the code that actually does the iteration</p>



<a name="169082018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082018">(Jun 26 2019 at 21:28)</a>:</h4>
<p>I mean, if you couldn't reduce it to "where all the impls in this crate hold"</p>



<a name="169082031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082031">(Jun 26 2019 at 21:29)</a>:</h4>
<p>which is the state we have today :-)</p>



<a name="169082184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082184">(Jun 26 2019 at 21:31)</a>:</h4>
<p>so maybe this is less practical than I thought...</p>



<a name="169082196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082196">(Jun 26 2019 at 21:31)</a>:</h4>
<p>I mean, you could prohibit associated types in structs</p>



<a name="169082202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082202">(Jun 26 2019 at 21:31)</a>:</h4>
<p>*in item fields</p>



<a name="169082228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082228">(Jun 26 2019 at 21:31)</a>:</h4>
<p>but the alternative seems to be to consider the implicit <code>impl Trait for dyn Trait</code> a real impl in terms of coherence, which would reject plenty of generic impls</p>



<a name="169082302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082302">(Jun 26 2019 at 21:32)</a>:</h4>
<blockquote>
<p>but the alternative seems to be to consider the implicit <code>impl Trait for dyn Trait</code> a real impl in terms of coherence, which would reject plenty of generic impls</p>
</blockquote>
<p>or do "impl priority" where it only holds if there is no other impl, or some hack like that</p>



<a name="169082336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082336">(Jun 26 2019 at 21:32)</a>:</h4>
<p>I prefer having to specify explicitly whether a trait is object-safe to not having associated types in struct fields</p>



<a name="169082343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082343">(Jun 26 2019 at 21:32)</a>:</h4>
<p>even from a blank-slate POV</p>



<a name="169082359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082359">(Jun 26 2019 at 21:33)</a>:</h4>
<p>(not that "having to specify explicitly whether a trait is object-safe" is a good idea)</p>



<a name="169082388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082388">(Jun 26 2019 at 21:33)</a>:</h4>
<blockquote>
<p>or do "impl priority" where it only holds if there is no other impl, or some hack like that</p>
</blockquote>
<p>this needs chalk and a proof or I dont believe it to be sound^^</p>



<a name="169082415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082415">(Jun 26 2019 at 21:33)</a>:</h4>
<blockquote>
<p>(not that "having to specify explicitly whether a trait is object-safe" is a good idea)</p>
</blockquote>
<p>that's actually a great idea</p>



<a name="169082418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082418">(Jun 26 2019 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> <br>
the most basic form would be having a <code>dyn Trait</code> be non-object-safe if it has a blanket impl</p>



<a name="169082476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082476">(Jun 26 2019 at 21:34)</a>:</h4>
<p>also in terms of semver where today you can accidentally break rev dependencies by changing a trait from obj-safe to not-obj-safe</p>



<a name="169082508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082508">(Jun 26 2019 at 21:34)</a>:</h4>
<p>I have seen people asking for an explicit annotation like that before</p>



<a name="169082525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082525">(Jun 26 2019 at 21:34)</a>:</h4>
<p>that might be the solution area</p>



<a name="169082534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082534">(Jun 26 2019 at 21:34)</a>:</h4>
<blockquote>
<p>I prefer having to specify explicitly whether a trait is object-safe to not having associated types in struct fields</p>
</blockquote>
<p>why would struct fields be special here?</p>



<a name="169082552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082552">(Jun 26 2019 at 21:34)</a>:</h4>
<blockquote>
<p>why would struct fields be special here?</p>
</blockquote>
<p>if item fields don't have associated types, you "sort of don't need associated types"</p>



<a name="169082575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082575">(Jun 26 2019 at 21:35)</a>:</h4>
<p>you could stay in the pre-1.0 world where everything was type parameters and HRTBs</p>



<a name="169082582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082582">(Jun 26 2019 at 21:35)</a>:</h4>
<p>and a bit of inference magic</p>



<a name="169082619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082619">(Jun 26 2019 at 21:35)</a>:</h4>
<p>that sounds... surprising?</p>



<a name="169082711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082711">(Jun 26 2019 at 21:36)</a>:</h4>
<p>I mean, when you have a <code>trait Foo { type Assoc; }</code>, you can translate it to <code>trait Foo {}. trait Foo2&lt;Assoc&gt;; "forall&lt;T&gt; T: Foo -&gt; exists U. T: Foo2&lt;U&gt;"</code></p>



<a name="169082724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082724">(Jun 26 2019 at 21:37)</a>:</h4>
<p>i.e., just give up on associated type uniqueness</p>



<a name="169082763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082763">(Jun 26 2019 at 21:37)</a>:</h4>
<p>but didnt you just argue above that that would be awful for e.g. <code>&lt;Vec&lt;T&gt; as IntoIterator&gt;::Item</code>?</p>



<a name="169082769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082769">(Jun 26 2019 at 21:37)</a>:</h4>
<p>I mean, in that place, type inference can pick the impl associated type</p>



<a name="169082776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082776">(Jun 26 2019 at 21:37)</a>:</h4>
<p>and it does not matter whether there is any <em>other</em> impl</p>



<a name="169082827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082827">(Jun 26 2019 at 21:38)</a>:</h4>
<p>(you also need to move all trait-items to the "most detailed" trait)</p>



<a name="169082836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082836">(Jun 26 2019 at 21:38)</a>:</h4>
<p>(or parameterize them or something)</p>



<a name="169082876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082876">(Jun 26 2019 at 21:39)</a>:</h4>
<p>that was what rust did before 1.0</p>



<a name="169082898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082898">(Jun 26 2019 at 21:39)</a>:</h4>
<p>and I think this is basically Haskell without TypeFamilies</p>



<a name="169082905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082905">(Jun 26 2019 at 21:39)</a>:</h4>
<p>which is a language that you can do things in</p>



<a name="169082914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169082914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169082914">(Jun 26 2019 at 21:40)</a>:</h4>
<p>and the main problem is basically "putting associated types in structs"</p>



<a name="169083114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083114">(Jun 26 2019 at 21:42)</a>:</h4>
<blockquote>
<p>and it does not matter whether there is any <em>other</em> impl</p>
</blockquote>
<p>oh I see... the case that wouldn't work though is <code>fn foo&lt;T&gt;(t: &lt;T as Iterator&gt;::Item) -&gt; &lt;T as IntoIterator&gt;::Item where T: Iterator + IntoIterator</code></p>



<a name="169083120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083120">(Jun 26 2019 at 21:42)</a>:</h4>
<p>because then you dont know which impl it is</p>



<a name="169083148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083148">(Jun 26 2019 at 21:42)</a>:</h4>
<p>so maybe we can just rule out <em>that</em> kind of "expoitingcoherence"? or does your other example in the issue show that that's not enough?</p>



<a name="169083177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083177">(Jun 26 2019 at 21:43)</a>:</h4>
<blockquote>
<p>because then you dont know which impl it is</p>
</blockquote>
<p>sure, and in that case you'll need an extra equality clause</p>



<a name="169083214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083214">(Jun 26 2019 at 21:43)</a>:</h4>
<blockquote>
<p>so maybe we can just rule out <em>that</em> kind of "expoitingcoherence"? or does your other example in the issue show that that's not enough?</p>
</blockquote>
<p>I think that once you have associated types in struct fields, you need full coherence</p>



<a name="169083323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083323">(Jun 26 2019 at 21:44)</a>:</h4>
<p>or a struct could require you to "commit" to all of the types of its fields, but that would be ugly</p>



<a name="169083441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083441">(Jun 26 2019 at 21:45)</a>:</h4>
<p>so yea I think T-lang should come up with the solution for <a href="https://github.com/rust-lang/rust/issues/57893" target="_blank" title="https://github.com/rust-lang/rust/issues/57893">#57893</a></p>



<a name="169083517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083517">(Jun 26 2019 at 21:46)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> by "coherence" do you mean "every different valid typing derivation of a program leads to a resulting program that has the same dynamic semantics" or do you mean canonicity (global uniqueness)? I assume the latter</p>



<a name="169083540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083540">(Jun 26 2019 at 21:46)</a>:</h4>
<p>I mean unique associated type resolution</p>



<a name="169083576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083576">(Jun 26 2019 at 21:47)</a>:</h4>
<p>for every concrete associated trait-ref <code>&lt;Foo as Bar&gt;::Baz</code>, there is exactly 1 way to resolve it</p>



<a name="169083678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083678">(Jun 26 2019 at 21:48)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> I'll need to digest your example on the issue tomorrow then... too tired now ^^</p>



<a name="169083816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083816">(Jun 26 2019 at 21:50)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span>  Anyways, we've booked a lang team meeting for <a href="https://github.com/rust-lang/rust/issues/57893" target="_blank" title="https://github.com/rust-lang/rust/issues/57893">#57893</a> on the 11th of July; there's an entry on the lang team calendar if you want to join (which would be great)</p>



<a name="169083829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083829">(Jun 26 2019 at 21:50)</a>:</h4>
<p>which time is that?</p>



<a name="169083874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169083874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169083874">(Jun 26 2019 at 21:51)</a>:</h4>
<p>(btw, if we treat methods as associated trait-refs, that description of coherence explains why incoherent marker traits are not a problem - still every ATR resolves in exactly 1 way)</p>



<a name="169084065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169084065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169084065">(Jun 26 2019 at 21:54)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> 21:00 CEST I believe (summer time is tricky... check the calendar :D )</p>



<a name="169084110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169084110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169084110">(Jun 26 2019 at 21:55)</a>:</h4>
<p>it says 15:00 boston time, which is indeed 21:00 CEST</p>



<a name="169112490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169112490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169112490">(Jun 27 2019 at 08:06)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> so looking at your example, adding <code>where dyn Object&lt;U, Output = T&gt;: Object&lt;U, Output = T&gt;,</code> to <code>iso1</code> solves nothing; A constraint <code>where dyn Object&lt;U, Output = T&gt;: Object&lt;U, Output = V&gt;,</code>  on <code>transmute_m</code> would solve things but to do that you'd need to look inside <code>transmute_m</code> which would be very ungreat in terms of the phase separation of the current compiler</p>



<a name="169112854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169112854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169112854">(Jun 27 2019 at 08:12)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> <span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span>  Oh but interestingly, if we add <code>X: Object&lt;U, Output = V&gt;</code> to <code>iso2</code> we make <code>transmute_m</code> not type check. <em>This</em> assumption can be deduced purely from the signature of <code>iso2</code> so we do not have to ruin phase separation</p>



<a name="169113683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169113683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169113683">(Jun 27 2019 at 08:24)</a>:</h4>
<p>From what I can tell this comes down to a question of  increased compile-times + a-more-trusted-analysis (adding new proof obligations when derivations from coherence are made) vs. giving up on some sound code and losing out on completeness (object safety taking blanket impls into account)</p>



<a name="169116854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169116854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169116854">(Jun 27 2019 at 09:13)</a>:</h4>
<p>Yeah <code>iso2</code> is the "bad" one there I think</p>



<a name="169117104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169117104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169117104">(Jun 27 2019 at 09:16)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> In the sense that it is not requiring things it should from its callers (which really makes <code>transmute_m</code> the bit that would stop type checking)</p>



<a name="169117375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169117375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169117375">(Jun 27 2019 at 09:20)</a>:</h4>
<p>yes</p>



<a name="169241943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169241943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169241943">(Jun 28 2019 at 16:53)</a>:</h4>
<p>@RalfJ @centril do you have a principled rule?</p>
<p>I think we have 4 classes of options for fixing things here:<br>
1. Making the blanket impl a coherence violation, which might have bad back-compat consequences, and is somewhat hard to implement in the compiler today (because of the <code>dyn Trait+AnySetOfSubtraits</code> problem, and also the <code>for&lt;'a&gt; dyn Trait&lt;'a&gt;</code> problem, unless we already modified coherence such that it is eqty to <code>dyn Trait&lt;'a&gt;</code> in coherence).<br>
2. Making <code>iso_1</code> be illegal in its current form ("requiring it to have an extra where-clause"). In Chalk terms, the rule <code>iso_1</code> uses is the  <code>&lt;dyn Object&lt;U, Output=T&gt; as Object&lt;U, Output=T&gt;&gt;::Output = T :-</code>, the <code>ObjectCandidate</code> in rustc terms.<br>
    I think it is possible to allow the <code>ObjectCandidate</code> rule only if there are no potentially-conflicting impls. One way of doing it would be to make <code>Trait</code> non-object-safe (in Rust terms), using the coherence conflict as the justificataion.<br>
3. Making <code>iso_2</code> be illegal in its current form ("requiring it to have an extra where-clause"). In Chalk terms, the rule <code>iso_2</code> uses is <code>&lt;T as Object&lt;U&gt;&gt;::Output = V := U: Mark, &lt;U as Mark&gt;::Output = V</code>. This is very similar to the rule that allows you to work with <code>IntoIterator</code>, so I don't think it is a good idea to get rid of it, unless you have a principled exception in mind.<br>
4. Making <code>transmute_m</code> illegal. ~~I can't think of a way of doing this that doesn't also make <code>iso_1</code> directly illegal.<br>
~~ Actually, if we consider the "object impl" to be an implied bound on the object ADT, then the equivalent of <code>2.</code> would prohibit <code>transmute_m</code> rather than <code>iso_1</code>, because <code>iso_1</code> would get what it needs through an implied bound and not need the <code>ObjectCandidate</code>.</p>
<p>How do your ideas fit in this mold?</p>



<a name="169242177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242177">(Jun 28 2019 at 16:56)</a>:</h4>
<p>@RalfJung <span class="user-mention" data-user-id="126931">@centril</span> </p>
<p>so I think what you wrote is basically a variant of <code>3.</code>, except it would add an "implicit" <code>X: Object&lt;U, Output = V&gt;</code> bound to <code>iso_2</code> to make it "work again". Do you  have a principled way of doing it?</p>



<a name="169242190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242190">(Jun 28 2019 at 16:56)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="169242331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242331">(Jun 28 2019 at 16:59)</a>:</h4>
<p>I'm afraid I dont have anything principled to say here</p>



<a name="169242358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242358">(Jun 28 2019 at 16:59)</a>:</h4>
<p>I have an intuition from thinking about modelling traits in lambda-rust, but we haven't modeled them yet</p>



<a name="169242372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242372">(Jun 28 2019 at 16:59)</a>:</h4>
<p>and I know nothing about how rustc/chalk actually implements all the trait rules</p>



<a name="169242377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242377">(Jun 28 2019 at 16:59)</a>:</h4>
<p>sure, I think the precise modeling of trait objects is important here</p>



<a name="169242456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242456">(Jun 28 2019 at 17:00)</a>:</h4>
<p>absolutely</p>



<a name="169242480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242480">(Jun 28 2019 at 17:00)</a>:</h4>
<p>every time some knocks on derek's door that's one of the projects he is proposing ;)</p>



<a name="169242490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242490">(Jun 28 2019 at 17:01)</a>:</h4>
<p>but so far people picked other projects</p>



<a name="169242523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242523">(Jun 28 2019 at 17:01)</a>:</h4>
<p>my intuition here is that <code>iso_2</code> is sneakily hiding an assumption that it is making... <code>iso_1</code> seems perfectly fine to me, after all it specifically asked for this associated type</p>



<a name="169242666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242666">(Jun 28 2019 at 17:03)</a>:</h4>
<p>All I can say is... we need to steal Stephanie Weirich, Richard Eisenberg, and more Haskell folks ;)</p>



<a name="169242779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242779">(Jun 28 2019 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> so I think mine (our?) thinking is that we do 4. by adding an implicit <code>V == &lt;X as Object&lt;U&gt;&gt;::Output</code> eq-constraint</p>



<a name="169242794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242794">(Jun 28 2019 at 17:04)</a>:</h4>
<p>@centril I consider it a form of 3.</p>



<a name="169242806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242806">(Jun 28 2019 at 17:04)</a>:</h4>
<p>or of 2</p>



<a name="169242869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242869">(Jun 28 2019 at 17:05)</a>:</h4>
<p>actually, forbidding you from proving <code>WF(dyn Object&lt;U, Output=T&gt;)</code> would be a form of 4. that might not be 2.</p>



<a name="169242870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242870">(Jun 28 2019 at 17:05)</a>:</h4>
<p>Well it revolves around <code>iso2</code>; I agree with <span class="user-mention" data-user-id="120791">@RalfJ</span>  that <code>iso2</code> is not properly propagating its assumption</p>



<a name="169242948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169242948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169242948">(Jun 28 2019 at 17:06)</a>:</h4>
<p>because <code>2</code> would get <code>WF(dyn Object&lt;U, Output=T&gt;)</code> as an assumption, and therefore it wouldn't need to prove it</p>



<a name="169243137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243137">(Jun 28 2019 at 17:08)</a>:</h4>
<p>what happened to the idea that one can do <code>#[dyn] trait { ... }</code> and doing so makes coherence consider the implicit impl, thereby ruling out the blanket impl in your example?</p>



<a name="169243147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243147">(Jun 28 2019 at 17:08)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span>  as for "how do we do this"... I'm thinking that "when we assume a blanket impl in a signature we also add a constraint for that assumption to said signature"</p>



<a name="169243157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243157">(Jun 28 2019 at 17:08)</a>:</h4>
<p>i guess that would be a variant of 1)</p>



<a name="169243179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243179">(Jun 28 2019 at 17:08)</a>:</h4>
<p>but that might be awfully hand-wavy</p>



<a name="169243213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243213">(Jun 28 2019 at 17:09)</a>:</h4>
<p>@RalfJ that's 1.</p>



<a name="169243262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243262">(Jun 28 2019 at 17:10)</a>:</h4>
<p>@centril but you don't assume the blanket impl in the signature</p>



<a name="169243421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243421">(Jun 28 2019 at 17:11)</a>:</h4>
<p>I suppose we might ask the Chalk people <span class="user-mention" data-user-id="131694">@scalexm</span></p>



<a name="169243623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243623">(Jun 28 2019 at 17:13)</a>:</h4>
<p>Then I don't get how:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">iso_2</span><span class="o">&lt;</span><span class="n">X</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span>: <span class="nc">Data</span><span class="o">&lt;</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">V</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">U</span>: <span class="nc">Mark</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// similarly, this shouldn&#39;t &quot;see&quot; the trait-object impl.</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>can type-check</p>



<a name="169243659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243659">(Jun 28 2019 at 17:13)</a>:</h4>
<p>Removing:</p>
<div class="codehilite"><pre><span></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"> </span><span class="n">U</span>: <span class="nc">Mark</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Object</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>makes <code>fn iso2</code> not type-check</p>



<a name="169243832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243832">(Jun 28 2019 at 17:15)</a>:</h4>
<p>This notably does not rely on the body of <code>iso2</code>; if you replace it with <code>panic!()</code> and remove either <code>U: Mark&lt;Output = V&gt;</code> or the blanket impl it won't type check</p>



<a name="169243952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243952">(Jun 28 2019 at 17:16)</a>:</h4>
<p>Yea it requires an <code>X: Object&lt;U&gt;</code> bound</p>



<a name="169243977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169243977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169243977">(Jun 28 2019 at 17:17)</a>:</h4>
<p>and because of a weird rustc limitation, a <code>X: Object&lt;U&gt;</code> requires you to specify <code>V</code></p>



<a name="169244000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169244000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169244000">(Jun 28 2019 at 17:17)</a>:</h4>
<p>but perhaps that rustc limitation could be formalized</p>



<a name="169244088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169244088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169244088">(Jun 28 2019 at 17:18)</a>:</h4>
<p>but in an implied bounds setting, <code>iso_2</code> would compile and the <code>X: Object&lt;U&gt;</code> bound would be passed to the caller</p>



<a name="169244133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169244133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169244133">(Jun 28 2019 at 17:18)</a>:</h4>
<p>(in fact, today, <code>transmute_m</code> already has to prove <code>X: Object&lt;U&gt;</code>)</p>



<a name="169244153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169244153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169244153">(Jun 28 2019 at 17:19)</a>:</h4>
<p>Propagating these assumed un-propagated constraints may however be expensive... I would suggest that we try the various 1-4 strategies, <code>@craterbot</code> and <code>@rust-timer build</code> them and see what falls out</p>



<a name="169245709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169245709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169245709">(Jun 28 2019 at 17:37)</a>:</h4>
<p>so I'm still thinking whether there is a way to abuse the absence of coherence</p>



<a name="169245861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169245861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169245861">(Jun 28 2019 at 17:39)</a>:</h4>
<p>or rather, of figuring out a sound/allows-all-the-code-we-want-compiling--to-compile rule, or why we don't want such a rule</p>



<a name="169245904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169245904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169245904">(Jun 28 2019 at 17:39)</a>:</h4>
<p>of course, the general boogeyman of these would be specialization</p>



<a name="169245923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169245923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169245923">(Jun 28 2019 at 17:39)</a>:</h4>
<p>but we still have no idea when specialization is sound, so I'll rather not try to rely on it</p>



<a name="169260721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169260721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169260721">(Jun 28 2019 at 20:46)</a>:</h4>
<p>So I think I found a hole in my naïve attempt to implement <span class="user-mention" data-user-id="120791">@RalfJ</span>'s suggestion: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=dc1bdbf5d59a3dba86fa3c9ece8556fc" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=dc1bdbf5d59a3dba86fa3c9ece8556fc">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=dc1bdbf5d59a3dba86fa3c9ece8556fc</a></p>



<a name="169260787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169260787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169260787">(Jun 28 2019 at 20:47)</a>:</h4>
<p>there's no way to see <code>Object</code> in the signature of <code>iso_2</code>, because it gets wrapped in the <code>HidingPlace</code></p>



<a name="169260860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169260860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169260860">(Jun 28 2019 at 20:48)</a>:</h4>
<p>Thanks <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  I'll read it tomorrow</p>



<a name="169260937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169260937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169260937">(Jun 28 2019 at 20:49)</a>:</h4>
<p><code>iso_2</code> still stops type-checking without the blanket impl though</p>



<a name="169261243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261243">(Jun 28 2019 at 20:53)</a>:</h4>
<p>@RalfJ sure it does</p>



<a name="169261248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261248">(Jun 28 2019 at 20:53)</a>:</h4>
<p>but what can you do with it?</p>



<a name="169261317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261317">(Jun 28 2019 at 20:54)</a>:</h4>
<p>I mean, you don't want type inference to depend on function bodies</p>



<a name="169261322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261322">(Jun 28 2019 at 20:54)</a>:</h4>
<p>*function signatures to depend on function bodies</p>



<a name="169261356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261356">(Jun 28 2019 at 20:55)</a>:</h4>
<p>it doesnt have to -- but (and I think I said that in the issue) it would have to basically aggressively collect all the facts that the body <em>might</em> use and add them to the "signature"</p>



<a name="169261369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261369">(Jun 28 2019 at 20:55)</a>:</h4>
<blockquote>
<ul>
<li>but (and I think I said that in the post) it would have to basically aggressively collect all the facts that the body might use and add them to the "signature"</li>
</ul>
</blockquote>
<p>That means that type inference depends on function bodies</p>



<a name="169261375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261375">(Jun 28 2019 at 20:55)</a>:</h4>
<p>I have no idea if that is even remotely practical</p>



<a name="169261376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261376">(Jun 28 2019 at 20:55)</a>:</h4>
<p>and I expect it to have weird effects with things like <code>IntoIterator</code></p>



<a name="169261377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261377">(Jun 28 2019 at 20:55)</a>:</h4>
<p>hu, how that?</p>



<a name="169261427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261427">(Jun 28 2019 at 20:56)</a>:</h4>
<p>I mean, to see whether <code>iso_2</code> typechecks, you have to see the body of <code>iso_2</code></p>



<a name="169261434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261434">(Jun 28 2019 at 20:56)</a>:</h4>
<p>plus, you can make <code>iso_2</code> a trait function</p>



<a name="169261438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261438">(Jun 28 2019 at 20:56)</a>:</h4>
<p>so you can't do "naive" propagation</p>



<a name="169261448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261448">(Jun 28 2019 at 20:56)</a>:</h4>
<p>I said none of that</p>



<a name="169261453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261453">(Jun 28 2019 at 20:56)</a>:</h4>
<p>I said collect all facts it <em>might</em> use</p>



<a name="169261455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261455">(Jun 28 2019 at 20:56)</a>:</h4>
<p>without knowing what it actually <em>does</em> use</p>



<a name="169261475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261475">(Jun 28 2019 at 20:57)</a>:</h4>
<p>basically going forward from the where clauses we got, what are all the things we can deduce? these all become part of the "signature"</p>



<a name="169261481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261481">(Jun 28 2019 at 20:57)</a>:</h4>
<p>and again, I have no idea if that's even remotely practical ;)</p>



<a name="169261562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261562">(Jun 28 2019 at 20:58)</a>:</h4>
<p>That feels like it could blow up very easily in terms of compile times ^^</p>



<a name="169261568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261568">(Jun 28 2019 at 20:58)</a>:</h4>
<p>I mean, if you go by the "might use" idea, you can notice that  you have a coherence violation</p>



<a name="169261577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261577">(Jun 28 2019 at 20:58)</a>:</h4>
<p><em>everything</em> "might use" a coherence violation</p>



<a name="169261583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261583">(Jun 28 2019 at 20:58)</a>:</h4>
<p>which means that code with a coherence violation does not compile</p>



<a name="169261592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261592">(Jun 28 2019 at 20:58)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span></p>
<blockquote>
<p>That means that type inference depends on function bodies</p>
</blockquote>
<p>I'm not opposed to this <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="169261611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261611">(Jun 28 2019 at 20:58)</a>:</h4>
<p>I know everyone else is tho</p>



<a name="169261644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261644">(Jun 28 2019 at 20:59)</a>:</h4>
<blockquote>
<p>I'm not opposed to this </p>
</blockquote>
<p>This doesn't scale to traits. Suppose you have</p>
<div class="codehilite"><pre><span></span>trait Iso2 {
fn iso_2&lt;X: ?Sized, U, V, D&gt;(data: D) -&gt; V
    where U: Mark&lt;Output=V&gt;, D: HidingPlace&lt;X, U&gt;;
}

impl Iso2 for MyIso2 {
    ...
}

trait TransmuteM {
fn transmute_m&lt;T, U, V, I: Iso2&gt;(data: T) -&gt; V
    where U: Mark&lt;Output=V&gt;;
}

impl TransmuteM for MyTransmuteM {
fn transmute_m&lt;T, U, V, I: Iso2&gt;(data: T) -&gt; V
    where U: Mark&lt;Output=V&gt; { /* ... */ }
}
</pre></div>



<a name="169261829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261829">(Jun 28 2019 at 21:02)</a>:</h4>
<p>(Is there anything in particular that Rust has that Haskell doesn't here apart from type based dispatch with methods?)</p>



<a name="169261886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261886">(Jun 28 2019 at 21:02)</a>:</h4>
<p>(Given that Haskell does have global type inference)</p>



<a name="169261899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261899">(Jun 28 2019 at 21:02)</a>:</h4>
<p>The problem here is not global type inference</p>



<a name="169261911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261911">(Jun 28 2019 at 21:02)</a>:</h4>
<p>I don't think typeclasses in haskell have type inference</p>



<a name="169261923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169261923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169261923">(Jun 28 2019 at 21:02)</a>:</h4>
<p><code>TransmuteM</code> would be a typeclass in Haskell</p>



<a name="169262049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169262049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169262049">(Jun 28 2019 at 21:04)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span>  type class definitions and instance heads do not; functions certainly do infer type class constraints in Haskell</p>



<a name="169262085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169262085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169262085">(Jun 28 2019 at 21:04)</a>:</h4>
<p>@centril sure, but here what you want is for the constraint on the body of <code>MyIso2</code> to somehow transfer to the typeclass definition for the trait <code>Iso2</code></p>



<a name="169262147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169262147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169262147">(Jun 28 2019 at 21:05)</a>:</h4>
<p>I'll need to look at your newest example more carefully tomorrow and get back to you <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="169262200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169262200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169262200">(Jun 28 2019 at 21:06)</a>:</h4>
<p>ok</p>



<a name="169305934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169305934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169305934">(Jun 29 2019 at 17:36)</a>:</h4>
<p>And my next obstacle to iso-2-blaming: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=b96e34ea38383adabe1850d049e9e9b0" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=b96e34ea38383adabe1850d049e9e9b0">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=b96e34ea38383adabe1850d049e9e9b0</a></p>



<a name="169305938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169305938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169305938">(Jun 29 2019 at 17:36)</a>:</h4>
<p>which "hides" the evidence for <code>Mark</code> by using <code>MarkWitness</code></p>



<a name="169306161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169306161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169306161">(Jun 29 2019 at 17:44)</a>:</h4>
<p>in that place, <code>Iso2Observer::observe</code> uses the <code>ImplCandidate</code> (to normalize the result of <code>get_data</code>). However, I don't see a way of forcing it to propagate its requirement without breaking <code>IntoIterator</code></p>



<a name="169306170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169306170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169306170">(Jun 29 2019 at 17:45)</a>:</h4>
<p>aka, while allowing it to use things like <code>&lt;Vec&lt;U&gt; as IntoIterator&gt;</code></p>



<a name="169582932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169582932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169582932">(Jul 03 2019 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> I’ve not exactly followed the solutions you have in mind so far, but to me there are basically two realistic solutions:</p>
<ul>
<li>resolve through impl precedence</li>
<li>more brutal: if <code>dyn Trait&lt;?X1,...?Xn&gt;</code> would unify with the receiver of an impl for <code>Trait&lt;T1,...,Tn&gt;</code>, make the trait non object safe</li>
</ul>
<p>Is that right? Are there any problems with, e.g. the second approach?</p>



<a name="169583017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583017">(Jul 03 2019 at 16:52)</a>:</h4>
<p><span class="user-mention" data-user-id="131694">@scalexm</span> </p>
<p>I'm not sure the coherence solution is too bad</p>



<a name="169583020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583020">(Jul 03 2019 at 16:52)</a>:</h4>
<p>(Other than breaking compatibility of course)</p>



<a name="169583036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583036">(Jul 03 2019 at 16:52)</a>:</h4>
<p>I'm not sure people are abusing things sufficiently badly that we have a coherence problem</p>



<a name="169583045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583045">(Jul 03 2019 at 16:52)</a>:</h4>
<p>What are you calling « coherence solution »?</p>



<a name="169583052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583052">(Jul 03 2019 at 16:53)</a>:</h4>
<p>making the bad impl illegal</p>



<a name="169583070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583070">(Jul 03 2019 at 16:53)</a>:</h4>
<p>I mean, we have an unsoundness, everything is going to break compatibility</p>



<a name="169583083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583083">(Jul 03 2019 at 16:53)</a>:</h4>
<p>Right</p>



<a name="169583174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583174">(Jul 03 2019 at 16:54)</a>:</h4>
<p>So you prefer « making the impl illegal » rather than « making it illegal to use the trait as a trait object »</p>



<a name="169583241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583241">(Jul 03 2019 at 16:55)</a>:</h4>
<p>I'm not sure</p>



<a name="169583311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583311">(Jul 03 2019 at 16:56)</a>:</h4>
<p>this feels like a lang-design question that might need some thought</p>



<a name="169583331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583331">(Jul 03 2019 at 16:56)</a>:</h4>
<p><span class="user-mention" data-user-id="131694">@scalexm</span> BTW, how <em>can</em> we do impl precedence?</p>



<a name="169583362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583362">(Jul 03 2019 at 16:57)</a>:</h4>
<p><span class="user-mention" data-user-id="228094">@Ariel Ben-Yehuda</span> I don’t know :)</p>



<a name="169583377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583377">(Jul 03 2019 at 16:57)</a>:</h4>
<p>But if it were possible, it would presumably break less code?</p>



<a name="169583379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583379">(Jul 03 2019 at 16:57)</a>:</h4>
<p>I'm not sure</p>



<a name="169583394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583394">(Jul 03 2019 at 16:57)</a>:</h4>
<p>it feels like any real way of doing it would manage to break some code</p>



<a name="169583453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583453">(Jul 03 2019 at 16:58)</a>:</h4>
<p>what with it being a fairly-big change and all</p>



<a name="169583472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583472">(Jul 03 2019 at 16:58)</a>:</h4>
<p>Yes</p>



<a name="169583476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583476">(Jul 03 2019 at 16:58)</a>:</h4>
<p>and we're still not sure that preventing the trait from being "object-safe" would break things</p>



<a name="169583502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583502">(Jul 03 2019 at 16:58)</a>:</h4>
<p>my actual idea for non-object-safety was uglier but more permitting</p>



<a name="169583521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583521">(Jul 03 2019 at 16:59)</a>:</h4>
<p>you make the <code>ObjectCandidate</code> not apply when an <code>ImplCandidate</code> can "possibly" match</p>



<a name="169583549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariel Ben-Yehuda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583549">(Jul 03 2019 at 16:59)</a>:</h4>
<p>i.e., basically add negative bounds to the object candidate</p>



<a name="169583591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2357893%20coherence%20and%20traits/near/169583591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scalexm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2357893.20coherence.20and.20traits.html#169583591">(Jul 03 2019 at 17:00)</a>:</h4>
<p>I see</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>