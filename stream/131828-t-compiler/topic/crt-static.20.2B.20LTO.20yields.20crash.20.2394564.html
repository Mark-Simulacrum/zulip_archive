<html>
<head><meta charset="utf-8"><title>crt-static + LTO yields crash #94564 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html">crt-static + LTO yields crash #94564</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274858869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274858869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274858869">(Mar 10 2022 at 16:22)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="133247">@bjorn3</span> I wasn't able to reproduce <a href="https://github.com/rust-lang/rust/issues/94564">#94564</a> on my Linux machine. How much target dependency might there be here? (I was trying on an AMD threadripper, and I'm wondering if I need to switch to an Intel machine to see this._</p>



<a name="274862263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274862263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274862263">(Mar 10 2022 at 16:47)</a>:</h4>
<p>I am using an <code>Intel(R) Core(TM) i3-7130U CPU @ 2.70GHz</code> with Debian 11 and glibc 2.31. I can reproduce it both using the repro given by <code>@elast0ny</code> and without cargo using <code>echo 'fn main() { std::process::Command::new("ls").spawn(); }' | rustc +stable - -Copt-level=3 -Clto -Ctarget-feature=+crt-static</code>.</p>



<a name="274862498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274862498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274862498">(Mar 10 2022 at 16:49)</a>:</h4>
<p>If I step a bit back in rr I get the following backtrace:</p>
<div class="codehilite"><pre><span></span><code>(rr) continue
(rr) break std::sys::unix::rwlock::RWLock::read
(rr) reverse-continue
(rr) rsi
(rr) bt
0x000000000043af0e in core::ptr::drop_in_place&lt;core::result::Result&lt;(), std::io::error::Error&gt;&gt; () at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/ptr/mod.rs:188
188     in /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/ptr/mod.rs
(rr) bt
#0  0x000000000043af0e in core::ptr::drop_in_place&lt;core::result::Result&lt;(), std::io::error::Error&gt;&gt; () at /rustc/9d1b2106e23b1abd32fce1f17267604a5102f57a/library/core/src/ptr/mod.rs:188
#1  std::io::Write::write_fmt&lt;std::sys::unix::stdio::Stderr&gt; () at library/std/src/io/mod.rs:1671
#2  std::panicking::rust_panic_with_hook () at library/std/src/panicking.rs:583
#3  0x000000000043aa36 in std::panicking::begin_panic_handler::{closure#0} () at library/std/src/panicking.rs:500
#4  0x000000000043a9d6 in std::sys_common::backtrace::__rust_end_short_backtrace&lt;std::panicking::begin_panic_handler::{closure#0}, !&gt; () at library/std/src/sys_common/backtrace.rs:139
#5  0x000000000043a992 in std::panicking::begin_panic_handler () at library/std/src/panicking.rs:498
#6  0x0000000000401220 in core::panicking::panic_fmt () at library/core/src/panicking.rs:116
#7  0x000000000043afc4 in std::sys::unix::rwlock::RWLock::read () at library/std/src/sys/unix/rwlock.rs:49
#8  std::sys_common::rwlock::StaticRWLock::read () at library/std/src/sys_common/rwlock.rs:23
#9  std::panicking::rust_panic_with_hook () at library/std/src/panicking.rs:595
#10 0x000000000043aa36 in std::panicking::begin_panic_handler::{closure#0} () at library/std/src/panicking.rs:500
#11 0x000000000043a9d6 in std::sys_common::backtrace::__rust_end_short_backtrace&lt;std::panicking::begin_panic_handler::{closure#0}, !&gt; () at library/std/src/sys_common/backtrace.rs:139
#12 0x000000000043a992 in std::panicking::begin_panic_handler () at library/std/src/panicking.rs:498
#13 0x0000000000401220 in core::panicking::panic_fmt () at library/core/src/panicking.rs:116
#14 0x000000000043afc4 in std::sys::unix::rwlock::RWLock::read () at library/std/src/sys/unix/rwlock.rs:49
#15 std::sys_common::rwlock::StaticRWLock::read () at library/std/src/sys_common/rwlock.rs:23
#16 std::panicking::rust_panic_with_hook () at library/std/src/panicking.rs:595
#17 0x000000000043aa36 in std::panicking::begin_panic_handler::{closure#0} () at library/std/src/panicking.rs:500
#18 0x000000000043a9d6 in std::sys_common::backtrace::__rust_end_short_backtrace&lt;std::panicking::begin_panic_handler::{closure#0}, !&gt; () at library/std/src/sys_common/backtrace.rs:139
#19 0x000000000043a992 in std::panicking::begin_panic_handler () at library/std/src/panicking.rs:498
#20 0x0000000000401220 in core::panicking::panic_fmt () at library/core/src/panicking.rs:116
#21 0x0000000000438077 in std::sys::unix::rwlock::RWLock::read () at library/std/src/sys/unix/rwlock.rs:49
#22 std::sys_common::rwlock::StaticRWLock::read () at library/std/src/sys_common/rwlock.rs:23
#23 std::sys::unix::os::env_read_lock () at library/std/src/sys/unix/os.rs:490
#24 std::sys::unix::process::process_common::Command::posix_spawn () at library/std/src/sys/unix/process/process_unix.rs:529
#25 std::sys::unix::process::process_common::Command::spawn () at library/std/src/sys/unix/process/process_unix.rs:55
#26 std::process::Command::spawn () at library/std/src/process.rs:868
#27 0x000000000040bf2c in rust_out::main ()
#28 0x000000000040ac43 in std::sys_common::backtrace::__rust_begin_short_backtrace ()
#29 0x000000000040b23c in main ()
</code></pre></div>



<a name="274862883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274862883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274862883">(Mar 10 2022 at 16:51)</a>:</h4>
<p>The second panic is because it hits <code>panic!("rwlock read lock would result in deadlock");</code>.</p>



<a name="274863009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274863009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274863009">(Mar 10 2022 at 16:52)</a>:</h4>
<p>The first panic is also because it hits this. <del><code>pthread_rwlock_rdlock</code> returns <code>EAGAIN</code>.</del></p>



<a name="274863205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274863205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274863205">(Mar 10 2022 at 16:53)</a>:</h4>
<p>It either returns <code>EDEADLK</code> or <code>*self.write_locked.get()</code> returns true.</p>



<a name="274863799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274863799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274863799">(Mar 10 2022 at 16:58)</a>:</h4>
<p>If you need further help minimizing this feel free to ask.</p>



<a name="274864243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274864243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274864243">(Mar 10 2022 at 17:00)</a>:</h4>
<p>It does return EDEADLK in my debugging.</p>



<a name="274864302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274864302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274864302">(Mar 10 2022 at 17:01)</a>:</h4>
<p>I does reproduce for me on Ubuntu 20.04 VM running on AMD Ryzen 5950X so it's not an Intel thing.</p>



<a name="274864494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274864494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274864494">(Mar 10 2022 at 17:02)</a>:</h4>
<p>huh. Okay. I'm going to keep looking into why I'm not seeing it myself.</p>



<a name="274864678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274864678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274864678">(Mar 10 2022 at 17:03)</a>:</h4>
<p>Maybe you use a different glibc version?</p>



<a name="274865055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274865055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274865055">(Mar 10 2022 at 17:05)</a>:</h4>
<p>I'm going to look at that, yeah</p>



<a name="274865288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274865288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274865288">(Mar 10 2022 at 17:07)</a>:</h4>
<p>glibc 2.34</p>



<a name="274868128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274868128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274868128">(Mar 10 2022 at 17:29)</a>:</h4>
<p>I'm on a 3970X and I know for sure I could reproduce this when the issue was posted, but I can't anymore. I suspect this is because on March 5, I bumped my version of glibc from 2.33-5 to 2.35-2.</p>



<a name="274868573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274868573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274868573">(Mar 10 2022 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564/near/274865288">said</a>:</p>
<blockquote>
<p>glibc 2.34</p>
</blockquote>
<p>(just reproduced atop cloud desktop running glibc 2.31. So, yeah, its seeming likely that there's some interaction here.)</p>



<a name="274870233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274870233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274870233">(Mar 10 2022 at 17:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> regarding your comment on GitHub 2.33-5 and 2.35-2 are just 2.33 and 2.35. <code>-2</code> and <code>-5</code> are the distro suffixes for the patch levels.</p>



<a name="274870334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274870334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274870334">(Mar 10 2022 at 17:45)</a>:</h4>
<p>I was assume it was a patch level; I didn't know if that was a glibc patch, but it sounds like you're saying each distro chooses its own set of patches and thus the numbers are not meaningful outside of a specific distribution?</p>



<a name="274871087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274871087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274871087">(Mar 10 2022 at 17:50)</a>:</h4>
<p>Yeah, those versions look like Arch Linux packages. Right now I have the same 2.35-2 version: <a href="https://archlinux.org/packages/core/x86_64/glibc/">https://archlinux.org/packages/core/x86_64/glibc/</a></p>



<a name="274871377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274871377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274871377">(Mar 10 2022 at 17:53)</a>:</h4>
<p>Correct, sorry for the confusion. I'm just covering all my bases in case an Arch patch is important.</p>



<a name="274871410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274871410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274871410">(Mar 10 2022 at 17:53)</a>:</h4>
<p>thanks</p>



<a name="274899733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274899733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274899733">(Mar 10 2022 at 21:46)</a>:</h4>
<p>I reproduced this in an old Arch Linux docker image</p>



<a name="274899765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274899765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274899765">(Mar 10 2022 at 21:47)</a>:</h4>
<p>And confirmed with gdb that <code>pthread_rwlock_rdlock()</code> is returning <code>EDEADLK</code> for some reason</p>



<a name="274899812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274899812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274899812">(Mar 10 2022 at 21:47)</a>:</h4>
<p>Interestingly <code>pthread_rwlock_wrlock()</code> isn't even linked in, so there's no way it's a real deadlock</p>



<a name="274900313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274900313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274900313">(Mar 10 2022 at 21:52)</a>:</h4>
<p>It seems to be this code block: <a href="https://github.com/bminor/glibc/blob/glibc-2.33/nptl/pthread_rwlock_common.c#L296-L300">https://github.com/bminor/glibc/blob/glibc-2.33/nptl/pthread_rwlock_common.c#L296-L300</a></p>



<a name="274900420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274900420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274900420">(Mar 10 2022 at 21:53)</a>:</h4>
<p><code>__cur_writer</code> is zero, but so is <code>THREAD_GETMEM (THREAD_SELF, tid)</code></p>



<a name="274900476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274900476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274900476">(Mar 10 2022 at 21:54)</a>:</h4>
<p>I'm guessing <code>THREAD_SELF</code> didn't get initialized</p>



<a name="274900955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274900955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274900955">(Mar 10 2022 at 21:58)</a>:</h4>
<p>Uh</p>
<div class="codehilite"><pre><span></span><code>[root@8b906bb3417f /]# cat foo.c
#include &lt;assert.h&gt;
#include &lt;pthread.h&gt;

static pthread_rwlock_t rwl = PTHREAD_RWLOCK_INITIALIZER;

int main() {
  assert(pthread_rwlock_rdlock(&amp;rwl) == 0);
  return 0;
}
[root@8b906bb3417f /]# gcc -static -pthread ./foo.c -o foo
[root@8b906bb3417f /]# ./foo
foo: ./foo.c:7: main: Assertion `pthread_rwlock_rdlock(&amp;rwl) == 0&#39; failed.
Aborted (core dumped)
</code></pre></div>



<a name="274901665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274901665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274901665">(Mar 10 2022 at 22:03)</a>:</h4>
<p>Okay so this is <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=5784">https://sourceware.org/bugzilla/show_bug.cgi?id=5784</a></p>



<a name="274901698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274901698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274901698">(Mar 10 2022 at 22:03)</a>:</h4>
<p>It's probably "fixed" in glibc 2.34 because they merged libpthread into libc</p>



<a name="274902623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274902623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274902623">(Mar 10 2022 at 22:10)</a>:</h4>
<p>This is the typical workaround:</p>
<div class="codehilite"><pre><span></span><code>[root@8b906bb3417f /]# gcc -static -pthread -Wl,--whole-archive,-lpthread,--no-whole-archive ./foo.c -o foo
[root@8b906bb3417f /]# ./foo
[root@8b906bb3417f /]#
</code></pre></div>
<p>but I don't know how to get <code>rustc</code> to put <code>--whole-archive</code> in the right place</p>



<a name="274908715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/crt-static%20%2B%20LTO%20yields%20crash%20%2394564/near/274908715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/crt-static.20.2B.20LTO.20yields.20crash.20.2394564.html#274908715">(Mar 10 2022 at 23:04)</a>:</h4>
<p>Something like <code>#[link(name = "pthread", modifier = "+whole-archive")]</code> maybe?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>