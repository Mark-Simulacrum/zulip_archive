<html>
<head><meta charset="utf-8"><title>Projection caching/deduplication · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html">Projection caching/deduplication</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264238105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264238105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264238105">(Dec 08 2021 at 23:50)</a>:</h4>
<p>There's been a lot of discussion of projection caching/deduplication spread across several github issues. I'm creating this thread as a central place for discussing it.</p>
<p>PR <a href="https://github.com/rust-lang/rust/pull/91065">https://github.com/rust-lang/rust/pull/91065</a> recently landed, so we now have a test for the original <code>EvaluatedToOkModuloRegions</code> incr comp fingerprint ICE. This should allow us to be more confident in making changes to projection caching/deduplication.</p>
<p>There are two main oustanding issues: An enormous performance regression when compiling certain crates (<a href="https://github.com/rust-lang/rust/issues/89195">https://github.com/rust-lang/rust/issues/89195</a>), and a spurious compilation failure (<a href="https://github.com/rust-lang/rust/issues/90662">https://github.com/rust-lang/rust/issues/90662</a>)</p>
<p>The spurious compilation failure is an issue with the 'speculative' evaluation of predicates that I introduced. There doesn't seem to be a good way to fix that, so I believe that we should remove it entirely.</p>
<p>There are three open PRs that all perform some form of projection obligation de-duplication: <a href="https://github.com/rust-lang/rust/pull/84944">https://github.com/rust-lang/rust/pull/84944</a>, <a href="https://github.com/rust-lang/rust/pull/90423">https://github.com/rust-lang/rust/pull/90423</a>, <a href="https://github.com/rust-lang/rust/pull/91186">https://github.com/rust-lang/rust/pull/91186</a>. They are all pretty similar, but differ in where exactly the deduplication is performed, and additional performance optimizations around duplicate checking.</p>
<p>PR <a href="https://github.com/rust-lang/rust/pull/89831">https://github.com/rust-lang/rust/pull/89831</a> re-introduces a different form of projection-related caching that I had previously removed. It also removes 'speculative evaluation', though I could split that out into another PR.</p>
<p>I think we should decide on a preferred de-duplication strategy, and then merge the PR corresponding to that strategy. We can then attempt to remove speculative evaluation, and then look at re-introducing the 'projection completion cache' if it's still necessary for performance.</p>
<p>cc <span class="user-mention" data-user-id="216206">@lcnr</span> <span class="user-mention" data-user-id="330154">@The 8472</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="232957">@Jack Huey</span></p>



<a name="264238282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264238282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264238282">(Dec 08 2021 at 23:53)</a>:</h4>
<p>(I think the "spurious compilation failure" link is incorrect)</p>



<a name="264238691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264238691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264238691">(Dec 08 2021 at 23:58)</a>:</h4>
<p>Thanks, fixed</p>



<a name="264238760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264238760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264238760">(Dec 09 2021 at 00:00)</a>:</h4>
<p>Personally, I think we can start by merging <a href="https://github.com/rust-lang/rust/issues/90423">#90423</a> as it is the smallest and is ready to go. After that, we can evaluate if deduplication in other places is still worthwhile.</p>



<a name="264238885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264238885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264238885">(Dec 09 2021 at 00:00)</a>:</h4>
<p>Very interested to hear others' opinions though!</p>



<a name="264239063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264239063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264239063">(Dec 09 2021 at 00:02)</a>:</h4>
<p>I have tested <a href="https://github.com/rust-lang/rust/issues/84944">#84944</a> against the reproducers in <a href="https://github.com/rust-lang/rust/issues/74456">#74456</a> and <a href="https://github.com/rust-lang/rust/issues/91598">#91598</a> <br>
I think the others should check if they solve those cases too.</p>



<a name="264239703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264239703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264239703">(Dec 09 2021 at 00:09)</a>:</h4>
<p>I'm having trouble testing <a href="https://github.com/rust-lang/rust/issues/74456">https://github.com/rust-lang/rust/issues/74456</a> - one of the dependencies is parsing the rustc version, and is crashing with a stage1 compiler</p>



<a name="264239722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264239722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264239722">(Dec 09 2021 at 00:09)</a>:</h4>
<p>Organizing the perf reports:</p>
<p><a href="https://github.com/rust-lang/rust/issues/84944">#84944</a> -&gt; <a href="https://perf.rust-lang.org/compare.html?start=2d11e257945c710d406e77903764ad4b7a52bda5&amp;end=cfbeb503faad5f1b68441b15f8f2660bbe95bfa8">perf run</a> from May, most likely outdated. I suspect the diesel doc win was already usurped by another PR.<br>
<a href="https://github.com/rust-lang/rust/issues/90423">#90423</a> -&gt; <a href="https://perf.rust-lang.org/compare.html?start=0fb1c371d4a14f9ce7a721d8aea683a6e6774f6c&amp;end=a01d1671ef29634b4dd21dcd4342a2981fabcdf7">perf run</a><br>
<a href="https://github.com/rust-lang/rust/issues/91186">#91186</a> -&gt; <a href="https://perf.rust-lang.org/compare.html?start=dd549dcab404ec4c7d07b5a83aca5bdd7171138f&amp;end=1937cf62d0cb08000a49346c146830a7de817de3">perf run</a><br>
<a href="https://github.com/rust-lang/rust/issues/89831">#89831</a> -&gt; <a href="https://perf.rust-lang.org/compare.html?start=5dab47dcd8267b8769421b46532414ec36d625e3&amp;end=c80bb240f9760b0b0ed2e6045d60508129d31f26">perf run</a></p>



<a name="264239794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264239794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264239794">(Dec 09 2021 at 00:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication/near/264239703">said</a>:</p>
<blockquote>
<p>I'm having trouble testing <a href="https://github.com/rust-lang/rust/issues/74456">https://github.com/rust-lang/rust/issues/74456</a> - one of the dependencies is parsing the rustc version, and is crashing with a stage1 compiler</p>
</blockquote>
<p>Yeah, it required some minor patches to get it to work, but it still reproduced with them. Let's see if I still have them</p>



<a name="264239879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264239879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264239879">(Dec 09 2021 at 00:11)</a>:</h4>
<p>We should see if we can add <a href="https://github.com/rust-lang/rust/issues/91598">https://github.com/rust-lang/rust/issues/91598</a> to rustc-perf, if we can get the compilation time back to the ~1 second it was before the regression</p>



<a name="264239933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264239933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264239933">(Dec 09 2021 at 00:12)</a>:</h4>
<p>or a minimized version of it</p>



<a name="264240086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240086">(Dec 09 2021 at 00:14)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Subject: [PATCH 2/2] make reproducer work

---
 Cargo.toml          |  5 ++++-
 core-error/build.rs | 12 ++----------
 2 files changed, 6 insertions(+), 11 deletions(-)

diff --git a/Cargo.toml b/Cargo.toml
index 0314eda..d82b998 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -13,4 +13,7 @@ serde = { version = &quot;1.0.113&quot;, features = [&quot;derive&quot;] }
 futures = &quot;0.3.5&quot;

 [workspace]
-members = [&quot;thiserror/impl&quot;, &quot;protocol/derive&quot;, &quot;protocol&quot;, &quot;protocol-mve-transport&quot;, &quot;core-error&quot;, &quot;thiserror&quot;, &quot;core-futures-io&quot;, &quot;erasure-traits&quot;]
\ No newline at end of file
+members = [&quot;thiserror/impl&quot;, &quot;protocol/derive&quot;, &quot;protocol&quot;, &quot;protocol-mve-transport&quot;, &quot;core-error&quot;, &quot;thiserror&quot;, &quot;core-futures-io&quot;, &quot;erasure-traits&quot;]
+
+[patch.crates-io]
+core-error = { path = &quot;./core-error&quot; }
\ No newline at end of file
diff --git a/core-error/build.rs b/core-error/build.rs
index 8673872..b1dbbf7 100644
--- a/core-error/build.rs
+++ b/core-error/build.rs
@@ -1,13 +1,5 @@
-extern crate version_check;
-
 fn main() {
-    let (version, _channel, _date) = version_check::triple().expect(&quot;Rustc to give us its version&quot;);
-
-    for i in 0..65536 {
-        if version.at_least(&amp;format!(&quot;1.{}.0&quot;, i)) {
-            println!(&quot;cargo:rustc-cfg=rustc_1_{}_0&quot;, i)
-        } else {
-            break;
-        }
+    for i in 0..58 {
+        println!(&quot;cargo:rustc-cfg=rustc_1_{}_0&quot;, i);
     }
 }
--
2.33.1
</code></pre></div>



<a name="264240175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240175">(Dec 09 2021 at 00:15)</a>:</h4>
<p>I think the issue was that the version parser doesn't like the -dev suffix on local builds.</p>



<a name="264240380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240380">(Dec 09 2021 at 00:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication/near/264239879">said</a>:</p>
<blockquote>
<p>We should see if we can add <a href="https://github.com/rust-lang/rust/issues/91598">https://github.com/rust-lang/rust/issues/91598</a> to rustc-perf, if we can get the compilation time back to the ~1 second it was before the regression</p>
</blockquote>
<p>Anything that takes &gt;5s is probably too long, but I'm guessing removing some of the type complexity to minimize that test is pretty straightforward, I'd be happy to accept a PR adding it. We can probably get away with something a bit longer in the short-term but it would be good to make that very short :)</p>



<a name="264240397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240397">(Dec 09 2021 at 00:18)</a>:</h4>
<p>My PR <a href="https://github.com/rust-lang/rust/pull/90423">https://github.com/rust-lang/rust/pull/90423</a> definitely helps with <a href="https://github.com/rust-lang/rust/issues/91598">https://github.com/rust-lang/rust/issues/91598</a> - it now compiles in ~20 seconds (excluding dependencies)</p>



<a name="264240422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240422">(Dec 09 2021 at 00:18)</a>:</h4>
<p>which is not nearly as good as it was before, but is better than the &gt; 5 minutes and &gt; 7GB of memory that it takes for me without the patch</p>



<a name="264240468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240468">(Dec 09 2021 at 00:19)</a>:</h4>
<p>So, I think merging <a href="https://github.com/rust-lang/rust/pull/90423">https://github.com/rust-lang/rust/pull/90423</a> to start could be a good idea</p>



<a name="264240539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240539">(Dec 09 2021 at 00:20)</a>:</h4>
<p>I think one of the other deduplication PRs did a more complicated deduplication strategy (an explicit check and optimization for a case with a small number of predicates)</p>



<a name="264240559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240559">(Dec 09 2021 at 00:20)</a>:</h4>
<p>PR <a href="https://github.com/rust-lang/rust/pull/91186">https://github.com/rust-lang/rust/pull/91186</a> does that</p>



<a name="264240687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240687">(Dec 09 2021 at 00:22)</a>:</h4>
<p>that PR appears to add the deduplication in pretty much the same spot as mine</p>



<a name="264240713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240713">(Dec 09 2021 at 00:22)</a>:</h4>
<p>No, it also deduplicates the whole vec that's being extended, not just the values that are being added. I have seen cases where that function would try to add only duplicates to an obligation vec containing elements. I haven't checked which cases drive the compile time explosions though.</p>



<a name="264240726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240726">(Dec 09 2021 at 00:23)</a>:</h4>
<p>ah, I see</p>



<a name="264240744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264240744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264240744">(Dec 09 2021 at 00:23)</a>:</h4>
<p>the best-case performance improvement is larger (6.7% vs 6.0%). Should we merge it instead of mine?</p>



<a name="264241045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264241045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264241045">(Dec 09 2021 at 00:27)</a>:</h4>
<p>Well, it has the downside that it may end up recomputing the hashset for deduplication more often. So there could in principle be some pathological cases where it negatively impacts compile times that don't happen to be covered by perf rlo.<br>
I have tried to minimize the impact of such a scenario by amortizing the deduplication (running on every vec expansion, i.e. powers of two growth).<br>
That still leaves one possible pathological case where something tries to add a single duplicate item at a time many times.</p>
<p>A better solution is possible but it requires wider changes. Basically replacing the <code>Vec</code> with an ordered set.</p>



<a name="264248958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264248958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264248958">(Dec 09 2021 at 02:26)</a>:</h4>
<p>I think the first best step is to merge <a href="https://github.com/rust-lang/rust/issues/90423">#90423</a></p>



<a name="264249007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264249007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264249007">(Dec 09 2021 at 02:27)</a>:</h4>
<p>Then we can see if removing the extra deduplication as <a href="https://github.com/rust-lang/rust/issues/84944">#84944</a> helps</p>



<a name="264249066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264249066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264249066">(Dec 09 2021 at 02:28)</a>:</h4>
<p>Then also see how <em>only</em> removing speculative execution looks.</p>



<a name="264249073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264249073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264249073">(Dec 09 2021 at 02:29)</a>:</h4>
<p>(Since that should fix the regressions)</p>



<a name="264249085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264249085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264249085">(Dec 09 2021 at 02:29)</a>:</h4>
<p>Those together should fix the regressions in both behavior and moderately in performance</p>



<a name="264249095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264249095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264249095">(Dec 09 2021 at 02:29)</a>:</h4>
<p>We can then try to win back more perf with completion, etc.</p>



<a name="264638694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264638694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264638694">(Dec 12 2021 at 19:11)</a>:</h4>
<p>PR <a href="https://github.com/rust-lang/rust/pull/90423">https://github.com/rust-lang/rust/pull/90423</a> has been merged - it turned out to only cause a very small regression</p>



<a name="264740688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264740688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264740688">(Dec 13 2021 at 17:28)</a>:</h4>
<p>Any way we can get one of the one of the  perf regressions test cases (<a href="https://github.com/rust-lang/rust/issues/91598">#91598</a>/#89195/#89601/#91830) as a perf benchmark? Also...should those issued be closed?</p>



<a name="264749755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264749755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264749755">(Dec 13 2021 at 18:27)</a>:</h4>
<p>Has the reproducer in <a href="https://github.com/rust-lang/rust/issues/74456">#74456</a> been checked?</p>



<a name="264757512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/264757512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#264757512">(Dec 13 2021 at 19:29)</a>:</h4>
<p>I don't know</p>



<a name="265225577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Projection%20caching/deduplication/near/265225577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Projection.20caching.2Fdeduplication.html#265225577">(Dec 16 2021 at 21:59)</a>:</h4>
<p>Ran the testcase from <a href="https://github.com/rust-lang/rust/issues/74456">#74456</a> against master, memory or compile times don't explode anymore.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>