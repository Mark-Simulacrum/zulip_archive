<html>
<head><meta charset="utf-8"><title>impl candidate selection and param autoref - issue #92178 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20candidate.20selection.20and.20param.20autoref.20-.20issue.20.2392178.html">impl candidate selection and param autoref - issue #92178</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265884439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20candidate%20selection%20and%20param%20autoref%20-%20issue%20%2392178/near/265884439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20candidate.20selection.20and.20param.20autoref.20-.20issue.20.2392178.html#265884439">(Dec 23 2021 at 05:15)</a>:</h4>
<p>Hey y'all! I'm investigating <a href="https://github.com/rust-lang/rust/issues/92178">#92178</a> (<a href="https://github.com/rust-lang/rust/issues/92178">https://github.com/rust-lang/rust/issues/92178</a>) and I think I understand why the issue is occuring. I commented in the original issue, but basically:</p>
<p>We try to call <code>Add</code> on a <code>String</code> and a <code>&amp;String</code>. Right now, we have one candidate for <code>impl Add&lt;_&gt; for String</code> in std, and this works fine. <br>
The issue arises when adding another relevant <code>Add</code> impl in scope (by implementing <code>Add&lt;Other&gt; for String</code> locally, or in the issue's case, <code>use</code>ing a module which does this). <br>
This causes us to skip the short-circuiting logic in <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs#L153"><code>SelectionContext::candidate_from_obligation_no_cache</code> @ L153</a>. <br>
Since we don't short-circuit, we try winnowing the (in this case, two) relevant <code>impl Add for String</code> candidates, which fails to account for autoref coersion in the parameter.. leading to us collecting zero candidate impls, and reporting "<code>Add&lt;&amp;String&gt;</code> is not implemented for <code>String</code>".</p>
<p>So my questions are: </p>
<ol start="0">
<li>This isn't due to any recent change in trait selection behavior that I'm missing, right?</li>
<li>Do we want to account for parameter autoref in impl candidate winnowing? </li>
<li>If so, how? I'd love to help implement this change.</li>
<li>If not, do we want to add <code>Add&lt;&amp;String&gt; for String</code> to fix the github issue (and related <a href="https://github.com/rust-lang/rust/issues/92209">#92209</a>)?</li>
</ol>
<p>I'd love to help fixing this issue, but I don't think I should start touching fundamental trait selection logic without asking whether we want this behavior in the first place.</p>



<a name="265884519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20candidate%20selection%20and%20param%20autoref%20-%20issue%20%2392178/near/265884519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20candidate.20selection.20and.20param.20autoref.20-.20issue.20.2392178.html#265884519">(Dec 23 2021 at 05:17)</a>:</h4>
<p>side-note: Does this belong in t-lang or here? Or perhaps another stream? wg-traits seemed a bit too chalk-focused :^)</p>



<a name="265885925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20candidate%20selection%20and%20param%20autoref%20-%20issue%20%2392178/near/265885925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20candidate.20selection.20and.20param.20autoref.20-.20issue.20.2392178.html#265885925">(Dec 23 2021 at 05:49)</a>:</h4>
<p><em>Correction</em>: </p>
<blockquote>
<p>we try winnowing the (in this case, two) relevant impl Add for String candidates, which fails to account for autoref coersion in the parameter.. leading to us collecting zero candidate impls,</p>
</blockquote>
<p>So this is actually is not exactly what happens. <br>
So first we try to solve <code>String as Add&lt;_&gt;</code> which for the 1 impl case, short-circuits as above. In the case we have our custom impl, we call this ambiguous since we have 2 impl candidates. Then inferencing progresses, and we infer the type variable to be <code>&amp;String</code>. Then we try solving <code>String as Add&lt;&amp;String&gt;</code> which fails, of course.</p>
<p>So integrating autoref into impl candidate winnowing won't fix this actually. This is really just due to the fact that <code>Add</code> currently has one impl candidate for <code>String</code>, and adding another one breaks things :/</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>