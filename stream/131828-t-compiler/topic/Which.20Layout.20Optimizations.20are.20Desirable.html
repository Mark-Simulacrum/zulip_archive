<html>
<head><meta charset="utf-8"><title>Which Layout Optimizations are Desirable · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html">Which Layout Optimizations are Desirable</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263784182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263784182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263784182">(Dec 05 2021 at 19:17)</a>:</h4>
<p>I've been thinking about layout optimizations a little recently, and have a question. I realize this may have been asked before, so links to previous discussions are greatly appreciated. Consider <code>type S = Option&lt;Option&lt;(NonZeroU8, u8)&gt;&gt;;</code> it is possible to layout optimize this into 2 bytes by having</p>
<div class="codehilite"><pre><span></span><code>Some(Some(a, b)) =&gt; [a, b]
Some(None) =&gt; [0, 1]
None =&gt; [0, 0]
</code></pre></div>
<p>I will call this the "small" layout. Alternatively, one could choose not to optimize this much, and give this type a size of 3 bytes, with</p>
<div class="codehilite"><pre><span></span><code>Some(Some([a, b])) =&gt; [0, a, b]
Some(None) =&gt; [1, x, x]
None =&gt; [2, x, x]
</code></pre></div>
<p>where <code>x</code> represent padding bytes. I will call this the "large" layout. In either case the alignment is <code>1</code>. (Neither are what this currently compiles to, but that is not the point). Ignoring implementation difficulties for a second, which version do we want? I assume in general the first is better, but I see an advantage to the second as well: Consider the function</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">write</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="n">S</span><span class="p">;</span><span class="w"> </span><span class="mi">1000</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">None</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In the case of the large layout, this can compile to repeated invocations of <code>mov byte ptr [rdi] 2</code>. In the case of the small layout, this instead compiles to repeated invocations of <code>mov word ptr [rdi] 0</code>. Importantly, that second write is a <em>potentially unaligned</em> write, unlike the first one. That means that in a case like this, the relative performance of this function for these two layouts is at least unclear (I may try and see if I can bench this later).</p>
<p>Is there some general guiding principle for how to decide what is better? Speaking abstractly, the "cause" of this kind of pessimization is the size of the tag growing from 1 byte to 2. These kinds of issues sound like they'll get especially complicated with types like <code>Vec&lt;T&gt;</code>, where we could realistically give it <code>2^128</code> niches or <code>1</code> (on 64 bit anyway); we'd pay for the <code>2^128</code> niches with tags larger than a register.</p>



<a name="263785089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263785089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263785089">(Dec 05 2021 at 19:36)</a>:</h4>
<p>For vec specifically you could get away with a much cheaper optimization on many platforms by declaring the pointer to be in the range of 1 .. 2^63-1 since the upper half of the addressspace isn't available in userspace.</p>



<a name="263785602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263785602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263785602">(Dec 05 2021 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263785089">said</a>:</p>
<blockquote>
<p>For vec specifically you could get away with a much cheaper optimization on many platforms by declaring the pointer to be in the range of 1 .. 2^63-1 since the upper half of the addressspace isn't available in userspace.</p>
</blockquote>
<p>Good point. Even then though, the question of "how big do we make the tag" is not always clear.</p>



<a name="263785860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263785860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263785860">(Dec 05 2021 at 19:55)</a>:</h4>
<p>IMHO, all layout optimizations are desirable. In the end, we could even investigate enhanced optimizations for <code>Copy</code> types where we pack bits of neighbouring fields together.</p>



<a name="263786745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263786745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263786745">(Dec 05 2021 at 20:16)</a>:</h4>
<p>runtime memory compression! ram doubler!</p>



<a name="263786850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263786850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263786850">(Dec 05 2021 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263785860">said</a>:</p>
<blockquote>
<p>In the end, we could even investigate enhanced optimizations for <code>Copy</code> types where we pack bits of neighbouring fields together.</p>
</blockquote>
<p>I'd like to see that, but I think it requires an opt-in since it's incompatible with getting <code>&amp;mut</code> to the fields.  Previous conversation: <a href="https://internals.rust-lang.org/t/towards-even-smaller-structs/14686/3?u=scottmcm">https://internals.rust-lang.org/t/towards-even-smaller-structs/14686/3?u=scottmcm</a></p>



<a name="263787351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787351">(Dec 05 2021 at 20:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263785860">said</a>:</p>
<blockquote>
<p>IMHO, all layout optimizations are desirable. In the end, we could even investigate enhanced optimizations for <code>Copy</code> types where we pack bits of neighbouring fields together.</p>
</blockquote>
<p>Indeed, although, having looked at some of the ways rustc layout optimizes right now, this kind of thing seems to be fairly far from the first steps for rustc. For example, even this type:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">S</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Large</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Small</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is currently 32 bytes, despite it being unambiguously better for it to be 24 bytes.</p>



<a name="263787512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787512">(Dec 05 2021 at 20:34)</a>:</h4>
<p>I don't know that there is a way go have that by 24 bytes.</p>



<a name="263787551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787551">(Dec 05 2021 at 20:34)</a>:</h4>
<p>The u64 wants to be aligned. So the niche would have to go into the 3rd value of vec, which currently is...</p>



<a name="263787565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787565">(Dec 05 2021 at 20:35)</a>:</h4>
<p>the length field</p>



<a name="263787568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787568">(Dec 05 2021 at 20:35)</a>:</h4>
<p>It could theoretically fit in any of the fields, but I don't think there's enough of a niche to stick the entire value in.</p>



<a name="263787572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787572">(Dec 05 2021 at 20:35)</a>:</h4>
<p>And length has to cover 0..usize::max.</p>



<a name="263787626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787626">(Dec 05 2021 at 20:36)</a>:</h4>
<p>In theory, you could do something with cap=0, len=value but that just seems too absolutely magic.</p>



<a name="263787673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787673">(Dec 05 2021 at 20:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263787568">said</a>:</p>
<blockquote>
<p>It could theoretically fit in any of the fields, but I don't think there's enough of a niche to stick the entire value in.</p>
</blockquote>
<p>There is. You can have</p>
<div class="codehilite"><pre><span></span><code>Large([ptr, len, capacity]) =&gt; [ptr, len, cap]
Small(val) =&gt; [0, val, x]
</code></pre></div>
<p>And this is not even that magic, I see a fairly simple way to do it in general.</p>



<a name="263787691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787691">(Dec 05 2021 at 20:38)</a>:</h4>
<p>Oh yeah, true.</p>



<a name="263787738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787738">(Dec 05 2021 at 20:38)</a>:</h4>
<p>hrrm, right. then why doesn't it do that already? ptr is nonnull</p>



<a name="263787779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787779">(Dec 05 2021 at 20:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263787738">said</a>:</p>
<blockquote>
<p>hrrm, right. then why doesn't it do that already? ptr is nonnull</p>
</blockquote>
<p>The "fundamental" reason is that the <code>Vec</code> reports its niche as <code>0..1</code>, not <code>0..2^128</code>, if I understand correctly. The thing is though, doing this kind of layouting without lots of global analysis is just a little tricky</p>



<a name="263787854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787854">(Dec 05 2021 at 20:41)</a>:</h4>
<p>but it only needs a single niche to represent "not the variant containing a vec", why would it need 0..2^128 just to store the discriminant?</p>



<a name="263787921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787921">(Dec 05 2021 at 20:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263787854">said</a>:</p>
<blockquote>
<p>but it only needs a single niche to represent "not the variant containing a vec", why would it need 0..2^128 just to store the discriminant?</p>
</blockquote>
<p>Not quite sure what you're saying here, can you rephrase?</p>



<a name="263787942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263787942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263787942">(Dec 05 2021 at 20:43)</a>:</h4>
<p>The "correct" way to lay that type out is even</p>
<div class="codehilite"><pre><span></span><code>Large([ptr, len, capacity]) =&gt; [ptr, len, cap]
Small(val) =&gt; [0, 0, val]
</code></pre></div>
<p>since now <code>E</code> has a niche nearly the size of the one of <code>Vec</code>, and so we could add <code>2^64-1</code> more variants that look like <code>Small</code> to <code>E</code> without growing the size</p>



<a name="263788089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263788089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263788089">(Dec 05 2021 at 20:46)</a>:</h4>
<p>Oh, I think I understand, the issue is that the variant payload would have to participate in the optimization, not just for finding a place to stash the tag.</p>



<a name="263788380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263788380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263788380">(Dec 05 2021 at 20:53)</a>:</h4>
<p>Yes, that is the case. The reason this is difficult to do in general though is issues like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">First</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Second</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">Bad</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">EV</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w"> </span><span class="c1">// from previous example</span>
<span class="w">    </span><span class="n">FV</span><span class="p">(</span><span class="n">F</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>where we first compute the layout of <code>F</code> to be</p>
<div class="codehilite"><pre><span></span><code>First(a) =&gt; [0, a]
Second(a) =&gt; [1, a]
</code></pre></div>
<p>Unfortunately now there's no way to lay out <code>B</code> in 24 bytes, since <code>EV</code> would have to have the same exact layout as <code>E</code> (no extra bytes for a tag), but <code>F</code> now has nowhere to go, with the layout as computed</p>



<a name="263788446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263788446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263788446">(Dec 05 2021 at 20:54)</a>:</h4>
<p>Of course, if we knew about <code>Bad</code> when computing the layout of <code>F</code>, we could instead have <code>F</code> look like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">First</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">]</span><span class="w"></span>
<span class="n">Second</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>and now <code>F</code> can be put in the bytes <code>8..24</code> without issue, but that kind of analysis seems hard and essentially has to be global</p>



<a name="263788889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263788889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263788889">(Dec 05 2021 at 21:03)</a>:</h4>
<p>I don't think for <code>S</code> you would need global analysis. Sure, another enum around S would have to add some extra space, but it would be no worse off because without optimization S would already have been one usize larger.<br>
So in that case it's only necessary for <code>S::Small</code> to move its payload around, but that's still more than what currently happens.</p>
<p>Also, you forgot to declare <code>E</code>  ;)</p>



<a name="263788907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263788907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263788907">(Dec 05 2021 at 21:03)</a>:</h4>
<p>It says <code>// from previous example</code> :P</p>



<a name="263789167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789167">(Dec 05 2021 at 21:08)</a>:</h4>
<p>...and it was called <code>S</code> in the previous example. Oops</p>



<a name="263789300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789300">(Dec 05 2021 at 21:11)</a>:</h4>
<p>Ah, now it makes more sense</p>



<a name="263789386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789386">(Dec 05 2021 at 21:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263788889">said</a>:</p>
<blockquote>
<p>I don't think for <code>S</code> you would need global analysis. Sure, another enum around S would have to add some extra space, but it would be no worse off because without optimization S would already have been one usize larger.<br>
So in that case it's only necessary for <code>S::Small</code> to move its payload around, but that's still more than what currently happens.</p>
<p>Also, you forgot to declare <code>E</code>  ;)</p>
</blockquote>
<p>Yes, absolutely, there is an option here to improve the layout of <code>S</code> but not <code>Bad</code>, but if we want to get the "best possible" layout optimizations in the long term, the algorithm could not simply compute the layout of a type on the basis of its fields</p>



<a name="263789467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789467">(Dec 05 2021 at 21:14)</a>:</h4>
<p>Oh, this problem is actually pretty trivially NP-Hard too. Fun.</p>



<a name="263789521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789521">(Dec 05 2021 at 21:15)</a>:</h4>
<p>best possible depends on constraints anyway. otherwise we can escalate further and demand PGO</p>



<a name="263789634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789634">(Dec 05 2021 at 21:17)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/46213">#46213</a></p>



<a name="263789767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789767">(Dec 05 2021 at 21:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263789634">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/rust/issues/46213">#46213</a></p>
</blockquote>
<p>see <a href="https://github.com/rust-lang/rust/pull/75866">https://github.com/rust-lang/rust/pull/75866</a> for the latest (afaik) attempt at that<br>
it works, but it causes a perf regression, likely due to match/"get discriminant" codegen being more complex for niche layouts</p>



<a name="263789876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263789876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263789876">(Dec 05 2021 at 21:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263789521">said</a>:</p>
<blockquote>
<p>best possible depends on constraints anyway. otherwise we can escalate further and demand PGO</p>
</blockquote>
<p>Well, yes, by "best possible" I mean giving each type a layout that is not bigger than the smallest possible layout for that type, with the restriction being that the layout must support referencing all fields</p>



<a name="263790068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263790068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263790068">(Dec 05 2021 at 21:27)</a>:</h4>
<p>Ok I have some ideas here actually, let me try and implement a proof of concept</p>



<a name="263803869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263803869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263803869">(Dec 06 2021 at 02:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/263785860">said</a>:</p>
<blockquote>
<p>IMHO, all layout optimizations are desirable. In the end, we could even investigate enhanced optimizations for <code>Copy</code> types where we pack bits of neighbouring fields together.</p>
</blockquote>
<p>So I've written a little code for this, and I'm pretty sure that you definitely dont want <em>all</em> layout optimizations :P . In particular, consider the types below: (I use <code>U</code> for <code>usize</code>)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Long</span><span class="p">(</span><span class="n">NonZeroU</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">U</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Long</span><span class="p">(</span><span class="n">Long</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Short</span><span class="p">(</span><span class="n">U</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Lets assume the desirable layout of <code>Long</code> is the niched value first and the array after (actually, this is wrong on little endian, but that doesn't actually matter). This means that now <code>Long</code> has a fairly big niche, <code>2^(64*3)</code> values! Now how do you lay out <code>E</code>? Well, <code>E</code> will have the same size as <code>Long</code>, so the long variant is easy, but how about the <code>Short</code> variant. Well, the <em>most</em> space efficient thing to do is this:</p>
<div class="codehilite"><pre><span></span><code>Short(a) =&gt; [0, 0, 0, a]
</code></pre></div>
<p>But that's a perf disaster, since now <code>matches!(x, E::Short(_))</code> now requires loading 3 usizes and making sure they're all zero. You can make this much faster by instead laying it out like this:</p>
<div class="codehilite"><pre><span></span><code>Short(a) =&gt; [0, a, x, x] // x is padding
</code></pre></div>
<p>Unfortunately, if someone in another crate who depends on my <code>E</code> type comes along and writes</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">F</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">E</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Other</span><span class="p">([</span><span class="n">U</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>we're in trouble. With the slow layout, <code>F</code> would have size <code>4*U</code> since we can fit <code>Other([a, b]) =&gt; [0, 1, a, b]</code>. On the other hand, with the big layout, we can't do any such thing and now <code>F</code> is one <code>U</code> bigger. Whether this particular trade-off is desirable, who knows, but if you imagine changing the <code>3</code> in long to some <code>N</code> much bigger (and then having <code>Other([U; N-1])</code>) you definitely do not want this anymore, and want to just take the memory hit</p>



<a name="263803966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263803966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263803966">(Dec 06 2021 at 02:58)</a>:</h4>
<p>(on the other hand, if you had PGO data telling you the <code>Short</code> variant is extremely cold...)</p>



<a name="263806506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263806506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263806506">(Dec 06 2021 at 04:00)</a>:</h4>
<p>I actually take some of that back, there is a general way to do decent things here</p>



<a name="263823294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263823294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263823294">(Dec 06 2021 at 09:07)</a>:</h4>
<p>I'm currently working on optimising discriminant switches to land the PR that was postponed</p>



<a name="263823584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/263823584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#263823584">(Dec 06 2021 at 09:10)</a>:</h4>
<p>Wrote some thoughts about that here: <a href="https://twitter.com/nokusu/status/1467533619321503744">https://twitter.com/nokusu/status/1467533619321503744</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/nokusu/status/1467533619321503744"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/baaa98f97f785abbde33bb21439562aa83878aca/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f3433303730373837323431393135313837322f774d42616e7a704e5f6e6f726d616c2e706e67"></a><p>I decided to go a different route, I'm trying to optimize them switches on the fly during monomorphization, instead of introducing a new kind of terminator.</p><span>- Anthony Ramine (@nokusu)</span></div></div>



<a name="264176826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264176826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264176826">(Dec 08 2021 at 16:01)</a>:</h4>
<p>Random thought while I'm in the monomorphization of discriminant-related code: we could also make enums with uninhabited variants smaller.</p>
<p>I know that rustc needs to reserve space for uninhabited variants because of partial initialisations, but that doesn't mean it needs to reserve space for an actual variant with a discriminant.</p>



<a name="264176987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264176987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264176987">(Dec 08 2021 at 16:02)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=af13e24a8c4c598dcf0f070af9b96fe7">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=af13e24a8c4c598dcf0f070af9b96fe7</a> Consider this, there would be nothing wrong making both types be 24 bytes, right?</p>



<a name="264213442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264213442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264213442">(Dec 08 2021 at 20:12)</a>:</h4>
<blockquote>
<p>I know that rustc needs to reserve space for uninhabited variants because of partial initialisations</p>
</blockquote>
<p>By "partial initialisations", do you mean something like this (<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=df6e88e1b1e6bd56749b9458581f9d20">playground</a>)?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">MaybeUninit</span><span class="o">&lt;</span><span class="n">UninhabitedButLarge</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">().</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="264214831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264214831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264214831">(Dec 08 2021 at 20:23)</a>:</h4>
<p>Kind of. There was a discussion of wanting to make it possible to also write </p>
<div class="codehilite"><pre><span></span><code>let x: UninhabitedButLarge;
x.0 = [0;3];
println!(&quot;{:?}&quot;, x.0);
</code></pre></div>



<a name="264233811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264233811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264233811">(Dec 08 2021 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/264213442">said</a>:</p>
<blockquote>
<blockquote>
<p>I know that rustc needs to reserve space for uninhabited variants because of partial initialisations</p>
</blockquote>
<p>By "partial initialisations", do you mean something like this (<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=df6e88e1b1e6bd56749b9458581f9d20">playground</a>)?</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">MaybeUninit</span><span class="o">&lt;</span><span class="n">UninhabitedButLarge</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">().</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>I dug that conversation back out <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264104953">here</a> yesterday for basically exactly this reason</p>



<a name="264233831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264233831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264233831">(Dec 08 2021 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263648">nox</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/264176987">said</a>:</p>
<blockquote>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=af13e24a8c4c598dcf0f070af9b96fe7">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=af13e24a8c4c598dcf0f070af9b96fe7</a> Consider this, there would be nothing wrong making both types be 24 bytes, right?</p>
</blockquote>
<p>Agreed, I've already implemented that one :P</p>



<a name="264234155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264234155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264234155">(Dec 08 2021 at 23:06)</a>:</h4>
<p>(locally, to be clear, I'm hoping to share by the end of the week)</p>



<a name="264235390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264235390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264235390">(Dec 08 2021 at 23:19)</a>:</h4>
<p>Nice</p>



<a name="264252928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264252928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264252928">(Dec 09 2021 at 03:39)</a>:</h4>
<p><span class="user-mention" data-user-id="310518">@Jake</span> That sounds awesome! I look forward to seeing possibilities for more layout optimizations.</p>



<a name="264473391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264473391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264473391">(Dec 10 2021 at 16:41)</a>:</h4>
<p>Current status: writing many tests to be sure I'm not breaking everyone's code hah. <a href="https://github.com/rust-lang/rust/compare/nox/i-need-a-niche-but-i-have-no-dog#diff-74a0e452d84e41c5e5df5307518b967e87da0ad574c67a55b2d772800bc870f8">https://github.com/rust-lang/rust/compare/nox/i-need-a-niche-but-i-have-no-dog#diff-74a0e452d84e41c5e5df5307518b967e87da0ad574c67a55b2d772800bc870f8</a></p>



<a name="264586005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264586005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264586005">(Dec 11 2021 at 21:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263648">nox</span> <a href="#narrow/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable/near/264473391">said</a>:</p>
<blockquote>
<p>Current status: writing many tests to be sure I'm not breaking everyone's code hah. <a href="https://github.com/rust-lang/rust/compare/nox/i-need-a-niche-but-i-have-no-dog#diff-74a0e452d84e41c5e5df5307518b967e87da0ad574c67a55b2d772800bc870f8">https://github.com/rust-lang/rust/compare/nox/i-need-a-niche-but-i-have-no-dog#diff-74a0e452d84e41c5e5df5307518b967e87da0ad574c67a55b2d772800bc870f8</a></p>
</blockquote>
<p>Can you check if your patch causes the <code>otherwise</code> branch in <code>bb0</code> in <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=44832a064ba1cc661f591aaadf22d6b9">this example</a> to be correctly marked as unreachable? (Don't worry if not, this feels only kind of related, and I can write an MIR opt pass to do this pretty easily)</p>



<a name="264587485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Which%20Layout%20Optimizations%20are%20Desirable/near/264587485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Which.20Layout.20Optimizations.20are.20Desirable.html#264587485">(Dec 11 2021 at 22:02)</a>:</h4>
<p>Actually, this probably should be done pre-monomorphization time anyway, so writing the pass regardless is probably right</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>