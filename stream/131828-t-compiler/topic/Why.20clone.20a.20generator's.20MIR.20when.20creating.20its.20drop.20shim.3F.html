<html>
<head><meta charset="utf-8"><title>Why clone a generator&#x27;s MIR when creating its drop shim? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html">Why clone a generator&#x27;s MIR when creating its drop shim?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263793336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263793336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263793336">(Dec 05 2021 at 22:42)</a>:</h4>
<p>The first thing that <code>create_generator_drop_shim</code> does is <a href="https://github.com/rust-lang/rust/blob/e2116acae59654bfab2a9729a024f3e2fd6d4b02/compiler/rustc_mir_transform/src/generator.rs#L921">clone the MIR of the original generator</a>, including its CFG. I found that strange, since presumably they do very different things (although I suppose both start with a switch on the generator state). Does anyone have some intuition about why things are done this way?</p>



<a name="263793429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263793429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263793429">(Dec 05 2021 at 22:44)</a>:</h4>
<p>I don't have the best understanding of the generator machinery, and I'm looking to improve it.</p>



<a name="263817545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263817545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263817545">(Dec 06 2021 at 07:59)</a>:</h4>
<p>The drop shim is added as field to the original generator mir: <a href="https://github.com/rust-lang/rust/blob/e2116acae59654bfab2a9729a024f3e2fd6d4b02/compiler/rustc_mir_transform/src/generator.rs#L1367">https://github.com/rust-lang/rust/blob/e2116acae59654bfab2a9729a024f3e2fd6d4b02/compiler/rustc_mir_transform/src/generator.rs#L1367</a></p>



<a name="263817564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263817564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263817564">(Dec 06 2021 at 07:59)</a>:</h4>
<p><code>create_generator_drop_shim</code> should probably take <code>&amp;Body</code> instead of <code>&amp;mut Body</code>.</p>



<a name="263881269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263881269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263881269">(Dec 06 2021 at 17:01)</a>:</h4>
<p>That's true, yes. But I still don't see why drop shim creation begins by cloning the body of the original generator instead of creating a fresh one and copying the source info. We don't need any of its locals (except the first), most of the CFG is irrelevant (except the first switch), and it means the drop shim is in the wrong MIR phase (see <a href="https://github.com/rust-lang/rust/issues/91576">#91576</a>).</p>



<a name="263881717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263881717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263881717">(Dec 06 2021 at 17:04)</a>:</h4>
<blockquote>
<p>We don't need any of its locals (except the first)</p>
</blockquote>
<p>Some of the locals are for the drop code I think. In addition the blocks with <code>GeneratorDrop</code> terminators need to have their statements copied.</p>



<a name="263882410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263882410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263882410">(Dec 06 2021 at 17:09)</a>:</h4>
<p>Ah, could you say more about the <code>GeneratorDrop</code>? Or if it's in the dev guide I can just go read.</p>



<a name="263882681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Why%20clone%20a%20generator%27s%20MIR%20when%20creating%20its%20drop%20shim%3F/near/263882681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Why.20clone.20a.20generator&#x27;s.20MIR.20when.20creating.20its.20drop.20shim.3F.html#263882681">(Dec 06 2021 at 17:10)</a>:</h4>
<p>Honestly I don't have much of a clue. I inferred this from <code>create_generator_drop_shim</code> and the place in <code>rustc_mir_built</code> where <code>GeneratorDrop</code> is created.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>