<html>
<head><meta charset="utf-8"><title>Incremental DCE before codegen · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html">Incremental DCE before codegen</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254883940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254883940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254883940">(Sep 26 2021 at 00:52)</a>:</h4>
<p>This is something ive been wondering, cg_ssa seems to codegen absolutely everything in a crate, despite it not being used by anything upstream.<br>
Has there ever been work on eliminating dead functions before they actually get to be codegenned by LLVM? This would have to be fully<br>
query based and incremental, but it may yield some gains since LLVM/the linker is doing less work. Or would this be too slow and complex compared to just letting something else handle it?</p>



<a name="254884068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884068">(Sep 26 2021 at 00:54)</a>:</h4>
<p>we only codegen functions that are transitively used by an entry point of the crate (which can be "any public function" in an rlib)</p>



<a name="254884118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884118">(Sep 26 2021 at 00:55)</a>:</h4>
<p>thats odd, i had to implement my own DCE in a codegen im working on because rustc was trying to codegen everything inside of every crate</p>



<a name="254884283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884283">(Sep 26 2021 at 00:58)</a>:</h4>
<p>oh i misunderstood, yeah i was talking about global DCE, only codegenning functions used by upstream crates</p>



<a name="254884340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884340">(Sep 26 2021 at 00:59)</a>:</h4>
<p>although this would be odd to implement, because you may have to recompile the entire crate and regenerate the rlib if a function usage changes, either that or modifying the object file itself inside the rlib... it would be a mess</p>



<a name="254884347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884347">(Sep 26 2021 at 00:59)</a>:</h4>
<p>oh, across crates? I'm not sure how that would work, given that rustc is only invoked to compile one crate at a time</p>



<a name="254884408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884408">(Sep 26 2021 at 01:00)</a>:</h4>
<p>seems like mir-only rlibs would be more effective at addressing that problem</p>



<a name="254884486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884486">(Sep 26 2021 at 01:00)</a>:</h4>
<p>although they have the drawback of redoing a lot of work when there are many leaf crates that all use similar subsets of code, which I think is still unsolved</p>



<a name="254884529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884529">(Sep 26 2021 at 01:01)</a>:</h4>
<p>with mir-only rlibs youd kinda defeat the point, no? since youd have to recompile basically... everything (albeit only whats used) every time a function becomes used... which may trigger more functions to be used... so on and so on</p>



<a name="254884546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884546">(Sep 26 2021 at 01:02)</a>:</h4>
<p>well, not recompile, recodegen it i guess, pass the new mir through llvm</p>



<a name="254884624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884624">(Sep 26 2021 at 01:03)</a>:</h4>
<p>modifying the object file could be possible albeit a bit odd, but you would only want to do this in debug because llvm would generate worse code because it doesn't have access to other functions' LLVMIR</p>



<a name="254884751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254884751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254884751">(Sep 26 2021 at 01:04)</a>:</h4>
<blockquote>
<p>rustc is only invoked to compile one crate at a time</p>
</blockquote>
<p>yeah thats another big issue, you would need to codegen all the crates at the end instead of one at a time, it wouldnt yield perf drawbacks because you could do it in parallel but it would be a huge change from what rustc currently does</p>



<a name="254919093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254919093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254919093">(Sep 26 2021 at 10:11)</a>:</h4>
<p>Incremental would mitigate the everything problem</p>



<a name="254944783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254944783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254944783">(Sep 26 2021 at 16:49)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> i dont really see how, since codegen is not very incremental, wouldnt you have to only recompile certain mir functions then patch the object file?</p>



<a name="254949491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254949491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254949491">(Sep 26 2021 at 18:00)</a>:</h4>
<p>There are plenty of codegen units by default.</p>



<a name="254949719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20DCE%20before%20codegen/near/254949719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20DCE.20before.20codegen.html#254949719">(Sep 26 2021 at 18:02)</a>:</h4>
<p>oh right i totally forgot about cgus <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>