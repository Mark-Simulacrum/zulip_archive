<html>
<head><meta charset="utf-8"><title>Improving `Symbol::intern` · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html">Improving `Symbol::intern`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263370986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263370986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263370986">(Dec 01 2021 at 23:10)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_span/src/symbol.rs#L1737-L1756"><code>Symbol::intern</code></a> is sub-optimal in the "not already interned case", because it does two hash table lookups, one to check for existence, and then another to insert.</p>
<p>I tried fixing this. It's a bit fiddly because of the lifetimes, I came up with this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">intern</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">string</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Symbol</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">lock</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">inner</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">InternerInner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inner</span><span class="p">.</span><span class="n">deref_mut</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// SAFETY: This ties in with the similar `string` cast below.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">static_string1</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">inner</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="n">static_string1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Entry</span>::<span class="n">Occupied</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">Entry</span>::<span class="n">Vacant</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Symbol</span>::<span class="n">new</span><span class="p">(</span><span class="n">inner</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="c1">// SAFETY: `from_utf8_unchecked` is safe since we just allocated a</span>
<span class="w">                </span><span class="c1">// `&amp;str` which is known to be UTF-8.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">arena_string</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kt">str</span>::<span class="n">from_utf8_unchecked</span><span class="p">(</span><span class="n">inner</span><span class="p">.</span><span class="n">arena</span><span class="p">.</span><span class="n">alloc_slice</span><span class="p">(</span><span class="n">static_string1</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()))</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="c1">// SAFETY: It is safe to extend the arena allocation to `'static`</span>
<span class="w">                </span><span class="c1">// because we only access these while the arena is still alive.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">static_string2</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">arena_string</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="n">inner</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">static_string2</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="c1">//inner.names.insert(static_string2, name);  // njn: works!</span>
<span class="w">                </span><span class="n">entry</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w"> </span><span class="c1">// njn: doesn't work!</span>

<span class="w">                </span><span class="n">name</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But something is wrong, because I get lots of weird errors compiling <code>std</code>, things like this:</p>
<div class="codehilite"><pre><span></span><code>error[E0432]: unresolved import `self::platform`
    --&gt; library/core/src/num/wrapping.rs:1042:19
     |
1042 |     pub use self::platform::usize;
     |                   ^^^^^^^^ could not find `platform` in `self`

error: cannot find macro `bt` in this scope
  --&gt; library/core/src/../../stdarch/crates/core_arch/src/x86/bt.rs:27:9
   |
27 |         bt!(&quot;btl&quot;),
   |         ^^
</code></pre></div>
<p>But small programs compile successfully, so it's only slightly broken, not totally broken. And as the comments say, if I use <code>inner.names.insert</code> instead of <code>entry.insert</code>, it works.</p>
<p>So I'm puzzled. I don't know if the unsafe lifetime stuff is a problem, or the <code>deref_mut</code> is somehow a problem. Any suggestions would be welcome, thanks!</p>



<a name="263371062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263371062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263371062">(Dec 01 2021 at 23:11)</a>:</h4>
<p>(I used a different name for each string variable, unlike the original, because I had a bunch of assertions ensuring that they were all equal, and they were.)</p>



<a name="263373814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263373814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263373814">(Dec 01 2021 at 23:42)</a>:</h4>
<p>This is what <code>raw_entry</code> is for - you shouldn't need unsafe</p>



<a name="263373877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263373877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263373877">(Dec 01 2021 at 23:43)</a>:</h4>
<p><a href="https://docs.rs/hashbrown/0.11.2/hashbrown/struct.HashMap.html#method.raw_entry_mut">https://docs.rs/hashbrown/0.11.2/hashbrown/struct.HashMap.html#method.raw_entry_mut</a></p>



<a name="263374839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263374839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263374839">(Dec 01 2021 at 23:54)</a>:</h4>
<p>Are you sure? IMO, this is exactly what vanilla <code>entry</code> is for, to avoid a lookup+insertion combination</p>



<a name="263375087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375087">(Dec 01 2021 at 23:57)</a>:</h4>
<p>Oh wait hold on I misread</p>



<a name="263375185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375185">(Dec 01 2021 at 23:58)</a>:</h4>
<p>I think the issue is that <code>static_string1</code> and <code>static_string2</code> have different hashes somehow? Which seems odd, I'd expect it to hash the string contents and not the pointer</p>



<a name="263375245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375245">(Dec 01 2021 at 23:59)</a>:</h4>
<p>Right, I double-checked that <code>str</code> is hashed by contents.</p>



<a name="263375264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375264">(Dec 01 2021 at 23:59)</a>:</h4>
<p>And that's why I had assertions that all the strings were equal</p>



<a name="263375292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375292">(Dec 01 2021 at 23:59)</a>:</h4>
<p>The fact that it mostly works indicates something subtle/infrequent is happening</p>



<a name="263375402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375402">(Dec 02 2021 at 00:00)</a>:</h4>
<p>Most likely related to the <code>unsafe</code> blocks somehow</p>



<a name="263375501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375501">(Dec 02 2021 at 00:00)</a>:</h4>
<p>I don't much like the use of fake <code>static</code> for these arena-allocated strings, but I can't see how it's a problem</p>



<a name="263375512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375512">(Dec 02 2021 at 00:01)</a>:</h4>
<p>Could <code>arena.alloc</code> slice be reallocating <code>names</code> somehow? It seems weird since they're different fields but I'm not sure why else the entry would be different from a normal insert ...</p>



<a name="263375557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375557">(Dec 02 2021 at 00:01)</a>:</h4>
<p>Aren't you inserting the entry behind the argument to the function as the key right now?</p>



<a name="263375573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375573">(Dec 02 2021 at 00:01)</a>:</h4>
<p>The previous code used the arena string as the key</p>



<a name="263375624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375624">(Dec 02 2021 at 00:02)</a>:</h4>
<p>The function argument doesn't necessarily live long enough so if I see this right you are invoking UB here</p>



<a name="263375687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375687">(Dec 02 2021 at 00:02)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> right but that would allocate even if there's already an entry in the map</p>



<a name="263375755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375755">(Dec 02 2021 at 00:02)</a>:</h4>
<p>Yes but the key of the entry is a static string ref, what is actually being put there is only static due to the unsafe reborrow though</p>



<a name="263375765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375765">(Dec 02 2021 at 00:03)</a>:</h4>
<p>Or am I missing something here?</p>



<a name="263375881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263375881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263375881">(Dec 02 2021 at 00:04)</a>:</h4>
<p>Oh, I think I understand what you're saying</p>



<a name="263376046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376046">(Dec 02 2021 at 00:05)</a>:</h4>
<p><code>entry.insert(name)</code> is equivalent to <code>inner.names.insert(string, name)</code></p>



<a name="263376071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376071">(Dec 02 2021 at 00:05)</a>:</h4>
<p>Ye, and <code>string</code> doesn't live for <code>'static</code></p>



<a name="263376079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376079">(Dec 02 2021 at 00:05)</a>:</h4>
<p>Surprising that this doesn't blow up more quickly</p>



<a name="263376103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376103">(Dec 02 2021 at 00:06)</a>:</h4>
<p>Certainly surprising <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="263376175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376175">(Dec 02 2021 at 00:06)</a>:</h4>
<p>Maybe a lot of the strings being hashed are long-lived in practice</p>



<a name="263376183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376183">(Dec 02 2021 at 00:06)</a>:</h4>
<p>Sort of static-ish <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="263376185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376185">(Dec 02 2021 at 00:06)</a>:</h4>
<p>Thanks for the help!</p>



<a name="263376260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376260">(Dec 02 2021 at 00:07)</a>:</h4>
<p>So my mistake here was overlooking that <code>entry.insert(name)</code> sets key as well, not just the value</p>



<a name="263376339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376339">(Dec 02 2021 at 00:08)</a>:</h4>
<p>I probably can use <code>raw_entry_mut</code> to avoid hashing twice, I'll look at that</p>



<a name="263376588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263376588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263376588">(Dec 02 2021 at 00:11)</a>:</h4>
<p>This is the "Deferring the creation of an owned key until it is known to be required" use case</p>



<a name="263377356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263377356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263377356">(Dec 02 2021 at 00:21)</a>:</h4>
<p>All this is a classic case of "the bug is in the <code>unsafe</code> code you added" <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="263379109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263379109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263379109">(Dec 02 2021 at 00:44)</a>:</h4>
<p>Here's the <code>raw_entry_mut</code> version:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">intern</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">string</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Symbol</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">lock</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">inner</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">InternerInner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inner</span><span class="p">.</span><span class="n">deref_mut</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// One reason to use `raw_entry_mut`, according to its docs, is</span>
<span class="w">        </span><span class="c1">// "Deferring the creation of an owned key until it is known to be</span>
<span class="w">        </span><span class="c1">// required". That's exactly what we do here; the arena allocation</span>
<span class="w">        </span><span class="c1">// below creates an owned version of the `string` argument if</span>
<span class="w">        </span><span class="c1">// necessary.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// If we didn't use `raw_entry_mut`, we'd need a lookup followed by a</span>
<span class="w">        </span><span class="c1">// separate insert.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FxHasher</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">string</span><span class="p">.</span><span class="n">hash</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">inner</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">raw_entry_mut</span><span class="p">().</span><span class="n">from_key_hashed_nocheck</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">RawEntryMut</span>::<span class="n">Occupied</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">RawEntryMut</span>::<span class="n">Vacant</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Symbol</span>::<span class="n">new</span><span class="p">(</span><span class="n">inner</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="c1">// SAFETY: `from_utf8_unchecked` is safe since we just</span>
<span class="w">                </span><span class="c1">// allocated a `&amp;str` which is known to be UTF-8.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">string</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">str</span>::<span class="n">from_utf8_unchecked</span><span class="p">(</span><span class="n">inner</span><span class="p">.</span><span class="n">arena</span><span class="p">.</span><span class="n">alloc_slice</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()))</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="c1">// SAFETY: It is safe to extend the arena allocation to</span>
<span class="w">                </span><span class="c1">// `'static` because we only access these while the arena is</span>
<span class="w">                </span><span class="c1">// still alive.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">string</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="n">inner</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">entry</span><span class="p">.</span><span class="n">insert_hashed_nocheck</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">name</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="263379135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263379135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263379135">(Dec 02 2021 at 00:44)</a>:</h4>
<p>Now to see if it actually improves performance</p>



<a name="263437498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263437498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263437498">(Dec 02 2021 at 13:36)</a>:</h4>
<p>tangentially: I've seen the Predicate and Ty interner hash table resizing show up in profiles. But naive optimization attempts (<a href="https://github.com/rust-lang/rust/issues/90743">#90743</a>; setting higher initial sizes or more aggressive growth) lead to max-rss regressions larger than the instruction count gains.<br>
I don't know enough about compiler internals to do it in a smarter way. Maybe there are some bulk operations filling the interners that could provide a better size hint.</p>



<a name="263514087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Improving%20%60Symbol%3A%3Aintern%60/near/263514087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Improving.20.60Symbol.3A.3Aintern.60.html#263514087">(Dec 02 2021 at 23:23)</a>:</h4>
<p>The <code>Symbol::intern</code> change wasn't worth it in the end: <a href="https://github.com/rust-lang/rust/pull/91445/">https://github.com/rust-lang/rust/pull/91445/</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>