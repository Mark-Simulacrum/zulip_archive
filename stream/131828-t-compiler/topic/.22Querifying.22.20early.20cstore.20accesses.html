<html>
<head><meta charset="utf-8"><title>&quot;Querifying&quot; early cstore accesses · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html">&quot;Querifying&quot; early cstore accesses</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253737343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253737343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253737343">(Sep 17 2021 at 12:56)</a>:</h4>
<p>One of the benefits of the query system is memoization - if we calculated someting once we keep the result and don't calculate it anymore.<br>
This applies to decoding something from other crates' metadata - we decode something once and then keep the result.</p>
<p>Accesses to metadata (cstore) from <code>Resolver</code> during early compilation are basically identical to cstore accesses that happens later on from tcx through the query system, because anything in cstore is already compiled in advance and doesn't need to be built on the fly unlike the current crate's data.<br>
However we don't currently have any centralized system for memoizing such metadata decoding work, so it may be performed multiple times early from resolver (which is kind of an early tcx at this point), and then once more from tcx later on. This may be costly for heavy queries like e.g. <code>all_trait_implementations</code> in <a href="https://github.com/rust-lang/rust/pull/88679">https://github.com/rust-lang/rust/pull/88679</a>.</p>
<p>What is the easiest way to add a query-like system to resolver (for cstore accesses only for a start)?<br>
I can add a simple memoization scheme to <code>Resolver</code> only, but it would be good to somehow transfer the cache filled by this system to the later query system as well.<br>
It would also be better if it's compatible with plans for moving incremental compilation closer to compilation start, etc.</p>
<p>cc <span class="user-mention" data-user-id="248906">@cjgillot</span></p>



<a name="253738183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253738183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253738183">(Sep 17 2021 at 13:02)</a>:</h4>
<p>I did rather move to a scheme where accessing crate metadata doesn't require a separate decoding step, but can directly operate on the encoded metadata. I understand that this is a lot harder though, but for example <a href="https://github.com/rust-lang/rust/issues/82183">#82183</a> is already reducing the amount of decoding necessary.</p>



<a name="253738252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253738252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253738252">(Sep 17 2021 at 13:02)</a>:</h4>
<blockquote>
<p>What is the easiest way to add a query-like system to resolver (for cstore accesses only for a start)?</p>
</blockquote>
<p><code>OnceCell</code> maybe?</p>



<a name="253738855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253738855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253738855">(Sep 17 2021 at 13:06)</a>:</h4>
<p>Yeah, something like <code>OnceCell</code> would work for a resolver-only cache, but I guess the main question is how to avoid duplicate work if we a calling a heavy query like <code>all_trait_implementations</code> from <em>both</em> resolver and tcx.</p>



<a name="253739097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253739097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253739097">(Sep 17 2021 at 13:08)</a>:</h4>
<p>It could be part of CStore. That still requires a clone between the CStore cache and TyCtxt query cache though.</p>



<a name="253762791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253762791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253762791">(Sep 17 2021 at 15:49)</a>:</h4>
<p>IMHO, the query system is not the right tool if you are only interested in memoization. The main objective of the query system is depencency-tracking and avoiding recomputations. Using a special-purpose macro to generate a memoization system (with OnceCell) should be enough.</p>
<p>OTOH, one of the aims of the end-to-end query program is to allow using the query system for crate metadata decoding. But this is a very long program.</p>



<a name="253824444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/253824444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#253824444">(Sep 18 2021 at 00:24)</a>:</h4>
<p>I've implemented some memoization in <a href="https://github.com/rust-lang/rust/pull/89059">https://github.com/rust-lang/rust/pull/89059</a>, it avoids decoding things multiple times, but still requires cloning them every time.</p>



<a name="254195997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/254195997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#254195997">(Sep 21 2021 at 12:09)</a>:</h4>
<p>Update: it turns out that arenas used by tcx are long living, so they can be passed to cstore as well.<br>
So tcx queries don't even need to copy the cached results, they can reuse them directly - the result is a pointer to the tcx arena.<br>
(There are some issues with passing arenas through <code>BoxedResolver</code> due to lifetime parameters, which I worked around with hacks, but they are probably solvable.)</p>



<a name="254196969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/254196969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#254196969">(Sep 21 2021 at 12:17)</a>:</h4>
<p>For some reason it's still a regression for the <code>metadata_decode_entry_item_attrs</code> query (and a couple of similar queries), despite the difference being only a single <code>FsHashMap</code> lookup by <code>DefIndex</code>.</p>



<a name="254206259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%22Querifying%22%20early%20cstore%20accesses/near/254206259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.22Querifying.22.20early.20cstore.20accesses.html#254206259">(Sep 21 2021 at 13:26)</a>:</h4>
<p>I would like CStore to be reusable between different TyCtxt to make a compiler daemon possible that shares information that is most of the time unchanged like the CStore between multiple compilations.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>