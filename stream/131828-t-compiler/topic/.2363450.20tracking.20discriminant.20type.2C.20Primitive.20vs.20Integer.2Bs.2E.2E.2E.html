<html>
<head><meta charset="utf-8"><title>#63450 tracking discriminant type, Primitive vs Integer+s... · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html">#63450 tracking discriminant type, Primitive vs Integer+s...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="175797635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797635">(Sep 16 2019 at 09:42)</a>:</h4>
<blockquote>
<p>even better if you can invite <span class="user-mention silent" data-user-id="120791">RalfJ</span></p>
</blockquote>
<p>(that was about <a href="https://github.com/rust-lang/rust/issues/63450" target="_blank" title="https://github.com/rust-lang/rust/issues/63450">https://github.com/rust-lang/rust/issues/63450</a>)<br>
Not sure what I could contribute here? All I want is for <a href="https://github.com/rust-lang/rust/pull/63448" target="_blank" title="https://github.com/rust-lang/rust/pull/63448">https://github.com/rust-lang/rust/pull/63448</a> to get merged, and at this point I think it is not appropriate to block that on resolving our enum discriminant story.</p>



<a name="175797647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797647">(Sep 16 2019 at 09:43)</a>:</h4>
<p>that PR fixes incorrect evaluation behavior in the Miri engine, meaning CTFE and Miri currently just evaluate programs incorrect -- a critical bug.</p>



<a name="175797682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797682">(Sep 16 2019 at 09:43)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> given that your PR didn't move in a few weeks, what is your rationale for blocking a critical bug fix on that?</p>



<a name="175797732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797732">(Sep 16 2019 at 09:44)</a>:</h4>
<p><em>aaaaaa</em></p>



<a name="175797738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797738">(Sep 16 2019 at 09:44)</a>:</h4>
<p>sorry I completely forgot about it</p>



<a name="175797765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797765">(Sep 16 2019 at 09:45)</a>:</h4>
<p>I'll try to take a look at it today</p>



<a name="175797776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797776">(Sep 16 2019 at 09:45)</a>:</h4>
<p>(I never wanted it to be blocked for this long)</p>



<a name="175797782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797782">(Sep 16 2019 at 09:45)</a>:</h4>
<p>out of curiosity, what is an example of a scenario where we currently use a pointer for the discriminant?</p>



<a name="175797861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797861">(Sep 16 2019 at 09:46)</a>:</h4>
<blockquote>
<p><em>aaaaaa</em></p>
</blockquote>
<p>I pinged you twice on that PR, seems like I should have pinged you... on Zulip instead?^^</p>



<a name="175797866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797866">(Sep 16 2019 at 09:46)</a>:</h4>
<blockquote>
<p>I'll try to take a look at it today</p>
</blockquote>
<p>thanks!</p>



<a name="175797885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797885">(Sep 16 2019 at 09:47)</a>:</h4>
<p>is it for handling e.g. <code>Option&lt;&amp;T&gt;</code> in some sort of way that LLVM likes?</p>



<a name="175797890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797890">(Sep 16 2019 at 09:47)</a>:</h4>
<blockquote>
<p>out of curiosity, what is an example of a scenario where we currently use a pointer for the discriminant?</p>
</blockquote>
<p>no it's not about pointers at all</p>



<a name="175797905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797905">(Sep 16 2019 at 09:47)</a>:</h4>
<p>it's about overflows when computing the discriminant in case there is a niche</p>



<a name="175797907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797907">(Sep 16 2019 at 09:47)</a>:</h4>
<p>from the comments in the PR it sounded like the reason we use Primitive today rather than Integer was to handle Pointers</p>



<a name="175797957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797957">(Sep 16 2019 at 09:48)</a>:</h4>
<p>oh you mean pointer <em>type</em>... yeah I guess that's for <code>Option&lt;&amp;T&gt;</code> or so</p>



<a name="175797968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797968">(Sep 16 2019 at 09:48)</a>:</h4>
<p>(in Miri/CTFE we also have integer vs pointer <em>values</em> and that's somewaht orthogonal to the types so I was confused)</p>



<a name="175797971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175797971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175797971">(Sep 16 2019 at 09:48)</a>:</h4>
<p>pointers are kinda easy to solve, the annoying one is signed integers</p>



<a name="175798008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798008">(Sep 16 2019 at 09:49)</a>:</h4>
<p>ah here is a <a href="https://github.com/rust-lang/rust/issues/62138#issuecomment-520154725" target="_blank" title="https://github.com/rust-lang/rust/issues/62138#issuecomment-520154725">concrete example</a> you had found earlier, <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="175798020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798020">(Sep 16 2019 at 09:50)</a>:</h4>
<p>namely <code>Option&lt;unsafe extern "C" fn(*mut u8)&gt;</code></p>



<a name="175798087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798087">(Sep 16 2019 at 09:51)</a>:</h4>
<p>we can try to land RalfJ's PR if this is not easily solvable: <a href="https://github.com/rust-lang/rust/pull/63450#issuecomment-523385921" target="_blank" title="https://github.com/rust-lang/rust/pull/63450#issuecomment-523385921">https://github.com/rust-lang/rust/pull/63450#issuecomment-523385921</a></p>



<a name="175798096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798096">(Sep 16 2019 at 09:51)</a>:</h4>
<p>wow that was 26 days ago it feels like last week</p>



<a name="175798873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798873">(Sep 16 2019 at 10:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> do you have a plan for proceeding here? if you want I can try to fix all the signedness bugs in my PR and then we can see how bad that is</p>



<a name="175798887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798887">(Sep 16 2019 at 10:04)</a>:</h4>
<p>plan? ha ha, no</p>



<a name="175798950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175798950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175798950">(Sep 16 2019 at 10:05)</a>:</h4>
<p>To be honest, I'm not quite clear on the relative benefits of the three options you laid out in <a href="https://github.com/rust-lang/rust/pull/63450#issuecomment-523385921" target="_blank" title="https://github.com/rust-lang/rust/pull/63450#issuecomment-523385921">your 26 day old comment</a></p>



<a name="175799048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799048">(Sep 16 2019 at 10:07)</a>:</h4>
<p>My assumption is that going to Integer + signedness would be fine. But you're more deeply acquainted with the code here, so I'd like to hear you out on why you want to go all the way to Integer.</p>



<a name="175799058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799058">(Sep 16 2019 at 10:07)</a>:</h4>
<p>but in any case, maybe we can move this whole discussion to its own topic? I will do that now if I can</p>



<a name="175799159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799159">(Sep 16 2019 at 10:09)</a>:</h4>
<p>oh yeah uhh sorry</p>



<a name="175799269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799269">(Sep 16 2019 at 10:10)</a>:</h4>
<p>the reason to go all the way to Integer is that signedness should matter as least as possible, IMO, but also there is no <code>(Integer, /*signed*/ bool)</code> type so it'd be an annoying refactor (but maybe less annoying than having to deal with signedness on the fly?)</p>



<a name="175799483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799483">(Sep 16 2019 at 10:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> <span class="user-mention" data-user-id="120791">@RalfJ</span> oh I'm silly there is something damning about losing signedness: these are both encoded as bytes and they both have <code>isize</code> (signed) high-level discriminants: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c140a4df209bececc5471d376fc2e3d0" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c140a4df209bececc5471d376fc2e3d0">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c140a4df209bececc5471d376fc2e3d0</a></p>



<a name="175799488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799488">(Sep 16 2019 at 10:14)</a>:</h4>
<p>I guess; your PR itself says that going all the way to <code>Integer</code> only seemed like a <em>slight</em> simplification, which makes me wary of trying to push this through, in terms of effort expended vs expected value.</p>



<a name="175799502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799502">(Sep 16 2019 at 10:14)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <span class="user-mention silent" data-user-id="120791">RalfJ</span> oh I'm silly there is something damning about losing signedness: these are both encoded as bytes and they both have <code>isize</code> (signed) high-level discriminants: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c140a4df209bececc5471d376fc2e3d0" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c140a4df209bececc5471d376fc2e3d0">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c140a4df209bececc5471d376fc2e3d0</a></p>
</blockquote>
<p>eek</p>



<a name="175799520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799520">(Sep 16 2019 at 10:15)</a>:</h4>
<p>okay then seems like that ... answers your Question then?</p>



<a name="175799533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799533">(Sep 16 2019 at 10:15)</a>:</h4>
<p>yeah I somehow didn't think to check this one thing that would've made it clear...</p>



<a name="175799544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799544">(Sep 16 2019 at 10:15)</a>:</h4>
<p>that is, I assume the PR you posted mishandles this case? And therefore we should go with option 2 (Integer + signedness)</p>



<a name="175799549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799549">(Sep 16 2019 at 10:15)</a>:</h4>
<p>if we want to change the code at all</p>



<a name="175799599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799599">(Sep 16 2019 at 10:16)</a>:</h4>
<p>I'm not sure how much the status quo inconvenienced <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="175799839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799839">(Sep 16 2019 at 10:21)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> it seems like you should be able to just remove this line and land the PR <em>sigh</em> &lt;<a href="https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R688" target="_blank" title="https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R688">https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R688</a>&gt;</p>



<a name="175799844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175799844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175799844">(Sep 16 2019 at 10:21)</a>:</h4>
<p>oh there's another copy here &lt;<a href="https://github.com/rust-lang/rust/pull/63448/files#diff-9c5f25e0d0302fa34791d33795e30781R1061" target="_blank" title="https://github.com/rust-lang/rust/pull/63448/files#diff-9c5f25e0d0302fa34791d33795e30781R1061">https://github.com/rust-lang/rust/pull/63448/files#diff-9c5f25e0d0302fa34791d33795e30781R1061</a>&gt;</p>



<a name="175800289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175800289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175800289">(Sep 16 2019 at 10:30)</a>:</h4>
<p>Well I wouldn't remove it but replace it by a comment and probably want to factor that match into a helper method? what would be a good place for that method?</p>



<a name="175801076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801076">(Sep 16 2019 at 10:46)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> presumably in here <a href="https://github.com/rust-lang/rust/blob/master/src/librustc/ty/layout.rs#L129" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/ty/layout.rs#L129">https://github.com/rust-lang/rust/blob/master/src/librustc/ty/layout.rs#L129</a></p>



<a name="175801096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801096">(Sep 16 2019 at 10:46)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> wait, does the type really matter? can't you just use the size?</p>



<a name="175801116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801116">(Sep 16 2019 at 10:47)</a>:</h4>
<p>I guess it matter for extending it but not for the addition</p>



<a name="175801193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801193">(Sep 16 2019 at 10:48)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> oh and I guess this is wrong <a href="https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R706" target="_blank" title="https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R706">https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R706</a></p>



<a name="175801216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801216">(Sep 16 2019 at 10:49)</a>:</h4>
<p><code>variants_start</code> might not fit in the discriminant</p>



<a name="175801669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801669">(Sep 16 2019 at 10:56)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> wait, does the type really matter? can't you just use the size?</p>
</blockquote>
<p>size and signedess</p>



<a name="175801706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801706">(Sep 16 2019 at 10:57)</a>:</h4>
<blockquote>
<p><code>variants_start</code> might not fit in the discriminant</p>
</blockquote>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> then this would be the wrong thing, right?<br>
<a href="https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R700" target="_blank" title="https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R700">https://github.com/rust-lang/rust/pull/63448/files#diff-47c36b7a2c9437eb6f382b25d46a3c54R700</a><br>
this (at least in debug builds, not sure about release builds) will panic if it doesn't fit</p>



<a name="175801720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801720">(Sep 16 2019 at 10:57)</a>:</h4>
<p>what should it do instead?</p>



<a name="175801789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801789">(Sep 16 2019 at 10:58)</a>:</h4>
<p>the only operation you need to do is the subtraction</p>



<a name="175801843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801843">(Sep 16 2019 at 10:59)</a>:</h4>
<p>the result of that should be an unsigned integer, so you can just zero-extend without knowing the signedness (maybe, I'm not 100% sure)</p>



<a name="175801873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801873">(Sep 16 2019 at 10:59)</a>:</h4>
<blockquote>
<p>the only operation you need to do is the subtraction</p>
</blockquote>
<p>I am doing two operations though?</p>



<a name="175801934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801934">(Sep 16 2019 at 11:00)</a>:</h4>
<p>sorry, the only operation you need to do in a special way is the subtraction</p>



<a name="175801947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801947">(Sep 16 2019 at 11:00)</a>:</h4>
<p>"special"? I am doing both using machine arithmetic right now, that seems most obvious?</p>



<a name="175801951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801951">(Sep 16 2019 at 11:00)</a>:</h4>
<p>once you've done the subtraction <em>wrapping at the right size</em>, you get a positive (or <code>0</code>) distance from <code>variants_start</code> to the index of a variant</p>



<a name="175801954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801954">(Sep 16 2019 at 11:00)</a>:</h4>
<p>and even for just doing those I need to pick a signedness and it seems preferrable to pick the right one?</p>



<a name="175801969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801969">(Sep 16 2019 at 11:01)</a>:</h4>
<p>well addition and subtraction don't care about signedness :)</p>



<a name="175801974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801974">(Sep 16 2019 at 11:01)</a>:</h4>
<p>fair</p>



<a name="175801982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175801982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175801982">(Sep 16 2019 at 11:01)</a>:</h4>
<p>still, I dont see a reason not to extract the signedness^^</p>



<a name="175802010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802010">(Sep 16 2019 at 11:02)</a>:</h4>
<p>anyway <code>adjusted_discr</code> is badly named. it's a variant index at that point</p>



<a name="175802053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802053">(Sep 16 2019 at 11:02)</a>:</h4>
<p>so you are saying I should do <code>variant_index_val - variants_start_val</code> using host, not machine, arithmetic?</p>



<a name="175802066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802066">(Sep 16 2019 at 11:02)</a>:</h4>
<p>are we looking at a different operation?</p>



<a name="175802090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802090">(Sep 16 2019 at 11:03)</a>:</h4>
<p>anyway yeah the operation with <code>variants_start</code> should just be on <code>u128</code> and it can never overflow so you don't need to use <code>wrapping_</code> either</p>



<a name="175802102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802102">(Sep 16 2019 at 11:03)</a>:</h4>
<p><code>if variants_start &lt;= adjusted_discr &amp;&amp; adjusted_discr &lt;= variants_end {</code> seems wrong btw</p>



<a name="175802110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802110">(Sep 16 2019 at 11:03)</a>:</h4>
<p>I forget if we've discussed this</p>



<a name="175802112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802112">(Sep 16 2019 at 11:03)</a>:</h4>
<blockquote>
<p>anyway <code>adjusted_discr</code> is badly named. it's a variant index at that point</p>
</blockquote>
<p>so maybe <code>variant_index_relative</code> or so?</p>



<a name="175802120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802120">(Sep 16 2019 at 11:03)</a>:</h4>
<blockquote>
<p>are we looking at a different operation?</p>
</blockquote>
<p>I looked ath the link you posted</p>



<a name="175802159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802159">(Sep 16 2019 at 11:04)</a>:</h4>
<p>which was in the write code</p>



<a name="175802165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802165">(Sep 16 2019 at 11:04)</a>:</h4>
<p>oh whoops</p>



<a name="175802168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802168">(Sep 16 2019 at 11:04)</a>:</h4>
<p>I am now staring at the read code</p>



<a name="175802174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802174">(Sep 16 2019 at 11:04)</a>:</h4>
<p>(not sure how I got here tbh)</p>



<a name="175802182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802182">(Sep 16 2019 at 11:04)</a>:</h4>
<p>anyway it's not even relative once you add <code>variants_start</code></p>



<a name="175802209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802209">(Sep 16 2019 at 11:05)</a>:</h4>
<p>hmmm okay maybe you do need <code>wrapping_</code> ops for the host stuff since your range check handles the dataful thing</p>



<a name="175802222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802222">(Sep 16 2019 at 11:05)</a>:</h4>
<p>i.e. it may overflow when it's the dataful case</p>



<a name="175802245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802245">(Sep 16 2019 at 11:05)</a>:</h4>
<p>I wish I could remember any of this</p>



<a name="175802338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802338">(Sep 16 2019 at 11:07)</a>:</h4>
<blockquote>
<p>anyway it's not even relative once you add <code>variants_start</code></p>
</blockquote>
<p>yeah, I meant only the first intermediate value</p>



<a name="175802342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802342">(Sep 16 2019 at 11:07)</a>:</h4>
<blockquote>
<p><code>if variants_start &lt;= adjusted_discr &amp;&amp; adjusted_discr &lt;= variants_end {</code> seems wrong btw</p>
</blockquote>
<p>it does?</p>



<a name="175802353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802353">(Sep 16 2019 at 11:07)</a>:</h4>
<blockquote>
<p>hmmm okay maybe you do need <code>wrapping_</code> ops for the host stuff since your range check handles the dataful thing</p>
</blockquote>
<p>let me ask the other way around -- we do machine arithmetic at run-time for this, right? so, using machine arithmetic is correct?</p>



<a name="175802403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802403">(Sep 16 2019 at 11:08)</a>:</h4>
<p>I currently have no interest in optimizing this code ;)</p>



<a name="175802468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802468">(Sep 16 2019 at 11:09)</a>:</h4>
<blockquote>
<p>anyway <code>adjusted_discr</code> is badly named. it's a variant index at that point</p>
</blockquote>
<p>I renamed: <a href="https://github.com/rust-lang/rust/pull/63448/commits/b73f1a51dcd1011129dc5c5c55a7577134410dbc" target="_blank" title="https://github.com/rust-lang/rust/pull/63448/commits/b73f1a51dcd1011129dc5c5c55a7577134410dbc">https://github.com/rust-lang/rust/pull/63448/commits/b73f1a51dcd1011129dc5c5c55a7577134410dbc</a></p>



<a name="175802507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802507">(Sep 16 2019 at 11:10)</a>:</h4>
<p>it's not about optimization</p>



<a name="175802525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802525">(Sep 16 2019 at 11:10)</a>:</h4>
<p>the runtime behavior was wrong until recently</p>



<a name="175802533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802533">(Sep 16 2019 at 11:10)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/place.rs#L294-L301" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/place.rs#L294-L301">https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/place.rs#L294-L301</a></p>



<a name="175802559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802559">(Sep 16 2019 at 11:11)</a>:</h4>
<p>only one of the operations can be performed at the niche size, the other has to be performed at something capable of fitting all variant indices</p>



<a name="175802617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802617">(Sep 16 2019 at 11:12)</a>:</h4>
<p>and whether it's a niche or dataful variant is checked not on the final variant index but on the relative one</p>



<a name="175802654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802654">(Sep 16 2019 at 11:13)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> maybe you can use <a href="https://github.com/rust-lang/rust/pull/62584/files#diff-dac0b3d5a19b291538d6f171b7e8eb8b" target="_blank" title="https://github.com/rust-lang/rust/pull/62584/files#diff-dac0b3d5a19b291538d6f171b7e8eb8b">https://github.com/rust-lang/rust/pull/62584/files#diff-dac0b3d5a19b291538d6f171b7e8eb8b</a>?</p>



<a name="175802660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802660">(Sep 16 2019 at 11:13)</a>:</h4>
<p>as a miri test</p>



<a name="175802667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802667">(Sep 16 2019 at 11:13)</a>:</h4>
<p>I expect miri to get this very wrong atm</p>



<a name="175802962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802962">(Sep 16 2019 at 11:19)</a>:</h4>
<p>we have some tests in <a href="https://github.com/rust-lang/miri/pull/903" target="_blank" title="https://github.com/rust-lang/miri/pull/903">https://github.com/rust-lang/miri/pull/903</a> that you supplied earlier</p>



<a name="175802977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175802977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175802977">(Sep 16 2019 at 11:20)</a>:</h4>
<p>I can certainly add that test as well. you are saying that will still fail even with the PR?</p>



<a name="175803027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175803027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175803027">(Sep 16 2019 at 11:20)</a>:</h4>
<blockquote>
<p>only one of the operations can be performed at the niche size, the other has to be performed at something capable of fitting all variant indices</p>
</blockquote>
<p>and which one would that be?</p>



<a name="175808327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175808327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175808327">(Sep 16 2019 at 12:48)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> that test case you suggested causes an ICE. good catch, I guess. ;)</p>



<a name="175808379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175808379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175808379">(Sep 16 2019 at 12:49)</a>:</h4>
<p>so for writing the discriminant, I assume computing the relative variant index should happen at max precision? and only adding <code>niche_start_val</code> should happen with overflow?</p>



<a name="175809799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175809799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175809799">(Sep 16 2019 at 13:06)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I updated the PR, I think that's better now? I am still confused by your "<code>variants_start &lt;= adjusted_discr &amp;&amp; adjusted_discr &lt;= variants_end</code> seems wrong" though.</p>



<a name="175905922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175905922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175905922">(Sep 17 2019 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> does the test pass now? because at this point my pedantry has outstayed its welcome :P</p>



<a name="175948292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175948292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175948292">(Sep 17 2019 at 20:56)</a>:</h4>
<p>yes, the tests added in <a href="https://github.com/rust-lang/miri/pull/903" target="_blank" title="https://github.com/rust-lang/miri/pull/903">https://github.com/rust-lang/miri/pull/903</a> all pass</p>



<a name="175948317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175948317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175948317">(Sep 17 2019 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I am still not sure though what you meant by <br>
"variants_start &lt;= adjusted_discr &amp;&amp; adjusted_discr &lt;= variants_end seems wrong"</p>



<a name="175995001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/175995001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#175995001">(Sep 18 2019 at 11:32)</a>:</h4>
<p>it can be fine, I just got confused and had assumed something about the operations before</p>



<a name="176044871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2363450%20tracking%20discriminant%20type%2C%20Primitive%20vs%20Integer%2Bs.../near/176044871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2363450.20tracking.20discriminant.20type.2C.20Primitive.20vs.20Integer.2Bs.2E.2E.2E.html#176044871">(Sep 18 2019 at 20:46)</a>:</h4>
<p>kk</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>