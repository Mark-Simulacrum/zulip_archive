<html>
<head><meta charset="utf-8"><title>Encodable/Decodable and Encoder/Decoder · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html">Encodable/Decodable and Encoder/Decoder</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268355727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268355727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268355727">(Jan 18 2022 at 08:11)</a>:</h4>
<p>I'm looking at <code>Encodable</code>/<code>Decodable</code> and <code>Encoder</code>/<code>Decoder</code> because they're hot in incremental builds.</p>
<p>There are two implementations of <code>Encoder</code>/<code>Decoder</code>. The <code>opaque</code> one is important because it is used in incremental builds. The <code>json</code> one is less important, being only used for (a) the <code>.rlink</code> file produced/consumed by <code>-Z no-link</code>/<code>-Z link-only</code> (and there's a <a href="https://github.com/rust-lang/rust/blob/195e931b02b69bbce1bcf4632f4e2d5603ef006b/compiler/rustc_interface/src/queries.rs#L370"><code>FIXME</code></a> comment saying it should be changed to a binary format), and (b) in a handful of tests in non-fundamental ways.</p>
<p>Also, the <code>opaque</code> implementation is mostly infallible, i.e. in most (though not all) places where something goes wrong it just panics, rather than returning an error. So I want to change <code>Decoder</code>/<code>Encoder</code> to actually be fallible, e.g. <code>decode()</code> would return <code>T</code> rather than <code>Result&lt;T, D::Error&gt;</code>. I have tried this locally with <code>Decoder</code>, but not yet with <code>Encoder</code>, and I get nice wins of up to 4%.</p>
<p>So I'm contemplating several possibilities, in order of my most preferred to least preferred:</p>
<ul>
<li>Remove the <code>json</code> implementation, and make <code>opaque</code> infallible.</li>
<li>Preserve <code>json</code>, and make both <code>json</code> and <code>opaque</code> infallible</li>
<li>Preserve <code>json</code> and keep it fallible by introducing <code>FallibleDecoder</code>/<code>FallibleEncoder</code>, and make <code>opaque</code> infallible.</li>
</ul>
<p>Anyone have opinions about this?</p>



<a name="268357669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268357669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268357669">(Jan 18 2022 at 08:30)</a>:</h4>
<p>I got an open PR to remove the json implementation. Need to update it someday and write an MCP (as it removes <code>-Zast-json</code>)</p>



<a name="268369785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268369785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268369785">(Jan 18 2022 at 10:17)</a>:</h4>
<p>Looks like <code>-Zast-json</code> needs <code>Encoder</code> but not <code>Decoder</code>, which makes sense</p>



<a name="268394363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268394363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268394363">(Jan 18 2022 at 14:01)</a>:</h4>
<p>FWIW it's probably fine to just panic rather than returning a result for JSON encoding - I'm not sure we ever do anything other than unwrap anyway.</p>



<a name="268442341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268442341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268442341">(Jan 18 2022 at 19:21)</a>:</h4>
<p>I think I will take that route. For both <code>opaque</code> and <code>json</code> it's just a question of where the panic occurs -- deep within the decoding code, or at some slightly nicer top-level spot.</p>



<a name="268448494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268448494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268448494">(Jan 18 2022 at 20:09)</a>:</h4>
<p>@bjorn3 I found  <a href="https://github.com/rust-lang/rust/issues/85993">#85993</a>. Looks like a case where splitting it up into smaller PRs would be a way to make progress. Anyway, my change to make them infallible is orthogonal, so I'll keep working on it.</p>



<a name="268465243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268465243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268465243">(Jan 18 2022 at 22:28)</a>:</h4>
<p>Hmm, making Encodable/Encoder infallible is harder than Decodable/Decoder. Because of <code>FileEncoder</code>, which can have IO-related errors occur while emitting, and the compiler currently handles these in a more complex fashion than just aborting.</p>



<a name="268486805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268486805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268486805">(Jan 19 2022 at 03:06)</a>:</h4>
<p>On a semi-related note, I see <code>compiler/rustc_builtin_macros/src/deriving/decodable.rs</code> and <code>compiler/rustc_builtin_macros/src/deriving/encodable.rs</code>, which seems to be remnants of the deprecated <code>Rustc{De,En}codable</code> derivable trait.</p>



<a name="268486827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268486827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268486827">(Jan 19 2022 at 03:07)</a>:</h4>
<p>And not just deprecated, but a hard error:</p>
<div class="codehilite"><pre><span></span><code>error[E0433]: failed to resolve: could not find `rustc_serialize` in the crate root
 --&gt; b.rs:1:10
  |
1 | #[derive(RustcDecodable)]
  |          ^^^^^^^^^^^^^^ could not find `rustc_serialize` in the crate root
  |
</code></pre></div>



<a name="268486844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268486844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268486844">(Jan 19 2022 at 03:07)</a>:</h4>
<p>Makes me wonder if those files are still necessary? Or perhaps they can be cut down to some stub contents?</p>



<a name="268487305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268487305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268487305">(Jan 19 2022 at 03:14)</a>:</h4>
<p>Related: <a href="https://github.com/rust-lang/rust/pull/92594">https://github.com/rust-lang/rust/pull/92594</a></p>



<a name="268488092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Encodable/Decodable%20and%20Encoder/Decoder/near/268488092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Encodable.2FDecodable.20and.20Encoder.2FDecoder.html#268488092">(Jan 19 2022 at 03:26)</a>:</h4>
<p>That's not a hard error: the crate <em>could</em> be provided and it'll work just fine.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>