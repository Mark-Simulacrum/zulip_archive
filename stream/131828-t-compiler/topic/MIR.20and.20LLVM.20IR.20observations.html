<html>
<head><meta charset="utf-8"><title>MIR and LLVM IR observations · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html">MIR and LLVM IR observations</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261879694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261879694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261879694">(Nov 18 2021 at 02:46)</a>:</h4>
<p>compiler/rustc_middle/src/mir/mod.rs has this:</p>
<div class="codehilite"><pre><span></span><code>// At least on 64 bit systems, `PlaceElem` should not be larger than two pointers.
#[cfg(all(target_arch = &quot;x86_64&quot;, target_pointer_width = &quot;64&quot;))]
static_assert_size!(PlaceElem&lt;&#39;_&gt;, 24);
</code></pre></div>
<p>The comment and the code aren't in sync, there...</p>



<a name="261879733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261879733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261879733">(Nov 18 2021 at 02:47)</a>:</h4>
<p>The responsible commit:</p>
<div class="codehilite"><pre><span></span><code>commit 4cc2cabee25a2ea74d13720c980bfd0379b9945a
Author: DPC &lt;dylan.dpc@gmail.com&gt;
Date:   Sun Aug 23 14:54:58 2020 +0200

            change offset from u32 to u64
</code></pre></div>



<a name="261882149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882149">(Nov 18 2021 at 03:31)</a>:</h4>
<p>Looking at the MIR for a small but non-trivial program, the very first basic block in the program is this:</p>
<div class="codehilite"><pre><span></span><code>    bb0: {
        _28 = const false;               // scope 0 at src/main.rs:89:11: 89:20
        _28 = const true;                // scope 0 at src/main.rs:89:11: 89:20
        _1 = do_main() -&gt; bb1;           // scope 0 at src/main.rs:89:11: 89:20
                                         // mir::Constant
                                         // + span: src/main.rs:89:11: 89:18
                                         // + literal: Const { ty: fn() -&gt; std::result::Result&lt;(), std::io::Error&gt; {do_main}, val: Value(Scalar(&lt;ZST&gt;)) }
    }
</code></pre></div>



<a name="261882198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882198">(Nov 18 2021 at 03:32)</a>:</h4>
<p>Double-assigning to <code>_28</code> seems inauspicious</p>



<a name="261882220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882220">(Nov 18 2021 at 03:32)</a>:</h4>
<p>The next block is this:</p>
<div class="codehilite"><pre><span></span><code>    bb1: {
        _2 = discriminant(_1);           // scope 0 at src/main.rs:89:11: 89:20
        switchInt(move _2) -&gt; [0_isize: bb3, 1_isize: bb4, otherwise: bb2]; // scope 0 at src/main.rs:89:5: 89:20
    }
</code></pre></div>



<a name="261882249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882249">(Nov 18 2021 at 03:33)</a>:</h4>
<p>I don't see why <code>bb0</code> and <code>bb1</code> are separate, they seem like they could be combined into a single BB</p>



<a name="261882390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882390">(Nov 18 2021 at 03:36)</a>:</h4>
<p>function calls always go at the end of BB's</p>



<a name="261882611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882611">(Nov 18 2021 at 03:40)</a>:</h4>
<p>Why is that?</p>



<a name="261882641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882641">(Nov 18 2021 at 03:41)</a>:</h4>
<p>ive no idea <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> would be interesting to hear why</p>



<a name="261882681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882681">(Nov 18 2021 at 03:42)</a>:</h4>
<p>it looked like we just put everything that's control flow as a terminator</p>



<a name="261882685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882685">(Nov 18 2021 at 03:42)</a>:</h4>
<p>(and given fn calls can unwind I assume its a similar thing)</p>



<a name="261882686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261882686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261882686">(Nov 18 2021 at 03:42)</a>:</h4>
<p>but Im not really sure</p>



<a name="261883160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261883160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261883160">(Nov 18 2021 at 03:53)</a>:</h4>
<p>LLVM <code>invoke</code> has two successors, normal and exception (unwind)</p>



<a name="261883247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261883247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261883247">(Nov 18 2021 at 03:55)</a>:</h4>
<p>I guess MIR doesn't know yet whether it might need that exception landing pad?</p>



<a name="261884043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884043">(Nov 18 2021 at 04:06)</a>:</h4>
<p>Is <code>_28</code> a drop flag? I've seen that pattern before in drop elaboration, although I would think we'd eliminate it with DSE somewhere. Assuming you're looking at optimized MIR.</p>



<a name="261884083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884083">(Nov 18 2021 at 04:07)</a>:</h4>
<p>I remember conversations about extended basic blocks when I first got involved with Rust, but that would be a pretty huge refactor.</p>



<a name="261884412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884412">(Nov 18 2021 at 04:15)</a>:</h4>
<p>I don't know if <code>_28</code> is a drop flag:</p>
<div class="codehilite"><pre><span></span><code>    let mut _28: bool;                   // in scope 0 at src/main.rs:97:1: 97:2
</code></pre></div>



<a name="261884424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884424">(Nov 18 2021 at 04:15)</a>:</h4>
<p>That source location is the closing <code>}</code> of <code>main</code>, so maybe</p>



<a name="261884432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884432">(Nov 18 2021 at 04:15)</a>:</h4>
<p>I'm looking at the output of <code>--emit=mir</code>, which I assume is the final MIR?</p>



<a name="261884555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884555">(Nov 18 2021 at 04:18)</a>:</h4>
<p>The BB split does pass through to the LLVM IR:</p>
<div class="codehilite"><pre><span></span><code>start:
  ...
  call void @llvm.memcpy.p0i8.p0i8.i64(i8* align 8 %4, i8* align 8 %5, i64 16, i1 false), !dbg !14418
  br label %bb1, !dbg !14418

bb1:                                              ; preds = %start
  %6 = bitcast %&quot;std::result::Result&lt;(), std::io::Error&gt;&quot;* %_1 to i8*, !dbg !14418
  %7 = load i8, i8* %6, align 8, !dbg !14418, !range !3053
  ...
</code></pre></div>



<a name="261884562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884562">(Nov 18 2021 at 04:18)</a>:</h4>
<p>(I don't actually know. I only use -Zdump-mir)</p>



<a name="261884566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884566">(Nov 18 2021 at 04:18)</a>:</h4>
<p>As does the double assignment to <code>_28</code>:</p>
<div class="codehilite"><pre><span></span><code>  store i8 0, i8* %_28, align 1, !dbg !14418
  store i8 1, i8* %_28, align 1, !dbg !14418
</code></pre></div>



<a name="261884660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261884660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261884660">(Nov 18 2021 at 04:20)</a>:</h4>
<p>I don't see a dead store elimination pass in the list of MIR transformations. It's one of the rare optimizations that's profitable pre-monomorphization too, so worth doing ourselves in the MIR.</p>



<a name="261885087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885087">(Nov 18 2021 at 04:28)</a>:</h4>
<p>I am open to the possibility of working on such a thing</p>



<a name="261885105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885105">(Nov 18 2021 at 04:29)</a>:</h4>
<p>The whole reason I'm looking at MIR and LLVM IR is to see how they can be shrunk, in order to reduce LLVM's execution time</p>



<a name="261885298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885298">(Nov 18 2021 at 04:32)</a>:</h4>
<p>/me reads <a href="https://rustc-dev-guide.rust-lang.org/mir/optimizations.html">https://rustc-dev-guide.rust-lang.org/mir/optimizations.html</a></p>



<a name="261885392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885392">(Nov 18 2021 at 04:34)</a>:</h4>
<p>I can review PRs and give advice. Unfortunately wg-mir-opt has sort of ground to a halt, but this one seems pretty simple (famous last words).</p>



<a name="261885536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885536">(Nov 18 2021 at 04:37)</a>:</h4>
<p>Any high-level suggestions to start with? E.g. existing optimization passes it might be similar to?</p>



<a name="261885585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885585">(Nov 18 2021 at 04:38)</a>:</h4>
<p>Feels like a simple backwards pass within BBs might suffice</p>



<a name="261885597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885597">(Nov 18 2021 at 04:38)</a>:</h4>
<p>Track defs, invalidate them on uses, etc.</p>



<a name="261885601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885601">(Nov 18 2021 at 04:38)</a>:</h4>
<p>Yeah, you could make it intrablock to start.</p>



<a name="261885686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885686">(Nov 18 2021 at 04:40)</a>:</h4>
<p>I saw this in another example, note the repeated <code>_219</code> assignment</p>
<div class="codehilite"><pre><span></span><code>        _218 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _221 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _219 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _217 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _222 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _224 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _220 = const false;              // scope 0 at src/main.rs:20:9: 20:21
        _1 = const false;                // scope 0 at src/main.rs:20:24: 20:29
        _219 = const true;               // scope 1 at /rustc/59eed8a2aac0230a8b53e89d4e99d55912ba6b35/library/alloc/src/macros.rs:43:36: 43:59
</code></pre></div>



<a name="261885812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885812">(Nov 18 2021 at 04:43)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_mir_transform/src/nrvo.rs">Dumb NRVO</a> is the simplest MIR opt I know. <a href="https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_mir_transform/src/dest_prop.rs">Dest prop</a> has some nice module documentation about the dangers of aliasing/indirection.</p>



<a name="261885819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885819">(Nov 18 2021 at 04:43)</a>:</h4>
<p>I feel like there might even be an outstanding PR for this. Lemme check.</p>



<a name="261885986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261885986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261885986">(Nov 18 2021 at 04:46)</a>:</h4>
<p>I did a quick google search for "rust dead code elimination" before, didn't find anything of note</p>



<a name="261886065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261886065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261886065">(Nov 18 2021 at 04:48)</a>:</h4>
<p>Ah, that's right. Someone tried but you can't use the <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants">existing live variables dataflow analysis</a> for this.</p>



<a name="261886113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261886113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261886113">(Nov 18 2021 at 04:49)</a>:</h4>
<p>You won't run into this if you just do an intrablock one, obviously.</p>



<a name="261905968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261905968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261905968">(Nov 18 2021 at 09:53)</a>:</h4>
<p>Making it possible for calls to be a statement instead of a terminator sometimes was a change we considered in the past. I don't remember exactly all of the arguments from that discussion, but the fact that a <code>call</code> can typically be unwound from even without any landing pads present I think was one of the motivating examples for keeping it a pure terminator. Also I think because it is plain easier to not have multiple ways to say the same thing.</p>



<a name="261906143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261906143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261906143">(Nov 18 2021 at 09:55)</a>:</h4>
<p>Double assignments: various propagation passes have been attempted a many times ever since MIR became a thing, latest movement there being <a href="https://github.com/rust-lang/rust/pull/82684">https://github.com/rust-lang/rust/pull/82684</a></p>



<a name="261993888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261993888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261993888">(Nov 18 2021 at 21:31)</a>:</h4>
<p>Hmm, <code>RUSTC=$RUSTC0 cargo rustc -- -Zdump-mir=all</code> works for me, creating a <code>mir_dump/</code> dir with lots of files.<br>
But <code>RUSTC=$RUSTC0 cargo rustc -- -Zdump-mir=main</code> doesn't create a <code>mir_dump</code> dir.</p>



<a name="261994126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261994126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261994126">(Nov 18 2021 at 21:33)</a>:</h4>
<p>Wait, the <code>-Zdump-mir=all</code> output doesn't include anything for <code>main</code></p>



<a name="261994261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261994261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261994261">(Nov 18 2021 at 21:34)</a>:</h4>
<p>But <code>RUSTC=$RUSTC0 cargo rustc -- --emit=mir</code> does have stuff for <code>main</code></p>



<a name="261994500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261994500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261994500">(Nov 18 2021 at 21:36)</a>:</h4>
<p>No, I'm totally confused; the <code>-Zdump=mir</code> does have stuff for <code>main</code>, sorry for the noise</p>



<a name="261994680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261994680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261994680">(Nov 18 2021 at 21:38)</a>:</h4>
<p>I guess my real question is: when is <code>--emit=mir</code> produced?</p>



<a name="261996179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/MIR%20and%20LLVM%20IR%20observations/near/261996179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations.html#261996179">(Nov 18 2021 at 21:51)</a>:</h4>
<p>OK, looks like <code>--emit=mir</code> is the same as <code>PreCodegen.after.mir</code>, which is the last thing producedc by <code>-Zdump=mir</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>