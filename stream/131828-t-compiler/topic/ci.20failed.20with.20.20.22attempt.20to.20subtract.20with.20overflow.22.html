<html>
<head><meta charset="utf-8"><title>ci failed with  &quot;attempt to subtract with overflow&quot; · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html">ci failed with  &quot;attempt to subtract with overflow&quot;</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258865969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ci%20failed%20with%20%20%22attempt%20to%20subtract%20with%20overflow%22/near/258865969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html#258865969">(Oct 24 2021 at 08:03)</a>:</h4>
<p>I saw 2 PRs already that failed with </p>
<div class="codehilite"><pre><span></span><code>[TIMING] TheBook { compiler: Compiler { stage: 2, host: TargetSelection { triple: &quot;x86_64-pc-windows-gnu&quot;, file: None } }, target: TargetSelection { triple: &quot;x86_64-pc-windows-gnu&quot;, file: None } } -- 3.075
Set({&quot;library\\alloc&quot;, &quot;library\\core&quot;, &quot;library\\panic_abort&quot;, &quot;library\\panic_unwind&quot;, &quot;library\\proc_macro&quot;, &quot;library\\profiler_builtins&quot;, &quot;library\\std&quot;, &quot;library\\test&quot;, &quot;library\\unwind&quot;}) not skipped for &quot;bootstrap::doc::Std&quot; -- not in [&quot;src/test/ui&quot;]
Documenting stage2 std (x86_64-pc-windows-gnu)
 Documenting core v0.0.0 (D:\a\rust\rust\library\core)
thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;attempt to subtract with overflow&#39;, C:\Users\runneradmin\.cargo\registry\src\github.com-1ecc6299db9ec823\rustc-rayon-core-0.3.1\src\sleep\mod.rs:330:21

error: internal compiler error: unexpected panic

error: Unrecognized option: &#39;markdown-css&#39;
error: Unrecognized option: &#39;markdown-css&#39;

Rayon: detected unexpected panic; aborting
thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;called `Result::unwrap()` on an `Err` value: PoisonError { .. }&#39;, C:\Users\runneradmin\.cargo\registry\src\github.com-1ecc6299db9ec823\rustc-rayon-core-0.3.1\src\sleep\mod.rs:299
error: could not document `core`
Caused by:
Caused by:
  process didn&#39;t exit successfully: `D:\a\rust\rust\build\bootstrap/debug/rustdoc --edition=2018 --crate-type lib --crate-name core library\core\src\lib.rs --target x86_64-pc-windows-gnu -o D:\a\rust\rust\build\x86_64-pc-windows-gnu\stage2-std\x86_64-pc-windows-gnu\doc --error-format=json --json=diagnostic-rendered-ansi --markdown-css rust.css --markdown-no-toc -Z unstable-options --resource-suffix 1.58.0 --index-page D:\a\rust\rust\src/doc/index.md -L dependency=D:\a\rust\rust\build\x86_64-pc-windows-gnu\stage2-std\x86_64-pc-windows-gnu\release\deps -L dependency=D:\a\rust\rust\build\x86_64-pc-windows-gnu\stage2-std\release\deps -Zsymbol-mangling-version=legacy -Dwarnings -Wrustdoc::invalid_codeblock_attributes --crate-version &quot;1.58.0-nightly
  (7dbdae0c4
  2021-10-24)&quot; &quot;-Zcrate-attr=doc(html_root_url=\&quot;https://doc.rust-lang.org/nightly/\&quot;)&quot;` (exit code: 0xc0000409, STATUS_STACK_BUFFER_OVERRUN)


command did not execute successfully: &quot;\\\\?\\D:\\a\\rust\\rust\\build\\x86_64-pc-windows-gnu\\stage0\\bin\\cargo.exe&quot; &quot;rustdoc&quot; &quot;--target&quot; &quot;x86_64-pc-windows-gnu&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;8&quot; &quot;--release&quot; &quot;--locked&quot; &quot;--color&quot; &quot;always&quot; &quot;--features&quot; &quot;panic-unwind backtrace profiler compiler-builtins-c&quot; &quot;--manifest-path&quot; &quot;D:\\a\\rust\\rust\\library/test/Cargo.toml&quot; &quot;-p&quot; &quot;core&quot; &quot;-Zskip-rustdoc-fingerprint&quot; &quot;--&quot; &quot;--markdown-css&quot; &quot;rust.css&quot; &quot;--markdown-no-toc&quot; &quot;-Z&quot; &quot;unstable-options&quot; &quot;--resource-suffix&quot; &quot;1.58.0&quot; &quot;--index-page&quot; &quot;D:\\a\\rust\\rust\\src/doc/index.md&quot;


Build completed unsuccessfully in 1:08:04
Build completed unsuccessfully in 1:08:04
make: *** [Makefile:80: ci-mingw-subset-1] Error 1
</code></pre></div>
<p><a href="https://github.com/rust-lang/rust/pull/90042#issuecomment-950263825">https://github.com/rust-lang/rust/pull/90042#issuecomment-950263825</a><br>
<a href="https://github.com/rust-lang/rust/pull/90222#issuecomment-950269305">https://github.com/rust-lang/rust/pull/90222#issuecomment-950269305</a></p>
<p>Could this be related to <a href="https://github.com/rust-lang/rust/pull/89776">https://github.com/rust-lang/rust/pull/89776</a> ?<br>
Is there something we can do about that?</p>



<a name="258866846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ci%20failed%20with%20%20%22attempt%20to%20subtract%20with%20overflow%22/near/258866846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html#258866846">(Oct 24 2021 at 08:29)</a>:</h4>
<p>yes, seems related.</p>
<blockquote>
<p>This code is not in upstream rayon but just in our fork, introduced here</p>
</blockquote>
<p>Guess it needs to be fixed</p>



<a name="258867205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ci%20failed%20with%20%20%22attempt%20to%20subtract%20with%20overflow%22/near/258867205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html#258867205">(Oct 24 2021 at 08:38)</a>:</h4>
<p>I'll make a pr to temporarily disable the overflow checks again so we don't have to deal with the "spurious" ci failures for now, until the rayon dep is fixed</p>



<a name="258867452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ci%20failed%20with%20%20%22attempt%20to%20subtract%20with%20overflow%22/near/258867452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html#258867452">(Oct 24 2021 at 08:44)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/90228">https://github.com/rust-lang/rust/pull/90228</a></p>



<a name="258867655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ci%20failed%20with%20%20%22attempt%20to%20subtract%20with%20overflow%22/near/258867655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html#258867655">(Oct 24 2021 at 08:50)</a>:</h4>
<p>lol, apparently you can't start a line in a commit message with an issue number like <a href="https://github.com/rust-lang/rust/issues/1234">#1234</a>  because git will read that as "commented out 1234" and skip the entire line when saving the message :D</p>



<a name="258868294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ci%20failed%20with%20%20%22attempt%20to%20subtract%20with%20overflow%22/near/258868294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ci.20failed.20with.20.20.22attempt.20to.20subtract.20with.20overflow.22.html#258868294">(Oct 24 2021 at 09:06)</a>:</h4>
<p>Issue for the rustc_rayon bug: <a href="https://github.com/rust-lang/rust/issues/90227">#90227</a></p>
<p>In any case overflowing to <code>usize:MAX</code> <a href="https://github.com/rust-lang/rustc-rayon/blob/c8ec88d8a2236d1fe19d65a4ab38834f76d256b7/rayon-core/src/sleep/mod.rs#L330">in this subtraction</a> can't be the intended behavior. So it seems enabling overflow checks will help us avoid real bugs like this in the long run.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>