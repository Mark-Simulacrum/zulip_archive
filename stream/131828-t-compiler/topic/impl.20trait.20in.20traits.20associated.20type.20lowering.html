<html>
<head><meta charset="utf-8"><title>impl trait in traits associated type lowering · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html">impl trait in traits associated type lowering</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262640532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640532">(Nov 24 2021 at 21:06)</a>:</h4>
<p>we were talking with <span class="user-mention" data-user-id="248906">@cjgillot</span> about how to properly lower the resulting associated type</p>



<a name="262640555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640555">(Nov 24 2021 at 21:07)</a>:</h4>
<p>for instance</p>



<a name="262640556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640556">(Nov 24 2021 at 21:07)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Send</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262640569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640569">(Nov 24 2021 at 21:07)</a>:</h4>
<p>would lower into ...</p>



<a name="262640581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640581">(Nov 24 2021 at 21:07)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="cp">$</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="cp">$</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262640666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640666">(Nov 24 2021 at 21:08)</a>:</h4>
<p>but we would really need something like ...</p>



<a name="262640669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640669">(Nov 24 2021 at 21:08)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="cp">$</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="cp">$</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262640717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640717">(Nov 24 2021 at 21:08)</a>:</h4>
<p>so if we were to follow that scheme we would need to "copy" all generic bounds from the fn to the associated type</p>



<a name="262640751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640751">(Nov 24 2021 at 21:09)</a>:</h4>
<p>the other possibility is to make that associated type a child of <code>foo</code></p>



<a name="262640782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640782">(Nov 24 2021 at 21:09)</a>:</h4>
<p>something like ...</p>



<a name="262640868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640868">(Nov 24 2021 at 21:10)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">foo</span>::<span class="n">rpit</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">foo</span>::<span class="n">rpit</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262640890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262640890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262640890">(Nov 24 2021 at 21:10)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> told me that we should also ask you <span class="user-mention" data-user-id="116118">@Matthew Jasper</span></p>



<a name="262641233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262641233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262641233">(Nov 24 2021 at 21:15)</a>:</h4>
<p>I would prefer something like the child approach (it's similar to how <code>impl trait</code> in impls works). It might be easier to override the parent in <code>generics_of</code> that actually change the HIR while prototyping because the compiler assumes that associated items have either a trait or an impl as their parent.</p>



<a name="262641641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262641641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262641641">(Nov 24 2021 at 21:20)</a>:</h4>
<p>Duplicating the generics in HIR is maybe possible, but HIR is pretty deliberately hard to copy.</p>



<a name="262641967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262641967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262641967">(Nov 24 2021 at 21:24)</a>:</h4>
<p>So, by patching up the parent in <code>generics_of</code>, we can get rid of the copying generic type/const parameters?</p>



<a name="262642008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262642008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262642008">(Nov 24 2021 at 21:24)</a>:</h4>
<p>I think so</p>



<a name="262642057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262642057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262642057">(Nov 24 2021 at 21:25)</a>:</h4>
<p>Great!</p>



<a name="262703057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262703057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262703057">(Nov 25 2021 at 13:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116118">Matthew Jasper</span> <a href="#narrow/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering/near/262641233">said</a>:</p>
<blockquote>
<p>I would prefer something like the child approach (it's similar to how <code>impl trait</code> in impls works). It might be easier to override the parent in <code>generics_of</code> that actually change the HIR while prototyping because the compiler assumes that associated items have either a trait or an impl as their parent.</p>
</blockquote>
<p>so you meant that in <code>generics_of</code> we would need to switch the parent on the fly from the function to the trait/trait impl?</p>



<a name="262709674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/impl%20trait%20in%20traits%20associated%20type%20lowering/near/262709674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/impl.20trait.20in.20traits.20associated.20type.20lowering.html#262709674">(Nov 25 2021 at 14:08)</a>:</h4>
<p>That trait would be the actual parent in the HIR, the parent in <code>generics_of</code> would be changed to the method</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>