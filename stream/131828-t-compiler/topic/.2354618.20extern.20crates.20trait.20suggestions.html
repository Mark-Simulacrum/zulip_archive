<html>
<head><meta charset="utf-8"><title>#54618 extern crates trait suggestions · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html">#54618 extern crates trait suggestions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="135192005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192005">(Oct 04 2018 at 14:23)</a>:</h4>
<p>Looking into <a href="https://github.com/rust-lang/rust/issues/54618" target="_blank" title="https://github.com/rust-lang/rust/issues/54618">#54618</a>. The issue is that if a crate isn't loaded but has a <code>--extern</code> then it won't make a suggestion. So I figure when making suggestions I'd need to load any crates from <code>--extern</code>flags first so that it can make suggestions from all crates. That means that this is a fairly rare case, since you'd only ever run into it if you add a dependency and don't use it, but expect the suggestion from it in errors. Anyway, I'm not sure how I'd go about loading crates from <code>rustc_typeck</code>. If there was a way to access a <code>CrateLoader</code> I could probably call <code>maybe_process_path_extern</code> on the <code>session.extern_prelude</code> names.</p>



<a name="135192114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192114" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192114">(Oct 04 2018 at 14:24)</a>:</h4>
<blockquote>
<p>That means that this is a fairly rare case, since you'd only ever run into it if you add a dependency and don't use it, but expect the suggestion from it in errors</p>
</blockquote>
<p>I don't think is that rare. e.g., it happens a lot with things like <code>rayon</code> and <code>itertools</code></p>



<a name="135192124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192124" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192124">(Oct 04 2018 at 14:24)</a>:</h4>
<p>which mainly extend types with new methods via traits</p>



<a name="135192133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192133" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192133">(Oct 04 2018 at 14:25)</a>:</h4>
<p>We do similar with the "did you mean to import X" suggestions - we iterate over all <code>--extern</code> crates and then load then and check if we can find a path in it; but that happens at a point where I can call functions on <code>CrateLoader</code>.</p>



<a name="135192162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192162" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192162">(Oct 04 2018 at 14:25)</a>:</h4>
<p>yeah I'm not sure about that aspect of it</p>



<a name="135192167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192167">(Oct 04 2018 at 14:25)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Well, what I mean is,  you'd need to add the crate to <code>Cargo.toml</code> and never import anything or use anything from that crate. That way you'd have an <code>--extern</code> flag to <code>rustc</code> but it'd never actually load the crate.</p>



<a name="135192175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192175" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192175">(Oct 04 2018 at 14:25)</a>:</h4>
<p>right, I'm saying this is common :)</p>



<a name="135192179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192179" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192179">(Oct 04 2018 at 14:25)</a>:</h4>
<p>in those specific scenarios</p>



<a name="135192222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192222">(Oct 04 2018 at 14:26)</a>:</h4>
<p>Ah, I see what you mean.</p>



<a name="135192225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192225" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192225">(Oct 04 2018 at 14:26)</a>:</h4>
<p>that is, you might reasonably add <code>rayon = "1.0"</code> and then use <code>par_iter()</code></p>



<a name="135192281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192281" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192281">(Oct 04 2018 at 14:26)</a>:</h4>
<p>Yeah, I see what you mean. I just think it'd be a little bit of a strange workflow to add the crate, then re-run the not-compiling code where you presumably are calling <code>par_iter</code> to see what to import  from the suggestion - presumably you'd have found that in documentation by that point.</p>



<a name="135192286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192286" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192286">(Oct 04 2018 at 14:27)</a>:</h4>
<p>It's inconsequential either way.</p>



<a name="135192643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135192643" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135192643">(Oct 04 2018 at 14:31)</a>:</h4>
<p>One way I think I could do it would be to make <code>rustc_typeck</code> depend on <code>rustc_metadata</code>, then I might be able to construct a <code>CrateLoader</code> with the <code>&amp;'a CrateStoreDyn</code> and <code>&amp;'a Session</code> stored in <code>TyCtxt</code>. Though <code>&amp;'a CrateStoreDyn</code> is not <code>&amp;'a CStore</code>. I don't know that I like that solution that much though.</p>



<a name="135197005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197005">(Oct 04 2018 at 15:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Do you have any suggestions on how best I'd go about doing this? Effectively I need a function that'll load all crates so I can use them for suggestions while in <code>rustc_typeck</code>.</p>



<a name="135197193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197193">(Oct 04 2018 at 15:36)</a>:</h4>
<blockquote>
<p>Yeah, I see what you mean. I just think it'd be a little bit of a strange workflow to add the crate, then re-run the not-compiling code where you presumably are calling <code>par_iter</code> to see what to import  from the suggestion - presumably you'd have found that in documentation by that point.</p>
</blockquote>
<p>I did it :)</p>



<a name="135197201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197201" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197201">(Oct 04 2018 at 15:36)</a>:</h4>
<p>hence how I came to file this bug...</p>



<a name="135197206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197206" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197206">(Oct 04 2018 at 15:36)</a>:</h4>
<p>I think though I was sort of expecting the compiler to tell me the trait to import</p>



<a name="135197211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197211">(Oct 04 2018 at 15:36)</a>:</h4>
<p>I thought it was from the test I added to the other PR.</p>



<a name="135197222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197222">(Oct 04 2018 at 15:37)</a>:</h4>
<p>I guess in which case, I've also done it.</p>



<a name="135197237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197237" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197237">(Oct 04 2018 at 15:37)</a>:</h4>
<p>oh, yes, true :) regardless I have done it</p>



<a name="135197240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197240" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197240">(Oct 04 2018 at 15:37)</a>:</h4>
<p>maybe subsequently though</p>



<a name="135197247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197247" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197247">(Oct 04 2018 at 15:37)</a>:</h4>
<p>in particular I often lean on the compiler to tell me the right traits...</p>



<a name="135197251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197251" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197251">(Oct 04 2018 at 15:37)</a>:</h4>
<p><em>anyway</em></p>



<a name="135197257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197257" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197257">(Oct 04 2018 at 15:37)</a>:</h4>
<p>I'm not sure let me look into the crate loading business</p>



<a name="135197303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197303" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197303">(Oct 04 2018 at 15:38)</a>:</h4>
<p>I'm not sure how much of a big deal it is to load all crates eagerly</p>



<a name="135197321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197321" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197321">(Oct 04 2018 at 15:38)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span> who probably has thoughts — see <a href="https://github.com/rust-lang/rust/issues/54618" target="_blank" title="https://github.com/rust-lang/rust/issues/54618">#54618</a> for context</p>



<a name="135197327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197327" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197327">(Oct 04 2018 at 15:38)</a>:</h4>
<p>I've just assumed there's a reason we only load them when we encounter a path with them in it.</p>



<a name="135197415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197415" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197415">(Oct 04 2018 at 15:40)</a>:</h4>
<p>presumably yes</p>



<a name="135197423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197423" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197423">(Oct 04 2018 at 15:40)</a>:</h4>
<p>but...you never know...</p>



<a name="135197442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197442" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197442">(Oct 04 2018 at 15:40)</a>:</h4>
<p>At the very least it's better not to do it if we don't need them.</p>



<a name="135197462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197462" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197462">(Oct 04 2018 at 15:41)</a>:</h4>
<p>well, I was wondering in particular if "loading a crate" were quite lazy</p>



<a name="135197465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197465" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197465">(Oct 04 2018 at 15:41)</a>:</h4>
<p>then it would seem fine</p>



<a name="135197481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197481" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197481">(Oct 04 2018 at 15:41)</a>:</h4>
<p>anyway, you are correct that this <code>CrateLoader</code> gets destroyed</p>



<a name="135197602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197602" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197602">(Oct 04 2018 at 15:43)</a>:</h4>
<p>though it doesn't appear to be a very "heavyweight" data structure</p>



<a name="135197612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197612" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197612">(Oct 04 2018 at 15:43)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CrateLoader</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">sess</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">Session</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cstore</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">CStore</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">local_crate_name</span>: <span class="nc">Symbol</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="135197696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197696" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197696">(Oct 04 2018 at 15:44)</a>:</h4>
<p>Yeah, we have everything available at the place where I need it (roughly) to be able to construct a new one - since it seems to just hold operations for adding to the <code>CStore</code>. But, <code>rustc_metadata</code> isn't a dependency of that crate so I can't access it.</p>



<a name="135197835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135197835" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135197835">(Oct 04 2018 at 15:46)</a>:</h4>
<p>(it's "roughly" because <code>GlobalCtxt</code>, IIRC, has a <code>CrateStoreDyn</code> which implements the same trait as <code>Cstore</code> - so not quite enough to make a <code>CreateLoader</code> but almost)</p>



<a name="135198268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135198268" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135198268">(Oct 04 2018 at 15:53)</a>:</h4>
<p>right and it may be that this separation is intended to be refactored into something stronger</p>



<a name="135198398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135198398" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135198398">(Oct 04 2018 at 15:55)</a>:</h4>
<p>I'll take a look into some other issues until there's a clearer idea of what approach we want to take here.</p>



<a name="135256275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135256275" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135256275">(Oct 05 2018 at 13:58)</a>:</h4>
<blockquote>
<p>since you'd only ever run into it if you add a dependency and don't use it, but expect the suggestion from it in errors</p>
</blockquote>
<p>It's not the most compelling case, but this is exactly how the playground works ;-) This error would improve that experience.</p>



<a name="135256491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135256491" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135256491">(Oct 05 2018 at 14:01)</a>:</h4>
<p>That's a good point, hadn't considered that.</p>



<a name="135257075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135257075" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135257075">(Oct 05 2018 at 14:12)</a>:</h4>
<p>that's kind of neat =)</p>



<a name="135609705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135609705" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135609705">(Oct 11 2018 at 13:56)</a>:</h4>
<p>Has there been any discussion or thought about the approach to be taken for this issue?</p>



<a name="135610066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/135610066" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#135610066">(Oct 11 2018 at 14:02)</a>:</h4>
<p>not really :(</p>



<a name="136927164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927164" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927164">(Nov 01 2018 at 15:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> where'd you get stuck?</p>



<a name="136927197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927197">(Nov 01 2018 at 15:05)</a>:</h4>
<p>all you need is to plumb this through the query engine <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_resolve/lib.rs#L4474-L4475" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_resolve/lib.rs#L4474-L4475">https://github.com/rust-lang/rust/blob/master/src/librustc_resolve/lib.rs#L4474-L4475</a></p>



<a name="136927200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927200" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927200">(Nov 01 2018 at 15:05)</a>:</h4>
<p><em>whoops</em></p>



<a name="136927218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927218" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927218">(Nov 01 2018 at 15:05)</a>:</h4>
<p>Let's move to the dedicated topic for this.</p>



<a name="136927222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927222">(Nov 01 2018 at 15:05)</a>:</h4>
<p>if the crate loader is separate from the crate store, maybe you can put the former in the latter?</p>



<a name="136927272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927272" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927272">(Nov 01 2018 at 15:06)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="136927296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927296" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927296">(Nov 01 2018 at 15:06)</a>:</h4>
<p>So, I don't think I made any attempts at actually implementing anything, I just looked around for a while and couldn't see a way I'd do it.</p>



<a name="136927312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927312" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927312">(Nov 01 2018 at 15:07)</a>:</h4>
<p>well, you put the crate loader in the crate store, if it's not already there</p>



<a name="136927323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927323" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927323">(Nov 01 2018 at 15:07)</a>:</h4>
<p>and the crate store can just provide queries, so... that's it</p>



<a name="136927344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927344" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927344">(Nov 01 2018 at 15:07)</a>:</h4>
<p>you add a query for <code>maybe_load_extern_crate</code> or something</p>



<a name="136927348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927348" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927348">(Nov 01 2018 at 15:07)</a>:</h4>
<p>One option I considered was making a function that would make a <code>CrateLoader</code> (the contents of which are mostly available) and then just call the correct function on that for each crate, but we only have a type erased crate store, not the actual type that is required.</p>



<a name="136927399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927399" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927399">(Nov 01 2018 at 15:08)</a>:</h4>
<p>I've not looked at the query system much, I'll need to familarize myself with that.</p>



<a name="136927405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927405" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927405">(Nov 01 2018 at 15:08)</a>:</h4>
<p>that's why you implement things on teh actual crate store</p>



<a name="136927431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927431" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927431">(Nov 01 2018 at 15:08)</a>:</h4>
<p>which gets special treatment from the query engine</p>



<a name="136927485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927485" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927485">(Nov 01 2018 at 15:09)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_metadata/cstore_impl.rs#L101" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_metadata/cstore_impl.rs#L101">https://github.com/rust-lang/rust/blob/master/src/librustc_metadata/cstore_impl.rs#L101</a></p>



<a name="136927593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927593" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927593">(Nov 01 2018 at 15:10)</a>:</h4>
<p>oh god this is such a hack <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_metadata/cstore_impl.rs#L83-L84" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_metadata/cstore_impl.rs#L83-L84">https://github.com/rust-lang/rust/blob/master/src/librustc_metadata/cstore_impl.rs#L83-L84</a></p>



<a name="136927634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927634">(Nov 01 2018 at 15:11)</a>:</h4>
<p>okay nvm this wouldn't work like that</p>



<a name="136927703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927703" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927703">(Nov 01 2018 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> okay, uhhh, just add a method to <a href="https://github.com/rust-lang/rust/blob/master/src/librustc/middle/cstore.rs#L208" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/middle/cstore.rs#L208">https://github.com/rust-lang/rust/blob/master/src/librustc/middle/cstore.rs#L208</a></p>



<a name="136927713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927713" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927713">(Nov 01 2018 at 15:12)</a>:</h4>
<p>that does the loading</p>



<a name="136927715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927715" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927715">(Nov 01 2018 at 15:12)</a>:</h4>
<p>that should work</p>



<a name="136927731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927731" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927731">(Nov 01 2018 at 15:13)</a>:</h4>
<p>you can probably figure out how to do an <code>_untracked</code> method with a query elsewhere</p>



<a name="136927742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927742" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927742">(Nov 01 2018 at 15:13)</a>:</h4>
<p>Alright, I'll give that a go and see what I can figure out.</p>



<a name="136927743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136927743" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136927743">(Nov 01 2018 at 15:13)</a>:</h4>
<p>just by grepping for those method names in the trait</p>



<a name="136990813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136990813" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136990813">(Nov 02 2018 at 10:43)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I've got it so that I can call the function to load something and I can see it doing that in the logs. However, I've not figured out how to get that to invalidate the <code>all_crate_nums</code> (and following on from that, the <code>all_traits</code>) queries.</p>



<a name="136990845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136990845" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136990845">(Nov 02 2018 at 10:43)</a>:</h4>
<p>(with the above said, I'm not 100% sure that I've implemented the query correctly, but I can call it, so <span class="emoji emoji-1f937" title="shrug">:shrug:</span>)</p>



<a name="136991244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991244" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991244">(Nov 02 2018 at 10:47)</a>:</h4>
<p>ehm, it can't do that :(</p>



<a name="136991273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991273" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991273">(Nov 02 2018 at 10:47)</a>:</h4>
<p>you have to make <code>all_traits </code>not use <code>all_crate_nums</code></p>



<a name="136991343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991343">(Nov 02 2018 at 10:48)</a>:</h4>
<p>or, rather, it should use <code>all_crate_nums</code> in combination with loading everything in the extern prelude, speculatively</p>



<a name="136991350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991350" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991350">(Nov 02 2018 at 10:48)</a>:</h4>
<p>Ah.</p>



<a name="136991356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991356" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991356">(Nov 02 2018 at 10:48)</a>:</h4>
<p>and use a set because you might get the same <code>CrateNum</code> more than once</p>



<a name="136991540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991540" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991540">(Nov 02 2018 at 10:50)</a>:</h4>
<p>Thanks, I'll look into doing that.</p>



<a name="136991562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991562">(Nov 02 2018 at 10:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> ^^ do you think that's a good approach?</p>



<a name="136991580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991580" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991580">(Nov 02 2018 at 10:50)</a>:</h4>
<p>basically I'm saying <code>all_traits</code> should always look in <code>--extern</code> crates even if nothing else loads them</p>



<a name="136991605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991605" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991605">(Nov 02 2018 at 10:50)</a>:</h4>
<p>but this might be bad/wrong if <code>all_traits</code> is used for non-diagnostic purposes</p>



<a name="136991665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991665">(Nov 02 2018 at 10:51)</a>:</h4>
<p>I'm not sure it is just <code>all_traits</code> - there's two computations as far as I can gather - one for out of scope traits (don't think it uses <code>all_traits</code>) and one for traits that it suggests you implement (does use <code>all_traits</code>).</p>



<a name="136991763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991763" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991763">(Nov 02 2018 at 10:52)</a>:</h4>
<p>To handle that, I've been trying to speculatively load all crates as soon as we're about to compute the earliest of those two - in the hopes that with the crates now loaded, they'd both get the benefit.</p>



<a name="136991782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991782" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991782">(Nov 02 2018 at 10:52)</a>:</h4>
<p>But, since it doesn't invalidate the other queries, that doesn't seem to happen.</p>



<a name="136991953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/136991953" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#136991953">(Nov 02 2018 at 10:54)</a>:</h4>
<p>no, you probably don't want other things to see those crates as loaded</p>



<a name="137000469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137000469" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137000469">(Nov 02 2018 at 11:54)</a>:</h4>
<p>Alright, so I have this working - mostly.</p>



<a name="137000517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137000517" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137000517">(Nov 02 2018 at 11:54)</a>:</h4>
<p>It correctly suggests both "you might want to implement this" and "there's an implementation of this, import it".</p>



<a name="137000586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137000586" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137000586">(Nov 02 2018 at 11:55)</a>:</h4>
<p>In fact, I think I know what the issue I've not explained yet might be.</p>



<a name="137000854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137000854" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137000854">(Nov 02 2018 at 11:56)</a>:</h4>
<p>Alright, fairly certain I don't.</p>



<a name="137001541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137001541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137001541">(Nov 02 2018 at 12:00)</a>:</h4>
<p>So, the issue I'm seeing is that I have this code:</p>
<div class="codehilite"><pre><span></span><span class="w">    </span><span class="c1">// Expect a &quot;try using baz::BazTrait&quot; (which involves</span>
<span class="w">    </span><span class="c1">// loading that crate speculatively as it isn&#39;t otherwise used).</span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">extern_baz</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Local</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Expect a &quot;consider implementing baz::BazTrait&quot;.</span>
<span class="w">    </span><span class="n">local</span><span class="p">.</span><span class="n">extern_baz</span><span class="p">();</span><span class="w"></span>
</pre></div>


<p>where <code>x</code> is a <code>u32</code> and has an implementation of <code>BazTrait</code> (which is from the external crate and defines the method <code>extern_baz</code>) and <code>Local</code> is a local type that doesn't implement it.</p>
<p>With the test as above, I get the following error:</p>
<div class="codehilite"><pre><span></span>   |
LL | struct Local;
   | ------------- method `extern_baz` not found for this
...
LL |     local.extern_baz();
   |           ^^^^^^^^^^
   |
   = help: items from traits can only be used if the trait is implemented and in scope
   = note: the following trait defines an item `extern_baz`, perhaps you need to implement it:
           candidate #1: `baz::BazTrait`
</pre></div>


<p>Which is ideal, that's what I want. However, I don't get an error for the <code>x.extern_baz()</code> line. I've hooked up this change to both of those diagnostics so I should be getting it. I've discovered if I comment out <code>let local = Local;</code> (which causes a "what is <code>local</code>" error, but that's fine), then I get a suggestion like this (as expected) for the <code>x.extern_baz()</code> line:</p>
<div class="codehilite"><pre><span></span>help: the following trait is implemented but not in scope, perhaps add a `use` for it:
   |
LL | use baz::BazTrait;
   |
</pre></div>


<p>Not sure why I can't get both at once to happen.</p>



<a name="137001666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137001666" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137001666">(Nov 02 2018 at 12:01)</a>:</h4>
<p>I'm lucky that I made the mistake of not adding <code>let local = Local;</code> initially and noticing the difference once I added it or I'd have taken way longer to realise that statement was having an effect.</p>



<a name="137002385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137002385" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137002385">(Nov 02 2018 at 12:05)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/method/suggest.rs#L587" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/method/suggest.rs#L587">This function</a> is called once for each error location - <code>x.extern_baz()</code> and <code>local.extern_baz()</code>. When <code>local</code> is commented, then <code>out_of_scope_traits</code> for <code>x.extern_baz</code> has one item in it during it's call (as it should). When <code>local</code> isn't commented, then <code>out_of_scope_traits</code> is empty for both of their calls (which is expected for the <code>local</code> case, it goes on to report a "you could implement it though" error correctly).</p>



<a name="137002727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137002727" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137002727">(Nov 02 2018 at 12:06)</a>:</h4>
<p>It seems that for some reason <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/method/probe.rs#L1182-L1185" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/method/probe.rs#L1182-L1185">this branch is used</a> for the <code>x.extern_baz()</code> case when <code>local</code> is uncommented.</p>



<a name="137002902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137002902" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137002902">(Nov 02 2018 at 12:08)</a>:</h4>
<p>The <code>suggest_traits_to_import</code> call for the <code>x.extern_baz()</code> case happens first irrespective of <code>local</code> being commented.</p>



<a name="137005719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137005719" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137005719">(Nov 02 2018 at 12:20)</a>:</h4>
<p>I'm struggling to work out what the issue is here, any ideas?</p>



<a name="137007054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137007054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137007054">(Nov 02 2018 at 12:27)</a>:</h4>
<p>It seems like it isn't an pre-existing issue with these two suggestions - <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=f7001d854df4616012e0aa9d12a7794d" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=f7001d854df4616012e0aa9d12a7794d">playground</a>.</p>



<a name="137007431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137007431" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137007431">(Nov 02 2018 at 12:29)</a>:</h4>
<p>It does seem to work as expected if I have two of the "it's implemented, try using it" suggestion - which makes me think that the issue stems from the overlap of both types of suggestion - "implemented try use" and "not implemented, try implement".</p>



<a name="137007889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137007889" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137007889">(Nov 02 2018 at 12:31)</a>:</h4>
<p>Similarly, if I have two occurances of the "not implemented, try implement" case then both get a suggestion. That would suggest that the new  speculative crate load isn't only working once.</p>



<a name="137029887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137029887" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137029887">(Nov 02 2018 at 14:03)</a>:</h4>
<p>Huh, now I'm getting it to fail without having the other suggestion at all. I don't know what is different.</p>



<a name="137032129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137032129" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137032129">(Nov 02 2018 at 14:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> do you have any idea why I might be seeing what I've described above?</p>



<a name="137032944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137032944" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137032944">(Nov 02 2018 at 14:14)</a>:</h4>
<p>Hmm</p>



<a name="137032987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137032987" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137032987">(Nov 02 2018 at 14:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> is there an open PR or something so I can "catch up" on what approach you used?</p>



<a name="137033425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137033425" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137033425">(Nov 02 2018 at 14:16)</a>:</h4>
<p><a href="https://gist.github.com/davidtwco/fb921467534b6f7351f68f49e827a493" target="_blank" title="https://gist.github.com/davidtwco/fb921467534b6f7351f68f49e827a493">I've got the log output in a gist here</a>. Will open a PR in a moment.</p>



<a name="137033793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137033793" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137033793">(Nov 02 2018 at 14:18)</a>:</h4>
<p>Searching for <code>consider_probe</code> has the logs that are as deep as I've tracked it down - <a href="https://gist.github.com/davidtwco/fb921467534b6f7351f68f49e827a493#file-gistfile1-txt-L1548-L1551" target="_blank" title="https://gist.github.com/davidtwco/fb921467534b6f7351f68f49e827a493#file-gistfile1-txt-L1548-L1551">these lines</a>.</p>



<a name="137034405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137034405" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137034405">(Nov 02 2018 at 14:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <a href="https://github.com/rust-lang/rust/issues/55613" target="_blank" title="https://github.com/rust-lang/rust/issues/55613">#55613</a></p>



<a name="137034684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137034684" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137034684">(Nov 02 2018 at 14:21)</a>:</h4>
<p>(the stderr file has the desired output in that PR, so it will fail the tests)</p>



<a name="137034929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137034929" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137034929">(Nov 02 2018 at 14:22)</a>:</h4>
<p>(lines 28-30 for <code>src/test/ui/rust-2018/trait-import-suggestions.stderr</code> don't  show up in practice)</p>



<a name="137073330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137073330" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137073330">(Nov 02 2018 at 18:28)</a>:</h4>
<p>sorry will try to look soon :) got distracted</p>



<a name="137085798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137085798" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137085798">(Nov 02 2018 at 22:07)</a>:</h4>
<p>No worries.</p>



<a name="137085800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/137085800" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#137085800">(Nov 02 2018 at 22:07)</a>:</h4>
<p>Thanks.</p>



<a name="147531010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/147531010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#147531010">(Nov 12 2018 at 15:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> hope SPLASH went well, I enjoyed your blog post. I've not done any more digging on the issue from this PR - just wanted to bump it - there's no rush, I'm sure you're super busy catching up <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="147543776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/147543776" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#147543776">(Nov 12 2018 at 18:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> indeed :) thanks</p>



<a name="151275422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/151275422" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#151275422">(Dec 10 2018 at 14:21)</a>:</h4>
<p>As a data point, there's at least one person who <a href="https://github.com/integer32llc/rust-playground/issues/445" target="_blank" title="https://github.com/integer32llc/rust-playground/issues/445">isn't a fan of extern crate suggestions for types in the playground</a>, which <em>is</em> a non-usual case.</p>



<a name="151563435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/151563435" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#151563435">(Dec 12 2018 at 21:02)</a>:</h4>
<p>FYI <span class="user-mention" data-user-id="116009">@nikomatsakis</span>, there is this PR that I also ran into a wall with - not had time to revisit it and take a look with fresh eyes yet though.</p>



<a name="152109297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152109297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152109297">(Dec 18 2018 at 13:57)</a>:</h4>
<p>Spent some more time digging into what was going on here today. Managed to get a decent 20+ functions deep and end up <a href="https://github.com/rust-lang/rust/blob/041254b81495a5aa67af839e00b890e78ed0cbeb/src/librustc/ty/trait_def.rs#L185" target="_blank" title="https://github.com/rust-lang/rust/blob/041254b81495a5aa67af839e00b890e78ed0cbeb/src/librustc/ty/trait_def.rs#L185">at this line</a> where despite loading all extern crates using the new query that this PR adds earlier in the execution and having <code>trait_id</code> in that function be from the external crate, the call to <code>tcx.crates()</code> doesn't include the crate - and therefore rustc concludes the trait isn't implemented for <code>u32</code> when it is.</p>



<a name="152109389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152109389" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152109389">(Dec 18 2018 at 13:58)</a>:</h4>
<p>Not sure really how to work around that. It is consistent since when we do our <a href="https://github.com/rust-lang/rust/blob/e03d25f30bf38ba1b74bc4dd071a9b44bc3a6060/src/librustc_typeck/check/method/suggest.rs#L772-L789" target="_blank" title="https://github.com/rust-lang/rust/blob/e03d25f30bf38ba1b74bc4dd071a9b44bc3a6060/src/librustc_typeck/check/method/suggest.rs#L772-L789">speculative crate load here</a>, we still need to append it to the <code>tcx.crates()</code> results afterwards.</p>



<a name="152109427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152109427" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152109427">(Dec 18 2018 at 13:59)</a>:</h4>
<p>I'll need to look into whether the new query should affect the result of <code>tcx.crates()</code> and if it should, why it isn't, and if it isn't, what alternatives there are.</p>



<a name="152116210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152116210" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152116210">(Dec 18 2018 at 15:39)</a>:</h4>
<p>Seems like the <code>crates</code> query shouldn't be being run because it's already been cached - as far as I gather from this <a href="#narrow/stream/131828-t-compiler/subject/.2354618.20extern.20crates.20trait.20suggestions/near/136991244" title="#narrow/stream/131828-t-compiler/subject/.2354618.20extern.20crates.20trait.20suggestions/near/136991244">old message from eddyb</a> - that can't be changed. </p>
<p>Doing what I did in to solve the issue that spurred on that previous message and just combining the output of <code>tcx.crates()</code> and the new query that this adds ends up hitting an ICE <a href="https://github.com/rust-lang/rust/blob/041254b81495a5aa67af839e00b890e78ed0cbeb/src/librustc/traits/specialize/specialization_graph.rs#L408-L409" target="_blank" title="https://github.com/rust-lang/rust/blob/041254b81495a5aa67af839e00b890e78ed0cbeb/src/librustc/traits/specialize/specialization_graph.rs#L408-L409">here</a> and <a href="https://github.com/rust-lang/rust/blob/041254b81495a5aa67af839e00b890e78ed0cbeb/src/librustc/dep_graph/graph.rs#L404" target="_blank" title="https://github.com/rust-lang/rust/blob/041254b81495a5aa67af839e00b890e78ed0cbeb/src/librustc/dep_graph/graph.rs#L404">then here</a> (if you just comment out the first one). </p>
<p>Using the <code>CrateNum</code> that already exists from the <code>DefId</code> of the trait (which isn't ideal, then we'd only find impls from the same crate as the trait, and not impls from any other extern crates that are not imported) then we get the same errors.</p>
<p>Not really sure how to progress again.</p>



<a name="152116274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152116274" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152116274">(Dec 18 2018 at 15:40)</a>:</h4>
<p>I suspect even if the <code>tcx.crates()</code> query returned the crate num that it would run into the same ICEs anyway.</p>



<a name="152117264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152117264" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152117264">(Dec 18 2018 at 15:54)</a>:</h4>
<p>Could we make the <code>crates</code> query return a structure that offers an accessor method for the list of crates as it does now, but also has a second accessor for all crates that will <code>delay_span_bug</code> to ensure we only use it in an error reporting path?</p>



<a name="152117315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152117315" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152117315">(Dec 18 2018 at 15:55)</a>:</h4>
<p>I'm assuming that there's another query that actually loads the crates, so just calling <code>crates</code> will not load all crates, but just reserve <code>CrateNum</code>s for them</p>



<a name="152117647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152117647" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152117647">(Dec 18 2018 at 15:59)</a>:</h4>
<blockquote>
<p>I'm assuming that there's another query that actually loads the crates, so just calling <code>crates</code> will not load all crates, but just reserve <code>CrateNum</code>s for them</p>
</blockquote>
<p>There's a new query added in the PR for this issue that loads a crate given a name (and we use <code>tcx.extern_prelude.keys()</code> to get those) - so the loading <em>should</em> be handled - we'd just need <code>crates</code> to return that new <code>CrateNum</code> too - which I suspect it would do, because the <code>cstore</code> has changed with the previous load and the provider behind <code>crates</code> would pick that up fine - it's just the caching that gets in the way for that.</p>
<p>However, I suspect that even doing that (while probably necessary) wouldn't solve the ICEs that it then runs into - that might be a result of the way that the <code>maybe_load_extern_crate</code> query that this PR added works.</p>



<a name="152118827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152118827" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152118827">(Dec 18 2018 at 16:15)</a>:</h4>
<p>is <code>crates</code> doing a lot of work? if not, we could maybe stop caching it?</p>



<a name="152118912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152118912" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152118912">(Dec 18 2018 at 16:16)</a>:</h4>
<p>My original suggestion/question above was whether <code>crates</code> could emit the extern prelude crates from the beginning instead of trying to make it emit more crates later</p>



<a name="152120860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152120860" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152120860">(Dec 18 2018 at 16:44)</a>:</h4>
<p><code>crates</code> just iterates over <code>self.metas</code> in the <code>cstore</code>. </p>
<p>Sorry, I misunderstood your suggestion. I don’t think it could (though that’s just my understanding of it).</p>



<a name="152120915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152120915" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152120915">(Dec 18 2018 at 16:45)</a>:</h4>
<p>I’m not sure though if there are other queries related to crates with cached outputs that would explain the follow-on ICEs though.</p>



<a name="152174487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152174487" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152174487">(Dec 19 2018 at 11:01)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@Oli</span> do you recall how to stop caching a query? I've tried changing <a href="https://github.com/rust-lang/rust/blob/e7b4bc35e99ee3c5b2b42a1b8b3f9cd6eca1f0b2/src/librustc/dep_graph/dep_node.rs#L647" target="_blank" title="https://github.com/rust-lang/rust/blob/e7b4bc35e99ee3c5b2b42a1b8b3f9cd6eca1f0b2/src/librustc/dep_graph/dep_node.rs#L647">this line</a> to <code>eval_always</code> but that doesn't seem to be doing it and I can't see anything else.</p>



<a name="152175041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152175041" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152175041">(Dec 19 2018 at 11:12)</a>:</h4>
<p>I think you "just" need to not make it be a query by removing the entry and adding a function to <code>TyCtxt</code></p>



<a name="152175056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152175056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152175056">(Dec 19 2018 at 11:12)</a>:</h4>
<p>Alright, I'll try that, thanks.</p>



<a name="152175650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152175650" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152175650">(Dec 19 2018 at 11:25)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@Oli</span> I think that might just have done it! Thanks. I suspect the other ICEs I saw before were just because adding that new <code>CrateNum</code> at just that function wasn't a good idea.</p>



<a name="152175713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354618%20extern%20crates%20trait%20suggestions/near/152175713" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2354618.20extern.20crates.20trait.20suggestions.html#152175713">(Dec 19 2018 at 11:27)</a>:</h4>
<p>cool! be sure to do a perf run, but it seems like it's a pretty cheap wrapper around accessing <code>self.metas</code></p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>