<html>
<head><meta charset="utf-8"><title>Profile Guided Optimization without Profiles: A Machine L... · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html">Profile Guided Optimization without Profiles: A Machine L...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266635882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266635882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266635882">(Jan 02 2022 at 22:19)</a>:</h4>
<p>This paper was published to arxiv a couple of week ago: <a href="https://arxiv.org/abs/2112.14679">https://arxiv.org/abs/2112.14679</a> It uses machine learning instead of profiling to estimate branch probabilities for PGO. Could we try it on rustc? If it doesn't regress runtime performance this may save CI time by avoiding the need to run rustc on several programs to gather profiles. I don't know if it is possible out of the box, but maybe it could even avoid having to compile rustc twice. Instead adding an llvm pass that runs this system to insert the branch probabilities before PGO runs.</p>



<a name="266638237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266638237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266638237">(Jan 02 2022 at 23:17)</a>:</h4>
<p>Wait, does Rust use PGO profiles to build rustc releases? Are those profiles available for those that compile their own rustc?</p>



<a name="266639010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639010">(Jan 02 2022 at 23:37)</a>:</h4>
<p>In theory yes, though I don't think we've ever checked or verified they're actually usable locally - they are uploaded though.</p>



<a name="266639013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639013">(Jan 02 2022 at 23:37)</a>:</h4>
<p>(both for the llvm and rustc builds)</p>



<a name="266639053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639053">(Jan 02 2022 at 23:38)</a>:</h4>
<p>Just on x86_64-unknown-linux-gnu currently.</p>



<a name="266639281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639281">(Jan 02 2022 at 23:44)</a>:</h4>
<p>Any chance you could point me to where?</p>



<a name="266639383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639383">(Jan 02 2022 at 23:47)</a>:</h4>
<p>Yeah, in a bit</p>



<a name="266639533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639533">(Jan 02 2022 at 23:51)</a>:</h4>
<p><span class="user-mention" data-user-id="435059">@Ben Reeves</span> <a href="https://static.rust-lang.org/dist/2021-10-10/reproducible-artifacts-nightly-x86_64-unknown-linux-gnu.tar.xz">https://static.rust-lang.org/dist/2021-10-10/reproducible-artifacts-nightly-x86_64-unknown-linux-gnu.tar.xz</a> for example for nightlies</p>



<a name="266639620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266639620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266639620">(Jan 02 2022 at 23:53)</a>:</h4>
<p>should be at <a href="http://ci-artifacts.rust-lang.org/rustc-builds/$commit_hash/reproducible-artifacts-nightly-x86_64-unknown-linux-gnu.tar.xz">ci-artifacts.rust-lang.org/rustc-builds/$commit_hash/reproducible-artifacts-nightly-x86_64-unknown-linux-gnu.tar.xz</a> for by-commit artifacts, though those are only kept for ~180 days</p>



<a name="266736962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266736962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266736962">(Jan 03 2022 at 21:09)</a>:</h4>
<p>Sorry for continuing to hijack this thread, but where can I find out the "test suite" used to generate those PGO profiles? Is it just like a crater run, compiling a bunch of Rust code from GitHub?</p>
<p>I ask because I'm contemplating trying to use them for compiling our fork of rustc at work, so it'd be useful to know what the dataset is and therefore if the PGO profile is maybe not general enough</p>



<a name="266737709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266737709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266737709">(Jan 03 2022 at 21:16)</a>:</h4>
<p>this should help: <a href="https://github.com/rust-lang/rust/blob/master/src/ci/pgo.sh">https://github.com/rust-lang/rust/blob/master/src/ci/pgo.sh</a></p>



<a name="266741064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Profile%20Guided%20Optimization%20without%20Profiles%3A%20A%20Machine%20L.../near/266741064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Profile.20Guided.20Optimization.20without.20Profiles.3A.20A.20Machine.20L.2E.2E.2E.html#266741064">(Jan 03 2022 at 21:54)</a>:</h4>
<p>Yeah, that's the place. It's not very solidly put together, but in practice seems to see good wins on the ~many benchmarks in perf.rlo beyond those added into the PGO data directly, so it seems fairly ok</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>