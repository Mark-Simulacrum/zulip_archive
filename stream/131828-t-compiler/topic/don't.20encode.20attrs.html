<html>
<head><meta charset="utf-8"><title>don&#x27;t encode attrs · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html">don&#x27;t encode attrs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277687535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277687535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277687535">(Apr 04 2022 at 06:38)</a>:</h4>
<p>in <a href="https://github.com/rust-lang/rust/issues/95562">#95562</a> i've stopped encoding some attributes in the crate metadata if they are only needed for the current crate.</p>
<p>I don't like that too much because it seems somewhat fragile, e.g. removing <code>#[stable]</code> annotations (which should be a ~1% perf impact probably), ended up causing some diagnostics changes I didn't want to deal with.</p>



<a name="277687822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277687822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277687822">(Apr 04 2022 at 06:42)</a>:</h4>
<p>i think that ideally I would like to simply not encode attributes at all, relying us to store relevant attributes in some other way which is specialized for each attribute. e.g.  <code>#[inline]</code> is already part of <code>CodegenFnAttrs</code> instead of using the attribute directly</p>



<a name="277695427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277695427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277695427">(Apr 04 2022 at 08:07)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="248906">@cjgillot</span> this seems similar to things you've done with incremental</p>



<a name="277775809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277775809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277775809">(Apr 04 2022 at 18:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/131828-t-compiler/topic/don.27t.20encode.20attrs/near/277687822">said</a>:</p>
<blockquote>
<p>i think that ideally I would like to simply not encode attributes at all, relying us to store relevant attributes in some other way which is specialized for each attribute. e.g.  <code>#[inline]</code> is already part of <code>CodegenFnAttrs</code> instead of using the attribute directly</p>
</blockquote>
<p>That would be great!  Do you have an idea of the list of queries/fields that would be required?</p>



<a name="277776771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277776771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277776771">(Apr 04 2022 at 18:44)</a>:</h4>
<p>FWIW rustdoc already does something like this for doc-comments (for performance reasons)</p>



<a name="277778447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277778447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277778447">(Apr 04 2022 at 18:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/131828-t-compiler/topic/don't.20encode.20attrs/near/277687822">said</a>:</p>
<blockquote>
<p>i think that ideally I would like to simply not encode attributes at all, relying us to store relevant attributes in some other way which is specialized for each attribute.</p>
</blockquote>
<p>That sounds far less error-prone, too, since it means that hopefully there's only one spot <em>parsing</em> the attribute, and everything else uses the purpose-made model to consume it.</p>



<a name="277947327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277947327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277947327">(Apr 05 2022 at 21:40)</a>:</h4>
<p>Could this idea be recast as: Identify the most common attributes and choose a more specialized encoding for them, rather than striving to remove all attributes ?</p>



<a name="277947397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277947397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277947397">(Apr 05 2022 at 21:41)</a>:</h4>
<p>(this recasting has the advantage that it can be done incrementally. It has the drawback that it does not admit the "less error-prone" property that <span class="user-mention" data-user-id="125270">@scottmcm</span> described.)</p>



<a name="277984925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277984925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277984925">(Apr 06 2022 at 07:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/131828-t-compiler/topic/don't.20encode.20attrs/near/277947327">said</a>:</p>
<blockquote>
<p>Could this idea be recast as: Identify the most common attributes and choose a more specialized encoding for them, rather than striving to remove all attributes ?</p>
</blockquote>
<p>I think we probably have to start with that anyways, considering that changing all attributes at once is probably not feasible</p>



<a name="277986389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277986389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277986389">(Apr 06 2022 at 07:48)</a>:</h4>
<p>opened an mcp <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/try.20to.20not.20rely.20on.20attributes.20from.20extern.E2.80.A6.20compiler-team.23505">https://rust-lang.zulipchat.com/#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/try.20to.20not.20rely.20on.20attributes.20from.20extern.E2.80.A6.20compiler-team.23505</a></p>



<a name="277988976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277988976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277988976">(Apr 06 2022 at 08:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="126944">Joe ST</span> has marked this topic as resolved.</p>



<a name="277988982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277988982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277988982">(Apr 06 2022 at 08:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="126944">Joe ST</span> has marked this topic as unresolved.</p>



<a name="277993841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277993841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277993841">(Apr 06 2022 at 08:55)</a>:</h4>
<blockquote>
<p>if the previous step continues to have a positive - or at least neutral - perf impact and does not negatively impact the maintainability of rustc, stop encoding attributes entirely and remove the item_attrs query</p>
</blockquote>
<p>How should tool attributes be handled?</p>



<a name="277995176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277995176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277995176">(Apr 06 2022 at 09:07)</a>:</h4>
<p>maybe <code>query tool_attrs(def_id: DefId, prefix: Symbol) -&gt; Attributes&lt;'tcx&gt;</code> or something like that <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="277995201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277995201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277995201">(Apr 06 2022 at 09:07)</a>:</h4>
<p>so clippy would use <code>tcx.tool_attrs(item, sym::clippy)</code></p>



<a name="277996473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/don%27t%20encode%20attrs/near/277996473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/don&#x27;t.20encode.20attrs.html#277996473">(Apr 06 2022 at 09:19)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>