<html>
<head><meta charset="utf-8"><title>Disabling cross-crate inlining · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html">Disabling cross-crate inlining</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263629868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263629868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263629868">(Dec 03 2021 at 19:57)</a>:</h4>
<p>Is it possible to somehow get rustc to just not do cross-crate inlining with <code>#[inline]</code>? I.e. telling it to still keep the attribute but not  include the MIR of the functions in the rlib? <br>
My CUDA codegen essentially does LTO every time, so it does not need rustc duplicating inline functions, and it may yield a good speedup to tell rustc to not do that, but because this is a core thing rustc does, im not quite sure if it is possible to get rustc to just not do that. Maybe it could be querified if it isn't already, then the codegen overrides the query?</p>



<a name="263630267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263630267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263630267">(Dec 03 2021 at 20:00)</a>:</h4>
<p>I guess i could kind of hack it together in the codegen by overriding such function definitions when defining mono items, but that seems like a hack, it would be better if rustc didnt try to do it in the first place</p>



<a name="263653086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263653086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263653086">(Dec 03 2021 at 21:06)</a>:</h4>
<p>AFAIK there isn't any way to do this without modifying rustc itself.</p>



<a name="263653267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263653267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263653267">(Dec 03 2021 at 21:08)</a>:</h4>
<p>Disabling <code>#[inline]</code> may actually slow down compilation as it requires a lot of functions to be unconditionally codegened, even if they aren't used in the first place. This includes 128bit int ops, which may crash nvvm.</p>



<a name="263654115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263654115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263654115">(Dec 03 2021 at 21:16)</a>:</h4>
<p>How would that cause them to be unconditionally codegenned? They are already codegenned into LLVM IR</p>



<a name="263654150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263654150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263654150">(Dec 03 2021 at 21:16)</a>:</h4>
<p>i fixed 128bit things so that should not be a problem</p>



<a name="263654587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263654587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263654587">(Dec 03 2021 at 21:21)</a>:</h4>
<p>Oh you mean they arent codegenned since something upstream will codegen it if it needs it</p>



<a name="263692432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263692432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263692432">(Dec 04 2021 at 08:23)</a>:</h4>
<blockquote>
<p>Oh you mean they arent codegenned since something upstream will codegen it if it needs it</p>
</blockquote>
<p>Exactly!</p>



<a name="263723942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263723942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263723942">(Dec 04 2021 at 18:24)</a>:</h4>
<p>Im not quite convinced that thats as big of an issue here, because probably the slowest part is linking together every bitcode file from the rlibs. I am not codegenning to PTX for every crate (this is what CUDA C++ does). The codegen part is actually really fast because its only codegenning functions that are actually used by kernels</p>



<a name="263723964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263723964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263723964">(Dec 04 2021 at 18:25)</a>:</h4>
<p>This also makes me think it might be worth it to just not optimize before libnvvm, because libnvvm does its own opts, and if i optimized on the final small llvm module itd be much faster</p>



<a name="263724400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263724400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263724400">(Dec 04 2021 at 18:35)</a>:</h4>
<p>I should really time my codegen...</p>



<a name="263731547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263731547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263731547">(Dec 04 2021 at 21:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining/near/263723964">said</a>:</p>
<blockquote>
<p>This also makes me think it might be worth it to just not optimize before libnvvm, because libnvvm does its own opts, and if i optimized on the final small llvm module itd be much faster</p>
</blockquote>
<p>It might still be helpful to <code>-O1</code> optimize (or a similar custom pass list, maybe with the commonality between <code>-O1</code> and <code>-Os</code>), just to clean up a bunch of the extra noise in the IR.  I wouldn't be surprised if a couple of cheap passes could get the volume of IR down by half, and thus be a net win for the serialization over to nvvm.</p>



<a name="263732348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263732348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263732348">(Dec 04 2021 at 21:26)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> I already run global DCE before giving it to libnvvm, so the IR shrinks to like -95%</p>



<a name="263732372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Disabling%20cross-crate%20inlining/near/263732372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Disabling.20cross-crate.20inlining.html#263732372">(Dec 04 2021 at 21:27)</a>:</h4>
<p>anything not directly or indirectly used by a kernel is eliminated</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>