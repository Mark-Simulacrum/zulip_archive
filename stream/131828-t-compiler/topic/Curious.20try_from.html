<html>
<head><meta charset="utf-8"><title>Curious try_from · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html">Curious try_from</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268333163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268333163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268333163">(Jan 18 2022 at 01:45)</a>:</h4>
<p>I just saw <a href="https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler/rustc_middle/src/mir/interpret/mod.rs#L281">this line of code</a> in the compiler:</p>
<div class="codehilite"><pre><span></span><code>        let idx = usize::try_from(decoder.read_u32()).unwrap();
</code></pre></div>



<a name="268333183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268333183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268333183">(Jan 18 2022 at 01:45)</a>:</h4>
<p>Is there a good reason why it isn't just this?</p>
<div class="codehilite"><pre><span></span><code>        let idx = decoder.read_u32() as usize;
</code></pre></div>



<a name="268333226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268333226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268333226">(Jan 18 2022 at 01:46)</a>:</h4>
<p>Is usize always 32 or 64 bits?</p>



<a name="268334249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268334249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268334249">(Jan 18 2022 at 02:00)</a>:</h4>
<p>I think we (std) "support" a 16-bit usize, though I doubt you can compile rustc for that target. I suspect it's written that way to avoid as-casting which is generally less obviously correct.</p>



<a name="268336687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268336687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268336687">(Jan 18 2022 at 02:44)</a>:</h4>
<p>super-ultra safe mode(TM)</p>



<a name="268358076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268358076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268358076">(Jan 18 2022 at 08:34)</a>:</h4>
<p>When usize is at least 32bits the panic in the try_from version should be trivially optimized away I think.</p>



<a name="268416178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268416178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268416178">(Jan 18 2022 at 16:18)</a>:</h4>
<p>If there are a lot of these, it might be worth an infallible <code>trait AsUsize</code></p>



<a name="268416424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268416424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268416424">(Jan 18 2022 at 16:19)</a>:</h4>
<p>See also <a href="https://github.com/rust-lang/rust/issues/49415">https://github.com/rust-lang/rust/issues/49415</a></p>



<a name="268417258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268417258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268417258">(Jan 18 2022 at 16:24)</a>:</h4>
<p>Outside of the compiler, I've also wanted something like this that would straight-up fail at compilation time. The <code>as</code> casts never fail and the <code>TryFrom</code> fails at run time.</p>



<a name="268417355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268417355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268417355">(Jan 18 2022 at 16:25)</a>:</h4>
<p>But it's the same root thing: "This application never cares to run on a 16-bit platform".</p>



<a name="268417757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268417757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268417757">(Jan 18 2022 at 16:28)</a>:</h4>
<p>to be fair, <code>librustc_driver</code> alone is a thousand times too big for a 16-bit address space</p>



<a name="268417966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268417966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268417966">(Jan 18 2022 at 16:29)</a>:</h4>
<p>Absolutely, which is why I think it's fair to be up front and encode that in the source. It would also clear up those lines a bit.</p>



<a name="268418108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418108">(Jan 18 2022 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Curious.20try_from/near/268358076">said</a>:</p>
<blockquote>
<p>When usize is at least 32bits the panic in the try_from version should be trivially optimized away I think.</p>
</blockquote>



<a name="268418134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418134">(Jan 18 2022 at 16:30)</a>:</h4>
<p>That has also been my experience.</p>



<a name="268418186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418186">(Jan 18 2022 at 16:30)</a>:</h4>
<p>I mean that the source code would be cleaned up, visually.</p>



<a name="268418200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418200">(Jan 18 2022 at 16:31)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/51564">#51564</a> made it so there isn't even any branch in the impl, so just the <code>unwrap</code> has to be optimized out</p>



<a name="268418309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418309">(Jan 18 2022 at 16:31)</a>:</h4>
<p><code>try_from_unbounded</code></p>



<a name="268418453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418453">(Jan 18 2022 at 16:32)</a>:</h4>
<p>To be clear, I'm agreeing with the idea of the <code>AsUsize</code> trait, and just not implementing it for 16-bit platforms (replacing with an error that specifically states "hey we don't do that here")</p>



<a name="268418609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418609">(Jan 18 2022 at 16:33)</a>:</h4>
<p>sure. it also doesn't have to start in <code>core</code> -- the compiler can add that trait somewhere to experiment on its own</p>



<a name="268418809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268418809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268418809">(Jan 18 2022 at 16:34)</a>:</h4>
<p>Agreed. I'm only mentioning my the outside-the-compiler usage and Simon Sapin's usage as "you are not alone in wanting this".</p>



<a name="268427271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268427271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268427271">(Jan 18 2022 at 17:28)</a>:</h4>
<p>This is definitely a widely wished for thing.  It's (related to) the mythical "portability lint": &lt;<a href="http://rust-lang.github.io/rfcs/1868-portability-lint.html">http://rust-lang.github.io/rfcs/1868-portability-lint.html</a>&gt;</p>



<a name="268442234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268442234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268442234">(Jan 18 2022 at 19:20)</a>:</h4>
<p>I get 10 matches for <code>/usize::try_from.*unwrap/</code> in the compiler, and 1,111 matches for <code>/as usize/</code>. The latter is probably too general for this comparison, but still.</p>



<a name="268914485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Curious%20try_from/near/268914485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Curious.20try_from.html#268914485">(Jan 21 2022 at 22:54)</a>:</h4>
<p>The original unwrap in question should probably be documented that it fails on 16 bit platforms however, unless it’s guaranteed that the code cannot run there</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>