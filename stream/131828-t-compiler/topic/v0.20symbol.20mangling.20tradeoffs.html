<html>
<head><meta charset="utf-8"><title>v0 symbol mangling tradeoffs · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html">v0 symbol mangling tradeoffs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259844437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259844437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259844437">(Nov 01 2021 at 09:54)</a>:</h4>
<p>In <span class="user-mention" data-user-id="116107">@davidtwco</span>'s PR for making v0 symbol mangling the default, <span class="user-mention" data-user-id="116122">@simulacrum</span> <a href="https://github.com/rust-lang/rust/pull/89917#issuecomment-945888574">asked for a list of trade offs</a> that switching to v0 mangling implies. Maybe we can compile the list here so that <span class="user-mention" data-user-id="116107">@davidtwco</span> can update the PR text before merging.</p>
<p>The main trade offs that I am aware of are: </p>
<ul>
<li>
<p>Symbol names become longer because they contain more information. It would be good to have some numbers on how this affects actual artifact sizes. Maybe we want to wait until perf.rlo can provide these numbers which hopefully should happen this month (assuming @rylev and I find the time to work on it). It would also be good to list the scenarios in which this makes a difference. Not all artifacts will contain (all) symbol names.</p>
</li>
<li>
<p>Compile times increase. The <a href="https://perf.rust-lang.org/compare.html?start=af9b508e1d6c83a8f0e6f5c0b2b75598aa37ed27&amp;end=d6cf5a91f80fba50e1594bddce52ee42486468c6">perf run in the PR</a> shows regressions up to 9.45%. However, on closer inspection it looks like only very linker-heavy workloads are affected that much (e.g. webrender-wrench which spends 85.13% in the linker). Generating the symbol names in the FE seems to be too much of a problem. My assumption is that compile time regressions are mostly due to the linker (and sometimes LLVM) having to shovel more data around due to the longer names. It would be great to have some numbers for different linkers here. And to group regressions by scenario (i.e. check builds vs rlib builds vs builds that actually invoke a linker).</p>
</li>
</ul>
<p>Are there other trade offs?</p>



<a name="259844859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259844859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259844859">(Nov 01 2021 at 09:59)</a>:</h4>
<p>Ideally this is a disadvantage that would be temporary and we've mostly dealt with, but support for symbols in third party tools is going to be worse with the new scheme than the old scheme.</p>



<a name="259845305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259845305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259845305">(Nov 01 2021 at 10:02)</a>:</h4>
<p>Yes, no harm in listing that as a trade off too.</p>



<a name="259845545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259845545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259845545">(Nov 01 2021 at 10:05)</a>:</h4>
<p>As a side note: Now that v0 is the default for the compiler code itself, it gets a lot more testing than it used, especially around new features that may require extensions to the scheme. I think the pressure to stabilize is lowered a bit by that so that there will be more time for external tools to add support.</p>



<a name="259845778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259845778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259845778">(Nov 01 2021 at 10:07)</a>:</h4>
<p>Also, making v0 the default on nightly as <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <a href="https://github.com/rust-lang/rust/pull/89917#issuecomment-951009529">suggested</a> will make the new scheme more visible to end-users -- which should also be good for external tooling adoption.</p>



<a name="259846051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259846051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259846051">(Nov 01 2021 at 10:10)</a>:</h4>
<p>So ... Those all sound like downsides. What are the benefits of v0 mangling?</p>



<a name="259846143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259846143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259846143">(Nov 01 2021 at 10:10)</a>:</h4>
<p>Oh never mind, they're listed in the PR description</p>



<a name="259848690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259848690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259848690">(Nov 01 2021 at 10:40)</a>:</h4>
<p>The legacy mangling scheme was at some point changed to include full substitutions for <code>drop_in_place</code>, but since legacy mangling has no back references, those symbols can be orders of magnitude longer in legacy scheme than in v0 scheme.</p>



<a name="259859931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259859931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259859931">(Nov 01 2021 at 12:56)</a>:</h4>
<p><span class="user-mention" data-user-id="352985">@tm</span>, interesting. So that would be an advantage of the v0 scheme, right?</p>



<a name="259866053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259866053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259866053">(Nov 01 2021 at 13:55)</a>:</h4>
<p>@mw yeah, back references doing their job. I noticed this when doing some basic comparison legacy vs v0 and observing that length of maximum length symbol decreased in v0, which seemed surprising initially. But I don't have any numbers offhand.</p>



<a name="259875603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259875603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259875603">(Nov 01 2021 at 15:10)</a>:</h4>
<p>Unlikely, but is it possible that <a href="https://github.com/rust-lang/rust/pull/89836">https://github.com/rust-lang/rust/pull/89836</a> might have some bearing on this discussion?</p>



<a name="259882147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/259882147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#259882147">(Nov 01 2021 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="316352">@pierwill</span> Not directly related, I'd say</p>



<a name="260777151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260777151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260777151">(Nov 09 2021 at 10:14)</a>:</h4>
<p>Another advantage of the new mangling scheme: The backtraces we get from the production compiler contain generic arguments now. Eg. <a href="https://github.com/rust-lang/rust/issues/90715">https://github.com/rust-lang/rust/issues/90715</a> </p>
<p>(Although the default demangler setting should probably not print the full crate disambiguator)</p>



<a name="260777228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260777228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260777228">(Nov 09 2021 at 10:15)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> was just mentioning in another thread that the generic parameters make the compiler much easier to profile :)</p>



<a name="260777671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260777671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260777671">(Nov 09 2021 at 10:20)</a>:</h4>
<p>I didn't say it was easier! There's more information, which is typically good, but it's <em>very</em> verbose, which makes the profiles harder to skim. I'm not yet decided on whether it's an improvement from a profiling POV.</p>



<a name="260778532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260778532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260778532">(Nov 09 2021 at 10:29)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span>  Note that the syntax of mangled names is defined by the RFC but how a demangler displays them is not defined. It can do whatever is most useful in a given context. It just has more information to work with.</p>



<a name="260778749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260778749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260778749">(Nov 09 2021 at 10:31)</a>:</h4>
<p>(see <a href="https://github.com/rust-lang/rfcs/blob/master/text/2603-rust-symbol-name-mangling-v0.md#appendix-a---suggested-demangling">https://github.com/rust-lang/rfcs/blob/master/text/2603-rust-symbol-name-mangling-v0.md#appendix-a---suggested-demangling</a>)</p>



<a name="260785652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260785652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260785652">(Nov 09 2021 at 11:42)</a>:</h4>
<p>Having generics makes it more useful when search through the the functions in a profile with hotspot in my experience</p>



<a name="260785803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/v0%20symbol%20mangling%20tradeoffs/near/260785803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/v0.20symbol.20mangling.20tradeoffs.html#260785803">(Nov 09 2021 at 11:43)</a>:</h4>
<p>although being able to remove them to aggregate monomorphizations would be nice.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>