<html>
<head><meta charset="utf-8"><title>llvm-dwp is not recommended · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html">llvm-dwp is not recommended</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="226567575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226567575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226567575">(Feb 16 2021 at 19:58)</a>:</h4>
<p>So the author of the llvm-dwp tool had <a href="https://reviews.llvm.org/D96678#2566422">this</a> to say about llvm-dwp. We currently ship rust-llvm-dwp as a tool that we use when <code>-Csplit-debuginfo=packed</code> is supplied by the user. I think given this we should switch away? cc <span class="user-mention" data-user-id="116015">@Alex Crichton</span> <span class="user-mention" data-user-id="116107">@davidtwco</span> thoughts?</p>



<a name="226567925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226567925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226567925">(Feb 16 2021 at 20:00)</a>:</h4>
<p>I don't know much about dwp (I did the macos stuff mostly, not the split-dwarf stuff), but I would agree that if the author of dwp says we shouldn't use it then we shouldn't use it</p>



<a name="226568417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226568417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226568417">(Feb 16 2021 at 20:03)</a>:</h4>
<p>I used it because binutils dwp didn’t support DWARF 5. As I understand it, LLVM might output DWARF 5 for some targets so that seemed like something we needed. I’m certainly open to alternatives but I don’t know what else would be suitable at the moment.</p>



<a name="226568584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226568584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226568584">(Feb 16 2021 at 20:04)</a>:</h4>
<p>The author of that comment mentions that they have patches for DWARF 5 and other dwp implementations so that might be an option in future.</p>



<a name="226577997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226577997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226577997">(Feb 16 2021 at 21:19)</a>:</h4>
<p>I wonder how hard would something like this be to implement in terms of gimli.</p>



<a name="226619596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226619596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226619596">(Feb 17 2021 at 06:50)</a>:</h4>
<p>I would love a gimli implementation. That would mean one less LLVM tool coupled with rustc outside of cg_llvm. Thereby making it easier to not use LLVM at all.</p>



<a name="226650830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226650830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Darley Barreto <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226650830">(Feb 17 2021 at 12:47)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> do you know what versions of Dwarf gimli supports? I havent found any specification on the repo.</p>



<a name="226651025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/226651025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#226651025">(Feb 17 2021 at 12:49)</a>:</h4>
<p>As far as I know it mostly supports DWARFv5. There may be some things missing though.</p>



<a name="263564004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263564004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263564004">(Dec 03 2021 at 11:09)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> <span class="user-mention" data-user-id="123586">@nagisa</span> I've implemented a dwp tool in Rust using gimli/object, you can find it here: <a href="https://github.com/davidtwco/thorin/">https://github.com/davidtwco/thorin/</a> </p>
<p>My goal is to use it to solve <a href="https://github.com/rust-lang/rust/issues/81024">#81024</a> (<a href="https://github.com/rust-lang/rust/issues/89819">#89819</a> didn't pan out as a fix, and we wanted to switch away from llvm-dwp for reasons documented in this thread anyway). I've added support for it to read dwarf objects from an archive input file, so we should be able to put our dependency dwarf objects into rlibs and give those to the new dwp tool. </p>
<p>I've tested it against llvm-dwp's test suite, but haven't added a test suite or CI to the project itself yet, it fails a bunch of llvm's tests but primarily because of differences in diagnostic output, it's basically on-par functionality-wise. I'd appreciate some reviews, issues or pull requests if you spot anywhere I've done something stupid and it could be better (my starting point was a passing familiarity with what dwarf was, so there's bound to be something).</p>



<a name="263564178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263564178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263564178">(Dec 03 2021 at 11:11)</a>:</h4>
<p>Nice!</p>



<a name="263564205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263564205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263564205">(Dec 03 2021 at 11:11)</a>:</h4>
<p>How does the performance compare?</p>



<a name="263564385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263564385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263564385">(Dec 03 2021 at 11:12)</a>:</h4>
<p>No idea.</p>



<a name="263564440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263564440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263564440">(Dec 03 2021 at 11:13)</a>:</h4>
<p>Haven't checked, I tried not to do anything I thought would be slow, so hopefully it's decent - certainly it's something we can improve if it isn't.</p>



<a name="263588386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263588386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263588386">(Dec 03 2021 at 14:39)</a>:</h4>
<p>The naming on this crate is excellent! <span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span></p>



<a name="263606794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263606794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263606794">(Dec 03 2021 at 16:53)</a>:</h4>
<p>I've updated <a href="https://github.com/rust-lang/rust/issues/89819">#89819</a> with the changes required so that rustc uses <code>thorin</code> - there's still changes we ought to make before actually landing a patch that switches to <code>thorin</code>, but I don't think any of those would prevent us going through whatever processes are required for the team to decide whether to accept the new dependency or not - is it just an MCP for that?</p>



<a name="263607909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/263607909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#263607909">(Dec 03 2021 at 17:01)</a>:</h4>
<p>According to <a href="https://rust-lang.github.io/compiler-team/procedures/crates/">our docs</a>, it's just an FCP when we get to merging, so I'll think about that later.</p>



<a name="265451289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/265451289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#265451289">(Dec 19 2021 at 00:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended/near/263607909">said</a>:</p>
<blockquote>
<p>According to <a href="https://rust-lang.github.io/compiler-team/procedures/crates/">our docs</a>, it's just an FCP when we get to merging, so I'll think about that later.</p>
</blockquote>
<p>This pull request and the new dependency have been reviewed and are ready to land now - based on a reading of that policy, it’s just pending decisions about if/where we move the repository (<code>rust-lang</code> is suggested in the policy, but <code>gimli-rs</code> has been suggested on the thread - of course that would depend on the <code>gimli-rs</code> folks, depends what we wanted); adding the compiler team to the <a href="http://crates.io">crates.io</a> package as owners; and an FCP for the new dependency in general.</p>



<a name="265452322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/265452322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#265452322">(Dec 19 2021 at 00:39)</a>:</h4>
<p>FWIW, the primary goal of rust-lang is "not an individual account", at least IMO -- mostly to avoid being blocked on either forking or a ~single person, at an infra level.</p>



<a name="265452329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/265452329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#265452329">(Dec 19 2021 at 00:39)</a>:</h4>
<p>(So either gimli or rust-lang are probably ok, though I'd probably express a slight preference for the latter, at least to start; it may make sense to invite gimli-rs folks if they'd be interested in maintaining it though).</p>



<a name="265452396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/265452396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#265452396">(Dec 19 2021 at 00:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> it probably also makes sense to consult <a href="https://rust-lang.github.io/rfcs/3119-rust-crate-ownership.html">https://rust-lang.github.io/rfcs/3119-rust-crate-ownership.html</a> for the <a href="http://crates.io">crates.io</a> publication and such, as a likely more recent doc than that of the compiler team</p>



<a name="265487619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/265487619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#265487619">(Dec 19 2021 at 16:24)</a>:</h4>
<p>thanks to <span class="user-mention silent" data-user-id="116122">simulacrum</span>’s help, <code>thorin</code> is now at <a href="https://github.com/rust-lang/thorin">https://github.com/rust-lang/thorin</a> and the compiler team are owners on <a href="http://crates.io">crates.io</a>.</p>



<a name="265487813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/llvm-dwp%20is%20not%20recommended/near/265487813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/llvm-dwp.20is.20not.20recommended.html#265487813">(Dec 19 2021 at 16:28)</a>:</h4>
<p>We can either r=nagisa on <a href="https://github.com/rust-lang/rust/issues/89819">#89819</a> or do an fcp before landing it (that should be on a pull request updating our out-of-tree list in the compiler-team repository, according to those documents, but that list hasn’t been updated since it was created by the looks of things).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>