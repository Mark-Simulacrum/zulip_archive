<html>
<head><meta charset="utf-8"><title>Drop flags and dead store elimination · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html">Drop flags and dead store elimination</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261886263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886263">(Nov 18 2021 at 04:52)</a>:</h4>
<p>Here's the existing <a href="https://github.com/rust-lang/rust/blob/98a5a98f44130b5bafb4f2b2f3126fb22a5a3228/compiler/rustc_mir_dataflow/src/impls/liveness.rs">liveness pass</a>. I'd be careful if trying to adapt its def/use categorization for your use case. It's only used for the generator transform.</p>



<a name="261886270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886270">(Nov 18 2021 at 04:52)</a>:</h4>
<p>There's a separate live variable analysis in the borrow-checker that uses a lazy paradigm, if you get bored and run out of MIR passes to read.</p>



<a name="261886367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886367">(Nov 18 2021 at 04:54)</a>:</h4>
<p>I think I can start by only considering assignments of boolean constants, if that makes it easier, because drop flags seem to be the common case here</p>



<a name="261886484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886484">(Nov 18 2021 at 04:56)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span> any suggestions where in the MIR phases this should go?</p>



<a name="261886495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886495">(Nov 18 2021 at 04:57)</a>:</h4>
<p>with the other optimizations</p>



<a name="261886516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886516">(Nov 18 2021 at 04:57)</a>:</h4>
<p>Or do you mean where within the optimizations? I don't know. As long as it runs after drop elaboration it should do what you want.</p>



<a name="261886781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886781">(Nov 18 2021 at 05:01)</a>:</h4>
<p>In here somewhere? <a href="https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_mir_transform/src/lib.rs#L502-L527">https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_mir_transform/src/lib.rs#L502-L527</a></p>



<a name="261886854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261886854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261886854">(Nov 18 2021 at 05:03)</a>:</h4>
<p>thanks</p>



<a name="261887440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261887440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261887440">(Nov 18 2021 at 05:16)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span> <code>MutVisitor</code> runs forwards. If I want to run backwards I guess I'll need to hand-code the traversal myself? Not that it'll be hard, I just want to check I'm not missing something obvious</p>



<a name="261930199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261930199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261930199">(Nov 18 2021 at 13:59)</a>:</h4>
<p>A question from someone who doesn't fully understand the architecture of the compiler in this area: does it make more sense to add dead store elimination for drop flags, or does it make more sense to attempt to eliminate drop flags in common cases?</p>



<a name="261930258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261930258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261930258">(Nov 18 2021 at 13:59)</a>:</h4>
<p>It seems like, rather than generating drop flags everywhere and then eliminating the redundant ones, we could try to avoid generating drop flags in the first place for common patterns where we currently do generate them.</p>



<a name="261930463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261930463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261930463">(Nov 18 2021 at 14:00)</a>:</h4>
<p>we already only create drop flags if they're needed, it's just that some assignments are not needed.</p>



<a name="261931192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261931192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261931192">(Nov 18 2021 at 14:07)</a>:</h4>
<p>Oh, interesting. What's the heuristic for when a drop flag is needed?</p>



<a name="261931232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261931232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261931232">(Nov 18 2021 at 14:07)</a>:</h4>
<p>(Vs when we assign to it.)</p>



<a name="261931819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261931819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261931819">(Nov 18 2021 at 14:12)</a>:</h4>
<p>A drop flag is needed when there's at least one drop of the variable/place in the MIR where the variables/place is not statically known to be initialized or not initialized. for example.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nb">String</span> <span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">drop</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// x is maybe initialized here</span>
</code></pre></div>



<a name="261931914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261931914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261931914">(Nov 18 2021 at 14:12)</a>:</h4>
<p>Once we have a drop flag though it's assigned/unnassigned whenever the variable is initialized/moved from</p>



<a name="261935059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261935059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261935059">(Nov 18 2021 at 14:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination/near/261886484">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> any suggestions where in the MIR phases this should go?</p>
</blockquote>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> You might want to try running after <code>RemoveNoopLandingPasses</code> <a href="https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_mir_transform/src/lib.rs#L520">https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_mir_transform/src/lib.rs#L520</a>. That would potentially surface more places where the drop flags are dead.</p>



<a name="261937412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261937412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261937412">(Nov 18 2021 at 14:53)</a>:</h4>
<p>I was thinking about this a while ago and it looked to me like a lot of the unnecessary drop flags we hand off to LLVM come from MIR that has generic types in play and at MIR opt time we don't know if they have effectful drops or not. We should certainly do better with these cases you highlighted but I wonder if eliminating redundant drop flags at codegen time (when we know all the concrete types) and then finding a way to share the optimization results across types would show improvements as well.</p>



<a name="261948329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261948329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261948329">(Nov 18 2021 at 16:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> Thanks for the great explanation!</p>



<a name="261948383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261948383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261948383">(Nov 18 2021 at 16:06)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> That sounds like a potentially substantial win with relatively little effort required.</p>



<a name="261986847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261986847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261986847">(Nov 18 2021 at 20:35)</a>:</h4>
<p>Stepping back for a second... the reason I started asking about this is that yesterday when I starting looking at MIR, this was literally the very first basic block in the small-but-real program I'm looking at:</p>
<div class="codehilite"><pre><span></span><code>    bb0: {
        _28 = const false;               // scope 0 at src/main.rs:89:11: 89:20
        _28 = const true;                // scope 0 at src/main.rs:89:11: 89:20
        _1 = do_main() -&gt; bb1;           // scope 0 at src/main.rs:89:11: 89:20
    }
</code></pre></div>
<p>Like, duh.<br>
I can appreciate that a pre-monomorphization optimization pass to remove these dead stores may not be optimal, particularly one that's only intra-basic-block. But it should also be pretty easy, and it'll teach me more about MIR, and I'm curious to see how big the effect is. So I might go ahead and implement it anyway. If it's a measurable win then we can maybe argue about whether there's a better approach. Seem reasonable?</p>



<a name="261988967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261988967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261988967">(Nov 18 2021 at 20:52)</a>:</h4>
<p>That seems like a great plan. :)</p>



<a name="261996626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261996626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261996626">(Nov 18 2021 at 21:54)</a>:</h4>
<p>FWIW, it seems these drop flags are added in the <code>ElaborateDrops</code> pass, viz: <code>ElaborateDrops.before.mir</code>:</p>
<div class="codehilite"><pre><span></span><code>    bb0: {
        StorageLive(_1);                 // scope 0 at src/main.rs:89:11: 89:20
        _1 = do_main() -&gt; bb1;           // scope 0 at src/main.rs:89:11: 89:20
    }
</code></pre></div>
<p>Becomes <code>ElaborateDrops.after.mir</code>:</p>
<div class="codehilite"><pre><span></span><code>    bb0: {
        _36 = const false;               // scope 0 at src/main.rs:89:11: 89:20
        _37 = const false;               // scope 0 at src/main.rs:89:11: 89:20
        StorageLive(_1);                 // scope 0 at src/main.rs:89:11: 89:20
        _36 = const true;                // scope 0 at src/main.rs:89:11: 89:20
        _37 = const true;                // scope 0 at src/main.rs:89:11: 89:20
        _1 = do_main() -&gt; bb1;           // scope 0 at src/main.rs:89:11: 89:20
    }
</code></pre></div>
<p>The <code>SimplifyLocals</code> pass later somehow combines <code>_36</code> and <code>_37</code> into a single <code>_28</code></p>



<a name="261999011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999011">(Nov 18 2021 at 22:12)</a>:</h4>
<blockquote>
<p>The <code>SimplifyLocals</code> pass later somehow combines <code>_36</code> and <code>_37</code> into a single <code>_28</code></p>
</blockquote>
<p>SimplifyLocals doesn't do anything that clever ;-). It only removes unused locals. The indexes will change, so diff tends to be confusing.</p>



<a name="261999262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999262">(Nov 18 2021 at 22:14)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> what’s the input program like? I’m assuming its something where one field of a struct is moved on one branch of control flow but not another?</p>



<a name="261999496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999496">(Nov 18 2021 at 22:15)</a>:</h4>
<div class="codehilite"><pre><span></span><code>fn main() -&gt; io::Result&lt;()&gt; {
    // Ignore broken pipes, which occur for `counts input.txt | head -11`.
    match do_main() {
        Ok(_) =&gt; Ok(()),
        Err(ref err) if err.kind() == io::ErrorKind::BrokenPipe =&gt; Ok(()),
        Err(err) =&gt; {
            eprintln!(&quot;counts: {}&quot;, err);
            std::process::exit(1);
        }
    }
}
</code></pre></div>



<a name="261999594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999594">(Nov 18 2021 at 22:16)</a>:</h4>
<p>yep okay</p>



<a name="261999618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999618">(Nov 18 2021 at 22:16)</a>:</h4>
<p>In the past before we had <code>ElaborateDrops</code> pass we would introduce dynamic flags for every possible variable in codegen.</p>



<a name="261999671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999671">(Nov 18 2021 at 22:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> You're referring to the two <code>Err</code> cases?</p>



<a name="261999808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999808">(Nov 18 2021 at 22:18)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> yeah. The third branch moves <code>err</code>, the second does not. (I’m not actually sure how elaborate-drops represents the distinction between enum variants.)</p>



<a name="261999862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999862">(Nov 18 2021 at 22:18)</a>:</h4>
<p>Which is why it seems that <code>ElaborateDrops</code> actually makes the code worse, but it doesn't, as it obviated the worse thing we used to do in codegen.</p>



<a name="261999880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Drop%20flags%20and%20dead%20store%20elimination/near/261999880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination.html#261999880">(Nov 18 2021 at 22:18)</a>:</h4>
<p>(but I assume its something like “allocate a seperate variable for every field of every variant.”)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>