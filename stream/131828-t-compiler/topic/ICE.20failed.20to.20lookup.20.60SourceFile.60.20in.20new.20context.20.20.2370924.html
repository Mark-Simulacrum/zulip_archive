<html>
<head><meta charset="utf-8"><title>ICE failed to lookup `SourceFile` in new context  #70924 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html">ICE failed to lookup `SourceFile` in new context  #70924</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="199235707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235707">(May 30 2020 at 03:27)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="119009">@eddyb</span> and <span class="user-mention" data-user-id="116122">@simulacrum</span> , I finally put up that PR that I promised, over on "Track devirtualized filename"s <a href="https://github.com/rust-lang/rust/issues/72767">#72767</a></p>



<a name="199235757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235757">(May 30 2020 at 03:28)</a>:</h4>
<p>Its probably not the best long-term fix; at least, I know <span class="user-mention" data-user-id="119009">@eddyb</span> was ... well, I don't know if "laughably unhappy" is the right term, but it did seem like they were both laughing and unhappy when they saw the problem</p>



<a name="199235762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235762">(May 30 2020 at 03:29)</a>:</h4>
<p>but anyway, even though it may not be the best long term fix, it <em>is</em> one that I would be okay backporting to beta</p>



<a name="199235764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235764">(May 30 2020 at 03:29)</a>:</h4>
<p>(which was to be done before, when <span class="user-mention" data-user-id="116122">@simulacrum</span> ? before Monday?)</p>



<a name="199235879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235879">(May 30 2020 at 03:32)</a>:</h4>
<p>I think so, yeah</p>



<a name="199235889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235889">(May 30 2020 at 03:33)</a>:</h4>
<p>Well, we'll include it in the beta to stable promotion probably instead of separately landing it</p>



<a name="199235891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235891">(May 30 2020 at 03:33)</a>:</h4>
<p>If you tag it as accepted that'd be great</p>



<a name="199235978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199235978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199235978">(May 30 2020 at 03:35)</a>:</h4>
<p>I'm guessing long term we should maybe just store the raw text of the files in metadata? I can't imagine it being a huge size increase or anything, especially if we run compression of some kind... Not entirely sure why we don't do that today.</p>



<a name="199236093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236093">(May 30 2020 at 03:39)</a>:</h4>
<p>well we still want paths too, no?</p>



<a name="199236094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236094">(May 30 2020 at 03:39)</a>:</h4>
<p>for local development</p>



<a name="199236095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236095">(May 30 2020 at 03:39)</a>:</h4>
<p>I guess it depends on what metadata you're talking about</p>



<a name="199236156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236156">(May 30 2020 at 03:40)</a>:</h4>
<p>I know <em>I</em> have been curious about storing raw text in our incremental build artifacts, but that is more because I would like to just spit out, as part of an incremental ICE: "here is the diff from the build we were using when we made the current set of artifacts"</p>



<a name="199236239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236239">(May 30 2020 at 03:43)</a>:</h4>
<p>Also, I don't have a regression test as part of the PR, because I'm not sure how to make one</p>



<a name="199236316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236316">(May 30 2020 at 03:45)</a>:</h4>
<p>my local replication relies on either adding/removing the <code>rust-src</code> component in rustup , or actually renaming the <code>rustlib/src/rust</code> subdirectory in my build directory. Either of these options don't seem to lend themselves to a test in our infrastructure, no?</p>



<a name="199236332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236332">(May 30 2020 at 03:45)</a>:</h4>
<p>(I will transcribe the last two comments to the github PR, because it seems like a generally useful comment. and maybe someone will have a bright idea about how to test this scenario.)</p>



<a name="199236384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236384">(May 30 2020 at 03:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> If I tag it as beta accepted, will you still wait for someone (hopefully <span class="user-mention" data-user-id="119009">@eddyb</span> ) to r+ it before you put it into the beta-to-stable promotion?</p>



<a name="199236396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236396">(May 30 2020 at 03:47)</a>:</h4>
<p>Yeah, sure</p>



<a name="199236399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236399">(May 30 2020 at 03:47)</a>:</h4>
<p>(leave a comment please to that effect)</p>



<a name="199236401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236401">(May 30 2020 at 03:47)</a>:</h4>
<p>(I don't want to inadvertantly bypass the review process just because I'm willing to take the heat for a unilateral beta approval)</p>



<a name="199236402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236402">(May 30 2020 at 03:47)</a>:</h4>
<p>Okay I will do so</p>



<a name="199236453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236453">(May 30 2020 at 03:49)</a>:</h4>
<p>A run-make test could mess with the sysroot (or a copy of it) I guess, but it would probably be fairly error prone</p>



<a name="199236455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236455">(May 30 2020 at 03:49)</a>:</h4>
<p>hmm</p>



<a name="199236518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236518">(May 30 2020 at 03:50)</a>:</h4>
<p>Also quite slow I imagine, especially on Windows? Not sure.. generally I don't think we have a good story for incremental tests</p>



<a name="199236522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236522">(May 30 2020 at 03:50)</a>:</h4>
<p>I at least always struggle to read them quickly</p>



<a name="199236526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236526">(May 30 2020 at 03:50)</a>:</h4>
<p>I mean we <em>do</em> have a nice infrastructure with the revision system</p>



<a name="199236530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236530">(May 30 2020 at 03:51)</a>:</h4>
<p>depending on your point of view</p>



<a name="199236532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236532">(May 30 2020 at 03:51)</a>:</h4>
<p>it at least makes authoring certain cases easy</p>



<a name="199236535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236535">(May 30 2020 at 03:51)</a>:</h4>
<p>but i'll admit that may not be so great for people trying to understand them</p>



<a name="199236540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236540">(May 30 2020 at 03:51)</a>:</h4>
<p>Yes, I usually need to spend a bit of time refreshing myself on what is going on before I can interpret revision tests</p>



<a name="199236581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/ICE%20failed%20to%20lookup%20%60SourceFile%60%20in%20new%20context%20%20%2370924/near/199236581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/ICE.20failed.20to.20lookup.20.60SourceFile.60.20in.20new.20context.20.20.2370924.html#199236581">(May 30 2020 at 03:52)</a>:</h4>
<p>Maybe that's unavoidable :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>