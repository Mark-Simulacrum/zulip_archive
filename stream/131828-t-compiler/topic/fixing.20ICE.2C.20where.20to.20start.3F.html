<html>
<head><meta charset="utf-8"><title>fixing ICE, where to start? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html">fixing ICE, where to start?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262475371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262475371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262475371">(Nov 23 2021 at 16:00)</a>:</h4>
<p>Heyyy :)</p>
<p>I wanted to try and fix this ICE <a href="https://github.com/rust-lang/rust/issues/88536">https://github.com/rust-lang/rust/issues/88536</a> but I'm not sure where to start. I looked up the function that's panicking but I'm not sure what to do next :p</p>
<p>Any hints?</p>
<p>Thank you</p>
<p>EDIT: from what I saw <code>typeck_results</code> cannot be called outside "bodies" (I suppose function/constant bodies). From what I saw this only happens if you create an alias type with a "complex" enough constant expression. So I assume that for some constant expressions inside type aliases, calling <code>typeck_results</code> is being considered outside even though it is being called inside the constant expr or smth.</p>



<a name="262476319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262476319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262476319">(Nov 23 2021 at 16:07)</a>:</h4>
<p>this is the last line in the backtrace before the panic machinery:</p>
<div class="codehilite"><pre><span></span><code>  17:     0x7f88ee5317bb - &lt;rustc_save_analysis::dump_visitor::DumpVisitor as rustc_hir::intravisit::Visitor&gt;::visit_expr::hf0cde4eb365a62ee
</code></pre></div>
<p>So I suspect you need to change the <code>visit_expr</code> implementation to check whether the expression is part of a constant/static or a function body.</p>



<a name="262476732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262476732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262476732">(Nov 23 2021 at 16:10)</a>:</h4>
<p>save-analysis doesn't have a ton of maintainers so I'm not sure what the proper behavior is when it's in a constant. <span class="user-mention" data-user-id="153740">@Igor Matuszewski</span> might have suggestions, they maintain RLS which uses save-analysis.</p>



<a name="262476836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262476836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262476836">(Nov 23 2021 at 16:11)</a>:</h4>
<p>Yeah, I was about to say: it's probably not defined what the behavior is for consts</p>



<a name="262476978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262476978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262476978">(Nov 23 2021 at 16:12)</a>:</h4>
<p>What I find weird is that using the same const expr outside aliases is perfectly fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">u8</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="k">u8</span><span class="o">..=</span><span class="mh">0x45</span><span class="p">).</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// This causes the ICE</span>
<span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="nc">Foo</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="k">u8</span><span class="o">..=</span><span class="mh">0x45</span><span class="p">).</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="p">;</span><span class="w"> </span><span class="c1">// This does not</span>
</code></pre></div>



<a name="262477111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262477111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262477111">(Nov 23 2021 at 16:13)</a>:</h4>
<p>are you sure the expression is actually being visited in that constant?</p>



<a name="262477203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262477203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262477203">(Nov 23 2021 at 16:14)</a>:</h4>
<p>(there's probably some logging in that module which you could enable with <code>RUSTC_LOG</code>)</p>



<a name="262477792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262477792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262477792">(Nov 23 2021 at 16:18)</a>:</h4>
<p>Not sure if this is going to answer your question or not. But I added a <code>eprintln!</code> at the top of <code>get_expr_data</code> which is the function calling <code>typeck_results</code> and I can see the <code>(0u8..=0x45).end()</code> expr being printed</p>



<a name="262477846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262477846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262477846">(Nov 23 2021 at 16:19)</a>:</h4>
<p>in both cases</p>



<a name="262477861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262477861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262477861">(Nov 23 2021 at 16:19)</a>:</h4>
<p>but the alias one is the only that panics</p>



<a name="262478042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262478042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262478042">(Nov 23 2021 at 16:21)</a>:</h4>
<p>oh interesting, that does seem a little odd</p>



<a name="262478322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/fixing%20ICE%2C%20where%20to%20start%3F/near/262478322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christian Poveda <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/fixing.20ICE.2C.20where.20to.20start.3F.html#262478322">(Nov 23 2021 at 16:23)</a>:</h4>
<p>actually that expr is the only one being printed</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>