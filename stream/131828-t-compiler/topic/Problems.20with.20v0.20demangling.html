<html>
<head><meta charset="utf-8"><title>Problems with v0 demangling · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html">Problems with v0 demangling</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260617544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260617544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260617544">(Nov 08 2021 at 05:47)</a>:</h4>
<p>If I'm reading the <a href="https://rust-lang.github.io/rfcs/2603-rust-symbol-name-mangling-v0.html#syntax-of-mangled-names">v0 spec</a> right, '.' is not valid</p>



<a name="260617603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260617603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260617603">(Nov 08 2021 at 05:48)</a>:</h4>
<p>But <code>rustfilt</code> handles it, giving this:</p>
<div class="codehilite"><pre><span></span><code>core::ptr::drop_in_place::&lt;rustc_borrowck::region_infer::RegionInferenceContext&gt;
</code></pre></div>



<a name="260617629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260617629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260617629">(Nov 08 2021 at 05:49)</a>:</h4>
<p>So I'm wondering if the Rust compiler is also being naughty, by generating some invalid symbols</p>



<a name="260618206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260618206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260618206">(Nov 08 2021 at 06:02)</a>:</h4>
<p>If so, my guess is that the symbols are mangled and then the <code>.llvm.&lt;numbers&gt;</code> bit is added afterwards. And this was ok with legacy encoding, but is invalid with v0 encoding.</p>



<a name="260619495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260619495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260619495">(Nov 08 2021 at 06:34)</a>:</h4>
<p>Yes, those are added afterwards by LLVM. For example, when importing/promoting static function for ThinLTO to avoid symbol conflicts.</p>



<a name="260619507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260619507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260619507">(Nov 08 2021 at 06:34)</a>:</h4>
<p>v0 spec should probably include a vendor dot suffix like the one in Itanium</p>



<a name="260630829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260630829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260630829">(Nov 08 2021 at 09:14)</a>:</h4>
<p>That's an interesting find about the <code>.llvm.&lt;numbers&gt;</code> suffix. Annoying too <code>:)</code></p>



<a name="260631335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260631335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260631335">(Nov 08 2021 at 09:19)</a>:</h4>
<p>Here is a link to the relevant Itanium mangling section: <a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#mangling-structure">https://itanium-cxx-abi.github.io/cxx-abi/abi.html#mangling-structure</a><br>
I wonder if just adding something like that  to the grammar would be sufficient to consider the problem solved. I'd certainly prefer if LLVM and other backends wouldn't just append random stuff to symbol names.</p>



<a name="260649827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260649827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260649827">(Nov 08 2021 at 12:27)</a>:</h4>
<p>I posted about both these bugs on the turn it on for everyone by default PR</p>



<a name="260650014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260650014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260650014">(Nov 08 2021 at 12:28)</a>:</h4>
<p>But yeah, I think v0 is still enough of a win with these bugs (I rebuilt valgrind locally but gave up on linux perf which is broken on at least LTS Ubuntu)</p>



<a name="260719907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260719907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260719907">(Nov 08 2021 at 21:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> What's the PR number for that? I was going to mention the issues in <a href="https://github.com/rust-lang/rust/issues/60705">https://github.com/rust-lang/rust/issues/60705</a> today once I'd worked through the Valgrind one a bit more.</p>



<a name="260719948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260719948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260719948">(Nov 08 2021 at 21:15)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@njn</span> <a href="https://github.com/rust-lang/rust/pull/89917#issuecomment-961035863">https://github.com/rust-lang/rust/pull/89917#issuecomment-961035863</a> (PR and my specific comment)</p>



<a name="260720509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260720509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260720509">(Nov 08 2021 at 21:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Github says you wrote that comment 4 days ago. Is that correct? Did I just rediscover yesterday stuff you'd already learned?</p>



<a name="260720541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260720541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260720541">(Nov 08 2021 at 21:20)</a>:</h4>
<p>yes</p>



<a name="260720554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260720554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260720554">(Nov 08 2021 at 21:20)</a>:</h4>
<p>(to both)</p>



<a name="260720626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260720626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260720626">(Nov 08 2021 at 21:21)</a>:</h4>
<p>Goodness. Anyway, I'm happy to take point on getting Valgrind fixed.</p>



<a name="260720636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260720636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260720636">(Nov 08 2021 at 21:21)</a>:</h4>
<p>sounds great!</p>



<a name="260736716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260736716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260736716">(Nov 09 2021 at 00:00)</a>:</h4>
<p>Here's one v0 entry demangled by the fixed-up Valgrind that is surprising to me:</p>
<div class="codehilite"><pre><span></span><code>&lt;rustc_infer::infer::InferCtxt&gt;::rollback_to
</code></pre></div>



<a name="260736736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260736736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260736736">(Nov 09 2021 at 00:00)</a>:</h4>
<p>Why are the angle brackets present?</p>



<a name="260736859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260736859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260736859">(Nov 09 2021 at 00:01)</a>:</h4>
<p>I see this pattern a lot, and I don't see any <code>aa::bb::cc::dd</code> forms, they're all <code>&lt;aa::bb::cc&gt;::dd</code></p>



<a name="260736862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260736862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260736862">(Nov 09 2021 at 00:01)</a>:</h4>
<p>yeah, that's an inherent method <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/infer/struct.InferCtxt.html#method.rollback_to">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/infer/struct.InferCtxt.html#method.rollback_to</a></p>



<a name="260736872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260736872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260736872">(Nov 09 2021 at 00:01)</a>:</h4>
<p>I wonder if <code>#[instrument]</code> confuses it?</p>



<a name="260737070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737070">(Nov 09 2021 at 00:03)</a>:</h4>
<p>Oh, <code>rustc_expand::mbe::macro_parser::parse_tt</code> is more normal</p>



<a name="260737095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737095">(Nov 09 2021 at 00:03)</a>:</h4>
<p>More weird ones:<br>
<code>&lt;rustc_middle::ty::context::CtxtInterners&gt;::intern_ty</code></p>



<a name="260737152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737152">(Nov 09 2021 at 00:04)</a>:</h4>
<p><code>&lt;rustc_parse::parser::Parser&gt;::bump</code></p>



<a name="260737177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737177">(Nov 09 2021 at 00:04)</a>:</h4>
<p><code>rustc_middle::ty::relate::super_relate_tys::&lt;rustc_infer::infer::equate::Equate&gt;</code>, wtf</p>



<a name="260737200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737200">(Nov 09 2021 at 00:04)</a>:</h4>
<p><code>&lt;rustc_middle::ty::context::TyCtxt&gt;::_intern_substs</code></p>



<a name="260737224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737224">(Nov 09 2021 at 00:05)</a>:</h4>
<p><code>&lt;rustc_trait_selection::traits::select::SelectionContext&gt;::match_where_clause_trait_ref</code></p>



<a name="260737234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737234">(Nov 09 2021 at 00:05)</a>:</h4>
<p>The weird ones are definitely more common than the non-weird ones</p>



<a name="260737240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260737240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260737240">(Nov 09 2021 at 00:05)</a>:</h4>
<p>My guess is these are treated as genetic over Self, so they get encoded with that as the one type parameter (so in angle brackets)</p>



<a name="260743346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260743346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260743346">(Nov 09 2021 at 01:27)</a>:</h4>
<p>I'm using a fun hack for writing the Valgrind test. I don't want to add a Rust dependency to the Valgrind test suite, so I'm using mangled Rust symbols as C function names, like this:</p>
<div class="codehilite"><pre><span></span><code>// A legacy symbol that demangles to: core::str::lossy::Utf8Lossy::from_bytes
int _ZN4core3str5lossy9Utf8Lossy10from_bytes17heb1677c8cb728b0bE(int* p)
{
   return _RNvNtNtCsaqSe1lZGvEL_12rustc_expand3mbe12macro_parser8parse_tt(p);
}
</code></pre></div>



<a name="260743405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260743405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260743405">(Nov 09 2021 at 01:28)</a>:</h4>
<p>When Valgrind prints out the error message for the test, the C function names get demangled into Rust function names</p>



<a name="260746902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260746902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260746902">(Nov 09 2021 at 02:27)</a>:</h4>
<p><a href="https://bugs.kde.org/show_bug.cgi?id=445184">https://bugs.kde.org/show_bug.cgi?id=445184</a> is the Valgrind fix.</p>



<a name="260752871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260752871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260752871">(Nov 09 2021 at 04:34)</a>:</h4>
<p>In &gt;1 year old profiles I have names like this:</p>
<div class="codehilite"><pre><span></span><code>rustc_data_structures::obligation_forest::ObligationForest&lt;O&gt;::process_obligations
</code></pre></div>



<a name="260752886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260752886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260752886">(Nov 09 2021 at 04:35)</a>:</h4>
<p>In new profiles I have names like this:</p>
<div class="codehilite"><pre><span></span><code>&lt;rustc_data_structures::obligation_forest::ObligationForest&lt;rustc_trait_selection::traits::fulfill::PendingPredicateObligation&gt;&gt;::process_obligations::&lt;rustc_trait_selection::traits::fulfill::FulfillProcessor, rustc_data_structures::obligation_forest::Outcome&lt;rustc_trait_selection::traits::fulfill::PendingPredicateObligation, rustc_infer::traits::FulfillmentErrorCode&gt;&gt;
</code></pre></div>



<a name="260752900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260752900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260752900">(Nov 09 2021 at 04:35)</a>:</h4>
<p>A big difference</p>



<a name="260778278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/260778278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#260778278">(Nov 09 2021 at 10:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling/near/260736859">said</a>:</p>
<blockquote>
<p>I see this pattern a lot, and I don't see any <code>aa::bb::cc::dd</code> forms, they're all <code>&lt;aa::bb::cc&gt;::dd</code></p>
</blockquote>
<p>That's what the <a href="https://doc.rust-lang.org/reference/paths.html#canonical-paths">canonical path</a> of a method in an inherent <code>impl</code> looks like. <code>aa::bb::cc</code> is the path of the Self type and <code>dd</code> is the method name.</p>



<a name="261091099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261091099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261091099">(Nov 11 2021 at 04:07)</a>:</h4>
<p>This one puzzles me:</p>
<div class="codehilite"><pre><span></span><code>[gulf:~] echo _RINvNtCs19hrgr3zeqR_5alloc7raw_vec11finish_growNtNtB4_5alloc6GlobalECsgI90OQiJWEs_11rustc_infer | rustfilt
alloc::raw_vec::finish_grow::&lt;alloc::alloc::Global&gt;
</code></pre></div>



<a name="261091103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261091103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261091103">(Nov 11 2021 at 04:07)</a>:</h4>
<p>What happened to the <code>rustc_infer</code> at the end of the mangled symbol?</p>



<a name="261093089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261093089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261093089">(Nov 11 2021 at 04:48)</a>:</h4>
<p>It's the crate that instantiates the symbol</p>



<a name="261095960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261095960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261095960">(Nov 11 2021 at 05:43)</a>:</h4>
<p>Why include info in the mangled name that doesn't show up when you demangle it?</p>



<a name="261095976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261095976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261095976">(Nov 11 2021 at 05:43)</a>:</h4>
<p>Another thing I just discovered about v0 demangling: it seems to have destroyed the usefulness of <code>cargo-llvm-lines</code>.</p>



<a name="261096025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096025">(Nov 11 2021 at 05:44)</a>:</h4>
<p>I used to get lines like this:</p>
<div class="codehilite"><pre><span></span><code>    9871 (2.6%)   152 (1.6%)  core::option::Option&lt;T&gt;::map
</code></pre></div>



<a name="261096037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096037">(Nov 11 2021 at 05:44)</a>:</h4>
<p>Which means there were 152 distinct instantiations of <code>Option::map</code>, totalling 9871 lines of LLVM IR.</p>



<a name="261096088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096088">(Nov 11 2021 at 05:45)</a>:</h4>
<p>Now I get lines like this:</p>
<div class="codehilite"><pre><span></span><code>      52 (0.0%)     1 (0.0%)  &lt;core[1888027d9e9c7885]::option::Option&lt;&amp;(core[1888027d9e9c7885]::option::Option&lt;&amp;str&gt;, &amp;str)&gt;&gt;::map::&lt;&amp;str, &amp;mut &lt;clap[445153585277c4b]::app::parser::Parser&gt;::add_defaults::{closure#142}&gt;
</code></pre></div>
<p>Every instantiation shows up on a different line, so you can't easily tell how many they are and how many lines they add up to <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="261096181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096181">(Nov 11 2021 at 05:47)</a>:</h4>
<p>Plus it's much less readable in general. What is <code>core[1888027d9e9c7885]</code>? What is the stuff that comes after <code>map</code>?</p>



<a name="261096248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096248">(Nov 11 2021 at 05:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling/near/261095960">said</a>:</p>
<blockquote>
<p>Why include info in the mangled name that doesn't show up when you demangle it?</p>
</blockquote>
<p>This ensures that symbols instantiated in two crates wouldn't clash.</p>



<a name="261096260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096260">(Nov 11 2021 at 05:48)</a>:</h4>
<p>Sounds like <code>cargo-llvm-lines</code> needs to be updated</p>



<a name="261096295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096295">(Nov 11 2021 at 05:50)</a>:</h4>
<p>The number is the hash of the crate so symbol names are unique and won't clash when two crates share the same name.</p>



<a name="261096491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261096491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261096491">(Nov 11 2021 at 05:53)</a>:</h4>
<p><span class="user-mention" data-user-id="119235">@David Tolnay</span> This information may be of interest ^^ (about cargo-llvm-lines and v0 demangling)</p>



<a name="261106546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261106546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261106546">(Nov 11 2021 at 08:42)</a>:</h4>
<p>It sounds to me like we'll want to add ways to configure how <a href="https://github.com/rust-lang/rustc-demangle">rustc-demangle</a> renders names (e.g. erase generic arguments, leave off crate disambiguators, etc) so as to make it easy for consumers of the library to choose a rendering that makes the most sense for the given use case.</p>



<a name="261106864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261106864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261106864">(Nov 11 2021 at 08:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling/near/261096181">said</a>:</p>
<blockquote>
<p>What is <code>core[1888027d9e9c7885]</code></p>
</blockquote>
<p><code>core</code> is the crate name and <code>[1888027d9e9c7885]</code> is the crate-disambiguator that makes sure that symbols from different versions of the same crate don't clash. For mangled names the disambiguator is needed in order to prevent linker errors but demangled names it should usually be fine to just not display it.</p>



<a name="261107373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Problems%20with%20v0%20demangling/near/261107373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling.html#261107373">(Nov 11 2021 at 08:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Problems.20with.20v0.20demangling/near/261096181">said</a>:</p>
<blockquote>
<p>What is the stuff that comes after <code>map</code>?</p>
</blockquote>
<p>Those are the generic parameters of <a href="https://doc.rust-lang.org/std/option/enum.Option.html#method.map">Option::map()</a>: <code>&amp;str</code> for <code>U</code> and <code>&amp;mut &lt;clap[445153585277c4b]::app::parser::Parser&gt;::add_defaults::{closure#142}</code> for the closure <code>F</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>