<html>
<head><meta charset="utf-8"><title>#88272 and `HybridBitSet::{subtract, intersect}` · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html">#88272 and `HybridBitSet::{subtract, intersect}`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250532946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2388272%20and%20%60HybridBitSet%3A%3A%7Bsubtract%2C%20intersect%7D%60/near/250532946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html#250532946">(Aug 24 2021 at 19:06)</a>:</h4>
<p>I was assigned to review <a href="https://github.com/rust-lang/rust/issues/88272">#88272</a>. The author, who is working on a <a href="https://github.com/willcrichton/flowistry">program slicing analysis for Rust</a>, wanted to make a private method of <code>SparseBitMatrix</code> into a public one. That method shouldn't really be part of the public API, especially if the intent is to <em>remove</em> bits from the matrix, but the alternative is implementing intersection, etc. for <code>SparseBitSet</code>, which is kind of a pain. The fact that we don't have those methods on <code>HybridBitSet</code> leads us to use dense <code>BitSet</code>s in more places than necessary, but it's probably not too big a deal.</p>
<p>What would y'all (compiler contributors/team members) recommend if you were the reviewer? I'm tempted to just let them make the method public with a warning in the documentation, but IDK.</p>



<a name="250533625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2388272%20and%20%60HybridBitSet%3A%3A%7Bsubtract%2C%20intersect%7D%60/near/250533625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html#250533625">(Aug 24 2021 at 19:11)</a>:</h4>
<p>I feel like the immediate step of making it public seems OK, presuming it's not possible to break any (even implicit) invariants of the type -- not necessarily memory safety to be clear.</p>



<a name="250533731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2388272%20and%20%60HybridBitSet%3A%3A%7Bsubtract%2C%20intersect%7D%60/near/250533731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html#250533731">(Aug 24 2021 at 19:12)</a>:</h4>
<p>But expanding the API for the various bitsets to be more complete seems like a good idea in general.</p>



<a name="250534698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2388272%20and%20%60HybridBitSet%3A%3A%7Bsubtract%2C%20intersect%7D%60/near/250534698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html#250534698">(Aug 24 2021 at 19:19)</a>:</h4>
<p>As far as I can tell it's perfectly safe for users to manipulate the <code>HybridBitSet</code> directly once space for it has been reserved. Empty ones are fine, for example. The only real downside is that <code>ensure_row</code> makes the matrix more "dense" than necessary if you're just clearing a row, but this is pretty minor.</p>
<p>I'll take their temperature re: <code>HybridBitSet</code> extensions. It seemed like they mostly just wanted to get their project off the ground. There's a few helper traits (e.g. <code>SubtractFromBitSet</code>) that would have to get changed as well, so it's not a trivial undertaking.</p>



<a name="250535243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2388272%20and%20%60HybridBitSet%3A%3A%7Bsubtract%2C%20intersect%7D%60/near/250535243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html#250535243">(Aug 24 2021 at 19:23)</a>:</h4>
<p>Yeah. Generally I definitely think exposing the method seems "just useful" because predicting full API surface is always hard, and ad-hoc extensions are often convenient, and generally it seems like it doesn't cost much.</p>



<a name="250536003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2388272%20and%20%60HybridBitSet%3A%3A%7Bsubtract%2C%20intersect%7D%60/near/250536003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2388272.20and.20.60HybridBitSet.3A.3A.7Bsubtract.2C.20intersect.7D.60.html#250536003">(Aug 24 2021 at 19:29)</a>:</h4>
<p>Thanks Mark.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>