<html>
<head><meta charset="utf-8"><title>#53821  Report const eval error inside the query · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html">#53821  Report const eval error inside the query</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="134316202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316202">(Sep 20 2018 at 15:22)</a>:</h4>
<p>lets continue talking here (continuation of <a href="#narrow/stream/131828-t-compiler/subject/weekly.20meeting.202018-09-20/near/134315542" title="#narrow/stream/131828-t-compiler/subject/weekly.20meeting.202018-09-20/near/134315542">this conversation</a>)</p>



<a name="134316221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316221">(Sep 20 2018 at 15:22)</a>:</h4>
<p>cc <span class="user-group-mention" data-user-group-id="492">@T-compiler</span> and <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="134316252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316252">(Sep 20 2018 at 15:23)</a>:</h4>
<p>So my questions are:</p>
<p>1. What code, besides macros breaks here;<br>
2. I suppose we don’t want to change the strategy employed by this PR much (i.e. our ultimate goal is to error everywhere anyway)?</p>



<a name="134316331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316331">(Sep 20 2018 at 15:24)</a>:</h4>
<p>3. How does this interact with constevaluated code that is really a runtime code?</p>



<a name="134316362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316362">(Sep 20 2018 at 15:24)</a>:</h4>
<p>that is, there was an issue before about <code>println!("{}", 1/0)</code> not failing if put in a <code>main</code> (for good reasons IIRC). Would this PR landing change this behaviour in any way?</p>



<a name="134316395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316395">(Sep 20 2018 at 15:25)</a>:</h4>
<p>in the current state the PR shouldnt introduce any new errors</p>



<a name="134316465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316465">(Sep 20 2018 at 15:26)</a>:</h4>
<p>but it also does not lint any more when an unused type contains a constant that errors when executed</p>



<a name="134316489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316489">(Sep 20 2018 at 15:26)</a>:</h4>
<p>unused type, as in <code>type A = [42; BAD_CONST]</code>?</p>



<a name="134316494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316494">(Sep 20 2018 at 15:26)</a>:</h4>
<p>where <code>A</code> is not used?</p>



<a name="134316507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316507">(Sep 20 2018 at 15:27)</a>:</h4>
<p>previously, both the lint and WF (or whatever evaluates constants when a type gets actually used) used the same query, but the query just returned "well there was an error" and it was up to the caller to figure out what to do with that error</p>



<a name="134316523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316523">(Sep 20 2018 at 15:27)</a>:</h4>
<p>so the lint made it a warning, WF made it a hard error</p>



<a name="134316533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316533">(Sep 20 2018 at 15:27)</a>:</h4>
<p>now the query already reports the error, so we cannot make that distinction any more</p>



<a name="134316537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316537">(Sep 20 2018 at 15:27)</a>:</h4>
<p>we also stop reporting the same error 3 times because nobody was sure if some other part didnt already report the error...</p>



<a name="134316540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316540">(Sep 20 2018 at 15:27)</a>:</h4>
<p>okay but I have an upcoming PR that could make it an unconditional error</p>



<a name="134316544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316544">(Sep 20 2018 at 15:27)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> yes</p>



<a name="134316595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316595">(Sep 20 2018 at 15:28)</a>:</h4>
<p>because it's more uniform IMO to do so (if we can get away with it)</p>



<a name="134316597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316597">(Sep 20 2018 at 15:28)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> sure fine for me, but that doesnt block this PR, right?</p>



<a name="134316605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316605">(Sep 20 2018 at 15:28)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> ah, now I understand what’s the point of discussion finally :P</p>



<a name="134316637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316637">(Sep 20 2018 at 15:28)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> well, if we <em>don't</em> make an error, we can't land the PR</p>



<a name="134316644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316644">(Sep 20 2018 at 15:29)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> as for your point 3, it shouldnt. that would be <code>const_prop</code>, which opportunistically evaluates runtime code with the miri engine. it's a horrible mess, but it also doesnt use the const_eval query and hence shouldnt be affected by this change</p>



<a name="134316653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316653">(Sep 20 2018 at 15:29)</a>:</h4>
<p>because we can't tell the query to warn instead anymore</p>



<a name="134316654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316654">(Sep 20 2018 at 15:29)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> why not?</p>



<a name="134316658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316658">(Sep 20 2018 at 15:29)</a>:</h4>
<p>so?</p>



<a name="134316659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316659">(Sep 20 2018 at 15:29)</a>:</h4>
<p>what warning is fairly recent</p>



<a name="134316668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316668">(Sep 20 2018 at 15:29)</a>:</h4>
<p>seems better to me to lose it again than the mess we had previously</p>



<a name="134316671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316671">(Sep 20 2018 at 15:29)</a>:</h4>
<p>I mean, we're moving towards a self-consistent model of <code>type</code> aliases</p>



<a name="134316673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316673">(Sep 20 2018 at 15:29)</a>:</h4>
<p>and then figure out something better</p>



<a name="134316685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316685">(Sep 20 2018 at 15:29)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> the query never warned for unused types</p>



<a name="134316734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316734">(Sep 20 2018 at 15:30)</a>:</h4>
<p>instead we have a really strange lint, which all it does is walk the crate and fire all <code>const_eval</code> queries</p>



<a name="134316765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316765">(Sep 20 2018 at 15:30)</a>:</h4>
<p>so if we warn about <code>type Foo = Vec&lt;str&gt;;</code>, we should warn about <code>type Foo = [u8; 0 - 1];</code> too</p>



<a name="134316794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316794">(Sep 20 2018 at 15:31)</a>:</h4>
<blockquote>
<p>so if we warn about <code>type Foo = Vec&lt;str&gt;;</code>, we should warn about <code>type Foo = [u8; 0 - 1];</code> too</p>
</blockquote>
<p>sure but that would likely fall out of whatever it is you are doing, and not out of the UnusedErrConstant lint or whatever oli called it</p>



<a name="134316806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316806">(Sep 20 2018 at 15:31)</a>:</h4>
<p>yes but what I'd be doing would necessarily query <code>const_eval</code></p>



<a name="134316812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316812">(Sep 20 2018 at 15:31)</a>:</h4>
<p>yes</p>



<a name="134316815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316815">(Sep 20 2018 at 15:31)</a>:</h4>
<p>and I can't force it now to warn, it would error</p>



<a name="134316819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316819">(Sep 20 2018 at 15:31)</a>:</h4>
<p>yes</p>



<a name="134316831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316831">(Sep 20 2018 at 15:31)</a>:</h4>
<p>#MakeConstEvalReturnResult&lt;T, E&gt;</p>



<a name="134316877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316877">(Sep 20 2018 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> it does, before the PR</p>



<a name="134316878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316878">(Sep 20 2018 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> thats what we have currently, it is horrible</p>



<a name="134316889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316889">(Sep 20 2018 at 15:32)</a>:</h4>
<p>so the only regression in the const query error PR is that it stops warning for bad consts in unused types</p>



<a name="134316900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316900">(Sep 20 2018 at 15:32)</a>:</h4>
<p>it requires reifying <em>a ridiculous amount</em> of state in the error</p>



<a name="134316903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316903">(Sep 20 2018 at 15:32)</a>:</h4>
<p>which IIRC isnt even on stable yet</p>



<a name="134316907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316907">(Sep 20 2018 at 15:32)</a>:</h4>
<p>yeah, I realised after I sent it. Failing in const_eval directly, however, precludes using const_eval for other uses.</p>



<a name="134316913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316913">(Sep 20 2018 at 15:33)</a>:</h4>
<p>for now, that seems like an acceptable regression to me for the overall cleanup</p>



<a name="134316942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316942">(Sep 20 2018 at 15:33)</a>:</h4>
<p>can we just add two distinct variants of const eval query, one that reports the errors from within itself, and the other that returns Option/Result?</p>



<a name="134316994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316994">(Sep 20 2018 at 15:34)</a>:</h4>
<p>that would be 4, we already have <code>const_eval</code> and <code>const_eval_raw</code></p>



<a name="134316999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134316999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134316999">(Sep 20 2018 at 15:34)</a>:</h4>
<p>Similar to the const_eval_raw/const_eval split, yeah.</p>



<a name="134317001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317001">(Sep 20 2018 at 15:34)</a>:</h4>
<p>where <code>const_eval</code> does the actual work of computing a const</p>



<a name="134317004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317004">(Sep 20 2018 at 15:34)</a>:</h4>
<p>and <code>const_eval_raw</code> tests the value at the given type</p>



<a name="134317008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317008">(Sep 20 2018 at 15:34)</a>:</h4>
<p>I dont know why that cant happen in one query</p>



<a name="134317011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317011">(Sep 20 2018 at 15:34)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@Oli</span> said sth with cycles</p>



<a name="134317033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317033">(Sep 20 2018 at 15:35)</a>:</h4>
<p>making a "test" query would work for eddyb’s use-cases I think?</p>



<a name="134317040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317040">(Sep 20 2018 at 15:35)</a>:</h4>
<p>it could also be an argument to the query</p>



<a name="134317041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317041">(Sep 20 2018 at 15:35)</a>:</h4>
<p>like, the type stuff should not depend on an actual const value at all, just whether it has errors or not.</p>



<a name="134317043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317043">(Sep 20 2018 at 15:35)</a>:</h4>
<p>but then we have to be careful about caching</p>



<a name="134317074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317074">(Sep 20 2018 at 15:36)</a>:</h4>
<p>well I guess its isomorphic to two queries</p>



<a name="134317092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317092">(Sep 20 2018 at 15:36)</a>:</h4>
<p>so we have to be careful either way^^</p>



<a name="134317113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317113">(Sep 20 2018 at 15:36)</a>:</h4>
<p>All that being said, I think I’d be fine with a temporary regression here.</p>



<a name="134317128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317128">(Sep 20 2018 at 15:37)</a>:</h4>
<p>/me shrugs</p>



<a name="134317149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134317149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134317149">(Sep 20 2018 at 15:37)</a>:</h4>
<p>/me has a feeling that one way or the other a query split between "compute" and "test" will one way or the other get exposed to other parts of the compiler.</p>



<a name="134326436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326436">(Sep 20 2018 at 18:13)</a>:</h4>
<p>ok so I read this stuff :)</p>



<a name="134326509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326509">(Sep 20 2018 at 18:14)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <span class="user-mention" data-user-id="120791">@RalfJ</span> is one of you evaluating whether we think we can get away with making this a hard error all the time?</p>
<p>It feels like "borderline bug territory" indeed. </p>
<p>That said, I don't know why we couldn't have an "inner query" that returns a Result and another query that makes it an error (which invokes the "inner query"). Most users would use the outer query.</p>



<a name="134326514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326514">(Sep 20 2018 at 18:14)</a>:</h4>
<p>I guess this is what <span class="user-mention" data-user-id="123586">@nagisa</span> was proposing?</p>



<a name="134326562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326562">(Sep 20 2018 at 18:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> my latest PR will be used to crater for type aliases, not just constants in them, but other monomorphic non-WF things</p>



<a name="134326576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326576">(Sep 20 2018 at 18:15)</a>:</h4>
<p>that PR currently makes things a warning, right?</p>



<a name="134326638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326638">(Sep 20 2018 at 18:16)</a>:</h4>
<p>(PS I'm having a hard time keeping "all the things" sorted it out here when it comes to your many PRs, but I'm sort of assuming you'll kick me when you feel like you've worked it out to a point where you need a review, and/or have a burning question?)</p>



<a name="134326646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326646">(Sep 20 2018 at 18:16)</a>:</h4>
<p>which reminds me that we should talk about errors in 2018 and how aggressive we think we can be</p>



<a name="134326651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326651">(Sep 20 2018 at 18:16)</a>:</h4>
<p>it makes <code>type Foo&lt;T&gt; = NeedsBounds&lt;T&gt;;</code> a warning but <code>type Bar = Vec&lt;str&gt;;</code> (or <code>type Baz = [u8; 0 - 1];</code>) a hard error</p>



<a name="134326652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326652">(Sep 20 2018 at 18:16)</a>:</h4>
<p>but not probably in this topic :)</p>



<a name="134326661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326661">(Sep 20 2018 at 18:16)</a>:</h4>
<p>having the miri engine error type in a query is a bit messy, but that's mostly me not wanting to update 15 manually derived traits each time that changes :P</p>



<a name="134326671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326671">(Sep 20 2018 at 18:17)</a>:</h4>
<blockquote>
<p>it makes <code>type Foo&lt;T&gt; = NeedsBounds&lt;T&gt;;</code> a warning but <code>type Bar = Vec&lt;str&gt;</code> a hard error</p>
</blockquote>
<p>what is the distinction between those? is it based on the use of a type parameter?</p>



<a name="134326679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326679">(Sep 20 2018 at 18:17)</a>:</h4>
<p>we do something similar for defaults</p>



<a name="134326685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326685">(Sep 20 2018 at 18:17)</a>:</h4>
<p>e.g., <code>struct Foo&lt;T = Vec&lt;str&gt;&gt;</code> is a hard error</p>



<a name="134326686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326686">(Sep 20 2018 at 18:17)</a>:</h4>
<p>yes, that's the entire point</p>



<a name="134326689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326689">(Sep 20 2018 at 18:17)</a>:</h4>
<p>ok, I see</p>



<a name="134326701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326701">(Sep 20 2018 at 18:17)</a>:</h4>
<p>I .. <em>think</em> we do that for defaults, anyway?</p>



<a name="134326706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326706">(Sep 20 2018 at 18:17)</a>:</h4>
<p>we went back and forth and wound up settling on something pretty conservative iirc</p>



<a name="134326715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326715">(Sep 20 2018 at 18:17)</a>:</h4>
<blockquote>
<p>having the miri engine error type in a query is a bit messy, but that's mostly me not wanting to update 15 manually derived traits each time that changes :P</p>
</blockquote>
<p>I see, I see</p>



<a name="134326771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134326771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134326771">(Sep 20 2018 at 18:18)</a>:</h4>
<p>so, there are two things:</p>
<ul>
<li>it's annoying for callers not to know whether an error has been reported (can be solved by moving it into the query)</li>
<li>it's annoying to communicate enough state for the other query to report the error</li>
</ul>



<a name="134670046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134670046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134670046">(Sep 26 2018 at 12:31)</a>:</h4>
<p>We don't want to pass state to the query, as that would duplicate errors and work (the latter can be worked around by having more queries as noted above). The entire point of the PR was to deduplicate errors and centralize error reporting in one location.</p>



<a name="134670257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2353821%20%20Report%20const%20eval%20error%20inside%20the%20query/near/134670257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2353821.20.20Report.20const.20eval.20error.20inside.20the.20query.html#134670257">(Sep 26 2018 at 12:34)</a>:</h4>
<p>We could add a query which returns a Diagnostic object in the err case, which is then reported by the main query. Type alias array lengths could then use the inner query to report the error as a future incompat lint</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>