<html>
<head><meta charset="utf-8"><title>rustc warn against repr rust transmutes · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html">rustc warn against repr rust transmutes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250581627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250581627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250581627">(Aug 25 2021 at 05:32)</a>:</h4>
<p>I was wondering, if transmuting between repr rust types is always ub (with some exceptions like option box), why does rustc not warn/error when there is a transmute call that does it?</p>



<a name="250585229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250585229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250585229">(Aug 25 2021 at 06:51)</a>:</h4>
<p>That's actually a very good question…I'd be interested in knowing the answer given that what you've said is generally true, with exceptions as noted.</p>



<a name="250586680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250586680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250586680">(Aug 25 2021 at 07:14)</a>:</h4>
<p>Here are some questions that make me always question if it's really UB or not. I don't think the answers are super clear-cut:</p>
<ol>
<li>Is it actually UB, or is it just unspecified? (I've gotten different responses at different points in rust's history)</li>
<li>If it is UB, is it lang UB, library UB, or something else?</li>
<li>If library UB, what about cases like <code>Vec&lt;T&gt;</code> =&gt; <code>[usize; 3]</code>. This is actually documented as the representation. (While padding is allowed, in a transmute, it would cause a compile error if any existed, which is different than UB)</li>
<li>If language UB, how does that work? It almost feels like this runs up against claims that Rust has no typed memory (aside from pointers, perhaps, which is a completely different concern).</li>
</ol>
<p>That said, a lint is probably not a bad idea.</p>



<a name="250586961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250586961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250586961">(Aug 25 2021 at 07:19)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> has argued in the past that transmutes aren't actually UB <em>if you use the right layout</em>. That is, the layout details are unstable and subject to change based on compiler settings etc., so programmers can't generally rely on them, but that doesn't mean they are UB in the abstract machine - there is actually some fixed offset at which fields can be found and so on, and if your program uses the right offsets then it isn't UB.</p>



<a name="250596975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250596975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250596975">(Aug 25 2021 at 09:25)</a>:</h4>
<p>I don't think that the lint should be taken as some godsend, just that it <em>might</em> be UB. So I suppose clippy would probably be the best place to start that?</p>



<a name="250638662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250638662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250638662">(Aug 25 2021 at 15:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes/near/250586961">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> has argued in the past that transmutes aren't actually UB <em>if you use the right layout</em>. That is, the layout details are unstable and subject to change based on compiler settings etc., so programmers can't generally rely on them, but that doesn't mean they are UB in the abstract machine - there is actually some fixed offset at which fields can be found and so on, and if your program uses the right offsets then it isn't UB.</p>
</blockquote>
<p>Yeah, this makes a lot of sense.</p>



<a name="250648420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250648420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250648420">(Aug 25 2021 at 17:03)</a>:</h4>
<p>isn't transmuting between repr rust types always unsound (unless it is a special case) because rustc is technically allowed to change the layout however it wants to and you cannot rely on those assumptions?</p>



<a name="250648492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250648492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250648492">(Aug 25 2021 at 17:04)</a>:</h4>
<p>two structs with the same fields are going to be the same in practice, but technically rustc is allowed to do whatever it wants so it could cause ub at any rustc release</p>



<a name="250648587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250648587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250648587">(Aug 25 2021 at 17:04)</a>:</h4>
<p>e.g. relying on <code>Option&lt;T&gt;</code> -&gt; <code>Option&lt;U&gt;</code> and rustc adding a niche for the former/latter in a new release</p>



<a name="250654465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250654465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250654465">(Aug 25 2021 at 17:44)</a>:</h4>
<p>Transmute to <code>Option&lt;u16&gt;</code> to <code>Option&lt;Wrapping&lt;u16&gt;&gt;</code> should always be sound, despite <code>Option</code> being a repr rust.</p>



<a name="250654705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250654705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250654705">(Aug 25 2021 at 17:46)</a>:</h4>
<p>That's not true. It is sound for the types that have defined representation when used in conjunction with option (which is <code>Option&lt;NonNull&lt;_&gt;&gt;</code>, <code>Option&lt;&amp;_&gt;</code>, <code>Option&lt;Box&lt;_&gt;&gt;</code> and perhaps some others I forget.</p>



<a name="250654739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250654739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250654739">(Aug 25 2021 at 17:46)</a>:</h4>
<p>but <code>Wrapping</code> is not one of those explicitly defined ones.</p>



<a name="250654815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250654815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250654815">(Aug 25 2021 at 17:47)</a>:</h4>
<p>I attempted to write down a lint for invalid transmutes in the past. It broke half of the ecosystem.</p>



<a name="250654944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250654944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250654944">(Aug 25 2021 at 17:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/51294">https://github.com/rust-lang/rust/pull/51294</a></p>



<a name="250655412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250655412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250655412">(Aug 25 2021 at 17:51)</a>:</h4>
<p>But <code>Wrapping</code> is <code>#[repr(transparent)]</code></p>



<a name="250656750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250656750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250656750">(Aug 25 2021 at 18:01)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> so were the failures mostly about actual unsound transmutes or about false positives?</p>



<a name="250657018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250657018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250657018">(Aug 25 2021 at 18:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes/near/250655412">said</a>:</p>
<blockquote>
<p>But <code>Wrapping</code> is <code>#[repr(transparent)]</code></p>
</blockquote>
<p>yes but that does not "upstream" to the type containing the transparent type. Rustc is allowed to make <code>Option&lt;Wrapping&lt;T&gt;&gt;</code> different from <code>Option&lt;T&gt;</code> just fine.</p>



<a name="250657236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250657236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250657236">(Aug 25 2021 at 18:04)</a>:</h4>
<p>also, it might be that some very commonly used crates are using unsound transmutes which thereby causes other crates to fail. In reality the crates that need to be fixed might be lower than expected</p>



<a name="250657534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250657534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250657534">(Aug 25 2021 at 18:06)</a>:</h4>
<p>here is an issue talking about this for anyone who didnt click on that pr <a href="https://github.com/rust-lang/rust/issues/50842">https://github.com/rust-lang/rust/issues/50842</a></p>



<a name="250657628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250657628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250657628">(Aug 25 2021 at 18:07)</a>:</h4>
<p>The issue of dead code transmutes not being ub is a bit tricky, because this means rustc would need to get info back from the dead code lint, but what if the dead code lint has not run because its disabled?</p>



<a name="250661535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250661535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250661535">(Aug 25 2021 at 18:36)</a>:</h4>
<p>if repr(transparent) doesn't always embed into larger structs identically to the wrapped value there's probably a lot of broken unsafe code out there.</p>



<a name="250662181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250662181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250662181">(Aug 25 2021 at 18:40)</a>:</h4>
<p>i mean in practice it should work just fine, im just saying that technically its unsound because rustc <em>is</em> allowed to change the representation because the "higher" type is repr rust</p>



<a name="250662203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250662203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250662203">(Aug 25 2021 at 18:41)</a>:</h4>
<p>like transmuting between vecs</p>



<a name="250664249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250664249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250664249">(Aug 25 2021 at 18:54)</a>:</h4>
<p><code>#[repr(transparent)</code> says that the effect is that the layout and ABI of the whole struct is guaranteed to be the same as that one field.</p>



<a name="250664465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250664465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250664465">(Aug 25 2021 at 18:55)</a>:</h4>
<p>I read it as compositable</p>



<a name="250664725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250664725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250664725">(Aug 25 2021 at 18:57)</a>:</h4>
<p>Oh but we don't guarantee that two identical repr rust structs have the same layout</p>



<a name="250664741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250664741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250664741">(Aug 25 2021 at 18:57)</a>:</h4>
<p>So indeed it's not sound</p>



<a name="250665004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250665004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250665004">(Aug 25 2021 at 18:59)</a>:</h4>
<p>for vec, sure<br>
for option, no way that's morally correct even if it's technically correct</p>



<a name="250673095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250673095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250673095">(Aug 25 2021 at 19:52)</a>:</h4>
<p>Yeah but its still unsound even if you should be able to do it</p>



<a name="250674072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250674072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250674072">(Aug 25 2021 at 19:59)</a>:</h4>
<p>The UCG aim to allow that case, but they're not official yet.</p>



<a name="250715355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715355">(Aug 26 2021 at 03:40)</a>:</h4>
<p>Seems like the easiest thing would be to just wait for safe-transmute to land and then just make this a lint on all uses of <code>mem::transmute</code></p>



<a name="250715394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715394">(Aug 26 2021 at 03:41)</a>:</h4>
<p>ehhhh i dont think flat out rejecting transmute is good, there are actual uses of transmute and id rather not have transmute be warn by default</p>



<a name="250715399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715399">(Aug 26 2021 at 03:41)</a>:</h4>
<p>because the false positive rate is going to be so high (in the sense that people are using <code>transmute</code> in the first place because they have to) that it may as well be a lint on <code>transmute</code> full stop</p>



<a name="250715437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715437">(Aug 26 2021 at 03:42)</a>:</h4>
<p>... if you know there are lots of false positives, why would you lint on <em>more</em> cases?</p>



<a name="250715486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715486">(Aug 26 2021 at 03:42)</a>:</h4>
<p>Like, if you weren't a regular I would think you're trolling</p>



<a name="250715487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715487">(Aug 26 2021 at 03:42)</a>:</h4>
<p>Frankly I don't think this lint will be useful, but it might be usable as a clippy restriction lint</p>



<a name="250715657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715657">(Aug 26 2021 at 03:43)</a>:</h4>
<p>It's possible some more messaging around use of <code>transmute</code> could help but it's already surrounded by giant flashing warning signs so I think that a lint will just annoy people</p>



<a name="250715826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715826">(Aug 26 2021 at 03:45)</a>:</h4>
<p>There are plenty of use cases for transmute that can't possibly be safe, e.g. I transmute a function pointer to a different function signature for one of my crates. I don't see why that should be linted on.</p>
<p>(To be clear, it's absolutely cursed code, but there's no better way to write it, so I don't think a lint makes sense.)</p>



<a name="250715953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250715953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250715953">(Aug 26 2021 at 03:47)</a>:</h4>
<p>It seems possible that safe-transmute will solve the majority of current uses of <code>transmute</code>, and if it is actually effective enough it might be possible to marginalize it some more, but I'm dubious. I have a few uses of <code>transmute</code> in my code that does stuff I know safe-transmute won't help with, like hacking around the borrow checker because of polonius style borrow patterns, or breaking privacy restrictions on a crate I don't control. If there was a warning I would just override it</p>



<a name="250716082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716082">(Aug 26 2021 at 03:48)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> I don't know why you've assumed the lint has to warn on <em>all</em> uses of transmute. The original suggestion was only to lint on uses that are definitely UB.</p>



<a name="250716107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716107">(Aug 26 2021 at 03:48)</a>:</h4>
<p>My theory is that most people use <code>transmute</code> responsibly, i.e. for "cursed code", and the lint will be useless in those cases</p>



<a name="250716137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716137">(Aug 26 2021 at 03:49)</a>:</h4>
<p>I don't understand what you mean by "responsibly".</p>



<a name="250716153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716153">(Aug 26 2021 at 03:49)</a>:</h4>
<p>I mean when nothing safer is available</p>



<a name="250716225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716225">(Aug 26 2021 at 03:50)</a>:</h4>
<p>Right, ok. I was assuming that my code doesn't have UB. If it does have UB I want to know so I can bang my head against it some more and see if there's an alternative.</p>



<a name="250716238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716238">(Aug 26 2021 at 03:50)</a>:</h4>
<p>The examples with <code>Option&lt;u16&gt;</code> vs <code>Option&lt;Wrapper&lt;u16&gt;&gt;</code> are certainly not "definitely UB"</p>



<a name="250716275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716275">(Aug 26 2021 at 03:51)</a>:</h4>
<p>... how did you come to that conclusion?</p>



<a name="250716294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716294">(Aug 26 2021 at 03:51)</a>:</h4>
<p>There is a ton of uncertainty about layout rules and promises we may or not be committing to in UCG</p>



<a name="250716412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716412">(Aug 26 2021 at 03:52)</a>:</h4>
<p>in the meantime I would not at all fault a rust user for throwing up their hands and using <code>transmute</code> until rust figures out what it actually wants to do</p>



<a name="250716419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716419">(Aug 26 2021 at 03:52)</a>:</h4>
<p>Ok, then don't lint on those. I'm sure there are plenty of other cases where the lint is still useful.</p>



<a name="250716446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716446">(Aug 26 2021 at 03:53)</a>:</h4>
<p>I feel like <em>you</em> are throwing up your hands :P</p>



<a name="250716489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716489">(Aug 26 2021 at 03:53)</a>:</h4>
<p>honestly I'm not sure what you can say about transmutes that are definitely wrong except in the case where the source and target sizes don't line up</p>



<a name="250716581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716581">(Aug 26 2021 at 03:54)</a>:</h4>
<p>there are plenty of transmutes that are dubious but not many that can't possibly be compiled <del>correctly</del> the way the user is hoping for</p>



<a name="250716755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250716755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250716755">(Aug 26 2021 at 03:55)</a>:</h4>
<p>I think transmutes with mismatched sizes are compiled to a <code>panic</code> - in this case I think a lint is warranted (but I'm fairly sure this already lints)</p>



<a name="250718540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250718540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250718540">(Aug 26 2021 at 04:17)</a>:</h4>
<p>it is impossible to replace transmute, many things will always be "trust me mr compiler"</p>



<a name="250718578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250718578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250718578">(Aug 26 2021 at 04:17)</a>:</h4>
<p>but theres many cases where its blatant ub and people dont know, i see this way too much, so id like to lint away the obviously unsound cases</p>



<a name="250718815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250718815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250718815">(Aug 26 2021 at 04:21)</a>:</h4>
<p>If it's definitely UB in the sense that the compiler is <em>currently</em> relying on the user not doing that and will miscompile the code, then that sounds like a good lint, but I can't think of any example of that which isn't already caught</p>



<a name="250719020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719020">(Aug 26 2021 at 04:22)</a>:</h4>
<p>its not caught at all...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span>: <span class="kt">u8</span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Bar</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">b</span>: <span class="kt">u8</span>
<span class="p">}</span><span class="w"></span>

<span class="n">transmute</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">Bar</span><span class="o">&gt;</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"></span>
</code></pre></div>
<p>this is unsound</p>



<a name="250719040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719040">(Aug 26 2021 at 04:22)</a>:</h4>
<p>and rustc doesnt warn against doing this</p>



<a name="250719140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719140">(Aug 26 2021 at 04:24)</a>:</h4>
<p>That will do what the user expects across a lot of compiler versions and optimization settings. So that's just an unstable implementation detail that happens to be true</p>



<a name="250719157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719157">(Aug 26 2021 at 04:24)</a>:</h4>
<p>rustc (afaik) only warns against size mismatches and<code>&amp;</code> to <code>&amp;mut</code></p>



<a name="250719170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719170">(Aug 26 2021 at 04:24)</a>:</h4>
<p>yes, but its still unsound and the user should not be doing that</p>



<a name="250719198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719198">(Aug 26 2021 at 04:25)</a>:</h4>
<p>that sounds a lot like a "trust me mr compiler" situation to me</p>



<a name="250719220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719220">(Aug 26 2021 at 04:25)</a>:</h4>
<p>hmmm?</p>



<a name="250719241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719241">(Aug 26 2021 at 04:25)</a>:</h4>
<p>it's at best a future compatibility risk</p>



<a name="250719249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719249">(Aug 26 2021 at 04:25)</a>:</h4>
<p>rustc is relying on the user not relying on layout of repr(Rust) types, the user isnt holding up that contract, thats unsound</p>



<a name="250719303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719303">(Aug 26 2021 at 04:26)</a>:</h4>
<p>but it's not UB on current rust, so calling it unsound is a stretch</p>



<a name="250719315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719315">(Aug 26 2021 at 04:26)</a>:</h4>
<p>you dont need to have UB for something to be unsound...</p>



<a name="250719357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719357">(Aug 26 2021 at 04:26)</a>:</h4>
<p>this can very well cause UB on a new compiler version, therefore it is unsound, doesnt matter if it doesnt in the current version</p>



<a name="250719371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719371">(Aug 26 2021 at 04:26)</a>:</h4>
<p>soundness is just lack of UB quantified over all possible inputs</p>



<a name="250719408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719408">(Aug 26 2021 at 04:27)</a>:</h4>
<p>It's unstable, not unsound</p>



<a name="250719423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719423">(Aug 26 2021 at 04:27)</a>:</h4>
<p>do you characterize rustc as an input?</p>



<a name="250719434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719434">(Aug 26 2021 at 04:27)</a>:</h4>
<p>this is unsound not unstable</p>



<a name="250719459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719459">(Aug 26 2021 at 04:27)</a>:</h4>
<p>Otherwise you would have to call all of std unsound</p>



<a name="250719496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719496">(Aug 26 2021 at 04:27)</a>:</h4>
<p>thats a false argument, std is allowed to rely on special things because its the stdlib and it can be updated WITH rustc</p>



<a name="250719556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719556">(Aug 26 2021 at 04:28)</a>:</h4>
<p>Yes, it's unstable but lives with it</p>



<a name="250719566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719566">(Aug 26 2021 at 04:28)</a>:</h4>
<p>by staying up to date</p>



<a name="250719580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719580">(Aug 26 2021 at 04:28)</a>:</h4>
<p>but its the stdlib, your program isnt</p>



<a name="250719583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719583">(Aug 26 2021 at 04:28)</a>:</h4>
<p>in principle an external crate can do the same and it would be no less sound</p>



<a name="250719613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719613">(Aug 26 2021 at 04:29)</a>:</h4>
<p>One way to handle unstable details is to abstract over them, another way is to adapt to the changes</p>



<a name="250719615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719615">(Aug 26 2021 at 04:29)</a>:</h4>
<p>thats not true, besides, youd need to keep up with every single rustc commit, or else you could miss a commit that causes ub on a special use of the crate</p>



<a name="250719640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719640">(Aug 26 2021 at 04:29)</a>:</h4>
<p>Yes, if you missed a spot then you would be unsound on that version</p>



<a name="250719649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719649">(Aug 26 2021 at 04:29)</a>:</h4>
<p>for example, you relying on a niche not existing, then rustc adding a niche and breaking everything</p>



<a name="250719709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719709">(Aug 26 2021 at 04:30)</a>:</h4>
<p>no it would be always unsound, unsoundness means it could cause UB and this very much could</p>



<a name="250719774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719774">(Aug 26 2021 at 04:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes/near/250719423">said</a>:</p>
<blockquote>
<p>do you characterize rustc as an input?</p>
</blockquote>
<p>rustc is a parameter, i.e. you have that a crate is sound/unsound on a certain set of versions and compiler settings of rustc</p>



<a name="250719805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719805">(Aug 26 2021 at 04:31)</a>:</h4>
<p>something which is sound today but might be unsound tomorrow is a future compatibility hazard, but not (yet) unsound today</p>



<a name="250719889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719889">(Aug 26 2021 at 04:33)</a>:</h4>
<p>rustc is not allowed to just make something unsound if it is sound in a current version because that would break a lot of things. Therefore if rustc is allowed to make your thing cause UB in a new version, it is already unsound</p>



<a name="250719926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250719926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250719926">(Aug 26 2021 at 04:33)</a>:</h4>
<p>But there are future compatibility lints for exactly this case anyway, so a lint might still be useful</p>



<a name="250720015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720015">(Aug 26 2021 at 04:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes/near/250719889">said</a>:</p>
<blockquote>
<p>rustc is not allowed to just make something unsound if it is sound in a current version because that would break a lot of things. Therefore if rustc is allowed to make your thing cause UB in a new version, it is already unsound</p>
</blockquote>
<p>It can if it is unstable in the current version</p>



<a name="250720023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720023">(Aug 26 2021 at 04:33)</a>:</h4>
<p>repr Rust is not documented/specified, relying on unspecified things that may cause ub if changed sounds very unsound to me</p>



<a name="250720038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720038">(Aug 26 2021 at 04:34)</a>:</h4>
<p>but transmute and repr rust are not unstable</p>



<a name="250720114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720114">(Aug 26 2021 at 04:34)</a>:</h4>
<p>repr rust is an opaque layout, you dont know what rustc is going to do and are not allowed to rely on it</p>



<a name="250720121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720121">(Aug 26 2021 at 04:34)</a>:</h4>
<p>thats stable to me, its stable as "pls dont rely on me"</p>



<a name="250720225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720225">(Aug 26 2021 at 04:36)</a>:</h4>
<p>Layout details of repr(Rust) are unstable, i.e. not specified. They might be specified tomorrow, they are not "definitely and forever unspecified" in the majority of cases</p>



<a name="250720348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720348">(Aug 26 2021 at 04:37)</a>:</h4>
<p>but until then, you cannot rely on it. I mean heck, rustc in a current version could even detect this kind of transmute and make it instant UB. It doesnt but its 100% allowed to because it established the invariant that layout details of repr rust may not be relied on</p>



<a name="250720421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720421">(Aug 26 2021 at 04:38)</a>:</h4>
<p>the compiler establishing an invariant and you violating the invariant is the definition of unsoundness</p>



<a name="250720460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720460">(Aug 26 2021 at 04:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes/near/250720348">said</a>:</p>
<blockquote>
<p>but until then, you cannot rely on it. I mean heck, rustc in a current version could even detect this kind of transmute and make it instant UB. It doesnt but its 100% allowed to because it established the invariant that layout details of repr rust may not be relied on</p>
</blockquote>
<p>It won't, and can't really as a practical matter because this would break tons of unsafe code in the wild</p>



<a name="250720574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720574">(Aug 26 2021 at 04:39)</a>:</h4>
<p>yes, but its fully allowed to</p>



<a name="250720595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720595">(Aug 26 2021 at 04:39)</a>:</h4>
<p>just because you know the rustc team wont do it doesnt mean its sound</p>



<a name="250720711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720711">(Aug 26 2021 at 04:40)</a>:</h4>
<blockquote>
<p>established the invariant that layout details of repr rust may not be relied on</p>
</blockquote>
<p>That's not an invariant. I don't even know how you would express that formally</p>



<a name="250720869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720869">(Aug 26 2021 at 04:42)</a>:</h4>
<p>its kind of stated in the nomicon <a href="https://doc.rust-lang.org/nomicon/transmutes.html">https://doc.rust-lang.org/nomicon/transmutes.html</a><br>
but obviously what is fine and what isnt isnt specified formally yet, which is even more of a reason to not do this and to instead rely on layouts that are 100% specified and fine for transmuting</p>



<a name="250720900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720900">(Aug 26 2021 at 04:42)</a>:</h4>
<p>It seems like this boils down to "use of <code>transmute</code> is inadvisable", but someone who is reaching for <code>transmute</code> probably already knows that</p>



<a name="250720924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720924">(Aug 26 2021 at 04:43)</a>:</h4>
<p>there are no formally stated invariants because rust has no spec, so by that point i dont see why all other unsound things arent fine</p>



<a name="250720927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250720927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250720927">(Aug 26 2021 at 04:43)</a>:</h4>
<p>All of the transmutes that are specified already fall under the purview of safe-transmute</p>



<a name="250721013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721013">(Aug 26 2021 at 04:44)</a>:</h4>
<p>which is why I said that this may as well be a ban on <code>transmute</code> altogether, because once you have eliminated all the non-sketchy uses of transmute all the uses are sketchy</p>



<a name="250721058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721058">(Aug 26 2021 at 04:45)</a>:</h4>
<p>i dont really understand that thought process</p>



<a name="250721076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721076">(Aug 26 2021 at 04:45)</a>:</h4>
<p>function-wide bans dont work, people will just think its fine and disable the lint</p>



<a name="250721080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721080">(Aug 26 2021 at 04:45)</a>:</h4>
<p>when would a use of <code>transmute</code> <em>not</em> be linted against?</p>



<a name="250721087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721087">(Aug 26 2021 at 04:45)</a>:</h4>
<p>what does work is <code>hey, this is unsound, dont do it thanks</code></p>



<a name="250721098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721098">(Aug 26 2021 at 04:45)</a>:</h4>
<p>when its a legitimate use, which is well, a lot of the time</p>



<a name="250721145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721145">(Aug 26 2021 at 04:46)</a>:</h4>
<p>when it's a legitimate use, there will be another function to do it</p>



<a name="250721148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721148">(Aug 26 2021 at 04:46)</a>:</h4>
<p>that is not true</p>



<a name="250721156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721156">(Aug 26 2021 at 04:46)</a>:</h4>
<p>take JIT compilers as an example</p>



<a name="250721163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721163">(Aug 26 2021 at 04:46)</a>:</h4>
<p>there is no way to prove this random memory im pointing to is a function</p>



<a name="250721191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721191">(Aug 26 2021 at 04:47)</a>:</h4>
<p>and how is that transmute relying only on stable layout details?</p>



<a name="250721245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721245">(Aug 26 2021 at 04:48)</a>:</h4>
<p>im not talking about that, im talking about linting against transmute, transmute has legitimate, sound uses that cant be statically checked</p>



<a name="250721298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721298">(Aug 26 2021 at 04:49)</a>:</h4>
<p>I don't see how the compiler doesn't have just the same freedom in that case to change how function pointers work in such a way to break that code</p>



<a name="250721346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721346">(Aug 26 2021 at 04:50)</a>:</h4>
<p>again, it's not going to happen because of the breakage, but that is in no way a guaranteed / specified corner of the language</p>



<a name="250721413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721413">(Aug 26 2021 at 04:50)</a>:</h4>
<p>pointers are primitives, they are not repr rust, they have defined layouts that literally every single rust program relies on</p>



<a name="250721456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721456">(Aug 26 2021 at 04:51)</a>:</h4>
<p>not function pointers - they are pointer sized but I don't think we specify anything about the target of the pointer</p>



<a name="250721469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721469">(Aug 26 2021 at 04:51)</a>:</h4>
<p>that's basically the rust calling convention, which is unspecified</p>



<a name="250721527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721527">(Aug 26 2021 at 04:52)</a>:</h4>
<p>calling convention has nothing to do with the function pointer, calling conv mismatch is ub that happens when you call the function, not when u take a pointer to it</p>



<a name="250721555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721555">(Aug 26 2021 at 04:52)</a>:</h4>
<p>jit compilers use the C call conv for functions for obvious reasons anyways</p>



<a name="250721685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721685">(Aug 26 2021 at 04:54)</a>:</h4>
<p>I don't think the validity constraints of function pointers are stable. I think they have to be nonzero, not sure if they are aligned, not sure if they have to point to a valid function</p>



<a name="250721769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721769">(Aug 26 2021 at 04:56)</a>:</h4>
<p>My point is that transmutes fall into two camps: those that will be solved by safe-transmute, and those that will be linted against by the proposed lint</p>



<a name="250721856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721856">(Aug 26 2021 at 04:56)</a>:</h4>
<p>and there are plenty of good reasons to use transmutes in the second camp</p>



<a name="250721879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721879">(Aug 26 2021 at 04:56)</a>:</h4>
<p>well jit compilers are making the same kind of function as one you would get from just linking to an extern function, so it cannot be unsound because its just mimicking linking against extern functions</p>



<a name="250721935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721935">(Aug 26 2021 at 04:57)</a>:</h4>
<p>unsafe is enough of a "bad stuff may happen here", we dont need a "welp gotta disable this because rustc devs think they know better". It feels too opinionated to me</p>



<a name="250721955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721955">(Aug 26 2021 at 04:57)</a>:</h4>
<p>I agree with you, but it's not specified. I hope we will specify this so that jit compilers can do this with a stability guarantee</p>



<a name="250721968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250721968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250721968">(Aug 26 2021 at 04:57)</a>:</h4>
<p>warnings/errors against things that are blatantly ub? sure, the user is actively violating what rust is all for so that case should be handled</p>



<a name="250722028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722028">(Aug 26 2021 at 04:58)</a>:</h4>
<p>i mean if you are going to treat everything as unspecified then rust as a whole is unsound, rust really makes zero formal guarantees for layout, what is ub, etc</p>



<a name="250722176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722176">(Aug 26 2021 at 05:00)</a>:</h4>
<p>Well for me soundness is a function of the compiler. As long as the crate is careful to turn things on and off appropriate to the compiler versions it's totally possible to adapt to changes in layout details. Historically rustc hasn't changed it's layout details much for the things people care to transmute though</p>



<a name="250722283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722283">(Aug 26 2021 at 05:01)</a>:</h4>
<p>but you cannot truly know if a version makes your program unsound</p>



<a name="250722290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722290">(Aug 26 2021 at 05:01)</a>:</h4>
<p>It's not completely hopeless to determine whether rust code has UB - there is miri for example</p>



<a name="250722300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722300">(Aug 26 2021 at 05:01)</a>:</h4>
<p>layout changes wont be documented because they shouldnt be relied upon</p>



<a name="250722319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722319">(Aug 26 2021 at 05:01)</a>:</h4>
<p>so unless you keep up with every single commit, you can miss things</p>



<a name="250722365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722365">(Aug 26 2021 at 05:02)</a>:</h4>
<p><code>Box</code> and <code>Vec</code> have documented layout, so that's not quite true</p>



<a name="250722369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722369">(Aug 26 2021 at 05:02)</a>:</h4>
<p>miri does not catch all of ub</p>



<a name="250722383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722383">(Aug 26 2021 at 05:02)</a>:</h4>
<p>miri can and does miss a lot of things so it shouldnt be relied upon for "yep this is sound"</p>



<a name="250722422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722422">(Aug 26 2021 at 05:03)</a>:</h4>
<p>Obviously I would prefer a proper spec, but there is a proto-spec in the form of documentation in the reference / nomicon / UCG</p>



<a name="250722429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722429">(Aug 26 2021 at 05:03)</a>:</h4>
<p>so it's not as hopeless as you suggest</p>



<a name="250722453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722453">(Aug 26 2021 at 05:03)</a>:</h4>
<p>because documentation never becomes out of date ;)</p>



<a name="250722497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722497">(Aug 26 2021 at 05:04)</a>:</h4>
<p>to my knowledge those three sources are kept up to date with rust</p>



<a name="250722535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722535">(Aug 26 2021 at 05:04)</a>:</h4>
<p>but for the most part rustc isn't changing this stuff every commit anyway, it's mostly just documenting what already exists</p>



<a name="250722575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722575">(Aug 26 2021 at 05:05)</a>:</h4>
<p>and the desire to not break huge swaths of the ecosystem keeps it mostly pinned down</p>



<a name="250722638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722638">(Aug 26 2021 at 05:06)</a>:</h4>
<p>i dont like this, i dont like relying on "ehhh ye but they surely wont change it". This is a cyclic thing, you dont want to tie the compiler devs' hands behind their back, because being able to abuse layout not being specified can lead to better optimization</p>



<a name="250722754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722754">(Aug 26 2021 at 05:07)</a>:</h4>
<p>and i know if i was a rustc dev id be frustrated of missing an optimization because some users didnt decide to follow the big red warning of "DONT RELY ON THIS LAYOUT"</p>



<a name="250722758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722758">(Aug 26 2021 at 05:07)</a>:</h4>
<p>That's up for the user to decide. Again, it's inadvisable to use <code>transmute</code> if you can help it, but the users that are using it probably got that message already, and a lint is only going to aggravate at that point</p>



<a name="250722867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722867">(Aug 26 2021 at 05:08)</a>:</h4>
<p>It might be fine as an opt-in lint, but it won't help most users</p>



<a name="250722868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722868">(Aug 26 2021 at 05:08)</a>:</h4>
<p>many users that use it are not aware that they shouldnt be transmuting repr rust types</p>



<a name="250722877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722877">(Aug 26 2021 at 05:09)</a>:</h4>
<p>thats why a lint is needed</p>



<a name="250722981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722981">(Aug 26 2021 at 05:10)</a>:</h4>
<p>If we can determine that adding <code>repr(C)</code> to the involved types is a thing the user can actually do, then that could work</p>



<a name="250722994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250722994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250722994">(Aug 26 2021 at 05:10)</a>:</h4>
<p>yes that could be a nice suggestion to add to the lint</p>



<a name="250723029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723029">(Aug 26 2021 at 05:11)</a>:</h4>
<p>but what if they can't? There will still be a huge number of positives (whether they are false is up for debate) in the wild</p>



<a name="250723076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723076">(Aug 26 2021 at 05:12)</a>:</h4>
<p>if they cant then they just ignore the suggestion then remove the transmute or do something else</p>



<a name="250723095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723095">(Aug 26 2021 at 05:12)</a>:</h4>
<p>the cases where its fine would need to be explicitly cased in the lint</p>



<a name="250723138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723138">(Aug 26 2021 at 05:13)</a>:</h4>
<p>that still sounds like it would come within striking distance of safe-transmute</p>



<a name="250723144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723144">(Aug 26 2021 at 05:13)</a>:</h4>
<p>we should just recommend that instead</p>



<a name="250723147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723147">(Aug 26 2021 at 05:13)</a>:</h4>
<p>sure and if it does then the lint can just reccomend that</p>



<a name="250723320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723320">(Aug 26 2021 at 05:16)</a>:</h4>
<p>for the case of <code>*const () -&gt; fn()</code> I think it is possible for safe-transmute to handle that with <code>Neglect::SAFETY</code></p>



<a name="250723391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250723391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250723391">(Aug 26 2021 at 05:17)</a>:</h4>
<p>(the name safe-transmute here is a bit of a misnomer since we're using it for an unsafe transmute, but it's more like "deeply checked transmute-compatibility")</p>



<a name="250735515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250735515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250735515">(Aug 26 2021 at 07:42)</a>:</h4>
<p>note: function pointers are not always aligned, though some platforms may have them be aligned</p>



<a name="250735818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250735818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250735818">(Aug 26 2021 at 07:46)</a>:</h4>
<p>Anyway: the standard library docs say "check the nomicon"<br>
then the nomicon says "here is some advice and ultimately we don't know, maybe check UCG"<br>
then UCG says "ultimately we don't know it's probably like this but there's no RFC yet"<br>
then Ralf says "probably it should be allowed if the layout matches".</p>



<a name="250735884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250735884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250735884">(Aug 26 2021 at 07:47)</a>:</h4>
<p>ironclad spec right there</p>



<a name="250735957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250735957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250735957">(Aug 26 2021 at 07:48)</a>:</h4>
<p>yeah it's not great and i wish T-lang would focus on this more heavily but we got an edition this year so that's how it goes</p>



<a name="250735960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250735960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250735960">(Aug 26 2021 at 07:48)</a>:</h4>
<p>maybe next year this can get attention</p>



<a name="250749074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250749074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250749074">(Aug 26 2021 at 10:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes/near/250722365">said</a>:</p>
<blockquote>
<p><code>Box</code> and <code>Vec</code> have documented layout, so that's not quite true</p>
</blockquote>
<p>Partially documented. The field order isn't specified for Vec for example, that's why you're not allowed transmute vecs and must use from/into_raw_parts</p>



<a name="250749193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc%20warn%20against%20repr%20rust%20transmutes/near/250749193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc.20warn.20against.20repr.20rust.20transmutes.html#250749193">(Aug 26 2021 at 10:04)</a>:</h4>
<p>Bone breaking will continue until morale improves: <a href="https://github.com/rust-lang/rust/issues/87868">#87868</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>