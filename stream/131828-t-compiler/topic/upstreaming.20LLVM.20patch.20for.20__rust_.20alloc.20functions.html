<html>
<head><meta charset="utf-8"><title>upstreaming LLVM patch for __rust_ alloc functions · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html">upstreaming LLVM patch for __rust_ alloc functions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="247370657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247370657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247370657">(Jul 27 2021 at 18:17)</a>:</h4>
<p>I'm back on this. Is there a reason to not send that patch upstream? There's plenty of caselaw for non-C++ stuff in LLVM (eg Swift) and it seems like it might make sense to just land this patch there. I'm happy to try and have that discussion with LLVM folks if there's not a compelling reason to keep it Rust-local.</p>



<a name="247426192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247426192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247426192">(Jul 28 2021 at 06:28)</a>:</h4>
<p>LLVM hardcoding those symbols would effectively mean they're stable and we can't fix them</p>



<a name="247426209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247426209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247426209">(Jul 28 2021 at 06:28)</a>:</h4>
<p>I've been meaning to switch them for a while to something more "mangled" to avoid them looking like C symbols</p>



<a name="247426300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247426300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247426300">(Jul 28 2021 at 06:30)</a>:</h4>
<p><span class="user-mention" data-user-id="316805">@durin42</span> also, as the PR linked above (<a href="https://github.com/rust-lang/llvm-project/pull/89">https://github.com/rust-lang/llvm-project/pull/89</a>) makes it clear, <em>the signatures have changed</em>, so we'd also need some kind of versioning in the symbol name</p>



<a name="247426389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247426389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247426389">(Jul 28 2021 at 06:32)</a>:</h4>
<p>it would be useful to be able to use attributes or something to pass this information to LLVM, so we don't need LLVM to know about Rust symbols <em>at all</em></p>



<a name="247426485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247426485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247426485">(Jul 28 2021 at 06:35)</a>:</h4>
<p>maybe metadata connecting alloc/realloc/free functions together</p>



<a name="247431351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247431351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247431351">(Jul 28 2021 at 07:57)</a>:</h4>
<p>The signatures are unlikely to change nowadays as <code>GlobalAlloc</code> has been stabilized and the <code>__rust_*</code> allocator methods have a 1-to-1 correspondence with <code>GlobalAlloc</code> methods. They only happen to expand <code>Layout</code> into a separate size and align argument.</p>



<a name="247434689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247434689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247434689">(Jul 28 2021 at 08:40)</a>:</h4>
<p>I just don't want to bake any assumptions about <em>unstable Rust std internals</em> into LLVM</p>



<a name="247434752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247434752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247434752">(Jul 28 2021 at 08:41)</a>:</h4>
<p>sure, the API wrapping those symbols might be stable, but the linking/call ABI isn't</p>



<a name="247434781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247434781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247434781">(Jul 28 2021 at 08:41)</a>:</h4>
<p>in fact it's probably broken if you try to mix multiple Rust versions into one process...</p>



<a name="247435193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247435193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247435193">(Jul 28 2021 at 08:47)</a>:</h4>
<p>The ABI is set to "C", so it doesn't change unless the allocator shim is explicitly changed.</p>



<a name="247435798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247435798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247435798">(Jul 28 2021 at 08:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20recognizing.20.60__rust_*.60.20allocator.20.20.2E.2E.2E/near/247434689">said</a>:</p>
<blockquote>
<p>I just don't want to bake any assumptions about <em>unstable Rust std internals</em> into LLVM</p>
</blockquote>
<p>If anything I would like it to be stabilized. That would allow C code to use the rust allocator to say allocate a <code>Box</code> or <code>Vec</code> without requiring everyone to write wrappers in rust. For example <code>cxx</code> has a lot of rust wrappers like <a href="https://github.com/dtolnay/cxx/blob/9c1737feff7208cd4825984614beaf09a27aefcf/src/symbols/rust_vec.rs#L15-L56">https://github.com/dtolnay/cxx/blob/9c1737feff7208cd4825984614beaf09a27aefcf/src/symbols/rust_vec.rs#L15-L56</a> that are called from C++ when trying to do anything with a <code>rust::Vec&lt;T&gt;</code> which is a C++ type that can be converted from and to a rust <code>Vec&lt;T&gt;</code> without reallocating.</p>



<a name="247435806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247435806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247435806">(Jul 28 2021 at 08:54)</a>:</h4>
<p>that just makes me want to try to hide the symbols more</p>



<a name="247435832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247435832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247435832">(Jul 28 2021 at 08:55)</a>:</h4>
<p>they are a way for two crates to communicate. they <em>should never</em> be accessible through other means</p>



<a name="247435869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247435869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247435869">(Jul 28 2021 at 08:55)</a>:</h4>
<p>also, it's not really about what changes we make today, that I'm worried about, but about baking in something that we might later find a reason to want to change</p>



<a name="247435870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247435870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247435870">(Jul 28 2021 at 08:55)</a>:</h4>
<p>Why would you want to change it? There are literally zero alternative implementation methods. <code>__rust_*</code> is effectively exposed to stable as <code>alloc::Global</code>.</p>



<a name="247436003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436003">(Jul 28 2021 at 08:57)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> currently if you try to use custom global allocators from multiple <em>independently compiled</em> Rust <code>cdylib</code>s, aren't they broken? if C can see the symbol, doesn't that mean one of the allocators will be ignored?</p>



<a name="247436071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436071">(Jul 28 2021 at 08:58)</a>:</h4>
<p>that's, for example, something that should IMO be fixed</p>



<a name="247436082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436082">(Jul 28 2021 at 08:58)</a>:</h4>
<p>One allocator has to be ignored either way. Imagine two cdylibs depend on the same <code>libstd.so</code>. Which allocator should <code>libstd.so</code> use?</p>



<a name="247436107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436107">(Jul 28 2021 at 08:58)</a>:</h4>
<p>my point is a situation in which <em>they don't</em></p>



<a name="247436110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436110">(Jul 28 2021 at 08:58)</a>:</h4>
<p>sorry, I forgot to say "multiple versions of Rust" too</p>



<a name="247436135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436135">(Jul 28 2021 at 08:59)</a>:</h4>
<p>(or <code>-Z build-std</code> I guess)</p>



<a name="247436181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436181">(Jul 28 2021 at 08:59)</a>:</h4>
<p>If <code>__rust_*</code> becomes stabilized, there is no problem with using the same allocator from multiple versions of rust.</p>



<a name="247436255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436255">(Jul 28 2021 at 09:00)</a>:</h4>
<p>I think panicking is similarly broken, and even worse since the ABI is nowhere near as unchanging</p>



<a name="247436328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436328">(Jul 28 2021 at 09:00)</a>:</h4>
<p>Probably.</p>



<a name="247436361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436361">(Jul 28 2021 at 09:00)</a>:</h4>
<p>anyway, I think stabilizing any of these <em>implementation details</em> requires an RFC, and until such a thing gets accepted, I'd rather make these "oh we just hardcoded some symbol names" things more hidden and less predictable</p>



<a name="247436385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436385">(Jul 28 2021 at 09:01)</a>:</h4>
<p>Add the rustc version to the symbol name?</p>



<a name="247436481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436481">(Jul 28 2021 at 09:02)</a>:</h4>
<p>if we can avoid LLVM hardcoding them, then we can probably fully mangle them (since the crate defining these symbols always depends on the crate declaring them <em>anyway</em>, so they can come from the latter)</p>



<a name="247436517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436517">(Jul 28 2021 at 09:03)</a>:</h4>
<p>i.e. weak lang items would require exactly one declaration and one definition, and the definition cannot be supplied unless the declaration already exists in an upstream crate</p>



<a name="247436538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436538">(Jul 28 2021 at 09:03)</a>:</h4>
<p>then, you just use the declaration's mangling as the symbol name</p>



<a name="247436663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436663">(Jul 28 2021 at 09:05)</a>:</h4>
<p>this could potentially allow e.g. incompatible panic runtimes from separate <code>-Z build-std</code>, to avoid interfering with eachother in the same process (but Cargo may make this non-trivial)</p>



<a name="247436696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436696">(Jul 28 2021 at 09:05)</a>:</h4>
<p>That would require renaming the personality function too I think.</p>



<a name="247436797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436797">(Jul 28 2021 at 09:06)</a>:</h4>
<p>It is currently hard coded as <code>rust_eh_personality</code>. Not even with an <code>__</code> prefix.</p>



<a name="247436810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247436810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247436810">(Jul 28 2021 at 09:07)</a>:</h4>
<p><em>yikes</em></p>



<a name="247437382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247437382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247437382">(Jul 28 2021 at 09:14)</a>:</h4>
<p>This is the full list of unmangled symbols exported by a rust dylib:</p>
<ul>
<li>__rust_alloc</li>
<li>__rust_alloc_zeroed</li>
<li>__rust_realloc</li>
<li>__rust_dealloc</li>
<li>rust_oom</li>
<li>__rdl_oom</li>
</ul>
<hr>
<ul>
<li>rust_begin_unwind (deliberately unmangled to allow breakpoint placing)</li>
</ul>
<hr>
<ul>
<li>rust_panic</li>
<li>rust_eh_personality</li>
<li>__rust_start_panic</li>
<li>__rust_drop_panic</li>
<li>__rust_foreign_exception</li>
<li>__rust_panic_cleanup</li>
</ul>



<a name="247437438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247437438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247437438">(Jul 28 2021 at 09:14)</a>:</h4>
<p>so yeah I think we need mandatory mangling + using some other method to inform LLVM of any global allocator entry-points (such as custom attributes, that we could upstream later, and which could perhaps be usable from C or C++ through Clang custom attributes)</p>



<a name="247437665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247437665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247437665">(Jul 28 2021 at 09:17)</a>:</h4>
<p>I still think the allocator methods should stay this way. Mangling the panic related symbols (except <code>rust_begin_unwind</code>) is a good idea.</p>



<a name="247438234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438234">(Jul 28 2021 at 09:24)</a>:</h4>
<p>even if we decide to stabilize them, I don't think they should look <em>anything</em> like C symbols</p>



<a name="247438268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438268">(Jul 28 2021 at 09:25)</a>:</h4>
<p><em>and</em> they need to be versioned (whether tied to Rust version or not)</p>



<a name="247438389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438389">(Jul 28 2021 at 09:26)</a>:</h4>
<p>to avoid backtraces looking terrible, one earlier idea of mine was using v0 mangling but with a special hashless crate root</p>



<a name="247438395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438395">(Jul 28 2021 at 09:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/247438234">said</a>:</p>
<blockquote>
<p>even if we decide to stabilize them, I don't think they should look <em>anything</em> like C symbols</p>
</blockquote>
<p>If they don't, you can't call them from C.</p>



<a name="247438416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438416">(Jul 28 2021 at 09:27)</a>:</h4>
<p>I mean they'd still be interfaceable with C, they should just not follow any existing naming conventions</p>



<a name="247438432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438432">(Jul 28 2021 at 09:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/247438268">said</a>:</p>
<blockquote>
<p><em>and</em> they need to be versioned (whether tied to Rust version or not)</p>
</blockquote>
<p><code>alloc::Global</code> isn't versioned either.</p>



<a name="247438477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438477">(Jul 28 2021 at 09:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/247438416">said</a>:</p>
<blockquote>
<p>I mean they'd still be interfaceable with C, they should just not follow any existing naming conventions</p>
</blockquote>
<p>In what way?</p>



<a name="247438506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438506">(Jul 28 2021 at 09:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/247438389">said</a>:</p>
<blockquote>
<p>to avoid backtraces looking terrible, one earlier idea of mine was using v0 mangling but with a special hashless crate root</p>
</blockquote>
<p>this, for example</p>



<a name="247438575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438575">(Jul 28 2021 at 09:28)</a>:</h4>
<p>I see. That would work I guess.</p>



<a name="247438577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438577">(Jul 28 2021 at 09:28)</a>:</h4>
<p>e.g. <code>_RNvNtC4rust5alloc7realloc</code> would demangle as <code>rust::alloc::realloc</code></p>



<a name="247438729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438729">(Jul 28 2021 at 09:30)</a>:</h4>
<p>and unlike a C-looking or C++-mangled symbol, it's <em>distinctly Rust</em></p>



<a name="247438950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247438950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247438950">(Jul 28 2021 at 09:33)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> the nice thing is that if we use "the symbol name of the declaration", <code>#[link_name = "..."]</code> is all it takes to "stabilize" any of them</p>



<a name="247439058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247439058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247439058">(Jul 28 2021 at 09:34)</a>:</h4>
<p>Almost, but not quite. The allocator methods are generated directly by the backend, not as part of any standard library crate.</p>



<a name="247444191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247444191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247444191">(Jul 28 2021 at 10:50)</a>:</h4>
<p>I wrote a Pre-RFC: <a href="https://hackmd.io/@bjorn3/B18MVoRR_">https://hackmd.io/@bjorn3/B18MVoRR_</a> <span class="user-mention" data-user-id="119009">@eddyb</span> do you have any feedback before I post it on i.r-l.o?</p>



<a name="247444439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247444439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247444439">(Jul 28 2021 at 10:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/247439058">said</a>:</p>
<blockquote>
<p>Almost, but not quite. The allocator methods are generated directly by the backend, not as part of any standard library crate.</p>
</blockquote>
<p>they're still "imported" somewhere in <code>alloc</code>, so that could serve as the "source of truth"</p>



<a name="247444498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247444498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247444498">(Jul 28 2021 at 10:55)</a>:</h4>
<p>I guess so. There is currently no direction connection between the two though. <code>liballoc</code> simply uses <code>extern "C" { fn __rust_alloc(...</code> without a lang item.</p>



<a name="247444530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247444530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247444530">(Jul 28 2021 at 10:56)</a>:</h4>
<p>right, but that's trivially fixable</p>



<a name="247448169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247448169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247448169">(Jul 28 2021 at 11:44)</a>:</h4>
<p><a href="https://internals.rust-lang.org/t/pre-rfc-support-using-the-rust-allocator-from-c/15097">https://internals.rust-lang.org/t/pre-rfc-support-using-the-rust-allocator-from-c/15097</a></p>



<a name="247449692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247449692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247449692">(Jul 28 2021 at 12:03)</a>:</h4>
<p>oh no I didn't finish writing and sending my message, found this in Zulip:</p>
<blockquote>
<p>anyway, I have no feedback on the Pre-RFC, other that some kind of versioning might be desirable, tho most choices we might make for the names still allow to add some kind of extra information later - tho either way, stabilizing means that whatever usecases we allow have to always be supported (which, yes, as you've mentioned, would</p>
</blockquote>



<a name="247449957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247449957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247449957">(Jul 28 2021 at 12:06)</a>:</h4>
<p>not sure what I wanted to say more, I guess that while it would always be <em>possible</em> to support today's exact set of functions and ABI, we may not want that if we e.g. add another method to the trait, with a default implementation, that we do want to allow it being overriden by a global allocator, and which we'd proxy through the symbols that would be stabilized</p>



<a name="247449985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247449985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247449985">(Jul 28 2021 at 12:06)</a>:</h4>
<p>we couldn't do that if we promised C code could implement an allocator, because they'd be missing the function</p>



<a name="247450126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247450126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247450126">(Jul 28 2021 at 12:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/247449985">said</a>:</p>
<blockquote>
<p>we couldn't do that if we promised C code could implement an allocator, because they'd be missing the function</p>
</blockquote>
<p>Promising this would require more than my Pre-RFC as currently there is no way to tell rustc that you wrote a global allocator without actually defining it at the same place, so rustc will either error out due to no global allocator existing in it's view or try to generate an allocator shim for libstd's default allocator.</p>



<a name="247488374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247488374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247488374">(Jul 28 2021 at 17:16)</a>:</h4>
<p>instead of upstreaming rust details, could LLVM get a new API for registering allocator details?</p>



<a name="247495312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247495312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247495312">(Jul 28 2021 at 18:07)</a>:</h4>
<p>That's probably worth discussing with upstream. I'm happy to try and shake a tree on my side and see if there's anyone from our stable of LLVM hackers that would be interested in having the conversation. Let me know?</p>



<a name="247499311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247499311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247499311">(Jul 28 2021 at 18:38)</a>:</h4>
<p>just to be clear, "registering" might not be necessary if we can have attributes/metadata instead, to annotate functions directly</p>



<a name="247499371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247499371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247499371">(Jul 28 2021 at 18:38)</a>:</h4>
<p>idk how willing LLVM is to retire their hacky symbol hardcoding practices</p>



<a name="247501269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247501269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247501269">(Jul 28 2021 at 18:52)</a>:</h4>
<p>I'll try and shake a tree and see if they're willing to consider something.</p>



<a name="247502936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247502936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247502936">(Jul 28 2021 at 19:04)</a>:</h4>
<p>I recall there being some effort around making allocation optimization agnostic to specific symbol names.</p>



<a name="247502956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247502956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247502956">(Jul 28 2021 at 19:04)</a>:</h4>
<p>not sure where it was, but there was definitely some discussion about that before.</p>



<a name="247503016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247503016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247503016">(Jul 28 2021 at 19:04)</a>:</h4>
<p>and yes, I believe it was a metadata annotation on the declaration or somesuch.</p>



<a name="247503289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247503289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247503289">(Jul 28 2021 at 19:07)</a>:</h4>
<p>Similar to GCC's <code>__attribute((malloc))</code>?</p>



<a name="247503646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247503646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247503646">(Jul 28 2021 at 19:09)</a>:</h4>
<p>Sort of. I don't know offhand if there are other requirements imposed by LLVM for allocation functions than just no-aliases.</p>



<a name="247602894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/247602894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#247602894">(Jul 29 2021 at 15:54)</a>:</h4>
<p>So, my LLVM experts say it's plausible that we could implement more attributes in LLVM, and thread that through. I might give that a shot.</p>



<a name="255283674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255283674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255283674">(Sep 28 2021 at 19:28)</a>:</h4>
<p>Hokay, I'm _really_ close on this, but: do we not have any cases in Rust where we use an LLVM attribute that takes a parameter?</p>



<a name="255283936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255283936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255283936">(Sep 28 2021 at 19:30)</a>:</h4>
<p><code>stack-probe</code>, or maybe its <code>probe-stack</code>?</p>



<a name="255284308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255284308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255284308">(Sep 28 2021 at 19:32)</a>:</h4>
<p>It takes either a function name or <code>inline-asm</code> as an argument.</p>



<a name="255284608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255284608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255284608">(Sep 28 2021 at 19:34)</a>:</h4>
<p>hm, I don't see that in LLVMRustAttribute?</p>



<a name="255284786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255284786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255284786">(Sep 28 2021 at 19:35)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/attributes.rs#L155">https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/attributes.rs#L155</a></p>



<a name="255285035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255285035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255285035">(Sep 28 2021 at 19:37)</a>:</h4>
<p>ah, I can just do it from a string, clever</p>



<a name="255285264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255285264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255285264">(Sep 28 2021 at 19:39)</a>:</h4>
<p>I'm surprised you need an attribute with a value, is there a LLVM diff for this attribute?</p>



<a name="255285496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255285496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255285496">(Sep 28 2021 at 19:40)</a>:</h4>
<p>not yet, but I need to tell LLVM which argument is the size of the allocation</p>



<a name="255285545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255285545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255285545">(Sep 28 2021 at 19:41)</a>:</h4>
<p>sec, lemme get an llvm repo I can push to</p>



<a name="255286111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255286111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255286111">(Sep 28 2021 at 19:44)</a>:</h4>
<p><a href="https://github.com/durin42/llvm-project/commit/7a6923b390669b8b9a839ef1afa9ec80d1fa9c1e">https://github.com/durin42/llvm-project/commit/7a6923b390669b8b9a839ef1afa9ec80d1fa9c1e</a> is what I've got, totally unreviewed</p>



<a name="255286142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255286142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255286142">(Sep 28 2021 at 19:44)</a>:</h4>
<p>I'm avoiding things I don't want to do by messing with compiler internals</p>



<a name="255286155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255286155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255286155">(Sep 28 2021 at 19:45)</a>:</h4>
<p>ah, okay, makes sense.</p>



<a name="255286336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255286336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255286336">(Sep 28 2021 at 19:46)</a>:</h4>
<p>oh my gosh it compiled a stage1</p>
<p>still doesn't _work_, but it compiled!</p>



<a name="255286469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255286469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255286469">(Sep 28 2021 at 19:47)</a>:</h4>
<p><a href="https://github.com/durin42/rust/commit/43aa09f57de84dfd6d158f5c4a78a27898d5d8eb">https://github.com/durin42/rust/commit/43aa09f57de84dfd6d158f5c4a78a27898d5d8eb</a> see anything obvious in there? I don't think I see my attributes at all in the IR?</p>



<a name="255287071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287071">(Sep 28 2021 at 19:51)</a>:</h4>
<p>not sure, seems okay to me, but you should be looking at the function declaration and whatnot… and if them allocations are optimised out, then the declaration won't show up <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="255287162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287162">(Sep 28 2021 at 19:51)</a>:</h4>
<p>you want to build code with -Cno-prepopulate-passes if you want to look at what llvm gets fed in the first place.</p>



<a name="255287165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287165">(Sep 28 2021 at 19:51)</a>:</h4>
<p>we're adding the attributes so the allocations _can_ optimize out</p>



<a name="255287286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287286">(Sep 28 2021 at 19:52)</a>:</h4>
<p>I think I might see it actually, hang on</p>



<a name="255287298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287298">(Sep 28 2021 at 19:52)</a>:</h4>
<p>might also be the case that LLVM just discards attributes it doesn't know about</p>



<a name="255287332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287332">(Sep 28 2021 at 19:52)</a>:</h4>
<p>make sure you build LLVM with assertions enabled.</p>



<a name="255287363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287363">(Sep 28 2021 at 19:52)</a>:</h4>
<p>ooh, I segfaulted llvm</p>



<a name="255287444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287444">(Sep 28 2021 at 19:53)</a>:</h4>
<p>that sounds like an assertion firing ^^</p>



<a name="255287524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287524">(Sep 28 2021 at 19:53)</a>:</h4>
<p>compiling the stage1 std, so I broke the compiler real good</p>



<a name="255287600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255287600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255287600">(Sep 28 2021 at 19:54)</a>:</h4>
<p>(I tried poking the attribute on the <code>ret</code> value in that function, like the <code>LLVMSetTailCall</code> call, but that's clearly wrong)</p>



<a name="255288473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255288473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255288473">(Sep 28 2021 at 19:59)</a>:</h4>
<p>If you don't have <code>[llvm] assertions=1</code> in your config.toml you definitely should add it.</p>



<a name="255288636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255288636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255288636">(Sep 28 2021 at 20:00)</a>:</h4>
<p>Added that, telling things to rebuild.</p>



<a name="255290299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255290299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255290299">(Sep 28 2021 at 20:10)</a>:</h4>
<p>even with assertions enabled, it just segfaults, how fun</p>



<a name="255290662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255290662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255290662">(Sep 28 2021 at 20:13)</a>:</h4>
<p>oh, this is a regression in llvm I think, and I just missed it until now. "fun"</p>



<a name="255337459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255337459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255337459">(Sep 29 2021 at 03:46)</a>:</h4>
<p>Okay, I've worked around the breakage (it's the same LTO breakage as before, just manifests different now). I think the attribute needs to be on the function declaration, that is on the</p>
<div class="codehilite"><pre><span></span><code>; Function Attrs: nounwind nonlazybind uwtable
declare void @__rust_dealloc(i8*, i64, i64) unnamed_addr #0
</code></pre></div>
<p>but I'm not sure where that declaration came from, so I'm not sure how to add the attribute. Any hints?</p>



<a name="255435680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255435680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255435680">(Sep 29 2021 at 17:04)</a>:</h4>
<p>All declarations ultimately end up happening via <code>LLVMRustGetOrInsertFunction</code> pretty much.</p>



<a name="255435902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255435902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255435902">(Sep 29 2021 at 17:05)</a>:</h4>
<p>There aren't many calls of this function, and you probably can just have a debugger break on a call of this function with appropriate arguments.</p>



<a name="255470450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255470450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255470450">(Sep 29 2021 at 20:39)</a>:</h4>
<p>Right, I've been modifying a return value of LLVMRustGetOrInsertFunction in <a href="http://allocator.rs">allocator.rs</a> in rustc_codegen_llvm, but it doesn'tseem to have a side effect...</p>



<a name="255472740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255472740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255472740">(Sep 29 2021 at 20:55)</a>:</h4>
<p>Yeah, my point was that perhaps there's some other pathway the function declaration is created..</p>



<a name="255472889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255472889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255472889">(Sep 29 2021 at 20:56)</a>:</h4>
<p>best way to find that out would be IMO placing a <code>if name.starts_with("__rust_alloc") { bpkt(); }</code> in the LLVMRustGetOrInsertFunction (or an equivalent breakpoint in a debugger)</p>



<a name="255472902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255472902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255472902">(Sep 29 2021 at 20:56)</a>:</h4>
<p>and then looking at the stack trace.</p>



<a name="255475486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255475486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255475486">(Sep 29 2021 at 21:12)</a>:</h4>
<p>Okay, I think I figured this out by bugging tmandry a bit. It looks like I should add new <code>#[rustc_deallocator]</code> and <code>#[rustc_allocator]</code> attributes that we can then wire up to <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/collect.rs#L2753">emit the right stuff in rustc_typecheck</a>, but I think that means this takes two steps, where I do the first part and then wait for the new attributes to be in the bootstrap compiler?</p>



<a name="255476269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255476269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255476269">(Sep 29 2021 at 21:16)</a>:</h4>
<p>The attribute can be applied conditionally: <code>#[cfg_attr(not(bootstrap), rustc_allocator)]</code></p>



<a name="255476494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255476494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255476494">(Sep 29 2021 at 21:18)</a>:</h4>
<p>indeed, thanks</p>



<a name="255479575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255479575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255479575">(Sep 29 2021 at 21:40)</a>:</h4>
<p>That's… not necessarily true. Make sure to know where the declarations are created first. Then look at the surrounding code to see what data is consumed.</p>



<a name="255479915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255479915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255479915">(Sep 29 2021 at 21:42)</a>:</h4>
<p>Like you could probably already try setting some attributes here: <a href="https://github.com/rust-lang/rust/blob/11491938f80988c7261a1179cf71a25c379c8783/compiler/rustc_codegen_llvm/src/attributes.rs#L286-L288">https://github.com/rust-lang/rust/blob/11491938f80988c7261a1179cf71a25c379c8783/compiler/rustc_codegen_llvm/src/attributes.rs#L286-L288</a></p>



<a name="255480393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255480393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255480393">(Sep 29 2021 at 21:46)</a>:</h4>
<p>I think the reason why working around the <code>allocator.rs</code> didn't help you is because its for implementation of the allocation functions, not the declaration.</p>



<a name="255480426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255480426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255480426">(Sep 29 2021 at 21:46)</a>:</h4>
<p>from what I can tell, anyway.\</p>



<a name="255485495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255485495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255485495">(Sep 29 2021 at 22:24)</a>:</h4>
<p>Yeah that seems to line up. Adding the new attributes definitely seems to be working, now I'm struggling to get the <code>allocator(N)</code> argument set up right, as the string version of the API is producing IR that looks wrong</p>



<a name="255486384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255486384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255486384">(Sep 29 2021 at 22:32)</a>:</h4>
<p>Is there a convenient way to get the stage0 compiler in a debugger for one of the stage1 compile actions? I'm hitting an LLVM assertion and I can't figure out what I've done wrong</p>



<a name="255487396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255487396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255487396">(Sep 29 2021 at 22:41)</a>:</h4>
<p><a href="https://github.com/durin42/rust/commit/8c3336c508893e45c87b3bb188cc3df5fe55ffef">https://github.com/durin42/rust/commit/8c3336c508893e45c87b3bb188cc3df5fe55ffef</a> is where we are now, I have to stop and eat etc. The issue is that the attempt to do <code>Attribute::Allocator.apply_llfn_with_value(llvm::AttributePlace::Function, llfn, 1);</code> in <code>attributes.rs</code> hits an assertion that implies we didn't pass a value, but I don't see how that could be. Either I'm missing something silly like a typo or bad enum conversion, or I need a debugger.</p>



<a name="255488427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255488427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255488427">(Sep 29 2021 at 22:51)</a>:</h4>
<p>--verbose should print the failing commands and the necessary envvars I believe.</p>



<a name="255488741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255488741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255488741">(Sep 29 2021 at 22:54)</a>:</h4>
<p>I wonder if the attribute problem you'll have will be in the fact that <code>"attribute"="value"</code> is distinct from <code>"attribute(N)"</code>.</p>



<a name="255488971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255488971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255488971">(Sep 29 2021 at 22:56)</a>:</h4>
<p>Ah, looks like you're covering that.</p>



<a name="255490749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255490749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255490749">(Sep 29 2021 at 23:13)</a>:</h4>
<p>worse, <code>"attribute(N)"</code> is distinct from <code>attribute(N)</code> (I already tried that)</p>



<a name="255490824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255490824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255490824">(Sep 29 2021 at 23:14)</a>:</h4>
<p>verbose appears to give me the CLI but not the environment vars?</p>



<a name="255491111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491111">(Sep 29 2021 at 23:17)</a>:</h4>
<p>My suggestion would be to construct a minimal <code>#[no_core]</code> <code>test.rs</code> that has the allocations you want to test and then just try and build it with <code>./build/$target/stage1/bin/rustc</code>.</p>



<a name="255491123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491123">(Sep 29 2021 at 23:17)</a>:</h4>
<p>that's one way.</p>



<a name="255491217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491217">(Sep 29 2021 at 23:18)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/pull/82403">https://github.com/rust-lang/rust/pull/82403</a> for printing out the envvars.</p>



<a name="255491309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491309">(Sep 29 2021 at 23:19)</a>:</h4>
<p>I don't have a stage1 yet, stage0 is dying</p>



<a name="255491444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491444">(Sep 29 2021 at 23:20)</a>:</h4>
<p>stage nomenclature is confusing, but IIRC stage0 std build is using stage1 rustc to produce stage1 libstd.</p>



<a name="255491592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491592">(Sep 29 2021 at 23:22)</a>:</h4>
<p>/me runs a ./x.py build --stage=1 to see the output again.</p>



<a name="255491893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491893">(Sep 29 2021 at 23:25)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    Finished dev [unoptimized + debuginfo] target(s) in 0.13s
Building stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
    Finished release [optimized] target(s) in 0.13s
Copying stage0 std from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Building stage0 compiler artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
    Finished release [optimized] target(s) in 0.20s
Copying stage0 rustc from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Assembling stage1 compiler (x86_64-unknown-linux-gnu)
Building stage1 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
   Compiling std v0.0.0 (/usr/local/google/home/augie/Programming/big/rust/library/std)
</code></pre></div>



<a name="255491898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255491898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255491898">(Sep 29 2021 at 23:25)</a>:</h4>
<p>that's how far I get before it dies</p>



<a name="255492023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255492023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255492023">(Sep 29 2021 at 23:27)</a>:</h4>
<p>ahh, <code>-vv</code>for extra verbosity</p>



<a name="255492088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255492088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255492088">(Sep 29 2021 at 23:27)</a>:</h4>
<p>Them off-by-ones, eh.</p>



<a name="255493216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255493216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255493216">(Sep 29 2021 at 23:39)</a>:</h4>
<p>blah. I can't figure out how to get in there in a debugger, but I've started doing fopen();fprintf() debugging and the values are what I loosely expect, so that's upsetting</p>



<a name="255500007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255500007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255500007">(Sep 30 2021 at 00:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions/near/255491444">said</a>:</p>
<blockquote>
<p>stage nomenclature is confusing, but IIRC stage0 std build is using stage1 rustc to produce stage1 libstd.</p>
</blockquote>
<p><code>build --stage 0 library/std</code> builds libstds using beta and does not build the compiler at all. <code>build --stage 1 library/std</code> first builds the compiler, then builds libstd with that newly built compiler. There's not a command to only build the compiler.</p>



<a name="255500023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255500023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255500023">(Sep 30 2021 at 00:51)</a>:</h4>
<p><a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#understanding-stages-of-bootstrap">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#understanding-stages-of-bootstrap</a></p>



<a name="255501841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255501841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255501841">(Sep 30 2021 at 01:14)</a>:</h4>
<p>I'm finally at the point of having rustc cracked open in lldb, but it looks like there's no debug symbols (eg no links to lines of code) and some optimizations (some functions appear to have been inlined?) - any specific config.toml tricks I should be deploying here? I've already disabled optimizations for rustc_codegen_llvm but that didn't get me the links to code I was hoping for...</p>



<a name="255503402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255503402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255503402">(Sep 30 2021 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="316805">@durin42</span> debug = true</p>



<a name="255503421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255503421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255503421">(Sep 30 2021 at 01:37)</a>:</h4>
<p>If you want local variables, debuginfo-level = 2, but it uses a metric ton of disk space</p>



<a name="255503438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255503438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255503438">(Sep 30 2021 at 01:37)</a>:</h4>
<p>thanks! Looks like I found the problem - I need to extend AttrBuilder in LLVM to understand the new integer-bearing attributes</p>



<a name="255607580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255607580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255607580">(Sep 30 2021 at 16:50)</a>:</h4>
<p>I've got this working and passing rustc's codegen tests about allocations optimizing away! Now for the second 90% of the work, wherein I find out what else needs to be in my LLVM patch to get accepted there.</p>



<a name="255609538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/upstreaming%20LLVM%20patch%20for%20__rust_%20alloc%20functions/near/255609538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/upstreaming.20LLVM.20patch.20for.20__rust_.20alloc.20functions.html#255609538">(Sep 30 2021 at 17:01)</a>:</h4>
<p>Please add me as a reviewer or subscriber when you submit a diff.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>