<html>
<head><meta charset="utf-8"><title>HIR hash for coverage · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html">HIR hash for coverage</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257761402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257761402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257761402">(Oct 15 2021 at 20:36)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="296355">@Rich Kadel</span>. I saw that MIR coverage markers require hashing the HIR body. Could you explain the rationale behind this hashing? Why does it need to ignore spans? (I'm trying to find a way to get rid of this hashing by reusing a previously computed HIR hash.)</p>



<a name="257766639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257766639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257766639">(Oct 15 2021 at 21:19)</a>:</h4>
<p>The spec for LLVM coverage requires some kind of hash to distinguish logic changes.</p>



<a name="257766836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257766836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257766836">(Oct 15 2021 at 21:20)</a>:</h4>
<p>(off the top of my head I don't remember if LLVM docs explained how that hash is used, but I can imagine, for instance, diff'ing coverage between two versions of the same function. There could be optimization opportunities as well, perhaps, but diff'ing is probably the more useful reason.)</p>



<a name="257766879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257766879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257766879">(Oct 15 2021 at 21:21)</a>:</h4>
<p>I don't think changing spacing or comments should matter</p>



<a name="257774340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257774340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257774340">(Oct 15 2021 at 22:23)</a>:</h4>
<p>But, just thinking about this, maybe I had this wrong. Perhaps I need to change the hash even if only for spaces and comments.</p>



<a name="257774462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257774462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257774462">(Oct 15 2021 at 22:24)</a>:</h4>
<p>Because the coverage results point to specific locations (line and column) in the code. If the locations change, the results would be wrong anyway, right?</p>



<a name="257777145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/257777145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#257777145">(Oct 15 2021 at 22:51)</a>:</h4>
<p>I think so, yes. If you need to hash line &amp; columns, I will have to handle it properly in -Zincremental-relative-spans mode.</p>



<a name="258221056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258221056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258221056">(Oct 19 2021 at 15:58)</a>:</h4>
<p>cc: <span class="user-mention" data-user-id="330205">@Arpad Borsos</span> <span class="user-mention" data-user-id="116883">@tmandry</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span></p>



<a name="258224070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258224070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258224070">(Oct 19 2021 at 16:14)</a>:</h4>
<p>I think a hash that changes on any source change to the function is probably OK and possibly better, since code coverage results assume the covered code does not change positions within the source file (line and column are stable for the start and end of the span). </p>
<p>I'm not familiar with what <code>-Zincremental-relative-spans</code> will do, but I don't expect you to hash specific line &amp; column.</p>
<p>As long as the hash changes if the source of the function changes (including adding or removing white space or comments), that's probably at least as good as what I'm doing now.</p>



<a name="258264614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258264614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258264614">(Oct 19 2021 at 20:16)</a>:</h4>
<p>I seem to remember thinking that coverage could be compared on two binaries with different spans, because the regions wouldn't have changed (only the source mapping)</p>



<a name="258264771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258264771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258264771">(Oct 19 2021 at 20:17)</a>:</h4>
<p>and this is on a per-function basis, so this is information that tooling could make frequent use of, in theory</p>



<a name="258264802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258264802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258264802">(Oct 19 2021 at 20:17)</a>:</h4>
<p>I don't know if any tooling actually does that or not</p>



<a name="258265119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258265119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258265119">(Oct 19 2021 at 20:19)</a>:</h4>
<p>changing the hash iff the source of that function changes is not going to regress any existing use case that I know of</p>



<a name="258265315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258265315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258265315">(Oct 19 2021 at 20:21)</a>:</h4>
<p>and would preserve at least some of the usefulness of being able to do comparisons of coverage between different binaries</p>



<a name="258265427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/HIR%20hash%20for%20coverage/near/258265427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/HIR.20hash.20for.20coverage.html#258265427">(Oct 19 2021 at 20:22)</a>:</h4>
<p>most of it, even. most people know that if they only changed comments they don't need to worry about code coverage changes, even if the tooling doesn't know that</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>