<html>
<head><meta charset="utf-8"><title>codegen upstreaming requirements · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html">codegen upstreaming requirements</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258325792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258325792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258325792">(Oct 20 2021 at 07:45)</a>:</h4>
<p>This isn't a question of whether rustc can be legally combined with it; it's a question of policy for targets merged into the upstream compiler.</p>



<a name="258325822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258325822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258325822">(Oct 20 2021 at 07:45)</a>:</h4>
<p>And that policy is based on the ability to maintain, debug, and otherwise work with the target.</p>



<a name="258326468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258326468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258326468">(Oct 20 2021 at 07:52)</a>:</h4>
<p>gutting good support for a target used by tens of thousands of developers, companies, and projects in multiple ecosystems for potential concern over unmaintainability (which is a valid concern) seems unwise, especially considering libnvvm is already battle tested, receptive to bugs, and open to temporary workarounds for things that dont work. Besides, by this proposal, people would be able to freely switch to something like the LLVM PTX backend if thats a concern, although it will probably never be as reliable as libnvvm or as well supported as a codegen which is designed around it. At some point i think the risk is worth taking considering absolutely nobody is currently seriously using rust for nvptx, because again, its completely broken</p>



<a name="258326573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258326573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258326573">(Oct 20 2021 at 07:52)</a>:</h4>
<p>Choosing to support a proprietary target is a tradeoff. You're listing the upsides.</p>



<a name="258326626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258326626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258326626">(Oct 20 2021 at 07:53)</a>:</h4>
<p>And if people continue ignoring the LLVM ptx target and deciding that any serious work has to use libnvvm, that's a self-fulfilling prophecy.</p>



<a name="258326775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258326775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258326775">(Oct 20 2021 at 07:55)</a>:</h4>
<p>The biggest downside of supporting such a target isn't just the maintenance of that target itself.</p>



<a name="258326903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258326903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258326903">(Oct 20 2021 at 07:56)</a>:</h4>
<p>The biggest downside is opening the floodgates for <em>other</em> such targets. For instance, "oh, if it's OK to have a proprietary codegen backend, then here's my target for a new CPU, that requires a custom fork of LLVM that's only shipped in binary form, we don't provide any open toolchain for targeting this CPU".</p>



<a name="258327007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327007">(Oct 20 2021 at 07:57)</a>:</h4>
<p>I do not disagree with you in saying its a risk, a risk that we may not be able to fix certain bugs, but i think you are disregarding that:</p>
<ul>
<li>there are ways of working around bugs, and thats already done a LOT, just ripgrep for it in cg_llvm, i dont see why libnvvm should be held to a higher standard, its not like rustc devs go directly to llvm to fix a bug themselves if they find it.</li>
<li>The upsides of making rust a great language for gpu computing outweigh the negatives, there are plenty of companies and individuals interested in such a thing, i am currently working with a VFX supervisor on adding OptiX support for this exact reason</li>
<li>libnvvm is not a library used by nobody, its used in nvcc, numba, julia GPU, etc, it is battle tested. Thats not to say it doesn't have bugs, but its very unlikely to have a miscompilation, and nvidia is (in my experience) pretty receptive to bugs in it</li>
</ul>



<a name="258327008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327008">(Oct 20 2021 at 07:57)</a>:</h4>
<p>That's the primary reason for the written requirement that we don't support targets requiring proprietary bits in order to do code generation.</p>



<a name="258327134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327134">(Oct 20 2021 at 07:58)</a>:</h4>
<p>We wouldn't be holding libnvvm to a higher standard, we'd be holding it to the <em>same</em> standard: must be open.</p>



<a name="258327139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327139">(Oct 20 2021 at 07:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258326903">said</a>:</p>
<blockquote>
<p>The biggest downside is opening the floodgates for <em>other</em> such targets. For instance, "oh, if it's OK to have a proprietary codegen backend, then here's my target for a new CPU, that requires a custom fork of LLVM that's only shipped in binary form, we don't provide any open toolchain for targeting this CPU".</p>
</blockquote>
<p>It doesnt have to be black and white, adding a target used by a couple of projects/companies is far less important than adding support for a gigantic ecosystem</p>



<a name="258327210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327210">(Oct 20 2021 at 07:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258327139">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258326903">said</a>:</p>
<blockquote>
<p>The biggest downside is opening the floodgates for <em>other</em> such targets. For instance, "oh, if it's OK to have a proprietary codegen backend, then here's my target for a new CPU, that requires a custom fork of LLVM that's only shipped in binary form, we don't provide any open toolchain for targeting this CPU".</p>
</blockquote>
<p>It doesnt have to be black and white, adding a target used by a couple of projects/companies is far less important than adding support for a gigantic ecosystem</p>
</blockquote>
<p>Right, and the hypothetical CPU target might be an even larger ecosystem. Suppose it were the Apple M1, for instance.</p>



<a name="258327349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327349">(Oct 20 2021 at 08:00)</a>:</h4>
<p>rust can already compile to m1 just fine AFAIK, what it can't do is any kind of serious gpu computing</p>



<a name="258327459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327459">(Oct 20 2021 at 08:01)</a>:</h4>
<p>I think you skipped over the point there. I'm saying, suppose a new CPU came along, something as large as the Apple M1 (there are lots of custom CPUs being developed now), and the CPU vendor said the only supported way to build for their CPU was a proprietary fork of LLVM.</p>



<a name="258327476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327476">(Oct 20 2021 at 08:01)</a>:</h4>
<p>Down that path lies a lack of any open compilers at all.</p>



<a name="258327527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327527">(Oct 20 2021 at 08:01)</a>:</h4>
<p>I think this is an unrealistic slippery slope</p>



<a name="258327584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327584">(Oct 20 2021 at 08:02)</a>:</h4>
<p>I think it's an <em>extremely</em> realistic scenario that has happened in the past and will happen again.</p>



<a name="258327691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327691">(Oct 20 2021 at 08:03)</a>:</h4>
<p>CPU vendors already push proprietary compilers with custom optimizations that they don't share. The only reason it's not a more widespread problem is that there aren't many completely custom architectures out there (e.g. Apple M1 is ARM with custom extensions, not a completely custom architecture), so it's possible to support them even without the CPU vendor's assistance.</p>



<a name="258327730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327730">(Oct 20 2021 at 08:03)</a>:</h4>
<p>In the past, when far more CPU architectures existed, CPU vendors were even more protective of the ability to build compilers for "their" platform.</p>



<a name="258327825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327825">(Oct 20 2021 at 08:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258327007">said</a>:</p>
<blockquote>
<p>I do not disagree with you in saying its a risk, a risk that we may not be able to fix certain bugs, but i think you are disregarding that:</p>
<ul>
<li>there are ways of working around bugs, and thats already done a LOT, just ripgrep for it in cg_llvm, i dont see why libnvvm should be held to a higher standard, its not like rustc devs go directly to llvm to fix a bug themselves if they find it.</li>
</ul>
</blockquote>
<p>They do. Look at these for example: <a href="https://reviews.llvm.org/D111276">https://reviews.llvm.org/D111276</a> <a href="https://reviews.llvm.org/D111681">https://reviews.llvm.org/D111681</a> <a href="https://reviews.llvm.org/D111493">https://reviews.llvm.org/D111493</a></p>



<a name="258327826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327826">(Oct 20 2021 at 08:04)</a>:</h4>
<p>rustc is not copyleft, and nothing stops you from building a fork of it that links to proprietary code generation libraries. This is a question of what policy we should apply for accepting and supporting new targets upstream.</p>



<a name="258327900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327900">(Oct 20 2021 at 08:04)</a>:</h4>
<p>Building a fork of rustc would just reinvent nvcc and make the problem even worse</p>



<a name="258327954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258327954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258327954">(Oct 20 2021 at 08:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258327900">said</a>:</p>
<blockquote>
<p>Building a fork of rustc would just reinvent nvcc and make the problem even worse</p>
</blockquote>
<p>I agree entirely. I just said "nothing stops you"; I wasn't suggesting you <em>should</em>, or that it'd be a good idea.</p>



<a name="258328050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328050">(Oct 20 2021 at 08:06)</a>:</h4>
<p>I mean yeah i agree that slippery slope <em>is</em> a problem, but i don't think it is such a big problem that it should stop rust from expanding into big fields like gpu computing</p>



<a name="258328083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328083">(Oct 20 2021 at 08:06)</a>:</h4>
<p>From my perspective, "rust has great support for non-proprietary GPUs, and poor support for nvidia GPUs" is a perfectly acceptable outcome.</p>



<a name="258328109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328109">(Oct 20 2021 at 08:06)</a>:</h4>
<p>And one way to fix that would be to contribute to the LLVM backend, or write a new one.</p>



<a name="258328118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328118">(Oct 20 2021 at 08:06)</a>:</h4>
<p>besides, the codegen <em>could</em> potentially in the future expand to just be an llvm-gpu codegen that targets generic gpu-friendly LLVM IR, although this is unlikely</p>



<a name="258328185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328185">(Oct 20 2021 at 08:07)</a>:</h4>
<p>You made the comment elsewhere that reworking the LLVM ptx backend to be good enough would require turning it into a clone of libnvvm, and you seemed to see that as an argument for just using libnvvm. But an Open Source clone of libnvvm would be a <em>good</em> outcome.</p>



<a name="258328216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328216">(Oct 20 2021 at 08:07)</a>:</h4>
<p>Well the truth of the matter is AMD is absolutely horrific to target through LLVM, the only reason i was able to do this was that libnvvm is a thing that works</p>



<a name="258328313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328313">(Oct 20 2021 at 08:08)</a>:</h4>
<p>Well i also learned a lot of things since then, and i still think that using libnvvm is 100x less work than making llvm work and be on the same level of optimization and reliability as libnvvm</p>



<a name="258328317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328317">(Oct 20 2021 at 08:08)</a>:</h4>
<p>I'm not a GPU expert; I can't speak to the quality of either the AMD or NVIDIA backends for LLVM. I know I've seen people use the AMD backend successfully, and I know it's being actively worked on and used by things like Mesa.</p>



<a name="258328346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328346">(Oct 20 2021 at 08:08)</a>:</h4>
<p>There is a difference between using in small examples that are painful to build and serious projects</p>



<a name="258328350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328350">(Oct 20 2021 at 08:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258328313">said</a>:</p>
<blockquote>
<p>Well i also learned a lot of things since then, and i still think that using libnvvm is 100x less work than making llvm work and be on the same level of optimization and reliability as libnvvm</p>
</blockquote>
<p>Does that 100x take into account being able to upstream one backend and having to maintain a fork for the other?</p>



<a name="258328391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328391">(Oct 20 2021 at 08:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258328346">said</a>:</p>
<blockquote>
<p>There is a difference between using in small examples that are painful to build and serious projects</p>
</blockquote>
<p>I would consider Mesa a serious project.</p>



<a name="258328401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328401">(Oct 20 2021 at 08:09)</a>:</h4>
<p>CUDA is not just libnvvm and some PTX, cuda is a gigantic ecosystem of libraries and driver api features</p>



<a name="258328532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328532">(Oct 20 2021 at 08:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258328401">said</a>:</p>
<blockquote>
<p>CUDA is not just libnvvm and some PTX, cuda is a gigantic ecosystem of libraries and driver api features</p>
</blockquote>
<p>I'm aware, and I consider that unfortunate and disappointing. I'll continue to cheer on the competing GPU vendors trying to build open standards. But regardless, a rustc backend that targets CUDA is entirely possible, and even upstreamable, as long as it doesn't use a proprietary codegen library.</p>



<a name="258328604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328604">(Oct 20 2021 at 08:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258328350">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258328313">said</a>:</p>
<blockquote>
<p>Well i also learned a lot of things since then, and i still think that using libnvvm is 100x less work than making llvm work and be on the same level of optimization and reliability as libnvvm</p>
</blockquote>
<p>Does that 100x take into account being able to upstream one backend and having to maintain a fork for the other?</p>
</blockquote>
<p>Libnvvm has very rarely been the bottleneck in trying to get my project to work, its actually usually been either LLVM or rustc itself. I would consider libnvvm mostly easy to work with, good luck trying to get the LLVM PTX backend to build on windows</p>



<a name="258328855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328855">(Oct 20 2021 at 08:13)</a>:</h4>
<p>There is also a reason that almost all projects use nvcc and not clang for building their CUDA code, libnvvm is simply more reliable, its been battle tested for years, and it can keep compatability for things like compute capabilities much better than something which is mostly guessing</p>



<a name="258328988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258328988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258328988">(Oct 20 2021 at 08:14)</a>:</h4>
<p>I dont like libnvvm/cuda not being open just as much as the next person, but cuda is simply the best tool we have for GPU computing, and i think support for it that matches and exceeds CUDA C++ is a great next step for rust</p>



<a name="258329044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329044">(Oct 20 2021 at 08:14)</a>:</h4>
<p>That sounds like a very good argument for making the case to either improve LLVM's CUDA support or convince NVIDIA to release/upstream more of their tooling.</p>



<a name="258329201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329201">(Oct 20 2021 at 08:16)</a>:</h4>
<p>Well that hasn't really worked out for many projects, if it did, then i wouldn't have needed to start my project in the first place, or other projects like numba having to use libnvvm</p>



<a name="258329267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329267">(Oct 20 2021 at 08:17)</a>:</h4>
<p>I'm <em>much</em> more concerned with Rust's sustainability and long-term prospects than I am about its popularity in one specific field.</p>



<a name="258329288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329288">(Oct 20 2021 at 08:17)</a>:</h4>
<p>And the target policy was written with that in mind.</p>



<a name="258329353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329353">(Oct 20 2021 at 08:17)</a>:</h4>
<p>What is preventing rust from long term swapping out libnvvm for the LLVM PTX backend if it turns out to work on the same level? There is nothing saying we are permanently stuck with libnvvm if we adopt this</p>



<a name="258329402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329402">(Oct 20 2021 at 08:18)</a>:</h4>
<p>What is preventing it from using LLVM in the first place?</p>



<a name="258329424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329424">(Oct 20 2021 at 08:18)</a>:</h4>
<p>"Oh, we could use the Open Source backend if it got good enough" sounds like a great recipe for never investing anything into making it good enough.</p>



<a name="258329522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329522">(Oct 20 2021 at 08:19)</a>:</h4>
<p>If it can be made good enough, then it can be made good enough before upstreaming support for it. If it can't, then let's not pretend it can as a way of getting a different backend upstream.</p>



<a name="258329537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329537">(Oct 20 2021 at 08:19)</a>:</h4>
<p>optimizations not on the same level, compatability for compute capabilities not matching, not as reliable as libnvvm, lack of features like lazy loading (which is massively helpful on the gpu)</p>



<a name="258329646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329646">(Oct 20 2021 at 08:20)</a>:</h4>
<p>That sounds like a clear list of differences. It doesn't address any of the actual reasons for this policy.</p>



<a name="258329716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329716">(Oct 20 2021 at 08:21)</a>:</h4>
<p>The amount of people who:</p>
<ul>
<li>are deeply familiar with llvm</li>
<li>dont like closed source stuff enough to not use libnvvm</li>
<li>are deeply familiar with cuda internals</li>
</ul>
<p>is basically next to zero</p>



<a name="258329742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329742">(Oct 20 2021 at 08:21)</a>:</h4>
<p>The relevant number of people is "Rust users and developers", not "CUDA developers who are not yet Rust users".</p>



<a name="258329770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329770">(Oct 20 2021 at 08:21)</a>:</h4>
<p>Rust users are Rust users, not LLVM C++ users</p>



<a name="258329843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329843">(Oct 20 2021 at 08:22)</a>:</h4>
<p>You're not going to be successful arguing against a policy without taking into account the reasons for the policy. Whether you care about those reasons or not, other people do, and the policy was written for a reason.</p>



<a name="258329890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329890">(Oct 20 2021 at 08:22)</a>:</h4>
<p>I am taking into account those reasons, i think the concerns are valid but outweighed by the benefits</p>



<a name="258329943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329943">(Oct 20 2021 at 08:23)</a>:</h4>
<p>And every single person arguing for a proprietary backend will always feel the benefits of their new backend outweigh the problems.</p>



<a name="258329984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258329984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258329984">(Oct 20 2021 at 08:23)</a>:</h4>
<p>And even if that <em>were</em> true for that one backend, which may or may not be the case, part of the problem is that there'd be dozens more right behind it citing the precedent.</p>



<a name="258330076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330076">(Oct 20 2021 at 08:24)</a>:</h4>
<p>To get rust to be reliable in gpu computing using the LLVM PTX backend would mean youd need to get someone who is wiling to do this and is deeply familiar with every part of the stack, rustc, llvm, and PTX. That is well, i think thats literally nobody</p>



<a name="258330123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330123">(Oct 20 2021 at 08:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258330076">said</a>:</p>
<blockquote>
<p>To get rust to be reliable in gpu computing using the LLVM PTX backend would mean youd need to get someone who is wiling to do this and is deeply familiar with every part of the stack, rustc, llvm, and PTX. That is well, i think thats literally nobody</p>
</blockquote>
<p>You seem to be taking it as a given that there should be an "and therefore we should compromise in order to get a CUDA backend" after that.</p>



<a name="258330140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330140">(Oct 20 2021 at 08:24)</a>:</h4>
<p>Rather than "and that's why we don't support CUDA".</p>



<a name="258330197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330197">(Oct 20 2021 at 08:25)</a>:</h4>
<p>As far as I can tell, you have all the relevant skills except for "willing to do this". ;)</p>



<a name="258330202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330202">(Oct 20 2021 at 08:25)</a>:</h4>
<p>No i am explaining why my project exists and other projects that try to do it with the LLVM PTX backend don't</p>



<a name="258330316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330316">(Oct 20 2021 at 08:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258330197">said</a>:</p>
<blockquote>
<p>As far as I can tell, you have all the relevant skills except for "willing to do this". ;)</p>
</blockquote>
<p>I dont think i could be paid enough to debug issues in C++ tools, especially LLVM. I am familiar with rustc and the PTX ISA to a decent degree but basically nothing in how LLVM works</p>



<a name="258330353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330353">(Oct 20 2021 at 08:26)</a>:</h4>
<blockquote>
<p>I dont think i could be paid enough to debug issues in C++ tools, especially LLVM.</p>
</blockquote>
<p>You have my complete and total sympathy on that front.</p>



<a name="258330370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330370">(Oct 20 2021 at 08:26)</a>:</h4>
<p>I'd still rather debug a C++ tool than a binary I have no source for, though. ;)</p>



<a name="258330390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330390">(Oct 20 2021 at 08:27)</a>:</h4>
<p>But all else being equal, I'll happily avoid both.</p>



<a name="258330436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330436">(Oct 20 2021 at 08:27)</a>:</h4>
<p>You could always add support to one of the Rust code generation projects, like cranelift; then you wouldn't have to touch C++ at all.</p>



<a name="258330538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330538">(Oct 20 2021 at 08:28)</a>:</h4>
<p>I have encountered 2 issues in libnvvm (that dont result in the verifier catching it):</p>
<ul>
<li>libnvvm doesnt like integers that are "irregular", i.e. not i1, i8, i16, i32, or i64. This was easily patched by using vector types and bitcasts.</li>
<li>libnvvm segfaults if you provide more than one module with debug info. This is well documented in the NVVM IR standard and it was my fault.</li>
</ul>



<a name="258330585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330585">(Oct 20 2021 at 08:28)</a>:</h4>
<p>Compared to the issues ive had to go through with llvm or rustc? libnvvm is an absolute pleasure to work with</p>



<a name="258330650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330650">(Oct 20 2021 at 08:29)</a>:</h4>
<p>"it's easy to work with" is still entirely orthogonal to the issue.</p>



<a name="258330695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330695">(Oct 20 2021 at 08:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258330436">said</a>:</p>
<blockquote>
<p>You could always add support to one of the Rust code generation projects, like cranelift; then you wouldn't have to touch C++ at all.</p>
</blockquote>
<p>Optimizations matter even more on the gpu, if we didn't have that we would just get laughed at for our kernels being 100x slower. This is __Especially__ important because noalias is extremely helpful for GPU code</p>



<a name="258330797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330797">(Oct 20 2021 at 08:30)</a>:</h4>
<p>/me personally hopes that one day MIR optimizations cover everything LLVM currently does.</p>



<a name="258330811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330811">(Oct 20 2021 at 08:30)</a>:</h4>
<p>(Though, of course, they're not to that point yet.)</p>



<a name="258330817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330817">(Oct 20 2021 at 08:30)</a>:</h4>
<p>FWIW, I'm not trying to be <em>gratuitously</em> difficult here. I'm trying to be clear on why we have this policy, what it's protecting against, and ways to potentially address it.</p>



<a name="258330865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258330865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258330865">(Oct 20 2021 at 08:31)</a>:</h4>
<p>Yeah and i totally understand, but i just dont think they are as big of an issue as you think they are</p>



<a name="258331007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331007">(Oct 20 2021 at 08:32)</a>:</h4>
<p>I understand the case you're making. And I appreciate the frustration. I <em>have</em> been in the position of "there's no technical reason against this, why can't the policy change" before.</p>



<a name="258331013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331013">(Oct 20 2021 at 08:32)</a>:</h4>
<p>Based on the discussions that happened when the policy was written, "but this backend/target is really important" is not likely to be a successful argument.</p>



<a name="258331048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331048">(Oct 20 2021 at 08:32)</a>:</h4>
<p>The policy was written the way it was <em>because</em> we expected arguments of the form "but this backend/target is really important".</p>



<a name="258331069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331069">(Oct 20 2021 at 08:33)</a>:</h4>
<p>But i don't think we will ever find someone who would be wiling to sink hundreds of hours of work into the LLVM PTX backend to make it match libnvvm AND be wiling to make a usable rustc backend AND be wiling to make gpu-side crates that work with the backend</p>



<a name="258331108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331108">(Oct 20 2021 at 08:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258331069">said</a>:</p>
<blockquote>
<p>But i don't think we will ever find someone who would be wiling to sink hundreds of hours of work into the LLVM PTX backend to make it match libnvvm AND be wiling to make a usable rustc backend AND be wiling to make gpu-side crates that work with the backend</p>
</blockquote>
<p>If that's the case, then it sounds like we won't have upstream CUDA support.</p>



<a name="258331189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331189">(Oct 20 2021 at 08:34)</a>:</h4>
<p>Aren't some of those pieces independent and could be attacked by separate developers?</p>



<a name="258331249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331249">(Oct 20 2021 at 08:34)</a>:</h4>
<p>Yes but the pool of people who are wiling to work on the LLVM PTX backend is low enough already</p>



<a name="258331286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331286">(Oct 20 2021 at 08:35)</a>:</h4>
<p>That's still a weaker argument than saying that it takes a single person which doesn't exist.</p>



<a name="258331315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331315">(Oct 20 2021 at 08:35)</a>:</h4>
<p>As an aside, there seems to be a GCC PTX backend as well.</p>



<a name="258331331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331331">(Oct 20 2021 at 08:35)</a>:</h4>
<p>I don't know its quality, either.</p>



<a name="258331353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331353">(Oct 20 2021 at 08:35)</a>:</h4>
<p>You need a rustc backend that can make gpu friendly IR, targetting a ptx backend isnt enough</p>



<a name="258331418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331418">(Oct 20 2021 at 08:36)</a>:</h4>
<p>you can start with a bad one and improve it</p>



<a name="258331460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331460">(Oct 20 2021 at 08:36)</a>:</h4>
<p>especially since a lot of cuda things need explicit handling in the codegen</p>



<a name="258331545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331545">(Oct 20 2021 at 08:37)</a>:</h4>
<p>I mean, as someone who has done it, its a tremendous amount of work, and it would probably be even worse with gcc because of the issues that cg_gcc is going through with cg_ssa</p>



<a name="258331621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331621">(Oct 20 2021 at 08:38)</a>:</h4>
<p>and debugging who's fault (rustc or gcc) it is that code is miscompiling would be a nightmare</p>



<a name="258331659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331659">(Oct 20 2021 at 08:38)</a>:</h4>
<p>FWIW, I think you've made a <em>very</em> effective case that there should be a GPU-specific backend, and potentially even a CUDA-specific backend if a general GPU backend can't easily be made to target various GPU architectures.</p>



<a name="258331698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331698">(Oct 20 2021 at 08:38)</a>:</h4>
<p>Oh absolutely, and ive effectively done that, it just uses libnvvm because its the best option</p>



<a name="258331729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331729">(Oct 20 2021 at 08:39)</a>:</h4>
<p>but it wouldnt be impossible to make it abstract over the llvm ptx backend or whatever in the future</p>



<a name="258331827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331827">(Oct 20 2021 at 08:39)</a>:</h4>
<p>but the thing is, in my experience, every single backend will have a phase of "oh my god why is this thing {segfaulting|miscompiling|asserting}", and that is a solid couple months of debugging to get it to be kind of usable</p>



<a name="258331974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258331974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258331974">(Oct 20 2021 at 08:41)</a>:</h4>
<p>and this doesn't even factor in miscompilation or errors inside of the backend itself, i was lucky because libnvvm doesnt really miscompile much, but i know things like amdgpu have so many odd things that cause them to break</p>



<a name="258332207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258332207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258332207">(Oct 20 2021 at 08:42)</a>:</h4>
<p>and NVVM IR and llvm are not the same thing, NVVM doesnt like some things, but the LLVM PTX backend will miscompile if you use some things (instead of documenting what is and isnt allowed), which is why libnvvm again is so good, because NVVM IR is formalized</p>



<a name="258332436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258332436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258332436">(Oct 20 2021 at 08:44)</a>:</h4>
<p>... and llvm doesnt have certain features like lazy loading which are essential for rust so you don't end up with 12mb ptx files</p>



<a name="258332539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258332539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258332539">(Oct 20 2021 at 08:45)</a>:</h4>
<p>which is also why libnvvm doesnt need LTO, because it loads everything into a single module and optimizes it, so i can just lazy-load dependencies and end up with a relatively tiny, hyper-optimized PTX file that doesnt even need LTO</p>



<a name="258408863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258408863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258408863">(Oct 20 2021 at 17:28)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> After looking at the LLVM PTX backend, it seems like they explicitly designed it so that its compatible with NVVM IR, so it may possibly work, but the concern i have is that i'd still like to have an option for users to use libnvvm over the LLVM PTX backend assuming that the codegen was upstreamed. Would you be wiling to upstream a backend which by default uses the LLVM PTX backend but also has an option to use libnvvm?</p>



<a name="258409019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258409019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258409019">(Oct 20 2021 at 17:28)</a>:</h4>
<p>especially since it seems to be lacking some intrinsics which i provide already, so i think id have to gate those off for just libnvvm somehow</p>



<a name="258410968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258410968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258410968">(Oct 20 2021 at 17:39)</a>:</h4>
<p>If libnvvm can't be upstreamed at all, then at least having the GPU LLVM IR part upstreamed would help a lot, since it would mean i don't need to do as much work in terms of keeping track of breakage in cg_ssa every week. And the GPU LLVM IR backend could then be leveraged by an LLVM PTX codegen backend, and my libnvvm backend. So the hard part still gets upstreamed, we have an upstreamed way of generating ptx code (that hopefully works), and we still have the option for users to use libnvvm (albeit not upstreamed so prob uglier to use)</p>



<a name="258411668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258411668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258411668">(Oct 20 2021 at 17:44)</a>:</h4>
<p>So essentially:</p>
<ul>
<li>(upstream) rustc_codegen_gpu: just acts as a middleman generating LLVM IR that works on CUDA GPUs and offers interfaces to crates like cuda_std for implementing stuff like shared mem and stuff, also handles things like marking functions as gpu kernels.</li>
<li>(upstream) rustc_codegen_llvmptx: outputs PTX using the gpu codegen and the LLVM PTX backend</li>
<li>rustc_codegen_nvvm: outputs PTX using libnvvm, lowering the LLVM 13 IR given by the gpu codegen</li>
</ul>



<a name="258411895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258411895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258411895">(Oct 20 2021 at 17:45)</a>:</h4>
<p>then maybe in the future if the llvm ptx backend turns out to be just as good in basically all cases, the nvvm backend will be deprecated</p>



<a name="258413280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258413280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258413280">(Oct 20 2021 at 17:53)</a>:</h4>
<p>That path seems potentially viable. (Nit: if it's called <code>rustc_codegen_gpu</code> it should be a generic layer for all kinds of GPUs, similar to rust-gpu; if it only generates code for CUDA then it should be <code>rustc_codegen_cuda</code> or similar.)</p>



<a name="258413706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258413706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258413706">(Oct 20 2021 at 17:56)</a>:</h4>
<p>Yeah i couldnt think of a good name <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="258413723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258413723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258413723">(Oct 20 2021 at 17:56)</a>:</h4>
<p>That trio of projects otherwise seems fine.</p>



<a name="258413859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258413859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258413859">(Oct 20 2021 at 17:57)</a>:</h4>
<p>To answer your previous question, I'd be <em>nervous</em> about the idea of a "default LLVM, optional libnvvm" backend. I can imagine it working, but it'd need to have careful constraints like "must always pass the testsuite with LLVM, needs to be usefully viable with LLVM".</p>



<a name="258413871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258413871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258413871">(Oct 20 2021 at 17:57)</a>:</h4>
<p>great, after i release my project ill prob experiment with the llvm ptx backend a bit, id prob need to reimplement lazy loading because without it its kind of impossible to match libnvvm</p>



<a name="258414039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258414039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258414039">(Oct 20 2021 at 17:58)</a>:</h4>
<p>Wym be usefully viable with llvm?</p>



<a name="258414707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258414707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258414707">(Oct 20 2021 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258414039">said</a>:</p>
<blockquote>
<p>Wym be usefully viable with llvm?</p>
</blockquote>
<p>I mean that I'd be nervous about whether a backend that is designed for both LLVM and NVVM would have the LLVM portion languish from disuse or otherwise break without people noticing. The LLVM backend might not be optimal, but it would need to be <em>useful</em>.</p>



<a name="258414775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258414775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258414775">(Oct 20 2021 at 18:01)</a>:</h4>
<p>I would just like to have a way to fall back to libnvvm (which should be the reference of what the ptx should look like since its the most battle tested one) in case we find a weird miscompilation or bug in the llvm ptx backend we cant immediately solve</p>



<a name="258414848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258414848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258414848">(Oct 20 2021 at 18:02)</a>:</h4>
<p>(In other words, it'd need to be useful enough to justify the target by itself, because the NVVM alternative doesn't add weight to the target's justification.)</p>



<a name="258414919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258414919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258414919">(Oct 20 2021 at 18:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258414775">said</a>:</p>
<blockquote>
<p>I would just like to have a way to fall back to libnvvm (which should be the reference of what the ptx should look like since its the most battle tested one) in case we find a weird miscompilation or bug in the llvm ptx backend we cant immediately solve</p>
</blockquote>
<p>Sure, I get that. And I can even see that being useful for people doing LLVM development, so that they can compare and optimize.</p>



<a name="258415031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258415031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258415031">(Oct 20 2021 at 18:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258414707">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/258414039">said</a>:</p>
<blockquote>
<p>Wym be usefully viable with llvm?</p>
</blockquote>
<p>I mean that I'd be nervous about whether a backend that is designed for both LLVM and NVVM would have the LLVM portion languish from disuse or otherwise break without people noticing. The LLVM backend might not be optimal, but it would need to be <em>useful</em>.</p>
</blockquote>
<p>There is only a single part of my codegen that is libnvvm-specific, and that is the linking step, but it only does a couple things:</p>
<ul>
<li>collects llvm bitcode from rlibs</li>
<li>lazy loads dependencies in order</li>
<li>loads libdevice</li>
<li>calls libnvvm to output ptx</li>
</ul>
<p>But the core of the work is not in libnvvm its in the actual LLVM IR (well, bitcode) generation, which would be shared</p>



<a name="258415243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258415243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258415243">(Oct 20 2021 at 18:04)</a>:</h4>
<p>Ideally we would run a shared test suite which pits both backends against eachother, if one makes valid ptx and the other doesn't, then well, both teams (llvm or nvidia) have something to work off of, and we could also make benchmarks to check for performance disparities</p>



<a name="258415327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258415327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258415327">(Oct 20 2021 at 18:05)</a>:</h4>
<p>(I'd also want to know if the NVVM license has any prohibition on reverse-engineering, and if they'd consider such heads-up testing to be reverse-engineering...)</p>



<a name="258415465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258415465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258415465">(Oct 20 2021 at 18:06)</a>:</h4>
<p>I am not sure honestly, but formats cannot be copyrighted, so just looking at what ptx libnvvm makes and guessing what its doing should be fine</p>



<a name="258415503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258415503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258415503">(Oct 20 2021 at 18:06)</a>:</h4>
<p>this is the CUDA EULA it is under: <a href="https://docs.nvidia.com/cuda/eula/index.html">https://docs.nvidia.com/cuda/eula/index.html</a></p>



<a name="258416346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258416346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258416346">(Oct 20 2021 at 18:11)</a>:</h4>
<p>At the very least we would have a default nvptx target that isnt completely broken, it would be very helpful to have users use the nvptx(64) target without libnvvm so that they can catch anything that breaks. If their project doesnt compile under the ptx backend, then well, they can easily swap back to using libnvvm. This is a great way to catch any bugs inside of the llvm ptx backend, but still have a way to fall back to something which is pretty much guaranteed to work</p>



<a name="258416477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258416477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258416477">(Oct 20 2021 at 18:12)</a>:</h4>
<p>However, the issue with it not linking on windows because of dylib stuff needs to be resolved, otherwise it wont work at all</p>



<a name="258416620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/258416620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#258416620">(Oct 20 2021 at 18:13)</a>:</h4>
<p>IIRC the only way that it worked is if you compiled rustc with static and not dynamic LLVM, which was a gigantic pain to do</p>



<a name="262912369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912369">(Nov 28 2021 at 06:11)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I was thinking, per the target tier policy:</p>
<blockquote>
<p>Targets should not require proprietary (non-FOSS) components to link a functional binary or library.</p>
</blockquote>
<p>Doesn't this mean it would be perfectly fine for me to try to use libnvvm by default then fall back to the LLVM PTX backend if not found? This would pass just fine for that sort of policy because it isn't strictly requiring libnvvm since it can fall back to a non-proprietary solution.</p>



<a name="262912409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912409">(Nov 28 2021 at 06:12)</a>:</h4>
<p>Other than this policy, libnvvm imposes no licensing requirements, my entire project is MIT OR Apache-2.0, and the PTX ISA (the end "binary") generated in the end is open and well-specified, so it imposes zero requirements</p>



<a name="262912472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912472">(Nov 28 2021 at 06:14)</a>:</h4>
<p>So, as mentioned previously, that may theoretically pass the policy, but my primary concern is whether the ptx backend would actually work in practice, and work well enough to actually use. Given how broken you've described that target as, and the lack of interest you've expressed in changing that, what happens if that fallback breaks?</p>



<a name="262912487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912487">(Nov 28 2021 at 06:15)</a>:</h4>
<p>Well if it breaks then we are just back to normal rustc lol, anyways, after doing more research, i think the issue is cg_llvm/rustc, not the ptx backend.</p>



<a name="262912527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912527">(Nov 28 2021 at 06:16)</a>:</h4>
<p>This would always be a better situation than what rustc currently has</p>



<a name="262912533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912533">(Nov 28 2021 at 06:16)</a>:</h4>
<p>(That's useful information! Does that mean with your GPU backend ptx would be more functional?)</p>



<a name="262912541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912541">(Nov 28 2021 at 06:17)</a>:</h4>
<p>Absolutely, im hopeful it should work mostly very well because some projects use clang to compile their cuda code instead of nvcc</p>



<a name="262912550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912550">(Nov 28 2021 at 06:17)</a>:</h4>
<p>And no, if it breaks then we potentially have a target with a working proprietary backend that people use and a broken Open Source that they can't, and a lot of people who would be upset if the target was removed as a result.</p>



<a name="262912592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912592">(Nov 28 2021 at 06:18)</a>:</h4>
<p>Well nvptx64-nvidia-cuda has been utterly broken for ages and it has been a tier 2 target for ages</p>



<a name="262912603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912603">(Nov 28 2021 at 06:19)</a>:</h4>
<p>what im saying is that either ways, we are at a better spot than we were for a long time</p>



<a name="262912609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912609">(Nov 28 2021 at 06:19)</a>:</h4>
<p>because then we have concrete IR that can be reported to nvidia or LLVM as not working. Without the issues of rustc producing horrific gpu-unfriendly IR</p>



<a name="262912657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912657">(Nov 28 2021 at 06:20)</a>:</h4>
<p>I know you don't agree with this perspective, but: all else being equal, adding a proprietary backend in-tree makes us strictly worse off than leaving it out of tree.</p>



<a name="262912666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912666">(Nov 28 2021 at 06:20)</a>:</h4>
<p>Hence my concerns about adding a switchable backend if in practice the maintainers if it don't care about the open alternative.</p>



<a name="262912667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912667">(Nov 28 2021 at 06:20)</a>:</h4>
<p>If it is only proprietary, if it has a fallback then no, we are just back to square one if the proprietary thing or the FOSS thing doesnt work</p>



<a name="262912673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912673">(Nov 28 2021 at 06:21)</a>:</h4>
<p>the LLVM PTX backend is explicitly designed to be mostly equal to what libnvvm expects</p>



<a name="262912678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912678">(Nov 28 2021 at 06:21)</a>:</h4>
<p>there is basically zero libnvvm-specific stuff in my code at this point, other than calling libnvvm</p>



<a name="262912717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912717">(Nov 28 2021 at 06:22)</a>:</h4>
<p>previously it was quite libnvvm specific because it used lazy-loading, now it doesn't, it uses LTO-like DCE which makes a single llvm ir file that can be given to anything that can consume it</p>



<a name="262912723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912723">(Nov 28 2021 at 06:22)</a>:</h4>
<p>So, a question: once you've generated GPU-friendly IR, to what extent are you calling LLVM/NVVM functions in a non-trivial way, and to what extent do you pretty much just call them and get output out the other end?</p>



<a name="262912731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912731">(Nov 28 2021 at 06:23)</a>:</h4>
<p><a href="https://github.com/Rust-GPU/Rust-CUDA/blob/dce/crates/rustc_codegen_nvvm/src/nvvm.rs#L52">https://github.com/Rust-GPU/Rust-CUDA/blob/dce/crates/rustc_codegen_nvvm/src/nvvm.rs#L52</a></p>



<a name="262912735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912735">(Nov 28 2021 at 06:23)</a>:</h4>
<p>That function is the only function that calls libnvvm</p>



<a name="262912738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912738">(Nov 28 2021 at 06:23)</a>:</h4>
<p>it could be replaced with about an equal amount of llvm calls for the nvptx backend</p>



<a name="262912778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912778">(Nov 28 2021 at 06:24)</a>:</h4>
<p>Then in that case, I have a possible idea that might work here.</p>



<a name="262912779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912779">(Nov 28 2021 at 06:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262912592">said</a>:</p>
<blockquote>
<p>Well nvptx64-nvidia-cuda has been utterly broken for ages and it has been a tier 2 target for ages</p>
</blockquote>
<p>tier 2 targets have a very low functionality requirement.</p>



<a name="262912780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912780">(Nov 28 2021 at 06:24)</a>:</h4>
<p>...with some additional <a href="http://build.rs">build.rs</a> logic for only <em>optionally</em> linking in libnvvm, but thats a secondary thing</p>



<a name="262912791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912791">(Nov 28 2021 at 06:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262912779">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262912592">said</a>:</p>
<blockquote>
<p>Well nvptx64-nvidia-cuda has been utterly broken for ages and it has been a tier 2 target for ages</p>
</blockquote>
<p>tier 2 targets have a very low functionality requirement.</p>
</blockquote>
<p>Well yes but ideally theyd work at least a little bit, per the docs</p>



<a name="262912801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912801">(Nov 28 2021 at 06:25)</a>:</h4>
<p>Weeeell mostly to build host tools on, apparently they aren't even smoke tested in practice. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="262912802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912802">(Nov 28 2021 at 06:25)</a>:</h4>
<p>Theoretically, could you make a standalone tool that loads your GPU-friendly LLVM IR from a file and invokes NVVM on it?</p>



<a name="262912804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912804">(Nov 28 2021 at 06:25)</a>:</h4>
<p>nvptx64-nvidia-cuda:</p>
<ul>
<li>doesnt work on windows</li>
<li>when it works it either errors or makes invalid/miscompiled ptx</li>
</ul>



<a name="262912808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912808">(Nov 28 2021 at 06:26)</a>:</h4>
<p>(Assuming your backend to generate that IR was in rustc.)</p>



<a name="262912823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912823">(Nov 28 2021 at 06:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262912802">said</a>:</p>
<blockquote>
<p>Theoretically, could you make a standalone tool that loads your GPU-friendly LLVM IR from a file and invokes NVVM on it?</p>
</blockquote>
<p>Id rather not, what i could do is make a generic codegen for "nvvm ir"</p>



<a name="262912849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912849">(Nov 28 2021 at 06:26)</a>:</h4>
<p>but not having the libnvvm stuff upstreamed would kinda defeat the point since it could not be used on stable</p>



<a name="262912850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912850">(Nov 28 2021 at 06:26)</a>:</h4>
<p>I was asking what's possible, not what you would ideally prefer. ;)</p>



<a name="262912853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912853">(Nov 28 2021 at 06:26)</a>:</h4>
<p>i mean its possible yes, but impractical</p>



<a name="262912854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912854">(Nov 28 2021 at 06:26)</a>:</h4>
<p>I have an idea that might let it be used on stable.</p>



<a name="262912856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912856">(Nov 28 2021 at 06:26)</a>:</h4>
<p>i think cuda has something for it too, cicc.exe or something like that</p>



<a name="262912861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912861">(Nov 28 2021 at 06:27)</a>:</h4>
<p>Oooh, an existing tool would be even better.</p>



<a name="262912863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912863">(Nov 28 2021 at 06:27)</a>:</h4>
<p>And yeah, I don't think that the nvptx64 target should be considered acceptable.<br>
But mostly, as far as tier 2 targets goes, it technically just <strong>barely</strong> meets the requirements and no one has asked to downgrade it.</p>



<a name="262912865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912865">(Nov 28 2021 at 06:27)</a>:</h4>
<p>(ive never been able to get it to actually work tho lol)</p>



<a name="262912894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912894">(Nov 28 2021 at 06:28)</a>:</h4>
<p>but id rather not separate nvvm ir, libnvvm, and llvm ptx backend into like 3 different things, not only is it confusing, but its a maintenance hell</p>



<a name="262912911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912911">(Nov 28 2021 at 06:28)</a>:</h4>
<p>Just two things, not three.</p>



<a name="262912913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912913">(Nov 28 2021 at 06:28)</a>:</h4>
<p>I also agree w/ Josh that a target should work in principle without proprietary code.<br>
It's fine if it can link against/use a proprietary tool with an argument to its invocation.</p>



<a name="262912914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912914">(Nov 28 2021 at 06:28)</a>:</h4>
<p>besides, id <em>like</em> to be able to add libnvvm or llvm-ptx backend specific things, i don't want to 100% lock myself out of being able to do that</p>



<a name="262912918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912918">(Nov 28 2021 at 06:28)</a>:</h4>
<p>but this <em>would</em> work without libnvvm</p>



<a name="262912924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912924">(Nov 28 2021 at 06:29)</a>:</h4>
<p>i mean, it is linking dynamically</p>



<a name="262912925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912925">(Nov 28 2021 at 06:29)</a>:</h4>
<p>So, theoretically, suppose we merged the GPU IR backend you've worked on, and made it run the IR through LLVM normally. But we added a configuration option, available in stable, that invoked a standalone tool in place of LLVM. Any tool the user specified, with specified command-line arguments.</p>



<a name="262912927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912927">(Nov 28 2021 at 06:29)</a>:</h4>
<p>i wouldn't strictly need libnvvm during building the codegen</p>



<a name="262912930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912930">(Nov 28 2021 at 06:29)</a>:</h4>
<p>It's not about whether it's linking dynamically, really.</p>



<a name="262912988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912988">(Nov 28 2021 at 06:30)</a>:</h4>
<p>But then i would just make it try to pass libnvvm by default from cuda_builder and then its the same thing except the libnvvm stuff is moved to cuda_builder, and its less flexible for the codegen</p>



<a name="262912993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912993">(Nov 28 2021 at 06:30)</a>:</h4>
<p>It's about whether it is <strong>actually dynamically linked</strong>, as it were.<br>
"what, you just said"<br>
ah ah<br>
a thing that links dynamically against one possible thing has a statically determined need for a specific library. :^)</p>



<a name="262912994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262912994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262912994">(Nov 28 2021 at 06:30)</a>:</h4>
<p>With that approach, you could write any NVVM-specific code you wanted in a standalone tool, but your GPU-friendly backend could go upstream, and the whole combination works in stable.</p>



<a name="262913008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913008">(Nov 28 2021 at 06:31)</a>:</h4>
<p>I mean nvvm-specific codegen, for example, if the llvm ptx backend doesn't break on i128, then i dont need to run my int replacement logic i have for libnvvm</p>



<a name="262913011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913011">(Nov 28 2021 at 06:31)</a>:</h4>
<p>It's the same thing <em>except rustc upstream isn't maintaining nvvm code</em>.</p>



<a name="262913052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913052">(Nov 28 2021 at 06:32)</a>:</h4>
<p>Well yes but i would like to be open to doing libnvvm-specific things <em>during</em> codegen if the codegen knows it will be using libnvvm</p>



<a name="262913054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913054">(Nov 28 2021 at 06:32)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> I don't think anyone would <em>block</em> merging changes to support making the IR friendlier for other tools processing it.</p>



<a name="262913056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913056">(Nov 28 2021 at 06:32)</a>:</h4>
<p>if its just spitting out IR it has no idea</p>



<a name="262913059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913059">(Nov 28 2021 at 06:32)</a>:</h4>
<p><code>-C no-i128</code></p>



<a name="262913069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913069">(Nov 28 2021 at 06:33)</a>:</h4>
<p>Hmmm</p>



<a name="262913071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913071">(Nov 28 2021 at 06:33)</a>:</h4>
<p>Id be wiling to compromise for something like <code>-C target_backend=libnvvm</code></p>



<a name="262913076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913076">(Nov 28 2021 at 06:33)</a>:</h4>
<p>then rustc has no libnvvm but the codegen still has the control it needs</p>



<a name="262913077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913077">(Nov 28 2021 at 06:33)</a>:</h4>
<p>I believe we're angling for a <code>codegen-args</code> aren't we?</p>



<a name="262913125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913125">(Nov 28 2021 at 06:34)</a>:</h4>
<p>yes pls no more "<code>llvm-args</code> except its not llvm its actually codegen args"</p>



<a name="262913129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913129">(Nov 28 2021 at 06:35)</a>:</h4>
<p>kinda puts me in a weird position cause i have both special codegen args AND maybe llvm-args too in the future</p>



<a name="262913140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913140">(Nov 28 2021 at 06:35)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span>  I would call the option for limiting the IR something like "ir-backend-capabilities", but if you're in general arguing for a named suite of features rather than individual codegen options that seems fine.</p>



<a name="262913144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913144">(Nov 28 2021 at 06:36)</a>:</h4>
<p>I mean, i'll try to give it better names like <code>int-remapping</code></p>



<a name="262913186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913186">(Nov 28 2021 at 06:36)</a>:</h4>
<p>I don't think this is a bad solution</p>



<a name="262913191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913191">(Nov 28 2021 at 06:36)</a>:</h4>
<p>Sure, but I mean in general it seems fine to have a high-level codegen option that enables a whole suite of low-level options like that.</p>



<a name="262913197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913197">(Nov 28 2021 at 06:37)</a>:</h4>
<p>Since all gpu code would still go through cuda_builder because of special gpu codegen things, the issue is that building gpu crates takes nightly</p>



<a name="262913208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913208">(Nov 28 2021 at 06:37)</a>:</h4>
<p>although nvptx64-nvidia-cuda spitting out llvm bitcode would be a bit... weird</p>



<a name="262913210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913210">(Nov 28 2021 at 06:37)</a>:</h4>
<p>Can you explain more of what you mean by that? Why does it need nightly once your backend is upstream?</p>



<a name="262913211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913211">(Nov 28 2021 at 06:38)</a>:</h4>
<p>no i mean currently</p>



<a name="262913247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913247">(Nov 28 2021 at 06:38)</a>:</h4>
<p>Ah.</p>



<a name="262913250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913250">(Nov 28 2021 at 06:38)</a>:</h4>
<p>if it was upstreamed it would be golden for me, dont need to actively keep up with nightly changes and projects build fully in stable</p>



<a name="262913257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913257">(Nov 28 2021 at 06:39)</a>:</h4>
<p>So, the main constraint on this solution is that the default needs to be to take the IR and feed it into LLVM, and that needs to work. And the state of the target for the purposes of the target tier policy would be evaluated based on that.</p>



<a name="262913261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913261">(Nov 28 2021 at 06:39)</a>:</h4>
<p>Although the rust repo would still need some CUDA/libnvvm stuff for tests, in the future i would like to try to get nvptx close to or into tier 1 (not tier 1 with host tools)</p>



<a name="262913264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913264">(Nov 28 2021 at 06:39)</a>:</h4>
<p>But then people can enable calling an alternate binary (kinda like a linker), and that seems fine.</p>



<a name="262913310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913310">(Nov 28 2021 at 06:40)</a>:</h4>
<p>Im in contact with someone at nvidia who said they may sponsor/work on rustc CI for actually running GPU code for tests in the future</p>



<a name="262913322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913322">(Nov 28 2021 at 06:41)</a>:</h4>
<p>The Rust repo could test the default version that uses LLVM ptx via your more GPU-friendly IR, and you could test the nvvm backend separately.</p>



<a name="262913324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913324">(Nov 28 2021 at 06:41)</a>:</h4>
<p>CI on the GPU is... rough, because of how much it could be abused</p>



<a name="262913330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913330">(Nov 28 2021 at 06:42)</a>:</h4>
<p>I think we could have runners on an AWS GPU-enabled instance, for instance.</p>



<a name="262913367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913367">(Nov 28 2021 at 06:42)</a>:</h4>
<p>Id rather not, if we test the target we test both things, libnvvm AND the LLVM PTX backend, separating CI is just a whole lot of work</p>



<a name="262913380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913380">(Nov 28 2021 at 06:43)</a>:</h4>
<p>i mean technically tier 1 would only count the LLVM PTX backend, but in reality it would be very unfair to not test libnvvm when in reality it will be the most common backend</p>



<a name="262913381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913381">(Nov 28 2021 at 06:43)</a>:</h4>
<p>I'm trying to suggest that if this target is tier 1, it needs to pass tests with the default LLVM version.</p>



<a name="262913385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913385">(Nov 28 2021 at 06:43)</a>:</h4>
<p>im not saying it doesnt, im saying it needs to pass both llvm AND libnvvm</p>



<a name="262913386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913386">(Nov 28 2021 at 06:43)</a>:</h4>
<p>and that leaving out either one is not an option</p>



<a name="262913388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913388">(Nov 28 2021 at 06:43)</a>:</h4>
<p>So, a hint: if you want to make this plan palatable, you need to stop suggesting that nvvm should be the most common backend.</p>



<a name="262913431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913431">(Nov 28 2021 at 06:44)</a>:</h4>
<p>You just said that ptx would be much higher quality than it is today with your GPU IR generator.</p>



<a name="262913432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913432">(Nov 28 2021 at 06:44)</a>:</h4>
<p>but that is simply the truth, just because it is proprietary doesn't mean it shouldn't be taken into account</p>



<a name="262913434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913434">(Nov 28 2021 at 06:44)</a>:</h4>
<p>im not saying ill treat the LLVM PTX backend as a secondary thing</p>



<a name="262913438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913438">(Nov 28 2021 at 06:44)</a>:</h4>
<p>You're not <em>saying</em> that, but you're kinda strongly implying that.</p>



<a name="262913439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913439">(Nov 28 2021 at 06:44)</a>:</h4>
<p>no i am saying that generated ptx would not be a miscompiled mess</p>



<a name="262913456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913456">(Nov 28 2021 at 06:45)</a>:</h4>
<p>well if i say the llvm ptx backend is the most common then id be implying i wont take libnvvm seriously, which would leave a bad taste in a lot of people's mouths</p>



<a name="262913499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913499">(Nov 28 2021 at 06:46)</a>:</h4>
<p>I'm not at <em>all</em> asking you to not take it seriously.</p>



<a name="262913509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913509">(Nov 28 2021 at 06:46)</a>:</h4>
<p>The Rust project has ideological and also, er, legal commitments.</p>



<a name="262913510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913510">(Nov 28 2021 at 06:46)</a>:</h4>
<p>Then im saying libnvvm should be tested alongside LLVM PTX in rustc</p>



<a name="262913516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913516">(Nov 28 2021 at 06:47)</a>:</h4>
<p>I'm asking you to not effectively tell people nvvm is so much <em>more</em> important that they should immediately enable that configuration and never consider doing otherwise.</p>



<a name="262913517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913517">(Nov 28 2021 at 06:47)</a>:</h4>
<p>It does, but neither CUDA nor libnvvm force rust to change licenses for anything</p>



<a name="262913522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913522">(Nov 28 2021 at 06:47)</a>:</h4>
<p>users wont have to think about the used backend for most uses</p>



<a name="262913524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913524">(Nov 28 2021 at 06:47)</a>:</h4>
<p>This isn't about license compatibility, it's about ecosystem health and project maintenance.</p>



<a name="262913567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913567">(Nov 28 2021 at 06:48)</a>:</h4>
<p>Now <em>that</em> is the kind of statement that's much more promising!</p>



<a name="262913568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913568">(Nov 28 2021 at 06:48)</a>:</h4>
<p>Saying im going to pick libnvvm first is basically the same as saying im going to pick llvm ptx first, either ways im implying i think one is the better choice</p>



<a name="262913587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913587">(Nov 28 2021 at 06:49)</a>:</h4>
<p>So i dont think theres any winning here, ill leave the option widely open for anyone who wants to change it, but internally i will pick an arbitrary backend decided by the project</p>



<a name="262913591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913591">(Nov 28 2021 at 06:49)</a>:</h4>
<p>I'm not telling you to treat ptx as better, I'm asking you to not systematically treat it as a formality that's only there so you can get upstream and tell people to avoid it. I'm not saying you would do so maliciously, just that some of your recommendations come across as though that's how you would position it.</p>



<a name="262913636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913636">(Nov 28 2021 at 06:50)</a>:</h4>
<p>Yeah</p>



<a name="262913650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913650">(Nov 28 2021 at 06:51)</a>:</h4>
<p>If you're comfortable treating it as a first-class supported choice, then I don't think there's an issue here. We can talk at length about the boundaries here so that you don't feel like anyone changes the goalposts on you later on. :)</p>



<a name="262913651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913651">(Nov 28 2021 at 06:51)</a>:</h4>
<p>/shrug You will in practice pick one over the other in terms of time and energy, and everyone will notice your behavior and evaluate it using their own heuristics.<br>
Our main consideration is that, whatever choice is made in practice, it doesn't add maintenance burden.</p>



<a name="262913700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913700">(Nov 28 2021 at 06:52)</a>:</h4>
<p>And you will have thousands of people trying to break the new toy.</p>



<a name="262913707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913707">(Nov 28 2021 at 06:52)</a>:</h4>
<p>I mean, i am wiling to treat LLVM PTX as a serious backend as long as LLVM is receptive to bug reports and it isn't <em>too</em> broken, meaning, i will feed it a lot of rust code and see if it breaks before considering it</p>



<a name="262913715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913715">(Nov 28 2021 at 06:53)</a>:</h4>
<p>Ah, so you... haven't reported bugs upstream to LLVM before?</p>



<a name="262913721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913721">(Nov 28 2021 at 06:53)</a>:</h4>
<p>I haven't, that will be a <del>fun</del> experience</p>



<a name="262913728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913728">(Nov 28 2021 at 06:53)</a>:</h4>
<p>/me cries in compiling with spaces in filenames</p>



<a name="262913732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913732">(Nov 28 2021 at 06:54)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span>  That sounds perfectly reasonable. And you have a strong incentive to convince them to be receptive and responsive enough to make the backend high quality enough to support the Rust target.</p>



<a name="262913769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913769">(Nov 28 2021 at 06:54)</a>:</h4>
<p>Also, because of that, i kind of expect that libnvvm will also be treated as a serious backend by rustc, meaning that for example, tests are ran with both libnvvm and llvm ptx to make sure they <em>both</em> work</p>



<a name="262913775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913775">(Nov 28 2021 at 06:55)</a>:</h4>
<p>So, two separate thoughts on that:</p>



<a name="262913778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913778">(Nov 28 2021 at 06:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262913728">said</a>:</p>
<blockquote>
<p>/me cries in compiling with spaces in filenames</p>
</blockquote>
<p>You know what makes me MAD, nvidia loves files with spaces</p>



<a name="262913788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913788">(Nov 28 2021 at 06:55)</a>:</h4>
<p>like... please <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.5</code></p>



<a name="262913795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913795">(Nov 28 2021 at 06:55)</a>:</h4>
<p>You... may or may not find LLVM is what you would consider "receptive to bug reports".</p>



<a name="262913839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913839">(Nov 28 2021 at 06:56)</a>:</h4>
<p>/me pain</p>



<a name="262913843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913843">(Nov 28 2021 at 06:56)</a>:</h4>
<p>But yeah, i am not a stranger to talking to a brick wall in bug reports</p>



<a name="262913851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913851">(Nov 28 2021 at 06:57)</a>:</h4>
<p>nvidia has been surprisingly receptive to bug reports, they seem to be actively fixing the i128 issues in libnvvm with CUDA 11.5's experimental 128 bit ints</p>



<a name="262913857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913857">(Nov 28 2021 at 06:57)</a>:</h4>
<p>First, I do absolutely think it's fair to treat bugs reported by users using nvvm as important, and in particular I don't think Rust folks should dismiss them. (There's value  in distinguishing whether any particular bug is present with the default backend or only with a non-default backend, but we should still accept the bug reports, and handle code generation issues such as the one you mentioned of limiting the IR to match NVVM's capabilities.)</p>



<a name="262913859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913859">(Nov 28 2021 at 06:57)</a>:</h4>
<p>I am not saying LLVM is <strong>not</strong> receptive to bug reports, I am merely saying they are a... different project with their own goals and ideas of how things should go, so! Sometimes a bug report is answered and addressed promptly, sometimes... not.</p>



<a name="262913861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913861">(Nov 28 2021 at 06:57)</a>:</h4>
<p>Yeah absolutely</p>



<a name="262913901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913901">(Nov 28 2021 at 06:58)</a>:</h4>
<p>But if its a simple codegen bug i will probably bite the bullet and submit a pr myself</p>



<a name="262913913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262913913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262913913">(Nov 28 2021 at 06:59)</a>:</h4>
<p>But second, I think there may well be logistical issues with treating nvvm testing as part of Rust CI, and I don't think we could reasonably treat test failures in it the same way we would treat test failures in a tier 1 target (e.g. blocking Rust PRs).</p>



<a name="262914014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914014">(Nov 28 2021 at 07:00)</a>:</h4>
<p>( this is in the theoretical future where this target gets far enough to consider applying for tier one status)</p>



<a name="262914019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914019">(Nov 28 2021 at 07:00)</a>:</h4>
<p>Yeah, this will probably need to get run by whatever passes for legal around here.</p>



<a name="262914027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914027">(Nov 28 2021 at 07:00)</a>:</h4>
<p>Hmm yeah, nvptx may not be able to make it into tier 1, but i would at least like to get it to "it will almost definitely work, and we test automatically that gpu code is not miscompiled and wrong"</p>



<a name="262914041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914041">(Nov 28 2021 at 07:01)</a>:</h4>
<p>sounds plausible.</p>



<a name="262914044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914044">(Nov 28 2021 at 07:01)</a>:</h4>
<p>Maybe a new subcategory of tier 1/tier 2?</p>



<a name="262914083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914083">(Nov 28 2021 at 07:02)</a>:</h4>
<p>Well mostly we have makefile tests for that sort of thing and you could just have it run as a cross compilation test.</p>



<a name="262914086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914086">(Nov 28 2021 at 07:02)</a>:</h4>
<p>Let's entertain that discussion after you get to tier 2. ;)</p>



<a name="262914088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914088">(Nov 28 2021 at 07:02)</a>:</h4>
<p>I am already at tier 2 <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="262914089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914089">(Nov 28 2021 at 07:02)</a>:</h4>
<p>lul</p>



<a name="262914093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914093">(Nov 28 2021 at 07:03)</a>:</h4>
<p>Your new GPU-friendly cg isn't. ;)</p>



<a name="262914104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914104">(Nov 28 2021 at 07:03)</a>:</h4>
<p>But mine actually works ;)</p>



<a name="262914105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914105">(Nov 28 2021 at 07:03)</a>:</h4>
<p>I mean there's another GPU backend that also works.</p>



<a name="262914109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914109">(Nov 28 2021 at 07:03)</a>:</h4>
<p>It's just not in-tree.</p>



<a name="262914151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914151">(Nov 28 2021 at 07:04)</a>:</h4>
<p>Anyways, blocking PRs may not be possible, but id at least like some way of being notified of "hey someone just borked the thing somehow"</p>



<a name="262914152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914152">(Nov 28 2021 at 07:04)</a>:</h4>
<p>Which, speaking of!</p>



<a name="262914166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914166">(Nov 28 2021 at 07:05)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> That seems easy enough, though bear in mind the text in the target tier policy about poking PR authors. It was written for that kind of situation.</p>



<a name="262914227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914227">(Nov 28 2021 at 07:06)</a>:</h4>
<p>Yeah im kind of torn on that clause... on one hand yes, we may have issues where some change breaks something deep inside of libnvvm or LLVM PTX, but at the same time, having changes break the codegen, even if not a backend issue, i think that should at least make the PR get paused until a decision is made</p>



<a name="262914242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914242">(Nov 28 2021 at 07:07)</a>:</h4>
<p>So kind of like an in-between of "you are not responsible if it breaks, BUT, if it does break, the PR will be paused while a decision is made on whether to wait on a fix inside the codegen/backends, or whether to push it"</p>



<a name="262914243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914243">(Nov 28 2021 at 07:07)</a>:</h4>
<p>Breaking the codegen would be blocking, breaking the nvvm usage wouldn't be.</p>



<a name="262914285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914285">(Nov 28 2021 at 07:08)</a>:</h4>
<p>breaking the codegen (not breaking the backends) would be blocking</p>



<a name="262914288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914288">(Nov 28 2021 at 07:08)</a>:</h4>
<p>if it was like, breaking LLVM PTX, and the fix was small enough, and the llvm team merged it fast enough, then idk? should that be blocking?</p>



<a name="262914293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914293">(Nov 28 2021 at 07:08)</a>:</h4>
<p>I mean im sure youve had this issue in the past</p>



<a name="262914311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914311">(Nov 28 2021 at 07:09)</a>:</h4>
<p>Argh, mobile UI treated that as an edit to a previous message rather than a new message.</p>



<a name="262914312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914312">(Nov 28 2021 at 07:10)</a>:</h4>
<p>Lol</p>



<a name="262914351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914351">(Nov 28 2021 at 07:10)</a>:</h4>
<p>mobile zulip is something else</p>



<a name="262914359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914359">(Nov 28 2021 at 07:10)</a>:</h4>
<p>Breaking the codegen would absolutely block a PR, once your codegen gets to an appropriate tier for that.</p>



<a name="262914372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914372">(Nov 28 2021 at 07:11)</a>:</h4>
<p>I mean, i think tier 1 is achievable, because in theory if something truly breaks badly in something like libnvvm, we can just switch to defaulting to LLVM PTX while we wait on a codegen workaround and/or a fix from nvidia.</p>



<a name="262914414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914414">(Nov 28 2021 at 07:12)</a>:</h4>
<p>I think you may have missed that this will need to default to LLVM upstream.</p>



<a name="262914422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914422">(Nov 28 2021 at 07:12)</a>:</h4>
<p>Yeah</p>



<a name="262914426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914426">(Nov 28 2021 at 07:12)</a>:</h4>
<p>With an option to call an external program to do something else with the IR.</p>



<a name="262914436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914436">(Nov 28 2021 at 07:13)</a>:</h4>
<p>Yeah this would not be a concern for rustc itself, but it would be for the project as a whole because after all, "direct" uses of the target should be rare</p>



<a name="262914491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914491">(Nov 28 2021 at 07:14)</a>:</h4>
<p>I think we can absolutely get to a well-supported state you're reasonably satisfied by. It may have some portions supported by rustc, and other portions supported by an external project you maintain and Nvidia sponsors.</p>



<a name="262914532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914532">(Nov 28 2021 at 07:16)</a>:</h4>
<p>Yeah, im just concerned of cases like, if libnvvm breaks (but it can be worked around), but llvm ptx works, then the PR won't be blocked because libnvvm is "external"</p>



<a name="262914556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914556">(Nov 28 2021 at 07:16)</a>:</h4>
<p>Yes, that's exactly what's going to happen.</p>



<a name="262914561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914561">(Nov 28 2021 at 07:16)</a>:</h4>
<p>Which i mean, is not the end of the world but not the best either</p>



<a name="262914565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914565">(Nov 28 2021 at 07:16)</a>:</h4>
<p>I get that. Nvidia's GPU support being proprietary is not the best, either. :)</p>



<a name="262914572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914572">(Nov 28 2021 at 07:17)</a>:</h4>
<p>Until AMD starts putting in effort into documenting the most minimal things about amdgpu i will stick with targeting nvidia, besides, to target something like HIP we would need a good nvidia codegen anyways</p>



<a name="262914617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914617">(Nov 28 2021 at 07:18)</a>:</h4>
<p>I'm personally hopeful that your GPU-friendly IR codegen will be useful for a variety of such purposes. :)</p>



<a name="262914631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914631">(Nov 28 2021 at 07:19)</a>:</h4>
<p>I mean, if amd starts actually documenting the amdgpu target, im open to trying to target it with some changes, but until then, i cant be expected to put in effort when a multibillion dollar company wont put in any</p>



<a name="262914635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914635">(Nov 28 2021 at 07:19)</a>:</h4>
<p>I wouldn't expect you to.</p>



<a name="262914639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914639">(Nov 28 2021 at 07:19)</a>:</h4>
<p>Someone else might want to work on that though, and get you to merge their changes. :)</p>



<a name="262914680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914680">(Nov 28 2021 at 07:20)</a>:</h4>
<p>In theory if we can target both PTX and whatever amd uses, and amd makes a version of HIP that is language-agnostic, then we can have cross platform stuff</p>



<a name="262914689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914689">(Nov 28 2021 at 07:20)</a>:</h4>
<p>but so far the only one putting in effort for language-agnostic stuff is nvidia, so, thats kind of the state of everything</p>



<a name="262914698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914698">(Nov 28 2021 at 07:21)</a>:</h4>
<p>I mean this is just funny and sad <a href="/user_uploads/4715/BZD3ouu06aAwg1TKURZ58Giq/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/BZD3ouu06aAwg1TKURZ58Giq/image.png" title="image.png"><img src="/user_uploads/4715/BZD3ouu06aAwg1TKURZ58Giq/image.png"></a></div>



<a name="262914758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914758">(Nov 28 2021 at 07:22)</a>:</h4>
<p>numba even dropped rocm support because it was just such a hassle to work with, so undocumented, and so buggy. So its not as much about "i just like nvidia more and dont like amd", its "nvidia is the only viable option" if you get what i mean</p>



<a name="262914770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914770">(Nov 28 2021 at 07:23)</a>:</h4>
<p>I'm not asking you to argue that point.</p>



<a name="262914780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914780">(Nov 28 2021 at 07:23)</a>:</h4>
<p>I want to confirm something about the plan we've talked about here to make sure we're on the same page.</p>



<a name="262914798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914798">(Nov 28 2021 at 07:24)</a>:</h4>
<p>Yeah it sounds good for now</p>



<a name="262914841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914841">(Nov 28 2021 at 07:24)</a>:</h4>
<p>I will probably make some sort of MCP once i can optionally target llvm ptx and ive found its not too buggy</p>



<a name="262914908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914908">(Nov 28 2021 at 07:27)</a>:</h4>
<p>You have a cg that generates GPU-friendly LLVM IR. You're going to feed that into LLVM PTX by default. You'll add a codegen option that sets an external IR tool, and either make a small command-line wrapper for nvvm or use an existing one. Does that match your takeaway from this conversation too?</p>



<a name="262914916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914916">(Nov 28 2021 at 07:27)</a>:</h4>
<p>We're talking about one target with some new options, not two targets, right?</p>



<a name="262914917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914917">(Nov 28 2021 at 07:28)</a>:</h4>
<p>yes</p>



<a name="262914959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914959">(Nov 28 2021 at 07:28)</a>:</h4>
<p>Although one weird thing is that if the project wants to switch, say, libnvvm for llvm ptx by default, then it would need to somehow sync with stable versions</p>



<a name="262914962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914962">(Nov 28 2021 at 07:29)</a>:</h4>
<p>like, if a release of the codegen happens in 1.50 that breaks libnvvm, then it should switch to llvm ptx until hopefully 1.51 when it is fixed</p>



<a name="262914966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262914966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262914966">(Nov 28 2021 at 07:29)</a>:</h4>
<p>I mean, thats probably possible by checking dates, but that seems... weird, its kind of an odd case</p>



<a name="262915019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915019">(Nov 28 2021 at 07:30)</a>:</h4>
<p>So<br>
you support all of the "platform-intrinsics"<br>
right?</p>



<a name="262915023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915023">(Nov 28 2021 at 07:30)</a>:</h4>
<p>Is there a list of those somewhere?</p>



<a name="262915032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915032">(Nov 28 2021 at 07:31)</a>:</h4>
<p>Im not sure if u mean like the codegen-handled intrinsics like trap, unreachable, bswap, etc</p>



<a name="262915040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915040">(Nov 28 2021 at 07:31)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> </p>
<blockquote>
<p>Although one weird thing is that if the project wants to switch, say, libnvvm for llvm ptx by default, then it would need to somehow sync with stable versions</p>
</blockquote>
<p>That isn't going to be an issue. The project will start out defaulting to LLVM, and stay that way, and if we ever had a situation in which that became non-viable we would be talking about removing the target.</p>



<a name="262915082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915082">(Nov 28 2021 at 07:32)</a>:</h4>
<p>I mean also the list of <code>simd_*</code> symbols. <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/intrinsic.rs">https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/intrinsic.rs</a></p>



<a name="262915092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915092">(Nov 28 2021 at 07:32)</a>:</h4>
<p>simd does not make sense on the gpu, it has some kinda weird specific simd things but thats it: <a href="https://docs.nvidia.com/cuda/cuda-math-api/group__CUDA__MATH__INTRINSIC__SIMD.html">https://docs.nvidia.com/cuda/cuda-math-api/group__CUDA__MATH__INTRINSIC__SIMD.html</a></p>



<a name="262915100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915100">(Nov 28 2021 at 07:33)</a>:</h4>
<p>It doesn't actually matter if you lower them to actual SIMD instructions FYI.</p>



<a name="262915102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915102">(Nov 28 2021 at 07:33)</a>:</h4>
<p>Yeah but emulating those will be... yikes</p>



<a name="262915149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915149">(Nov 28 2021 at 07:34)</a>:</h4>
<p>I hope to get an emulation library somewhere in the compiler eventually, though I am still doing cleanup on the frontend (i.e. the actual library-library).</p>



<a name="262915159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915159">(Nov 28 2021 at 07:34)</a>:</h4>
<p>Other than that, i don't support a lot of advanced i128 intrinsics. ill need to emulate those too</p>



<a name="262915160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915160">(Nov 28 2021 at 07:35)</a>:</h4>
<p>Don't worry, I am inconveniencing <strong>everyone</strong>. :D</p>



<a name="262915173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915173">(Nov 28 2021 at 07:35)</a>:</h4>
<p>The price of good simd</p>



<a name="262915175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915175">(Nov 28 2021 at 07:35)</a>:</h4>
<p>now stabilize it thanks :)</p>



<a name="262915222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915222">(Nov 28 2021 at 07:36)</a>:</h4>
<p>But yes just "whatever you would do looped on an array" is (generically speaking, ignoring permutation instructions and the like) a valid lowering.</p>



<a name="262915253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915253">(Nov 28 2021 at 07:37)</a>:</h4>
<p>Although i think if ur trying to use simd on the gpu you probably have bigger issues in your kernels</p>



<a name="262915270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915270">(Nov 28 2021 at 07:38)</a>:</h4>
<p>because yknow, the whole point is to not use simd and to use threads</p>



<a name="262915299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915299">(Nov 28 2021 at 07:38)</a>:</h4>
<p>It's more that people will be using libraries.</p>



<a name="262915300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915300">(Nov 28 2021 at 07:38)</a>:</h4>
<p>warps are just really w i d e simd execution units</p>



<a name="262915382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915382">(Nov 28 2021 at 07:41)</a>:</h4>
<p>So while it's not a huge thing <strong>right now</strong>, eventually someone will call a library function that for some godforsaken reason reprs something as SIMD somewhere and then... and then...! <strong>boom</strong></p>



<a name="262915387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915387">(Nov 28 2021 at 07:41)</a>:</h4>
<p>Yeah</p>



<a name="262915395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915395">(Nov 28 2021 at 07:41)</a>:</h4>
<p>I mean, i can lower certain simd things to those special cuda instructions, but the rest needs to be emulated</p>



<a name="262915563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915563">(Nov 28 2021 at 07:46)</a>:</h4>
<p>Oh yeah these are like i16x2 packed in a u32? Yeah Arm does the same thing.</p>



<a name="262915898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262915898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262915898">(Nov 28 2021 at 07:56)</a>:</h4>
<p>I would <em>love</em> it if instead of just</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">unchecked_mul</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Copy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>the intrinsics could be defined like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">unchecked_mul</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Copy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">wrapping_mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>so the backend could just use that MIR if it didn't have a native implementation.</p>
<p>That would make adding intrinsics <em>so</em> much easier in our upcoming "at least 4 common backends" world...</p>



<a name="262944059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944059">(Nov 28 2021 at 19:25)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Actually, after a lot of thought, and a lot of consulting other people who have a stake in targets that use proprietary libraries, i think i will go the route of proposing changes to the target tier policy. Not only for CUDA, but for future targets in which the best way to target them is a proprietary library.</p>



<a name="262944070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944070">(Nov 28 2021 at 19:25)</a>:</h4>
<p>Sigh. I'd love it if you picked a path that <em>doesn't</em> require me to spend a while attempting to prevent such changes, because I'm a little busy with other things right now.</p>



<a name="262944074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944074">(Nov 28 2021 at 19:25)</a>:</h4>
<p>In short: yes, I want to stop those other targets too.</p>



<a name="262944130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944130">(Nov 28 2021 at 19:27)</a>:</h4>
<p>Every proposal will have people who don't agree, i just think the amount of people who have a stake in such targets is much higher than those who oppose such changes <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="262944134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944134">(Nov 28 2021 at 19:27)</a>:</h4>
<p>I think it's a fundamentally bad idea, I wrote the policy specifically to prevent it, and people across three teams signed off on that policy. I started with a toned-down version and people asked me to make it <em>stricter</em>.</p>



<a name="262944145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944145">(Nov 28 2021 at 19:27)</a>:</h4>
<p>Yes but a lot has changed since then, nowadays rustc is starting to expand into tons of other custom backends</p>



<a name="262944147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944147">(Nov 28 2021 at 19:27)</a>:</h4>
<p>That's quite recent, and the policy was written with other backends in mind.</p>



<a name="262944194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944194">(Nov 28 2021 at 19:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262944130">said</a>:</p>
<blockquote>
<p>Every proposal will have people who don't agree, i just think the amount of people who have a stake in such targets is much higher than those who oppose such changes <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
</blockquote>
<p>Also, I'm going to ask you to <em>please</em> not try to make this a numbers game. This is not a vote.</p>



<a name="262944209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944209">(Nov 28 2021 at 19:29)</a>:</h4>
<p>I know its not, but the more people you can show that have a stake in rust supporting such things, the more you can show the usefulness of overriding such a policy</p>



<a name="262944211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944211">(Nov 28 2021 at 19:29)</a>:</h4>
<p>That's really, really not how it works.</p>



<a name="262944260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944260">(Nov 28 2021 at 19:30)</a>:</h4>
<p>This is "cost/benefit" or "harm vs help" not "number of interested people".</p>



<a name="262944289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944289">(Nov 28 2021 at 19:31)</a>:</h4>
<p>I realize that you don't actually believe this would do harm to Rust, but take it as a given that those who <em>do</em> oppose proprietary in-tree targets do believe it would do substantial harm to Rust. If you take that to be true, then you're attempting to argue "there are enough people who care about this target that it outweighs the harm that would be done to Rust".</p>



<a name="262944297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944297">(Nov 28 2021 at 19:31)</a>:</h4>
<p>Yes, exactly, the more people interested in using rust for such domains, the more it would help rust. It would be kind of useless to propose such a change without showing what the change could do for rust itself</p>



<a name="262944302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944302">(Nov 28 2021 at 19:31)</a>:</h4>
<p>I do know the downsides of allowing this, but i also recognize the great benefits this could bring for rust</p>



<a name="262944366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944366">(Nov 28 2021 at 19:33)</a>:</h4>
<p>The argument of "you want your compiler to support my special target more than you want to keep your compiler open" is a very old one. The compilers that heard and ignored that argument are still around. The targets aren't.</p>



<a name="262944377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944377">(Nov 28 2021 at 19:33)</a>:</h4>
<p>If rustc does not allow itself to expand into such domains, in the long term we may have compilers and tools that <em>do</em> target such domains, leading to rustc having a hard time keeping up</p>



<a name="262944387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944387">(Nov 28 2021 at 19:33)</a>:</h4>
<p>Or we may have people who care enough about using Rust in those domains that they build open tools for targeting those domains.</p>



<a name="262944392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944392">(Nov 28 2021 at 19:33)</a>:</h4>
<p>Or we may have people using something other than Rust for those domains, and that's OK too.</p>



<a name="262944439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944439">(Nov 28 2021 at 19:34)</a>:</h4>
<p>I care about Rust enduring for the long term and being non-proprietary for <em>other</em> targets much much more than I care about any one target.</p>



<a name="262944445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944445">(Nov 28 2021 at 19:34)</a>:</h4>
<p>To put it another way: the same argument you're using to support NVIDIA is one that CPU vendors would jump on in a <em>heartbeat</em> if they hear "oooh, we can keep optimizations for our CPU secret!".</p>



<a name="262944449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944449">(Nov 28 2021 at 19:35)</a>:</h4>
<p>And ten years from now, I don't want the primary backends for x86 and ARM to be proprietary.</p>



<a name="262944463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944463">(Nov 28 2021 at 19:35)</a>:</h4>
<p>Nor do I want Rust folks trying to figure out how to support them while not being able to debug them unless they work for those companies.</p>



<a name="262944905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944905">(Nov 28 2021 at 19:47)</a>:</h4>
<p>If people are so eager to keep their stuff closed they can always implement a wasm compiler and take wasm output from rust, with all the penalties that implies <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="262944974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944974">(Nov 28 2021 at 19:49)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> I don't think we have to go <em>that</em> far. I think it's fine for folks to use a decent IR.</p>



<a name="262944980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262944980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262944980">(Nov 28 2021 at 19:49)</a>:</h4>
<p>(And I don't think wasm is a good fit for GPUs, as far as I know.)</p>



<a name="262945039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262945039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262945039">(Nov 28 2021 at 19:50)</a>:</h4>
<p>Sure, substitute wasm with something equivalent.</p>



<a name="262949518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262949518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262949518">(Nov 28 2021 at 21:35)</a>:</h4>
<p>FWIW, <span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> and I talked this through in detail, and came up with the following rough sketch of a plan that should allow merging a CUDA target upstream:</p>
<ul>
<li>Add the new GPU-friendly CUDA codegen layer to Rust, <code>cg_cuda</code>, which generates a specified subset of LLVM IR that's compatible with both LLVM PTX and libnvvm.</li>
<li>Modify the existing <code>nvptx64-nvidia-cuda</code> target to use <code>cg_cuda</code>. (We don't have to drop support for using <code>cg_llvm</code> with that target, but we almost certainly want to default to using <code>cg_cuda</code> once it's merged; it's likely to produce much better code and make LLVM PTX behave better, in addition to supporting libnvvm. And we may want to drop <code>cg_llvm</code> support for this if it turns out to not be worth supporting.)</li>
<li>Add a new rustc codegen option to use the external <code>cicc</code> program (which uses libnvvm) from the CUDA SDK to turn the IR into PTX. (We should document exactly what interface we expect from <code>cicc</code> so that it's possible for people to use that interface for some other tool, such as experimenting with an open equivalent.)</li>
<li>Plumb that codegen option through cargo so that people can easily pass it in their projects without using <code>RUSTFLAGS</code>.</li>
</ul>



<a name="262949626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262949626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262949626">(Nov 28 2021 at 21:37)</a>:</h4>
<p>Does nvidia provide a software emulation library to run cuda on the CPU so we could run tests for that in CI without needing expensive GPU runners?</p>



<a name="262949687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262949687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262949687">(Nov 28 2021 at 21:38)</a>:</h4>
<p>I dont think so</p>



<a name="262949693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262949693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262949693">(Nov 28 2021 at 21:38)</a>:</h4>
<p>There is gpu ocelot but thats a third party thing and probably doesn’t always work</p>



<a name="262949712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262949712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262949712">(Nov 28 2021 at 21:39)</a>:</h4>
<p>Besides, i dont think its wise to rely on third party tools for tests, because a lot of tests will be testing semantics of memory ordering and things like that</p>



<a name="262949722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262949722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262949722">(Nov 28 2021 at 21:39)</a>:</h4>
<p>And we will need CUDA CI anyways for benchmarking libnvvm and llvm ptx against eachother</p>



<a name="262950232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262950232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262950232">(Nov 28 2021 at 21:50)</a>:</h4>
<p>We may also want to run tests through <code>cuda-memcheck</code>, just to make sure we dont make anything unsound. CUDA is especially good at hiding unsoundness</p>



<a name="262950278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262950278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262950278">(Nov 28 2021 at 21:51)</a>:</h4>
<p>Though for some reason cuda-memcheck, at least on my machine is soooooooo slow in startup and stop, it takes like 2 microseconds to process a kernel and 2 minutes to yield the result <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="262964557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262964557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262964557">(Nov 29 2021 at 03:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262944209">said</a>:</p>
<blockquote>
<p>I know its not, but the more people you can show that have a stake in rust supporting such things, the more you can show the usefulness of overriding such a policy</p>
</blockquote>
<p>Rust already supports proprietary targets to the extent it must (hi Windows) and it is HELL. Even Microsoft barely knows what the spec for their own debuginfo format is, and they certainly aren't really disclosing much to anyone else.</p>



<a name="262964563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262964563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262964563">(Nov 29 2021 at 03:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262945039">said</a>:</p>
<blockquote>
<p>Sure, substitute wasm with something equivalent.</p>
</blockquote>
<p>The SPIRV backend, probably.</p>



<a name="262964640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262964640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262964640">(Nov 29 2021 at 03:54)</a>:</h4>
<p>I suppose claiming Microsoft doesn't know their own debuginfo format could be seen as inflammatory, but I am open to being proven wrong by Microsoft publishing an actual spec instead of a barely-functional repo. :^)</p>



<a name="262965245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262965245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262965245">(Nov 29 2021 at 04:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262944302">said</a>:</p>
<blockquote>
<p>I do know the downsides of allowing this, but i also recognize the great benefits this could bring for rust</p>
</blockquote>
<p>Rust is nothing... ash and smoke in the wind... without the people backing it.<br>
And I am not here for serving corporate interests, or supporting further enclosure of the commons.</p>



<a name="262970061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970061">(Nov 29 2021 at 06:03)</a>:</h4>
<p>I also think this counts as a crime on <del>humanity</del> rustc, i am overriding functions defined in libm with libdevice intrinsics for the purpose of code size and speed <a href="https://github.com/Rust-GPU/Rust-CUDA/blob/master/crates/rustc_codegen_nvvm/src/override_fns.rs">https://github.com/Rust-GPU/Rust-CUDA/blob/master/crates/rustc_codegen_nvvm/src/override_fns.rs</a></p>



<a name="262970112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970112">(Nov 29 2021 at 06:04)</a>:</h4>
<p>anyways, <span class="user-mention" data-user-id="239881">@Josh Triplett</span> would u be wiling to go with a dll interface instead of an exe interface? really the medium doesnt change, its just that keeping everything in memory is helpful for performance and flexibility</p>



<a name="262970125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970125">(Nov 29 2021 at 06:05)</a>:</h4>
<p>I would define a common interface thats expected, then make a dll that wraps the libnvvm dll with that common interface</p>



<a name="262970137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970137">(Nov 29 2021 at 06:05)</a>:</h4>
<p>that way, we don't get feature creep because the dll interface is always the same</p>



<a name="262970192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970192">(Nov 29 2021 at 06:06)</a>:</h4>
<p>That seems like a lot more trouble, but assuming the interface is roughly "pass IR, get back generated code", I don't see an issue with that.</p>
<p>But wouldn't that mean users need to build something? You wanted to avoid that.</p>



<a name="262970203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970203">(Nov 29 2021 at 06:07)</a>:</h4>
<p>Well its because the bitcode may potentially be very big for large programs, and id like to add optional APIs for things like validation</p>



<a name="262970207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970207">(Nov 29 2021 at 06:07)</a>:</h4>
<p>If possible id like to ship that dll <em>with</em> rustc</p>



<a name="262970216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970216">(Nov 29 2021 at 06:07)</a>:</h4>
<p>So at that point you effectively are linking to nvvm directly and I don't see a meaningful difference.</p>



<a name="262970217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970217">(Nov 29 2021 at 06:07)</a>:</h4>
<p>the dll is basically just a wrapper for the libnvvm dll, it doesn't statically link it, so there should be no issue</p>



<a name="262970260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970260">(Nov 29 2021 at 06:08)</a>:</h4>
<p>not necessarily, im linking through a common interface to avoid contributors relying on the libnvvm interface directly</p>



<a name="262970268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970268">(Nov 29 2021 at 06:08)</a>:</h4>
<p>which if im not mistaken, was the main reason for using an exe</p>



<a name="262970269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970269">(Nov 29 2021 at 06:08)</a>:</h4>
<p>I don't know how many different ways to say "static versus dynamic doesn't matter for licensing". :)</p>



<a name="262970344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970344">(Nov 29 2021 at 06:10)</a>:</h4>
<p>If you want to centralize the interface, I think you might as well use dlopen and just say "do not dlsym any other functions".</p>



<a name="262970357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970357">(Nov 29 2021 at 06:10)</a>:</h4>
<p>Putting it in a separate crate would help for instance.</p>



<a name="262970361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970361">(Nov 29 2021 at 06:10)</a>:</h4>
<p>Yeah</p>



<a name="262970384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970384">(Nov 29 2021 at 06:11)</a>:</h4>
<p>I'm also wondering if cicc could take a pipe.</p>



<a name="262970391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970391">(Nov 29 2021 at 06:11)</a>:</h4>
<p>No cicc only takes files i think</p>



<a name="262970397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970397">(Nov 29 2021 at 06:11)</a>:</h4>
<p>(by the way, bitcode being big would normally be an argument for files, not memory)</p>



<a name="262970439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970439">(Nov 29 2021 at 06:12)</a>:</h4>
<p>(in case it doesn't fit in memory)</p>



<a name="262970449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970449">(Nov 29 2021 at 06:12)</a>:</h4>
<p>Well it <em>has to</em> because of the way linking works currently <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="262970456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970456">(Nov 29 2021 at 06:12)</a>:</h4>
<p>i mean, it will be hard to make a bitcode file so big it doesnt fit into memory</p>



<a name="262970461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970461">(Nov 29 2021 at 06:12)</a>:</h4>
<p>unless you are pulling in like half the ecosystem</p>



<a name="262970474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970474">(Nov 29 2021 at 06:13)</a>:</h4>
<p>Would you consider trying the cicc interface at first, and see if it's actually a bottleneck? I would expect that since it only gets involved once per compile it wouldn't be a substantial overhead.</p>



<a name="262970506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970506">(Nov 29 2021 at 06:13)</a>:</h4>
<p>If it's a bottleneck to the point that it makes the interface not usable, then let's talk about alternatives.</p>



<a name="262970507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970507">(Nov 29 2021 at 06:13)</a>:</h4>
<p>Yeah i'll see once nvidia gets back to me about how to actually use it <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="262970513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970513">(Nov 29 2021 at 06:13)</a>:</h4>
<p>No --help?</p>



<a name="262970515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970515">(Nov 29 2021 at 06:14)</a>:</h4>
<p>i also wanted to implement some way to load plugins, for tools like the enzyme autodiff</p>



<a name="262970529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970529">(Nov 29 2021 at 06:14)</a>:</h4>
<p>No</p>



<a name="262970571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970571">(Nov 29 2021 at 06:14)</a>:</h4>
<p>Plugins into what?</p>



<a name="262970579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970579">(Nov 29 2021 at 06:14)</a>:</h4>
<p>into the generated bitcode module</p>



<a name="262970586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970586">(Nov 29 2021 at 06:14)</a>:</h4>
<p>Ah. So on the rustc side before handing off the code?</p>



<a name="262970588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970588">(Nov 29 2021 at 06:15)</a>:</h4>
<p>And i think doing Module -&gt; Bitcode -&gt; Module -&gt; Bitcode -&gt; Module -&gt; PTX would be a significant issue</p>



<a name="262970596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970596">(Nov 29 2021 at 06:15)</a>:</h4>
<p>if it goes through files that is</p>



<a name="262970597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970597">(Nov 29 2021 at 06:15)</a>:</h4>
<p>Yeah</p>



<a name="262970606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970606">(Nov 29 2021 at 06:15)</a>:</h4>
<p>What do you mean by bitcode -&gt; module?</p>



<a name="262970607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970607">(Nov 29 2021 at 06:15)</a>:</h4>
<p>enzyme works on the LLVM IR itself, you make extern calls, then enzyme generates defs for those functions using the LLVM IR</p>



<a name="262970613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970613">(Nov 29 2021 at 06:15)</a>:</h4>
<p>Module is the in-memory repr</p>



<a name="262970617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970617">(Nov 29 2021 at 06:15)</a>:</h4>
<p>its what the modules are stored in before giving it to libnvvm</p>



<a name="262970658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970658">(Nov 29 2021 at 06:16)</a>:</h4>
<p>although libnvvm naturally reparses the in-memory bc to a module on its side</p>



<a name="262970663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970663">(Nov 29 2021 at 06:16)</a>:</h4>
<p>So, one argument for translating to bitcode is that I would expect that to be more stable.</p>



<a name="262970672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970672">(Nov 29 2021 at 06:16)</a>:</h4>
<p>Oh yeah 100%</p>



<a name="262970676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970676">(Nov 29 2021 at 06:17)</a>:</h4>
<p>im not saying it wont be, im just saying with plugins and stuff the overhead with files might become unwanted</p>



<a name="262970688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970688">(Nov 29 2021 at 06:17)</a>:</h4>
<p>and dlls are just an easier interface to work with</p>



<a name="262970706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970706">(Nov 29 2021 at 06:17)</a>:</h4>
<p>I think supporting enzyme or similar is a perfectly reasonable thing to do, albeit not one I would expect to stabilize anytime soon.</p>



<a name="262970712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970712">(Nov 29 2021 at 06:17)</a>:</h4>
<p>But I wouldn't want to tie that to nvvm support specifically.</p>



<a name="262970757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970757">(Nov 29 2021 at 06:18)</a>:</h4>
<p>no enzyme doesnt have any libnvvm specific things</p>



<a name="262970758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970758">(Nov 29 2021 at 06:18)</a>:</h4>
<p>It's just as useful for cg_llvm as well.</p>



<a name="262970761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970761">(Nov 29 2021 at 06:18)</a>:</h4>
<p>i think it actually requires the llvm ptx backend currently because nvcc cant spit out intermediate nvvm ir</p>



<a name="262970765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970765">(Nov 29 2021 at 06:18)</a>:</h4>
<p>Right, so no reason to emit files first for enzyme.</p>



<a name="262970787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970787">(Nov 29 2021 at 06:19)</a>:</h4>
<p>Just for cicc.</p>



<a name="262970797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/262970797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#262970797">(Nov 29 2021 at 06:19)</a>:</h4>
<p>Yeah</p>



<a name="263028670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263028670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263028670">(Nov 29 2021 at 16:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262912925">said</a>:</p>
<blockquote>
<p>So, theoretically, suppose we merged the GPU IR backend you've worked on, and made it run the IR through LLVM normally. But we added a configuration option, available in stable, that invoked a standalone tool in place of LLVM. Any tool the user specified, with specified command-line arguments.</p>
</blockquote>
<p>I think this is a really interesting idea. There are quite a few tools that read LLVM BC and then do <em>something</em> with it. Many of these tools are currently awkward to use in Rust since you can't really integrate them into the build via Cargo unless you create your own subcommand or something. So I think this would be useful even outside of the gpu/cuda target.</p>



<a name="263032981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263032981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263032981">(Nov 29 2021 at 16:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements/near/262970456">said</a>:</p>
<blockquote>
<p>i mean, it will be hard to make a bitcode file so big it doesnt fit into memory</p>
</blockquote>
<p>Some people run rustc, even do significant development, on extremely resource-constrained machines.<br>
The compiler should be capable of reasonably gracefully handling being on a machine with only 1 GB RAM.</p>



<a name="263048539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263048539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263048539">(Nov 29 2021 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> This is difficult because of the strategy for linking that the codegen currently uses, it is essentially always fat LTO. At link time, i gather the bc of all the cgus in the rlibs, then i merge them into a single LLVM module, internalize anything not a kernel, then run global DCE. And finally give that to libnvvm. If i did not do that, we would have absolutely gigantic PTX files. This also reduces the amount of work libnvvm has to do, as well as give us LTO optimizations by default, which is important on the GPU. </p>
<p>I used to lazily-load only what was needed by previous modules with dependency graphs, but becauseof no_mangle functions, it still made a large ptx file, this approach is much better and faster. Im not too worried about it because:</p>
<ul>
<li>If you are running CUDA you probably have at least 8 gb of ram, i dont think cuda can even run on 1gb of ram.</li>
<li>GPU crates are unlikely to have tons of dependencies before or after DCE.</li>
</ul>



<a name="263048895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263048895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263048895">(Nov 29 2021 at 18:27)</a>:</h4>
<p>One thing that i want to figure out is how to get rustc to just not respect <code>#[inline]</code>, for us it is basically just bloat because inlining will happen anyways</p>



<a name="263049821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263049821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263049821">(Nov 29 2021 at 18:34)</a>:</h4>
<p>No no,<br>
People do not deploy on these machines.<br>
They build locally and then upload it to a server that runs it.</p>



<a name="263050397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263050397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263050397">(Nov 29 2021 at 18:39)</a>:</h4>
<p>I've run rust on 1, 4, and 8gb devices many times, and it does work, but gosh does it take a long time sometimes. Not like "get the coffee" long, more like "make and eat an entire sandwich" long.</p>



<a name="263052249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263052249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263052249">(Nov 29 2021 at 18:53)</a>:</h4>
<p>that's... not too terrible. compared to building llvm and rust on a laptop. last time I did that it ran for more than an hour. Granted, that was before download-ci-llvm.</p>



<a name="263053744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263053744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263053744">(Nov 29 2021 at 19:05)</a>:</h4>
<p>Yeah, I am really basically thinking<br>
"okay, yes, the user has 8 GB, but 6 of it has already been eaten by Chrome."</p>



<a name="263054158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263054158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263054158">(Nov 29 2021 at 19:08)</a>:</h4>
<p>Mind, virtual memory, i.e. using a disk as memory, is an option. But Rustup has specific mitigations to make sure it installs properly on 32 bit machines that don't have virtual memory available. It's also fine if there's no <strong>specific</strong> mitigation, I think, that hard-guarantees it will work, but just attempts to reduce the working set, so I think "convincing rustc to inline less for this backend because I will take care of that" is a valid response.</p>



<a name="263054250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263054250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263054250">(Nov 29 2021 at 19:09)</a>:</h4>
<p>It's also fine if the happy path is under 2 minutes and the sad path is 24 hours.</p>



<a name="263055860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263055860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263055860">(Nov 29 2021 at 19:23)</a>:</h4>
<p>I think most of the bloat when linking will actually just be inline functions</p>



<a name="263055870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263055870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263055870">(Nov 29 2021 at 19:23)</a>:</h4>
<p>so many functions that are needlessly there</p>



<a name="263055932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263055932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263055932">(Nov 29 2021 at 19:24)</a>:</h4>
<p>So itd be great if there was a way to tell rustc to just... not</p>



<a name="263056334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263056334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263056334">(Nov 29 2021 at 19:27)</a>:</h4>
<p>Cool.<br>
Then I look forward to someone fixing that so I can compile CUDA in WASI on the browser.</p>



<a name="263056377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263056377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263056377">(Nov 29 2021 at 19:28)</a>:</h4>
<p>You know just because you can doesnt mean you should</p>



<a name="263056549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263056549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263056549">(Nov 29 2021 at 19:29)</a>:</h4>
<p><span aria-label="smiling imp" class="emoji emoji-1f608" role="img" title="smiling imp">:smiling_imp:</span> When has that incredibly sensible advice ever stopped humanity?</p>



<a name="263056563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263056563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263056563">(Nov 29 2021 at 19:29)</a>:</h4>
<p>sadly not many times</p>



<a name="263056638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263056638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263056638">(Nov 29 2021 at 19:30)</a>:</h4>
<p>someone will find a way to get us WebCUDA, then we will truly be evolved</p>



<a name="263059873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263059873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263059873">(Nov 29 2021 at 19:55)</a>:</h4>
<p>As far as I know, I think we're getting close to that with WebGPU.</p>



<a name="263059883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263059883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263059883">(Nov 29 2021 at 19:55)</a>:</h4>
<p>Not quite there, but getting there.</p>



<a name="263059940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263059940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263059940">(Nov 29 2021 at 19:55)</a>:</h4>
<p>finally, websites can now mine bitcoin for me, ads werent enough <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="263059978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263059978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263059978">(Nov 29 2021 at 19:56)</a>:</h4>
<p>They already do <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="263060059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263060059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263060059">(Nov 29 2021 at 19:56)</a>:</h4>
<p>afaik there already are some web miners, but they use coins that are designed to be GPU/ASIC-hostile</p>



<a name="263066953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263066953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263066953">(Nov 29 2021 at 20:58)</a>:</h4>
<p>And AFAIK even a GPU isn't enough for competitive bitcoin mining these days. So until there's a WebFPGA...</p>



<a name="263067316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263067316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263067316">(Nov 29 2021 at 21:01)</a>:</h4>
<p>Yeah but they still yoink all of the valuable silicon i could be using to turn my pc into a space heater <span aria-label="rage" class="emoji emoji-1f621" role="img" title="rage">:rage:</span></p>



<a name="263072517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263072517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263072517">(Nov 29 2021 at 21:52)</a>:</h4>
<p>There are ASIC-resistant protocols that use GPUs, so.</p>



<a name="263105018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263105018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263105018">(Nov 30 2021 at 06:04)</a>:</h4>
<p>I was thinking, would it be beneficial to actually demote nvptx64-nvidia-cuda to tier 3 once the codegen is upstreamed and is the default handler for it? Then its easier to track testing progress and milestones in general. Such as it being promoted to tier 2 once we have tests for "this compiles", then tier 1 once there are proper tests for "this actually runs"?</p>



<a name="263107310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263107310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263107310">(Nov 30 2021 at 06:54)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> That seems rather reasonable to me.</p>



<a name="263237666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263237666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263237666">(Dec 01 2021 at 02:36)</a>:</h4>
<p>Also how do stability guarantees work in terms of targets? Is it breaking to demote or promote a target? what about substituting a codegen? I would presume the latter would only be breaking if the target was tier 1</p>



<a name="263237831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263237831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263237831">(Dec 01 2021 at 02:39)</a>:</h4>
<p>the nvptx64-nvidia-cuda target spec is wrong too, it should state the minimum atomic width is 32 bits, cuda has nothing for less than 32 bit</p>



<a name="263237913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263237913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263237913">(Dec 01 2021 at 02:40)</a>:</h4>
<p>But fixing it would break that target... which is why im asking about this</p>



<a name="263252705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252705">(Dec 01 2021 at 07:21)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> So, a few different aspects of that...</p>



<a name="263252721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252721">(Dec 01 2021 at 07:21)</a>:</h4>
<p>The target tier policy specifically states that demoting a target is something we can do, but shouldn't do <em>lightly</em>, and lays out a process for it.</p>



<a name="263252732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252732">(Dec 01 2021 at 07:21)</a>:</h4>
<p>It's not breaking at all to <em>promote</em> a target, it just commits us to more.</p>



<a name="263252796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252796">(Dec 01 2021 at 07:22)</a>:</h4>
<p>Substituting a codegen is only breaking if it actually breaks things. If it causes things to stop working that worked before, then that'd have to be carefully evaluated.</p>



<a name="263252820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252820">(Dec 01 2021 at 07:23)</a>:</h4>
<p>As for changing something like "minimum atomic width", I think that's likely to fall under a rule we <em>often</em> apply for breaking changes:</p>



<a name="263252846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252846">(Dec 01 2021 at 07:23)</a>:</h4>
<p>It's only broken if it breaks real code that wasn't already broken.</p>



<a name="263252911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252911">(Dec 01 2021 at 07:24)</a>:</h4>
<p>If atomics less than 32 bits never actually <em>worked</em>, then code using them doesn't work, so that wouldn't be a blocker.</p>



<a name="263252937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263252937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263252937">(Dec 01 2021 at 07:24)</a>:</h4>
<p>(There's also the question of whether anyone is using a relevant <code>cfg</code>, but again, that seems unlikely to crop up.)</p>



<a name="263253668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263253668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263253668">(Dec 01 2021 at 07:36)</a>:</h4>
<p>Types available, like AtomicU8, should be changed with great loathing...<br>
...but functionally it is never actually breaking to fix a simply wrong type.</p>



<a name="263253769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263253769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263253769">(Dec 01 2021 at 07:38)</a>:</h4>
<p>just a lot going on in that "simply" wrong.</p>



<a name="263308942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263308942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263308942">(Dec 01 2021 at 15:39)</a>:</h4>
<p>I see</p>



<a name="263311284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311284">(Dec 01 2021 at 15:54)</a>:</h4>
<p>In theory there shouldn't be many things that will stop working, i am skeptic that atomics ever worked with the ptx backend + rustc, but i will need to try it. If it <em>did</em> work, it should definitely not work with atomics less than 32 bits unless the llvm ptx backend emulates them</p>



<a name="263311305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311305">(Dec 01 2021 at 15:54)</a>:</h4>
<p>Isn't it legal for the compiler to lower small atomics to larger ones? load + cas isn't destructive for neighboring bytes.</p>



<a name="263311351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311351">(Dec 01 2021 at 15:55)</a>:</h4>
<p>Yes but in practice that would be a lot of work and less efficient than just using native</p>



<a name="263311404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311404">(Dec 01 2021 at 15:55)</a>:</h4>
<p>And i dont think we should lie to the user about what atomics are natively supported without emulation</p>



<a name="263311421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311421">(Dec 01 2021 at 15:55)</a>:</h4>
<p>sure, but if it doesn't support small ones then there still isn't a minimum, AtomicU8 would just be less efficient than AtomicUsize</p>



<a name="263311440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311440">(Dec 01 2021 at 15:55)</a>:</h4>
<p>CUDA also does not have fetch_nand</p>



<a name="263311470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311470">(Dec 01 2021 at 15:55)</a>:</h4>
<p>but that can be emulated i guess, its not a common operation</p>



<a name="263311571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311571">(Dec 01 2021 at 15:56)</a>:</h4>
<p>yeah, most operations are emulated as long as CAS or similar are available</p>



<a name="263311626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311626">(Dec 01 2021 at 15:56)</a>:</h4>
<p>theres always CAS for 32 bit, i think 64 bit anything needs compute capability 6.x+</p>



<a name="263311656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311656">(Dec 01 2021 at 15:56)</a>:</h4>
<p>but we default to 6.1</p>



<a name="263311666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311666">(Dec 01 2021 at 15:56)</a>:</h4>
<p>x86 doesn't have fetch_max either</p>



<a name="263311701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311701">(Dec 01 2021 at 15:57)</a>:</h4>
<p>CUDA defaults to 5.2 but we default to 6.1 just in anticipation for cuda 12 deprecating 5.1</p>



<a name="263311989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263311989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263311989">(Dec 01 2021 at 15:58)</a>:</h4>
<p>Hmm yeah but LLVM would not be doing the work for us, we would need to do it in codegen because nvvm ir does not support it</p>



<a name="263312274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/codegen%20upstreaming%20requirements/near/263312274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/codegen.20upstreaming.20requirements.html#263312274">(Dec 01 2021 at 16:00)</a>:</h4>
<p>Although i probably will not be using NVVM IR intrinsics for it, i'll be using intrinsics implemented in cuda_std that use <code>atom</code> instructions on 7.x+ and "emulate" the ordering on &lt; 7.x</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>