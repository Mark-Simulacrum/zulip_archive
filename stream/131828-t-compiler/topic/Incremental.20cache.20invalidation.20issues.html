<html>
<head><meta charset="utf-8"><title>Incremental cache invalidation issues · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html">Incremental cache invalidation issues</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264298495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264298495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264298495">(Dec 09 2021 at 13:14)</a>:</h4>
<p>There are several reports like <a href="https://github.com/rust-lang/rust/issues/91702">#91702</a> popping up. This is caused by a change affecting the serialization format in <a href="https://github.com/rust-lang/rust/issues/91407">#91407</a><br>
I thought all caches are keyed on the compiler version, are they not?</p>



<a name="264298670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264298670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264298670">(Dec 09 2021 at 13:15)</a>:</h4>
<p><code>cargo clean</code> fixes it, but it's hitting more nightly users than I anticipated when making that PR. I assumed it would only affect rustc devs.</p>



<a name="264299844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264299844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264299844">(Dec 09 2021 at 13:24)</a>:</h4>
<p>I also thought they were - I think there's a metadata version constant somewhere, though, maybe we should bump that.</p>



<a name="264329749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264329749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264329749">(Dec 09 2021 at 16:49)</a>:</h4>
<p>There are several.</p>
<div class="codehilite"><pre><span></span><code>compiler/rustc_incremental/src/persist/file_format.rs
26:const HEADER_FORMAT_VERSION: u16 = 0;

compiler/rustc_metadata/src/rmeta/mod.rs
51:const METADATA_VERSION: u8 = 5;
58:pub const METADATA_HEADER: &amp;[u8] = &amp;[b&#39;r&#39;, b&#39;u&#39;, b&#39;s&#39;, b&#39;t&#39;, 0, 0, 0, METADATA_VERSION];

src/tools/cargo/src/cargo/core/compiler/future_incompat.rs
26:const ON_DISK_VERSION: u32 = 0;

src/tools/cargo/src/cargo/core/compiler/context/compilation_files.rs
23:const METADATA_VERSION: u8 = 2;
</code></pre></div>
<p>From the stack traces I guess it should be the rmeta one.</p>



<a name="264331249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264331249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264331249">(Dec 09 2021 at 16:59)</a>:</h4>
<p>Rust-analyzer will need to be updated too. It loads the rustc version from the crate metadata to determine which proc macro abi to use.</p>



<a name="264332810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264332810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264332810">(Dec 09 2021 at 17:09)</a>:</h4>
<p>It doesn't use rustc_metadata for that?</p>



<a name="264332875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264332875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264332875">(Dec 09 2021 at 17:09)</a>:</h4>
<p>No, but it does look at the rustc metadata, whose format got changed.</p>



<a name="264333173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264333173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264333173">(Dec 09 2021 at 17:11)</a>:</h4>
<p>PR for bumping the metadata version: <a href="https://github.com/rust-lang/rust/issues/91715">#91715</a></p>



<a name="264333374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264333374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264333374">(Dec 09 2021 at 17:12)</a>:</h4>
<p>Um, looks like github no longer forwards /issues/123 to /pull/123 for pull requests <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span></p>



<a name="264334028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264334028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264334028">(Dec 09 2021 at 17:16)</a>:</h4>
<p>I hope that's a bug and temporary</p>



<a name="264334332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264334332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264334332">(Dec 09 2021 at 17:18)</a>:</h4>
<p>I hope so too. I'm afraid it is (somewhat) intentional and won't be reverted if there isn't backlash against it.</p>



<a name="264334636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264334636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264334636">(Dec 09 2021 at 17:20)</a>:</h4>
<p>oh huh I found <a href="https://github.com/github/feedback/discussions/categories/general-feedback">https://github.com/github/feedback/discussions/categories/general-feedback</a> just now, that's new</p>



<a name="264357658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264357658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264357658">(Dec 09 2021 at 19:57)</a>:</h4>
<p>Above is: <a href="https://github.com/rust-lang/rust/pull/91715">https://github.com/rust-lang/rust/pull/91715</a> (since we are hitting <a class="stream-topic" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler/topic/GitHub.20stopped.20forwarding.20issue-num.20to.20pull-num">#t-compiler &gt; GitHub stopped forwarding issue-num to pull-num</a>  )</p>



<a name="264458191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264458191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264458191">(Dec 10 2021 at 14:57)</a>:</h4>
<p>So this caused a problem because it broke reading the rustc version string from the cache file?</p>



<a name="264458881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264458881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264458881">(Dec 10 2021 at 15:01)</a>:</h4>
<p>it actually was the rmeta format, not incremental cache. but yeah. the former encodes it as a string and the string format changed. boom.</p>



<a name="264470839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Incremental%20cache%20invalidation%20issues/near/264470839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Incremental.20cache.20invalidation.20issues.html#264470839">(Dec 10 2021 at 16:22)</a>:</h4>
<p>very subtle :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>