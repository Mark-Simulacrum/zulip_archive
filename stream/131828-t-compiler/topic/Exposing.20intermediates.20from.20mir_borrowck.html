<html>
<head><meta charset="utf-8"><title>Exposing intermediates from mir_borrowck · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Exposing.20intermediates.20from.20mir_borrowck.html">Exposing intermediates from mir_borrowck</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248890642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Exposing%20intermediates%20from%20mir_borrowck/near/248890642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Exposing.20intermediates.20from.20mir_borrowck.html#248890642">(Aug 09 2021 at 18:48)</a>:</h4>
<p>I've been working on a <a href="https://github.com/willcrichton/rust-slicer">static analysis</a> pass that requires access to information computed by the borrow checker. Specifically, the outlives-constraints graph. For my tool, I modified rustc to export this graph as a part of the <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.mir_borrowck"><code>TyCtxt::mir_borrowck</code></a> query. </p>
<p>This change isn't huge, it mostly requires shuffling around a few data structures from rustc_mir to rustc_middle so they can be part of the query interface. You can see the full diff here: <a href="https://github.com/rust-lang/rust/compare/master...willcrichton:expose-borrowck-info?expand=1">https://github.com/rust-lang/rust/compare/master...willcrichton:expose-borrowck-info?expand=1</a></p>
<p>Would it be possible to get this change merged into nightly? I'm not sure who the relevant person is to ask. Are there important considerations against doing it, and/or would an RFC be needed for this kind of change?</p>



<a name="248897169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Exposing%20intermediates%20from%20mir_borrowck/near/248897169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Exposing.20intermediates.20from.20mir_borrowck.html#248897169">(Aug 09 2021 at 19:40)</a>:</h4>
<p>You can dump <code>outlives</code> relationships  (and many others) to disk on current nightlies with <code>-Z nll-facts</code>. It's not exactly what you have now: due to a shortcoming in <a class="stream" data-stream-id="186049" href="/#narrow/stream/186049-t-compiler.2Fwg-polonius">#t-compiler/wg-polonius</a>,  constraints like "outlives at all locations" gets expanded into an <code>outlives</code> constraint at all points in the CFG. This can be changed pretty easily, however. I suspect you'll encounter less friction by building on top of this machinery rather than trying to export plugin-specific data through pre-existing queries, but it depends on how tightly you want to integate with <code>rustc</code>. The latter would probably require an MCP.</p>



<a name="248900162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Exposing%20intermediates%20from%20mir_borrowck/near/248900162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Exposing.20intermediates.20from.20mir_borrowck.html#248900162">(Aug 09 2021 at 20:03)</a>:</h4>
<p>(there was also <a href="https://github.com/rust-lang/rust/pull/86977">https://github.com/rust-lang/rust/pull/86977</a> -- easier than dumping and parsing facts on disk)</p>



<a name="248902759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Exposing%20intermediates%20from%20mir_borrowck/near/248902759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Exposing.20intermediates.20from.20mir_borrowck.html#248902759">(Aug 09 2021 at 20:20)</a>:</h4>
<p>Oh great! That PR subsumes my need, so I will just participate on that thread. Thanks <span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span> and <span class="user-mention" data-user-id="116113">@lqd</span> .</p>



<a name="248903478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Exposing%20intermediates%20from%20mir_borrowck/near/248903478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Exposing.20intermediates.20from.20mir_borrowck.html#248903478">(Aug 09 2021 at 20:26)</a>:</h4>
<p>niko has already reviewed it, vytautas has since fixed the failing MSVC test, let's trigger bors and see if it fails again</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>