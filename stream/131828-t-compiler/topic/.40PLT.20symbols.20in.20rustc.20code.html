<html>
<head><meta charset="utf-8"><title>@PLT symbols in rustc code · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html">@PLT symbols in rustc code</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="134822197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822197">(Sep 28 2018 at 13:04)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="131022">@Gabriel Majeri</span> Hi!</p>



<a name="134822237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822237" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822237">(Sep 28 2018 at 13:05)</a>:</h4>
<p>so I've looked around and realized the symbols which use the PLT are generated by LLVM code</p>



<a name="134822269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822269" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822269">(Sep 28 2018 at 13:05)</a>:</h4>
<p>to begin with, could you give me an idea how to make <code>x.py</code> rebuild the local LLVM if I've made a change?</p>



<a name="134822404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822404" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822404">(Sep 28 2018 at 13:07)</a>:</h4>
<p>I remember needing to actually stage the LLVM submodule changes so that <code>x.py</code> did not check-out the previous version</p>



<a name="134822479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822479" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822479">(Sep 28 2018 at 13:08)</a>:</h4>
<p>I recall there possibly being some flag(s) to make x.py not checkout submodules for you, but I don’t remember what they are.</p>



<a name="134822512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822512" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822512">(Sep 28 2018 at 13:08)</a>:</h4>
<p>LLVM making calls to @PLT seems plausible. This ties back into what I had suggested before: changing the <code>cc</code> crate.</p>



<a name="134822530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822530">(Sep 28 2018 at 13:09)</a>:</h4>
<p>(submodules? <a href="https://github.com/rust-lang/rust/blob/master/config.toml.example#L133" target="_blank" title="https://github.com/rust-lang/rust/blob/master/config.toml.example#L133">https://github.com/rust-lang/rust/blob/master/config.toml.example#L133</a>)</p>



<a name="134822550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822550" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822550">(Sep 28 2018 at 13:09)</a>:</h4>
<blockquote>
<p>(submodules? <a href="https://github.com/rust-lang/rust/blob/master/config.toml.example#L133" target="_blank" title="https://github.com/rust-lang/rust/blob/master/config.toml.example#L133">https://github.com/rust-lang/rust/blob/master/config.toml.example#L133</a>)</p>
</blockquote>
<p>yeah, that's the one.</p>



<a name="134822635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822635" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822635">(Sep 28 2018 at 13:10)</a>:</h4>
<p>hmm, well I set that to false, and even comitted my changes to the submodule and it seems like it doesn't work</p>



<a name="134822648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822648" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822648">(Sep 28 2018 at 13:10)</a>:</h4>
<p>I'd rather not do a clean rebuild of LLVM if possible</p>



<a name="134822686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822686" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822686">(Sep 28 2018 at 13:11)</a>:</h4>
<p>In that case you could <code>touch</code> <code>src/rustllvm/llvm-rebuild-trigger</code>, but I can’t immediatelly tell if it rebuilds from scratch or not</p>



<a name="134822690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822690" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822690">(Sep 28 2018 at 13:11)</a>:</h4>
<p>lemme try it for you</p>



<a name="134822795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822795">(Sep 28 2018 at 13:12)</a>:</h4>
<p>nevermind, I've deleted <code>llvm-finished-building</code> file and it works now</p>



<a name="134822858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134822858" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134822858">(Sep 28 2018 at 13:13)</a>:</h4>
<p>/me will try nevertheless, out of sheer interest</p>



<a name="134823636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134823636" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134823636">(Sep 28 2018 at 13:23)</a>:</h4>
<p>Yeah, it seems like touching <code>llvm-rebuild-trigger</code> does not help.</p>



<a name="134823649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134823649" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134823649">(Sep 28 2018 at 13:23)</a>:</h4>
<p>You <em>need</em> to remove the llvm-finished-building markerfile</p>



<a name="134823707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134823707" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134823707">(Sep 28 2018 at 13:24)</a>:</h4>
<p><span class="user-mention" data-user-id="131022">@Gabriel Majeri</span> the appropriate location to set flags for llvm build is in <code>src/librustc_llvm/build.rs</code> btw.</p>



<a name="134824293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824293" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824293">(Sep 28 2018 at 13:33)</a>:</h4>
<p>LLVM was already built with <code>-fno-plt</code> for me, because I set <code>CXXFLAGS=-fno-plt</code> and it picked that up</p>



<a name="134824353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824353" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824353">(Sep 28 2018 at 13:34)</a>:</h4>
<p>Something even weirder is going on here. I've completly removed the code to call functions through PLT from LLVM and it _still_ generates some PLT calls</p>



<a name="134824360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824360" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824360">(Sep 28 2018 at 13:34)</a>:</h4>
<p><a href="/user_uploads/4715/YEMmGkxS-GAtNw4S-ZkaKXFV/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/YEMmGkxS-GAtNw4S-ZkaKXFV/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/4715/YEMmGkxS-GAtNw4S-ZkaKXFV/pasted_image.png"></a></div>



<a name="134824414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824414" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824414">(Sep 28 2018 at 13:35)</a>:</h4>
<p>Literally, at this point even if I build with <code>-Z plt=yes</code>, LLVM should simply not know how to generate PLT calls, yet for some compiler intrinsics it still seems to generate them</p>



<a name="134824576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824576" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824576">(Sep 28 2018 at 13:37)</a>:</h4>
<p>Can you get a list of all @PLTd symbols at all?</p>



<a name="134824726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824726" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824726">(Sep 28 2018 at 13:39)</a>:</h4>
<p>OK, so for a simple <code>hello world</code> binary, the functions which use the PLT are: <code>_Unwind_Resume</code> and <code>__stack_chk_fail</code>, <code>memcpy</code> and <code>memset</code></p>



<a name="134824777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824777" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824777">(Sep 28 2018 at 13:40)</a>:</h4>
<p>These are all intrinsic functions, generated by LLVM implicitly</p>



<a name="134824802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134824802" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134824802">(Sep 28 2018 at 13:41)</a>:</h4>
<p>I added the <code>RtLibUseGOT</code> module flag to all Rust modules to ensure LLVM doesn't use the PLT for these calls, but it seems it didn't work?</p>



<a name="134825462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134825462" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134825462">(Sep 28 2018 at 13:51)</a>:</h4>
<blockquote>
<p>OK, so for a simple <code>hello world</code> binary, the functions which use the PLT are: <code>_Unwind_Resume</code> and <code>__stack_chk_fail</code>, <code>memcpy</code> and <code>memset</code></p>
</blockquote>
<p>At least some of those are provided by glibc, is it possible that calling function at all would <em>require</em> calling through @PLT?</p>



<a name="134825619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134825619" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134825619">(Sep 28 2018 at 13:53)</a>:</h4>
<p>No, that's the issue, on my Arch distro where every C binary is compiled with <code>-fno-plt</code>, there are absolutely no PLT mentions in the disassembly. I want to get Rust binaries to the same point.</p>



<a name="134825837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134825837" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134825837">(Sep 28 2018 at 13:56)</a>:</h4>
<p>Okay. So they cannot come from the standard library and <code>__stack_chk_fail</code> is definitely called by LLVM itself, yeah.</p>



<a name="134826004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134826004" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134826004">(Sep 28 2018 at 13:59)</a>:</h4>
<p>I’m honestly not sure where in LLVM @PLT calls are generated, so my guess is as good as yours. But I expected there to be more calls in the first place.</p>



<a name="134826010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134826010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134826010">(Sep 28 2018 at 13:59)</a>:</h4>
<p>if it is just those, that’s already very workable <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="134826106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134826106" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134826106">(Sep 28 2018 at 14:00)</a>:</h4>
<p>Yeah, I am happy to say that we got rid of 80-90% of the PLT calls. When the perf run was made, we had only gotten rid of 20% of the calls, so perf should be even better once it gets merged</p>



<a name="134826135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134826135" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134826135">(Sep 28 2018 at 14:00)</a>:</h4>
<p>lets run perf again, I guess.</p>



<a name="134826155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134826155" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134826155">(Sep 28 2018 at 14:01)</a>:</h4>
<p>I wanted to see if we can get rid of ALL the PLT calls before trying that</p>



<a name="134826183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134826183" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134826183">(Sep 28 2018 at 14:01)</a>:</h4>
<p>Feel free to keep trying. Whenever you’re ready just ping me and I’ll kick the perf off</p>



<a name="134829108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134829108" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134829108">(Sep 28 2018 at 14:42)</a>:</h4>
<p>Well I seem to be getting somewhere. It seems <code>libbacktrace</code>'s build file didn't take into account global CFLAGS, so after adding <code>-fno-plt</code> I managed to at least eliminate the <code>_Unwind_Resume@PLT</code> calls</p>



<a name="134829151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134829151" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134829151">(Sep 28 2018 at 14:43)</a>:</h4>
<p>I'll investigate the other calls, but it seems the story will be similar: C libraries (which don't respect CFLAGS) are the issue</p>



<a name="134829778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134829778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134829778">(Sep 28 2018 at 14:52)</a>:</h4>
<p>At least calls to <code>__stack_chk_fail@PLT</code> are entirely generated by LLVM</p>



<a name="134829831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134829831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134829831">(Sep 28 2018 at 14:53)</a>:</h4>
<p><span class="user-mention" data-user-id="131022">@Gabriel Majeri</span> you could just grep through disassembly of the whole binary for <code>call .*@PLT</code> to see <em>what</em> calls via PLT.</p>



<a name="134830467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134830467" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134830467">(Sep 28 2018 at 15:00)</a>:</h4>
<p>Oh lovely, it seems <code>jemalloc</code> is also betraying us.</p>



<a name="134830484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134830484" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134830484">(Sep 28 2018 at 15:01)</a>:</h4>
<p>Using the system allocator drastically reduces the number of PLT calls</p>



<a name="134831236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134831236" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134831236">(Sep 28 2018 at 15:11)</a>:</h4>
<p>Also, it seems <code>jemalloc</code> recorded the <code>-fno-plt</code> flag in the <code>SPECIFIED_CFLAGS</code> Makefile variable, but then decided to ignore it when building</p>



<a name="134838843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134838843" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Majeri <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134838843">(Sep 28 2018 at 17:20)</a>:</h4>
<p>Well I don't think there's much more I can do here. The issue is with C code, and the best solution I guess is to eventually rewrite everything in Rust :)</p>



<a name="134843083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%40PLT%20symbols%20in%20rustc%20code/near/134843083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.40PLT.20symbols.20in.20rustc.20code.html#134843083">(Sep 28 2018 at 18:30)</a>:</h4>
<blockquote>
<p>Well I don't think there's much more I can do here. The issue is with C code, and the best solution I guess is to eventually rewrite everything in Rust <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>
</blockquote>
<p>I’m starting another perf run then</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>