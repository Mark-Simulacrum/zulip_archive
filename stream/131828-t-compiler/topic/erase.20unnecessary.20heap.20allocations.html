<html>
<head><meta charset="utf-8"><title>erase unnecessary heap allocations · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html">erase unnecessary heap allocations</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272374489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272374489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sirui Mu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272374489">(Feb 18 2022 at 08:42)</a>:</h4>
<p>Currently, <code>rustc</code> does not optimize out simple occasions such as <code>Box::new(*ptr)</code> where <code>ptr</code> is a <code>Box&lt;T&gt;</code>. The compiler still emits a deallocation and an allocation in optimization build. Is there any reason for not optimizing out the memory allocations?</p>



<a name="272375469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272375469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272375469">(Feb 18 2022 at 08:52)</a>:</h4>
<p>There is actually an LLVM optimization just for this case, but it's never worked reliably I think</p>



<a name="272375478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272375478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272375478">(Feb 18 2022 at 08:53)</a>:</h4>
<p>LLVM doesn't know about the size of the original allocation. It may be bigger than the new allocation, in which case optimizing the alloc and dealloc away would increase memory usage.</p>



<a name="272375534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272375534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272375534">(Feb 18 2022 at 08:53)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> There is an optimization for the opposite case. (alloc then dealloc the same allocation)</p>



<a name="272376054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272376054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sirui Mu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272376054">(Feb 18 2022 at 08:59)</a>:</h4>
<p>I think this optimization can be done on the MIR. Does it worth implementing?</p>



<a name="272376230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272376230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272376230">(Feb 18 2022 at 09:00)</a>:</h4>
<p>How common is it? I don't think it is really common.</p>



<a name="272377954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272377954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272377954">(Feb 18 2022 at 09:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="347308">Sirui Mu</span> <a href="#narrow/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations/near/272374489">said</a>:</p>
<blockquote>
<p>The compiler still emits a deallocation and an allocation in optimization build. Is there any reason for not optimizing out the memory allocations?</p>
</blockquote>
<p>I opened an issue about this about 2 weeks ago, actually: <a href="https://github.com/rust-lang/rust/issues/93707">https://github.com/rust-lang/rust/issues/93707</a></p>
<p>With <code>free</code> this would be hard, but since rust's dealloc is passed the layout, I think this would be completely doable.  The LLVM currently looks like</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="w">  </span><span class="k">tail</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@__rust_dealloc</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">nonnull</span><span class="w"> </span><span class="nv">%_2.i.i.i.i</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="vg">#4</span><span class="w"></span>
<span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">tail</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">dereferenceable_or_null</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="vg">@__rust_alloc</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="vg">#4</span><span class="w"></span>
</code></pre></div>
<p>so it can see that both are size-4-align-4 and thus the allocation could be re-used.</p>



<a name="272378028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272378028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272378028">(Feb 18 2022 at 09:20)</a>:</h4>
<p>(I don't know if it's actually <em>common</em> that this would be applicable, though.)</p>



<a name="272383845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/erase%20unnecessary%20heap%20allocations/near/272383845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sirui Mu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations.html#272383845">(Feb 18 2022 at 10:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/erase.20unnecessary.20heap.20allocations/near/272376230">said</a>:</p>
<blockquote>
<p>How common is it? I don't think it is really common.</p>
</blockquote>
<p>I have not taken a research about how common it is. I just come across this problem in one of my projects and it surprises me since rustc can do pretty many optimizations on <code>Box</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>