<html>
<head><meta charset="utf-8"><title>Using Intrinsics Generically · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html">Using Intrinsics Generically</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276564088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276564088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276564088">(Mar 25 2022 at 02:14)</a>:</h4>
<p>Is it important that code like this, found in <code>src/test/mir-opt/lower_intrinsics.rs</code>, not ICE?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wrapping</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Copy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">intrinsics</span>::<span class="n">wrapping_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">intrinsics</span>::<span class="n">wrapping_sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">intrinsics</span>::<span class="n">wrapping_mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Specifically, I'm improving the MIR validator at the moment and one of the things I would like to check is that <code>Rvalue::BinOp</code>s are used with appropriate types. I could of course add type parameters to the accepted types, but if this isn't supposed to work anyway it might be better to just switch the test to use <code>i32</code> or something</p>



<a name="276564379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276564379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276564379">(Mar 25 2022 at 02:20)</a>:</h4>
<p>Trying to codegen this with a wrong type ICEs already</p>



<a name="276576156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276576156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276576156">(Mar 25 2022 at 04:43)</a>:</h4>
<p>I think it's important that that function definition not ICE, yes -- it's very handy to add new intrinsics to bootstrap by calling other intrinsics in that way.  See, for example, <a href="https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386">https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386</a></p>
<p>If they ICE when <em>called</em> with wrong types that's definitely fine.</p>



<a name="276576344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276576344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276576344">(Mar 25 2022 at 04:48)</a>:</h4>
<p>But it would also be fine for that to only work in some restricted functions.  I don't think there's any ordinary code that needs to be able to do it.  Just special <code>core</code> stuff.</p>



<a name="276576738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276576738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276576738">(Mar 25 2022 at 04:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276576344">said</a>:</p>
<blockquote>
<p>But it would also be fine for that to only work in some restricted functions.  I don't think there's any ordinary code that needs to be able to do it.  Just special <code>core</code> stuff.</p>
</blockquote>
<p>I don't think this part makes a difference. What I'd like is for MIR passes to be able to assume they won't see things like this. Hm, let me think about this some more</p>



<a name="276577019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276577019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276577019">(Mar 25 2022 at 05:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276576156">said</a>:</p>
<blockquote>
<p>I think it's important that that function definition not ICE, yes -- it's very handy to add new intrinsics to bootstrap by calling other intrinsics in that way.  See, for example, <a href="https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386">https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386</a></p>
<p>If they ICE when <em>called</em> with wrong types that's definitely fine.</p>
</blockquote>
<p>Can't this kind of thing be done in the "surface level" functions? ie in this case the unstable functions on the numeric types? That requires a little more verbosity, but I don't think it's that bad</p>



<a name="276578161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276578161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276578161">(Mar 25 2022 at 05:29)</a>:</h4>
<p>I really want there to be one function for the new thing.</p>
<p>That'd also fit better with <a href="https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451">https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451</a> (cc <span class="user-mention" data-user-id="124288">@oli</span>) because if this kind of thing wasn't an intrinsic (in the current meaning of the word) then it would be extra annoying for backends to have to match "codegen items" for all 16 different integer types, rather than just the one <code>add_unchecked</code> item that has a body that defaults to the right thing.</p>
<p>Maybe you could do this from the other direction, and stop lowering <em>generic</em> uses of intrinsics to MIR ops in <a href="https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64">https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64</a> ?</p>



<a name="276578256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276578256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276578256">(Mar 25 2022 at 05:31)</a>:</h4>
<p>Obligatory caveat: I'm not actually on the compiler team, nor a "compiler contributor", so my opinion is not necessarily important.</p>



<a name="276578870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276578870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276578870">(Mar 25 2022 at 05:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276578161">said</a>:</p>
<blockquote>
<p>I really want there to be one function for the new thing.</p>
<p>That'd also fit better with <a href="https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451">https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451</a> (cc <span class="user-mention silent" data-user-id="124288">oli</span>) because if this kind of thing wasn't an intrinsic (in the current meaning of the word) then it would be extra annoying for backends to have to match "codegen items" for all 16 different integer types, rather than just the one <code>add_unchecked</code> item that has a body that defaults to the right thing.</p>
</blockquote>
<p>I don't think this is an issue. I'm proposing to have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(stage0)]</span><span class="w"></span>
<span class="n">overflow</span><span class="p">();</span><span class="w"></span>
<span class="cp">#[cfg(not(stage0))]</span><span class="w"></span>
<span class="n">intrinsic</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>in the integer functions - codegen will see an intrinsic in either case. Actually, I think Oli's proposal would resolve this issue from my pov, because if I am understanding correctly we would no longer have MIR bodies that have generic usages of MIR ops that are supposed to be non-generic. (<strong>Edit:</strong> Wait, maybe I got that backwards and it actually wouldn't)</p>
<blockquote>
<p>Maybe you could do this from the other direction, and stop lowering <em>generic</em> uses of intrinsics to MIR ops in <a href="https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64">https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64</a> ?</p>
</blockquote>
<p>I don't think this would be correct - intrinsic lowering is currently guaranteed as far as I know, which means that probably codegen backends are not expecting to see the intrinsic invocation for intrinsics that have an associated MIR opt.</p>
<p>That being said, I realize this is actually a non-issue for any intrinsics that do not get lowered to MIR ops, so something like the non-overflowing stuff wouldn't be affected. This probably makes the change much more feasible.</p>
<p>In any case, I'll add the generic param for now, since it seems like there might be legitimate use cases for this.</p>



<a name="276579069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276579069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276579069">(Mar 25 2022 at 05:48)</a>:</h4>
<p>Honestly, now that I think about it, it probably makes the most sense to explicitly differentiate between those intrinsics that get lowered to MIR ops and those that don't. For the second kind it's not a problem to allow these kinds of things in MIR, and I think those are also the only ones it's interesting for</p>



<a name="276579432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276579432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276579432">(Mar 25 2022 at 05:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276578870">said</a>:</p>
<blockquote>
<p>That being said, I realize this is actually a non-issue for any intrinsics that do not get lowered to MIR ops, so something like the non-overflowing stuff wouldn't be affected. This probably makes the change much more feasible.</p>
</blockquote>
<p>Oh, that's a very good point.  It basically only affects <code>wrapping_*</code>, since everything else that lowers to MIR is generic anyway.</p>
<p>Might be fine to just change that test to a different intrinsic and be more stringent in the validator, then.</p>



<a name="276579744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276579744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276579744">(Mar 25 2022 at 06:00)</a>:</h4>
<p>Yeah, I just checked - <code>wrapping_*</code> is literally the only thing this affects, so this is probably fine then. Cool, that makes me happy</p>



<a name="276592122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276592122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276592122">(Mar 25 2022 at 09:10)</a>:</h4>
<p>Yea, the amount of generics will get reduces a lot on integer intrinsics, but others like copy_nonoverlapping and SIMD intrinsics are inherently generic</p>



<a name="276592237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Using%20Intrinsics%20Generically/near/276592237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically.html#276592237">(Mar 25 2022 at 09:11)</a>:</h4>
<p>Maybe I make an MVP of the new intrinsic scheme for just one intrinsic so that we can create a tracking issue for the rest and get some contributors to munch away on them</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>