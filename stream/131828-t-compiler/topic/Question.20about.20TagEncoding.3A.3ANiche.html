<html>
<head><meta charset="utf-8"><title>Question about TagEncoding::Niche · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html">Question about TagEncoding::Niche</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263472558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263472558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263472558">(Dec 02 2021 at 17:29)</a>:</h4>
<p>I am not exactly sure how tags are transformed into discriminants, can anyone ELI5 to me the computation to go from tag to discriminant? I'm trying to reverse that computation to get a SwitchTargets that works on the tag itself</p>



<a name="263476917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263476917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263476917">(Dec 02 2021 at 18:00)</a>:</h4>
<p>This is the logic cg_clif uses: <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/516b478c8161c7a90e604f96d0f5878990550f21/src/discriminant.rs#L63-L169">https://github.com/bjorn3/rustc_codegen_cranelift/blob/516b478c8161c7a90e604f96d0f5878990550f21/src/discriminant.rs#L63-L169</a></p>



<a name="263522581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263522581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263522581">(Dec 03 2021 at 01:03)</a>:</h4>
<p>Here is the code in rustc for converting a variant to a discriminant <a href="https://doc.rust-lang.org/beta/nightly-rustc/src/rustc_middle/ty/adt.rs.html#432-436">https://doc.rust-lang.org/beta/nightly-rustc/src/rustc_middle/ty/adt.rs.html#432-436</a></p>



<a name="263582607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263582607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263582607">(Dec 03 2021 at 13:56)</a>:</h4>
<p>Thanks. In a <code>SwitchInt</code> that matches on a <code>Discriminant(_)</code> of an niche-encoded enum, the values are always discriminants, which are always variant indices, right?</p>



<a name="263584201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263584201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263584201">(Dec 03 2021 at 14:06)</a>:</h4>
<p>Discriminants can be different from variant indices. Discriminants are what you write as user using eg <code>Foo = 100</code>, while variant indices always start from 0.</p>



<a name="263585082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263585082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263585082">(Dec 03 2021 at 14:13)</a>:</h4>
<p>I said "of a niche-encoded enum" though. A niche-encoded enum cannot have explicit discriminants</p>



<a name="263675112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263675112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263675112">(Dec 04 2021 at 01:44)</a>:</h4>
<p>A niche-encoded enum will use unused bit patterns, which aren't necessarily the same as variant indices either IIUC.</p>



<a name="263675229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263675229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263675229">(Dec 04 2021 at 01:47)</a>:</h4>
<p>So, e.g., let's say <code>None</code> has variant index zero. With <code>Option&lt;char&gt;</code>, its discriminant will be a large value that's not in use in Unicode:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="c1">// prints 1114112</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="263675243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263675243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263675243">(Dec 04 2021 at 01:47)</a>:</h4>
<p>So the variant index is different from the discriminant; my understanding is the variant index is more like a DefId.</p>



<a name="263675956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263675956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263675956">(Dec 04 2021 at 02:02)</a>:</h4>
<blockquote>
<p>In a <code>SwitchInt</code> that matches on a <code>Discriminant(_)</code> of an niche-encoded enum, the values are always discriminants, which are always variant indices, right?</p>
</blockquote>
<p>Right. The current implementation uses niche optimization only if there are no explicit discriminants, since it relies on variant indices and discriminants matching exactly: <a href="https://github.com/rust-lang/rust/blob/532d2b14c05f9bc20b2d27cbb5f4550d28343a36/compiler/rustc_middle/src/ty/layout.rs#L1036-L1047">https://github.com/rust-lang/rust/blob/532d2b14c05f9bc20b2d27cbb5f4550d28343a36/compiler/rustc_middle/src/ty/layout.rs#L1036-L1047</a></p>



<a name="263676465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263676465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263676465">(Dec 04 2021 at 02:12)</a>:</h4>
<blockquote>
<p>since it relies on variant indices and discriminants matching exactly</p>
</blockquote>
<p>That is really bizarre. Indeed, </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(core_intrinsics)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">intrinsics</span>::<span class="n">discriminant_value</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Option</span>::<span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span>::<span class="nb">None</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>prints <code>0</code>. That's obviously not the "real" discriminant, which is effectively 1114112. But I guess returning that would expose the unstable layout details?</p>



<a name="263676490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263676490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263676490">(Dec 04 2021 at 02:13)</a>:</h4>
<blockquote>
<p>if T has no discriminant, returns 0.</p>
</blockquote>
<p>Ah, so perhaps the 0 it's returning is a "sentinel value". Why doesn't this intrinsic return <code>Option&lt;&lt;T as DiscriminantKind&gt;::Discriminant&gt;</code>?</p>



<a name="263684195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263684195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263684195">(Dec 04 2021 at 04:56)</a>:</h4>
<p>Try calling it with a <code>Some</code>; I suspect that's a "real" discriminant, just not one set by a user.  (The same way that <code>enum Foo { Zero, One, Two }</code> has "real" discriminants despite the lack of <code>= 1</code>, <code>=2</code>, ...)</p>



<a name="263684489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263684489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263684489">(Dec 04 2021 at 05:02)</a>:</h4>
<p>But it's not a discriminant (since it's a niche-encoded variant), though I guess it could be the VariantIdx?</p>



<a name="263684508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263684508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263684508">(Dec 04 2021 at 05:03)</a>:</h4>
<p><code>Some</code> returns 1, so yeah, I suspect it's actually returning the VariantIdx...</p>



<a name="263691342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263691342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263691342">(Dec 04 2021 at 07:55)</a>:</h4>
<blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(core_intrinsics)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">intrinsics</span>::<span class="n">discriminant_value</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Option</span>::<span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span>::<span class="nb">None</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>prints <code>0</code>. That's obviously not the "real" discriminant, which is effectively 1114112.</p>
</blockquote>
<p>The encoding of discriminant in a memory is called tag. The discriminant of None variant is zero, which is encoded by a tag 1114112.</p>



<a name="263691771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Question%20about%20TagEncoding%3A%3ANiche/near/263691771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Question.20about.20TagEncoding.3A.3ANiche.html#263691771">(Dec 04 2021 at 08:06)</a>:</h4>
<p>Regarding the question about target values in <code>switchInt</code> matching on a discriminant, I would also mention the general caveat that the target values can be arbitrary, since the MIR could correspond to a user written code. For example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">intrinsics</span>::<span class="n">discriminant_value</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">42</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span><span class="w"></span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>