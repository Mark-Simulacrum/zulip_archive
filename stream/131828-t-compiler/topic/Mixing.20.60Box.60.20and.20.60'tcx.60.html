<html>
<head><meta charset="utf-8"><title>Mixing `Box` and `&#x27;tcx` · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html">Mixing `Box` and `&#x27;tcx`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261880357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880357">(Nov 18 2021 at 02:59)</a>:</h4>
<p>Consider this snippet:</p>
<div class="codehilite"><pre><span></span><code>pub enum StatementKind&lt;&#39;tcx&gt; {
    /// Write the RHS Rvalue to the LHS Place.
    Assign(Box&lt;(Place&lt;&#39;tcx&gt;, Rvalue&lt;&#39;tcx&gt;)&gt;),
</code></pre></div>
<p>It seems weird to mix <code>Box</code> and <code>'tcx</code> (which means arena allocation).</p>



<a name="261880475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880475">(Nov 18 2021 at 03:00)</a>:</h4>
<p>Should there be an <code>ArenaBox</code> type that's a bit like <code>List</code>, but containing a single element?</p>



<a name="261880522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880522">(Nov 18 2021 at 03:01)</a>:</h4>
<p>Having a <code>Box</code> within a <code>&lt;'tcx&gt;</code> type means it requires <code>drop</code>. Avoiding that seems like it can only help performance.</p>



<a name="261880597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880597">(Nov 18 2021 at 03:02)</a>:</h4>
<p>Are you suggesting that we intern all combinations of <code>Place</code> and <code>Rvalue</code> that appear in a program?</p>



<a name="261880602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880602">(Nov 18 2021 at 03:02)</a>:</h4>
<p>Or do them separately?</p>



<a name="261880649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880649">(Nov 18 2021 at 03:03)</a>:</h4>
<p>(I assume the reason it's in a <code>Box</code> is to make<code>StatementKind</code> smaller)</p>



<a name="261880740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880740">(Nov 18 2021 at 03:05)</a>:</h4>
<p>I think interning is a separate question; I don't know if that would be worthwhile</p>



<a name="261880757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880757">(Nov 18 2021 at 03:05)</a>:</h4>
<p>Just generally, having types that are a mixture of arena allocation and vanilla heap allocation seems odd</p>



<a name="261880832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880832">(Nov 18 2021 at 03:06)</a>:</h4>
<p>Arena allocation is an optimization for when you have lots of objects that can be freed at the same time, which allows for cheaper allocation <em>and</em> deallocation. So why not use it for everything you can...</p>



<a name="261880867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261880867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261880867">(Nov 18 2021 at 03:07)</a>:</h4>
<p><code>StatementKind</code> is just one of a number of types for which this observation applies.</p>



<a name="261881017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881017">(Nov 18 2021 at 03:10)</a>:</h4>
<p>Similar story for <code>Vec</code>:</p>
<div class="codehilite"><pre><span></span><code>pub struct BasicBlockData&lt;&#39;tcx&gt; {
    /// List of statements in this block.
    pub statements: Vec&lt;Statement&lt;&#39;tcx&gt;&gt;,
</code></pre></div>



<a name="261881034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881034">(Nov 18 2021 at 03:10)</a>:</h4>
<p>The number of <code>BasicBlockData</code> instances will be much less than the number of <code>StatementKind</code> instances, so the potential benefit in that case is smaller.</p>



<a name="261881058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881058">(Nov 18 2021 at 03:11)</a>:</h4>
<p>And maybe the flexibilty of <code>Vec</code> (allowing growth) might be required, an <code>ArenaVec</code> may well lack that flexibility</p>



<a name="261881068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881068">(Nov 18 2021 at 03:11)</a>:</h4>
<p>Makes sense. Do we do non-interned arena allocated types right now?</p>



<a name="261881113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881113">(Nov 18 2021 at 03:12)</a>:</h4>
<p>Yes</p>



<a name="261881173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881173">(Nov 18 2021 at 03:13)</a>:</h4>
<p>I'm thinking about this stuff because the other day I tried shrinking one arena-allocated type by using a <code>Box</code> within it (to shrink a variant). I noticed that it went from being allocated in a <code>DroplessArena</code> (used for multiple types that don't impl <code>Drop</code>) to a <code>TypedArena</code> (used for an individual type that does impl <code>Drop</code>).</p>



<a name="261881275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881275">(Nov 18 2021 at 03:15)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_middle/src/arena.rs">https://github.com/rust-lang/rust/blob/master/compiler/rustc_middle/src/arena.rs</a> shows one set of arenas, there are lots of non-interned types in there. Even things like <code>FxHashSet</code>.</p>



<a name="261881362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881362">(Nov 18 2021 at 03:17)</a>:</h4>
<p><code>Statement</code>s get added and removed pretty frequently during MIR transformation, so their lifetime isn't quite the lifetime of the program. Also, arena allocating means you don't have unique ownership, right? So to update an assignment you'd have to allocate a new one?</p>



<a name="261881377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881377">(Nov 18 2021 at 03:17)</a>:</h4>
<p>Could still be worth it though. I don't know.</p>



<a name="261881524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881524">(Nov 18 2021 at 03:20)</a>:</h4>
<p>Yes, I think you're right on both counts.</p>



<a name="261881567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881567">(Nov 18 2021 at 03:20)</a>:</h4>
<p>I'm wrong btw. Bumpalo doesn't require interior mutability.</p>



<a name="261881577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881577">(Nov 18 2021 at 03:20)</a>:</h4>
<p>Maybe <code>rustc</code> does though.</p>



<a name="261881673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881673">(Nov 18 2021 at 03:22)</a>:</h4>
<p><code>Arena::alloc</code> (and similar functions) returns a <code>&amp;mut T</code></p>



<a name="261881722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881722">(Nov 18 2021 at 03:23)</a>:</h4>
<p>Ah, okay. Wrong everywhere.</p>



<a name="261881808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881808">(Nov 18 2021 at 03:24)</a>:</h4>
<p>For interned values that are arena-allocated, they must be immutable</p>



<a name="261881823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881823">(Nov 18 2021 at 03:25)</a>:</h4>
<p>Yeah, clearly I'm stuck in the interning mindset.</p>



<a name="261881853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881853">(Nov 18 2021 at 03:25)</a>:</h4>
<p>If you can mutate through the <code>ArenaBox</code>, I kind of doubt that we delete and then recreate a bunch of <code>StatementKind::Assign</code>s, even during MIR optimization. Arena allocation might be a good fit.</p>



<a name="261881854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881854">(Nov 18 2021 at 03:25)</a>:</h4>
<p>I think you are right about <code>Statement</code> lifetimes possibly being shorter than the arena lifetime, though</p>



<a name="261881902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881902">(Nov 18 2021 at 03:26)</a>:</h4>
<p>Nice to have you back by the way!</p>



<a name="261881905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261881905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261881905">(Nov 18 2021 at 03:26)</a>:</h4>
<p>Thanks! It's good to be back <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261882940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261882940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261882940">(Nov 18 2021 at 03:48)</a>:</h4>
<p>Right, so here's an example where we do a vanilla arena-allocation without interning:</p>
<div class="codehilite"><pre><span></span><code>pub enum AggregateKind&lt;&#39;tcx&gt; {
    ...
    Adt2(&amp;&#39;tcx AdtDef, VariantIdx, SubstsRef&lt;&#39;tcx&gt;, Option&lt;UserTypeAnnotationIndex&gt;, Option&lt;usize&gt;),
    ...
}
</code></pre></div>



<a name="261883046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883046">(Nov 18 2021 at 03:51)</a>:</h4>
<p>And the allocation happens here: <a href="https://github.com/rust-lang/rust/blob/efd0483949496b067cd5f7569d1b28cd3d5d3c72/compiler/rustc_middle/src/ty/context.rs#L1075-L1083">https://github.com/rust-lang/rust/blob/efd0483949496b067cd5f7569d1b28cd3d5d3c72/compiler/rustc_middle/src/ty/context.rs#L1075-L1083</a></p>



<a name="261883096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883096">(Nov 18 2021 at 03:52)</a>:</h4>
<p>This makes me realize we don't need a <code>BoxArena&lt;T&gt;</code> type, <code>&amp;'tcx T</code> is exactly that</p>



<a name="261883134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883134">(Nov 18 2021 at 03:53)</a>:</h4>
<p>This comment suggests that other people also have some expectation that "arena-allocated" == "interned": <a href="https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_middle/src/ty/adt.rs#L60">https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_middle/src/ty/adt.rs#L60</a>. In this case the <code>AdtDef</code> is <em>not</em> interned</p>



<a name="261883149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883149">(Nov 18 2021 at 03:53)</a>:</h4>
<p>At least, not in the sense of "guaranteed only one in existence and therefore we can use pointer equality"</p>



<a name="261883156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883156">(Nov 18 2021 at 03:53)</a>:</h4>
<p>Well, I think we use 'tcx for lifetime purposes so that interned types can be referenced. Sticking in more 'tcx wouldn't help readability, and arena allocation isn't as easy to use as a Box (and couldn't be matched in pattern directly)</p>



<a name="261883161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883161">(Nov 18 2021 at 03:53)</a>:</h4>
<p>Well, not exactly that. <code>&amp;'tcx</code> doesn't allow mutation</p>



<a name="261883225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883225">(Nov 18 2021 at 03:54)</a>:</h4>
<p><code>&amp;'tcx</code> means it couldn't be deallocated.</p>



<a name="261883230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883230">(Nov 18 2021 at 03:55)</a>:</h4>
<p>I think <code>bumpalo</code> works by keeping a reference count for the entire arena?</p>



<a name="261883444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883444">(Nov 18 2021 at 03:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60'tcx.60/near/261883134">said</a>:</p>
<blockquote>
<p>This comment suggests that other people also have some expectation that "arena-allocated" == "interned": <a href="https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_middle/src/ty/adt.rs#L60">https://github.com/rust-lang/rust/blob/55111d656f7ecd511ebfad09d3b4b41e44cbcc23/compiler/rustc_middle/src/ty/adt.rs#L60</a>. In this case the <code>AdtDef</code> is <em>not</em> interned</p>
</blockquote>
<p>It was interned in the distant past, but that was changed at some point</p>



<a name="261883495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883495">(Nov 18 2021 at 03:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60'tcx.60/near/261883230">said</a>:</p>
<blockquote>
<p>I think <code>bumpalo</code> works by keeping a reference count for the entire arena?</p>
</blockquote>
<p>Oh, no <code>Box</code> has a lifetime parameter, duh.</p>



<a name="261883741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261883741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261883741">(Nov 18 2021 at 04:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60'tcx.60/near/261883096">said</a>:</p>
<blockquote>
<p>This makes me realize we don't need a <code>BoxArena&lt;T&gt;</code> type, <code>&amp;'tcx T</code> is exactly that</p>
</blockquote>
<p><code>&amp;'tcx mut T</code> is exactly that though. But I haven't seen that pattern in the compiler much. Not sure why.</p>



<a name="261884303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261884303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261884303">(Nov 18 2021 at 04:12)</a>:</h4>
<p>I'm experimenting with changing one <code>Box&lt;Place&lt;'tcx&gt;&gt;</code>with <code>&amp;'tcx mut T</code>, in <code>StatementKind::Retag</code>.</p>



<a name="261884312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261884312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261884312">(Nov 18 2021 at 04:12)</a>:</h4>
<p>First problem:</p>
<div class="codehilite"><pre><span></span><code>1552 |       Retag(RetagKind, &amp;&#39;tcx mut Place&lt;&#39;tcx&gt;),
     |                        ^^^^^^^^^^^^^^^^^^^^^ the trait `std::clone::Clone` is not implemented for `&amp;mut mir::Place&lt;&#39;_&gt;`
</code></pre></div>



<a name="261884911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261884911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261884911">(Nov 18 2021 at 04:25)</a>:</h4>
<p>So you'd have add a <code>CloneIntoArena</code> abstraction. Looks like that would be compatible with <code>TypeFoldable</code> (which requires <code>Clone</code>), since <code>TypeFolder</code> provides access to the <code>TyCtxt&lt;'tcx&gt;</code>.</p>



<a name="261885080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885080">(Nov 18 2021 at 04:28)</a>:</h4>
<blockquote>
<p>So you'd have add a CloneIntoArena abstraction.</p>
</blockquote>
<p>Can you elaborate? I'm having trouble picturing exactly what this means</p>



<a name="261885166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885166">(Nov 18 2021 at 04:30)</a>:</h4>
<p>Well, the <code>Clone</code> impl for <code>StatementKind</code> creates a deep copy of the boxed <code>Place</code>. We'd want to emulate that behavior by creating a second arena allocated place equal to the first one.</p>



<a name="261885184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885184">(Nov 18 2021 at 04:30)</a>:</h4>
<p>Alternatively, I doubt the <code>Retag</code> place is ever actually mutated, so it could probably be a shared reference.</p>



<a name="261885217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885217">(Nov 18 2021 at 04:31)</a>:</h4>
<p>But that won't work for <code>StatementKind::Assign</code>, which I'm sure does get mutated.</p>



<a name="261885413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885413">(Nov 18 2021 at 04:34)</a>:</h4>
<p><code>StatementKind</code> currently derives <code>Clone</code>, and I'd prefer to keep it that way, so I guess I need to introduce a new type that wraps the <code>&amp;'tcx mut T</code> and implement <code>Clone</code> on that</p>



<a name="261885525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885525">(Nov 18 2021 at 04:37)</a>:</h4>
<p>Hmm, I'm skeptical <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>. A shallow copy would create two mutable references to the same <code>T</code>, but a deep copy requires access to an arena to allocate into.</p>



<a name="261885774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Mixing%20%60Box%60%20and%20%60%27tcx%60/near/261885774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Mixing.20.60Box.60.20and.20.60&#x27;tcx.60.html#261885774">(Nov 18 2021 at 04:42)</a>:</h4>
<p>mmm</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>