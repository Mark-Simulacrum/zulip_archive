<html>
<head><meta charset="utf-8"><title>When does inlining happen? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html">When does inlining happen?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264973822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/264973822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#264973822">(Dec 15 2021 at 07:34)</a>:</h4>
<p>When does inlining happen? Is it a MIR transformation? LLVM? Something else?</p>



<a name="264974665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/264974665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#264974665">(Dec 15 2021 at 07:48)</a>:</h4>
<p>There's a MIR inliner, but it's off by default.  Turning it on is <a href="https://github.com/rust-lang/rust/issues/81567">#81567</a>.</p>
<p>Otherwise it's LLVM that does it.  And IIRC it's always bottom-up, for better or worse.</p>



<a name="265073531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265073531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265073531">(Dec 15 2021 at 20:53)</a>:</h4>
<p>Thanks!</p>



<a name="265074932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265074932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265074932">(Dec 15 2021 at 21:05)</a>:</h4>
<p>some discussion of when it's <em>not</em> bottom-up: <a href="https://reviews.llvm.org/D115497">https://reviews.llvm.org/D115497</a></p>



<a name="265077218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265077218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265077218">(Dec 15 2021 at 21:26)</a>:</h4>
<blockquote>
<p>LLVM uses a bottom-up inliner, and the fact that functions are processed bottom-up is not just a question of optimality -- it is a critically imporant requirement to prevent runaway inlining. </p>
</blockquote>
<p>Odd. Afaik java's incremental inliner manages to inline in the middle of the call-graph without runaway inlining. They iterate inline-optimize-inline-... as long as the function stays within some size limit (+ some recursion budget for pathological cases).</p>



<a name="265084163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265084163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265084163">(Dec 15 2021 at 22:18)</a>:</h4>
<p>Oh, interesting.  Thanks, @​<strong>cuviper</strong></p>



<a name="265084373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265084373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265084373">(Dec 15 2021 at 22:20)</a>:</h4>
<p>I've been thinking that some of the best MIR inlining opportunities would be top-down, actually.  Like <code>&lt;&amp;A: PartialOrd&lt;&amp;B&gt;&gt;</code>, for example, where the derefs are likely free in the caller, and much better than inlining another copy of the actual comparison logic.</p>



<a name="265211673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265211673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265211673">(Dec 16 2021 at 20:02)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> Doing top-down inlining is fine, you just can't do it with a bottom-up cost model.</p>



<a name="265224546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265224546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265224546">(Dec 16 2021 at 21:50)</a>:</h4>
<p>Somewhat tangential: I'd also love to be able to <em>suggest</em> top-down inlining for certain functions.  Like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline(top_down)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="n">i</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inner</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// This one intentionally not marked `#[inline]`</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="n">i</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Because it's pretty common for precondition checks to be able to be removed in callers, but they never can at the top of non-inlined functions.</p>



<a name="265234317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265234317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265234317">(Dec 16 2021 at 23:23)</a>:</h4>
<p><code>#[inline(callees)]</code>? <em>bikeshed</em></p>



<a name="265234446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265234446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265234446">(Dec 16 2021 at 23:24)</a>:</h4>
<p>That sounds like it would inline child functions, not tell the parent to inline the annotated one before considering its children</p>



<a name="265234906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265234906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265234906">(Dec 16 2021 at 23:30)</a>:</h4>
<p>Hm.</p>



<a name="265240476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265240476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265240476">(Dec 17 2021 at 00:40)</a>:</h4>
<p><code>#[inline(shallow)]</code> might work</p>



<a name="265240596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265240596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265240596">(Dec 17 2021 at 00:42)</a>:</h4>
<p>Oh yeah you're right, I was mentally mis-modeling it.</p>



<a name="265361320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/When%20does%20inlining%20happen%3F/near/265361320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/When.20does.20inlining.20happen.3F.html#265361320">(Dec 17 2021 at 21:14)</a>:</h4>
<p>And yeah, I agree re: <code>#[inline(top_down)]</code> annotation would be nice. I would definitely like to use it on certain <code>std::simd</code> functions that do various kinds of bounds-masking stuff to make the interface safe, because if the bounds mask is repetitive or handled by the user already then it <strong>really</strong> needs to be optimized away. The alternative is using much more grisly <code>unsafe</code> interfaces.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>