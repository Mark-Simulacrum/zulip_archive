<html>
<head><meta charset="utf-8"><title>Demangling · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html">Demangling</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260615023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260615023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260615023">(Nov 08 2021 at 04:49)</a>:</h4>
<p>I'm catching up on the switch from legacy demanging to v0 demangling. In binaries produced by a stage1 compiler I see that the standard library symbols are legacy encoded (start with <code>_ZN</code>) and the compiler's own symbols are v0 encoded (start with <code>_R</code>). Is that expected?</p>



<a name="260615035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260615035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260615035">(Nov 08 2021 at 04:49)</a>:</h4>
<p>Valgrind is also failing to demangle the v0 symbols, even though I'm using a post 3.18 version, which supposedly does support v0 encoding.</p>



<a name="260615081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260615081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260615081">(Nov 08 2021 at 04:50)</a>:</h4>
<p>Valgrind is successfully decoding the legacy symbols</p>



<a name="260615271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260615271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260615271">(Nov 08 2021 at 04:55)</a>:</h4>
<blockquote>
<p>In binaries produced by a stage1 compiler I see that the standard library symbols are legacy encoded (start with _ZN) and the compiler's own symbols are v0 encoded (start with _R). Is that expected?</p>
</blockquote>
<p>IIRC, it was intentional to only enable v0 demangling for the compiler, not std yet. But I'm not certain.</p>



<a name="260615547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260615547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260615547">(Nov 08 2021 at 05:01)</a>:</h4>
<p>The real problem here is that Valgrind isn't decoded symbols it should be able to decode</p>



<a name="260616496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616496">(Nov 08 2021 at 05:23)</a>:</h4>
<p>OMG</p>



<a name="260616499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616499">(Nov 08 2021 at 05:23)</a>:</h4>
<p>There is code in Valgrind to do v0 demangling.</p>



<a name="260616573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616573">(Nov 08 2021 at 05:24)</a>:</h4>
<p>But it's preceded by this test:</p>
<div class="codehilite"><pre><span></span><code>    if (do_cxx_demangling &amp;&amp; VG_(clo_demangle)
       &amp;&amp; orig != NULL &amp;&amp; orig[0] == &#39;_&#39; &amp;&amp; orig[1] == &#39;Z&#39;) {
</code></pre></div>



<a name="260616582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616582">(Nov 08 2021 at 05:24)</a>:</h4>
<p>If I change that last line to this:</p>
<div class="codehilite"><pre><span></span><code>&amp;&amp; orig != NULL &amp;&amp; orig[0] == &#39;_&#39; &amp;&amp; (orig[1] == &#39;Z&#39; || orig[1] == &#39;R&#39;))
 {
</code></pre></div>



<a name="260616583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616583">(Nov 08 2021 at 05:24)</a>:</h4>
<p>it works</p>



<a name="260616585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616585">(Nov 08 2021 at 05:24)</a>:</h4>
<p>... which will only be hit for the legacy encoding?</p>



<a name="260616590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616590">(Nov 08 2021 at 05:25)</a>:</h4>
<p>yeah :(</p>



<a name="260616596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616596">(Nov 08 2021 at 05:25)</a>:</h4>
<p>C++ mangling also uses <code>_Z</code></p>



<a name="260616604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616604">(Nov 08 2021 at 05:25)</a>:</h4>
<p>Clearly nobody ever tested this :(</p>



<a name="260616683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616683">(Nov 08 2021 at 05:27)</a>:</h4>
<p>I will submit a fix for this to Valgrind tomorrow. It's a shame that Valgrind 3.18 came out just 3 weeks ago</p>



<a name="260616908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616908">(Nov 08 2021 at 05:32)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> It looks like you added the v0 demangling support to Valgrind in <a href="https://bugs.kde.org/show_bug.cgi?id=431306">https://bugs.kde.org/show_bug.cgi?id=431306</a>.</p>



<a name="260616944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260616944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260616944">(Nov 08 2021 at 05:33)</a>:</h4>
<p>The commit added new code for the v0 demangling, and modified one test where a symbol was no longer demangled because it is too long. But I don't, for example, see any tests added for the v0 encoding. Did you test this?</p>



<a name="260617434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260617434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260617434">(Nov 08 2021 at 05:44)</a>:</h4>
<p>Even with my change, Valgrind still fails to demangle some symbols like this one:</p>
<div class="codehilite"><pre><span></span><code>_RINvNtCsjj22Phx58mM_4core3ptr13drop_in_placeNtNtCs3EfPVfRM4MK_14rustc_borrowck12region_infer22RegionInferenceContextEBK_.llvm.14431053312260283512
</code></pre></div>



<a name="260617440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260617440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260617440">(Nov 08 2021 at 05:44)</a>:</h4>
<p>I'm suspicious about the '.' chars.</p>



<a name="260617472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Demangling/near/260617472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Demangling.html#260617472">(Nov 08 2021 at 05:45)</a>:</h4>
<p>The demangling code in Valgrind has these comments:</p>
<div class="codehilite"><pre><span></span><code>  /* Rust symbols (v0) use only [_0-9a-zA-Z] characters. */
</code></pre></div>
<p>and</p>
<div class="codehilite"><pre><span></span><code>      /* Legacy Rust symbols can also contain [.:$] characters. */
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>