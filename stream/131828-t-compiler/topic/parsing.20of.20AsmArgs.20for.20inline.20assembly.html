<html>
<head><meta charset="utf-8"><title>parsing of AsmArgs for inline assembly · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html">parsing of AsmArgs for inline assembly</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265208543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/parsing%20of%20AsmArgs%20for%20inline%20assembly/near/265208543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html#265208543">(Dec 16 2021 at 19:38)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="239881">@Josh Triplett</span>  <span class="user-mention" data-user-id="143274">@Amanieu</span> </p>
<p>There's been a long standing a desire for rustfmt to support formatting inline assmebly (<a href="https://github.com/rust-dev-tools/fmt-rfcs/issues/152">https://github.com/rust-dev-tools/fmt-rfcs/issues/152</a>) and we've recently started digging into it</p>
<p>rustfmt lives entirely in the pre-expansion world, so it sees the <code>asm</code> and <code>llvm_asm</code> as standard MacCall expressions. I believe that in order to do any type of significant formatting we'll want to at least get the underling <code>AsmArgs</code> representation, but obviously we really don't want to duplicate the parsing and processing of the token stream because that'll inevitably lead to bifurcation and likely future bugs in rustfmt.</p>
<p>It seems to me that the easiest way for rustfmt to be able to get the <code>AsmArgs</code> would be for some slight augmentation to the existing <code>parse_args</code> function in <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_builtin_macros/src/asm.rs#L27-L32">https://github.com/rust-lang/rust/blob/master/compiler/rustc_builtin_macros/src/asm.rs#L27-L32</a>. AIUI that generation of the <code>AsmArgs</code> really only needs a parser, source map, and a function for the span errors, all of which we have/can access pre-expansion within rustfmt (via the session).</p>
<p>Would folks be open to an extra function or two/slightly adjusted signatures that would allow the existing flow to stay the same with the <code>ExtCtxt</code> based approach while also giving us a way to hook into this from rustfmt (e.g. a new function rustfmt could call and pass the parser instance, source map, etc. directly)?</p>
<p>We're happy to send a PR with a proposal but wanted to gauge receptiveness first, or even see if anyone had any suggested alternatives.</p>



<a name="265211113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/parsing%20of%20AsmArgs%20for%20inline%20assembly/near/265211113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html#265211113">(Dec 16 2021 at 19:59)</a>:</h4>
<p>The idea seems reasonable.</p>



<a name="265211173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/parsing%20of%20AsmArgs%20for%20inline%20assembly/near/265211173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html#265211173">(Dec 16 2021 at 19:59)</a>:</h4>
<p>When you say formatting asm, you mean the macro invocation, not the assembly string, right?</p>



<a name="265216919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/parsing%20of%20AsmArgs%20for%20inline%20assembly/near/265216919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html#265216919">(Dec 16 2021 at 20:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly/near/265211173">said</a>:</p>
<blockquote>
<p>When you say formatting asm, you mean the macro invocation, not the assembly string, right?</p>
</blockquote>
<p>correct, invocation including the args</p>



<a name="265218563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/parsing%20of%20AsmArgs%20for%20inline%20assembly/near/265218563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html#265218563">(Dec 16 2021 at 20:57)</a>:</h4>
<p>Sounds good to me!</p>



<a name="265218742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/parsing%20of%20AsmArgs%20for%20inline%20assembly/near/265218742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/parsing.20of.20AsmArgs.20for.20inline.20assembly.html#265218742">(Dec 16 2021 at 20:59)</a>:</h4>
<p>awesome, thanks all! will see if i can't get a pr up within the next day or so</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>