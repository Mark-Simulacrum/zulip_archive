<html>
<head><meta charset="utf-8"><title>Stable custom codegens · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html">Stable custom codegens</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257983844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/257983844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#257983844">(Oct 18 2021 at 06:42)</a>:</h4>
<p>If <code>-Z codegen-backend</code> will ever be stabilized (<a href="https://github.com/rust-lang/rust/issues/77933">https://github.com/rust-lang/rust/issues/77933</a>), does that mean that we will<br>
get some rustc_private crates that can compile on stable? I dont see how codegen-backend being stable can do anything if compiling the codegens requires nightly. Will this restriction ever be lifted?</p>



<a name="257984023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/257984023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#257984023">(Oct 18 2021 at 06:44)</a>:</h4>
<p>I think it would benefit a lot of projects if codegen crates are able to compile on stable, however, that kind of breaks stable guarantees if the codegens are not updated alongside stable releases. But then that also causes more issues because do you update according to nightly or according to stable? doing one or the other precludes the other.</p>



<a name="257989353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/257989353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#257989353">(Oct 18 2021 at 07:45)</a>:</h4>
<p>I don't think we'd ever want to stabilize "here's a path to a shared library for a codegen backend". I think we'd want to stabilize "here's the name of a stable codegen backend", so that people can say "I want to build using cg_gcc" or "I want to build using cg_cranelift".</p>



<a name="257989430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/257989430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#257989430">(Oct 18 2021 at 07:46)</a>:</h4>
<p>(As well as allowing targets to have a default codegen backend, so that targets only supported by cg_gcc can default to cg_gcc.)</p>



<a name="258058279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258058279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258058279">(Oct 18 2021 at 16:33)</a>:</h4>
<p>Yeah that makes sense</p>



<a name="258115341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258115341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258115341">(Oct 18 2021 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/Stable.20custom.20codegens/near/257989353">said</a>:</p>
<blockquote>
<p>I don't think we'd ever want to stabilize "here's a path to a shared library for a codegen backend". I think we'd want to stabilize "here's the name of a stable codegen backend", so that people can say "I want to build using cg_gcc" or "I want to build using cg_cranelift".</p>
</blockquote>
<p>I'd agree with this, especially stabilizing it in $RUSTC interface, instead of for rustc in particular (for which the line between is currently fairly grey). Though I would want the names of stable codegen backends to be <code>rustc</code> specific (compiler specific in general) as well anyways. After all, good luck convicing gcc-rs to provide cg_llvm (also, I may end up avoiding llvm myself).</p>



<a name="258117104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258117104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258117104">(Oct 18 2021 at 23:19)</a>:</h4>
<p>i dont see how gcc-rs applies in this case at all since its a frontend not a backend</p>



<a name="258117697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258117697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258117697">(Oct 18 2021 at 23:26)</a>:</h4>
<p>that frontend may want to support the same stable set of <code>-C</code> options, insofar as they make sense</p>



<a name="258117727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258117727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258117727">(Oct 18 2021 at 23:26)</a>:</h4>
<p>but gcc-rs probably wouldn't support this, nor <code>-Cllvm-args</code> etc.</p>



<a name="258117907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258117907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258117907">(Oct 18 2021 at 23:28)</a>:</h4>
<p>I think being able to control the codegen used and its arguments in Cargo.toml will go a long way to having better support for custom codegens]</p>



<a name="258117969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258117969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258117969">(Oct 18 2021 at 23:29)</a>:</h4>
<p>For example, rust-gpu (and a project im working on that compiles for cuda) needs a <a href="http://build.rs">build.rs</a> because the arguments needed by rustc are fairly complex and there isnt great support for running custom codegens overall</p>



<a name="258118012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258118012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258118012">(Oct 18 2021 at 23:29)</a>:</h4>
<p>this <a href="http://build.rs">build.rs</a> approach is full of issues, things like not having an accurate progress view for compiling the crate, warnings being silently ignored, etc</p>



<a name="258120818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258120818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258120818">(Oct 19 2021 at 00:00)</a>:</h4>
<p>Yeah, I was wondering about <code>-C llvm-args</code> myself. But in general, as I mentioned, the line between "stable for rustc" and part of the stable interface presented by <code>$RUSTC</code> (which is any rust compiler that also matches the CLI expected for use with cargo among others) is very thin and it's not clear where it sits. <br>
The ability to specify a custom codegen from Cargo.toml seems like a great idea on paper, but it runs into issues when you consider that not every frontend with the same interface will have or want to have the same codegens, or most definately the same interface. There is zero way that  a custom codegen written for rustc will work with lccc, or take your pick of any other frontend that is being developed or will be developed. They have  completely different internals, which is the advantage of having multiple frontends, rather than "rustc, rustc, rustc".  The ability to specify in Cargo.toml would likely place it in the "stable for the $RUSTC interface" collum, which means that it has to be supported, whether it is reasonable or not, if a frontend wishes to support cargo.</p>
<p>Obviously, some method of selecting a stable codegen would be useful, but that list would have to be compiler-specific by design. Likewise any mechanism for selecting a custom codegen.</p>



<a name="258121204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258121204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258121204">(Oct 19 2021 at 00:04)</a>:</h4>
<p>honestly i dont think its worth it to gut good custom codegen support just because new frontends will exist in the future, at least not for now. If a project needs a custom codegen, and the frontend is not able to deliver/emulate it, then the project will simply not build with that compiler. I do want to note im firmly against having multiply frontends currently, partly for this exact reason</p>



<a name="258121454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258121454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258121454">(Oct 19 2021 at 00:07)</a>:</h4>
<p>I would agree with that, but I would want it to be in a location other than Cargo.toml, which presents what I would call the definitive stable interface to the frontend CLI.  Or, otherwise the portability, or lack thereof, of using it should be made clear.</p>



<a name="258121461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258121461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258121461">(Oct 19 2021 at 00:07)</a>:</h4>
<p>I believe custom codegens are one of the most exciting things about rustc for the future. We have a backend for fast compilation with cranelift, a backend for gcc, a backend for shader code, and soon a backend for general gpu computing. Some of these things are fundamentally impossible to have with multiple frontends unless somehow the frontends agree on a common interface for custom codegens, which we all know will never happen</p>



<a name="258121713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258121713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258121713">(Oct 19 2021 at 00:10)</a>:</h4>
<p>Custom codegens are already ambitious for a language that is nowhere near complete and does not have any form of a specification. Adding multiple frontends to the mix is a recipe for disaster</p>



<a name="258122161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258122161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258122161">(Oct 19 2021 at 00:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/Stable.20custom.20codegens/near/258121204">said</a>:</p>
<blockquote>
<p>honestly i dont think its worth it to gut good custom codegen support just because new frontends will exist in the future, at least not for now. If a project needs a custom codegen, and the frontend is not able to deliver/emulate it, then the project will simply not build with that compiler. I do want to note im firmly against having multiply frontends currently, partly for this exact reason</p>
</blockquote>
<p>Acknowleding my own opposed bias in the matter, there are considerable uses for different frontends, including handling hosts where rustc is unreasonable or impossible to use, or supporting targets that are fundamentally unsupportable by the design of existing ones. Also reguardless of whether or not there are arguments for or against them, they will exist, and in my opinion, Rust should not actively seek to make it difficult to mitigate the damage that will occur when they do.</p>



<a name="258122321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258122321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258122321">(Oct 19 2021 at 00:17)</a>:</h4>
<p>Rustc doing this would hurt frontends which won't be used by a significant amount of people for probably decades to come, but it would greatly help a good majority of users interested in using a custom codegen backend for things like GPU work (which is not an uncommon task). So i think the damage done is perfectly fine</p>



<a name="258174098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258174098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258174098">(Oct 19 2021 at 10:48)</a>:</h4>
<p>I think it makes sense for cargo to support providing many different kinds of options to the rust compiler. Depending on the options you specify, you may end up only working on a compiler that supports those options. That doesn't mean you only work on the rust compiler, because another compiler could theoretically implement those options. That's a lot more likely for something like strip, or linker options. It's a lot less likely for the name of a specific code generation back end, so if you specify such an option, that's going to inherently make your crate less portable.</p>



<a name="258174146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258174146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258174146">(Oct 19 2021 at 10:49)</a>:</h4>
<p>That seems reasonable, since if your crate is written specifically for something like rust-gpu, you're unlikely to work with anything else anyway.</p>



<a name="258174352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258174352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258174352">(Oct 19 2021 at 10:50)</a>:</h4>
<p>Normally, I think most crates would want to use the default backend for a given architecture (e.g llvm for mainstream architectures, gcc for architectures llvm doesn't support). If a crate is going out of its way to specify a specific backend, it wants that backend. If it can also handle different backends, it might make sense to have different profiles for that.</p>



<a name="258174418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258174418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258174418">(Oct 19 2021 at 10:51)</a>:</h4>
<p>As one possible example, perhaps one backend generate substantially better code for a specific target, either in terms of size or in terms of performance.</p>



<a name="258176157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258176157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258176157">(Oct 19 2021 at 11:07)</a>:</h4>
<p>Dependencies can't specify which codegen backend to use, just like they can't specify eg their opt level. Only the root workspace can specify it.</p>



<a name="258177826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258177826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258177826">(Oct 19 2021 at 11:22)</a>:</h4>
<p>At the same time, though, a user may have a way to have a crate build wth !rustc (likely involving writing a similar backend for a compiler that itself has pluggable backends). Although if it's only specified by the top-level crates and can be overriden by the end user, that may be reasonable to avoid the issues I described.</p>



<a name="258185540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258185540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258185540">(Oct 19 2021 at 12:28)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> True, though artifact dependencies may specify an architecture that necessitates a specific backend.</p>



<a name="258185602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258185602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258185602">(Oct 19 2021 at 12:29)</a>:</h4>
<p>And we may eventually need a way for artifact dependencies to control a bit more of their compilation (with the ability of the top-level package to override).</p>



<a name="258186054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258186054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258186054">(Oct 19 2021 at 12:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/Stable.20custom.20codegens/near/258185540">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> True, though artifact dependencies may specify an architecture that necessitates a specific backend.</p>
</blockquote>
<p>That seems harder to override at a user level, though.</p>



<a name="258186330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258186330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258186330">(Oct 19 2021 at 12:35)</a>:</h4>
<p>If you're compiling to, say, cuda, you don't specifically need the nvvm rustc backend, you just need a backend that generates nvptx code. The nvvm rustc backend may be a reasonable default to achieve that, it may not forever be the only way, and it should be reasonable for the user to say "I know what I'm doing, use this backend".</p>



<a name="258191916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258191916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258191916">(Oct 19 2021 at 13:14)</a>:</h4>
<p>Sure, but there should be a default. If you specify that you want to compile to a vulkan shader, there should be a default, probably rust-gpu. We might one day have more than one backend that can support that target, but we should still have a default.</p>



<a name="258191959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258191959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258191959">(Oct 19 2021 at 13:14)</a>:</h4>
<p>(Rather than, for instance, defaulting to a backend that doesn't support the target and then emitting an error.)</p>



<a name="258196085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258196085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258196085">(Oct 19 2021 at 13:41)</a>:</h4>
<p>The default should be in rustc and not cargo. Cargo should have as little target specific knowledge beyond what rustc tells it using <code>--print</code> IMHO.</p>



<a name="258198116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258198116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258198116">(Oct 19 2021 at 13:54)</a>:</h4>
<p>Complete agreement there.</p>



<a name="258198153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258198153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258198153">(Oct 19 2021 at 13:54)</a>:</h4>
<p>Cargo should default to <em>not</em> telling Rust what backend to use, just telling it what target to use.</p>



<a name="258234884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258234884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258234884">(Oct 19 2021 at 17:10)</a>:</h4>
<blockquote>
<p>If you're compiling to, say, cuda, you don't specifically need the nvvm rustc backend, you just need a backend that generates nvptx code. The nvvm rustc backend may be a reasonable default to achieve that, it may not forever be the only way, and it should be reasonable for the user to say "I know what I'm doing, use this backend".</p>
</blockquote>
<p>I agree, but at the same time, my libnvvm backend is the only thing that can reliably generate PTX code, both because it uses the library that NVCC itself uses, and because it fixes up some things that gpu code needs/doesnt need. And i dont see cg_llvm and the llvm ptx backend ever being on that level unless they refactor to basically become my codegen. So i think it is perfectly fine to have <code>nvptx-nvidia-cuda</code> and <code>nvptx64-nvidia-cuda</code> use that backend by default. While giving the user the option to say "please use cg_llvm with the nvptx target". Its all about sensible defaults</p>



<a name="258235133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258235133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258235133">(Oct 19 2021 at 17:12)</a>:</h4>
<p>the bad thing is that the LLVM PTX backend is not going to emit a nice error, it will either:</p>
<ul>
<li>Throw a linker error if you try using any of the fundamental nvvm intrinsics (like thread idx)</li>
<li>Work but generate completely invalid PTX which fails to load or produces unwanted results</li>
</ul>



<a name="258236651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258236651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258236651">(Oct 19 2021 at 17:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/Stable.20custom.20codegens/near/258198153">said</a>:</p>
<blockquote>
<p>Cargo should default to <em>not</em> telling Rust what backend to use, just telling it what target to use.</p>
</blockquote>
<p>Yes, but cargo also needs a way to override whatever rustc chooses with another codegen backend, like if for example, somebody wants to use cg_llvm with a target that is handled by default by another backend</p>



<a name="258236878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258236878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258236878">(Oct 19 2021 at 17:22)</a>:</h4>
<p><code>-Zcodegen-backend</code> should always override the default backend for a target.</p>



<a name="258236968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258236968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258236968">(Oct 19 2021 at 17:22)</a>:</h4>
<p>But that won't be stable, i mean for already-stabilized codegens inside rustc</p>



<a name="258237365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258237365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258237365">(Oct 19 2021 at 17:24)</a>:</h4>
<p><code>-Zcodegen-backend</code> may become stable as <code>-Ccodegen-backends</code> for builtin codegen backends.</p>



<a name="258237427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258237427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258237427">(Oct 19 2021 at 17:25)</a>:</h4>
<p>Yeah that may be a good option</p>



<a name="258237841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258237841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258237841">(Oct 19 2021 at 17:27)</a>:</h4>
<p>if for example, someone wants to use cg_llvm over cg_nvvm they can just use <code>-C codegen-backend=llvm</code> or something like that</p>



<a name="258237983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258237983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258237983">(Oct 19 2021 at 17:28)</a>:</h4>
<p>it would also probably need a method for codegen backends for "fetch me the supported targets"</p>



<a name="258238034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258238034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258238034">(Oct 19 2021 at 17:28)</a>:</h4>
<p>so that rustc can issue an early error for trying to use an invalid backend for a target</p>



<a name="258244188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258244188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258244188">(Oct 19 2021 at 18:02)</a>:</h4>
<p>codegen backends have an init method that can error out.</p>



<a name="258244687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258244687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258244687">(Oct 19 2021 at 18:05)</a>:</h4>
<p>Right but wouldn't it be better to have rustc handle the "this is what targets this codegen supports, you chose this codegen but it does not support &lt;target&gt;"?</p>



<a name="258246091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258246091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258246091">(Oct 19 2021 at 18:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/Stable.20custom.20codegens/near/258234884">said</a>:</p>
<blockquote>
<blockquote>
<p>If you're compiling to, say, cuda, you don't specifically need the nvvm rustc backend, you just need a backend that generates nvptx code. The nvvm rustc backend may be a reasonable default to achieve that, it may not forever be the only way, and it should be reasonable for the user to say "I know what I'm doing, use this backend".</p>
</blockquote>
<p>I agree, but at the same time, my libnvvm backend is the only thing that can reliably generate PTX code, both because it uses the library that NVCC itself uses, and because it fixes up some things that gpu code needs/doesnt need. And i dont see cg_llvm and the llvm ptx backend ever being on that level unless they refactor to basically become my codegen. So i think it is perfectly fine to have <code>nvptx-nvidia-cuda</code> and <code>nvptx64-nvidia-cuda</code> use that backend by default. While giving the user the option to say "please use cg_llvm with the nvptx target". Its all about sensible defaults</p>
</blockquote>
<p>May be true of rustc and currently. May not always be true of all <code>$RUSTC</code>s.</p>



<a name="258246550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258246550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258246550">(Oct 19 2021 at 18:17)</a>:</h4>
<p>I'm not disputing it's a good default, but an override must exist, especially if it would be specified in <code>Cargo.toml</code>.</p>



<a name="258267932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258267932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258267932">(Oct 19 2021 at 20:39)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> (regarding defaults, it doesn't seem likely that a backend that isn't upstream and can't be upstream would be the default.)</p>



<a name="258270021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258270021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258270021">(Oct 19 2021 at 20:52)</a>:</h4>
<p>Thats a discussion for another time</p>



<a name="258270164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258270164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258270164">(Oct 19 2021 at 20:54)</a>:</h4>
<p>i dont quite see how libnvvm's case is much different from libgccjit's case</p>



<a name="258315433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258315433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258315433">(Oct 20 2021 at 05:43)</a>:</h4>
<p>One is open, the other is not. But yes, that's a discussion for another time.</p>



<a name="258315695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Stable%20custom%20codegens/near/258315695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Stable.20custom.20codegens.html#258315695">(Oct 20 2021 at 05:46)</a>:</h4>
<p>libnvvm is arguably more permissive than libgccjit, you can redistribute it freely in your tools and you can use it in proprietary closed source tools just fine</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>