<html>
<head><meta charset="utf-8"><title>Aggressive enum space optimization · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html">Aggressive enum space optimization</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269177958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269177958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269177958">(Jan 24 2022 at 21:51)</a>:</h4>
<p>I was contemplating an aggressive space optimization for enums in arenas. Imagine the enum <code>enum E { A(u64), B }</code>. The type size is 16 bytes.</p>
<ul>
<li>The <code>A</code> variant has a 1 byte discriminant, 7 bytes padding, 8 bytes for the <code>u64</code>.</li>
<li>The <code>B</code> variant has a 1 byte discriminant, and 15 bytes of padding.<br>
If an instance of <code>E::B</code> is arena allocated, you could conceivably just allocate the 1 byte discriminant and then put other data immediately after it. (Assuming you know you aren't within 15 bytes of the end of the chunk.) When you read that <code>E::B</code> out of the arena you'd get 15 bytes from one or more other values, but only in the bytes of <code>E::B</code> that don't matter.<br>
I don't think Rust exposes functionality to even achieve this easily, and I also wonder about whether overlapping types could result in UB. Still, interesting idea.</li>
</ul>



<a name="269178051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269178051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269178051">(Jan 24 2022 at 21:52)</a>:</h4>
<p>Basically, the idea is variable-length in-memory encoding of enums, reminds me a bit of Encodable/Decodable and the use of LEB128, etc.</p>



<a name="269178106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269178106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269178106">(Jan 24 2022 at 21:52)</a>:</h4>
<p>And also how we have some types with a "packed" and "unpacked" version</p>



<a name="269178564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269178564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269178564">(Jan 24 2022 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> That could work for read-only things, but what happens if you overwrite the B with an A?</p>



<a name="269178590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269178590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269178590">(Jan 24 2022 at 21:58)</a>:</h4>
<p>Yes, this would be read-only; all our arena-allocated things are read-only, I think. Certainly the interned types are</p>



<a name="269178928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269178928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269178928">(Jan 24 2022 at 22:00)</a>:</h4>
<p>For things guaranteed to be read-only (<em>actually</em> read-only with no internal mutability), I don't see a reason you couldn't do that.</p>



<a name="269179644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269179644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269179644">(Jan 24 2022 at 22:07)</a>:</h4>
<p>You would never take references into the arena (you'd always copy values out), right?</p>



<a name="269179796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269179796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269179796">(Jan 24 2022 at 22:08)</a>:</h4>
<p>If so, then I think the compiler would never see overlapping types</p>



<a name="269180017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180017">(Jan 24 2022 at 22:10)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Have you considered slab allocation? It might be possible to have a slab of As, a slab of Bs, internally track types as one or the other (so that you don't actually store the discriminant next to the value), and then if you're copying things out you synthesize the full enum.</p>



<a name="269180031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180031">(Jan 24 2022 at 22:10)</a>:</h4>
<p>Well, you need to have references into the arena in order to copy things out...</p>



<a name="269180105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180105">(Jan 24 2022 at 22:11)</a>:</h4>
<p>A reference already needs to point somewhere; what if the arena could go "ah, the pointer is within the slab of As, so it's an A, and it points to the u64", or "Ah, the pointer is within the slab of Bs, so it's a B".</p>



<a name="269180202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180202">(Jan 24 2022 at 22:12)</a>:</h4>
<p>(Depending on semantics, the internal type of B could be a ZST or it could be one byte so that the addresses are unique.)</p>



<a name="269180247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180247">(Jan 24 2022 at 22:12)</a>:</h4>
<p>Definitely conceivable. This is basically a question of "how to best compress data". The thing about my original suggestion was that it could potentially nicely apply to every enum that gets read-only arena-allocated. These more fine-grained ideas are probably only going to happen on a per-type basis...</p>



<a name="269180299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180299">(Jan 24 2022 at 22:13)</a>:</h4>
<p>It seems <em>possible</em> to build a generalized "enum slab arena" that doesn't require unique code.</p>



<a name="269180373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180373">(Jan 24 2022 at 22:13)</a>:</h4>
<p>Worst case, <code>#[derive(EnumSlabArena)]</code> and do code gen; best case, feed the variants into a generic with some clever type-level handling.</p>



<a name="269180469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180469">(Jan 24 2022 at 22:14)</a>:</h4>
<p>Also, <em>this</em> case in particular seems equivalent to <code>Option&lt;u64&gt;</code>, and you could make arenas special-case Option.</p>



<a name="269180538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180538">(Jan 24 2022 at 22:15)</a>:</h4>
<p>Yeah a proc macro is definitely an option</p>



<a name="269180556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180556">(Jan 24 2022 at 22:15)</a>:</h4>
<p>What's an example of a concrete type you would want to apply this to?</p>



<a name="269180566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180566">(Jan 24 2022 at 22:15)</a>:</h4>
<p>My example was equivalent to <code>Option</code>, but the real types in question are more complex, things like <code>TyKind</code> and <code>PredicateKind</code></p>



<a name="269180570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180570">(Jan 24 2022 at 22:15)</a>:</h4>
<p>Ah.</p>



<a name="269180637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180637">(Jan 24 2022 at 22:16)</a>:</h4>
<p>So you'd need quite a few slabs for the 10-20 variants, etc.</p>



<a name="269180658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180658">(Jan 24 2022 at 22:16)</a>:</h4>
<p>So this is all me just being a bit frustrated with large heterogenous enums <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="269180665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180665">(Jan 24 2022 at 22:16)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="269180671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180671">(Jan 24 2022 at 22:17)</a>:</h4>
<p>I would <em>love</em> to see simple ways of doing these optimizations.</p>



<a name="269180851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180851">(Jan 24 2022 at 22:18)</a>:</h4>
<p>Another optimization that'd be nice to have within the compiler: a generalized scheme for "this can technically be any u64, but most values will actually be quite small and fit within a u16 or so, so reserve one value for 'oops, it's big' and store those separately or tweak the arena at runtime".</p>



<a name="269180891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269180891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269180891">(Jan 24 2022 at 22:19)</a>:</h4>
<p>(e.g. many indexes inside the compiler)</p>



<a name="269181027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181027">(Jan 24 2022 at 22:20)</a>:</h4>
<p>Effectively, a kind of runtime Huffman compression.</p>



<a name="269181035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181035">(Jan 24 2022 at 22:20)</a>:</h4>
<p>Hmm, even unaligned reads out of such an arena could be weird since a read of an enum could read past the end of the arena, unless the population code is particularly careful.  And even writing it initially might be weird since you I think the rules mean you couldn't write into the trailing padding of an enum if you've given out a <code>&amp;</code> to it, even though it's padding that you don't care about.</p>
<p>Definitely feels like it'd need a macro to generate <code>repr(packed)</code> and normal structs for the payloads of each of the enums, so the arena could have the packed form and the various APIs for the arena could translate appropriately between the different representations.</p>



<a name="269181059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181059">(Jan 24 2022 at 22:20)</a>:</h4>
<p>The challenge there is always "how to find the auxiliary storage for the long cases" <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="269181085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181085">(Jan 24 2022 at 22:21)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> I'm imagining the case where you reference the thing by pointer-into-arena anyway.</p>



<a name="269181112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181112">(Jan 24 2022 at 22:21)</a>:</h4>
<p>If you're passing something around by value rather than by pointer, then most of these tricks don't work, unless the thing fits into 8 bytes.</p>



<a name="269181148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181148">(Jan 24 2022 at 22:21)</a>:</h4>
<p>(Which is <em>also</em> an optimization I'd love to see: "high bit set: magic encoding of this into the remaining 63 bits; high bit clear, pointer to the thing".)</p>



<a name="269181222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181222">(Jan 24 2022 at 22:22)</a>:</h4>
<p>This isn't quite the same thing, but there's been lots of talk of "move-only" fields where, like <code>repr(packed)</code>, using a field moves (or more often <code>Copy</code>s) out/in the field, giving an opportunity to run code, and avoiding the restrictions inherent in being able to get references (particularly mutable ones) to fields.</p>
<p>I guess something like that could only help avoid the discriminant taking extra space, though, not handle the different variants fundamentally being different lengths.</p>



<a name="269181302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181302">(Jan 24 2022 at 22:23)</a>:</h4>
<p>Seems like we could generalize the hand-done "box the big variants" optimization into an automatic <code>#[PseudoBoxThingsThatDontFitIn63Bits]</code></p>



<a name="269181519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181519">(Jan 24 2022 at 22:25)</a>:</h4>
<p>Except that often in the compiler <code>Box</code> isn't really the appropriate thing, more arena-allocating is <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="269181570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181570">(Jan 24 2022 at 22:26)</a>:</h4>
<p>Back to my original example: maybe it's less interesting than I first thought. When interning is involved, <code>E::B</code> will only be stored once because it only has one value. But many <code>E::A(n)</code> values can be stored.</p>



<a name="269181632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269181632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269181632">(Jan 24 2022 at 22:26)</a>:</h4>
<p>I'm about to measure this on <code>TyKind</code>, which is the most important of these types</p>



<a name="269186149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269186149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269186149">(Jan 24 2022 at 23:11)</a>:</h4>
<p>in general: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_data_structures/tagged_ptr/index.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_data_structures/tagged_ptr/index.html</a>, though it has limitations of course</p>



<a name="269196824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Aggressive%20enum%20space%20optimization/near/269196824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Aggressive.20enum.20space.20optimization.html#269196824">(Jan 25 2022 at 01:31)</a>:</h4>
<p>I imagine with <code>union</code> of structures you could even implement some ability to take references too.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>