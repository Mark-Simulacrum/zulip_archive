<html>
<head><meta charset="utf-8"><title>20K stack frame size regression from 1.58 to 1.59 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html">20K stack frame size regression from 1.58 to 1.59</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276806457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276806457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kyle Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276806457">(Mar 27 2022 at 20:35)</a>:</h4>
<p>I have a (closed source) program where upgrading from 1.58 to 1.59 (making no changes to the program) increased the size of the stack frame of one of my key functions by 20KB. What can I do to help debug this?</p>



<a name="276806507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276806507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kyle Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276806507">(Mar 27 2022 at 20:36)</a>:</h4>
<p>it's not even clear to me how to bisect builds usefully here, so instructions for that would be nice, but perhaps there are other ways to attack this too</p>



<a name="276809078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276809078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276809078">(Mar 27 2022 at 21:32)</a>:</h4>
<p>If you want to try to determine which change in rustc caused the change, typically we use <a href="https://github.com/rust-lang/cargo-bisect-rustc/"><code>cargo-bisect-rustc</code></a>.  You'll need to either write a script that determines if the stack size is a regression, or use the <code>--prompt</code> option and do it manually.</p>
<p>You'll probably use date ranges to set the initial range of commits to test.  I think the range between those two versions is 2021-11-29 to 2022-01-13.</p>



<a name="276809176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276809176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276809176">(Mar 27 2022 at 21:35)</a>:</h4>
<p>It would be really cool if we could tell bisect-rustc "start at 1.59 and end at 1.60" somehow instead of having to look up the dates manually</p>



<a name="276810597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276810597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276810597">(Mar 27 2022 at 22:07)</a>:</h4>
<p>Yea, I've wanted that many times.  I opened <a href="https://github.com/rust-lang/cargo-bisect-rustc/issues/146">https://github.com/rust-lang/cargo-bisect-rustc/issues/146</a> for that.  I think it should be a pretty simple change if someone wants to try.</p>



<a name="276823820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276823820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kyle Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276823820">(Mar 28 2022 at 03:29)</a>:</h4>
<p>thanks, with those dates I was able to bisect it to the regressing PR</p>



<a name="276836055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276836055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276836055">(Mar 28 2022 at 07:29)</a>:</h4>
<p>Just out of curiosity, what PR is it?</p>



<a name="276836540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276836540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276836540">(Mar 28 2022 at 07:35)</a>:</h4>
<p>I'd say <a href="https://github.com/rust-lang/rust/issues/90737">#90737</a> because of <a href="https://github.com/rust-lang/rust/issues/67982#issuecomment-1080125015">this comment</a></p>



<a name="276848379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276848379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276848379">(Mar 28 2022 at 09:38)</a>:</h4>
<p>It says for debug builds. I don't think we don't really optimize much for stack sizes in debug builds. There's a lot of small functions that don't get inlined in debug.</p>



<a name="276848900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276848900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276848900">(Mar 28 2022 at 09:43)</a>:</h4>
<p>That said, the blanket impl for <code>IntoIterator</code> has an <code>#[inline]</code> which helps with <code>opt-level=1</code> at least<br>
Maybe the same could be done for the <code>IntoFuture</code> blanket impl. <a href="https://doc.rust-lang.org/src/core/future/into_future.rs.html#25">https://doc.rust-lang.org/src/core/future/into_future.rs.html#25</a></p>



<a name="276849505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/276849505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#276849505">(Mar 28 2022 at 09:50)</a>:</h4>
<p>Without optimizations the stack coloring is disabled altogether.</p>



<a name="277087315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/277087315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kyle Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#277087315">(Mar 30 2022 at 02:22)</a>:</h4>
<p>yeah it was <a href="https://github.com/rust-lang/rust/issues/90737">#90737</a></p>



<a name="277102155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/277102155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#277102155">(Mar 30 2022 at 07:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59/near/276848900">said</a>:</p>
<blockquote>
<p>That said, the blanket impl for <code>IntoIterator</code> has an <code>#[inline]</code> which helps with <code>opt-level=1</code> at least<br>
Maybe the same could be done for the <code>IntoFuture</code> blanket impl. <a href="https://doc.rust-lang.org/src/core/future/into_future.rs.html#25">https://doc.rust-lang.org/src/core/future/into_future.rs.html#25</a></p>
</blockquote>
<p>I don't think we have an MCVE yet, so I've launched a try build of that in <a href="https://github.com/rust-lang/rust/pull/95465">https://github.com/rust-lang/rust/pull/95465</a> so people can try it on fuchsia and closed-source projects</p>



<a name="277186218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/277186218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#277186218">(Mar 30 2022 at 18:20)</a>:</h4>
<p>let us know if that helps <span class="user-mention" data-user-id="452469">@Kyle Huey</span> and if it does I'll make an actual PR</p>



<a name="277197563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/277197563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kyle Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#277197563">(Mar 30 2022 at 19:57)</a>:</h4>
<p>that does not help</p>



<a name="277197660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/277197660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#277197660">(Mar 30 2022 at 19:58)</a>:</h4>
<p>probably only helps at opt-level=1 then</p>



<a name="277197669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/20K%20stack%20frame%20size%20regression%20from%201.58%20to%201.59/near/277197669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/20K.20stack.20frame.20size.20regression.20from.201.2E58.20to.201.2E59.html#277197669">(Mar 30 2022 at 19:58)</a>:</h4>
<p>thanks for trying it out!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>