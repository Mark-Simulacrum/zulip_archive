<html>
<head><meta charset="utf-8"><title>question about macro expansion · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/question.20about.20macro.20expansion.html">question about macro expansion</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265955242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/question%20about%20macro%20expansion/near/265955242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> technetos <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/question.20about.20macro.20expansion.html#265955242">(Dec 23 2021 at 21:34)</a>:</h4>
<p>Hey folks, I am working on a proc macro that stores some state about previous macro invocations.  Following this post <a href="https://stackoverflow.com/questions/52910783/is-it-possible-to-store-state-within-rusts-procedural-macros">https://stackoverflow.com/questions/52910783/is-it-possible-to-store-state-within-rusts-procedural-macros</a> and reading this <a href="https://rustc-dev-guide.rust-lang.org/parallel-rustc.html">https://rustc-dev-guide.rust-lang.org/parallel-rustc.html</a> I am left wondering if I could end up in the situation where macros are expanded in parallel and I miss tracking an invocation in the shared state.  </p>
<p>My question is basically is macro expansion part of codegen as mentioned in the second link and is it likely I will have the problem I described.</p>



<a name="265955577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/question%20about%20macro%20expansion/near/265955577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/question.20about.20macro.20expansion.html#265955577">(Dec 23 2021 at 21:39)</a>:</h4>
<p>Yes, proc macros are allowed to be expanded in parallel. Rustc currently doesn't do this, but it may in the future. In fact it may run every expansion in it's own process, thus clearing any state you try to keep. Also rust-analyzer doesn't reload the proc macro server every time you change the code so old state will be left around. It also caches the results of previous macro invocations. <strong>Don't use any state in proc macros.</strong> Keep them pure functions from input tokenstream to output tokenstream.</p>



<a name="265955961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/question%20about%20macro%20expansion/near/265955961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> technetos <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/question.20about.20macro.20expansion.html#265955961">(Dec 23 2021 at 21:45)</a>:</h4>
<p>Good to know.  Thanks for taking the time to answer my question.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>