<html>
<head><meta charset="utf-8"><title>`-Zno-link`/`-Zlink-only` broken? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html">`-Zno-link`/`-Zlink-only` broken?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276548535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276548535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276548535">(Mar 24 2022 at 22:40)</a>:</h4>
<p>It appears that <code>-Zno-link</code>/<code>-Zlink-only</code> are totally broken:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">gulf</span>:<span class="o">~/</span><span class="n">tmp</span><span class="p">]</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">[</span><span class="n">gulf</span>:<span class="o">~/</span><span class="n">tmp</span><span class="p">]</span><span class="w"> </span><span class="cp">$RUSTC0</span><span class="w"> </span><span class="o">-</span><span class="n">Zno</span><span class="o">-</span><span class="n">link</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="p">[</span><span class="n">gulf</span>:<span class="o">~/</span><span class="n">tmp</span><span class="p">]</span><span class="w"> </span><span class="n">ls</span><span class="w"></span>
<span class="n">z</span><span class="p">.</span><span class="mi">43</span><span class="n">k2bohs4u65rnbc</span><span class="p">.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">1.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">5.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
<span class="n">z</span><span class="p">.</span><span class="n">rlink</span><span class="w">                    </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">2.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">6.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
<span class="n">z</span><span class="p">.</span><span class="n">rs</span><span class="w">                       </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">3.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">7.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
<span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">0.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">z</span><span class="p">.</span><span class="n">z</span><span class="p">.</span><span class="mf">7e813375</span><span class="o">-</span><span class="n">cgu</span><span class="p">.</span><span class="mf">4.</span><span class="n">rcgu</span><span class="p">.</span><span class="n">o</span><span class="w"></span>
<span class="p">[</span><span class="n">gulf</span>:<span class="o">~/</span><span class="n">tmp</span><span class="p">]</span><span class="w"> </span><span class="cp">$RUSTC0</span><span class="w"> </span><span class="o">-</span><span class="n">Zlink</span><span class="o">-</span><span class="n">only</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">rustc</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">'</span><span class="na">index</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">bounds</span>: <span class="nc">the</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">43</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">112</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">njn</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">rust0</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_serialize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">opaque</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">655</span>:<span class="mi">24</span><span class="w"></span>
</code></pre></div>



<a name="276548587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276548587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276548587">(Mar 24 2022 at 22:41)</a>:</h4>
<p>The file format was recently changed from JSON to binary, but it was broken before that. With nightly 1.59 I get a different error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">decode</span><span class="w"> </span><span class="n">rlink</span>: <span class="nc">ParseError</span><span class="p">(</span><span class="n">SyntaxError</span><span class="p">(</span><span class="n">InvalidSyntax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>



<a name="276548595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276548595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276548595">(Mar 24 2022 at 22:41)</a>:</h4>
<p>I couldn't find any open issues on this</p>



<a name="276589172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276589172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276589172">(Mar 25 2022 at 08:41)</a>:</h4>
<p>I'm not exactly sure what's the process people used to test this; I only could get these 2 errors as well, going back to around the time they were introduced. there may some combination of flags required to make it work (like additional emit values, or -Zcombine-cgus, etc), but a deserialization issue is unexpected</p>



<a name="276589556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276589556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276589556">(Mar 25 2022 at 08:45)</a>:</h4>
<p>It should work by using the linker invocation the same as the compile invocation except replacing the source file with the .rlink file and -Zno-link with -Zlink-only. This is exactly what <span class="user-mention silent" data-user-id="120989">nnethercote</span> did.</p>



<a name="276590786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276590786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276590786">(Mar 25 2022 at 08:55)</a>:</h4>
<p>that was our expectation, but alas</p>



<a name="276591194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276591194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276591194">(Mar 25 2022 at 09:00)</a>:</h4>
<p>For me the following works just fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="o">-</span><span class="n">vV</span><span class="w"></span>
<span class="n">rustc</span><span class="w"> </span><span class="mf">1.61.0</span><span class="o">-</span><span class="n">nightly</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="n">c17c84a3</span><span class="w"> </span><span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">21</span><span class="p">)</span><span class="w"></span>
<span class="n">binary</span>: <span class="nc">rustc</span><span class="w"></span>
<span class="n">commit</span><span class="o">-</span><span class="n">hash</span>: <span class="mi">3</span><span class="n">c17c84a386e7badf6b2c6018d172496b3a28a04</span><span class="w"></span>
<span class="n">commit</span><span class="o">-</span><span class="n">date</span>: <span class="mi">2022</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">21</span><span class="w"></span>
<span class="n">host</span>: <span class="nc">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"></span>
<span class="n">release</span>: <span class="mf">1.61.0</span><span class="o">-</span><span class="n">nightly</span><span class="w"></span>
<span class="n">LLVM</span><span class="w"> </span><span class="n">version</span>: <span class="mf">14.0.0</span><span class="w"></span>
<span class="cp">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="o">'</span><span class="na">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="o">'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="o">-</span><span class="n">Zno</span><span class="o">-</span><span class="n">link</span><span class="w"> </span><span class="o">-</span><span class="w"></span>
<span class="cp">$</span><span class="w"> </span><span class="n">rustc</span><span class="w"> </span><span class="o">-</span><span class="n">Zlink</span><span class="o">-</span><span class="n">only</span><span class="w"> </span><span class="n">rust_out</span><span class="p">.</span><span class="n">rlink</span><span class="w"></span>
<span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">rust_out</span><span class="w"></span>
</code></pre></div>



<a name="276591607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276591607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276591607">(Mar 25 2022 at 09:04)</a>:</h4>
<p>ok that also did work and it's not what we did before, we were just changing the flag, while you also need to refer to the rlink. I see what you mean now, thanks a bunch!</p>



<a name="276591800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276591800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276591800">(Mar 25 2022 at 09:07)</a>:</h4>
<p>Right, missed that <span class="user-mention silent" data-user-id="120989">nnethercote</span>  kept referring to the source file.</p>



<a name="276591838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276591838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276591838">(Mar 25 2022 at 09:07)</a>:</h4>
<p>Rlink files should probably get a header indicating that they are rlink files and mentioning the rustc version.</p>



<a name="276592127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276592127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276592127">(Mar 25 2022 at 09:10)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95297">https://github.com/rust-lang/rust/issues/95297</a></p>



<a name="276594676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276594676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276594676">(Mar 25 2022 at 09:37)</a>:</h4>
<p>Oh, you have to name the rlink file, not the source file. That wasn't clear to me</p>



<a name="276594697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60-Zno-link%60/%60-Zlink-only%60%20broken%3F/near/276594697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60-Zno-link.60.2F.60-Zlink-only.60.20broken.3F.html#276594697">(Mar 25 2022 at 09:37)</a>:</h4>
<p>Thanks</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>