<html>
<head><meta charset="utf-8"><title>enum variant support · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html">enum variant support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257594274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257594274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257594274">(Oct 14 2021 at 19:48)</a>:</h4>
<p>Continuing the discussion from <a href="https://github.com/rust-lang/rust/pull/89745">https://github.com/rust-lang/rust/pull/89745</a></p>
<p><span class="user-mention" data-user-id="124288">@oli</span>  Regarding item 1 from the linked PR would this change just involve removing <code>variant_index</code> from <code>PlaceTy</code> and instead using <code>ty::Variant</code>?</p>



<a name="257657010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257657010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257657010">(Oct 15 2021 at 07:27)</a>:</h4>
<p>yes</p>



<a name="257657127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257657127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257657127">(Oct 15 2021 at 07:28)</a>:</h4>
<p>I believe that shoudl work, as it should only affect code generated during mir building, and never appear in HIR</p>



<a name="257727610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257727610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257727610">(Oct 15 2021 at 16:40)</a>:</h4>
<p>Just want to get a higher level picture. So for <code>let x = Enum::A</code>, what would be the plan for <code>x</code>'s type? IIUC it's currently still <code>Enum</code> but the plan is to switch it to <code>Enum::A</code>?</p>



<a name="257727802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257727802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257727802">(Oct 15 2021 at 16:41)</a>:</h4>
<p>More broadly, is the variant -&gt; enum conversion handled by coercion? If so, then we will run into an issue where <code>&amp;x</code> cannot be used as <code>&amp;Enum</code> if <code>x</code> is a of type <code>Enum::A</code> (as coercion doesn't take place here), while <code>&amp;{x}</code> can.</p>



<a name="257730883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257730883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257730883">(Oct 15 2021 at 17:02)</a>:</h4>
<p>the RFC that was postponed specifies that stuff be inferred to the unrefined versions. so <code>x</code> would be <code>let x: Enum = Enum::A</code></p>



<a name="257730934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257730934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257730934">(Oct 15 2021 at 17:02)</a>:</h4>
<p>though it then goes and has pattern bidnings of <code>x @ Enum::A</code> be the refined version so its not particularly consistent on this matter</p>



<a name="257731103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257731103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257731103">(Oct 15 2021 at 17:04)</a>:</h4>
<p>(the postponed RFC also states that there is no subtyping here so <code>Vec&lt;Enum::A&gt;</code> is nto a subtype of <code>Vec&lt;Enum&gt;</code>)</p>



<a name="257738209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257738209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257738209">(Oct 15 2021 at 17:52)</a>:</h4>
<p>yea, we should probably flesh out those details a bit more... How about we copy the RFC to some hackmd and work on it collaboratively to create an MVP (and keep anything else in the future work section, or linking to other hackmds that flesh those out)</p>



<a name="257954373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257954373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257954373">(Oct 17 2021 at 22:37)</a>:</h4>
<p>I got part 1 working (using ty::Varaint in PlaceTy), the code is <a href="https://github.com/zhamlin/rust/tree/placety/enum-variant-types">here</a>.</p>
<p>There is probably a better way to do this, but I ran into issues when<br>
exposing PlaceTy.ty directly and instead had to create a fn on PlaceTy to strip the variant type.</p>



<a name="257994329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/257994329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#257994329">(Oct 18 2021 at 08:34)</a>:</h4>
<p>Do you remember details about the issues? I would have hoped we'd not need stripping at this stage</p>



<a name="258030195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/258030195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#258030195">(Oct 18 2021 at 13:39)</a>:</h4>
<p>I think the issue was that <code>ty::Variant</code> was being used from <code>PlaceTy.ty</code> which caused issues with anywhere that was matching with an <code>_</code> arm. </p>
<p>The test  <code>src/test/ui/nll/enum-drop-access.rs</code>. was failing because of it. There might have been more failing tests because of that issue as well, I can check if needed.</p>



<a name="258973539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/258973539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#258973539">(Oct 25 2021 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Do you want me to create a PR for part 1? Or is the stripping of the variant type on PlaceTy not desired?</p>



<a name="258976091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/258976091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#258976091">(Oct 25 2021 at 15:29)</a>:</h4>
<p>I think we should go with your first version that was exposing <code>ty</code> directly and fix the sites that don't expect a ty::Variant (so we have to check whether any of the sites match on ty::Adt or ty::Generator). The stripping is too prone to silent bugs</p>



<a name="259172931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/enum%20variant%20support/near/259172931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/enum.20variant.20support.html#259172931">(Oct 26 2021 at 22:50)</a>:</h4>
<p>Created a draft <a href="https://github.com/rust-lang/rust/pull/90330">PR</a>, only stripping the variant type at a few places vs creating a helper method on PlaceTy.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>