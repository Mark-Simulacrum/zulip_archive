<html>
<head><meta charset="utf-8"><title>Semantics of `SetDiscriminant` in MIR · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html">Semantics of `SetDiscriminant` in MIR</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273749927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273749927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273749927">(Mar 02 2022 at 03:35)</a>:</h4>
<p>Back with more MIR questions. For a type like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">A</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is MIR like this intended to be valid (assuming the obvious layout is chosen)?</p>
<div class="codehilite"><pre><span></span><code>setDiscriminant(_1) = E::A
(_1 as E::A).0 = 5;
// things in between
setDiscrimant(_1) = E::B
// `_1` is now `B(5)` and completely initialized
</code></pre></div>



<a name="273750142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273750142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273750142">(Mar 02 2022 at 03:38)</a>:</h4>
<p>Also as a procedural point: <span class="user-mention" data-user-id="116009">@nikomatsakis</span> , is this the kind of question that the traits team (or whatever it ends up being called) would be involved in answering?</p>



<a name="273762022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273762022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273762022">(Mar 02 2022 at 06:31)</a>:</h4>
<p>I wouldn't expect that to be valid. Both variants may put the field at a different offset.</p>



<a name="273764188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273764188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273764188">(Mar 02 2022 at 07:04)</a>:</h4>
<p>Indeed, I'm asking specifically about the scenario where that's not the case</p>



<a name="273764230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273764230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273764230">(Mar 02 2022 at 07:05)</a>:</h4>
<p>(it's unfortunately bed time for me, but I can explain my thoughts around this more completely tomorrow)</p>



<a name="273764750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273764750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273764750">(Mar 02 2022 at 07:11)</a>:</h4>
<p>I think it would be fine, but we shouldn't do it either. It just makes analyzing MIR harder than it needs to be without a clear benefit in my eyes. It may be interesting for state machines though.</p>



<a name="273764812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273764812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273764812">(Mar 02 2022 at 07:12)</a>:</h4>
<p>I believe that this will not be UB, in the sense that the R-AM would have to carry around some as-yet unenvisioned state in order to detect this as an error and the cost of adding something like that to the model is not worth the "gain" of making this UB. But it should not be valid according to the MIR type system, and the compiler should not attempt to generate such code</p>



<a name="273764855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273764855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273764855">(Mar 02 2022 at 07:13)</a>:</h4>
<p>(And yes, this seems like a great question for the traits team)</p>



<a name="273765142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273765142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273765142">(Mar 02 2022 at 07:19)</a>:</h4>
<p>It's a bit weird to talk about MIR functions being "safe" or "unsafe" in isolation but I think that there is a reasonable reading in which operations like <code>(_1 as E::A).0 = 5;</code> are safe according to the type system as long as the discriminant was set to <code>E::A</code> previously in the control flow. On that reading, changing the discriminant would produce all uninitialized variant fields, so reading <code>(_1 as E::B).0</code> would be a compile error (reading from an uninitialized place) but converting that place to a pointer and reading from it would be sound but <code>unsafe</code></p>



<a name="273766283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273766283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273766283">(Mar 02 2022 at 07:32)</a>:</h4>
<p>The discriminant is set <strong>after</strong> the fields. As soon as the discriminant is set the entire value is considered initialized.</p>



<a name="273766701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273766701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273766701">(Mar 02 2022 at 07:38)</a>:</h4>
<p>Ah, I was worried about that. To support that, I guess you can have a type-state of the form "the enum is not fully initialized, it is preparing for the <code>E::A</code> discriminant, and the initialized fields are .0, .1", and <code>(_1 as E::A).0 = 5</code> would put it in this "pre <code>E::A</code> state, <code>.0</code> initialized" state, and <code>setDiscriminant(_1) = E::A</code> only fully initializes the enum if it either has no <code>E::A</code> fields or it was in pre-<code>E::A</code> state with all fields initialized</p>



<a name="273771188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273771188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273771188">(Mar 02 2022 at 08:26)</a>:</h4>
<p>How elaborate can the optimizations on the result of a <code>discriminant(_1)</code> call get? For basic matches, it looks like it is sufficient to track that if we see  <code>_2 = discriminant(_1)</code> followed by <code>switchInt(_2) -&gt; [0_usize: bb2, ...]</code> then we know that <code>discriminant(_1) == 0</code> inside <code>bb2</code> (well, modulo other dataflow considerations), which is enough to license uses of the <code>Downcast</code> operation in <code>bb2</code>. But perhaps instead of a <code>switchInt</code> it becomes an equality test, or an AND or some completely different kind of check that happens to be equivalent, at which point it will be hard to continue to typecheck the resulting MIR</p>



<a name="273774283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273774283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273774283">(Mar 02 2022 at 08:57)</a>:</h4>
<p>Once we get into optimization territory, we lose the ability to run mir borrowck (and mir typeck, which is part of that). We should uphold certain rules, but it is not clear to me whether we need to be able to statically prove that a <code>Downcast</code> is correct, or whether a <code>SetDiscriminant</code> is only done on a fully initialized variant.</p>



<a name="273785545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273785545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273785545">(Mar 02 2022 at 10:34)</a>:</h4>
<p>If <code>SetDiscriminant</code> is done on a partially initialized niche filling enum, it may cause the read discriminant to be incorrect. For example setting the <code>Some</code> discriminant of an <code>Option&lt;&amp;()&gt;</code> would be a no-op, but if the field is not initialized, the value could be a 0 which would be read as <code>None</code> discriminant.</p>



<a name="273786171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273786171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273786171">(Mar 02 2022 at 10:39)</a>:</h4>
<p>I hope that (at least pre-optimization) the <code>SetDiscriminant</code> is still there anyway, even if it is a no-op to be optimized out later? MIR typeck will be a lot more complicated if these things are missing</p>



<a name="273786599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273786599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273786599">(Mar 02 2022 at 10:43)</a>:</h4>
<p>That example doesn't show that <code>SetDiscriminant</code> followed by setting the fields would be wrong though, since it would end up nonzero in the end when the field is set. (Not that I'm advocating for this, and probably there is a more complex example where setting the discriminant first doesn't make sense. From a typeck point of view we need to know that we are in a specific variant-filling mode though in order to describe the precondition of <code>SetDiscriminant</code>.)</p>



<a name="273834650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273834650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273834650">(Mar 02 2022 at 16:32)</a>:</h4>
<p>The reason that I ask about this is because the current use of <code>SetDiscriminant</code> makes analysis somewhat difficult. For example, the MaybeLiveLocals analysis has a note in it about misbehaving on these kinds of things, and thus not being useful for DSE. In order to fix this, we would basically need an analysis that reports the local as killed when the first field is set, as long as it has checked that all the other fields and the discriminant are set afterward. Even then though, I worry that this might be somewhat footgunny</p>



<a name="273835152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273835152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273835152">(Mar 02 2022 at 16:34)</a>:</h4>
<p>It also seems sort of awkward to only define the semantics of <code>SetDiscriminant</code> in conjunction with the statements that are expected to come immediately before</p>



<a name="273835849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273835849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273835849">(Mar 02 2022 at 16:38)</a>:</h4>
<p>I guess one way to possibly fix this (although it's probably not worth it) is to reverse the order, ie put the <code>SetDiscriminant(_2) = E::A</code> first, and then define it to mean <code>_2 = E::A(uninit)</code>. This would justify making the local as killed in the analysis, while having very clear semantics on its own</p>



<a name="273836194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273836194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273836194">(Mar 02 2022 at 16:40)</a>:</h4>
<p>This also has the advantage of not allowing weird MIR like I wrote above to express things that you can't express in Rust</p>



<a name="273838396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273838396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273838396">(Mar 02 2022 at 16:54)</a>:</h4>
<p>Actually, this has more advantages I can think of: for my <code>SimplifyArmIdentity</code> PR, i restricted the optimization to run when the statements it considered appeared at the beginning of a BB. Doing it differently in a way that doesn't lead to quadratic runtime is a bit tricky. If the order were the other way around, this would be a non-issue</p>



<a name="273840960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273840960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273840960">(Mar 02 2022 at 17:08)</a>:</h4>
<p>You would still need a marker to indicate the location where the value is fully initialized.</p>



<a name="273841167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273841167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273841167">(Mar 02 2022 at 17:09)</a>:</h4>
<p>Putting the <code>SetDiscriminant</code> first may also break if we get support for fields to which you can't take a reference as in that case we may stash a variant tag in unused bits of a value that would be overwritten when assigning to a field.</p>



<a name="273849410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273849410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273849410">(Mar 02 2022 at 17:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR/near/273841167">said</a>:</p>
<blockquote>
<p>Putting the <code>SetDiscriminant</code> first may also break if we get support for fields to which you can't take a reference as in that case we may stash a variant tag in unused bits of a value that would be overwritten when assigning to a field.</p>
</blockquote>
<p>I don't see how <code>SetDiscriminant</code> is special here. If we get MIR support for memory operations that don't operate on whole bits at once, lots of things will break (although see <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Practical.20Approach.20to.20Reusing.20Padding/near/269419084">here</a> where I showed how to reclaim padding without causing problems of this sort)</p>



<a name="273849982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273849982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273849982">(Mar 02 2022 at 18:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR/near/273840960">said</a>:</p>
<blockquote>
<p>You would still need a marker to indicate the location where the value is fully initialized.</p>
</blockquote>
<p>You mean in borrowck or somewhere? I'm not too familiar with MIR at that stage, so I don't know about that. But at least during optimizations, the analysis for "is this value fully initialized" will be simpler, because enums would work exactly like structs</p>



<a name="273853131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273853131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273853131">(Mar 02 2022 at 18:19)</a>:</h4>
<p>During borrowck.</p>



<a name="273853591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273853591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273853591">(Mar 02 2022 at 18:22)</a>:</h4>
<p>Borrowck runs before deaggregation, doesn't it? It shouldn't encounter any SetDiscriminant statements.</p>



<a name="273854261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273854261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273854261">(Mar 02 2022 at 18:27)</a>:</h4>
<p>Indeed. I thought SetDiscriminant was also used before the deaggregator. Maybe it changed since?</p>



<a name="273886116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273886116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273886116">(Mar 02 2022 at 22:16)</a>:</h4>
<p>oh hmm, I wonder if this is feasible to change then. Let me see how much stuff breaks with this change</p>



<a name="273889996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273889996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273889996">(Mar 02 2022 at 22:48)</a>:</h4>
<p>This breaks very few tests. If I want to propose changing this, is it better to describe my exact proposal here and get feedback first, or put up a PR and just discuss there?</p>



<a name="273890067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273890067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273890067">(Mar 02 2022 at 22:49)</a>:</h4>
<p>(very few is 0 ui, 1 codegen, and 16 mir-opt - that last one is sort of to be expected, and I'm honestly surprised it's not more)</p>



<a name="273895033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273895033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273895033">(Mar 02 2022 at 23:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR/near/273750142">said</a>:</p>
<blockquote>
<p>Also as a procedural point: <span class="user-mention silent" data-user-id="116009">nikomatsakis</span> , is this the kind of question that the traits team (or whatever it ends up being called) would be involved in answering?</p>
</blockquote>
<p>in the long run, yes.</p>



<a name="273895079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/273895079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#273895079">(Mar 02 2022 at 23:25)</a>:</h4>
<p>I would think that would fall out from the operational semantics</p>



<a name="274067056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20%60SetDiscriminant%60%20in%20MIR/near/274067056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20.60SetDiscriminant.60.20in.20MIR.html#274067056">(Mar 04 2022 at 01:36)</a>:</h4>
<p>Filed <a href="https://github.com/rust-lang/rust/issues/94590">#94590</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>