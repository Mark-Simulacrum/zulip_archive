<html>
<head><meta charset="utf-8"><title>Enum padding · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html">Enum padding</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261088665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261088665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261088665">(Nov 11 2021 at 03:19)</a>:</h4>
<p>It bugs me endlessly that a huge fraction of enums start with a 1 byte tag followed by 7 bytes of padding. And in complicated types (e.g. the compiler AST/HIR/whatever) you often have 2 or 3 or 4 layers of nested enums, each with their own padding.</p>



<a name="261124147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261124147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261124147">(Nov 11 2021 at 12:00)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Are you thinking of enums with data, or C-like enums (just a discriminant)?</p>



<a name="261134806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261134806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261134806">(Nov 11 2021 at 13:39)</a>:</h4>
<p>I also feel like AST &amp; HIR are hugely inefficient in terms of memory. Variants have typically (1) vastly different sizes, (2) high alignment requirements, (3) some fields with few possible values. They may benefit from a much more aggressive variant optimization mode. However, such optimizations may require to pack bits and have some fields non-adressable. Still, since most of the optimizable fields are Copy (whole HIR could be), that does not really seem like a deal breaker.</p>



<a name="261136125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261136125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261136125">(Nov 11 2021 at 13:51)</a>:</h4>
<p>Yeah this has been an issue for windows-rs, <em>just</em> running configure_and_expand already uses like 9 GB before rustdoc gets a chance to run</p>



<a name="261136237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261136237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261136237">(Nov 11 2021 at 13:52)</a>:</h4>
<p>(time-passes output if anyone is interested: <a href="https://github.com/microsoft/windows-docs-rs/pull/6#issuecomment-904022881">https://github.com/microsoft/windows-docs-rs/pull/6#issuecomment-904022881</a>)</p>



<a name="261174747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261174747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261174747">(Nov 11 2021 at 19:22)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Very much enums with data. One (partial) example I was looking at yesterday:</p>
<div class="codehilite"><pre><span></span><code>print-type-size type: `rustc_infer::traits::ObligationCauseCode`: 40 bytes, alignment: 8 bytes
print-type-size     discriminant: 1 bytes
print-type-size     variant `BuiltinDerivedObligation`: 39 bytes
print-type-size         padding: 7 bytes
print-type-size         field `.0`: 32 bytes, alignment: 8 bytes
print-type-size     variant `ImplDerivedObligation`: 39 bytes
print-type-size         padding: 7 bytes
print-type-size         field `.0`: 32 bytes, alignment: 8 bytes
print-type-size     variant `DerivedObligation`: 39 bytes
print-type-size         padding: 7 bytes
print-type-size         field `.0`: 32 bytes, alignment: 8 bytes
print-type-size     variant `FunctionArgumentObligation`: 31 bytes
print-type-size         padding: 3 bytes
print-type-size         field `.arg_hir_id`: 8 bytes, alignment: 4 bytes
print-type-size         field `.call_hir_id`: 8 bytes
print-type-size         padding: 4 bytes
print-type-size         field `.parent_code`: 8 bytes, alignment: 8 bytes
...
</code></pre></div>



<a name="261175107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175107">(Nov 11 2021 at 19:26)</a>:</h4>
<p>I wonder why the layout code isn't putting the discriminant at the end of the "layout", so we can avoid the extra padding. Maybe that's a good win?</p>



<a name="261175191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175191">(Nov 11 2021 at 19:27)</a>:</h4>
<p>I was also looking at <code>TyKind</code>. It's biggest variant is <code>FnPtr</code>, which contains a <code>PolyFnSig</code>, which is a <code>Binder&lt;FnSig&gt;</code>. <code>FnSig</code> has four fields, and <code>Binder&lt;T&gt;</code> adds another field. I tried "inlining" the five fields directly into <code>FnPtr</code>, like this:</p>
<div class="codehilite"><pre><span></span><code>-    FnPtr(PolyFnSig&lt;&#39;tcx&gt;),
+    FnPtr(&amp;&#39;tcx List&lt;Ty&lt;&#39;tcx&gt;&gt;, bool, hir::Unsafety, abi::Abi, &amp;&#39;tcx List&lt;BoundVariableKind&gt;),
</code></pre></div>
<p>This reduced the size of <code>TyKind</code> from 32 bytes to 24 bytes because it avoided padding. Then I had to change all the use points to account for the less ergonomic layout, using a new function that reconstituted a <code>PolyFnSig</code> from the five fields. A bit of a hassle and had negligible perf effect in the end.</p>



<a name="261175412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175412">(Nov 11 2021 at 19:29)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Interesting idea! For it to help I think every variant would need to have some padding at the end, which isn't so common IME.</p>



<a name="261175459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175459">(Nov 11 2021 at 19:29)</a>:</h4>
<p>The <code>TyKind</code> example shows how lots of padding occurs when you have multiple layers, enums within enums.</p>



<a name="261175597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175597">(Nov 11 2021 at 19:30)</a>:</h4>
<p>If you have an enum within an enum within an enum, you might have 7 bytes of padding after the discriminant for each one, for example.</p>



<a name="261175770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175770">(Nov 11 2021 at 19:32)</a>:</h4>
<p>The layout/alignment requirements for a type T are more strict when a type is within a Vector, say, than when you know it appears by itself within an enum variant. But the same layout is used in both cases.</p>



<a name="261175785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261175785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261175785">(Nov 11 2021 at 19:32)</a>:</h4>
<p>yeah, true</p>



<a name="261177411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261177411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261177411">(Nov 11 2021 at 19:49)</a>:</h4>
<p>I do recall mildly a comment (on a PR that implemented them layout opts) that layout optimizations don't currently cover discriminant but there is no reason why it couldn't.</p>



<a name="261177820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261177820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261177820">(Nov 11 2021 at 19:53)</a>:</h4>
<p>I guess just putting the discriminant at the end is likely to be most straightforward, an ideal implementation would have the ability to place a discriminant between fields of a variant in case that somehow helps.</p>



<a name="261186842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261186842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261186842">(Nov 11 2021 at 21:33)</a>:</h4>
<p>The discriminant surely has to be in the same place for every variant, right?</p>



<a name="261188773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261188773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261188773">(Nov 11 2021 at 21:57)</a>:</h4>
<p>yeah, but there are still situations where e.g. there's some common unused between variants that could be used for the discriminant.</p>



<a name="261193582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193582">(Nov 11 2021 at 22:57)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> One thing we've talked about various times is the idea of a "type you can't take a reference to".</p>



<a name="261193653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193653">(Nov 11 2021 at 22:58)</a>:</h4>
<p>Such a type would not need to use the same layout as that type normally does, because you can't write code that references it without knowing what it's contained in.</p>



<a name="261193660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193660">(Nov 11 2021 at 22:58)</a>:</h4>
<p>Yes!</p>



<a name="261193663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193663">(Nov 11 2021 at 22:58)</a>:</h4>
<p>That would allow more aggressive niche optimizations, such as rearranging the fields of a sub-structure into the containing structure.</p>



<a name="261193716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193716">(Nov 11 2021 at 22:59)</a>:</h4>
<p>That's one possible approach to solve this. I can think of two more.</p>



<a name="261193817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193817">(Nov 11 2021 at 23:00)</a>:</h4>
<p>We could also teach the compiler to handle "alignment" niches: if it knows <code>T</code> must be 4-byte aligned, then <code>&amp;T</code> always has the low bits zero, so that's two bits that could be used for a small discriminant or similar.</p>



<a name="261193907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193907">(Nov 11 2021 at 23:01)</a>:</h4>
<p>And we could teach the compiler to have target-specific opt-in niches for pointers that can never be valid; for instance, under x86_64 Linux, it'd be reasonable to default to "valid pointers may never be less than 4096".</p>



<a name="261193965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261193965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261193965">(Nov 11 2021 at 23:01)</a>:</h4>
<p>Would the "type you can't take a reference to" be an explicitly marked thing, or inferred by the compiler?</p>



<a name="261194015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194015">(Nov 11 2021 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Enum.20padding/near/261193965">said</a>:</p>
<blockquote>
<p>Would the "type you can't take a reference to" be an explicitly marked thing, or inferred by the compiler?</p>
</blockquote>
<p>Initially the former.</p>



<a name="261194038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194038">(Nov 11 2021 at 23:02)</a>:</h4>
<p>I can imagine inferring the latter via whole-program optimization or similar, but we should add the support via explicit type first.</p>



<a name="261194060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194060">(Nov 11 2021 at 23:02)</a>:</h4>
<p>(Also, this wouldn't necessarily be a property of a type, so much as a field of a type. Or an entire aggregate: "splat out all fields of this and don't allow field references".)</p>



<a name="261194373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194373">(Nov 11 2021 at 23:07)</a>:</h4>
<p>Feels a bit like <code>repr(packed)</code></p>



<a name="261194399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194399">(Nov 11 2021 at 23:08)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> FWIW, if you're interested in working on any of those three, I'd be thrilled to be the lang-team liaison for the lang components of them.</p>



<a name="261194519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194519">(Nov 11 2021 at 23:09)</a>:</h4>
<p>I think they'd be valuable optimizations, and they can be the kind of thing that you flip a switch on in Rust, versus pervasive bit-swizzling accesses in C.</p>



<a name="261194611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261194611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261194611">(Nov 11 2021 at 23:10)</a>:</h4>
<p>My current problem is too many shiny things to work on, but I'll keep it in mind <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261196377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261196377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261196377">(Nov 11 2021 at 23:38)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Fair. Though it does seem like a useful path towards mass-optimizing memory usage.</p>



<a name="261196505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261196505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261196505">(Nov 11 2021 at 23:41)</a>:</h4>
<p>The existing optimizations for things like <code>Option&lt;Rc&lt;T&gt;&gt;</code> must already take advantage of low bits, is that right?</p>



<a name="261196766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261196766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261196766">(Nov 11 2021 at 23:45)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> I <em>think</em> that <code>Option&lt;Rc&lt;T&gt;&gt;</code> just takes advantage of the niche for NULL.</p>



<a name="261196771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261196771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261196771">(Nov 11 2021 at 23:45)</a>:</h4>
<p>I don't think we can take advantage of alignment niches at all right now.</p>



<a name="261196854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261196854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261196854">(Nov 11 2021 at 23:46)</a>:</h4>
<p>Oh, so NULL means <code>None</code> and non-NULL means <code>Some</code>?</p>



<a name="261196904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261196904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261196904">(Nov 11 2021 at 23:47)</a>:</h4>
<p>Just like in C <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="261197134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197134">(Nov 11 2021 at 23:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Enum.20padding/near/261196854">said</a>:</p>
<blockquote>
<p>Oh, so NULL means <code>None</code> and non-NULL means <code>Some</code>?</p>
</blockquote>
<p>Right, that's the standard <code>Option</code> optimization we use in many places. We even guarantee it in FFI; you can write <code>Option&lt;&amp;T&gt;</code> instead of <code>*T</code> and we guarantee <code>None</code> will be NULL.</p>



<a name="261197433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197433">(Nov 11 2021 at 23:55)</a>:</h4>
<p>Is <code>Option</code> special-cased, or will that work for any type with the same shape? I'm thinking of</p>
<div class="codehilite"><pre><span></span><code>pub enum Poll&lt;T&gt; {
    Ready(T),
    Pending,
}
</code></pre></div>



<a name="261197452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197452">(Nov 11 2021 at 23:55)</a>:</h4>
<p>It works for any enum of the same shape.</p>



<a name="261197551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197551">(Nov 11 2021 at 23:57)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=e4854a41747d7942badd00f02b6125e7">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=e4854a41747d7942badd00f02b6125e7</a></p>



<a name="261197562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197562">(Nov 11 2021 at 23:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>size_of::&lt;Option&lt;bool&gt;&gt;() = 1
size_of::&lt;Result&lt;(), char&gt;&gt;() = 4
</code></pre></div>



<a name="261197626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197626">(Nov 11 2021 at 23:58)</a>:</h4>
<p>But types can only have one niche, which must be contiguous.</p>



<a name="261197634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197634">(Nov 11 2021 at 23:58)</a>:</h4>
<p>And because of the reference problem: <code>size_of::&lt;Result&lt;bool, char&gt;&gt;() = 8</code></p>



<a name="261197702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261197702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261197702">(Nov 11 2021 at 23:59)</a>:</h4>
<p>If you applied "no references" to either the bool or the char (or both), that could be just 4 bytes.</p>



<a name="261198424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261198424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261198424">(Nov 12 2021 at 00:07)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/45225">#45225</a> was the big one, some tweaks and support for generators since then</p>



<a name="261198564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261198564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261198564">(Nov 12 2021 at 00:09)</a>:</h4>
<p>As far as official guarantees go it's only <code>Option</code> though, the others are unstable optimizations.</p>



<a name="261198776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261198776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261198776">(Nov 12 2021 at 00:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Enum.20padding/near/261198564">said</a>:</p>
<blockquote>
<p>As far as official guarantees go it's only <code>Option</code> though, the others are unstable optimizations.</p>
</blockquote>
<p>I thought that was only a limitation of FFI (that only Option is FFI-safe), not that we didn't guarantee the rest.</p>



<a name="261199301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261199301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261199301">(Nov 12 2021 at 00:22)</a>:</h4>
<p>repr(Rust) has no spec, hence no guarantees in general. this is the only explicit one <a href="https://doc.rust-lang.org/std/option/index.html#representation">https://doc.rust-lang.org/std/option/index.html#representation</a></p>



<a name="261199336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261199336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261199336">(Nov 12 2021 at 00:23)</a>:</h4>
<p>And there's no RFC for niches either.</p>



<a name="261199729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261199729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261199729">(Nov 12 2021 at 00:29)</a>:</h4>
<p>Note that using LSBs and using null for niche are orthogonal</p>



<a name="261199745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Enum%20padding/near/261199745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Enum.20padding.html#261199745">(Nov 12 2021 at 00:29)</a>:</h4>
<p>Since null is also "well-aligned"</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>