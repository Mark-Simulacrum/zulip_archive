<html>
<head><meta charset="utf-8"><title>Macro expansion performance on complex macros · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html">Macro expansion performance on complex macros</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273903757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273903757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273903757">(Mar 03 2022 at 00:45)</a>:</h4>
<p>I'm currently looking at the performance of macro expansion on some crates where it's really expensive.</p>
<ul>
<li>async-std-1.10.0 (<a href="https://github.com/async-rs/async-std/blob/35f768166436112db97224e823b4ee610c81d6d6/src/utils.rs#L247">macro</a>, <a href="https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/stream/stream/mod.rs#L146">example usage</a>)</li>
<li>time-macros-0.2.3 (<a href="https://github.com/time-rs/time/blob/592ef915cf6275069f65483216ba7ccb8081b2bc/time-macros/src/quote.rs#L1">macro</a>, <a href="https://github.com/time-rs/time/blob/159cedbf6e99213501d0a12a33b4e46d3291294f/time-macros/src/format_description/component.rs#L27">example usage</a>)</li>
<li>yansi-0.5.0 (<a href="https://github.com/SergioBenitez/yansi/blob/c5637db6599a72e3d5fd003f7d91f07f47fa3a97/src/docify.rs#L1">macro</a>, <a href="https://github.com/SergioBenitez/yansi/blob/c5637db6599a72e3d5fd003f7d91f07f47fa3a97/src/style.rs#L164">example usage</a>)</li>
</ul>



<a name="273903904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273903904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273903904">(Mar 03 2022 at 00:46)</a>:</h4>
<p>These are all very complex macros with lots of rules and heavy <code>tt</code> metavariable usage.</p>



<a name="273903965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273903965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273903965">(Mar 03 2022 at 00:47)</a>:</h4>
<p>The expense is partly in macro expansion itself (i.e. <code>parse_tt</code>). That code is complex, maintains a lot of state, there's a lot of allocations because chunks of that state gets duplicated a lot (even though it uses <code>Lrc</code> heavily).</p>



<a name="273904042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904042">(Mar 03 2022 at 00:48)</a>:</h4>
<p>And it's also partly in <code>parse_nonterminal</code>, which gets called a <em>lot</em>. E.g. 5.3 million times when compiling <code>async-std-1.10.0</code>.</p>



<a name="273904128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904128">(Mar 03 2022 at 00:49)</a>:</h4>
<p>I've been looking closely at the <code>parse_tt</code> code, making lots of measurements. I can get some small to medium wins (e.g. 10%) with some moderate heroics relating to avoiding allocations. But it feels like there is some quadratic behaviour going on, and it might be worth trying to avoid that.</p>



<a name="273904275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904275">(Mar 03 2022 at 00:50)</a>:</h4>
<p>For example, I printed out the value returned by every call to <code>parse_nonterminal()</code> and counted the frequencies. Here are the most common ones for <code>async-std</code>:</p>
<div class="codehilite"><pre><span></span><code>5312196 counts
(  1)     4553 ( 0.1%,  0.1%): tt Token(Token { kind: Pound, span: src/stream/stream/mod.rs:238:9: 238:10 (#0) })
(  2)     4551 ( 0.1%,  0.2%): tt Delimited(DelimSpan { open: src/stream/stream/mod.rs:238:10: 238:11 (#0), close: src/stream/stream/mod.rs:262:11: 262:12 (#0) }, Bracket, TokenStream([(Token(Token { kind: Ident(&quot;doc&quot;, false), span: src/stream/stream/mod.rs:238:11: 238:14 (#0) }), Alone), (Token(Token { kind: Eq, span: src/stream/stream/mod.rs:238:15: 238:16 (#0) }), Alone), (Token(Token { kind: Literal(Lit { kind: StrRaw(1), symbol: &quot;\n            Advances the stream and returns the next value.\n\n            Returns [`None`] when iteration is finished. Individual stream implementations may\n            choose to resume iteration, and so calling `next()` again may or may not eventually\n            start returning more values.\n\n            [`None`]: https://doc.rust-lang.org/std/option/enum.Option.html#variant.None\n\n            # Examples\n\n            ```\n            # fn main() { async_std::task::block_on(async {\n            #\n            use async_std::prelude::*;\n            use async_std::stream;\n\n            let mut s = stream::once(7);\n\n            assert_eq!(s.next().await, Some(7));\n            assert_eq!(s.next().await, None);\n            #\n            # }) }\n            ```\n        &quot;, suffix: None }), span: src/stream/stream/mod.rs:238:17: 262:11 (#0) }), Alone)]))
(  3)     4549 ( 0.1%,  0.3%): tt Token(Token { kind: Ident(&quot;fn&quot;, false), span: src/stream/stream/mod.rs:263:9: 263:11 (#0) })
(  4)     4547 ( 0.1%,  0.3%): tt Token(Token { kind: Ident(&quot;next&quot;, false), span: src/stream/stream/mod.rs:263:12: 263:16 (#0) })
(  5)     4545 ( 0.1%,  0.4%): tt Delimited(DelimSpan { open: src/stream/stream/mod.rs:263:16: 263:17 (#0), close: src/stream/stream/mod.rs:263:26: 263:27 (#0) }, Paren, TokenStream([(Token(Token { kind: BinOp(And), span: src/stream/stream/mod.rs:263:17: 263:18 (#0) }), Alone), (Token(Token { kind: Ident(&quot;mut&quot;, false), span: src/stream/stream/mod.rs:263:18: 263:21 (#0) }), Alone), (Token(Token { kind: Ident(&quot;self&quot;, false), span: src/stream/stream/mod.rs:263:22: 263:26 (#0) }), Alone)]))
(  6)     4543 ( 0.1%,  0.5%): tt Token(Token { kind: Ident(&quot;where&quot;, false), span: src/stream/stream/mod.rs:264:9: 264:14 (#0) })
(  7)     4541 ( 0.1%,  0.6%): tt Token(Token { kind: Ident(&quot;Self&quot;, false), span: src/stream/stream/mod.rs:265:13: 265:17 (#0) })
(  8)     4539 ( 0.1%,  0.7%): tt Token(Token { kind: Colon, span: src/stream/stream/mod.rs:265:17: 265:18 (#0) })
(  9)     4538 ( 0.1%,  0.8%): tt Token(Token { kind: Interpolated(NtTy(..)), span: src/utils.rs:309:45: 309:47 (#456) })
( 10)     4538 ( 0.1%,  0.9%): tt Token(Token { kind: RArrow, span: src/utils.rs:309:42: 309:44 (#456) })
( 11)     4537 ( 0.1%,  0.9%): tt Token(Token { kind: Ident(&quot;Unpin&quot;, false), span: src/stream/stream/mod.rs:265:19: 265:24 (#0) })
( 12)     4535 ( 0.1%,  1.0%): tt Token(Token { kind: Comma, span: src/stream/stream/mod.rs:265:24: 265:25 (#0) })
</code></pre></div>



<a name="273904456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904456">(Mar 03 2022 at 00:52)</a>:</h4>
<p>All the most common nonterminals are <code>tt</code>s. That first one was parsed 4,553 times. And you can see as you go down the list the frequencies gradually drop. E.g. here's the ones around the 1000th most common nonterminal:</p>
<div class="codehilite"><pre><span></span><code>(1000)     2601 ( 0.0%, 67.1%): tt Token(Token { kind: Gt, span: src/stream/stream/mod.rs:1790:17: 1790:18 (#0) })
(1001)     2599 ( 0.0%, 67.2%): tt Delimited(DelimSpan { open: src/stream/stream/mod.rs:1790:18: 1790:19 (#0), close: src/stream/stream/mod.rs:1790:33: 1790:34 (#0) }, Paren, TokenStream([(Token(Token { kind: Ident(&quot;self&quot;, false), span: src/stream/stream/mod.rs:1790:19: 1790:23 (#0) }), Joint), (Token(Token { kind: Comma, span: src/stream/stream/mod.rs:1790:23: 1790:24 (#0) }), Alone), (Token(Token { kind: Ident(&quot;other&quot;, false), span: src/stream/stream/mod.rs:1790:25: 1790:30 (#0) }), Joint), (Token(Token { kind: Colon, span: src/stream/stream/mod.rs:1790:30: 1790:31 (#0) }), Alone), (Token(Token { kind: Ident(&quot;U&quot;, false), span: src/stream/stream/mod.rs:1790:32: 1790:33 (#0) }), Alone)]))
(1002)     2597 ( 0.0%, 67.2%): tt Token(Token { kind: RArrow, span: src/stream/stream/mod.rs:1790:35: 1790:37 (#0) })
(1003)     2595 ( 0.0%, 67.3%): tt Token(Token { kind: Ident(&quot;Zip&quot;, false), span: src/stream/stream/mod.rs:1790:38: 1790:41 (#0) })
(1004)     2593 ( 0.0%, 67.3%): tt Token(Token { kind: Lt, span: src/stream/stream/mod.rs:1790:41: 1790:42 (#0) })
(1005)     2591 ( 0.0%, 67.4%): tt Token(Token { kind: Ident(&quot;Self&quot;, false), span: src/stream/stream/mod.rs:1790:42: 1790:46 (#0) })
(1006)     2589 ( 0.0%, 67.4%): tt Token(Token { kind: Comma, span: src/stream/stream/mod.rs:1790:46: 1790:47 (#0) })
(1007)     2587 ( 0.0%, 67.5%): tt Token(Token { kind: Ident(&quot;U&quot;, false), span: src/stream/stream/mod.rs:1790:48: 1790:49 (#0) })
(1008)     2585 ( 0.0%, 67.5%): tt Token(Token { kind: Gt, span: src/stream/stream/mod.rs:1790:49: 1790:50 (#0) })
</code></pre></div>



<a name="273904465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904465">(Mar 03 2022 at 00:52)</a>:</h4>
<p>Smells very quadratic.</p>



<a name="273904531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904531">(Mar 03 2022 at 00:53)</a>:</h4>
<p>Despite looking at <code>parse_tt</code> a lot, I admit I still don't fully understand how it works. It's pretty complicated. So my primary question is: is this slowness avoidable?</p>



<a name="273904579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904579">(Mar 03 2022 at 00:53)</a>:</h4>
<p>Are these macros inherently badly written, and the repetition is inherent? Could <code>parse_tt</code> do something smarter here? Some kind of memoization?</p>



<a name="273904697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904697">(Mar 03 2022 at 00:54)</a>:</h4>
<p>Parsing the same token trees over and over, thousands of times... it's not good</p>



<a name="273904935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904935">(Mar 03 2022 at 00:57)</a>:</h4>
<p>Was this token really parsed that many times?</p>



<a name="273904940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273904940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273904940">(Mar 03 2022 at 00:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>(  1)     4553 ( 0.1%,  0.1%): tt Token(Token { kind: Pound, span: src/stream/stream/mod.rs:238:9: 238:10 (#0) })
</code></pre></div>



<a name="273905013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905013">(Mar 03 2022 at 00:58)</a>:</h4>
<p>Looking at the usage, there's only a single macro invocation: <a href="https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/stream/stream/mod.rs#L238">https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/stream/stream/mod.rs#L238</a></p>



<a name="273905040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905040">(Mar 03 2022 at 00:58)</a>:</h4>
<p>and it doesn't appear to do anything weird like expand to a new macro</p>



<a name="273905060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905060">(Mar 03 2022 at 00:58)</a>:</h4>
<p>so I'm not sure how that token could be parsed so many times</p>



<a name="273905122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905122">(Mar 03 2022 at 00:59)</a>:</h4>
<p>It really was</p>



<a name="273905221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905221">(Mar 03 2022 at 01:00)</a>:</h4>
<p>And the tokens nearby almost as many times (though the counts gradually dropped for the later tokens)</p>



<a name="273905415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905415">(Mar 03 2022 at 01:00)</a>:</h4>
<p>wow</p>



<a name="273905455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905455">(Mar 03 2022 at 01:01)</a>:</h4>
<p><code>extension_trait</code> is a recursive macro, I've been assuming that's relevant</p>



<a name="273905465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905465">(Mar 03 2022 at 01:01)</a>:</h4>
<p>Oh, yeah, it's probably related to this: <a href="https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/utils.rs#L304-L326">https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/utils.rs#L304-L326</a></p>



<a name="273905558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905558">(Mar 03 2022 at 01:02)</a>:</h4>
<p>I think our hands may be partially tied by the design of macros like that</p>



<a name="273905575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905575">(Mar 03 2022 at 01:02)</a>:</h4>
<p>I'm wondering about <a href="https://github.com/async-rs/async-std/blob/35f768166436112db97224e823b4ee610c81d6d6/src/utils.rs#L329-L330">this</a></p>



<a name="273905615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905615">(Mar 03 2022 at 01:03)</a>:</h4>
<p>I was thinking more about things like this: <a href="https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/utils.rs#L320-L326">https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/utils.rs#L320-L326</a></p>



<a name="273905632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905632">(Mar 03 2022 at 01:03)</a>:</h4>
<p>where the macro recursively handles one token at a time</p>



<a name="273905776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905776">(Mar 03 2022 at 01:05)</a>:</h4>
<p>In the past, I've wondered about arena-allocating tokens to replace the (frequent) token cloning by a pointer copy</p>



<a name="273905804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905804">(Mar 03 2022 at 01:05)</a>:</h4>
<p>but I haven't gotten around to investing the time needed to do that level of refactoring</p>



<a name="273905868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905868">(Mar 03 2022 at 01:06)</a>:</h4>
<p>I don't think that's such a big deal here</p>



<a name="273905891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273905891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273905891">(Mar 03 2022 at 01:06)</a>:</h4>
<p>Those rules seem almost custom-designed to blow up macro expansion</p>



<a name="273910249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273910249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273910249">(Mar 03 2022 at 01:59)</a>:</h4>
<p>They are laboriously shuffling one <code>tt</code> at a time within the parentheses, until there's little enough on the tail to match one of the earlier rules. If the input is thousands of <code>tt</code>s long, I can easily see how many of them will be parsed thousands of times. And also why the earlier ones gets re-parsed more times than the later ones.</p>



<a name="273911386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911386">(Mar 03 2022 at 02:13)</a>:</h4>
<p>Yikes!</p>



<a name="273911423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911423">(Mar 03 2022 at 02:13)</a>:</h4>
<p>Can this macro be written as a more standard tt muncher?</p>



<a name="273911488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911488">(Mar 03 2022 at 02:14)</a>:</h4>
<p>I'm also wondering if there's some way we could optimize that pattern and handle it without re-parsing untouched tokens.</p>



<a name="273911492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911492">(Mar 03 2022 at 02:14)</a>:</h4>
<p>I mean, I agree that if we can write the macro a better way in the first place we should.</p>



<a name="273911503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911503">(Mar 03 2022 at 02:15)</a>:</h4>
<p>But also, if we can catch an n^2 pattern and optimize it into a linear one, we should.</p>



<a name="273911630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911630">(Mar 03 2022 at 02:17)</a>:</h4>
<p>Oh look!:</p>
<div class="codehilite"><pre><span></span><code>src/lib.rs:#![recursion_limit = &quot;2048&quot;]
</code></pre></div>



<a name="273911637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911637">(Mar 03 2022 at 02:17)</a>:</h4>
<p>In this context, it <em>seems</em> like we could roughly recognize three things:<br>
1) There's a series of macros that are all matching the same prefix.<br>
2) Those macros accumulate into the prefix.<br>
3) The macros never actually parse anything <em>out</em> of the prefix, ever.</p>



<a name="273911731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911731">(Mar 03 2022 at 02:18)</a>:</h4>
<p>That last point seems like the key optimization: if we can recognize an accumulator that is only accumulated into and later emitted, never re-parsed, then we don't re-parse it, we just accumulate into it.</p>



<a name="273911732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911732">(Mar 03 2022 at 02:18)</a>:</h4>
<p>Right. There are numerous other crates that all seem to fit into the "slow macro expansion" bucket, I've just been looking at the top three offenders</p>



<a name="273911837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911837">(Mar 03 2022 at 02:20)</a>:</h4>
<p>Along the same lines, if we can recognize a "source" (like tail in this case) that's only ever parsed out of and never has things added to it, we could parse it once and then use it as a source repeatedly.</p>



<a name="273911872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911872">(Mar 03 2022 at 02:21)</a>:</h4>
<p>I'm not saying this is the right pattern, but the "source" case seems like a required part of parsing, and the "accumulator" could potentially be avoided by just producing macro output incrementally without passing it to the recursive call but hoisting that out still seems like a worthwhile optimization.</p>



<a name="273911913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911913">(Mar 03 2022 at 02:21)</a>:</h4>
<p>Also, the "accumulator" case is one that <em>could</em> make sense if you're going to feed it into something else at the end but only <em>once</em>, not repeatedly as you go.</p>



<a name="273911972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273911972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273911972">(Mar 03 2022 at 02:22)</a>:</h4>
<p>Either way, the only "state" that syntax macros have and can use is their arguments, so recognizing when that's being used as variables would help.</p>



<a name="273921588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273921588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273921588">(Mar 03 2022 at 04:37)</a>:</h4>
<p>I think these are all using "push-down accumulation", which the Little Book of Rust Macros explicitly <a href="https://veykril.github.io/tlborm/decl-macros/patterns/push-down-acc.html">recommends</a>.</p>



<a name="273921713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273921713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273921713">(Mar 03 2022 at 04:39)</a>:</h4>
<p>I noticed that the LBORM puts the accumulator at the end of each rule, rather than the start. I just tried changing the <code>@ext</code> rules in <code>async-std</code>'s <code> </code>extension_trait` so the accumulator is at the end, and instruction counts for a check build dropped from 21.3 billion to 14.8 billion(!)</p>



<a name="273921886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273921886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273921886">(Mar 03 2022 at 04:41)</a>:</h4>
<p>Which makes sense, because putting the accumulator at the front means that on any accumulator-involving rule that fails, rustc will have re-processed the entire accumulator before hitting a post-accumulator token that doesn't match</p>



<a name="273923355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273923355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273923355">(Mar 03 2022 at 05:03)</a>:</h4>
<p>Even with the reordering, we're still re-processing the accumulator on the successful rules</p>



<a name="273925610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273925610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273925610">(Mar 03 2022 at 05:38)</a>:</h4>
<p>How feasible would it be to detect the push-down accumulation pattern?</p>



<a name="273929669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273929669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273929669">(Mar 03 2022 at 06:38)</a>:</h4>
<p>I don't understand the code well enough to answer that question. I'll have to re-read the code with all this in mind...</p>



<a name="273948858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273948858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273948858">(Mar 03 2022 at 09:57)</a>:</h4>
<p>since expansion is 75% of <code>async-std</code>'s check time, I'll also look into ways to help in-crate</p>



<a name="273956745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273956745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273956745">(Mar 03 2022 at 11:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116113">@lqd</span> I'm not sure what you mean by "in-crate".</p>



<a name="273956806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273956806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273956806">(Mar 03 2022 at 11:08)</a>:</h4>
<p>changing the macro</p>



<a name="273956880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273956880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273956880">(Mar 03 2022 at 11:09)</a>:</h4>
<p>comparing with a proc-macro, minimizing it, finding other ways to achieve the rendered docs output, etc</p>



<a name="273961987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273961987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273961987">(Mar 03 2022 at 12:01)</a>:</h4>
<p>As above, putting the accumulator at the end reduces compile time by about 1/3. But this is a common enough pattern that it would be good to find an in-compiler solution.</p>



<a name="273964105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273964105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> weiznich <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273964105">(Mar 03 2022 at 12:22)</a>:</h4>
<p>So skim in here as this seem roughly the right topic for this: <br>
Another macro that is really expensive to expand is diesel <code>__diesel_for_each_tuple!</code> macro. Especially this call <a href="https://github.com/rust-lang/rustc-perf/blob/e8c333e9a6d65bf47a90db6e62922c66ce1fcd33/collector/benchmarks/diesel/diesel/src/type_impls/tuples.rs#L502">here</a>. This likely does not show up in the default runs as rust-pref "only" builds diesel with the default features and not with the <code>128-column-tables</code> flag enabled. That flag blows up the macro expansion time quite a lot. See the <a href="https://github.com/rust-lang/rustc-perf/pull/807#issuecomment-746005967">PR</a> that added diesel to the rustc-pref infrastructure for more details.</p>



<a name="273981579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273981579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273981579">(Mar 03 2022 at 14:38)</a>:</h4>
<p>doesn't the <a href="https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/utils.rs#L308">first rule</a> cover the <a href="https://github.com/async-rs/async-std/blob/b90c2cddd185c087d597922a39a56e038aea7f4e/src/utils.rs#L316">second rule</a> ? if expansion is very eager with this recursive second rule, that work will never be used, right ?</p>



<a name="273996498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/273996498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#273996498">(Mar 03 2022 at 16:16)</a>:</h4>
<p>and if it would make sense to change the rules of what's allowed in order to allow algorithmic speedups in macro expansion, we do have the option of making breaking changes via macros 2.0 :P</p>



<a name="274034728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274034728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274034728">(Mar 03 2022 at 20:28)</a>:</h4>
<p>@lqd: that's what I thought, but when I removed the second of those <code>@doc</code> rules I got a small difference in the <code>cargo doc</code> output. I don't understand why. Remove the second <code>@ext</code> rule seemed to not affect anything, though.</p>



<a name="274034855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274034855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274034855">(Mar 03 2022 at 20:29)</a>:</h4>
<p>I haven't tried the doc ones, but the ext one did improve my measurements</p>



<a name="274034991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274034991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274034991">(Mar 03 2022 at 20:30)</a>:</h4>
<p>I'll try it again on cg soon enough</p>



<a name="274345445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274345445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274345445">(Mar 07 2022 at 03:25)</a>:</h4>
<p>An update: the three crates I've been measuring all defined top-down accumulator macros. I just measured the next seven hottest crates. Six of them were dominated by <code>quote::quote!</code>, which ends up <a href="https://github.com/dtolnay/quote/blob/278057d0d2e59c7de95d79d42e4934783d013e83/src/lib.rs#L734">here</a></p>



<a name="274345457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274345457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274345457">(Mar 07 2022 at 03:25)</a>:</h4>
<p>The other one ended up <a href="https://github.com/bitflags/bitflags/blob/0bc11cb78b73522bc5dface26b3c30cefff94c3e/src/lib.rs#L434">here</a> in the <code>bitflags</code> crate</p>



<a name="274345551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274345551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274345551">(Mar 07 2022 at 03:27)</a>:</h4>
<p>The <code>quote</code> ones go through <a href="https://github.com/dtolnay/quote/blob/278057d0d2e59c7de95d79d42e4934783d013e83/src/lib.rs#L674">here</a>, which is some pretty interesting macro abuse I admit I don't yet understand</p>



<a name="274486565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274486565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274486565">(Mar 08 2022 at 02:05)</a>:</h4>
<p>I think the abuse there is allowing some form of look-ahead/look-back matching on tokens by offsetting the tt-captures by differing amounts.</p>



<a name="274487937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274487937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274487937">(Mar 08 2022 at 02:31)</a>:</h4>
<p>Yes. I don't know yet if this is for error messages or something else</p>



<a name="274519779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274519779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274519779">(Mar 08 2022 at 10:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="215423">weiznich</span> <a href="#narrow/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros/near/273964105">said</a>:</p>
<blockquote>
<p>So skim in here as this seem roughly the right topic for this: <br>
Another macro that is really expensive to expand is diesel <code>__diesel_for_each_tuple!</code> macro. Especially this call <a href="https://github.com/rust-lang/rustc-perf/blob/e8c333e9a6d65bf47a90db6e62922c66ce1fcd33/collector/benchmarks/diesel/diesel/src/type_impls/tuples.rs#L502">here</a>. This likely does not show up in the default runs as rust-pref "only" builds diesel with the default features and not with the <code>128-column-tables</code> flag enabled. That flag blows up the macro expansion time quite a lot. See the <a href="https://github.com/rust-lang/rustc-perf/pull/807#issuecomment-746005967">PR</a> that added diesel to the rustc-pref infrastructure for more details.</p>
</blockquote>
<p>Aaaand this is why rust needs variadic tuples.</p>



<a name="274558833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274558833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274558833">(Mar 08 2022 at 15:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros/near/274345551">said</a>:</p>
<blockquote>
<p>The <code>quote</code> ones go through <a href="https://github.com/dtolnay/quote/blob/278057d0d2e59c7de95d79d42e4934783d013e83/src/lib.rs#L674">here</a>, which is some pretty interesting macro abuse I admit I don't yet understand</p>
</blockquote>
<p>Yeah, it's a "manual" kind of lookahead. It's actually incredibly clever, if I understand it correctly.</p>



<a name="274564276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274564276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274564276">(Mar 08 2022 at 16:19)</a>:</h4>
<p>Basically, dtolnay is implementing something you'd normally implement with "reduce" by using only "map" and "flatmap", so to speak. This avoid the quadratic parsing problem mentioned in this thread.</p>
<p>The quote macro is roughly equivalent to this pseudo-code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">quote</span><span class="p">(</span><span class="n">tokens</span>: <span class="nc">Tokens</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_b3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_curr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tokens_a3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">concat!</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">,</span><span class="w"> </span><span class="sc">'@'</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"></span>
<span class="w">        </span><span class="n">Iter</span>::<span class="n">zip</span><span class="p">(</span><span class="n">tokens_b1</span><span class="p">,</span><span class="w"> </span><span class="n">tokens_b2</span><span class="p">,</span><span class="w"> </span><span class="n">tokens_b3</span><span class="p">,</span><span class="w"> </span><span class="n">curr_token</span><span class="p">,</span><span class="w"> </span><span class="n">tokens_a1</span><span class="p">,</span><span class="w"> </span><span class="n">tokens_a2</span><span class="p">,</span><span class="w"> </span><span class="n">tokens_a3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="p">,</span><span class="w"> </span><span class="n">b3</span><span class="p">,</span><span class="w"> </span><span class="n">curr</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="sc">'#'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">inner</span>:<span class="nc">tt</span><span class="p">),</span><span class="w"> </span><span class="sc">'*'</span><span class="p">,</span><span class="w"> </span><span class="sc">'_'</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">do_interpolation</span><span class="p">(</span><span class="n">inner</span><span class="p">),</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="sc">'#'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">inner</span>:<span class="nc">tt</span><span class="p">),</span><span class="w"> </span><span class="sc">'*'</span><span class="p">,</span><span class="w"> </span><span class="sc">'_'</span><span class="p">,</span><span class="w"> </span><span class="sc">'_'</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">skip</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="sc">'#'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">inner</span>:<span class="nc">tt</span><span class="p">),</span><span class="w"> </span><span class="sc">'*'</span><span class="p">,</span><span class="w"> </span><span class="sc">'_'</span><span class="p">,</span><span class="w"> </span><span class="sc">'_'</span><span class="p">,</span><span class="w"> </span><span class="sc">'_'</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">skip</span><span class="p">(),</span><span class="w"></span>

<span class="w">            </span><span class="c1">// ... other interpolation cases</span>

<span class="w">            </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">token</span>:<span class="nc">tt</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">handle_regular_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This basically "parallelizes" parsing: each token is parsed once, with three tokens of lookahead and three tokens of lookbehind. It handles the <code>#(stuff)*</code> syntax when parsing the <code>#</code> token, and compensates by emitting nothing when it parses the <code>(stuff)</code> / <code>*</code> tokens and detects <code>#</code> in lookback.</p>
<p>This means the complexity of parsing a given <code>quote!</code> invocation O(token_count). This is actually pretty good, and I'm not sure there's any way to do better short of a compiler intrinsic.</p>



<a name="274564934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274564934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274564934">(Mar 08 2022 at 16:23)</a>:</h4>
<p>I wonder if the macros from async-std, time-macros and yansi could be optimized by following the same model.</p>



<a name="274565371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274565371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274565371">(Mar 08 2022 at 16:26)</a>:</h4>
<p>It might not even be worth adding caching optimizations or whatnot to the compilers, if macro parsing is only a serious part of build times in a few crates with extremely complex macros.</p>



<a name="274611753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274611753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274611753">(Mar 08 2022 at 21:44)</a>:</h4>
<p>I think the diesel case is quite different to the others I've been discussing</p>



<a name="274612034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274612034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274612034">(Mar 08 2022 at 21:46)</a>:</h4>
<p><span class="user-mention" data-user-id="263609">@Olivier FAURE</span> Thanks for the explanation. Even if quote is very clever and optimized, it's still showing up as hot in quite a few of these crates, so anything we can do in rustc (at moderate effort) to improve things would be worthwhile.</p>



<a name="274787625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274787625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274787625">(Mar 10 2022 at 04:15)</a>:</h4>
<p>I have spent more time investigating this. I have managed to find one hacky little optimization in the macro expander that reduces compile times of <code>check</code> builds for <code>async-std</code>, <code>time-macros</code> and <code>yansi</code> by 15-20%. But it's a constant time improvement on a quadratic problem. And it's only a 2% win on <code>num-derive</code>, which uses <code>quote</code>.</p>



<a name="274787643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274787643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274787643">(Mar 10 2022 at 04:15)</a>:</h4>
<p>Tweaking the macros in those first three crates would be easy and give bigger wins.</p>



<a name="274787690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274787690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274787690">(Mar 10 2022 at 04:16)</a>:</h4>
<p>I'm not sure about <code>quote</code>, I still don't understand how it works.</p>



<a name="274787732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274787732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274787732">(Mar 10 2022 at 04:17)</a>:</h4>
<p>Avoiding the quadratic-ness of the first three in rustc itself seems hard. The problem is that there are all these recursive invocations of the relevant macro, and each invocation is separate from those before and after it. This makes it hard to maintain state that might allow repetitive operations to be skipped.</p>



<a name="274787785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274787785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274787785">(Mar 10 2022 at 04:18)</a>:</h4>
<p>The chapter on push-down accumulators in the Little Book of Rust Macros definitely needs some text about the performance pitfalls here.</p>



<a name="274795191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274795191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274795191">(Mar 10 2022 at 06:23)</a>:</h4>
<p>I filed a PR for <code>async-std</code>: <a href="https://github.com/async-rs/async-std/pull/1005">https://github.com/async-rs/async-std/pull/1005</a>. Reduces compile time for a <code>cargo check</code> build by 25%.</p>



<a name="274797986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274797986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274797986">(Mar 10 2022 at 07:13)</a>:</h4>
<p>I also did remove the unused rules <a href="https://github.com/async-rs/async-std/pull/1004">https://github.com/async-rs/async-std/pull/1004</a> but didn't do the pushdown change, I knew you'd do it  ^^</p>



<a name="274834450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274834450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274834450">(Mar 10 2022 at 13:31)</a>:</h4>
<p>Something that might help, besides adding optimizations for common cases, is giving macro authors the tools to analyze how expansive their macros are.</p>



<a name="274834823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274834823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274834823">(Mar 10 2022 at 13:34)</a>:</h4>
<p>Maybe something like <a href="https://github.com/dtolnay/cargo-llvm-lines">cargo-llvm-lines</a>, but instead of sorting generics by emitted line count, it sorts macros by how many intermediary passes they go through?</p>



<a name="274835399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274835399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274835399">(Mar 10 2022 at 13:39)</a>:</h4>
<p>sure, we’ve discussed this before in a more general context of being able to see the sources of slowness in one’s project (scheduling issues, missed parallelism, heavy monomorphizations, slow proc macros or build scripts, heavy dependencies, spurious rebuilds, etc). </p>
<p>for macros, one may be able to see some info of these expansion passes via the trace_macros macro, but I’m not sure it contains everything an automated tool would need rn</p>



<a name="274835533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274835533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274835533">(Mar 10 2022 at 13:40)</a>:</h4>
<p>worth looking at for sure</p>



<a name="274852006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274852006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274852006">(Mar 10 2022 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros/near/274787785">말함</a>:</p>
<blockquote>
<p>The chapter on push-down accumulators in the Little Book of Rust Macros definitely needs some text about the performance pitfalls here.</p>
</blockquote>
<p>I added a small note to the top of the <a href="https://veykril.github.io/tlborm/decl-macros/patterns/push-down-acc.html">page</a></p>



<a name="274882448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274882448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274882448">(Mar 10 2022 at 19:20)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> Thanks! I may end up adding a bit more detail, but that's an excellent start</p>



<a name="274887848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274887848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274887848">(Mar 10 2022 at 20:01)</a>:</h4>
<p>You are more than welcome to <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="274930578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274930578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274930578">(Mar 11 2022 at 04:25)</a>:</h4>
<p><span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span> suggested getting rid of the <code>extension_trait</code> macro entirely in <code>async-std</code>, which I did here: <a href="https://github.com/async-rs/async-std/pull/1006">https://github.com/async-rs/async-std/pull/1006</a>. With that, compile time for a non-incremental <code>cargo check</code> build is down by about 75% since I started working on it.</p>



<a name="274930654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274930654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274930654">(Mar 11 2022 at 04:27)</a>:</h4>
<p>I also filed <a href="https://github.com/time-rs/time/pull/453">https://github.com/time-rs/time/pull/453</a> for <code>time-macros</code>, roughly halving its compile time for the same scenario.</p>



<a name="274930723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274930723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274930723">(Mar 11 2022 at 04:28)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> That's two crates now where I've got a big compile-time win by rewriting a push-down accumulator rule so that the accumulator is at the end. The LBORM does have examples with the accumulator at the end, but it would be worthwhile having some text briefly explaining this.</p>



<a name="274933797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274933797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274933797">(Mar 11 2022 at 05:39)</a>:</h4>
<p>I also removed the <code>docify!</code> macro from <code>yansi</code>, but I see now that the repo hasn't been touched in almost three years <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="274934010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274934010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274934010">(Mar 11 2022 at 05:43)</a>:</h4>
<p>I filed <a href="https://github.com/SergioBenitez/yansi/pull/36">https://github.com/SergioBenitez/yansi/pull/36</a> anyway, just in case it's ever resurrected</p>



<a name="274984112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/274984112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#274984112">(Mar 11 2022 at 14:45)</a>:</h4>
<p>I'm now wondering: How do we enable ordinary users to get the kind of insights that are leading <span class="user-mention" data-user-id="120989">@nnethercote</span> to do these experiments? Should the compiler, for example, be gathering time profiles attached to <em>specific macros</em>, so that people observe that there may be opportunities to improve their build times by changing <em>those macros</em> (or eliminating them entirely) ?</p>



<a name="275045495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275045495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275045495">(Mar 11 2022 at 22:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> It's a good question. Possibilities:</p>
<ul>
<li>If you run with <code>-Ztimings</code> and <code>expand_crate</code>/<code>macro_expand_crate</code> are big (e.g. <a href="https://github.com/lqd/rustc-benchmarking-data/blob/main/results/round-17-time-passes-check/Ztp-w-profiling-async-std-1.10.0-Check-Full.txt">here</a>), that indicates macro expansion is a problem.</li>
</ul>



<a name="275045538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275045538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275045538">(Mar 11 2022 at 22:55)</a>:</h4>
<ul>
<li>(Aside: presumably <code>macro_expand_crate</code> is a sub-step of <code>expand_crate</code>. <code>-Ztimings</code> used to use indentation to indicate sub-steps, but that disappeared at some point, which makes me sad.)</li>
</ul>



<a name="275045633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275045633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275045633">(Mar 11 2022 at 22:56)</a>:</h4>
<ul>
<li><code>trace_macros</code> gives some insight, because you can see how many rule matching there are, but it won't make clear that there might be a linear cost within each rule matching, so the quadratic aspect isn't obvious.</li>
</ul>



<a name="275045851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275045851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275045851">(Mar 11 2022 at 22:58)</a>:</h4>
<ul>
<li>If you have to adjust <code>recursion_limit</code> a lot, that's a sign that something bad might be happening. (E.g. <a href="https://github.com/async-rs/async-std/blob/35f768166436112db97224e823b4ee610c81d6d6/src/lib.rs#L285">here</a>)</li>
</ul>



<a name="275046157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275046157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275046157">(Mar 11 2022 at 23:02)</a>:</h4>
<p>It's not a lot to work with! I'm not sure how better information would even be exposed to the user. Have some rustc flag or clippy mode that warns if code might cause compile times to be slow?</p>



<a name="275063190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275063190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275063190">(Mar 11 2022 at 23:45)</a>:</h4>
<p>One idea would be to add on further timings around each macro invocation (using the macro name)</p>



<a name="275063201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275063201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275063201">(Mar 11 2022 at 23:45)</a>:</h4>
<p>and add an option to show just those timings</p>



<a name="275087102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275087102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275087102">(Mar 12 2022 at 09:24)</a>:</h4>
<p>Showing which macros are expensive in such a way would be already helpful, but it's still probably going to be hard to know <em>why</em> they are expensive (and fix them) without more metrics, e.g. the number of expansions, token tree sizes, success/failure stats about rule matching, etc</p>
<p>If y'all also think adding timing information would be a good first step, I'll try to work on that. Recording and showing timings via <code>-Zself-profile-events</code> seems interesting. But I know nothing about the macro expansion code, so if <span class="user-mention" data-user-id="125294">@Aaron Hill</span> you would have the time to mentor me bit about it, and provide a few pointers, that would be greatly appreciated.</p>



<a name="275309003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275309003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275309003">(Mar 14 2022 at 22:56)</a>:</h4>
<p>One useful measurement might be the number of times <code>parse_nonterminal</code> is called -- that's the best signal of quadratic-ness</p>



<a name="275328604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275328604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275328604">(Mar 15 2022 at 04:25)</a>:</h4>
<p>In terms of other things that could be detected as possible causes of slow compile times, the other good possibility I can think of is if a function gets really large, e.g. lots of BBs or local variables.</p>



<a name="275328614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275328614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275328614">(Mar 15 2022 at 04:25)</a>:</h4>
<p>i.e. "Function <code>f</code> is very large, consider making it smaller".</p>



<a name="275328627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275328627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275328627">(Mar 15 2022 at 04:26)</a>:</h4>
<p>There are a few crates I know (e.g. <code>keccak</code> and <code>inflate</code> in <code>rustc-perf</code>, <code>http-0.2.6</code> on <a href="http://crates.io">crates.io</a>) that would be hit by that.</p>



<a name="275328681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275328681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275328681">(Mar 15 2022 at 04:26)</a>:</h4>
<p>clippy has a <code>perf</code> category, this could possibly be a new category, <code>compile-time</code> or something</p>



<a name="275355056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275355056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275355056">(Mar 15 2022 at 10:35)</a>:</h4>
<p>Also, one difficulty I have is that any such command-line option is going to be unstable at first, maybe for years, which means you need to use a nightly compiler even if your current compiler has the option.</p>



<a name="275355401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275355401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275355401">(Mar 15 2022 at 10:38)</a>:</h4>
<p>That's annoying because:</p>
<ul>
<li>You need to have a nightly toolchain installed and remember to use the <code>+nightly</code> flag.</li>
<li>If you're used to compiling with a stable toolchain, switching to nightly will recompile all your program and your dependencies, which is kind of a big flow breaker.</li>
</ul>



<a name="275355614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275355614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275355614">(Mar 15 2022 at 10:40)</a>:</h4>
<p>I understand the rationale when this is about language features or cargo configs (they might be changed later), but in that case you're just trying to glean some information about your build process. There's almost no way using an experimental instrumentation flag in stable leads to breakage, unless the flag is used in CI and dropped, or parsed by a third-party tool and the format changes (and even those are a stretch).</p>



<a name="275355716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275355716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275355716">(Mar 15 2022 at 10:41)</a>:</h4>
<p>I wish there was some kind of middle-ground for read-only unstable options, something like "You're allowed to use them in stable, but only from a user console, not a pipe or a script. The option gives you a warning in a console and an error in a script".</p>



<a name="275596964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275596964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275596964">(Mar 17 2022 at 01:09)</a>:</h4>
<p><span class="user-mention" data-user-id="263609">@Olivier FAURE</span> I now understand what <code>quote</code> is doing. The advantage of that approach is that the macro is no longer recursive, so you can process longer inputs without having to increase <code>recursion_limit</code>. But it's not  a speed win, it's still quadratic.</p>



<a name="275597023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275597023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275597023">(Mar 17 2022 at 01:10)</a>:</h4>
<p>I tried converting <code>quote!</code> to a standard TT muncher and it was faster in some cases. But unfortunately standard TT munchers are <em>also</em> quadratic <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="275597059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275597059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275597059">(Mar 17 2022 at 01:11)</a>:</h4>
<p>Because they work like this: "process N tokens", "process N-1 tokens", ... "process 1 token"</p>



<a name="275597117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275597117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275597117">(Mar 17 2022 at 01:12)</a>:</h4>
<p>Push-down accumulation macros are twice quadratic, because they have that behaviour for the input, and they're also building up an output whose size goes 1, 2, 3, ... N.</p>



<a name="275597206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275597206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275597206">(Mar 17 2022 at 01:14)</a>:</h4>
<p>In summary, TT munchers are 0.5N^2, while push-down accumulators are N^2</p>



<a name="275597928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275597928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275597928">(Mar 17 2022 at 01:27)</a>:</h4>
<p>I would expect that at least the output will not be inspected too much by a TT muncher, meaning that you are just copying pointers around. At least for some possible implementations of the macro engine it should be possible to make these patterns O(n log n) or O(n)</p>



<a name="275604410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275604410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275604410">(Mar 17 2022 at 03:42)</a>:</h4>
<p>You might expect that, but it's not what happens in the current compiler.</p>



<a name="275604423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275604423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275604423">(Mar 17 2022 at 03:42)</a>:</h4>
<p>For a simple macro like this:</p>
<div class="codehilite"><pre><span></span><code>macro_rules! munch {
    ($token:tt $($tail:tt)*) =&gt; {
        let _x = 3;
        munch!($($tail)*)
    };
    () =&gt; {};
}
</code></pre></div>



<a name="275604432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275604432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275604432">(Mar 17 2022 at 03:42)</a>:</h4>
<p>The number of calls to <code>parse_nonterminal</code> is quadratic relative to the number of input tokens</p>



<a name="275627205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275627205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275627205">(Mar 17 2022 at 09:45)</a>:</h4>
<blockquote>
<p>But it's not  a speed win, it's still quadratic.</p>
</blockquote>
<p>What do you mean? It should be linear.</p>



<a name="275636906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275636906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275636906">(Mar 17 2022 at 11:16)</a>:</h4>
<p>To be specific, if I'm understanding the macro correctly (I haven't tested it or anything):</p>
<p>For every instance of <code>quote!</code> called with <code>N</code> tokens:</p>
<ul>
<li><code>quote_each_token!</code> is called once with <code>N</code> tokens</li>
<li><code>quote_tokens_with_context!</code> is called once with (roughly) <code>7N + 36</code> tokens</li>
<li><code>quote_token_with_context!</code> is called <code>N + 6</code> times with <code>7</code> tokens each.</li>
<li><code>quote_token</code> is called <code>O(N)</code> times with a single token or so.</li>
</ul>
<p>Now, <code>quote_token!</code> is actually recursive, and calls <code>quote!</code> on group tokens eg <code>(), [], {}</code>. I'm not sure that's what you mean by quadratic?</p>



<a name="275636947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275636947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275636947">(Mar 17 2022 at 11:16)</a>:</h4>
<p>If it is, it sounds like a problem with the macro engine, not the quote macro.</p>



<a name="275637952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275637952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275637952">(Mar 17 2022 at 11:27)</a>:</h4>
<p>I think token matching is linear in input size. So if the macro is invoked with an input size linear in the original input size (so not say a single token each time) an amount of times linear in the input size the resulting runtime is quadratic (linear times linear).</p>



<a name="275647995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275647995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275647995">(Mar 17 2022 at 13:00)</a>:</h4>
<p>Yeah, but that's not the case.</p>



<a name="275648246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275648246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275648246">(Mar 17 2022 at 13:02)</a>:</h4>
<p>AFAICT, each sub-macro is either called <code>O(N)</code> times with <code>O(1)</code> tokens, or <code>O(1)</code> times with <code>O(N)</code> tokens</p>



<a name="275648450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275648450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275648450">(Mar 17 2022 at 13:03)</a>:</h4>
<p>Like, that's the whole point of the weird parsing scheme.</p>



<a name="275648678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275648678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275648678">(Mar 17 2022 at 13:04)</a>:</h4>
<p>(Paging <span class="user-mention" data-user-id="119235">@David Tolnay</span>, since we're discussing his lib)</p>



<a name="275652866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275652866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275652866">(Mar 17 2022 at 13:36)</a>:</h4>
<p>Right</p>



<a name="275674067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275674067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275674067">(Mar 17 2022 at 15:46)</a>:</h4>
<p>Yeah I don't immediately understand how it would be quadratic, other than in nesting depth which is at most let's say 10 ever.</p>



<a name="275768506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Macro%20expansion%20performance%20on%20complex%20macros/near/275768506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Macro.20expansion.20performance.20on.20complex.20macros.html#275768506">(Mar 18 2022 at 07:43)</a>:</h4>
<p>True, my mistake</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>