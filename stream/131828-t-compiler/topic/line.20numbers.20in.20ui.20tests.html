<html>
<head><meta charset="utf-8"><title>line numbers in ui tests · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html">line numbers in ui tests</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278522641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278522641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278522641">(Apr 11 2022 at 08:35)</a>:</h4>
<p>Hey all!</p>
<p>At work I have the need to annotate a lot of UI tests with additional comments on top of each file, but I'm having problems with the line numbers in error messages. Each comment I add shifts all the line numbers and requires running <code>--bless</code>, and causes merge conflicts when the test is updated upstream. Those annotations are specific to our CI setup so there isn't much value in upstreaming them (which would solve the merge conflicts problem).</p>
<p>I've also been encountering this in PRs to rust-lang/rust (like the recent bootstrap update I did), where changing something on top of the file requires changing the line numbers:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span> error: the target features paca, pacg must all be either enabled or disabled together<span class="w"></span>
<span class="gd">-   --&gt; $DIR/tied-features.rs:13:5</span><span class="w"></span>
<span class="gi">+   --&gt; $DIR/tied-features.rs:12:5</span><span class="w"></span>
<span class="w"> </span>    |<span class="w"></span>
<span class="w"> </span> LL |     #[target_feature(enable = "pacg")]<span class="w"></span>
<span class="w"> </span>    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<span class="w"></span>
<span class="w"> </span>    |<span class="w"></span>
<span class="w"> </span>    = help: add the missing features in a `target_feature` attribute<span class="w"></span>
</code></pre></div>
<p>I did some digging, and in the <a href="https://github.com/rust-lang/rust/pull/48449">PR changing most line numbers to <code>LL</code></a> it was mentioned that the line numbers in <code>--&gt;</code> were <a href="https://github.com/rust-lang/rust/issues/46643#issuecomment-350831862">explicitly not replaced to detect error reordering</a>. Later, the remaining line and column numbers were changed <a href="https://github.com/rust-lang/rust/pull/53558">only for paths outside the test itself</a>.</p>
<p>Are the concerns about error reordering still present, or would the compiler team be interested in a PR removing all remaining line numbers and replacing them with <code>LL:COL</code>?</p>



<a name="278527018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278527018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278527018">(Apr 11 2022 at 09:16)</a>:</h4>
<p>Replacing the line numbers with LL seems fine, though I'd kinda prefer to keep the column numbers, since that's something we should detect regressions in the values of.</p>



<a name="278527085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278527085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278527085">(Apr 11 2022 at 09:17)</a>:</h4>
<p>For the line numbers, I wonder if there's something more we could do to tie the line numbers to the actual code, such that we're robust against adding lines...</p>



<a name="278534555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278534555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278534555">(Apr 11 2022 at 10:33)</a>:</h4>
<blockquote>
<p>Are the concerns about error reordering still present</p>
</blockquote>
<p>Yes, the concerns still very much exist.<br>
Even with the anonymization as it's done right now it's hard to read the tests sometimes.<br>
If we are talking about test usefulness for humans, then no lines would be anonymized ideally, the fact that we have to anonymize a part of them is a tradeoff.</p>



<a name="278535146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278535146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278535146">(Apr 11 2022 at 10:40)</a>:</h4>
<blockquote>
<p>annotate a lot of UI tests with additional comments on top of each file</p>
</blockquote>
<p>What kind of annotations we are talking about?<br>
Is it additional compiletest annotations, or something custom?<br>
Maybe they can be added at the end of test files? I think we can even modify compiletest to do that if necessary.</p>



<a name="278536832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278536832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278536832">(Apr 11 2022 at 11:01)</a>:</h4>
<p>Basically, we need to link some tests with their corresponding (internal) issue numbers or requirements, like <code>// annotate: #1234</code></p>
<p>Our plan was to have compiletest parse those annotations, validate them and emit a list of all annotations with the related tests (enabling the rest of our tooling to process that data). If adding any annotation requires a <code>--bless</code> because the line numbers change, pulling new changes from rust-lang/rust into our fork would become too much painful.</p>
<p>I'm open to have compiletest parse annotations up to the end of the file, <a href="https://github.com/rust-lang/rust/blob/48a9e104dfafdec3a5d00d365229d6369939f433/src/tools/compiletest/src/header.rs#L514-L531">but that's currently not done</a>. If you want I can send a PR lifting the restriction.</p>



<a name="278542556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278542556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278542556">(Apr 11 2022 at 11:59)</a>:</h4>
<p>This looks like a better alternative to me than removing line information.</p>



<a name="278545039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278545039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278545039">(Apr 11 2022 at 12:23)</a>:</h4>
<p>ok! I originally proposed removing the line information as I also kinda found that annoying when making PRs, but I understand others might find it useful</p>



<a name="278549726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278549726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278549726">(Apr 11 2022 at 13:01)</a>:</h4>
<p>Hm</p>



<a name="278549950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278549950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278549950">(Apr 11 2022 at 13:03)</a>:</h4>
<p>I think end of file parsing seems OK, but it's probably a little awkward to put the annotations down at the end of the file. I wonder if we should consider e.g. stripping annotation lines prior to calling rustc, so that the number of annotations doesn't affect final output, though that would make finding the original bit of the file that produced output rather annoying.</p>



<a name="278550074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278550074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278550074">(Apr 11 2022 at 13:04)</a>:</h4>
<p>Unless you can instead maintain an out-of-band list that just lists all UI tests and maps them to a set of annotations, which might also work ok, at least for this kind of thing</p>



<a name="278561418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278561418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278561418">(Apr 11 2022 at 14:26)</a>:</h4>
<blockquote>
<p>I think end of file parsing seems OK, but it's probably a little awkward to put the annotations down at the end of the file</p>
</blockquote>
<p>having tried that it's indeed a bit awkward, but it's way better than maintaining out-of-bad lists</p>
<blockquote>
<p>I wonder if we should consider e.g. stripping annotation lines prior to calling rustc, so that the number of annotations doesn't affect final output, though that would make finding the original bit of the file that produced output rather annoying.</p>
</blockquote>
<p>not sure what the opinion of the compiler team is, but IMO incorrect line numbers you have to offset in your mind are worse than no line numbers</p>



<a name="278579865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/line%20numbers%20in%20ui%20tests/near/278579865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/line.20numbers.20in.20ui.20tests.html#278579865">(Apr 11 2022 at 16:29)</a>:</h4>
<p>Yeah, that seems right to me.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>