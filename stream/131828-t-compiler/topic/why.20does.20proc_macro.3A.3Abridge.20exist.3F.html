<html>
<head><meta charset="utf-8"><title>why does proc_macro::bridge exist? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html">why does proc_macro::bridge exist?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261149836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261149836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261149836">(Nov 11 2021 at 15:48)</a>:</h4>
<p>my understanding is that it just wasn't possible to use proc-macros with the stage1 compiler before that</p>



<a name="261150145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150145">(Nov 11 2021 at 15:51)</a>:</h4>
<p>I think that’s still perhaps a little unsatisfying, because I think proc macros are morally “part of the compiler,” so if you’re compiling using the stage1 compiler, you probably want to load stage1-compiled proc macros. But implementing that seems like maybe more trouble than it’s worth, so whatever.</p>



<a name="261150260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150260">(Nov 11 2021 at 15:52)</a>:</h4>
<p>I don't think I understand. How would you compile stage2 <code>rustc_macros</code> if the ABI didn't match?</p>



<a name="261150285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150285">(Nov 11 2021 at 15:52)</a>:</h4>
<p>note that these are proc macros <em>used to generate compiler code</em>, not built-in macros</p>



<a name="261150611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150611">(Nov 11 2021 at 15:54)</a>:</h4>
<p>Right, but proc macros currently always exist in a separate crate, right? So if you have code in the compiler that depends on some proc macro in some crate <code>a</code>, then when compiling the stage2 compiler using the stage1 compiler, you could still load the <code>a</code> crate compiled with the stage1 compiler, and there’s no problem, because the stage1-compiled proc macro just generates token streams. So the stage1 compiler will compile the generated code using the new calling convention, and everything is okay… right?</p>



<a name="261150769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150769">(Nov 11 2021 at 15:56)</a>:</h4>
<p>Err, no it isn’t, I said that wrong. You’d need to load crate <code>a</code> compiled with the stage0 compiler.</p>



<a name="261150771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150771">(Nov 11 2021 at 15:56)</a>:</h4>
<p>I think this is a question for <span class="user-mention" data-user-id="116122">@simulacrum</span> or <span class="user-mention" data-user-id="119009">@eddyb</span>  <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="261150846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150846">(Nov 11 2021 at 15:56)</a>:</h4>
<p>(I guess I don’t actually know whether Rust’s stage numbering starts from 0 or 1. :))</p>



<a name="261150930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261150930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261150930">(Nov 11 2021 at 15:57)</a>:</h4>
<p>don't worry, no one else does either <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span><br>
<a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#understanding-stages-of-bootstrap">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#understanding-stages-of-bootstrap</a></p>



<a name="261151139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151139">(Nov 11 2021 at 15:58)</a>:</h4>
<p>Okay, it looks like it uses the numbering scheme I was assuming… but what I said above was still wrong. When I wrote</p>
<blockquote>
<p>if you’re compiling using the stage1 compiler, you probably want to load stage1-compiled proc macros</p>
</blockquote>
<p>what I really should have said was</p>
<blockquote>
<p>if you’re compiling using the stage1 compiler, you probably want to load stage0-compiled proc macros</p>
</blockquote>



<a name="261151247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151247">(Nov 11 2021 at 15:59)</a>:</h4>
<p>did this thread get split from the other one?</p>



<a name="261151250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151250">(Nov 11 2021 at 15:59)</a>:</h4>
<p>Because if proc macros are “morally part of the compiler,” then the point is you want them to have been compiled with the same ABI as the compiler you’re currently using.</p>



<a name="261151256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151256">(Nov 11 2021 at 15:59)</a>:</h4>
<p>given how many times I've gotten this wrong I am very unconfident in anything other than changing x.py to actually do the thing <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="261151269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151269">(Nov 11 2021 at 15:59)</a>:</h4>
<p>I clicked on a notification that pinged me and got very confused</p>



<a name="261151273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151273">(Nov 11 2021 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261151247">said</a>:</p>
<blockquote>
<p>did this thread get split from the other one?</p>
</blockquote>
<p>yes</p>



<a name="261151282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151282">(Nov 11 2021 at 15:59)</a>:</h4>
<p>sorry for the confusion</p>



<a name="261151312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151312">(Nov 11 2021 at 16:00)</a>:</h4>
<p>is this the thread I should read?</p>



<a name="261151352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151352">(Nov 11 2021 at 16:00)</a>:</h4>
<p>yes</p>



<a name="261151384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151384">(Nov 11 2021 at 16:00)</a>:</h4>
<p>(the other was 150+ messages)</p>



<a name="261151466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151466">(Nov 11 2021 at 16:00)</a>:</h4>
<p>(I don't have strong opinions on finishing/stabilizing the generalization of hygiene other than "someone should get to it" :P)</p>



<a name="261151882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151882">(Nov 11 2021 at 16:03)</a>:</h4>
<p><span class="user-mention" data-user-id="456123">@Alexis King</span> so the problem being solved is being able to compile the proc macro with the compiler which will then load it. an ABI bridge isn't needed to do this with a normal Rust release. however, <code>stage1/bin/rustc</code> is really weird in its internals</p>



<a name="261151946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151946">(Nov 11 2021 at 16:04)</a>:</h4>
<p>it can't compile code that then links to itself</p>



<a name="261151974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261151974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261151974">(Nov 11 2021 at 16:04)</a>:</h4>
<p>right, yeah, I guess that makes sense</p>



<a name="261152016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152016">(Nov 11 2021 at 16:04)</a>:</h4>
<p>its own internal ABI is potentially arbitrarily mismatched (from memory layouts to symbol manglings, etc. etc.) from the ABI it knows how to compile with</p>



<a name="261152065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152065">(Nov 11 2021 at 16:05)</a>:</h4>
<p>and Rust has nothing like a "versioned protocol" built-in, so this "bridge" mechanism was the best I could come up with at the time</p>



<a name="261152121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152121">(Nov 11 2021 at 16:05)</a>:</h4>
<p>Yeah, you’re right, if the proc macro code depends on stuff in the compiler, then you have the same bootstrapping problems with proc macros that you do with the compiler itself</p>



<a name="261152153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152153">(Nov 11 2021 at 16:05)</a>:</h4>
<p>additionally, it's 99% RPC, with the hope of eventually using helper processes to run proc macros in isolated separate processes</p>



<a name="261152252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152252">(Nov 11 2021 at 16:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152153">said</a>:</p>
<blockquote>
<p>additionally, it's 99% RPC, with the hope of eventually using helper processes to run proc macros in isolated separate processes</p>
</blockquote>
<p>hey, this is basically <code>watt</code> we were talking  about before<br>
<span class="user-mention silent" data-user-id="278740">Anatol Ulrich</span> <a href="#narrow/stream/131828-t-compiler/topic/The.20state.20of.20proc.20macros/near/261091883">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span>, tangentially (performance related) - have you seen <a href="https://github.com/dtolnay/watt">watt</a>?</p>
</blockquote>



<a name="261152255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152255">(Nov 11 2021 at 16:06)</a>:</h4>
<p>sadly this stalled because even cross-thread isolation (which was really easy to implement and test) was a p sad perf hit (due to rescheduling or something?)</p>



<a name="261152298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152298">(Nov 11 2021 at 16:07)</a>:</h4>
<p>yeah, I think doing that would probably be unnecessarily slow, though I do understand the desire to do so</p>



<a name="261152363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152363">(Nov 11 2021 at 16:07)</a>:</h4>
<p>maybe using OS features to share pages across processes would make it possible to improve performance, but I’ve never actually looked into how that works and what the perf characteristics are</p>



<a name="261152376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152376">(Nov 11 2021 at 16:07)</a>:</h4>
<p>proc macros being arbitrary Rust code sucks for various reasons, but more isolation tends to be a slow down - <span class="user-mention" data-user-id="270901">@Nika Layzell</span> started working on massive bridge improvements but I haven't had the bandwidth to help with the review and stuff</p>



<a name="261152465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152465">(Nov 11 2021 at 16:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152363">said</a>:</p>
<blockquote>
<p>maybe using OS features to share pages across processes would make it possible to improve performance, but I’ve never actually looked into how that works and what the perf characteristics are</p>
</blockquote>
<p>I think we would need to first make cross-thread a negligible slowdown from same-thread, to even hope to do okay with multi-process</p>



<a name="261152506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152506">(Nov 11 2021 at 16:08)</a>:</h4>
<p>right, yeah, that makes sense, too</p>



<a name="261152553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152553">(Nov 11 2021 at 16:09)</a>:</h4>
<p>in fact, multi-process might not be much harder at that point than cross-thread, since the thread control-flow separation seems to have bigger implications than the address space separation (but I haven't done any fancy measurements so maybe I'm wrong)</p>



<a name="261152602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152602">(Nov 11 2021 at 16:09)</a>:</h4>
<p>wouldn't multi-process lose CoW semantics? I can imagine that being a pretty big slowdown</p>



<a name="261152661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152661">(Nov 11 2021 at 16:10)</a>:</h4>
<p>Generally my perspective on running proc macros in a truly isolated context would be “don’t”, because I think it opens up a lot of additional cans of worms that make the cure questionably better than the disease… I think it would be more successful to try to find a way to improve safety of running proc macros in-process, on the same thread</p>



<a name="261152698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152698">(Nov 11 2021 at 16:10)</a>:</h4>
<p>there isn't really anything you can do from what I looked at</p>



<a name="261152732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152732">(Nov 11 2021 at 16:10)</a>:</h4>
<p>it's just too much of an open-ended program</p>



<a name="261152799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152799">(Nov 11 2021 at 16:11)</a>:</h4>
<p>even banning global state runs into a myriad of issues from not being able to tell benign idempotent caching from true cross-invocation communication</p>



<a name="261152833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152833">(Nov 11 2021 at 16:11)</a>:</h4>
<p>That would provide far weaker benefits from a true security perspective, but as I said in the previous thread, I think the security issue is a lot less meaningful than people often initially think, and what’s more important is improving usability that primarily protects the programmer from themselves rather than from bad actors</p>



<a name="261152843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152843">(Nov 11 2021 at 16:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152661">said</a>:</p>
<blockquote>
<p>Generally my perspective on running proc macros in a truly isolated context would be “don’t”, because I think it opens up a lot of additional cans of worms that make the cure questionably better than the disease</p>
</blockquote>
<p>Eh, once you have out of process you can choose to let the process have system access or run pure compute. It should be <em>an option</em>.</p>



<a name="261152852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152852">(Nov 11 2021 at 16:11)</a>:</h4>
<p>I'm not interested in security btw</p>



<a name="261152926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152926">(Nov 11 2021 at 16:12)</a>:</h4>
<p>there's a far bigger issue that sadly is less well-known because of the incidental impacts of rustc's design on querification</p>



<a name="261152949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152949">(Nov 11 2021 at 16:12)</a>:</h4>
<p>I don’t think it should necessarily be an option because it makes various parts of the system enormously more difficult to design in a useful way</p>



<a name="261152951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261152951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261152951">(Nov 11 2021 at 16:12)</a>:</h4>
<p>pushing incremental recompilation into the front-end stopped before having to account for proc macros, for now</p>



<a name="261153056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153056">(Nov 11 2021 at 16:13)</a>:</h4>
<p>but even if we managed to do it, proc macros cannot be treated like pure functions</p>



<a name="261153068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153068">(Nov 11 2021 at 16:13)</a>:</h4>
<p>it’s theoretically possible to make proc macros cooperate with querification/incrementalization but it is not well-tread in any existing system I am aware of, so there’s no proven designs that I know about</p>



<a name="261153152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153152">(Nov 11 2021 at 16:14)</a>:</h4>
<p>you don't need anything other than determinism for Salsa-like systems to be correct, that's the beauty of it</p>



<a name="261153153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153153">(Nov 11 2021 at 16:14)</a>:</h4>
<p>Yeah, I am about to say that I am aware of existence of stateful proc macros.</p>



<a name="261153186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153186">(Nov 11 2021 at 16:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152951">said</a>:</p>
<blockquote>
<p>pushing incremental recompilation into the front-end stopped before having to account for proc macros, for now</p>
</blockquote>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> is working on this btw :)</p>



<a name="261153203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153203">(Nov 11 2021 at 16:14)</a>:</h4>
<p>in particular on making HIR lowering incremental</p>



<a name="261153257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153257">(Nov 11 2021 at 16:15)</a>:</h4>
<p>stateful proc macros are often highly desirable, you’d just need to allow their state management to cooperate with dependency tracking to allow them to be incrementalized</p>



<a name="261153264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153264">(Nov 11 2021 at 16:15)</a>:</h4>
<p>anyway, the only future I see for that kind of endeavor is running proc macros in WASM VMs (or miri but that's too slow), with an opt-in in <code>Cargo.toml</code></p>



<a name="261153277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153277">(Nov 11 2021 at 16:15)</a>:</h4>
<p>/me really wants resolving to be incremental so he can stop thinking about <a href="https://github.com/rust-lang/rust/issues/83761">https://github.com/rust-lang/rust/issues/83761</a></p>



<a name="261153291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153291">(Nov 11 2021 at 16:15)</a>:</h4>
<p>and just not incrementalizing stateful/IO-interacting stuff</p>



<a name="261153388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153388">(Nov 11 2021 at 16:16)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> if you can run it in a wasm VM why not in a sandbox/jail? That would be faster</p>



<a name="261153423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153423">(Nov 11 2021 at 16:16)</a>:</h4>
<p>exposing statefulness to macros without compromising on separate compilation is part of the design in the “Composable and Compilable Macros” paper</p>



<a name="261153476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153476">(Nov 11 2021 at 16:16)</a>:</h4>
<p>(you can still get the dependency-firewalling benefits if the proc macro <em>happens to</em> return the same tokens again, but that requires <em>running</em> the proc macro again. a deterministic proc macro doesn't have to be re-run if the inputs changed tho, that would be the diference)</p>



<a name="261153505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153505">(Nov 11 2021 at 16:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261153388">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> if you can run it in a wasm VM why not in a sandbox/jail? That would be faster</p>
</blockquote>
<p>global state</p>



<a name="261153519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153519">(Nov 11 2021 at 16:17)</a>:</h4>
<p>there is no sandbox/jail that guarantees determinism</p>



<a name="261153538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153538">(Nov 11 2021 at 16:17)</a>:</h4>
<p>from global state to weird microarchitectural nonsense</p>



<a name="261153539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153539">(Nov 11 2021 at 16:17)</a>:</h4>
<p>it would have to be different in Rust, because Rust’s incrementalization is more sophisticated than traditional separate compilation, and it’s more aggressive in what it attempts to achieve, but Rust proc macros also generally do less, so I don’t see why it wouldn’t be possible</p>



<a name="261153595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153595">(Nov 11 2021 at 16:17)</a>:</h4>
<blockquote>
<p>Rust proc macros also generally do less</p>
</blockquote>
<p><em>cough</em> sqlx <em>cough</em></p>



<a name="261153685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153685">(Nov 11 2021 at 16:18)</a>:</h4>
<p>you cannot quantify what the non-deterministic fragment of a proc macro is without running it, basically</p>



<a name="261153745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153745">(Nov 11 2021 at 16:18)</a>:</h4>
<p>I suppose the main danger here is that an incorrectly-written proc macro could make incremental compilation produce a different result from non-incremental compilation, which seems probably undesirable</p>



<a name="261153770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153770">(Nov 11 2021 at 16:18)</a>:</h4>
<p>you can still avoid doing work <em>later</em> in the compilation, if most of its output hasn't changed, but you will always have to run proc macros that aren't limited by their execution environment in drastic ways</p>



<a name="261153793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153793">(Nov 11 2021 at 16:19)</a>:</h4>
<p>anyway before I get even more distracted</p>



<a name="261153814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153814">(Nov 11 2021 at 16:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152252">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152153">said</a>:</p>
<blockquote>
<p>additionally, it's 99% RPC, with the hope of eventually using helper processes to run proc macros in isolated separate processes</p>
</blockquote>
<p>hey, this is basically <code>watt</code> we were talking  about before<br>
<span class="user-mention silent" data-user-id="278740">Anatol Ulrich</span> <a href="#narrow/stream/131828-t-compiler/topic/The.20state.20of.20proc.20macros/near/261091883">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span>, tangentially (performance related) - have you seen <a href="https://github.com/dtolnay/watt">watt</a>?<br>
</p>
</blockquote>
</blockquote>
<p><code>watt</code> is a mere proof of concept using the public API, IMO the correct course of action would be to pass the RPC communication into a wasm VM, but interest in a real implementation died down after the proof of concept, instead of accelerating</p>



<a name="261153839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153839">(Nov 11 2021 at 16:19)</a>:</h4>
<p>real tragedy but developer bandwidth is limited :(</p>



<a name="261153867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153867">(Nov 11 2021 at 16:19)</a>:</h4>
<p>fwiw, Racket provides a fairly strong guarantee known as the “separate compilation guarantee” that makes it impossible for macros to produce different results when modules are compiled together versus compiled separately, and that really does work in practice</p>



<a name="261153870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153870">(Nov 11 2021 at 16:19)</a>:</h4>
<p>so it's the dime-a-dozen tragedy</p>



<a name="261153959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153959">(Nov 11 2021 at 16:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261153867">said</a>:</p>
<blockquote>
<p>fwiw, Racket provides a fairly strong guarantee known as the “separate compilation guarantee” that makes it impossible for macros to produce different results when modules are compiled together versus compiled separately, and that really does work in practice</p>
</blockquote>
<p>that's a weird-at-a-glance property, I don't fully understand why that's useful or how</p>



<a name="261153991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153991">(Nov 11 2021 at 16:20)</a>:</h4>
<p>it’s related to incrementalization in the sense that separate compilation is a weaker form of incrementalization</p>



<a name="261153994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261153994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261153994">(Nov 11 2021 at 16:20)</a>:</h4>
<p>it sounds sort of similar to orphan rules ("crates that compile separately compile together")</p>



<a name="261154008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154008">(Nov 11 2021 at 16:20)</a>:</h4>
<p>the Salsa approach is more like a build system's dependency DAG, except instead of commands, each step is some function in the compiler</p>



<a name="261154017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154017">(Nov 11 2021 at 16:20)</a>:</h4>
<p>right, I know</p>



<a name="261154066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154066">(Nov 11 2021 at 16:21)</a>:</h4>
<p>I’m just saying you could theoretically adapt that model to extend dependency tracking to macros in an incrementalized system</p>



<a name="261154071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154071">(Nov 11 2021 at 16:21)</a>:</h4>
<p>but, like, the reason for wanting determinism has nothing to do with the separation</p>



<a name="261154111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154111">(Nov 11 2021 at 16:21)</a>:</h4>
<p>it's to be able to treat the functions opaquely and not need something like ILC</p>



<a name="261154180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154180">(Nov 11 2021 at 16:22)</a>:</h4>
<p>I’m saying you want to be able to write stateful proc macros, this is sometimes a useful thing to do</p>



<a name="261154216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154216">(Nov 11 2021 at 16:22)</a>:</h4>
<p>is it a more declarative replacement for "state"?</p>



<a name="261154219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154219">(Nov 11 2021 at 16:22)</a>:</h4>
<p>(ILC is <a href="https://github.com/dotnet/corert/blob/master/Documentation/botr/ilc-architecture.md">https://github.com/dotnet/corert/blob/master/Documentation/botr/ilc-architecture.md</a> ?)</p>



<a name="261154225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154225">(Nov 11 2021 at 16:22)</a>:</h4>
<p>so in that context you need the state to be able to cooperate with the dependency-tracking framework</p>



<a name="261154245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154245">(Nov 11 2021 at 16:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261154219">said</a>:</p>
<blockquote>
<p>(ILC is <a href="https://github.com/dotnet/corert/blob/master/Documentation/botr/ilc-architecture.md">https://github.com/dotnet/corert/blob/master/Documentation/botr/ilc-architecture.md</a> ?)</p>
</blockquote>
<p>no, Incremental Lambda Calculus</p>



<a name="261154265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154265">(Nov 11 2021 at 16:22)</a>:</h4>
<p>still mostly academic AFAIK</p>



<a name="261154309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154309">(Nov 11 2021 at 16:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261154225">said</a>:</p>
<blockquote>
<p>so in that context you need the state to be able to cooperate with the dependency-tracking framework</p>
</blockquote>
<p>okay but is IO impossible?</p>



<a name="261154319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154319">(Nov 11 2021 at 16:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261154216">said</a>:</p>
<blockquote>
<p>is it a more declarative replacement for "state"?</p>
</blockquote>
<p>sort of, though not exactly… the main obstacle here is, indeed, that it depends upon the compiler being able to exert some control over the way global state is managed, whereas Rust compiles global state in a more traditional fashion</p>



<a name="261154480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154480">(Nov 11 2021 at 16:24)</a>:</h4>
<p>we cannot really even instrument proc macros, they're too much like normal code. frankly they should've been some kind of interpreted <code>const fn</code> type thing all along but the proc macros we have were ready years before miri etc. etc.</p>



<a name="261154494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154494">(Nov 11 2021 at 16:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261154309">said</a>:</p>
<blockquote>
<p>okay but is IO impossible?</p>
</blockquote>
<p>no, there is a distinction between “internal” state and “external” state; if you write macros that do I/O and modify external state you are just hosed, and the general perspective is just “don’t do that”… obviously in a Haskell-like system you could actually enforce this, but without that it’s not really possible</p>



<a name="261154557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154557">(Nov 11 2021 at 16:25)</a>:</h4>
<p>yeah, <code>const fn</code> is a notion of purity tracking</p>



<a name="261154607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154607">(Nov 11 2021 at 16:25)</a>:</h4>
<p>okay so basically what I'm saying is we currently have <em>no choice</em> but to expect that all proc macros do IO</p>



<a name="261154665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154665">(Nov 11 2021 at 16:25)</a>:</h4>
<p>the only way to backwards-compatibly transition away from that is with an opt-in in <code>Cargo.toml</code>, and some kind of deterministic execution (wasm VM or miri)</p>



<a name="261154817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154817">(Nov 11 2021 at 16:27)</a>:</h4>
<p>well, sure, but technically all proc macros <em>can</em> do I/O in Racket as well, but this isn’t really a problem in practice because Racket makes it possible to do things people want to do with macros without doing I/O… so I guess the question is how much you care about providing a strong guarantee versus just expecting programmers to not write bad things</p>



<a name="261154828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154828">(Nov 11 2021 at 16:27)</a>:</h4>
<p>there's global state that's needed for various things to work, so one way those would work is the globals would reset for each proc macro. in wasm Web API terms, a new <code>Instance</code> would be created for every invocations</p>



<a name="261154868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154868">(Nov 11 2021 at 16:27)</a>:</h4>
<p>we have to provide a strong guarantee IMO, and it's not up for discussion</p>



<a name="261154894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154894">(Nov 11 2021 at 16:27)</a>:</h4>
<p>or IOW, you'd have to convince a lot more people than just me if you wanted something different than a strong guarantee</p>



<a name="261154897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154897">(Nov 11 2021 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261154817">said</a>:</p>
<blockquote>
<p>well, sure, but technically all proc macros <em>can</em> do I/O in Racket as well, but this isn’t really a problem in practice because Racket makes it possible to do things people want to do with macros without doing I/O… so I guess the question is how much you care about providing a strong guarantee versus just expecting programmers to not write bad things</p>
</blockquote>
<p>really please do go read up about sqlx</p>



<a name="261154911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154911">(Nov 11 2021 at 16:27)</a>:</h4>
<p>people are using it in prod and it does network io</p>



<a name="261154919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154919">(Nov 11 2021 at 16:27)</a>:</h4>
<p>it’s impossible to provide a guarantee like what you’re describing without disallowing I/O in proc macros</p>



<a name="261154933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154933">(Nov 11 2021 at 16:28)</a>:</h4>
<p>even ignoring incrementalization</p>



<a name="261154994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261154994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261154994">(Nov 11 2021 at 16:28)</a>:</h4>
<p>because any proc macro that does I/O can just return different code on two successive from-scratch compilations</p>



<a name="261155005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155005">(Nov 11 2021 at 16:28)</a>:</h4>
<p>that's precisely what I (and other people) want: an opt-in in <code>Cargo.toml</code> that results in full determinism</p>



<a name="261155025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155025">(Nov 11 2021 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261154911">said</a>:</p>
<blockquote>
<p>people are using it in prod and it does network io</p>
</blockquote>
<p>and it's for a <em>reason</em>, because it provides guarantees that you can't get without actually talking to a live database</p>



<a name="261155028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155028">(Nov 11 2021 at 16:28)</a>:</h4>
<p>similar to <code>const fn</code> but it can be more relaxed thanks to e.g. wasm VMs</p>



<a name="261155045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155045">(Nov 11 2021 at 16:28)</a>:</h4>
<p>how do you propose the determinism be enforced?</p>



<a name="261155060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155060">(Nov 11 2021 at 16:29)</a>:</h4>
<p>run it in a wasm VM</p>



<a name="261155236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155236">(Nov 11 2021 at 16:30)</a>:</h4>
<p>miri can also do this, and it's a more flexible solution in terms of how much we can abstract away from the code (e.g. we could treat the entire bridge as magical values not even <code>unsafe</code> code in the proc macro can manipulate)</p>



<a name="261155246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155246">(Nov 11 2021 at 16:30)</a>:</h4>
<p>it's just that miri would be even slower</p>



<a name="261155302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155302">(Nov 11 2021 at 16:30)</a>:</h4>
<p>okay, I think I understand your perspective now, yeah</p>



<a name="261155384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155384">(Nov 11 2021 at 16:31)</a>:</h4>
<p>(miri is the basis for the determinism guarantee that is one of the pillars of Rust's typesystem soundness: if you can make consteval exhibit non-determinism, then inject the resulting incoherence into the typesystem via arrays or other const generics, you can break the typesystem and e.g. <code>transmute</code> in safe code)</p>



<a name="261155607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155607">(Nov 11 2021 at 16:32)</a>:</h4>
<p>I think running proc macros in a VM is still kind of a bad set of compromises, though… you could get significantly better results by implementing a more relaxed <code>const fn</code>-like thing that disallows <code>unsafe</code> code and links against different versions of I/O operations that throw</p>



<a name="261155707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155707">(Nov 11 2021 at 16:33)</a>:</h4>
<p>one thing to be wary of is that a wasm VM can in theory be less reliable than miri in the presence of float ops, so we'd have to be careful with those. the integer fragment should be fine tho</p>



<a name="261155816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155816">(Nov 11 2021 at 16:34)</a>:</h4>
<p>I just don’t understand the appeal of running everything in wasm, honestly, it seems like creating a lot of new problems for relatively little concrete gain</p>



<a name="261155931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155931">(Nov 11 2021 at 16:35)</a>:</h4>
<p>there are other ways to enforce determinism than running the entire thing in a VM</p>



<a name="261155950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155950">(Nov 11 2021 at 16:35)</a>:</h4>
<p>the <code>const fn</code> thing would be much harder to get into an usable state (and you don't get all the benefits without running it in miri), whereas wasm is a mature technology at this point</p>



<a name="261155969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155969">(Nov 11 2021 at 16:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="456123">Alexis King</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261155931">said</a>:</p>
<blockquote>
<p>there are other ways to enforce determinism than running the entire thing in a VM</p>
</blockquote>
<p>yeah but I don't <em>trust</em> them</p>



<a name="261155973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261155973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261155973">(Nov 11 2021 at 16:35)</a>:</h4>
<p>okay, sure, it could make short-term implementation costs lower</p>



<a name="261156050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156050">(Nov 11 2021 at 16:36)</a>:</h4>
<p>anyway this only makes sense with incremental: you want to do this when most of the time it lets you <em>skip</em> running the proc macro</p>



<a name="261156069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156069">(Nov 11 2021 at 16:36)</a>:</h4>
<p>running code is bad and should be avoided as much as possible :P</p>



<a name="261156149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156149">(Nov 11 2021 at 16:37)</a>:</h4>
<p>anyway, sorry for all the near-incoherent rambling - a lot of this stuff has been stewing for like over two years now, and I was taken by surprise by the ping, lol</p>



<a name="261156178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156178">(Nov 11 2021 at 16:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261155969">said</a>:</p>
<blockquote>
<p>yeah but I don't <em>trust</em> them</p>
</blockquote>
<p>I think it’s bizarre to demand such an extreme level of trust for proc macros, because what is your threat model in which people could maliciously exploit execution of proc macros but not get malicious code linked into the compiled binary</p>



<a name="261156344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156344">(Nov 11 2021 at 16:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261153186">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F/near/261152951">said</a>:</p>
<blockquote>
<p>pushing incremental recompilation into the front-end stopped before having to account for proc macros, for now</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> is working on this btw :)</p>
</blockquote>
<p>just remembered to reply to this: sorry, I meant more like "drastically slowed down" - and yeah, HIR lowering is where I'd expect the frontier to be</p>



<a name="261156379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156379">(Nov 11 2021 at 16:39)</a>:</h4>
<p>I am sympathetic to “running what we have right now in wasm is less difficult to implement than any other strategy that provides the guarantees we want”</p>



<a name="261156410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156410">(Nov 11 2021 at 16:39)</a>:</h4>
<p>But I think that would be a pretty poor long-term solution</p>



<a name="261156635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156635">(Nov 11 2021 at 16:41)</a>:</h4>
<p>it's less about security (so we can probably ignore very obscure ways to siphon non-determinism) and more about, well, stuff like this: <a href="https://github.com/rust-lang/rust/issues?q=is%3Aissue+is%3Aopen+unstable+fingerprints">https://github.com/rust-lang/rust/issues?q=is%3Aissue+is%3Aopen+unstable+fingerprints</a></p>



<a name="261156709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261156709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261156709">(Nov 11 2021 at 16:42)</a>:</h4>
<p>(if not familiar, someone else can explain it, I gotta step up, my eyes hurt from staring at this Zulip window, lol)</p>



<a name="261157016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261157016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261157016">(Nov 11 2021 at 16:45)</a>:</h4>
<p>Yes, I understand, and I agree that it’s important to make it impossible to cause that sort of problem without explicitly going out of your way to break things</p>



<a name="261157258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261157258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261157258">(Nov 11 2021 at 16:47)</a>:</h4>
<p>i.e. I don’t think you need such extreme sandboxing that you have complete confidence it will protect against malicious actors as a security measure, but I do think it’s helpful to be able to treat any way to subvert the restrictions as a bug (just not as a CVE)</p>



<a name="261165522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261165522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261165522">(Nov 11 2021 at 17:53)</a>:</h4>
<p>After thinking about this a little more, a thought: if you’re compiling to wasm, then you have to recompile all proc macros’ dependencies to wasm as well, so you’re already compiling proc macro code in a separate way from other code. I think that’s probably undesirable (as it makes compile times even worse), but if you accept it, then it’s not actually any better than just recompiling all that code to the normal arch and replacing all uses of I/O or unsafe operations with panics, right?</p>



<a name="261165636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261165636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261165636">(Nov 11 2021 at 17:54)</a>:</h4>
<p>Most dependencies used by proc macros are pretty much only used by proc macros (syn, quote, proc_macro2).</p>



<a name="261165832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261165832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261165832">(Nov 11 2021 at 17:56)</a>:</h4>
<p>Yes, that makes sense… that doesn’t in any way affect my actual question here, though. ;)</p>



<a name="261166086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261166086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261166086">(Nov 11 2021 at 17:59)</a>:</h4>
<p>Replacing all unsafe operations with panics is not really an option. Syn has multiple unsafe blocks: <a href="https://github.com/dtolnay/syn/search?q=unsafe">https://github.com/dtolnay/syn/search?q=unsafe</a></p>



<a name="261166133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261166133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261166133">(Nov 11 2021 at 17:59)</a>:</h4>
<p>(Part of the search results are false-positives for parsing unsafe blocks)</p>



<a name="261166340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261166340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261166340">(Nov 11 2021 at 18:01)</a>:</h4>
<p>Well, okay, I guess what I really mean is replacing whatever subset of operations that wasm disallows with panics. The point being simply that you can get the same determinism guarantees you get from wasm without using wasm by just doing what the wasm implementation of those things does.</p>



<a name="261166484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261166484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261166484">(Nov 11 2021 at 18:02)</a>:</h4>
<p>And it isn’t immediately clear to me why doing that when compiling to the native target would be meaningfully more difficult than doing it when compiling to wasm. But maybe there’s something subtle I don’t understand!</p>



<a name="261166724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261166724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261166724">(Nov 11 2021 at 18:04)</a>:</h4>
<p>When compiling for a native target, the entire address space is accessible, allowing trivial escape from the sandbox. With wasm all memory accesses are constrained to a "linear memory" that covers only a specified part of the entire address space. By placing this "linear memory" such that it doesn't overlap with any memory used by rustc or libc, you have done most of the work of sandboxing.</p>



<a name="261166901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261166901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261166901">(Nov 11 2021 at 18:06)</a>:</h4>
<p>Sure, but I think (correct me if I’m wrong) that <span class="user-mention silent" data-user-id="119009">eddyb</span> and I are in agreement that security isn’t the goal here, so code that goes meaningfully out of its way to do intentional/malicious sandbox escape isn’t really what we’re trying to prevent.</p>



<a name="261167084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167084">(Nov 11 2021 at 18:08)</a>:</h4>
<p>If you want to protect against accidental sandbox escape, you will have to consider that a proc macro can use a C library, which may make arbitrary calls that you can't easily interpose.</p>



<a name="261167185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167185">(Nov 11 2021 at 18:09)</a>:</h4>
<p>Right, an FFI call is exactly the sort of thing that you’d want to disallow/replace with a panic.</p>



<a name="261167307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167307">(Nov 11 2021 at 18:10)</a>:</h4>
<p>What about say a proc macro that compresses a blob? At least one of the widely used compression/decompression crates uses a C library I believe.</p>



<a name="261167400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167400">(Nov 11 2021 at 18:11)</a>:</h4>
<p>Sure, that’s a totally valid complaint about this strategy, but that wouldn’t run in wasm, either, and all I’m saying is that this strategy seems no worse than compiling everything to wasm.</p>



<a name="261167552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167552">(Nov 11 2021 at 18:12)</a>:</h4>
<p>It can. Clang supports compiling C to wasm. I am not sure if the build script of this compression crate has the necessary setup for compiling it to wasm though.</p>



<a name="261167585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167585">(Nov 11 2021 at 18:13)</a>:</h4>
<p>WASM has another benefit of crates being able to ship wasm bytecode for proc macros rather than rust code that needs to be compiled (=&gt; faster builds)</p>



<a name="261167724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261167724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261167724">(Nov 11 2021 at 18:14)</a>:</h4>
<p>Well, I mean, if all proc macros are <em>transparently</em> compiled to wasm, presumably people would not generally be manually shipping the wasm blobs themselves, by hand, and would not be able to just ship a wasm-compiled C library alongside it. But I guess I concede the point about it being theoretically possible to do so.</p>



<a name="261172228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261172228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261172228">(Nov 11 2021 at 18:59)</a>:</h4>
<p>I suppose one additional question is: how do <code>build.rs</code> scripts fit into this? Don’t they have all the same problems? Under this plan, do they get wasmized, too?</p>



<a name="261173401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173401">(Nov 11 2021 at 19:10)</a>:</h4>
<p><code>build.rs</code> is terrible horrible thing, yes, but it doesn't really impact cargo workflows all that much.</p>



<a name="261173505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173505">(Nov 11 2021 at 19:11)</a>:</h4>
<p>How does it impact them meaningfully less than proc macros do?</p>



<a name="261173672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alexis King <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173672">(Nov 11 2021 at 19:13)</a>:</h4>
<p>I guess just because they’re usually used to build separate things that aren’t in any way related to rustc’s dependency tracking?</p>



<a name="261173699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173699">(Nov 11 2021 at 19:13)</a>:</h4>
<p><code>build.rs</code> scripts' behaviour only influence a decision of whether <code>rustc</code> needs to be invoked again to build the crate or not, but within rustc and for the purposes of incremental <code>build.rs</code> is not a thing that exists at all.</p>



<a name="261173709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173709">(Nov 11 2021 at 19:13)</a>:</h4>
<p>its entirely a cargo concept.</p>



<a name="261173835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173835">(Nov 11 2021 at 19:14)</a>:</h4>
<p>The reason it is horrible and terrible is because a) it makes it hard for alternative build systems that rely on reproducibility; b) build scripts tend to do nasty stuff as downloading binaries off the internet or invoking other arbitrary executables.</p>



<a name="261173943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261173943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261173943">(Nov 11 2021 at 19:15)</a>:</h4>
<p>For that purpose I do believe that a wasm with a well thought out runtime exposed to the scripts would help, even if just slightly.</p>



<a name="261174030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261174030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261174030">(Nov 11 2021 at 19:16)</a>:</h4>
<p>But replacing typical use-cases <a href="http://build.rs">build.rs</a> are being used for could be done other ways too, more declaratively.</p>



<a name="261174529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261174529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261174529">(Nov 11 2021 at 19:20)</a>:</h4>
<p><a href="https://docs.rs/metadeps/1.1.2/metadeps/">https://docs.rs/metadeps/1.1.2/metadeps/</a> is one such example.</p>



<a name="261187003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261187003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261187003">(Nov 11 2021 at 21:35)</a>:</h4>
<p>I'm not sure if it was mentioned, but another reason for wanting out-of-process proc macros is for symbol isolation. Right now things go badly if you want a proc macro that uses its own LLVM, or even libstdc++ differences (since dist-x86_64-linux links that statically)</p>



<a name="261187129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261187129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261187129">(Nov 11 2021 at 21:36)</a>:</h4>
<p>e.g. <a href="https://github.com/rust-lang/rust/issues/76980">https://github.com/rust-lang/rust/issues/76980</a></p>



<a name="261187148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20does%20proc_macro%3A%3Abridge%20exist%3F/near/261187148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20does.20proc_macro.3A.3Abridge.20exist.3F.html#261187148">(Nov 11 2021 at 21:37)</a>:</h4>
<p>which might be mostly solved in that case, but I think the problem still looms in general</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>