<html>
<head><meta charset="utf-8"><title>Effects of `cargo build -j1` · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html">Effects of `cargo build -j1`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271201290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271201290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271201290">(Feb 08 2022 at 22:31)</a>:</h4>
<p>@lqd and I were just looking at some <code>-Ztimings</code> results, comparing some builds with <code>cargo build -j1</code> vs <code>cargo build -j8</code>. We saw one example where building the <code>syn</code> crate took 4 seconds with <code>-j8</code> but 40+ seconds with <code>-j1</code>. Does <code>-j1</code> also disable LLVM parallelism in the backend?</p>



<a name="271201298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271201298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271201298">(Feb 08 2022 at 22:32)</a>:</h4>
<p>This was on a 24-core machine, if that's relevant</p>



<a name="271202077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202077">(Feb 08 2022 at 22:39)</a>:</h4>
<p>If you're using lld you'll want to add <code>-Clink-arg=-Wl,--threads=1</code>. To eyeball what is still running in parallel you could run a <code>perf record</code> session and load it into hotspot and look at the thread view.</p>



<a name="271202239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202239">(Feb 08 2022 at 22:40)</a>:</h4>
<p>my belief is that it does indeed disable parallelism in the backend, based on <a href="https://github.com/rust-lang/rust/blob/0c292c9667f1b202a9150d58bdd2e89e3e803996/compiler/rustc_codegen_ssa/src/back/write.rs#L1069-L1203">this comment</a></p>



<a name="271202289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202289">(Feb 08 2022 at 22:40)</a>:</h4>
<p>The only parallel part of rustc is llvm, so that must be it</p>



<a name="271202372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202372">(Feb 08 2022 at 22:41)</a>:</h4>
<p>well, there's also cargo running multiple rustcs in parallel if the crate-graph allows</p>



<a name="271202373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202373">(Feb 08 2022 at 22:41)</a>:</h4>
<p>we were also trying out <code>-Zthreads</code> but it appears that is only about parallel-compiler</p>



<a name="271202506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202506">(Feb 08 2022 at 22:43)</a>:</h4>
<p>Yes, -j1 will also affect the LLVM parallelism.  It uses the job server to coordinate across all the parallel jobs.</p>



<a name="271202562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202562">(Feb 08 2022 at 22:43)</a>:</h4>
<p>(while you're here eric, we were also gushing on how great -Ztimings is <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> )</p>



<a name="271202662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202662">(Feb 08 2022 at 22:44)</a>:</h4>
<p>Thanks. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>   It will be stabilized very soon (will push the pr tonight).</p>



<a name="271202740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271202740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271202740">(Feb 08 2022 at 22:45)</a>:</h4>
<p>there's no priority for the jobserver tokens, right ? like if a codegen thread and another cargo job compete for one, either could get it ?</p>



<a name="271203403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271203403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271203403">(Feb 08 2022 at 22:51)</a>:</h4>
<p>Right, first come first serve.</p>



<a name="271203456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271203456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271203456">(Feb 08 2022 at 22:51)</a>:</h4>
<p>alright, thanks a bunch</p>



<a name="271203940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271203940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271203940">(Feb 08 2022 at 22:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60/near/271202562">said</a>:</p>
<blockquote>
<p>(while you're here eric, we were also gushing on how great -Ztimings is <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> )</p>
</blockquote>
<p>One thing I particularly like is how nice the generated HTML is. We have a bunch of <code>Ztimings</code> runs and I was able to grep for all sorts of interesting stuff because of this.</p>



<a name="271204076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271204076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271204076">(Feb 08 2022 at 22:57)</a>:</h4>
<p>It doesn't have any automatic critical path analysis. You can certainly eyeball it, but it would be cool if it could tell you for each crate not only how long it took to compile, but info about how much time its compilation caused sub-optimal parallelism. Not sure how hard that would be.</p>



<a name="271204149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271204149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271204149">(Feb 08 2022 at 22:58)</a>:</h4>
<p>I'm not exactly sure what this information would look like, I'm waving my hands a bit <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="271204161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271204161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271204161">(Feb 08 2022 at 22:58)</a>:</h4>
<p>(and maybe differentiating the proc-macro subgraphs)</p>



<a name="271210482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271210482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271210482">(Feb 08 2022 at 23:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60/near/271202740">said</a>:</p>
<blockquote>
<p>there's no priority for the jobserver tokens, right ? like if a codegen thread and another cargo job compete for one, either could get it ?</p>
</blockquote>
<p>For cargo there's weights: <a href="https://github.com/rust-lang/cargo/pull/8908">https://github.com/rust-lang/cargo/pull/8908</a></p>
<p>But</p>
<blockquote>
<p>The behavior of this implementation should match the previous implementation if all units are assigned the same cost</p>
</blockquote>



<a name="271210635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271210635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271210635">(Feb 08 2022 at 23:58)</a>:</h4>
<p>the jobserver itself can't support weights (it's just a pipe), at least with the current impl</p>



<a name="271210657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271210657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271210657">(Feb 08 2022 at 23:58)</a>:</h4>
<p>Cargo can weight different jobs when it acquires a token to start something new, but not beyond that</p>



<a name="271210705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Effects%20of%20%60cargo%20build%20-j1%60/near/271210705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Effects.20of.20.60cargo.20build.20-j1.60.html#271210705">(Feb 08 2022 at 23:59)</a>:</h4>
<p>yeah, that's what I meant. what can consume tokens follows from what gets started</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>