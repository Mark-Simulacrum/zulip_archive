<html>
<head><meta charset="utf-8"><title>LLVM+mingw-w64 Windows targets · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html">LLVM+mingw-w64 Windows targets</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267121778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267121778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267121778">(Jan 06 2022 at 22:09)</a>:</h4>
<p>Hello, I'd like to gather opinions about adding new mingw-w64 targets (alongside <code>*-pc-windows-gnu</code>) but using purely LLVM tools instead of GCC+Binutils (<a href="https://github.com/rust-lang/rust/issues/72241">#72241</a>).<br>
These targets are gaining popularity and Rust support is one of the missing pieces to make them fully viable.</p>
<p>Some of the key differences between LLVM and GNU when targeting Windows with mingw-w64 as CRT:</p>
<ul>
<li>AArch64 support, LLVM unofficially supports it longer than it supports MSVC AArch64, GNU toolset doesn't support (and probably never will)</li>
<li>LLVM libunwind and compiler-rt instead of libgcc, AFAIK their implementation differs internally and we don't want to mix two different unwind libraries</li>
<li>proper and working native TLS instead of bugged emuTLS, this causes linking errors in C++ projects trying to mix Clang with GCC</li>
<li>LLVM (and therefore LLD) uses modern short import lib format (just like MSVC) which is not supported properly by Binutils <code>ld.bfd</code></li>
<li>sanitizers and profiling working OOTB</li>
<li>UCRT instead of MSVCRT (again following MSVC), to be fair both toolchains can use either of them but GCC is often used with MSVCRT to avoid compatibility issues with existing libraries and most popular mingw-w64 + GNU toolchains</li>
<li>better interop with Rust's LLVM backend (e.g. it doesn't require this hack: <a href="https://github.com/rust-lang/rust/issues/90782">#90782</a>, already merged MSVC solution will work)</li>
<li>small things other like working weak symbols in DLLs</li>
</ul>
<p>When it comes to target triple let's look at <code>*-windows-gnu</code> target. This is very clear since GNU (GCC + Binutils) tools can be used only with MinGW or mingw-w64 CRTs.<br>
LLVM can use mingw-w64 or MSVC CRTs  so things like <code>*-windows-llvm</code> aren't good choice. Would really love some insight on how to name it.</p>
<p>Projects providing LLVM mingw-w64 toolchains:<br>
<a href="https://github.com/mstorsjo/llvm-mingw">https://github.com/mstorsjo/llvm-mingw</a> - created and maintained by trusted LLVM developer<br>
<a href="https://www.msys2.org/docs/environments/">https://www.msys2.org/docs/environments/</a> - project providing prebuilt packages with <code>pacman</code> package manager</p>



<a name="267145388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267145388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267145388">(Jan 07 2022 at 02:53)</a>:</h4>
<blockquote>
<p>Would really love some insight on how to name it.</p>
</blockquote>
<p><code>*-mingw</code> should probably be somewhere in the name?<br>
The primary dichotomy with Windows targets is <code>*-msvc</code> vs <code>*-mingw</code>, target flavors inside these groups seems much closer to each other than to the other group.</p>
<p>Not sure how all of this maps on <code>target_env</code>/<code>target_vendor</code>/<code>target_abi</code>/etc.<br>
UWP targets currently follow the <code>x86_64-uwp-windows-gnu</code> naming with <code>uwp</code> in the vendor place - is it the right thing to do? Should the llvm-mingw based targets follow it?<br>
I remember something like this was discussed somewhere last year or so, cc <span class="user-mention" data-user-id="239881">@Josh Triplett</span></p>



<a name="267145466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267145466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267145466">(Jan 07 2022 at 02:54)</a>:</h4>
<p>I'm not sure if we have any other examples of targets that differ solely based on LLVM vs GCC. We certainly have the mingw vs MSVC targets.</p>



<a name="267145474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267145474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267145474">(Jan 07 2022 at 02:55)</a>:</h4>
<p>I do think that we should avoid the use of meaningful vendor fields as much as possible.</p>



<a name="267145678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267145678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267145678">(Jan 07 2022 at 02:59)</a>:</h4>
<p>I <em>think</em> the right answer might be something like <code>-windows-gnullvm</code> and <code>-windows-msvcllvm</code>.</p>



<a name="267146004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267146004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267146004">(Jan 07 2022 at 03:03)</a>:</h4>
<p>Where <code>gnu</code> or <code>msvc</code> end up in the same place they currently do (so that existing code continues to detect the targets as expected) and the <code>llvm</code> bit perhaps ends up in <code>target_abi</code>.</p>



<a name="267178913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267178913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267178913">(Jan 07 2022 at 11:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets/near/267145388">said</a>:</p>
<blockquote>
<p>UWP targets currently follow the <code>x86_64-uwp-windows-gnu</code> naming with <code>uwp</code> in the vendor place - is it the right thing to do? Should the llvm-mingw based targets follow it?</p>
</blockquote>
<p>I think it's right and LLVM also does it but this triple is unrelated to mingw-w64+GNU (I'm not sure if GNU even allows to create UWP application), in fact it's mingw-w64+LLVM based. So it should be moved under mingw-w64+LLVM family.</p>



<a name="267179895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267179895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267179895">(Jan 07 2022 at 11:45)</a>:</h4>
<p>To wrap it up a bit: on Windows there are official CRT libraries from MS bundled with MSVC and open source unofficial MinGW and it's fork mingw-w64. Something like glibc vs musl except they are both "wrappers" to the same system libraries.<br>
Then there are ABIs: MSVC (AFAIK LLVM msvc triple is as much as possible ABI compatible with it so we don't need <code>*-msvcllvm</code>), GNU and we could say mingw-w64+LLVM (to distinguish it from MSVC/MSVC+LLVM). mingw-w64+LLVM is pretty much GNU ABI (the way values are passed around, registers use, ...) with exception for AArch64 where there was no previous GNU ABI so something closer to MSVC is used, for x86_64 AFAIK the only big differences are native TLS vs emutls and builtins+unwind libraries.</p>



<a name="267180427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/267180427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#267180427">(Jan 07 2022 at 11:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets/near/267145678">said</a>:</p>
<blockquote>
<p>I <em>think</em> the right answer might be something like <code>-windows-gnullvm</code> and <code>-windows-msvcllvm</code>.</p>
</blockquote>
<p>I have considered it but it sounds weird to me given the fact x86_64 is based on GNU ABI (but not fully compatible) and AArch64 is basically new ABI based on MSVC and AFAIK Linux AArch64.</p>



<a name="268908714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/268908714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#268908714">(Jan 21 2022 at 21:58)</a>:</h4>
<p>I'd like to move this forward, shall we discuss triple before I start working on PR?</p>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets/near/267146004">said</a>:</p>
<blockquote>
<p>Where <code>gnu</code> or <code>msvc</code> end up in the same place they currently do (so that existing code continues to detect the targets as expected) and the <code>llvm</code> bit perhaps ends up in <code>target_abi</code>.</p>
</blockquote>
<p>I searched for <code>windows-gnu</code> in cloned Rust repo and most of the time this target would do different thing than <code>windows-gnu</code>.</p>



<a name="268925082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/268925082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#268925082">(Jan 22 2022 at 01:02)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> Can you give some examples?</p>



<a name="268930484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/268930484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#268930484">(Jan 22 2022 at 02:32)</a>:</h4>
<p>This sounds like a lot of fun.</p>



<a name="268951223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/268951223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#268951223">(Jan 22 2022 at 10:46)</a>:</h4>
<p>Ordering results by GitHub Code Search preview:</p>
<ul>
<li><code>library/unwind/build.rs</code> this one might need to stay depending if we want to link static and shared unwind similarly to windows-gnu</li>
<li><code>src/bootstrap/dist.rs‎</code> I really hope we can avoid <code>rust-mingw</code> component mess here</li>
<li><code>src/bootstrap/compile.rs‎</code> same</li>
<li><code>‎compiler/rustc_codegen_llvm/src/back/archive.rs‎</code> same</li>
</ul>
<p>I avoided searching in <code>cfg</code>s which are used more often because they match env literally and IIUC env for this target would differ.</p>



<a name="268969916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/268969916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#268969916">(Jan 22 2022 at 18:06)</a>:</h4>
<p>I was suggesting that <code>target_env</code> would be the same, but <code>target_abi</code> would be different.</p>



<a name="268972605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/268972605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#268972605">(Jan 22 2022 at 19:07)</a>:</h4>
<p>Then I'm guessing probably 20%-30% of those cfg would need changing to distinguish LLVM toolchain.</p>



<a name="270063775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/270063775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#270063775">(Jan 31 2022 at 16:49)</a>:</h4>
<p>semi-related, I just saw this change proposal for Fedora to add cross-toolchains for MinGW UCRT:<br>
<a href="https://fedoraproject.org/wiki/Changes/F37MingwUCRT">https://fedoraproject.org/wiki/Changes/F37MingwUCRT</a></p>



<a name="275068138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/LLVM%2Bmingw-w64%20Windows%20targets/near/275068138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/LLVM.2Bmingw-w64.20Windows.20targets.html#275068138">(Mar 12 2022 at 01:02)</a>:</h4>
<p>Took a while but with LLVM 14 merged I built both x86_64 and AArch64 host compilers without patching LLVM and they seem to work fine with few small examples.<br>
Opened PR at: <a href="https://github.com/rust-lang/rust/pull/94872">https://github.com/rust-lang/rust/pull/94872</a></p>
<p>One thing I have no idea how to fix right now is tests ignoring. AFAIK writing <code># ignore-windows-gnu</code> will make it ignored on <code>*windows-gnu*</code> which doesn't seem ideal.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>