<html>
<head><meta charset="utf-8"><title>#58310 substsref · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html">#58310 substsref</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="158892070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/158892070" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#158892070">(Feb 19 2019 at 15:53)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> would you mind have a bors retrying?<br>
it's strange that <code>Substs</code> already imported.</p>



<a name="158892154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/158892154" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#158892154">(Feb 19 2019 at 15:54)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/58321#issuecomment-465138251" target="_blank" title="https://github.com/rust-lang/rust/pull/58321#issuecomment-465138251">https://github.com/rust-lang/rust/pull/58321#issuecomment-465138251</a></p>



<a name="159228946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159228946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159228946">(Feb 23 2019 at 13:13)</a>:</h4>
<p>@oli rebased again. may I request a "early" merging as the comment said?</p>



<a name="159267704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159267704" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159267704">(Feb 24 2019 at 08:47)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="159281946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159281946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159281946">(Feb 24 2019 at 16:28)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> just to confirm, so you mean we will have <code>type Substs = &amp;'tcx List[Kind]</code> finally?</p>



<a name="159281958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159281958" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159281958">(Feb 24 2019 at 16:29)</a>:</h4>
<p><span class="user-mention" data-user-id="116773">@csmoe</span> yes</p>



<a name="159437925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159437925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159437925">(Feb 26 2019 at 16:42)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> step 1 done.</p>



<a name="159453193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159453193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> varkor <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159453193">(Feb 26 2019 at 20:01)</a>:</h4>
<p>if this is going to interact with <a href="https://github.com/rust-lang/rust/pull/58583" target="_blank" title="https://github.com/rust-lang/rust/pull/58583">https://github.com/rust-lang/rust/pull/58583</a> much, I'd appreciate it if the next steps could be delayed until after that PR is merged, because it's going to be troublesome enough to rebase it as it is :)</p>



<a name="159471742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159471742" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159471742">(Feb 27 2019 at 00:37)</a>:</h4>
<p><span class="user-mention" data-user-id="121053">@varkor</span> okay I'll wait for you</p>



<a name="159535362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159535362" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159535362">(Feb 27 2019 at 17:39)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> this PR broke the RLS as high-five said, and she requested a PR to rls. but what's the work flow for such kind of fixes?</p>



<a name="159538460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159538460" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159538460">(Feb 27 2019 at 18:15)</a>:</h4>
<p>Well, create a PR that fixes rls, then a PR that updates the rls submodulr in the rustc repo</p>



<a name="159538494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/159538494" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#159538494">(Feb 27 2019 at 18:15)</a>:</h4>
<p>Probably needs a clippy submodule update</p>



<a name="160628527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/160628527" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#160628527">(Mar 13 2019 at 02:02)</a>:</h4>
<p><span class="user-mention" data-user-id="121053">@varkor</span> 's PR was merged, so step next.</p>



<a name="164179834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164179834" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164179834">(Apr 25 2019 at 15:20)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> need help to impl <code>ToStableHashKey</code> for <code>SubstsRef</code>, what's the <code>KeyType</code> should be?</p>



<a name="164180563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164180563" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164180563">(Apr 25 2019 at 15:28)</a>:</h4>
<p>isn't <code>SubstsRef</code> <code>&amp;'tcx List&lt;...&gt;</code>?</p>



<a name="164180589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164180589" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164180589">(Apr 25 2019 at 15:28)</a>:</h4>
<p>oh, that would require a <code>HashStable</code> impl for the <code>...</code></p>



<a name="164181000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181000">(Apr 25 2019 at 15:32)</a>:</h4>
<blockquote>
<p>isn't <code>SubstsRef</code> <code>&amp;'tcx List&lt;...&gt;</code>?</p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="n">SubstsRef</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">inner</span>: <span class="kp">&amp;</span><span class="na">&#39;tcx</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Kind</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="164181295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181295" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181295">(Apr 25 2019 at 15:35)</a>:</h4>
<p>ah heheh, Yea, so I think you can just forward to the &amp;'tcx List impl. so <code>type KeyType = &lt;&amp;'tcx List&lt;Kind&gt; as ToStableHashKey&gt;::KeyType;</code></p>



<a name="164181451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181451" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181451">(Apr 25 2019 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> and during the refactoring trip, I saw some usages of <code>&amp;[Kind]</code>, should them be replaced with <code>SubstsRef</code> too?</p>



<a name="164181498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181498">(Apr 25 2019 at 15:37)</a>:</h4>
<p>hmm... not sure, do you have a link to an example?</p>



<a name="164181674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181674" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181674">(Apr 25 2019 at 15:38)</a>:</h4>
<p><a href="/user_uploads/4715/imIl-26EMKenZ3758TJuWyKh/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/imIl-26EMKenZ3758TJuWyKh/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/4715/imIl-26EMKenZ3758TJuWyKh/pasted_image.png"></a></div>



<a name="164181834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181834" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181834">(Apr 25 2019 at 15:40)</a>:</h4>
<p>hmm... can you try modifying them and see which callers exist? It seems to me like <code>SubstsRef</code> is indeed right here, but the callers may disagree</p>



<a name="164181950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164181950" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164181950">(Apr 25 2019 at 15:41)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> yep, I tried to replace them with <code>SubstsRef</code>. but stuck by how to convert <code>[Kind]</code> to <code>List&lt;Kind&gt;</code>.</p>



<a name="164182043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182043" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182043">(Apr 25 2019 at 15:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/59312/files#r267297677" target="_blank" title="https://github.com/rust-lang/rust/pull/59312/files#r267297677">https://github.com/rust-lang/rust/pull/59312/files#r267297677</a></p>



<a name="164182048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182048" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182048">(Apr 25 2019 at 15:42)</a>:</h4>
<p>where's the <code>[Kind]</code> from? we need to find the root caller, all the forwarding calls should be the same and not convert</p>



<a name="164182082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182082" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182082">(Apr 25 2019 at 15:43)</a>:</h4>
<p>wait a moment, I'd paste a case.</p>



<a name="164182084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182084" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182084">(Apr 25 2019 at 15:43)</a>:</h4>
<p>Oh that is a caller? But we do have a <code>SubstsRef</code> here, right?</p>



<a name="164182358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182358">(Apr 25 2019 at 15:45)</a>:</h4>
<p>ah, this is happening because of the <code>Deref</code> impl on <code>SubstsRef</code></p>



<a name="164182424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182424" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182424">(Apr 25 2019 at 15:46)</a>:</h4>
<p>yea I think you can just replace <code>&amp;'tcx [Kind]</code> with <code>SubstsRef&lt;'tcx&gt;</code></p>



<a name="164182878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164182878" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164182878">(Apr 25 2019 at 15:51)</a>:</h4>
<blockquote>
<p>yea I think you can just replace <code>&amp;'tcx [Kind]</code> with <code>SubstsRef&lt;'tcx&gt;</code></p>
</blockquote>
<p>okay.<br>
(hmmm, failed to find out that case)</p>



<a name="164385442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385442" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385442">(Apr 28 2019 at 12:45)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> I was trying to convert a slice <code>substs[...]: [Kind]</code> into <code>SubstsRef</code> with <code>tcx.mk_substs()</code>, that's why tcx came in.</p>



<a name="164385456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385456" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385456">(Apr 28 2019 at 12:45)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/59312#discussion_r279187806" target="_blank" title="https://github.com/rust-lang/rust/pull/59312#discussion_r279187806">https://github.com/rust-lang/rust/pull/59312#discussion_r279187806</a></p>



<a name="164385461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385461" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385461">(Apr 28 2019 at 12:45)</a>:</h4>
<p>right, but isn't <code>SubstsRef</code> just <code>SubstsRef { sth: &amp;[Kind] }</code>?</p>



<a name="164385505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385505">(Apr 28 2019 at 12:46)</a>:</h4>
<p>the only time you need a <code>tcx</code> is if you don't start with a <code>'tcx</code> lifetime</p>



<a name="164385513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385513" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385513">(Apr 28 2019 at 12:46)</a>:</h4>
<blockquote>
<p>right, but isn't <code>SubstsRef</code> just <code>SubstsRef { sth: &amp;[Kind] }</code>?</p>
</blockquote>
<p>inner is <code>List&lt;Kind&gt;</code></p>



<a name="164385516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385516" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385516">(Apr 28 2019 at 12:46)</a>:</h4>
<p>ah</p>



<a name="164385547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385547" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385547">(Apr 28 2019 at 12:47)</a>:</h4>
<p>slightly uncool. Why do we even start with a <code>&amp;'tcx [Kind]</code>, can't that also be <code>SubstsRef&lt;'tcx&gt;</code>?</p>



<a name="164385616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385616" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385616">(Apr 28 2019 at 12:49)</a>:</h4>
<blockquote>
<p>slightly uncool. Why do we even start with a <code>&amp;'tcx [Kind]</code>, can't that also be <code>SubstsRef&lt;'tcx&gt;</code>?</p>
</blockquote>
<p>yes, but I'm not sure can <code>&amp;[Kind]</code> be optimized as the original issue planned?</p>



<a name="164385759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385759" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385759">(Apr 28 2019 at 12:53)</a>:</h4>
<p>wait I'm confused, we're trying to reduce the number of <code>&amp;[Kind]</code> and have more <code>SubstsRef</code> (which can have optimizations)</p>



<a name="164385900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385900" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385900">(Apr 28 2019 at 12:56)</a>:</h4>
<p>ok, so <a href="https://github.com/rust-lang/rust/pull/59312/files#diff-239d31f6f959d7140a4da7f011fd08afR134" target="_blank" title="https://github.com/rust-lang/rust/pull/59312/files#diff-239d31f6f959d7140a4da7f011fd08afR134">https://github.com/rust-lang/rust/pull/59312/files#diff-239d31f6f959d7140a4da7f011fd08afR134</a> starts out with a <code>SubstsRef</code>, but we then want a "subslice" of that <code>SubstsRef</code></p>



<a name="164385907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385907" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385907">(Apr 28 2019 at 12:57)</a>:</h4>
<p>the old code just subsliced it and it worked</p>



<a name="164385919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385919">(Apr 28 2019 at 12:57)</a>:</h4>
<p>now we are creating a duplicate of the subslice</p>



<a name="164385925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385925">(Apr 28 2019 at 12:57)</a>:</h4>
<p>same in <a href="https://github.com/rust-lang/rust/pull/59312/files#diff-239d31f6f959d7140a4da7f011fd08afR202" target="_blank" title="https://github.com/rust-lang/rust/pull/59312/files#diff-239d31f6f959d7140a4da7f011fd08afR202">https://github.com/rust-lang/rust/pull/59312/files#diff-239d31f6f959d7140a4da7f011fd08afR202</a></p>



<a name="164385985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385985" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385985">(Apr 28 2019 at 12:59)</a>:</h4>
<p>oh, nevermind, we have some invariants to keep up: <a href="https://github.com/rust-lang/rust/blob/517fb1b06f8b481d559285d1c3c665e143ad8156/src/librustc/ty/mod.rs#L603" target="_blank" title="https://github.com/rust-lang/rust/blob/517fb1b06f8b481d559285d1c3c665e143ad8156/src/librustc/ty/mod.rs#L603">https://github.com/rust-lang/rust/blob/517fb1b06f8b481d559285d1c3c665e143ad8156/src/librustc/ty/mod.rs#L603</a></p>



<a name="164385994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164385994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164385994">(Apr 28 2019 at 12:59)</a>:</h4>
<p><span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="164386122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164386122" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164386122">(Apr 28 2019 at 13:02)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span> we're running into a space vs perf optimization issue. Taking subslices of <code>List&lt;Subst&gt;</code> should be a O(1) operation imo and not take up any additional interning space, but at the same time we have the invariant that any <code>List&lt;Subst&gt;</code> is unique, so comparing two <code>List&lt;T&gt;</code>s is just a pointer equality check</p>



<a name="164512232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512232" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512232">(Apr 30 2019 at 05:19)</a>:</h4>
<p>if you see <code>&amp;[Kind&lt;'tcx&gt;]</code> it's intentional</p>



<a name="164512234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512234" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512234">(Apr 30 2019 at 05:19)</a>:</h4>
<p>at least most of the time</p>



<a name="164512286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512286" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512286">(Apr 30 2019 at 05:20)</a>:</h4>
<p>maybe I should've added a comment on all of the places</p>



<a name="164512290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512290" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512290">(Apr 30 2019 at 05:20)</a>:</h4>
<p>specifically, substituting and printing necessarily need to work without a full <code>Substs</code></p>



<a name="164512304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512304" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512304">(Apr 30 2019 at 05:21)</a>:</h4>
<p>substituting, because creating a <code>Substs</code> needs to be able to substitute in defaults, and printing because of all the slicing going on</p>



<a name="164512363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512363" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512363">(Apr 30 2019 at 05:22)</a>:</h4>
<p>I don't know why you might want to replace <code>[Kind]</code> with <code>Substs</code>, but you should avoid it unless necessary for something</p>



<a name="164512456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512456" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512456">(Apr 30 2019 at 05:25)</a>:</h4>
<blockquote>
<p>I don't know why you might want to replace <code>[Kind]</code> with <code>Substs</code>, but you should avoid it unless necessary for something</p>
</blockquote>
<p><code>Substs</code> derefs to <code>[Kind]</code>, so I need to write <code>&amp;substs</code> in some cases, but <span class="user-mention" data-user-id="124288">@oli</span> felt uncool about those additional <code>&amp;</code>.</p>



<a name="164512477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164512477" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164512477">(Apr 30 2019 at 05:25)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <a href="https://github.com/rust-lang/rust/pull/59312#discussion_r267297677" target="_blank" title="https://github.com/rust-lang/rust/pull/59312#discussion_r267297677">https://github.com/rust-lang/rust/pull/59312#discussion_r267297677</a></p>



<a name="164515916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164515916" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164515916">(Apr 30 2019 at 06:50)</a>:</h4>
<p>are we making <code>Subst</code> a <code>struct</code>?</p>



<a name="164515925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164515925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164515925">(Apr 30 2019 at 06:50)</a>:</h4>
<p>is that why?</p>



<a name="164515940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164515940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164515940">(Apr 30 2019 at 06:51)</a>:</h4>
<p>[Quoting…]<br>
yes <code>SubstsRref { inner: &amp;List&lt;Kind&gt; }</code></p>



<a name="164515944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164515944" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164515944">(Apr 30 2019 at 06:51)</a>:</h4>
<p>if so, is there any chance you could keep the <code>&amp;</code> on the outside of an unsized <code>struct</code>? I guess not without another type alias....</p>



<a name="164515948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164515948" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164515948">(Apr 30 2019 at 06:51)</a>:</h4>
<p>any reason why?</p>



<a name="164515999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164515999" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164515999">(Apr 30 2019 at 06:52)</a>:</h4>
<p>if this isn't about the optimization <span class="user-mention" data-user-id="126804">@Ariel Ben-Yehuda</span> proposed at the allhands, then I don't see why we're doing it</p>



<a name="164516439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164516439" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164516439">(Apr 30 2019 at 07:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116773">@csmoe</span> <span class="user-mention" data-user-id="124288">@oli</span> if you want to make it more explicit, you can use <code>&amp;substs[..]</code></p>



<a name="164516494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164516494" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164516494">(Apr 30 2019 at 07:02)</a>:</h4>
<p>and make the <code>subst</code> method take a <code>Substs</code></p>



<a name="164516505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164516505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164516505">(Apr 30 2019 at 07:02)</a>:</h4>
<p>(and have it call another method that does the actual substitution)</p>



<a name="164516511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164516511" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164516511">(Apr 30 2019 at 07:02)</a>:</h4>
<p>I assume that's where most of the <code>&amp;</code> would've come from</p>



<a name="164517250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164517250" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164517250">(Apr 30 2019 at 07:18)</a>:</h4>
<p>Question (perhaps off-topic): Why <code>SubstsRef</code> is named <code>SubstsRef</code> and not <code>Substs</code>?<br>
For interned / arena-allocated data the reference to it is the primarily used type and naming the data type itself is more rare.<br>
So it's natural to use a short name for the reference and a long name for the data type (like <code>Span</code> and <code>SpanData</code>).<br>
For substs that would be <code>Substs</code> and <code>SubstsData</code> or something.</p>



<a name="164517254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164517254" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164517254">(Apr 30 2019 at 07:18)</a>:</h4>
<p>the <code>Ref</code> thing is transitionary, I believe</p>



<a name="164517263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164517263" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164517263">(Apr 30 2019 at 07:18)</a>:</h4>
<p><span class="user-mention" data-user-id="126804">@Ariel Ben-Yehuda</span> wanted to optimize single-element substs so I think he did a name split to make refactoring easier</p>



<a name="164517283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2358310%20substsref/near/164517283" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2358310.20substsref.html#164517283">(Apr 30 2019 at 07:19)</a>:</h4>
<p>it's relatively recent and the PR might have more information</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>