<html>
<head><meta charset="utf-8"><title>why is rustc_query_impl so slow to compile? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html">why is rustc_query_impl so slow to compile?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250237387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237387">(Aug 21 2021 at 21:12)</a>:</h4>
<p>Why is <code>rustc_query_impl</code> so slow to compile? It has the longest compile time of any rustc crate; it currently takes around 2 minutes to compile on rustc-perf. But it's only around 2000 lines of Rust code (excluding blanks and comments). Is it because <code>define_queries!</code> and <code>rustc_query_append!</code> expand to a lot of code?</p>



<a name="250237410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237410">(Aug 21 2021 at 21:13)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Noah Lev</span> yes, it's running a bunch of proc macros generating a bunch of highly generic code</p>



<a name="250237418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237418">(Aug 21 2021 at 21:13)</a>:</h4>
<p>take a look at how <code>define_queries!</code> is defined in <code>rustc_macros</code></p>



<a name="250237466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237466">(Aug 21 2021 at 21:14)</a>:</h4>
<p>(this is what used to make rustc_middle so ridiculously slow to compile)</p>



<a name="250237468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237468">(Aug 21 2021 at 21:14)</a>:</h4>
<p>Isn't <code>define_queries!</code> defined in <code>rustc_query_impl</code>? Or is this a different macro with the same name?</p>



<a name="250237493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237493">(Aug 21 2021 at 21:15)</a>:</h4>
<p>oops, I mean <code>rustc_queries</code></p>



<a name="250237513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237513">(Aug 21 2021 at 21:15)</a>:</h4>
<p>I know that for benchmarks on rustc-perf you can see how long each pass took. Is there any way to do that for bootstrap crates on rustc-perf?</p>



<a name="250237561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237561">(Aug 21 2021 at 21:16)</a>:</h4>
<p>I'm curious if the macro expansion is the slow part or if it's the compilation of the expanded code (probably both, but I'm wondering to what degree).</p>



<a name="250237572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237572">(Aug 21 2021 at 21:17)</a>:</h4>
<p>I don't think so, no - it only measures the total time</p>



<a name="250237623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237623">(Aug 21 2021 at 21:18)</a>:</h4>
<p>you could measure it locally with <code>RUSTFLAGS_BOOTSTRAP=-Zself-profile</code> though</p>



<a name="250237627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237627">(Aug 21 2021 at 21:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250237623">said</a>:</p>
<blockquote>
<p>you could measure it locally with <code>RUSTFLAGS_BOOTSTRAP=-Zself-profile</code> though</p>
</blockquote>
<p>Ok, thanks. I'll do that.</p>



<a name="250237691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237691">(Aug 21 2021 at 21:20)</a>:</h4>
<p>rustc_query_impl duplicates all the code for each of the 257 queries.</p>



<a name="250237764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237764">(Aug 21 2021 at 21:22)</a>:</h4>
<p>Interesting. Is that necessary for the current architecture or could it be removed?</p>



<a name="250237921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250237921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250237921">(Aug 21 2021 at 21:26)</a>:</h4>
<p>Well... it's responsible for plumbing together all the calls to queries for incremental compilation. The current implementation is quite heavy, so any idea to make it thinner is welcome.</p>



<a name="250238624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250238624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250238624">(Aug 21 2021 at 21:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250237627">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250237623">said</a>:</p>
<blockquote>
<p>you could measure it locally with <code>RUSTFLAGS_BOOTSTRAP=-Zself-profile</code> though</p>
</blockquote>
<p>Ok, thanks. I'll do that.</p>
</blockquote>
<p>Would I want <code>-Z self-profile</code> or <code>-Z time-passes</code>?</p>



<a name="250238632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250238632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250238632">(Aug 21 2021 at 21:45)</a>:</h4>
<p>self-profile, time-passes only shows the time elapsed</p>



<a name="250238675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250238675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250238675">(Aug 21 2021 at 21:46)</a>:</h4>
<p>self-profile records it and lets you do fancy analysis after the fact</p>



<a name="250238678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250238678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250238678">(Aug 21 2021 at 21:46)</a>:</h4>
<p>(you can pass both if you want a progress indicator)</p>



<a name="250238748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250238748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250238748">(Aug 21 2021 at 21:48)</a>:</h4>
<p>You'll probably want to use the <a href="https://github.com/rust-lang/measureme#summarize"><code>summarize</code></a> tool which prints a table of useful statistics including but not limited to time elapsed</p>



<a name="250241248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241248">(Aug 21 2021 at 22:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250237561">said</a>:</p>
<blockquote>
<p>I'm curious if the macro expansion is the slow part or if it's the compilation of the expanded code (probably both, but I'm wondering to what degree).</p>
</blockquote>
<p>Ok, looks like it's entirely codegen. Macro expansion takes 300ms on rustc_query_impl.</p>



<a name="250241261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241261">(Aug 21 2021 at 22:49)</a>:</h4>
<p>Even just gathering the mono items takes 2.43s (which is actually longer than typeck's 2.17s).</p>



<a name="250241331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241331">(Aug 21 2021 at 22:50)</a>:</h4>
<p>On my machine, LTO is taking more than a minute. (I didn't even realize I had it enabled; I should probably disable it since I don't need that much in the way of optimizations.)</p>



<a name="250241360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241360">(Aug 21 2021 at 22:51)</a>:</h4>
<p>Interestingly, <code>mir_shims</code> takes 246ms, which seems like a long time to just generate shims (unless I'm misunderstanding what it does).</p>



<a name="250241413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241413">(Aug 21 2021 at 22:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250241331">said</a>:</p>
<blockquote>
<p>On my machine, LTO is taking more than a minute. (I didn't even realize I had it enabled; I should probably disable it since I don't need that much in the way of optimizations.)</p>
</blockquote>
<p>Actually, there doesn't seem to be a config.toml setting to disable that.</p>



<a name="250241439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241439">(Aug 21 2021 at 22:53)</a>:</h4>
<p>Does <code>expand_crate</code> includ the time it took for proc macros to run? I assume yes, but I wanted to check.</p>



<a name="250241503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241503">(Aug 21 2021 at 22:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250241413">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250241331">said</a>:</p>
<blockquote>
<p>On my machine, LTO is taking more than a minute. (I didn't even realize I had it enabled; I should probably disable it since I don't need that much in the way of optimizations.)</p>
</blockquote>
<p>Actually, there doesn't seem to be a config.toml setting to disable that.</p>
</blockquote>
<p>you might be able to hack it</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="c1"># Compile the compiler with a non-default ThinLTO import limit. This import</span>
<span class="c1"># limit controls the maximum size of functions imported by ThinLTO. Decreasing</span>
<span class="c1"># will make code compile faster at the expense of lower runtime performance.</span>
<span class="c1">#thin-lto-import-instr-limit = if incremental { 10 } else { LLVM default (currently 100) }</span>
</code></pre></div>



<a name="250241531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241531">(Aug 21 2021 at 22:55)</a>:</h4>
<p>(by setting the limit to 0)</p>



<a name="250241543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241543">(Aug 21 2021 at 22:56)</a>:</h4>
<p>Does <code>10</code> mean 10 ASM instructions?</p>



<a name="250241582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241582">(Aug 21 2021 at 22:56)</a>:</h4>
<p>(Or LLVM instructions?)</p>



<a name="250241591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241591">(Aug 21 2021 at 22:56)</a>:</h4>
<p>I think it's just an arbitrary unit tbh</p>



<a name="250241603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250241603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250241603">(Aug 21 2021 at 22:57)</a>:</h4>
<p>Hmm</p>



<a name="250242285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250242285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250242285">(Aug 21 2021 at 23:10)</a>:</h4>
<p>Some queries take <code>impl IntoQueryParam&lt;DefId&gt;</code>. The macro-generated call sites of <code>into_query_param</code> are marked with <code>#[inline(always)]</code>. Could adding a trampoline still help with reducing the amount of generic code, or no?</p>



<a name="250242398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250242398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250242398">(Aug 21 2021 at 23:13)</a>:</h4>
<p>oh good call - I would actually see how much churn there is from taking DefId directly and only doing that</p>



<a name="250243070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243070">(Aug 21 2021 at 23:30)</a>:</h4>
<p>I think I've tried it before and it had no effect</p>



<a name="250243076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243076">(Aug 21 2021 at 23:30)</a>:</h4>
<p>into_query_param is very trivial</p>



<a name="250243147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243147">(Aug 21 2021 at 23:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250243076">said</a>:</p>
<blockquote>
<p>into_query_param is very trivial</p>
</blockquote>
<p>right, but won't it compile the function twice if you call it with LocalDefId and DefId? not <code>into_query_param</code>, the function it's used in</p>



<a name="250243217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243217">(Aug 21 2021 at 23:34)</a>:</h4>
<p>you likely want it to be inlined anyway, since queries are quite hot; at that point you're not saving much</p>



<a name="250243474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243474">(Aug 21 2021 at 23:41)</a>:</h4>
<p>The call sites actually aren't that large (only 10 or so lines that are mostly functional calls and a conditional or two).</p>



<a name="250243475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243475">(Aug 21 2021 at 23:41)</a>:</h4>
<p>Alright, I guess I'll have to look for something else.</p>



<a name="250243482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243482">(Aug 21 2021 at 23:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F/near/250237410">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> yes, it's running a bunch of proc macros generating a bunch of highly generic code</p>
</blockquote>
<p>Which code is the highly generic code you're referring to?</p>



<a name="250243595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243595">(Aug 21 2021 at 23:44)</a>:</h4>
<p>I remember <span class="user-mention" data-user-id="248906">@cjgillot</span> telling me that some functions are super generic, I don't remember which though. Maybe <code>JobOwner::try_start</code>?</p>



<a name="250243603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243603">(Aug 21 2021 at 23:45)</a>:</h4>
<p>there are a <em>lot</em> of generics in the query system</p>



<a name="250243735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243735">(Aug 21 2021 at 23:48)</a>:</h4>
<p>Yeah, JobOwner is too generic for its sake.</p>



<a name="250243897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250243897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250243897">(Aug 21 2021 at 23:53)</a>:</h4>
<p>Ok, thanks! I'll look into that.</p>



<a name="250245145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245145">(Aug 22 2021 at 00:29)</a>:</h4>
<p>There are a lot of generics, but it seems like a decent number of them are only instantiated to one or two different types. Doesn't that mean de-genericising them wouldn't affect codegen time?</p>



<a name="250245253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245253">(Aug 22 2021 at 00:31)</a>:</h4>
<p>Why are <code>rustc_query_impl</code> and <code>rustc_query_system</code> separate crates? It seems like them being separate is the source of a lot of the generics.</p>



<a name="250245350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245350">(Aug 22 2021 at 00:33)</a>:</h4>
<p>looks like <code>rustc_middle</code> depends on query_system but not query_impl</p>



<a name="250245390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245390">(Aug 22 2021 at 00:34)</a>:</h4>
<p>and query_impl depends on rustc_middle</p>



<a name="250245442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245442">(Aug 22 2021 at 00:35)</a>:</h4>
<p>I was worried that was the case.</p>



<a name="250245529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245529">(Aug 22 2021 at 00:37)</a>:</h4>
<p>Having both crates also allows to manage the amount of code using generics instead of macros. That way, rustc_query_system has a clean (-ish) interface and rustc_query_impl instanciates everything.</p>



<a name="250245546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245546">(Aug 22 2021 at 00:37)</a>:</h4>
<p>So is there a way to de-genericise stuff without changing the architecture?</p>



<a name="250245550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245550">(Aug 22 2021 at 00:37)</a>:</h4>
<p>However, this separation of concerns is still very weak, with some convoluted back-and-forth.</p>



<a name="250245608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245608">(Aug 22 2021 at 00:38)</a>:</h4>
<p>Could <code>-Z print-mono-items</code> be useful to see what's being instantiated so much?</p>



<a name="250245736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245736">(Aug 22 2021 at 00:42)</a>:</h4>
<p>Some functions only depend on the query result type as a return type. I think we should get rid of this dependency, but I haven't found a satisfactory way to do it.</p>



<a name="250245798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245798">(Aug 22 2021 at 00:42)</a>:</h4>
<p>Hmm, what do you mean?</p>



<a name="250245806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245806">(Aug 22 2021 at 00:43)</a>:</h4>
<p>Do you have an example of a function that does that?</p>



<a name="250245910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/why%20is%20rustc_query_impl%20so%20slow%20to%20compile%3F/near/250245910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/why.20is.20rustc_query_impl.20so.20slow.20to.20compile.3F.html#250245910">(Aug 22 2021 at 00:45)</a>:</h4>
<p>try_execute_query does nothing interesting with the query result. It just passes it around for caching and to the caller.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>