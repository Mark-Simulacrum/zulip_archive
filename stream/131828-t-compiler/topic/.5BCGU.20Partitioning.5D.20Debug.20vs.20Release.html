<html>
<head><meta charset="utf-8"><title>[CGU Partitioning] Debug vs Release · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html">[CGU Partitioning] Debug vs Release</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="198453301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453301" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453301">(May 22 2020 at 15:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> brought an interesting idea, which I think makes a lot of sense:</p>
<ul>
<li>CGUs for LLVM are generated in equal ways for debug and release builds</li>
<li>Release would prefer the CGU partitioning scheme to be biased towards runtime performance.</li>
<li>Yet debug cares a lot more about compile times than release does. Like a lot <em>a lot</em>. Debug would much prefer shorter compile times if it meant a bit less of runtime performance.</li>
<li>This makes optimizing the CGU partitioning scheme for one use case not really great for the other.</li>
<li>Therefore: <strong>should we have the same scheme?</strong> Maybe we could have a runtime-perf oriented scheme for Release builds and a compile-time oriented scheme for Debug builds.</li>
</ul>
<p>Relevant meeting: <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281">https://rust-lang.zulipchat.com/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281</a></p>



<a name="198453551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453551" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453551">(May 22 2020 at 15:16)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span></p>



<a name="198453583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453583" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453583">(May 22 2020 at 15:16)</a>:</h4>
<p>It would also be nice to have a scheme for when there is no inlining support at all in the codegen backend (aka cg_clif) It could for example not copy functions marked as <code>#[inline]</code> into every cgu that uses them but instead treat them like normal functions.</p>



<a name="198453793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453793" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453793">(May 22 2020 at 15:19)</a>:</h4>
<p>Yeah, for <code>release</code> builds, we'd ideally have large but equally sized CGUs so that we don't waste idle cycles on different cores waiting for large outlier CGUs to finish compiling.</p>



<a name="198453845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453845" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453845">(May 22 2020 at 15:19)</a>:</h4>
<p>For <code>debug</code> (with incremental), we'd really want the CGUs to be as small as possible with no regard to inlining.</p>



<a name="198453848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453848" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453848">(May 22 2020 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> <br>
YAAAAS. Omg, I completely forgot to bring up the importance of having different backends. Dangit! <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span><br>
Okay, next time.</p>
<p>I think the fact that our current scheme is tailored towards LLVM is somewhat dangerous. We should avoid being too tied to LLVM.</p>
<p>(Edit: sorry got a bit off topic)</p>



<a name="198453934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453934">(May 22 2020 at 15:20)</a>:</h4>
<p>I think a scheme like the debug one would work pretty well with cg_clif</p>



<a name="198453940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198453940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198453940">(May 22 2020 at 15:20)</a>:</h4>
<p>I think it may make a lot of sense to have separate partitioning schemes per-backend, but I wouldn't hesitate to make improvements <em>today</em> even if they are llvm-only somehow</p>



<a name="198454011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454011" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454011">(May 22 2020 at 15:21)</a>:</h4>
<p>Now I'm kind of wondering how those cg_clif perf runs would look without inlining logic enabled...</p>



<a name="198454015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454015" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454015">(May 22 2020 at 15:21)</a>:</h4>
<p>Adapting it for cg_clif should be much much easier than improving it for cg_llvm, as cg_clif doesn't do any inlining, which means that you don't have to be smart about copying functions. Just don't copy them and don't merge codegen units.</p>



<a name="198454075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454075" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454075">(May 22 2020 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198453940">said</a>:</p>
<blockquote>
<p>I think it may make a lot of sense to have separate partitioning schemes per-backend, but I wouldn't hesitate to make improvements <em>today</em> even if they are llvm-only somehow</p>
</blockquote>
<p>No, I completely agree... but what I mean is... we should if possible try to not build something too complex that's llvm-based if that meant that further support for other backends would be hindered. Does that make sense?</p>



<a name="198454277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454277" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454277">(May 22 2020 at 15:24)</a>:</h4>
<p>Yeah. I think I agree in general but we should be careful not to overly generalize here since we only have two backends.</p>



<a name="198454287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454287" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454287">(May 22 2020 at 15:24)</a>:</h4>
<p>I disagree :)</p>
<p>I care much more at this point about optimizing the compiler we have today than a future compiler. I do think we should avoid undue complexity if it doesn't make sense, but if that complexity gives us wins, then we should do it.</p>



<a name="198454328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454328" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454328">(May 22 2020 at 15:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198453845">said</a>:</p>
<blockquote>
<p>For <code>debug</code> (with incremental), we'd really want the CGUs to be as small as possible with no regard to inlining.</p>
</blockquote>
<p>On that same line, should we maybe run different mir-opts based on whether or not we're in Release mode? Because if inlining is always slow to compile, maybe we could experiment and ditch other opts that make debug slower to compile as well :3</p>



<a name="198454402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454402">(May 22 2020 at 15:25)</a>:</h4>
<p>I suspect using different algorithms that tailor to specific use cases will make the overall code simpler since it is trying to juggle fewer concerns.</p>



<a name="198454432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454432" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454432">(May 22 2020 at 15:25)</a>:</h4>
<p><span class="user-mention" data-user-id="212698">@Félix Fischer</span> Most mir opts reduce the amount of generated LLVM IR enough and thus save LLVM optimization time that it outweighs the cost of optimizing.</p>



<a name="198454500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454500" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454500">(May 22 2020 at 15:26)</a>:</h4>
<p>I think right now we always run mir-opts because like <span class="user-mention" data-user-id="133247">@bjorn3</span> says, they improve the throughput of LLVM even though we're in debug</p>



<a name="198454503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454503" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454503">(May 22 2020 at 15:26)</a>:</h4>
<p>Including inlining? Although I think the mir-opt for inlining was disabled, wasn't it</p>



<a name="198454530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454530">(May 22 2020 at 15:26)</a>:</h4>
<p>MIR inlining is always disabled</p>



<a name="198454545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454545" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454545">(May 22 2020 at 15:26)</a>:</h4>
<p>Ohh, okay :)</p>



<a name="198454585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454585" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454585">(May 22 2020 at 15:26)</a>:</h4>
<p>Well "always" in that the only time it gets used is in the mir-opt tests.</p>



<a name="198454612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454612" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454612">(May 22 2020 at 15:26)</a>:</h4>
<p>In terms of normal uses of rustc, it is never run.</p>



<a name="198454629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454629" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454629">(May 22 2020 at 15:27)</a>:</h4>
<p>You have to opt-in via <code>-Zmir-opt-level=2</code></p>



<a name="198454639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454639" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454639">(May 22 2020 at 15:27)</a>:</h4>
<p>And you can't do that on a stable compiler.</p>



<a name="198454821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454821">(May 22 2020 at 15:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454287">said</a>:</p>
<blockquote>
<p>I disagree :)</p>
<p>I care much more at this point about optimizing the compiler we have today than a future compiler. I do think we should avoid undue complexity if it doesn't make sense, but if that complexity gives us wins, then we should do it.</p>
</blockquote>
<p>That's fair :)</p>
<p>I dunno, I guess I just worry about the recent LLVM compile-time regressions too much. Also their interests not being all that aligned with ours as well.</p>
<p>Like don't get me wrong, LLVM is a marvel and a gem. Compiler development was a wasteland before LLVM came along. <br>
But... I can't avoid thinking about their path forward diverging from ours in the future.</p>



<a name="198454899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454899" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454899">(May 22 2020 at 15:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454530">said</a>:</p>
<blockquote>
<p>MIR inlining is always disabled</p>
</blockquote>
<p>Do you think inlining in the MIR before partitioning - so that inlining isn't a concern at all during partitioning - could be worthwhile?</p>



<a name="198454903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454903" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454903">(May 22 2020 at 15:29)</a>:</h4>
<p>If we were in a future land where LLVM wasn't our primary backend, my opinion would definitely be different</p>



<a name="198454910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198454910" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198454910">(May 22 2020 at 15:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454629">said</a>:</p>
<blockquote>
<p>You have to opt-in via <code>-Zmir-opt-level=2</code></p>
</blockquote>
<p>Maybe we could run it in Release?</p>



<a name="198455048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455048" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455048">(May 22 2020 at 15:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454899">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454530">said</a>:</p>
<blockquote>
<p>MIR inlining is always disabled</p>
</blockquote>
<p>Do you think inlining in the MIR before partitioning - so that inlining isn't a concern at all during partitioning - could be worthwhile?</p>
</blockquote>
<p>MIR inlining happens during the <code>optimized_mir</code> query long before partitioning.</p>



<a name="198455107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455107" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455107">(May 22 2020 at 15:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="212698">Félix Fischer</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454910">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454629">said</a>:</p>
<blockquote>
<p>You have to opt-in via <code>-Zmir-opt-level=2</code></p>
</blockquote>
<p>Maybe we could run it in Release?</p>
</blockquote>
<p>I believe there are still broken optimizations at that level. At least a while ago there were.</p>



<a name="198455136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455136" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455136">(May 22 2020 at 15:31)</a>:</h4>
<p>Having some release-only MIR opts will happen at some point, I believe – currently we were lucky enough that all MIR opts improve compile times, but that is unlikely to be the case forever.</p>



<a name="198455168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455168" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455168">(May 22 2020 at 15:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198455107">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="212698">Félix Fischer</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454910">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454629">said</a>:</p>
<blockquote>
<p>You have to opt-in via <code>-Zmir-opt-level=2</code></p>
</blockquote>
<p>Maybe we could run it in Release?</p>
</blockquote>
<p>I believe there are still broken optimizations at that level. At least a while ago there were.</p>
</blockquote>
<p>Ahh, yes. I meant running the inlining :3</p>



<a name="198455236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455236" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455236">(May 22 2020 at 15:32)</a>:</h4>
<p>Currently though there's still bugs in the inliner and copy-prop passes (and possibly more), so we couldn't just turn on the full level 2 suite</p>



<a name="198455259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455259" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455259">(May 22 2020 at 15:32)</a>:</h4>
<p>nono I agree</p>



<a name="198455337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455337">(May 22 2020 at 15:33)</a>:</h4>
<p>FWIW I see y'all talking a lot about cgus and partitioning, and I know a fair bit about what we currently do and would be more than happy to answer questions or talk about it. I don't have a ton of time to implement changes but brain dumps are easier. Feel free to CC me if I can help!</p>



<a name="198455394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455394" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455394">(May 22 2020 at 15:33)</a>:</h4>
<p>(there was more discussion in <a class="stream-topic" data-stream-id="238009" href="/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bdesign.20meeting.5D.20codegen.20unit.20partitioning.20compiler-team.23281">#t-compiler/meetings &gt; [design meeting] codegen unit partitioning compiler-team#281</a> that you might not have saw)</p>



<a name="198455464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455464" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455464">(May 22 2020 at 15:34)</a>:</h4>
<p>(anyone mind if I rename this topic to use "CGU" instead of spelling it out? Its very long in the side bar at the moment and I'd like to add other topics that are also CGU releated)</p>



<a name="198455472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455472" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455472">(May 22 2020 at 15:34)</a>:</h4>
<p>I was thinking more on the line of... instead of having "levels" mean both "unstability/unsoundness" and "compile time regressions", having an enum where we had:</p>
<ul>
<li>"Unstability/Unsoundness"</li>
<li>"Compile Time Improvement for Debug"</li>
<li>"Compile Time Improvement/Runtime improvement for Release"</li>
</ul>



<a name="198455502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455502" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455502">(May 22 2020 at 15:34)</a>:</h4>
<p>Because there are sound opts in level 2</p>



<a name="198455584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455584" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455584">(May 22 2020 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198455464">said</a>:</p>
<blockquote>
<p>(anyone mind if I rename this topic to use "CGU" instead of spelling it out? Its very long in the side bar at the moment and I'd like to add other topics that are also CGU releated)</p>
</blockquote>
<p>Oh, I spelled it out so that people not familiar with it could understand what we were talking about :)</p>



<a name="198455627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455627" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455627">(May 22 2020 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116015">Alex Crichton</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198455337">said</a>:</p>
<blockquote>
<p>FWIW I see y'all talking a lot about cgus and partitioning, and I know a fair bit about what we currently do and would be more than happy to answer questions or talk about it. I don't have a ton of time to implement changes but brain dumps are easier. Feel free to CC me if I can help!</p>
</blockquote>
<p>Thanks Alex, that's super helpful!</p>



<a name="198455783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455783" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455783">(May 22 2020 at 15:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198454899">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCode.20Generation.20Unit.20Partitioning.5D.20Debug.20vs.20Release/near/198454530">said</a>:</p>
<blockquote>
<p>MIR inlining is always disabled</p>
</blockquote>
<p>Do you think inlining in the MIR before partitioning - so that inlining isn't a concern at all during partitioning - could be worthwhile?</p>
</blockquote>
<p>I think that is an interesting idea but I'm not sure it would pay off in debug mode where LLVM doesn't inline anyway. For release? Yeah, I think it would.</p>



<a name="198455819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455819" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455819">(May 22 2020 at 15:37)</a>:</h4>
<p>I've done perf runs in the past with the inliner switched on and there are performance improvements.</p>



<a name="198455879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455879">(May 22 2020 at 15:37)</a>:</h4>
<p>OH. We should definitely have this distinction then. Should I open a topic in wg-mir-opt?</p>



<a name="198455895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455895">(May 22 2020 at 15:37)</a>:</h4>
<p>Seems good, yeah!</p>



<a name="198455973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198455973" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198455973">(May 22 2020 at 15:38)</a>:</h4>
<p>Oh, you mean fully replace LLVM's inliner with the MIR inliner?</p>



<a name="198456754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198456754" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198456754">(May 22 2020 at 15:44)</a>:</h4>
<p>I just meant running it in addition to LLVM's since theirs can probably do things ours can't because of query cycles.</p>



<a name="198456823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198456823" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198456823">(May 22 2020 at 15:45)</a>:</h4>
<p>But for polymorphic functions, if we can generate better MIR that leaves them with less to do, that should be a win.</p>



<a name="198456829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198456829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198456829">(May 22 2020 at 15:45)</a>:</h4>
<p>(and also inlining post-llvm optimizations is better, e.g. because it's monomorphized "more")</p>



<a name="198457649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198457649" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198457649">(May 22 2020 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198456829">said</a>:</p>
<blockquote>
<p>(and also inlining post-llvm optimizations is better, e.g. because it's monomorphized "more")</p>
</blockquote>
<p>Wait, I don't 100% understand what you mean here. Why is it better post-llvm opts? Sorry, I'm a bit sleep deprived today.</p>



<a name="198457875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198457875" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198457875">(May 22 2020 at 15:53)</a>:</h4>
<p>For those interested in following up on the mir-opts specific conversation, here you go:<br>
<a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Debug.20vs.20Release.20opts">https://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Debug.20vs.20Release.20opts</a></p>



<a name="198458103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198458103" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198458103">(May 22 2020 at 15:54)</a>:</h4>
<p>Yeah that makes sense, but it wouldn't resolve any of the interactions with partitioning, which was mentioned above</p>



<a name="198459008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198459008" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198459008">(May 22 2020 at 16:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198458103">said</a>:</p>
<blockquote>
<p>Yeah that makes sense, but it wouldn't resolve any of the interactions with partitioning, which was mentioned above</p>
</blockquote>
<p>What were you answering to here? Sorry, I think I'm not following where the replies lie anymore &gt;.&lt;</p>



<a name="198459253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198459253" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198459253">(May 22 2020 at 16:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="212698">Félix Fischer</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198457649">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198456829">said</a>:</p>
<blockquote>
<p>(and also inlining post-llvm optimizations is better, e.g. because it's monomorphized "more")</p>
</blockquote>
<p>Wait, I don't 100% understand what you mean here. Why is it better post-llvm opts? Sorry, I'm a bit sleep deprived today.</p>
</blockquote>
<p>I mean that LLVM's inlining is better able to see, in theory, that e.g. the function being inlined has been removed entirely because it had some complicated logic that worked out to <code>return false;</code> or so</p>



<a name="198459260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198459260" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198459260">(May 22 2020 at 16:03)</a>:</h4>
<p>I was referring to the response to:</p>
<blockquote>
<p>Do you think inlining in the MIR before partitioning - so that inlining isn't a concern at all during partitioning - could be worthwhile?</p>
</blockquote>



<a name="198460377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198460377" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198460377">(May 22 2020 at 16:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198459253">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="212698">Félix Fischer</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198457649">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198456829">said</a>:</p>
<blockquote>
<p>(and also inlining post-llvm optimizations is better, e.g. because it's monomorphized "more")</p>
</blockquote>
<p>Wait, I don't 100% understand what you mean here. Why is it better post-llvm opts? Sorry, I'm a bit sleep deprived today.</p>
</blockquote>
<p>I mean that LLVM's inlining is better able to see, in theory, that e.g. the function being inlined has been removed entirely because it had some complicated logic that worked out to <code>return false;</code> or so</p>
</blockquote>
<p>Ahh! I see. But this is something that we are also able to do at MIR level. Specially with some of the recent opts, I think we are really close to this exact feature.</p>
<p>There's also two or three things I think?</p>
<ol>
<li>The fact that we have more information than LLVM does, so most of the opts that we and LLVM both have, happen faster on our side.</li>
<li>That this more or less depends on the order you apply optimizations in.</li>
<li>How prevalent is this case in real codebases? Aren't most functions not reducible to constants?</li>
</ol>
<p>Anywho. I think I owe you an illustration of where we stand here in mir-opts:</p>
<ul>
<li>A recent PR I did implemented constant propagation into function call arguments.</li>
<li>We have unstable function inlining in mir-opts, which seems to be close to completion?</li>
<li>Constant propagation and folding has progressed a lot lately. We're almost at feature completion, I think. What we lack today is control-flow aware propagation (which I plan on working during the following months), which should complete this optimization branch.</li>
<li>NRVO opts are WIP, but we're working on it.</li>
</ul>
<p>Thing is, I think with those four things you can basically have exactly the same transformation you speak of! So there. I hope I was not too rambly, but I wanted to illustrate that this kind of optimization is also approaching MIR :3</p>



<a name="198460605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198460605" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198460605">(May 22 2020 at 16:12)</a>:</h4>
<p>We're not trying to nor do I think we can with the small amount of work we've put in match LLVM's insight and ability to remove code -- that's just not really feasible with the tiny amount of resources we've dedicated so far. I do think we can do a lot (and are doing a lot) though!</p>



<a name="198460697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198460697" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198460697">(May 22 2020 at 16:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198459260">said</a>:</p>
<blockquote>
<p>I was referring to the response to:</p>
<blockquote>
<p>Do you think inlining in the MIR before partitioning - so that inlining isn't a concern at all during partitioning - could be worthwhile?</p>
</blockquote>
</blockquote>
<p>Ahh. I see ^^<br>
<span class="user-mention" data-user-id="116107">@davidtwco</span> they were answering to you there. I'm tagging you so that you don't miss it :)</p>



<a name="198460769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198460769" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198460769">(May 22 2020 at 16:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release/near/198460605">said</a>:</p>
<blockquote>
<p>We're not trying to nor do I think we can with the small amount of work we've put in match LLVM's insight and ability to remove code -- that's just not really feasible with the tiny amount of resources we've dedicated so far. I do think we can do a lot (and are doing a lot) though!</p>
</blockquote>
<p>I do agree :)</p>



<a name="198460978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198460978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198460978">(May 22 2020 at 16:15)</a>:</h4>
<p>Well, still, I think this question has kind of a murky answer... in the sense that we probably need benchmarking to see the nuances</p>



<a name="198461000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198461000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198461000">(May 22 2020 at 16:15)</a>:</h4>
<p>(<span class="user-mention" data-user-id="116122">@simulacrum</span>)</p>



<a name="198483170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198483170" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198483170">(May 22 2020 at 19:16)</a>:</h4>
<p>I would love to see the performance numbers on a prototype that only pays attention to <code>inline(always)</code>, and doesn't mind generating a large number of CGUs.</p>



<a name="198483192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198483192" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198483192">(May 22 2020 at 19:17)</a>:</h4>
<p>The preliminary prototype numbers posted earlier looked great.</p>



<a name="198483227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198483227" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198483227">(May 22 2020 at 19:17)</a>:</h4>
<p>And I definitely agree with the premise that debug should be happy to trade more runtime performance for faster compilation.</p>



<a name="198483233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BCGU%20Partitioning%5D%20Debug%20vs%20Release/near/198483233" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.5BCGU.20Partitioning.5D.20Debug.20vs.20Release.html#198483233">(May 22 2020 at 19:17)</a>:</h4>
<p>(Within reason.)</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>