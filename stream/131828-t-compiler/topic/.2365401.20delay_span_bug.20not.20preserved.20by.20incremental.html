<html>
<head><meta charset="utf-8"><title>#65401 delay_span_bug not preserved by incremental · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html">#65401 delay_span_bug not preserved by incremental</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="178099775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178099775" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178099775">(Oct 14 2019 at 12:50)</a>:</h4>
<p><span class="user-mention" data-user-id="124287">@mw</span>  ah nice; we should be able to E-easy + E-mentored the issue and it will probably be fixed very soon? :D cc <span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="178099810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178099810" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178099810">(Oct 14 2019 at 12:51)</a>:</h4>
<p>if there are no other hidden complexities, yes</p>



<a name="178099832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178099832" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178099832">(Oct 14 2019 at 12:51)</a>:</h4>
<p>let's give it a go and find out <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="178099847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178099847" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178099847">(Oct 14 2019 at 12:51)</a>:</h4>
<p>yep :)</p>



<a name="178099870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178099870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178099870">(Oct 14 2019 at 12:51)</a>:</h4>
<p>Baptism by <span aria-label="fire" class="emoji emoji-1f525" role="img" title="fire">:fire:</span>  ;)</p>



<a name="178099913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178099913" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178099913">(Oct 14 2019 at 12:52)</a>:</h4>
<p>:D</p>



<a name="178100018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178100018" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178100018">(Oct 14 2019 at 12:53)</a>:</h4>
<p><span class="user-mention" data-user-id="124287">@mw</span> I'm seeing saved incremental state from <code>echo 'fn main() {0}' | rustc -Cincremental=foo-incr -</code></p>



<a name="178100045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178100045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178100045">(Oct 14 2019 at 12:53)</a>:</h4>
<p>that's why I wrote the things I did in the issue description</p>



<a name="178100264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178100264" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178100264">(Oct 14 2019 at 12:56)</a>:</h4>
<p>is <code>delay_span_bug</code> involved in that example?</p>



<a name="178100513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178100513" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178100513">(Oct 14 2019 at 12:59)</a>:</h4>
<p>trying that out locally generates a non-finalized incr comp session dir, which should be fine</p>



<a name="178100524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178100524" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178100524">(Oct 14 2019 at 12:59)</a>:</h4>
<p>that directory should be gc-ed the next time around</p>



<a name="178208694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178208694" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> traxys <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178208694">(Oct 15 2019 at 16:14)</a>:</h4>
<p>Just to be sure on what to do on this, I need to make the last snippet from <a href="https://github.com/rust-lang/rust/issues/63154#issuecomment-541592381" target="_blank" title="https://github.com/rust-lang/rust/issues/63154#issuecomment-541592381">here</a> not ICE anymore, and the places mentionned in the issue are the places I should start by looking at ? ( rust/src/librustc_incremental/persist/fs.rs &amp;  rust/src/librustc_incremental/persist/save.rs)</p>



<a name="178228975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178228975" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> traxys <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178228975">(Oct 15 2019 at 19:52)</a>:</h4>
<p>So I changed the <code>if sess.has_errors()</code> to <code>if sess.has_errors_or_delayed_span_bugs()</code>in the <a href="http://fs.rs" target="_blank" title="http://fs.rs">fs.rs</a> and returned early in the <a href="http://save.rs" target="_blank" title="http://save.rs">save.rs</a> in the same case, and this gives the warning</p>
<div class="codehilite"><pre><span></span>warning: Error finalizing incremental compilation session directory `/home/traxys/rust/rust/ice_snip/foo-incr/snip-r3d3vtpzbif2/s-fgxkyk7had-1krhggp-working`: No such file or directory (os error 2)
</pre></div>


<p>I think it is because returning early is not what should be done. But now the compiler ICEs evrytime on the snippet, I believe this is what should happen ?</p>



<a name="178230008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2365401%20delay_span_bug%20not%20preserved%20by%20incremental/near/178230008" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> traxys <a href="https://rust-lang.github.io/zulip_archive/stream/131828-t-compiler/topic/.2365401.20delay_span_bug.20not.20preserved.20by.20incremental.html#178230008">(Oct 15 2019 at 20:05)</a>:</h4>
<p>Okay so I guess it is wanted behavior seeing the end of the finalize function to warn when the session dir was deleted</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>