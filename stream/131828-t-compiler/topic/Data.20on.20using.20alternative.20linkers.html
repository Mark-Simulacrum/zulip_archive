<html>
<head><meta charset="utf-8"><title>Data on using alternative linkers · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html">Data on using alternative linkers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252381460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252381460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252381460">(Sep 07 2021 at 22:41)</a>:</h4>
<p>I was curious if there is data about comparison of different linkers (I was looking at <code>lld</code> but also reading about <a href="https://github.com/rui314/mold">mold</a>), which "knobs" could be used to decrease linking time. I have a great stake in this because for me linking time is the main time eater when developing in Rust, I assume because I have a lot of opaque type resolution.<br>
For some context numbrs, I have a project with ~450 crates: <code>cargo +nightly -Z timings build</code> reports 100s compile + ~500s linking time. </p>
<p>I am looking forward to the next nightly cut to test pr <a href="https://github.com/rust-lang/rust/issues/87546">#87546</a> and see the difference (if any)</p>



<a name="252381930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252381930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252381930">(Sep 07 2021 at 22:46)</a>:</h4>
<p>doesn't most of the time come from lto?</p>



<a name="252381971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252381971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252381971">(Sep 07 2021 at 22:47)</a>:</h4>
<p>id be surprised if rustc included lto in the linking time, because despite the name, LTO is not done by the linker, its done by rustc/llvm on the llvm ir</p>



<a name="252411138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252411138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252411138">(Sep 08 2021 at 06:09)</a>:</h4>
<p>If you just care about the incremental compilation time of the final executable you could try linking all dependencies into a single dylib and then link against this dylib. This will save a lot of duplicate work linking the dependencies again each time.</p>



<a name="252417696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252417696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252417696">(Sep 08 2021 at 07:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers/near/252381930">said</a>:</p>
<blockquote>
<p>doesn't most of the time come from lto?</p>
</blockquote>
<p>not sure if relevant, for <code>[profile.dev]</code> of Cargo.toml I have <code>codegen-units=16</code> and <code>lto=false</code>, so link-time optimizations should be off (if I understand correctly the flag meaning)</p>



<a name="252418019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252418019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252418019">(Sep 08 2021 at 07:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers/near/252411138">said</a>:</p>
<blockquote>
<p>If you just care about the incremental compilation time of the final executable you could try linking all dependencies into a single dylib and then link against this dylib. </p>
</blockquote>
<p>yes, I'm looking into getting the shortest build time possible when iterating on the codebase (release builds can be as slow and optimized as possible).</p>
<p>Dynamic linking of dependencies is sometyhing I could try. Are there specific settings you'd suggest? For example <a href="https://doc.rust-lang.org/stable/rustc/codegen-options/#prefer-dynamic">prefer-dynamic</a>?</p>



<a name="252422642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252422642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252422642">(Sep 08 2021 at 08:14)</a>:</h4>
<p>Prefer-dynamic only helps when there are already dylibs to link against. In your case probably only libstd is a dylib. I would try creating a new crate with dylib as crate type  adding all dependencies of your main executable and <code>use dep_name;</code> in the source of this crate to ensure that it actually links the deps. Then depend on this crate from the main executable and add a <code>use my_dylib;</code> to the main executable source.</p>



<a name="252428180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252428180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252428180">(Sep 08 2021 at 09:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="250987">apiraino</span> <a href="#narrow/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers/near/252417696">said</a>:</p>
<blockquote>
<p><code>lto=false</code>, so link-time optimizations should be off (if I understand correctly the flag meaning)</p>
</blockquote>
<p>No, <code>lto = false</code> means "thin local" LTO: <a href="https://github.com/rust-lang/cargo/issues/7491">https://github.com/rust-lang/cargo/issues/7491</a></p>



<a name="252430798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252430798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252430798">(Sep 08 2021 at 09:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="374396">hyd-dev</span> <a href="#narrow/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers/near/252428180">said</a>:</p>
<blockquote>
<p>No, <code>lto = false</code> means "thin local" LTO: <a href="https://github.com/rust-lang/cargo/issues/7491">https://github.com/rust-lang/cargo/issues/7491</a></p>
</blockquote>
<p>oh thanks, I was also confused by the description on <br>
<a href="https://doc.rust-lang.org/stable/rustc/codegen-options/#lto">https://doc.rust-lang.org/stable/rustc/codegen-options/#lto</a></p>



<a name="252650454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252650454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252650454">(Sep 09 2021 at 15:59)</a>:</h4>
<p>So, it turns out that the cheapest method to shave off a substantial linking time is throwing it at a Ryzen grinding machine :-)</p>



<a name="252650619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252650619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apiraino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252650619">(Sep 09 2021 at 16:00)</a>:</h4>
<p>This said, I am also playing with this new experimental linker: <a href="https://github.com/rui314/mold">https://github.com/rui314/mold</a></p>
<p>A debug build on my production code went from ~ 7'20" to ~ 4'20" (-40% !). I'll do some more tests...</p>



<a name="252657765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Data%20on%20using%20alternative%20linkers/near/252657765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Data.20on.20using.20alternative.20linkers.html#252657765">(Sep 09 2021 at 16:48)</a>:</h4>
<p><span class="user-mention" data-user-id="250987">@apiraino</span> Oooh. Last time I looked at mold, I believe it was still under a proprietary license. I'm really glad to see that they've switched over to AGPL.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>