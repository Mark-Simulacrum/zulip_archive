<html>
<head><meta charset="utf-8"><title>Bootstrapping questions · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html">Bootstrapping questions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265729401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265729401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265729401">(Dec 21 2021 at 20:14)</a>:</h4>
<p>What's the difference between <code>x.py build --stage 0 library/std</code> and <code>x.py build --stage 0 library/test</code>?</p>



<a name="265729693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265729693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265729693">(Dec 21 2021 at 20:17)</a>:</h4>
<p>And how do they differ from <code>x.py build --stage 0</code>? AFAICT they're all equivalent</p>



<a name="265729754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265729754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265729754">(Dec 21 2021 at 20:18)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> I believe they are the same</p>



<a name="265729834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265729834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265729834">(Dec 21 2021 at 20:19)</a>:</h4>
<p>I swear someone in the past told me <code>library/test</code> was a more useful target than <code>library/std</code>; I have <code>library/test</code> in all my aliases.</p>



<a name="265729874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265729874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265729874">(Dec 21 2021 at 20:19)</a>:</h4>
<p>Also, given that <code>--stage 0</code> means "build with the stage 0 compiler" I would have thought <code>x.py build --stage 0</code> would build a local rustc, but it doesn't</p>



<a name="265729899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265729899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265729899">(Dec 21 2021 at 20:19)</a>:</h4>
<p>Every time I think I've got my head around how this stuff works, some new misunderstanding arises</p>



<a name="265730051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730051">(Dec 21 2021 at 20:21)</a>:</h4>
<p><code>x.py build --stage 0 library/alloc</code> and <code>x.py build -stage 0 library/proc_macro</code> are also valid, and seemingly equivalent to the ones above.</p>



<a name="265730146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730146">(Dec 21 2021 at 20:22)</a>:</h4>
<p>But <code>x.py build --stage 0 library/backtrace</code> fails with:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;main&#39; panicked at &#39;error: no rules matched library/backtrace&#39;, src/bootstrap/builder.rs:236:17
</code></pre></div>



<a name="265730573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730573">(Dec 21 2021 at 20:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265730051">said</a>:</p>
<blockquote>
<p><code>x.py build --stage 0 library/alloc</code> and <code>x.py build -stage 0 library/proc_macro</code> are also valid, and seemingly equivalent to the ones above.</p>
</blockquote>
<p>Referencing the directory of any crate that is part of the standard library causes the standard library to be built.</p>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265730146">said</a>:</p>
<blockquote>
<p>But <code>x.py build --stage 0 library/backtrace</code> fails with:</p>
<p><div class="codehilite"><pre><span></span><code>thread &#39;main&#39; panicked at &#39;error: no rules matched library/backtrace&#39;, src/bootstrap/builder.rs:236:17
</code></pre></div><br>
</p>
</blockquote>
<p><code>library/backtrace</code> isn't a standalone crate but directly included into libstd using <code>#[path = "..."] mod backtrace;</code> as libbacktrace itself depends on libstd for reading files.</p>



<a name="265730583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730583">(Dec 21 2021 at 20:27)</a>:</h4>
<p>For various reasons, <code>library/backtrace</code> isn't a real dependency.  It is embedded via a <code>#[path]</code> attribute.</p>



<a name="265730771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730771">(Dec 21 2021 at 20:28)</a>:</h4>
<p>Ok, thanks</p>



<a name="265730858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730858">(Dec 21 2021 at 20:29)</a>:</h4>
<p>The output of <code>x.py build -h</code> includes this:</p>
<div class="codehilite"><pre><span></span><code>    This subcommand accepts a number of paths to directories to the crates
    and/or artifacts to compile. For example:

        ./x.py build library/core
        ./x.py build library/core library/proc_macro
        ./x.py build library/std --stage 1

    If no arguments are passed then the complete artifacts for that stage are
    also compiled.

        ./x.py build
        ./x.py build --stage 1

    For a quick build of a usable compiler, you can pass:

        ./x.py build --stage 1 library/test

    This will first build everything once (like `--stage 0` without further
    arguments would), and then use the compiler built in stage 0 to build
    library/test and its dependencies.
    Once this is done, build/$ARCH/stage1 contains a usable compiler.
</code></pre></div>



<a name="265730959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730959">(Dec 21 2021 at 20:30)</a>:</h4>
<p>I think those first three commands are equivalent now?</p>



<a name="265730976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265730976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265730976">(Dec 21 2021 at 20:30)</a>:</h4>
<p>Also, the last command mentions <code>library/test</code></p>



<a name="265731016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731016">(Dec 21 2021 at 20:31)</a>:</h4>
<p>yeah, all of {core,proc_macro,std,test} are currently equivalent.</p>



<a name="265731046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731046">(Dec 21 2021 at 20:31)</a>:</h4>
<p>I want to improve the docs on this, because they are not great and I'm tired of not understanding this stuff</p>



<a name="265731193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731193">(Dec 21 2021 at 20:33)</a>:</h4>
<p>should be in src/bootstrap/flags.rs, happy to accept PRs :)</p>



<a name="265731219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731219">(Dec 21 2021 at 20:33)</a>:</h4>
<p>Yep, this is partly in bootstrap/, partly in the rustc-dev-guide</p>



<a name="265731316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731316">(Dec 21 2021 at 20:34)</a>:</h4>
<p>So far I only have small changes to the bootstrap output. Most notably a "Building rustbuild" label, which clears up a confusion I've had for ages</p>



<a name="265731367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731367">(Dec 21 2021 at 20:35)</a>:</h4>
<p>(Like, if you get a fresh clone and run <code>x.py clean</code> it starts building Rust code, which was always a head-scratcher to me)</p>



<a name="265731696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731696">(Dec 21 2021 at 20:38)</a>:</h4>
<p>Next question: if I run <code>./x.py build --stage 1 library/std</code>it ends with this:</p>
<div class="codehilite"><pre><span></span><code>  - Assembling stage1 compiler
  - Building stage1 std artifacts
  - Copying stage1 std from stage1
</code></pre></div>
<p>But if I run <code>./x.py build --stage 2 library/std</code> it ends with this:</p>
<div class="codehilite"><pre><span></span><code>  - Assembling stage2 compiler
  - Uplifting stage1 std
  - Copying stage2 std from stage1
</code></pre></div>
<p>It doesn't build <code>std</code> again. Does it just copy the <code>std</code> built previously -- is that what "uplifting" means?</p>



<a name="265731751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731751">(Dec 21 2021 at 20:39)</a>:</h4>
<p>yeah, uplifting is just a copy</p>



<a name="265731770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731770">(Dec 21 2021 at 20:39)</a>:</h4>
<p>It builds libstd again if you use full-bootstrap=true I believe.</p>



<a name="265731855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731855">(Dec 21 2021 at 20:40)</a>:</h4>
<p>Presumably this is just to save time, because rebuilding again is rarely going to be useful</p>



<a name="265731908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265731908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265731908">(Dec 21 2021 at 20:40)</a>:</h4>
<p>Yeah, it should be the same anyway if there aren't any bugs.</p>



<a name="265732216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265732216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265732216">(Dec 21 2021 at 20:44)</a>:</h4>
<p>So what's the full list of sensible targets(?) for <code>x.py build</code>? Definitely <code>library/std</code> and <code>compiler/rust</code>. Anything else?</p>



<a name="265732538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265732538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265732538">(Dec 21 2021 at 20:48)</a>:</h4>
<p>There are lots of targets, it all depends on what someone is doing.  There's a full list in <code>./x.py build --help -v</code> (albeit, some of those overlap with each other).</p>



<a name="265732709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265732709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265732709">(Dec 21 2021 at 20:50)</a>:</h4>
<p>Is there any way to know which ones overlap?</p>



<a name="265732892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265732892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265732892">(Dec 21 2021 at 20:52)</a>:</h4>
<p>for <code>./x.py build</code> I think the <code>library/*</code> ones are the only ones that do that.</p>



<a name="265732978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265732978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265732978">(Dec 21 2021 at 20:53)</a>:</h4>
<p>If you're curious code-wise how that happens, it is the <a href="https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L48"><code>all_krates</code></a> function.</p>



<a name="265733393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265733393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265733393">(Dec 21 2021 at 20:58)</a>:</h4>
<p>Also all compiler/* paths do the same I believe. (with the exception of rustc_codegen_cranelift and rustc_codegen_gcc)</p>



<a name="265733453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265733453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265733453">(Dec 21 2021 at 20:59)</a>:</h4>
<p>The only two available <code>compiler/*</code> paths for me are</p>
<div class="codehilite"><pre><span></span><code>    ./x.py build compiler/rustc
    ./x.py build compiler/rustc_codegen_cranelift
</code></pre></div>



<a name="265733823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265733823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265733823">(Dec 21 2021 at 21:02)</a>:</h4>
<p>for cg_gcc looks like <a href="https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L779">https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L779</a> hasn't been updated yet. cc <span class="user-mention" data-user-id="404242">@antoyo</span></p>



<a name="265733895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265733895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265733895">(Dec 21 2021 at 21:03)</a>:</h4>
<p>only compiler/rustc is used indeed: <a href="https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L1030">https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L1030</a></p>



<a name="265734185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265734185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265734185">(Dec 21 2021 at 21:06)</a>:</h4>
<p><code>./x.py check compiler/...</code> also uses the <code>all_krates</code> function so that passing any path will check the entire compiler, so that's maybe what you're thinking of.</p>
<p>I think that should probably change to just check the path you pass in.  I don't know why it does the whole compiler.</p>



<a name="265734658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265734658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265734658">(Dec 21 2021 at 21:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265733823">said</a>:</p>
<blockquote>
<p>for cg_gcc looks like <a href="https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L779">https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/compile.rs#L779</a> hasn't been updated yet. cc <span class="user-mention silent" data-user-id="404242">antoyo</span></p>
</blockquote>
<p>I believe that's on purpose. AFAIK, we did not want to enable that until it's ready, no?</p>



<a name="265738957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265738957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265738957">(Dec 21 2021 at 21:53)</a>:</h4>
<p>That isn't the dist pass, just the build pass. Also you can build it anyway by adding <code>"gcc"</code> to the <code>codegen-backends</code> array in <code>config.toml</code>.</p>



<a name="265739347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265739347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265739347">(Dec 21 2021 at 21:58)</a>:</h4>
<p>I still don't have a coherent explanation for the behaviour of the basic build command <code>./x.py build --stage N &lt;path&gt;</code>.</p>
<p>E.g. consider these three example commands, and what actions they perform:</p>
<div class="codehilite"><pre><span></span><code>./x.py build --stage 1 library/std
  Building stage0 std artifacts
  Copying stage0 std from stage0
  Building stage0 compiler artifacts
  Copying stage0 rustc from stage0
  Assembling stage1 compiler
  Building stage1 std artifacts
  Copying stage1 std from stage1

./x.py build --stage 1
  Building stage0 std artifacts
  Copying stage0 std from stage0
  Building stage0 compiler artifacts
  Copying stage0 rustc from stage0
  Assembling stage1 compiler
  Building stage1 std artifacts
  Copying stage1 std from stage1
    Building rustdoc for stage1

./x.py build --stage 1 compiler/rustc
  Building stage0 std artifacts
  Copying stage0 std from stage0
  Building stage0 compiler artifacts
  Copying stage0 rustc from stage0
  Assembling stage1 compiler
  Building stage1 std artifacts
  Copying stage1 std from stage1
    Building stage1 compiler artifacts
    Copying stage1 rustc from stage1
    Assembling stage2 compiler
</code></pre></div>



<a name="265739403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265739403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265739403">(Dec 21 2021 at 21:59)</a>:</h4>
<p>Why does adding the <code>library/std</code> path cause <em>less</em> stuff to happen than no path, but adding the <code>compiler/rustc</code> path causes <em>more</em> stuff to happen than no path?</p>



<a name="265739935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265739935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265739935">(Dec 21 2021 at 22:03)</a>:</h4>
<p>this is the list for each x.py subcommand by step -- <a href="https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/builder.rs#L372">https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/builder.rs#L372</a></p>



<a name="265740088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740088">(Dec 21 2021 at 22:05)</a>:</h4>
<p>it looks like no path ends up building rustdoc, which forces stage1 std + compiler artifacts, but doesn't need the stage2 rustc binary and sysroot assembled, so skips that setp. invoking compiler/rustc assembles that sysroot.</p>



<a name="265740130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740130">(Dec 21 2021 at 22:05)</a>:</h4>
<p>in general, there's not a lot of "principled" thought behind the differences between these options, it largely amounts to historical artifact of which steps ended up on the DEFAULT list and which didn't, as well as the relationships between them to some extent.</p>



<a name="265740295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740295">(Dec 21 2021 at 22:07)</a>:</h4>
<p>Right, I think this is a big part of why people find it so confusing, and why the docs are so hard to read and write</p>



<a name="265740395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740395">(Dec 21 2021 at 22:08)</a>:</h4>
<p>It ends up being a case of memorizing particular incantations for scenarios of interest</p>



<a name="265740417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740417">(Dec 21 2021 at 22:08)</a>:</h4>
<p>yeah, for sure</p>



<a name="265740599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740599">(Dec 21 2021 at 22:11)</a>:</h4>
<p>fwiw, I think part of it is also that the interface (at least IMO) is designed less so for "why is this building this" kind of question, but rather "what do you want to build" -- at least in theory, there's no intrinsic <em>reason</em> you need to know if you always specify a set of paths what the defaults are.</p>
<p>I've even thought about hard requiring paths on ~all commands, with some kind of --literally-everything option, potentially.</p>



<a name="265740647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265740647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265740647">(Dec 21 2021 at 22:11)</a>:</h4>
<p>(the value of the defaults is somewhat questionable, imo, given the questions they bring up and the relatively low likelihood we actually get it right when you run x.py build for a significant fraction of people)</p>



<a name="265741263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265741263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265741263">(Dec 21 2021 at 22:16)</a>:</h4>
<p>Requiring paths seems reasonable to me, could potentially have an "all" path</p>



<a name="265741306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265741306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265741306">(Dec 21 2021 at 22:17)</a>:</h4>
<p>"What do I want to build?" seems the key question</p>



<a name="265741348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265741348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265741348">(Dec 21 2021 at 22:17)</a>:</h4>
<p>The answer "everything (or something approximating that) within stage N" doesn't seem that useful, especially when the meaning of "within stage N" is non-obvious</p>



<a name="265741446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265741446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265741446">(Dec 21 2021 at 22:19)</a>:</h4>
<p>More useful answers are things like "a <code>std</code> built from local sources" (for <code>std</code> devs) or "a <code>rustc</code> built from local sources" or "a <code>rustdoc</code> built from local sources"</p>



<a name="265742035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265742035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265742035">(Dec 21 2021 at 22:27)</a>:</h4>
<p>I'm looking at the <code>Step</code> type now, wow, every command+path combination is its own unique snowflake</p>



<a name="265742074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265742074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265742074">(Dec 21 2021 at 22:28)</a>:</h4>
<blockquote>
<p>The answer "everything (or something approximating that) within stage N" doesn't seem that useful</p>
</blockquote>
<p>Except <code>./x.py build</code> to get something one can rustup link.</p>



<a name="265742350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265742350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265742350">(Dec 21 2021 at 22:30)</a>:</h4>
<p>but even that is pretty vague -- I guess we can limit it to <em>just</em> std by default in theory, but even that seems a little presumptive to some extent.</p>



<a name="265743050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265743050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265743050">(Dec 21 2021 at 22:38)</a>:</h4>
<p>Oh, so paths are not necessarily related to actual file system paths, they're just magic strings within <code>bootstrap</code> that <em>usually</em> correspond to file system paths?</p>



<a name="265743357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265743357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265743357">(Dec 21 2021 at 22:42)</a>:</h4>
<p>"I want to build a stage 1 compiler" --&gt; "oh, you need to run <code>x.py build --stage 1 library/std</code>" --&gt; "what?"</p>



<a name="265743650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265743650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265743650">(Dec 21 2021 at 22:45)</a>:</h4>
<p>yeah, that's right</p>



<a name="265743718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265743718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265743718">(Dec 21 2021 at 22:46)</a>:</h4>
<p>(though the <em>idea</em> is that the correspond to filesystem paths or some similar namespace, in general)</p>



<a name="265744767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265744767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265744767">(Dec 21 2021 at 22:58)</a>:</h4>
<p>And now I realize all the docs suggest running <code>x.py build --stage 1 library/std</code> but you can just write <code>x.py build --stage 1 std</code>, which I think is better</p>



<a name="265745104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265745104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265745104">(Dec 21 2021 at 23:02)</a>:</h4>
<p><code>rustc</code> is also a valid path, apparently</p>



<a name="265745111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265745111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265745111">(Dec 21 2021 at 23:02)</a>:</h4>
<p>suffixes, I think</p>



<a name="265745962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265745962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265745962">(Dec 21 2021 at 23:11)</a>:</h4>
<p>It does suffix matching? lol</p>



<a name="265746823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265746823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265746823">(Dec 21 2021 at 23:22)</a>:</h4>
<p>I can't work out where the default stage for each subcommand is specified</p>



<a name="265746920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265746920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265746920">(Dec 21 2021 at 23:23)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> <a href="https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/config.rs#L1029">https://github.com/rust-lang/rust/blob/e100ec5bc7cd768ec17d75448b29c9ab4a39272b/src/bootstrap/config.rs#L1029</a></p>



<a name="265746954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265746954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265746954">(Dec 21 2021 at 23:23)</a>:</h4>
<p>complicated, and not sure if entirely helpful, but I pretty much always use like ~two commands so likely not really representative.</p>



<a name="265821550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265821550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265821550">(Dec 22 2021 at 16:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265729834">said</a>:</p>
<blockquote>
<p>I swear someone in the past told me <code>library/test</code> was a more useful target than <code>library/std</code>; I have <code>library/test</code> in all my aliases.</p>
</blockquote>
<p>Eventually I and <span class="user-mention silent" data-user-id="116122">simulacrum</span> would like to make x.py "crate-aware" but right now it's only "step-aware", so it will build <em>all</em> crates in the standard library if you specify any of them.</p>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265729874">said</a>:</p>
<blockquote>
<p>Also, given that <code>--stage 0</code> means "build with the stage 0 compiler" I would have thought <code>x.py build --stage 0</code> would build a local rustc, but it doesn't</p>
</blockquote>
<p>It used to, but no longer does because people use <code>build --stage 1</code> most often and it would end up building the compiler twice. You can opt-in to the old behavior with <code>build --stage 0 compiler/rustc</code>. See also <a href="https://blog.rust-lang.org/inside-rust/2020/08/30/changes-to-x-py-defaults.html">https://blog.rust-lang.org/inside-rust/2020/08/30/changes-to-x-py-defaults.html</a>.</p>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265739403">said</a>:</p>
<blockquote>
<p>Why does adding the <code>library/std</code> path cause <em>less</em> stuff to happen than no path, but adding the <code>compiler/rustc</code> path causes <em>more</em> stuff to happen than no path?</p>
</blockquote>
<p>I very much wanted this to <em>not</em> be the case, but my MCP was shot down and I ran out of energy to fight over it. <a href="https://github.com/rust-lang/compiler-team/issues/351">https://github.com/rust-lang/compiler-team/issues/351</a></p>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265743357">said</a>:</p>
<blockquote>
<p>"I want to build a stage 1 compiler" --&gt; "oh, you need to run <code>x.py build --stage 1 library/std</code>" --&gt; "what?"</p>
</blockquote>
<p>Well, you <em>can</em> run <code>build --stage 0 compiler/rustc</code>, but it's not very useful - this is discussed more in <a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#stages-and-std">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#stages-and-std</a>.</p>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265746823">said</a>:</p>
<blockquote>
<p>I can't work out where the default stage for each subcommand is specified</p>
</blockquote>
<p>in the code like <span class="user-mention silent" data-user-id="116122">simulacrum</span> said, and also in the dev-guide: <a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#building-the-stages">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#building-the-stages</a></p>



<a name="265821728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265821728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265821728">(Dec 22 2021 at 16:08)</a>:</h4>
<p>cc <a href="https://github.com/rust-lang/rust/pull/77489">https://github.com/rust-lang/rust/pull/77489</a></p>



<a name="265821807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265821807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265821807">(Dec 22 2021 at 16:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265734185">said</a>:</p>
<blockquote>
<p><code>./x.py check compiler/...</code> also uses the <code>all_krates</code> function so that passing any path will check the entire compiler, so that's maybe what you're thinking of.</p>
<p>I think that should probably change to just check the path you pass in.  I don't know why it does the whole compiler.</p>
</blockquote>
<p>happy to take a PR for this!</p>



<a name="265821808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265821808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265821808">(Dec 22 2021 at 16:09)</a>:</h4>
<blockquote>
<p>Eventually I and simulacrum would like to make x.py "crate-aware" but right now it's only "step-aware", so it will build all crates in the standard library if you specify any of them.</p>
</blockquote>
<p>fwiw, I'd personally love to see crate builds get fast enough that there's not much point in being crate-aware but that's maybe an unreachable goal :)</p>



<a name="265821913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265821913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265821913">(Dec 22 2021 at 16:10)</a>:</h4>
<blockquote>
<p>fwiw, I'd personally love to see crate builds get fast enough that there's not much point in being crate-aware but that's maybe an unreachable goal :)</p>
</blockquote>
<p>I'm not sure why, though? If you only need the AST parsing, e.g. for building rustfmt, building rustc_middle will <em>always</em> take significantly longer</p>



<a name="265821924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265821924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265821924">(Dec 22 2021 at 16:10)</a>:</h4>
<p>it seems silly to force people to take the compile time hit</p>



<a name="265822970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265822970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265822970">(Dec 22 2021 at 16:20)</a>:</h4>
<p>That's a slightly different thing -- dependency edges to parts of a step.</p>
<p>But in general if e.g. you could build a full compiler in 5 seconds, then interface wise there's potentially a preference to avoid complexity and prefer fewer options over lots of small bits.</p>



<a name="265823022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265823022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265823022">(Dec 22 2021 at 16:21)</a>:</h4>
<p><span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> I would still prefer it to take 2 seconds over 5 seconds if I didn't need the full compiler</p>



<a name="265823717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265823717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265823717">(Dec 22 2021 at 16:28)</a>:</h4>
<p>cc <a href="https://github.com/rust-lang/rustc-dev-guide/issues/914">https://github.com/rust-lang/rustc-dev-guide/issues/914</a> (although it's a little out of date now that the compiler artifacts aren't built by default)</p>



<a name="265861791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265861791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265861791">(Dec 22 2021 at 22:32)</a>:</h4>
<p>I'm wondering why this is so complicated.</p>
<ul>
<li>Some of it feels inevitable: the compiler is complicated and so is the bootstrapping process. The staggered std/rustc dance is also inherently challenging.</li>
<li>Some doesn't: the fact that every subcommand+path combination (including "no path") has a separate implementation is... interesting. It means that building a mental model of how subcommands work is pretty much impossible.</li>
</ul>



<a name="265862907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265862907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265862907">(Dec 22 2021 at 22:44)</a>:</h4>
<ul>
<li>And the reason there are so many paths is that compilation is slow, so there's a lot of desire for fine-grained control over exactly what is compiled, even when there's a risk of bad builds involved (e.g. --keep-stage)</li>
</ul>



<a name="265950587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265950587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265950587">(Dec 23 2021 at 20:26)</a>:</h4>
<p>Oh wow, default stages for different subcommands can be overridden in the config.toml with <code>check-stage</code>, <code>build-stage</code>, <code>test-stage</code>, etc.</p>



<a name="265950638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265950638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265950638">(Dec 23 2021 at 20:27)</a>:</h4>
<p>And <code>x.py setup</code> will change those values depending on what profile you select! Oh my goodness. That means you can't write docs explaining what <code>x.py &lt;subcommand&gt;</code> does without reference to what you selected via <code>x.py setup</code>.</p>



<a name="265950752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265950752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265950752">(Dec 23 2021 at 20:29)</a>:</h4>
<p>I also don't like how the <code>profile</code> feature refers to other TOML files. I would prefer it if <code>x.py setup</code> just generated the appropriate settings within <code>config.toml</code>.</p>



<a name="265950894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265950894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265950894">(Dec 23 2021 at 20:31)</a>:</h4>
<p>Think about this from the docs writer's point of view. "<code>x.py build</code> does a stage 1 build. Unless you ran <code>x.py setup</code> and chose option (a), which changes the <code>build-stage</code> setting. But it doesn't change it in config.toml, it's buried in src/bootstrap/defaults/config.library.toml which your config.toml refers to via the <code>profile</code> setting."</p>



<a name="265952200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265952200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265952200">(Dec 23 2021 at 20:49)</a>:</h4>
<p>Is removing <code>[profile]</code> and just generating the appropriate options directly via <code>x.py setup</code> a possibility?</p>



<a name="265952208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265952208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265952208">(Dec 23 2021 at 20:49)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> ^^</p>



<a name="265955910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265955910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265955910">(Dec 23 2021 at 21:44)</a>:</h4>
<p>I almost always <code>--stage N</code> to x.py (except for <code>tidy</code>) because I can't remember the defaults.</p>



<a name="265958796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265958796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265958796">(Dec 23 2021 at 22:22)</a>:</h4>
<p>Me too</p>



<a name="265963285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265963285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265963285">(Dec 23 2021 at 23:41)</a>:</h4>
<p>I'm on vacation the next month or so.</p>



<a name="265963316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265963316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265963316">(Dec 23 2021 at 23:41)</a>:</h4>
<p>partly because I'm burned out thinking about bootstrapping</p>



<a name="265978003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978003">(Dec 24 2021 at 05:16)</a>:</h4>
<p>I will keep posting here, but I know it's holiday season and I'm not expecting answers from anyone in particular.</p>



<a name="265978014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978014">(Dec 24 2021 at 05:17)</a>:</h4>
<p>On that note, <a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html</a> says:</p>
<blockquote>
<p>The stage0 compiler is then used only to compile rustbuild, std, and rustc. When compiling rustc, the stage0 compiler uses the freshly compiled std.</p>
</blockquote>



<a name="265978019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978019">(Dec 24 2021 at 05:17)</a>:</h4>
<p>I'm pretty sure the second sentence is wrong, that it uses the downloaded std.</p>



<a name="265978067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978067">(Dec 24 2021 at 05:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265978019">said</a>:</p>
<blockquote>
<p>I'm pretty sure the second sentence is wrong, that it uses the downloaded std.</p>
</blockquote>
<p>No, it's correct. Rustc only builds with master libstd, that's why it doesn't need cfg(bootstrap).</p>



<a name="265978069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978069">(Dec 24 2021 at 05:18)</a>:</h4>
<p>I just tested this by changing my local std to print stuff out, and nothing was printed when the first rustc was being compiled. Stuff only started being printed out when the second new std was built.</p>



<a name="265978070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978070">(Dec 24 2021 at 05:18)</a>:</h4>
<p><a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#why-does-only-libstd-use-cfgbootstrap">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#why-does-only-libstd-use-cfgbootstrap</a></p>



<a name="265978079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978079">(Dec 24 2021 at 05:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265978069">said</a>:</p>
<blockquote>
<p>I just tested this by changing my local std to print stuff out, and nothing was printed when the first rustc was being compiled. Stuff only started being printed out when the second new std was built.</p>
</blockquote>
<p>rustc is <em>linked</em> to std</p>



<a name="265978082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978082">(Dec 24 2021 at 05:19)</a>:</h4>
<p>any changes you made to std will only be reflected at runtime</p>



<a name="265978151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978151">(Dec 24 2021 at 05:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265950752">said</a>:</p>
<blockquote>
<p>I also don't like how the <code>profile</code> feature refers to other TOML files. I would prefer it if <code>x.py setup</code> just generated the appropriate settings within <code>config.toml</code>.</p>
</blockquote>
<p>this means that changes to the "default defaults" won't be reflected, and you'd have to rerun x.py setup to see the changes</p>



<a name="265978166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978166">(Dec 24 2021 at 05:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265861791">said</a>:</p>
<blockquote>
<p>I'm wondering why this is so complicated.</p>
<ul>
<li>Some of it feels inevitable: the compiler is complicated and so is the bootstrapping process. The staggered std/rustc dance is also inherently challenging.</li>
<li>Some doesn't: the fact that every subcommand+path combination (including "no path") has a separate implementation is... interesting. It means that building a mental model of how subcommands work is pretty much impossible.</li>
</ul>
</blockquote>
<p>I'm not sure what you mean by a separate implementation? This is no different than how normal build systems work, in a makefile you'd have a separate rule for each target</p>



<a name="265978190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978190">(Dec 24 2021 at 05:21)</a>:</h4>
<p><code>x.py build path1</code> and <code>x.py  build path2</code> are different <code>Step</code>s, right? And could conceivably do completely different things</p>



<a name="265978230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978230">(Dec 24 2021 at 05:22)</a>:</h4>
<p>correct, but I'm not sure why you think that's unique to x.py</p>



<a name="265978263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978263">(Dec 24 2021 at 05:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265978069">said</a>:</p>
<blockquote>
<p>I just tested this by changing my local std to print stuff out, and nothing was printed when the first rustc was being compiled. Stuff only started being printed out when the second new std was built.</p>
</blockquote>
<p>the proper test is deleting some function rustc uses and seeing whether you get a compile error or not</p>



<a name="265978352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978352">(Dec 24 2021 at 05:25)</a>:</h4>
<p>So you think <code>x.py build path1</code> and <code>x.py build path2</code> doing completely different things is reasonable? The names chosen for <code>path1</code> and <code>path2</code> look a lot like filesystem paths, but they're actually not. Perhaps that's the problem.</p>



<a name="265978403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978403">(Dec 24 2021 at 05:26)</a>:</h4>
<p>I don't know what you mean by completely different things, and I resent the implication that bootstrap is doing unreasonable things and intentionally trying to confuse people. <code>build</code> does the minimum amount of work necessary to compile the target.</p>



<a name="265978431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978431">(Dec 24 2021 at 05:27)</a>:</h4>
<p>what do you mean by "The names chosen for path1 and path2 look a lot like filesystem paths, but they're actually not"? what would you rather the model be?</p>



<a name="265978519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978519">(Dec 24 2021 at 05:29)</a>:</h4>
<p>x.py doesn't enforce internally that target names match filesystem paths, the way <code>make</code> does, but I'm not aware of any examples where the name looks like a path and doesn't match the path on disk.</p>



<a name="265978526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978526">(Dec 24 2021 at 05:29)</a>:</h4>
<p>Probably just a label without any slashes. Like, all these paths <code>library/std</code> and <code>library/test</code> and <code>library/alloc</code> actually end up meaning the same thing, right? So just <code>std</code> seems better.</p>



<a name="265978532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978532">(Dec 24 2021 at 05:29)</a>:</h4>
<p><code>x build std</code> works already I'm pretty sure</p>



<a name="265978581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978581">(Dec 24 2021 at 05:30)</a>:</h4>
<p><code>x doc std</code> certainly does</p>



<a name="265978589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978589">(Dec 24 2021 at 05:30)</a>:</h4>
<p>From the guide:</p>
<blockquote>
<p>Note this is different from any other Rust program: stage1 rustc is built by the beta compiler, but using the master version of libstd!</p>
</blockquote>
<p>/me wonders what "master" means here</p>



<a name="265978595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978595">(Dec 24 2021 at 05:30)</a>:</h4>
<p>"in-tree"</p>



<a name="265978602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978602">(Dec 24 2021 at 05:30)</a>:</h4>
<p>thx</p>



<a name="265978607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978607">(Dec 24 2021 at 05:30)</a>:</h4>
<p>as opposed to the version distributed on the beta or nightly channel</p>



<a name="265978625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978625">(Dec 24 2021 at 05:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265978532">said</a>:</p>
<blockquote>
<p><code>x build std</code> works already I'm pretty sure</p>
</blockquote>
<p>yeah, this works already</p>



<a name="265978706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978706">(Dec 24 2021 at 05:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265978526">said</a>:</p>
<blockquote>
<p>Probably just a label without any slashes. Like, all these paths <code>library/std</code> and <code>library/test</code> and <code>library/alloc</code> actually end up meaning the same thing, right? So just <code>std</code> seems better.</p>
</blockquote>
<p>I agree this is confusing today, but breaking it is a no-go, and warning seems like overkill when it still works fine; especially since I <em>would</em> like them to just build that crate in the future</p>



<a name="265978714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978714">(Dec 24 2021 at 05:33)</a>:</h4>
<p>maybe that's what you mean, it's confusing that <code>build library/core</code> is the same as <code>build library/std</code>?</p>



<a name="265978802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978802">(Dec 24 2021 at 05:35)</a>:</h4>
<p>As a user, I thought the paths given to <code>x.py build</code> were file system paths. Because they look like file system paths, and all the common ones are file system paths. Which made me think that I could use any file system path as an argument. But then you try something like <code>x.py build library/stdarch</code> and it says "error: no rules matched library/stdarch" and then it's like, whoa, what's going on?</p>



<a name="265978856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978856">(Dec 24 2021 at 05:36)</a>:</h4>
<p>And then I learned they're just hardcoded strings in bootstrap, labels basically.</p>



<a name="265978918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978918">(Dec 24 2021 at 05:38)</a>:</h4>
<blockquote>
<p>Which made me think that I could use any file system path as an argument.</p>
</blockquote>
<p>this seems like an unreasonable expectation though? like, obviously <code>x build src/ci</code> and <code>x build README.md</code> don't make sense, and at that point it's just a question of where the cutoff happens</p>



<a name="265978922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265978922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265978922">(Dec 24 2021 at 05:38)</a>:</h4>
<p>"directories that are standalone crates" seems like a reasonable cutoff to me</p>



<a name="265979034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265979034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265979034">(Dec 24 2021 at 05:41)</a>:</h4>
<p>FWIW I would be ok with changing <code>build library/backtrace</code> to either give a warning or build the standard library, I can see how that particular case is confusing</p>



<a name="265979037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265979037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265979037">(Dec 24 2021 at 05:41)</a>:</h4>
<p>but I don't see why it means the whole model is bad</p>



<a name="265979192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265979192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265979192">(Dec 24 2021 at 05:45)</a>:</h4>
<p>Well, when a user says "I found this confusing", you can respond to that in a variety of ways.</p>



<a name="265979410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265979410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265979410">(Dec 24 2021 at 05:50)</a>:</h4>
<p>/me should have stayed on vacation</p>



<a name="265980113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/265980113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#265980113">(Dec 24 2021 at 06:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/265978079">said</a>:</p>
<blockquote>
<p>rustc is <em>linked</em> to std</p>
</blockquote>
<p>Ah, it finally clicked, thanks</p>



<a name="266000744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/266000744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#266000744">(Dec 24 2021 at 13:06)</a>:</h4>
<p>FWIW in general I think we've not fully succeeded on the "filesystem paths" mapping, but it also feels potentially more discoverable than crate names (and in particular maps well to "build these UI tests", for example).</p>
<p>It's worth noting that many of the steps are actually sharing code (at least for build), and to the extent we can unify it's generally something we should do.</p>
<p>Across subcommands, we have much less uniform treatment (particularly around stages). I think this may actually be good - for example, if you're building documentation, a local compiler build may not be necessary. One of my hopes is to continue fine tuning download llvm and download rustc options to make it more straightforward to use those, which I think will help unify things since it reduces the need for potentially bad defaults.</p>
<p>One thought I did have, which is pretty simple but maybe meaningful, is that we could add (or replace) the option for requesting things via stages and what to build with the option of requesting a particular set of outputs, and then we do our best to provide them; for example, maybe something like rustc+std would be equivalent to today's <code>--stage 1 library/std</code>.</p>
<p>It seems like a good idea regardless of that to add a line to build output of "what did we produce" roughly, e.g. pointing users at stage1/bin/rustc.</p>



<a name="266000842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/266000842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#266000842">(Dec 24 2021 at 13:08)</a>:</h4>
<p>An small advantage of using filesystem paths is that your shell autocompletes filesystem paths without having to install any completion script unlike crate names.</p>



<a name="278492829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Bootstrapping%20questions/near/278492829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Bootstrapping.20questions.html#278492829">(Apr 10 2022 at 22:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/131828-t-compiler/topic/Bootstrapping.20questions/near/266000744">said</a>:</p>
<blockquote>
<p>FWIW in general I think we've not fully succeeded on the "filesystem paths" mapping, but it also feels potentially more discoverable than crate names (and in particular maps well to "build these UI tests", for example).</p>
</blockquote>
<p>opened <a href="https://github.com/rust-lang/rust/pull/95906">https://github.com/rust-lang/rust/pull/95906</a> trying to enforce this internally a bit better</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>