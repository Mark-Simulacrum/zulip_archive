<html>
<head><meta charset="utf-8"><title>Making backtraces optional · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html">Making backtraces optional</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250068783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250068783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250068783">(Aug 20 2021 at 01:44)</a>:</h4>
<p>The backtrace crate makes up the vast majority of the file size of simple programs in release mode. When using LTO, panic=abort, and -Z build-std, an empty executable weighs 231kb after stripping. If you apply the following patch to libstd before building, the resulting executable weighs 52kb:</p>
<div class="codehilite"><pre><span></span><code>diff --git a/library/std/src/panicking.rs b/library/std/src/panicking.rs
index 7de70091bec..5cf4be6d721 100644
--- a/library/std/src/panicking.rs
+++ b/library/std/src/panicking.rs
@@ -182,11 +182,7 @@ pub fn take_hook() -&gt; Box&lt;dyn Fn(&amp;PanicInfo&lt;&#39;_&gt;) + &#39;static + Sync + Send&gt; {
 fn default_hook(info: &amp;PanicInfo&lt;&#39;_&gt;) {
     // If this is a double panic, make sure that we print a backtrace
     // for this panic. Otherwise only print it if logging is enabled.
-    let backtrace_env = if panic_count::get_count() &gt;= 2 {
-        RustBacktrace::Print(crate::backtrace_rs::PrintFmt::Full)
-    } else {
-        backtrace::rust_backtrace_env()
-    };
+    let backtrace_env = RustBacktrace::Disabled;

     // The current implementation always returns `Some`.
     let location = info.location().unwrap();
</code></pre></div>
<p>Would it be possible to make backtraces optional at compile time? I could imagine a property similar to panic=abort. E.g. backtraces=false in cargo. I assume many people would be interested in removing backtracing functionality from their binaries if it allows them to reduce the file size significantly.</p>



<a name="250069310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069310">(Aug 20 2021 at 01:55)</a>:</h4>
<p><span class="user-mention" data-user-id="353460">@James Monroe</span> I know the standard library already supports <code>panic_immediate_abort</code> if you build it from source, I can imagine this being behind a cargo feature too</p>



<a name="250069353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069353">(Aug 20 2021 at 01:56)</a>:</h4>
<p>Especially since the patch is so simple, you could basically do your patch there behind a cfg</p>



<a name="250069361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069361">(Aug 20 2021 at 01:56)</a>:</h4>
<p>This is a question for T-libs, not T-compiler, though</p>



<a name="250069397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069397">(Aug 20 2021 at 01:57)</a>:</h4>
<p>Using a cfg requires build-std. I was thinking about switching the backtrace crate without having to recompile everything. E.g. having two crates backtrace_std and backtrace_dummy, one of which is chosen at compile time. Similar to panic_unwind and panic_abort. Is this still T-libs?</p>



<a name="250069459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069459">(Aug 20 2021 at 01:58)</a>:</h4>
<p>The standard library is compiled ahead of time. You can't change what it does unless you compile it from source.</p>



<a name="250069479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069479">(Aug 20 2021 at 01:59)</a>:</h4>
<p>You're saying "compile time" to mean "when a user's crate is compiled", but the only way for this to be possible is for it to mean "when the standard library is compiled"</p>



<a name="250069567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069567">(Aug 20 2021 at 02:00)</a>:</h4>
<p>I do not see why this would be so. Why does switching the panic crate work but not switching the backtrace crate?</p>



<a name="250069573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069573">(Aug 20 2021 at 02:00)</a>:</h4>
<p>Unless you're suggested that rustup distribute many different versions of the standard library, which is a much larger can of worms</p>



<a name="250069659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069659">(Aug 20 2021 at 02:01)</a>:</h4>
<p>What do you mean by "the panic crate"? I'm pretty sure the standard library decides at runtime whether to unwind or abort</p>



<a name="250069701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069701">(Aug 20 2021 at 02:01)</a>:</h4>
<p>No, the stdlib calls an <code>extern "Rust"</code> function which is a lang item that exists once in panic_unwind and once in panic_abort.</p>



<a name="250069746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069746">(Aug 20 2021 at 02:02)</a>:</h4>
<p>Oh huh, TIL</p>



<a name="250069753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069753">(Aug 20 2021 at 02:02)</a>:</h4>
<p>I guess that could work for backtraces too</p>



<a name="250069859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069859">(Aug 20 2021 at 02:04)</a>:</h4>
<p>How does that work with panic=abort? I'm confused how this can be controlled when compiling a user crate</p>



<a name="250069881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069881">(Aug 20 2021 at 02:05)</a>:</h4>
<p>What I wrote above is not quite right. It's actually</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[rustc_std_internal_symbol]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C-unwind"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">__rust_start_panic</span><span class="p">(</span><span class="n">_payload</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">BoxMeUp</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>But basically what I said above. This function is once in panic_unwind and once in panic_abort.</p>



<a name="250069948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069948">(Aug 20 2021 at 02:06)</a>:</h4>
<p>Right sure, but don't both versions have to be compiled in for you to be able to choose between them?</p>



<a name="250069977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069977">(Aug 20 2021 at 02:07)</a>:</h4>
<p>Both versions are distributed as an rlib with the standard library I believe. I assume that rustc automatically adds one of them as a dependency when compiling.</p>



<a name="250069988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250069988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250069988">(Aug 20 2021 at 02:07)</a>:</h4>
<p>There is probably some magic going on.</p>



<a name="250072321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250072321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250072321">(Aug 20 2021 at 02:57)</a>:</h4>
<p>rlib doesn't include the dependencies, so we'll just need to decide which one to link</p>



<a name="250121220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250121220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250121220">(Aug 20 2021 at 14:01)</a>:</h4>
<p>yeah it's easy to tell the linker that one or the other is included in the linking</p>



<a name="250333476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Making%20backtraces%20optional/near/250333476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> James Monroe <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Making.20backtraces.20optional.html#250333476">(Aug 23 2021 at 10:29)</a>:</h4>
<p>What would be the steps to make this happen?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>