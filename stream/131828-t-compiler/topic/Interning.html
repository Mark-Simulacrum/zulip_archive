<html>
<head><meta charset="utf-8"><title>Interning · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html">Interning</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268773203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268773203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268773203">(Jan 20 2022 at 23:29)</a>:</h4>
<p>I find the interning code in <code>compiler/rustc_middle/src/ty/context.rs</code> quite confusing. Particularly the <code>Interned</code> type. All its impls (<code>PartialEq</code>, <code>Hash</code>, etc.) work on the inner type's contents, when it seems like they can work on just the pointer.</p>



<a name="268773385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268773385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268773385">(Jan 20 2022 at 23:31)</a>:</h4>
<p>Hashing the pointer would introduce non-determinism.</p>



<a name="268774204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268774204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268774204">(Jan 20 2022 at 23:40)</a>:</h4>
<p>But a major point of interning is to allow equality and hashing of a pointer. It's done for other interned types like <code>List&lt;T&gt;</code> and <code>TyS</code></p>



<a name="268774789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268774789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268774789">(Jan 20 2022 at 23:47)</a>:</h4>
<p>Only a HashStable impl needs to avoid hashing a pointer value</p>



<a name="268774820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268774820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268774820">(Jan 20 2022 at 23:47)</a>:</h4>
<p>It's fine for Hash to hash the address of an interned pointer</p>



<a name="268775422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268775422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268775422">(Jan 20 2022 at 23:55)</a>:</h4>
<p>Anyway, I'm totally confused by <code>Interned</code>, if someone knows what it's for</p>



<a name="268775451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268775451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268775451">(Jan 20 2022 at 23:55)</a>:</h4>
<p>(I understand interning in general, just not the specific purpose of the <code>Interned</code> type)</p>



<a name="268776310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268776310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268776310">(Jan 21 2022 at 00:04)</a>:</h4>
<p>Using interning to allow comparing pointers is fine. It is hashing I have a problem with.</p>



<a name="268776527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268776527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268776527">(Jan 21 2022 at 00:06)</a>:</h4>
<p>It introduces noise in the perf results and if someone accidentally depends on iteration order that will result in non-determinism even without incremental compilation. Normally it would just make it more sensitive to compiler and source changes, but when hashing pointers it will change every time the aslr seed changes.</p>



<a name="268787732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268787732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268787732">(Jan 21 2022 at 02:22)</a>:</h4>
<p>Aw geez, I was confused by <code>Interned</code> last month and eventually <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263952437">worked it out</a> and then forgot about that. Ok, definitely gonna rename this confusing type this time</p>



<a name="268791238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/268791238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#268791238">(Jan 21 2022 at 03:22)</a>:</h4>
<p>I just learned about the requirements on <code>Eq</code> and <code>Hash</code> for types the implement <code>Borrow</code>, interesting.</p>



<a name="269062873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/269062873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#269062873">(Jan 24 2022 at 05:55)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I appreciate the point about the non-determinism. I did some measurements and found that the pointer hashing has a sizeable effect on performance, though. I only measured <code>check full</code>runs:</p>
<div class="codehilite"><pre><span></span><code>Benchmark &amp; Profile     Scenario    % Change    Significance Factor ?
ctfe-stress-4 check     full    9.84%   49.18x
projection-caching check    full    9.75%   48.73x
wg-grammar check    full    7.34%   36.69x
deeply-nested check     full    7.22%   36.11x
regression-31157 check  full    6.78%   33.90x
repro_crate check   full    4.71%   23.57x
diesel check    full    4.60%   23.02x
clap-rs check   full    4.45%   22.26x
futures check   full    4.35%   21.76x
serde check     full    4.14%   20.68x
hyper-2 check   full    3.81%   19.03x
tokio-webpush-simple check  full    3.57%   17.83x
piston-image check  full    3.46%   17.30x
cargo check     full    3.27%   16.33x
webrender-wrench check  full    3.21%   16.05x
webrender check     full    3.19%   15.95x
ripgrep check   full    3.14%   15.69x
cranelift-codegen check     full    3.13%   15.67x
regex check     full    3.05%   15.25x
coercions check     full    3.01%   15.03x
</code></pre></div>



<a name="269062927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Interning/near/269062927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Interning.html#269062927">(Jan 24 2022 at 05:56)</a>:</h4>
<p>That's the slowdowns I got when I changed <code>TyS</code>, <code>List</code>, <code>Predicate</code>, and <code>LintId</code> to hash their contents instead of the pointer</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>