<html>
<head><meta charset="utf-8"><title>Cargo’s scheduling may have room for improvement. · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html">Cargo’s scheduling may have room for improvement.</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273243088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273243088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273243088">(Feb 25 2022 at 15:27)</a>:</h4>
<p>Hi, I just read <a href="https://nnethercote.github.io/2022/02/25/how-to-speed-up-the-rust-compiler-in-2022.html">https://nnethercote.github.io/2022/02/25/how-to-speed-up-the-rust-compiler-in-2022.html</a> witch has a comment "Cargo’s scheduling may have room for improvement".<br>
My main reaction is, Yes Yes it definitely can be improved! The other reaction, is please talk to us (the Cargo team) before putting a lot of work into a solution. We have ideas and requirements on how it can be fixed.</p>



<a name="273243695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273243695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273243695">(Feb 25 2022 at 15:33)</a>:</h4>
<p>as I'm currently looking into that: noted, thanks for the heads up :)</p>



<a name="273243738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273243738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273243738">(Feb 25 2022 at 15:33)</a>:</h4>
<p>in the meantime, is there some way I can help with <a href="https://github.com/rust-lang/cargo/pull/10388">https://github.com/rust-lang/cargo/pull/10388</a> ?</p>



<a name="273244107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273244107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273244107">(Feb 25 2022 at 15:37)</a>:</h4>
<p>It just needs reviewer time, and we have a lot of big things happening. Sorry. <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="273244230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273244230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273244230">(Feb 25 2022 at 15:38)</a>:</h4>
<p>What is your plan of attack on the scheduling front?</p>



<a name="273244464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273244464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273244464">(Feb 25 2022 at 15:40)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/pull/8908">https://github.com/rust-lang/cargo/pull/8908</a> already laid some groundwork by adding weights to the graph. the default weights are all 1, so what's missing is a way to feed in custom weights based on measurements (probably based on a -j1 build? or by measuring CPU cycles spent instead of wall-time?)</p>



<a name="273244588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273244588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273244588">(Feb 25 2022 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120179">Eh2406</span> <a href="#narrow/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E/near/273244107">said</a>:</p>
<blockquote>
<p>It just needs reviewer time, and we have a lot of big things happening. Sorry. <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
</blockquote>
<p>no worries whatsoever, focusing on the most important things first is great. this issue doesn't seem urgent anyways.</p>



<a name="273244793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273244793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273244793">(Feb 25 2022 at 15:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120179">Eh2406</span> <a href="#narrow/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E/near/273244230">said</a>:</p>
<blockquote>
<p>What is your plan of attack on the scheduling front?</p>
</blockquote>
<p>at first, I was looking into sorting the pending queue so that the dependency queue priorities can affect the already enqueued jobs; and I was manually hacking higher costs per crate à la <a href="https://github.com/rust-lang/cargo/issues/7437">https://github.com/rust-lang/cargo/issues/7437</a></p>



<a name="273245733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273245733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273245733">(Feb 25 2022 at 15:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E/near/273244464">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/cargo/pull/8908">https://github.com/rust-lang/cargo/pull/8908</a> already laid some groundwork by adding weights to the graph. the default weights are all 1, so what's missing is a way to feed in custom weights based on measurements (probably based on a -j1 build? or by measuring CPU cycles spent instead of wall-time?)</p>
</blockquote>
<p>I was looking at first at making something like this static and opt-in, so no dynamism based on measurements, because it's extremely contextual: depending on the crate, the machine and available parallelism, the type of build, its position in the schedule, etc. (and also: it's easier). -j1 disables the parallelism in the backend and that is significantly slower than a regular build</p>



<a name="273246766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273246766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273246766">(Feb 25 2022 at 16:00)</a>:</h4>
<p>So I see two big issues with that (both of which are solvable, but not as simple as they first appear):</p>
<ul>
<li>can we get real data on how different heuristics affect build time? The hard way is to implement a bunch of different heuristics, build a lot of important crates on a lot of different size machines, and analyze all the data. An alternative is to make some interactive tool for guessing the build time of a <code>-Ztimings</code> file if other heuristics or size machines had been used.</li>
<li>the other question is where do we store data from past runs to use as weights? Presumably we don't want it to be project specific, we want the system to learn that <code>syn</code> is slow and use that on the next project. But if it is shared then we will need some kind of locking to protect against multiple Cargos editing it at the same time. And it's easy for the locking to become a bottle neec.</li>
</ul>



<a name="273247242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273247242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273247242">(Feb 25 2022 at 16:04)</a>:</h4>
<p>as I've focused on the "hacky" use-case (that is, I'm not planning on looking at optimizing the schedule via past runs any time soon), I do have data for prioritizing syn/quote/proc-macro2 in the schedule, timings on 150 crates or so, if that's of interest</p>



<a name="273247763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273247763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273247763">(Feb 25 2022 at 16:08)</a>:</h4>
<p>If you build a hacky solution and use it, the data would be useful for answering my first question!</p>



<a name="273248139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248139">(Feb 25 2022 at 16:11)</a>:</h4>
<p>I do have an in-progress prototype of the idea I described above, terrible and hardcoded (and I don't believe it to be correct in the general case yet)</p>



<a name="273248228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248228">(Feb 25 2022 at 16:12)</a>:</h4>
<p>but seems to work in my limited testing</p>



<a name="273248536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248536">(Feb 25 2022 at 16:15)</a>:</h4>
<p>The data would definitely be helpful for prioritization!</p>



<a name="273248570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248570">(Feb 25 2022 at 16:15)</a>:</h4>
<p>I'll test it more, and better, and get back to you with a branch and numbers</p>



<a name="273248717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248717">(Feb 25 2022 at 16:16)</a>:</h4>
<p>just to be clear, you mean prioritization of that work/reviews/Etc, or prioritization in cargo's schedule ? :)</p>



<a name="273248817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248817">(Feb 25 2022 at 16:17)</a>:</h4>
<p>if you want data about cargo timings (without that hack) I do have that rn <a href="https://github.com/lqd/rustc-benchmarking-data/tree/main/results">https://github.com/lqd/rustc-benchmarking-data/tree/main/results</a></p>



<a name="273248911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273248911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273248911">(Feb 25 2022 at 16:17)</a>:</h4>
<p>and if you're looking for something in particular, let me know and I'll gather it</p>



<a name="273249061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273249061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273249061">(Feb 25 2022 at 16:18)</a>:</h4>
<blockquote>
<p>just to be clear, you mean prioritization of that work/reviews/Etc, or prioritization in cargo's schedule ? :)</p>
</blockquote>
<p>I meant in what things are team chooses to work on.</p>



<a name="273249274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273249274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273249274">(Feb 25 2022 at 16:20)</a>:</h4>
<p>ok, understood :)</p>
<p>(I also <a href="https://github.com/rust-lang/cargo/pull/10388#issuecomment-1049725601">have data</a> for the PR I linked above if that would matter for prioritization as well)</p>



<a name="273250985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273250985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273250985">(Feb 25 2022 at 16:34)</a>:</h4>
<p>Our opinion so far has been "we can't really get started until we have a plan for a non hacky way for learning and storing the data", but if it is a <em>big</em> improvement then maybe we consider some "hacky".</p>



<a name="273251073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273251073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273251073">(Feb 25 2022 at 16:35)</a>:</h4>
<p>ah I see</p>



<a name="273251174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273251174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273251174">(Feb 25 2022 at 16:36)</a>:</h4>
<p>I'll gather more data, but it looked promising let's say</p>



<a name="273251431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273251431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273251431">(Feb 25 2022 at 16:38)</a>:</h4>
<blockquote>
<p>maybe we consider some "hacky".</p>
</blockquote>
<p>or we write up our plan for how to store things, and get your help polishing it up for stable.</p>



<a name="273425590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Cargo%E2%80%99s%20scheduling%20may%20have%20room%20for%20improvement./near/273425590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Cargo.E2.80.99s.20scheduling.20may.20have.20room.20for.20improvement.2E.html#273425590">(Feb 27 2022 at 21:16)</a>:</h4>
<p><span class="user-mention" data-user-id="120179">@Eh2406</span> Thanks for starting this topic! @lqd is definitely the person looking at this the most, so it's good you two are talking <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>