<html>
<head><meta charset="utf-8"><title>[DRAFT] Change `Symbol::as_str()` to `&amp;self -&gt; &amp;str` #76460 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html">[DRAFT] Change `Symbol::as_str()` to `&amp;self -&gt; &amp;str` #76460</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="209693032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693032">(Sep 10 2020 at 18:58)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="209693081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693081">(Sep 10 2020 at 18:58)</a>:</h4>
<p>was going to take a look at this issue</p>



<a name="209693143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693143">(Sep 10 2020 at 18:59)</a>:</h4>
<p>I was wondering ...</p>



<a name="209693173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693173">(Sep 10 2020 at 18:59)</a>:</h4>
<p>why do we want to do this?</p>



<a name="209693188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693188">(Sep 10 2020 at 18:59)</a>:</h4>
<p>what's the expected outcome?</p>



<a name="209693197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693197">(Sep 10 2020 at 18:59)</a>:</h4>
<p>have you seen <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span>'s comment?</p>



<a name="209693345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693345">(Sep 10 2020 at 19:00)</a>:</h4>
<p>I see the "&amp;str is nicer to work with than SymbolStr"</p>



<a name="209693389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693389">(Sep 10 2020 at 19:00)</a>:</h4>
<p>"It would be nice to eliminate SymbolStr." unsure why this :)</p>



<a name="209693444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693444">(Sep 10 2020 at 19:00)</a>:</h4>
<p>"It avoids the lie that SymbolStr strings have a static lifetime, replacing it with a smaller lie that the strings have a lifetime tied to the lifetime of the input Symbol." unsure I understand what lie are we talking about :)</p>



<a name="209693519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693519">(Sep 10 2020 at 19:01)</a>:</h4>
<p>right now <code>SymbolStr</code> contains a <code>&amp;'static str</code></p>



<a name="209693570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209693570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209693570">(Sep 10 2020 at 19:01)</a>:</h4>
<p>and you can pass it around arbitrarily, but not across threads</p>



<a name="209694920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209694920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209694920">(Sep 10 2020 at 19:11)</a>:</h4>
<p>I'm not worried about</p>
<blockquote>
<p>We can't mark &amp;str as !Send and !Sync.</p>
</blockquote>
<p>because you can't send or share a <code>&amp;str</code> across threads without crossbeam like stuff and we have none of that</p>



<a name="209695014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209695014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209695014">(Sep 10 2020 at 19:12)</a>:</h4>
<p>I haven't looked at <code>to_stable_hash_key</code>, so idk what would be the problem there</p>



<a name="209695828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209695828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209695828">(Sep 10 2020 at 19:19)</a>:</h4>
<p>ok, gonna take a look at this</p>



<a name="209698010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209698010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209698010">(Sep 10 2020 at 19:35)</a>:</h4>
<blockquote>
<p>because you can't send or share a <code>&amp;str</code> across threads without crossbeam like stuff and we have none of that</p>
</blockquote>
<p><span class="user-mention" data-user-id="124288">@oli</span> Can you elaborate on that? Would there be a soundness hole if we started to use crossbeam in the compiler?</p>



<a name="209714590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209714590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209714590">(Sep 10 2020 at 21:55)</a>:</h4>
<p>one of the crossbeam packages appears to rely on a behavior that could be UB, so yes.</p>



<a name="209714723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209714723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209714723">(Sep 10 2020 at 21:56)</a>:</h4>
<p>It's not very much, but it's the one, and it would be tedious to audit particular usages of crossbeam to guarantee it wasn't using that.</p>



<a name="209715140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209715140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209715140">(Sep 10 2020 at 22:00)</a>:</h4>
<p>this is not at all related to that, presumably</p>



<a name="209715235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209715235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209715235">(Sep 10 2020 at 22:01)</a>:</h4>
<p>I think sharing the &amp;str across threads is actually not UB, so long as it's <code>&amp;'a str</code> rather than 'static; a scoped thread should be fine? Not 100% sure</p>



<a name="209715366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%5BDRAFT%5D%20Change%20%60Symbol%3A%3Aas_str%28%29%60%20to%20%60%26self%20-%3E%20%26str%60%20%2376460/near/209715366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.5BDRAFT.5D.20Change.20.60Symbol.3A.3Aas_str().60.20to.20.60.26self.20-.3E.20.26str.60.20.2376460.html#209715366">(Sep 10 2020 at 22:02)</a>:</h4>
<p>Probably wouldn't matter for this specific context no, question appeared more general.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>