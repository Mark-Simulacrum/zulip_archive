<html>
<head><meta charset="utf-8"><title>musings on windows ABI&#x27;s · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html">musings on windows ABI&#x27;s</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275822280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822280">(Mar 18 2022 at 15:57)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I wanted to follow up on that conversation from <a class="stream-topic" data-stream-id="238009" href="/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bsteering.20meeting.5D.202022-03-18.20compiler-team.23484">#t-compiler/meetings &gt; [steering meeting] 2022-03-18 compiler-team#484</a></p>



<a name="275822295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822295">(Mar 18 2022 at 15:57)</a>:</h4>
<p>namely, you pointed out this:</p>



<a name="275822426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822426">(Mar 18 2022 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bsteering.20meeting.5D.202022-03-18.20compiler-team.23484/near/275811806">said</a>:</p>
<blockquote>
<p>There are only 2 ABIs on x86_64 Windows: the standard x86_64 one and vectorcall. (IIRC)</p>
</blockquote>



<a name="275822516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822516">(Mar 18 2022 at 15:59)</a>:</h4>
<p>so: what happens in Visual Studio when one tries to compile a function with extern "thiscall" on x86_64 on Windows?</p>



<a name="275822564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822564">(Mar 18 2022 at 15:59)</a>:</h4>
<p>does it get silently remapped to the standard x86_64 calling convention?</p>



<a name="275822603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822603">(Mar 18 2022 at 15:59)</a>:</h4>
<blockquote>
<p>On ARM, ARM64, and x64 machines, __thiscall is accepted and ignored by the compiler. That's because they use a register-based calling convention by default.</p>
</blockquote>
<p><a href="https://docs.microsoft.com/en-us/cpp/cpp/thiscall?view=msvc-170">https://docs.microsoft.com/en-us/cpp/cpp/thiscall?view=msvc-170</a></p>



<a name="275822611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822611">(Mar 18 2022 at 15:59)</a>:</h4>
<p>(if that is the case, then I think we could make an argument for doing the same)</p>



<a name="275822659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822659">(Mar 18 2022 at 15:59)</a>:</h4>
<p>huh. Okay.</p>



<a name="275822672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822672">(Mar 18 2022 at 15:59)</a>:</h4>
<p>This applies to all the calling conventions on i686 except for vectorcall.</p>



<a name="275822825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822825">(Mar 18 2022 at 16:00)</a>:</h4>
<p>Oh but </p>
<blockquote>
<p>On ARM machines, __vectorcall is accepted and ignored by the compiler.</p>
</blockquote>



<a name="275822871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822871">(Mar 18 2022 at 16:00)</a>:</h4>
<blockquote>
<p>The __vectorcall calling convention on x64 extends the standard x64 calling convention to take advantage of additional registers.</p>
</blockquote>



<a name="275822887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275822887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275822887">(Mar 18 2022 at 16:00)</a>:</h4>
<p><a href="https://docs.microsoft.com/en-us/cpp/cpp/vectorcall">https://docs.microsoft.com/en-us/cpp/cpp/vectorcall</a></p>



<a name="275823289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275823289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275823289">(Mar 18 2022 at 16:02)</a>:</h4>
<p>I'm not sure if we want to copy that behavior or not. I'm guessing silently ignoring it was probably done because just switching from x86 to x64 in VS/msvc would break a lot of code in the wild that hadn't been written with this fact in mind.</p>



<a name="275823320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275823320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275823320">(Mar 18 2022 at 16:02)</a>:</h4>
<p>I'm not sure how true that is of Rust code.</p>



<a name="275827274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827274">(Mar 18 2022 at 16:27)</a>:</h4>
<p>hmm.</p>



<a name="275827293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827293">(Mar 18 2022 at 16:27)</a>:</h4>
<p>yes, annoying code duplication is different from outright breakage</p>



<a name="275827351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827351">(Mar 18 2022 at 16:27)</a>:</h4>
<p>mostly I was musing about this because my assumed direction was something like the straw proposal I had put into the meeting</p>



<a name="275827447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827447">(Mar 18 2022 at 16:28)</a>:</h4>
<p>namely this:</p>



<a name="275827450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827450">(Mar 18 2022 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bsteering.20meeting.5D.202022-03-18.20compiler-team.23484/near/275812175">said</a>:</p>
<blockquote>
<p><code>extern cfg_match!(target_arch, "x86" =&gt; "thiscall", "x86_64" =&gt; "fastcall") fn foo() {}</code></p>
</blockquote>
<p>(update: its possible the "fastcall" above should have just been "C"; I'm not sure.)</p>



<a name="275827554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827554">(Mar 18 2022 at 16:29)</a>:</h4>
<p>and after reflecting on it, I wondered "Is this actually going to provide <em>value</em>? Or is it just going to be boilerplate that <em>could always</em> have been written just as <code>extern "thiscall" fn foo()</code></p>



<a name="275827662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275827662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275827662">(Mar 18 2022 at 16:29)</a>:</h4>
<p>(where <code>extern "thiscall"</code> silently maps to <code>extern "C"</code> on "x86_64" Windows targets.)</p>



<a name="275828721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275828721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275828721">(Mar 18 2022 at 16:36)</a>:</h4>
<p>Yeah, I'm unsure. The other thing that's a bit different for us is that most of the time, these annotations are going to be on FFI code where it's really important that what you write matches up with what is actually expected at link/load time. <br>
I could see ignoring abis that don't make sense for the current target being confusing to users. On the other hand, perhaps it will match up with what msvc does so often that it's just noise and doesn't matter.</p>



<a name="275843403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275843403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275843403">(Mar 18 2022 at 18:21)</a>:</h4>
<p>in any case, if I'm right in my expectations, we can always <em>adopt the msvc approach later</em></p>



<a name="275843501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275843501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275843501">(Mar 18 2022 at 18:22)</a>:</h4>
<p>So i think I will focus on the near term goal of enabling ergonomic-yet-explicit specification here. Which I think means an MCP for making the ABI in <code>extern ABI</code> a macro expansion position.</p>



<a name="275846202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275846202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275846202">(Mar 18 2022 at 18:44)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/blob/1bfe40d11c3630254504fb73eeccfca28d50df52/compiler/rustc_target/src/spec/mod.rs#L1610-L1639">https://github.com/rust-lang/rust/blob/1bfe40d11c3630254504fb73eeccfca28d50df52/compiler/rustc_target/src/spec/mod.rs#L1610-L1639</a></p>



<a name="275847298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/musings%20on%20windows%20ABI%27s/near/275847298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/musings.20on.20windows.20ABI&#x27;s.html#275847298">(Mar 18 2022 at 18:54)</a>:</h4>
<p>I really dislike whatever food was being served to the toolchain developers at microsoft on the day when this fallback thing was decided upon. This is almost as bad as ordering a chair on amazon and having a pillow delivered. Can sit on it? sure. Is it a chair? eh...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>