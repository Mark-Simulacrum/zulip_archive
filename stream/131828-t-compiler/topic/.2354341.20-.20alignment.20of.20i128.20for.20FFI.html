<html>
<head><meta charset="utf-8"><title>#54341 - alignment of i128 for FFI · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html">#54341 - alignment of i128 for FFI</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260289399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260289399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260289399">(Nov 04 2021 at 15:46)</a>:</h4>
<p>I'm currently looking into the issue of the alignment of <code>i128</code> being 8 while the C <code>__int128</code> has an alignment of 16. Clang ignores the LLVM datalayout and hard-codes the alignment to 16 bytes.</p>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> You previously attempted to fix this in <a href="https://github.com/rust-lang/rust/issues/38871">#38871</a>, but in the end it didn't get merged. There was an attempt to fix this on the LLVM side but that didn't go through either. Do you think we can just hard-code the alignment like Clang does and ignore the datalayout?</p>



<a name="260296307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260296307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260296307">(Nov 04 2021 at 16:26)</a>:</h4>
<p>I would rather we don't. Data layout is used by our size and layout calculation code as implemented by eddyb.</p>



<a name="260296354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260296354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260296354">(Nov 04 2021 at 16:27)</a>:</h4>
<p>IME the right solution would be to change the data layout string on our end and remove the requirement that it matches whatever llvm thinks is default.</p>



<a name="260296576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260296576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260296576">(Nov 04 2021 at 16:28)</a>:</h4>
<p><a href="https://reviews.llvm.org/D28990">https://reviews.llvm.org/D28990</a>  was a fix attempt on LLVM side.</p>



<a name="260296632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260296632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260296632">(Nov 04 2021 at 16:29)</a>:</h4>
<p>I never actually followed up on this.</p>



<a name="260354274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260354274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260354274">(Nov 05 2021 at 00:49)</a>:</h4>
<p>@nagisa One possibility for changing LLVM is to change the default alignment in the datalayout for i128 when a value isn't specified (<a href="https://github.com/llvm/llvm-project/blob/9714444f1e43fafc7e5235f4d3675b9d2056d97b/llvm/lib/IR/DataLayout.cpp#L170">here</a>). That way the actual datalayout strings wouldn't need to be changed.</p>



<a name="260354299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260354299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260354299">(Nov 05 2021 at 00:50)</a>:</h4>
<p>Any target that doesn't specify an alignment for i128 in their datalayout will have it default to 128-bit alignment, which is in line with what Clang expects.</p>



<a name="260355220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260355220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260355220">(Nov 05 2021 at 01:02)</a>:</h4>
<p>We hit the <code>__int128</code> issue on the libc bindings and I'd like to figure out <em>some</em> way we can make <code>i128</code> C-compatible.</p>



<a name="260355526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260355526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260355526">(Nov 05 2021 at 01:07)</a>:</h4>
<p>would we make it <em>conditionally</em> FFI-safe? I don't think all targets have <code>__int128</code> in their C ABIs</p>



<a name="260357125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%2354341%20-%20alignment%20of%20i128%20for%20FFI/near/260357125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.2354341.20-.20alignment.20of.20i128.20for.20FFI.html#260357125">(Nov 05 2021 at 01:34)</a>:</h4>
<p>Yes, we would basically disable the FFI-safe lint for <code>i128</code> only on targets that have a <code>__int128</code> type.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>