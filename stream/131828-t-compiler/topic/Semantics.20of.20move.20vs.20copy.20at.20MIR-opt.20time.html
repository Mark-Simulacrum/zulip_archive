<html>
<head><meta charset="utf-8"><title>Semantics of move vs copy at MIR-opt time · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html">Semantics of move vs copy at MIR-opt time</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270801543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270801543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270801543">(Feb 05 2022 at 03:26)</a>:</h4>
<p>What are the requirements of the "correct" usage of <code>move</code> vs <code>copy</code> in the MIR that optimizations run on? I assume using a non-<code>Copy</code> value after it has been <code>move</code>d out of is MIR UB even if the semantics of the thing at runtime are ok (for example if the store is dead). Does this remain true for <code>Copy</code> values? Is copying a non-<code>Copy</code> value ok even if that copy is never used (either at all, or to do anything bad)?</p>



<a name="270802040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270802040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270802040">(Feb 05 2022 at 03:38)</a>:</h4>
<p>Also, is there some place where these types of decisions are recorded? I know that MIR semantics are fairly up in the air right now, but other than the code for the validator, are the decisions that have been made written down anywhere?</p>



<a name="270808827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270808827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270808827">(Feb 05 2022 at 06:13)</a>:</h4>
<p><a class="stream" data-stream-id="189540" href="/#narrow/stream/189540-t-compiler.2Fwg-mir-opt">#t-compiler/wg-mir-opt</a> would probably have a better idea.</p>
<p>As far as I know, the <em>intention</em> of <code>Move(_3)</code> in MIR is to help allow reasoning by being a guarantee that <code>_3</code> is never used after that.  The HIR-&gt;MIR code generates <code>Copy</code>s for places where things might be used again.</p>



<a name="270808925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270808925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270808925">(Feb 05 2022 at 06:14)</a>:</h4>
<p>(I don't recall whether the MIR validation pass double-checks it, but if it does that might be an easy way to confirm it.)</p>



<a name="270811538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270811538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270811538">(Feb 05 2022 at 07:21)</a>:</h4>
<p>MIR validation does some checks, but no "is place read after move". Due to pointers, this is hard/impossible  to do anyway. We want to do this in miri though. Deinitialize the place that was moved from. So yes, from my understanding of MIR, you are reading uninitialized bytes if you read from something that was moved out of.</p>



<a name="270812926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270812926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270812926">(Feb 05 2022 at 07:58)</a>:</h4>
<p>This thread reminds me of my question here <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/307">https://github.com/rust-lang/unsafe-code-guidelines/issues/307</a></p>



<a name="270819299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/270819299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#270819299">(Feb 05 2022 at 10:38)</a>:</h4>
<p>Time to create precedent by making miri deinit sources on move xD</p>



<a name="271654596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/271654596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#271654596">(Feb 11 2022 at 23:53)</a>:</h4>
<p>Was thinking about this, and an example I came up with: If we have a</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>and MIR like</p>
<div class="codehilite"><pre><span></span><code>let _1: Foo;
let _2: Foo;
let _3: usize;
...
_2.0 = copy _1.0;
_2.1 = move _1.0;
...
_3 = copy _1.0;
</code></pre></div>
<p>we might want to optimize the middle batch of statements into <code>_2 = move _1;</code>, but that would be incorrect if <code>move</code> is supposed to invalidate. I can think of many ways around this (SSA, allowing <code>_2 = copy _1;</code>, making <code>move</code> not recursive on <code>Copy</code> fields), but it's potentially something to consider</p>



<a name="271655633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/271655633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#271655633">(Feb 12 2022 at 00:05)</a>:</h4>
<p>Probably the best of those options is to allow optimizations to produce <code>_2 = copy _1;</code>, although this once more brings up the issue I had asked about in some PR regarding whether optimized MIR is expected to pass analysis</p>



<a name="271658503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/271658503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#271658503">(Feb 12 2022 at 00:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time/near/271654596">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>_2.0 = copy _1.0;
_2.1 = move _1.0;
</code></pre></div><br>
</p>
</blockquote>
<p>Was that perhaps supposed to be this?</p>
<div class="codehilite"><pre><span></span><code>_2.0 = copy _1.0;
_2.1 = move _1.1;
</code></pre></div>



<a name="271658904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/271658904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> spunit262 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#271658904">(Feb 12 2022 at 00:59)</a>:</h4>
<p>If we care about analysis on optimized MIR, but want optimizations that produce copies of non-<code>Copy</code> type, we could add a new Operand to mark them, maybe name it <code>ForcedCopy</code>. Then we can reintroduce the reborrow to copy optimization.</p>



<a name="271659609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Semantics%20of%20move%20vs%20copy%20at%20MIR-opt%20time/near/271659609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time.html#271659609">(Feb 12 2022 at 01:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time/near/271658503">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/131828-t-compiler/topic/Semantics.20of.20move.20vs.20copy.20at.20MIR-opt.20time/near/271654596">said</a>:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>_2.0 = copy _1.0;
_2.1 = move _1.0;
</code></pre></div><br>
</p>
</blockquote>
<p>Was that perhaps supposed to be this?</p>
<p><div class="codehilite"><pre><span></span><code>_2.0 = copy _1.0;
_2.1 = move _1.1;
</code></pre></div><br>
</p>
</blockquote>
<p>Yep, thanks</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>