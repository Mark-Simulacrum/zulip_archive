<html>
<head><meta charset="utf-8"><title>Would like to help investigate and fix a potential GAT bug · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html">Would like to help investigate and fix a potential GAT bug</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251358285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251358285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mvlabat <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251358285">(Aug 31 2021 at 09:49)</a>:</h4>
<p>Hi everyone! I'm totally new to the Rust compiler. I've just stumbled upon a bug with GAT (supposedly): <a href="https://github.com/rust-lang/rust/issues/88526">https://github.com/rust-lang/rust/issues/88526</a><br>
I'd be grateful if anyone could confirm that it's really a bug and what kind of bug that is. I assume that the thing that I was trying to do wasn't correct either, so it might be a diagnostic issue as well. I'd also be happy to try to fix that, so I'll appreciate any explanations of what is wrong exactly and directions to the source code where I should start looking.</p>
<p>Meanwhile, I'm finishing reading through <a href="https://rustc-dev-guide.rust-lang.org/getting-started.html">https://rustc-dev-guide.rust-lang.org/getting-started.html</a>, after that I'll look at random PRs related to GAT, to get an idea of where the related code might be. Thanks!</p>



<a name="251371680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251371680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251371680">(Aug 31 2021 at 11:52)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="211913">@mvlabat</span>! So, <a href="https://github.com/rust-lang/rust/issues/87735">#87735</a> is related. This isn't necessarily a bug as much as a  weird design quirk and bad diagnostics. The issue is that <code>'q</code> isn't constrained, so <code>I</code> is stopped being constrained. I think you can get around this by changing it to be <code>for&lt;'q&gt; A&lt;I&lt;'q&gt; = &amp;'q I&gt;</code>, but I realize if this is a minimization that might be difficult with more code.</p>



<a name="251371996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251371996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251371996">(Aug 31 2021 at 11:55)</a>:</h4>
<p>I was talking to <span class="user-mention" data-user-id="116009">@nikomatsakis</span> about this before, but I think we likely should revisit this. I'm wondering if we should be considering the GAT substs as "inputs" when checking if a projection is constrained</p>



<a name="251372488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251372488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251372488">(Aug 31 2021 at 11:59)</a>:</h4>
<p>If you're interested in helping out, maybe the most helpful "correct" thing that can be done would be to add some diagnostics to point to <code>'q</code> as being the problem and maybe suggesting a <code>for&lt;'q&gt;</code> if possible. If you need some help getting started, feel free to message me or head over to <a class="stream" data-stream-id="144729" href="/#narrow/stream/144729-wg-traits">#wg-traits</a></p>



<a name="251440875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251440875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mvlabat <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251440875">(Aug 31 2021 at 19:13)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="232957">@Jack Huey</span>! Thanks for the response. Btw, is passing a generic parameter into a GAT any different in terms of constraints logic from assigning it to an associated type? For example,</p>
<div class="codehilite"><pre><span></span><code>impl&lt;&#39;a, G&gt; ...
where G: SomeTrait&lt;Item&lt;&#39;a&gt;=()&gt;
</code></pre></div>
<p>vs</p>
<div class="codehilite"><pre><span></span><code>impl&lt;G, T&gt; ...
where G: SomeTrait&lt;Item=T&gt;
</code></pre></div>
<p>Or are both of these cases related to the design quirk that you've mentioned? I'm curious whether it would make sense to treat them differently.</p>



<a name="251441970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251441970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251441970">(Aug 31 2021 at 19:19)</a>:</h4>
<p>Right, so in</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="k">where</span><span class="w"> </span><span class="n">G</span>: <span class="nc">SomeTrait</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">=</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p><code>T</code> is constrained in <code>G</code> is (because the substs of the projection is <code>[G]</code>)<br>
If you had</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="k">where</span><span class="w"> </span><span class="n">G</span>: <span class="nc">SomeTrait</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;=</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>then <code>T</code> is only constrained if <em>both</em> <code>'a</code> and <code>G</code> are (because the substs are <code>[G, 'a]</code>)<br>
(I'll have to find where this logic is later, but it's easy enough to find searching back from the emitted error)</p>



<a name="251442029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251442029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251442029">(Aug 31 2021 at 19:20)</a>:</h4>
<p>So, in this, they are treated the same</p>



<a name="251442856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251442856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251442856">(Aug 31 2021 at 19:24)</a>:</h4>
<p>But the idea behind this logic is essentially that we want to make sure that each impl only applies once for each self type for each trait</p>



<a name="251443003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251443003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251443003">(Aug 31 2021 at 19:25)</a>:</h4>
<p>Now, with GATs, do we need to require that <code>'a</code> has to be constrained here?</p>



<a name="251443302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251443302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251443302">(Aug 31 2021 at 19:27)</a>:</h4>
<p>I have to think about it a bit more, but the reason why I think the current rules aren't <em>exactly</em> correct is that when the GAT is constructed, in can be constructed with any <code>'a</code> (that satisfy the where clauses)</p>



<a name="251443332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251443332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251443332">(Aug 31 2021 at 19:27)</a>:</h4>
<p>and they don't affect the impl picked</p>



<a name="251443498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251443498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251443498">(Aug 31 2021 at 19:28)</a>:</h4>
<p>But I have yet to fully wrap my head around this. <span class="user-mention" data-user-id="116009">@nikomatsakis</span> would be a good person to butt in here</p>



<a name="251443682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251443682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mvlabat <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251443682">(Aug 31 2021 at 19:29)</a>:</h4>
<p>Oh, I didn't realize that <code>T</code> is constrained in the first example. Thanks for pointing that out</p>



<a name="251443803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Would%20like%20to%20help%20investigate%20and%20fix%20a%20potential%20GAT%20bug/near/251443803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mvlabat <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Would.20like.20to.20help.20investigate.20and.20fix.20a.20potential.20GAT.20bug.html#251443803">(Aug 31 2021 at 19:30)</a>:</h4>
<p>my comparison doesn't quite make sense then</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>