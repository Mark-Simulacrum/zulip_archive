<html>
<head><meta charset="utf-8"><title>design meeting 2019-10-11 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html">design meeting 2019-10-11</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="177906209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177906209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177906209">(Oct 11 2019 at 13:23)</a>:</h4>
<p>Dear <span class="user-group-mention" data-user-group-id="897">@T-compiler/meeting</span>,</p>
<p>Today we will be having a <strong>design meeting</strong>. The topic was originally sketched as "some Zoxc PR". We've since narrowed that down to discuss <a href="https://github.com/rust-lang/rust/issues/62038" target="_blank" title="https://github.com/rust-lang/rust/issues/62038">#62038</a>, which is a refactoring to how dep-graph loading occurs. <span class="user-mention" data-user-id="116466">@Zoxc</span> <a href="https://github.com/rust-lang/rust/pull/62038#issuecomment-540508308" target="_blank" title="https://github.com/rust-lang/rust/pull/62038#issuecomment-540508308">wrote up a comment</a> giving a summary of the ideas. Note that this PR itself is an incremental step towards <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a>, which aims to make dep-graph loading/saving more continuous.</p>
<p>I'd also like to discuss briefly how we should document these changes. We currently have some rustc-chapters on incremental compilation (e.g., <a href="https://rust-lang.github.io/rustc-guide/queries/incremental-compilation-in-detail.html" target="_blank" title="https://rust-lang.github.io/rustc-guide/queries/incremental-compilation-in-detail.html">this chapter goes into detail</a>). I would like to move us to a world where major refactorings like <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> (but not limited to this one -- I think e.g. <a href="https://github.com/rust-lang/rust/pull/65232" target="_blank" title="https://github.com/rust-lang/rust/pull/65232">my recent PR</a> and work on lazy norm fits the bill) come along with a rustc-guide chapter that documents the new state of the world. Maybe we discuss some how that might work and -- in the case of THIS PR -- who might do that documentation work (I don't necessarily think it has to be <span class="user-mention" data-user-id="116466">@Zoxc</span>, though they're also an obvious candidate). (In my ideal world, drafts of that chapter would be available <em>before</em> the PR, but at minimum I think such a chapter should be in place to help with reviewing.)</p>



<a name="177909253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909253">(Oct 11 2019 at 14:01)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="897">@T-compiler/meeting</span>! Meeting starting in a few minutes. As you arrive, please click on the <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> emoji so we have some idea who is here today.</p>
<h1>Announcements</h1>



<a name="177909263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909263">(Oct 11 2019 at 14:01)</a>:</h4>
<p>The <code>A Tale Of Two DepGraphs: The Old And The New</code> part you linked could be updated, but it seems like the rest of the docs don't go enough into details for this PR to matter.</p>



<a name="177909398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909398">(Oct 11 2019 at 14:02)</a>:</h4>
<p>I think updating that section would suffice, yes</p>



<a name="177909447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909447">(Oct 11 2019 at 14:02)</a>:</h4>
<p>(In general, I definitely think there's a bootstrapping problem that the <strong>old docs</strong> don't exist, which makes writing the first round of <strong>new docs</strong> harder.)</p>



<a name="177909500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909500">(Oct 11 2019 at 14:03)</a>:</h4>
<p><strong>Announcement:</strong> <span class="user-mention" data-user-id="116107">@davidtwco</span> wrote an <a href="https://github.com/rust-lang/blog.rust-lang.org/pull/418/" target="_blank" title="https://github.com/rust-lang/blog.rust-lang.org/pull/418/">awesome blog post</a> on the recent diagnostic work they've been working on.</p>



<a name="177909649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909649">(Oct 11 2019 at 14:05)</a>:</h4>
<p>Here is a <a href="https://hackmd.io/FWbz1a_5RPmUnyUWNra7pg" target="_blank" title="https://hackmd.io/FWbz1a_5RPmUnyUWNra7pg">hackmd document</a> that we can use to document and guide this conversation -- at the end, it will hopefully also serve as the minutes.</p>



<a name="177909671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909671">(Oct 11 2019 at 14:05)</a>:</h4>
<p>I meant to do this before but I got caught up in other crap -- but maybe use a few minutes to jot down questions or thoughts, if you've had a chance to peruse the links above</p>



<a name="177909820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909820">(Oct 11 2019 at 14:07)</a>:</h4>
<blockquote>
<p><strong>Announcement:</strong> <span class="user-mention silent" data-user-id="116107">davidtwco</span> wrote an <a href="https://github.com/rust-lang/blog.rust-lang.org/pull/418/" target="_blank" title="https://github.com/rust-lang/blog.rust-lang.org/pull/418/">awesome blog post</a> on the recent diagnostic work they've been working on.</p>
</blockquote>
<p>wonder how much of that may end in rustc-guide :)</p>



<a name="177909998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177909998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177909998">(Oct 11 2019 at 14:09)</a>:</h4>
<p>OK, let's get started?</p>



<a name="177910005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910005">(Oct 11 2019 at 14:09)</a>:</h4>
<p>was just gonna say :P</p>



<a name="177910017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910017">(Oct 11 2019 at 14:09)</a>:</h4>
<p>There are some notes happening in the hackmd too :)</p>



<a name="177910023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910023">(Oct 11 2019 at 14:10)</a>:</h4>
<p>(I advise you to tile your windows if possible :)</p>



<a name="177910096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910096">(Oct 11 2019 at 14:10)</a>:</h4>
<p>So, maybe we can start by talking a bit about how the PR works?</p>



<a name="177910182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910182">(Oct 11 2019 at 14:11)</a>:</h4>
<p>So as <span class="user-mention" data-user-id="116466">@Zoxc</span> wrote, we currently load he entire previous dep-graph into memory</p>



<a name="177910190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910190">(Oct 11 2019 at 14:11)</a>:</h4>
<p>I have a few questions to refresh my memory</p>



<a name="177910196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910196">(Oct 11 2019 at 14:11)</a>:</h4>
<p>About existing system</p>



<a name="177910262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910262">(Oct 11 2019 at 14:12)</a>:</h4>
<p>Basically, when we start a query, I think we go check against this old graph to see if we can re-use the results, right?</p>



<a name="177910270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910270">(Oct 11 2019 at 14:12)</a>:</h4>
<p>If so, we copy into the new graph that we are building up for the current session?</p>



<a name="177910279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910279">(Oct 11 2019 at 14:12)</a>:</h4>
<p>yes</p>



<a name="177910369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910369">(Oct 11 2019 at 14:13)</a>:</h4>
<p>We have also this color scheme -- green nodes being ones whose results were unchanged from last time etc -- but that is only relevant to the new graph, right?</p>



<a name="177910395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910395">(Oct 11 2019 at 14:13)</a>:</h4>
<p>That's only for the old graph</p>



<a name="177910530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910530">(Oct 11 2019 at 14:14)</a>:</h4>
<p>Hmm, I guess that surprises me, but likely i'm confused :)</p>



<a name="177910535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910535">(Oct 11 2019 at 14:14)</a>:</h4>
<p>What I think happens when we start a query is something like this:</p>



<a name="177910569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910569">(Oct 11 2019 at 14:15)</a>:</h4>
<ul>
<li>If the query existed in the old graph, we go and find its node</li>
<li>We add that node to the new graph, colored grey or something like that</li>
</ul>



<a name="177910584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910584">(Oct 11 2019 at 14:15)</a>:</h4>
<p>yes, when you ask if node X is green or red, and node X did not exist in the old graph, then you don't have to look any further</p>



<a name="177910592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910592">(Oct 11 2019 at 14:15)</a>:</h4>
<ul>
<li>Then we go validate its inputs recursively, repeating the above process</li>
</ul>



<a name="177910615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910615">(Oct 11 2019 at 14:15)</a>:</h4>
<p>The green color means that the result of a query is the same in the previous graph as the current one. If the query doesn't exist in the previous graph, it has no color.</p>



<a name="177910637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910637">(Oct 11 2019 at 14:15)</a>:</h4>
<ul>
<li>If all inputs are green, then we can mark this node as green; if any input changed, we re-execute and compare hashes of output, coloring node red or green appropriately.</li>
</ul>



<a name="177910710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910710">(Oct 11 2019 at 14:16)</a>:</h4>
<p>Right, ok, it sounds like we're roughly saying the same thing. So the <strong>color</strong> is a property of the new graph. Nobody cares what color it had in the old graph.</p>



<a name="177910749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910749">(Oct 11 2019 at 14:16)</a>:</h4>
<p>(Sound right?)</p>



<a name="177910752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910752">(Oct 11 2019 at 14:16)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> almost: we don;t add grey nodes. rather we don't do anything with the current node yet</p>



<a name="177910758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910758">(Oct 11 2019 at 14:16)</a>:</h4>
<p>OK.</p>



<a name="177910768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910768">(Oct 11 2019 at 14:17)</a>:</h4>
<p>/me wonders about parallelism</p>



<a name="177910785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910785">(Oct 11 2019 at 14:17)</a>:</h4>
<p>ah I guess that's handled separately</p>



<a name="177910794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910794">(Oct 11 2019 at 14:17)</a>:</h4>
<p>marking is racy, but deterministic currently</p>



<a name="177910796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910796">(Oct 11 2019 at 14:17)</a>:</h4>
<p>i.e., the query mechanism intercepts parallel attempts to compute same value earlier</p>



<a name="177910799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910799">(Oct 11 2019 at 14:17)</a>:</h4>
<p>I think</p>



<a name="177910825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910825">(Oct 11 2019 at 14:17)</a>:</h4>
<p>Colors are comparisons between the new and old graph and don't get stored on disk</p>



<a name="177910828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910828">(Oct 11 2019 at 14:17)</a>:</h4>
<p>ok, let's leave parallelism out of it for a second</p>



<a name="177910892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910892">(Oct 11 2019 at 14:18)</a>:</h4>
<p>I have another question:</p>
<blockquote>
<p>This means that the ids in the previous dep graph and current dep graph are distinct.</p>
</blockquote>



<a name="177910906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177910906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177910906">(Oct 11 2019 at 14:18)</a>:</h4>
<p>These ids you are referring to, <span class="user-mention" data-user-id="116466">@Zoxc</span>, are they the <code>DepGraphNodeIndex</code> values?</p>



<a name="177911022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911022">(Oct 11 2019 at 14:19)</a>:</h4>
<p>To give those following along some context:</p>
<ul>
<li>the dep-graph tracks the dependencies between queries; </li>
<li>it has a node representing each query, and an edge N1 -&gt; N2 indicates that the query N1 executed the query N2 (and hence is dependent on N2's result)</li>
<li>each node gets an index, the <code>DepNodeIndex</code>; </li>
<li>also, sometimes we have nodes that are not queries, so-called "anonymous nodes", but I don't think they're too relevant here (yet).</li>
</ul>



<a name="177911093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911093">(Oct 11 2019 at 14:20)</a>:</h4>
<blockquote>
<p>These ids you are referring to, @Zoxc, are they the DepGraphNodeIndex values?</p>
</blockquote>
<p>yes. <code>DepGraphNodeIndex</code> -&gt; <code>DepNodeIndex</code></p>



<a name="177911107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911107">(Oct 11 2019 at 14:20)</a>:</h4>
<p>er, ok</p>



<a name="177911161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911161">(Oct 11 2019 at 14:20)</a>:</h4>
<p>OK, so in the new PR, let's maybe walk through the editing process a bit?</p>



<a name="177911184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911184">(Oct 11 2019 at 14:21)</a>:</h4>
<p>Basically, the change is to load up the old graph and use it as the starting point, editing it in place, rather than copying things out from it into the new graph (right?)</p>



<a name="177911215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911215">(Oct 11 2019 at 14:21)</a>:</h4>
<p>Yeah. That's the key idea.</p>



<a name="177911307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911307">(Oct 11 2019 at 14:22)</a>:</h4>
<p>Do we ever delete nodes?</p>



<a name="177911334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911334">(Oct 11 2019 at 14:22)</a>:</h4>
<p>Like, if we go to evaluate some query, and we find it had a correpsonding node, but that node has a red input</p>



<a name="177911360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911360">(Oct 11 2019 at 14:22)</a>:</h4>
<p>We will re-execute the query, producing a result -- this result may have distinct edges from before, I guess</p>



<a name="177911372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911372">(Oct 11 2019 at 14:22)</a>:</h4>
<p>But we keep the same DepNode index, we just adjust its set of edges in place?</p>



<a name="177911387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911387">(Oct 11 2019 at 14:23)</a>:</h4>
<p>No, we only overwrite nodes with new dependencies.</p>



<a name="177911428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911428">(Oct 11 2019 at 14:23)</a>:</h4>
<p>My PR will delete nodes at the end of the compiler, but that's the only way nodes are removed.</p>



<a name="177911542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911542">(Oct 11 2019 at 14:24)</a>:</h4>
<p>The main scenario (at present) that I think something could need to be deleted is:</p>
<ul>
<li>Node A used to depend nodes B and C</li>
<li>Node B was Red</li>
<li>When N re-executes, it no longer uses node C </li>
<li>Node C remains in the graph and is maybe no longer relevant</li>
</ul>



<a name="177911543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911543">(Oct 11 2019 at 14:24)</a>:</h4>
<p>As in queries which did not get executed are removed from the dep graph. In the current state of the compiler, these wouldn't get copied to the new dep graph from the old.</p>



<a name="177911573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911573">(Oct 11 2019 at 14:25)</a>:</h4>
<p>OK, so we do a final sweep over the graph</p>



<a name="177911580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911580">(Oct 11 2019 at 14:25)</a>:</h4>
<p>Checking which queries were used this time</p>



<a name="177911584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911584">(Oct 11 2019 at 14:25)</a>:</h4>
<p>and deleting those that were not?</p>



<a name="177911595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911595">(Oct 11 2019 at 14:25)</a>:</h4>
<p>what about so-called "anonymous nodes"?</p>



<a name="177911697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911697">(Oct 11 2019 at 14:26)</a>:</h4>
<p>everything that got used is either red or green, right? (including anon nodes)</p>



<a name="177911708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911708">(Oct 11 2019 at 14:26)</a>:</h4>
<p>the rest is "unknown"</p>



<a name="177911752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911752">(Oct 11 2019 at 14:26)</a>:</h4>
<p>and we should get rid of all excess nodes by deleting all the unknown ones</p>



<a name="177911800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911800">(Oct 11 2019 at 14:27)</a>:</h4>
<p>(which is true only under the assumption  that we did a full compilation that touched everything)</p>



<a name="177911811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911811">(Oct 11 2019 at 14:27)</a>:</h4>
<p>ok, so we now have a use for the "grey" color :P</p>



<a name="177911848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911848">(Oct 11 2019 at 14:27)</a>:</h4>
<p>yes, in the PR, the current graph starts out as a grey copy of the old graph</p>



<a name="177911856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911856">(Oct 11 2019 at 14:27)</a>:</h4>
<p>however, I take it that when we delete nodes, we don't have any mechanism to "re-use" the old indices</p>



<a name="177911873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911873">(Oct 11 2019 at 14:28)</a>:</h4>
<p>this is presumably the "index leak" that <span class="user-mention" data-user-id="116466">@Zoxc</span> was referring to?</p>



<a name="177911937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911937">(Oct 11 2019 at 14:28)</a>:</h4>
<p>The PR stores the deletes ids to disk to be reused.</p>



<a name="177911954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911954">(Oct 11 2019 at 14:28)</a>:</h4>
<p>OK. So the main problem is that the "high water mark" never goes down?</p>



<a name="177911962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911962">(Oct 11 2019 at 14:28)</a>:</h4>
<p>so is there still a drift?</p>



<a name="177911968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911968">(Oct 11 2019 at 14:28)</a>:</h4>
<p>plus fragmentation</p>



<a name="177911980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911980">(Oct 11 2019 at 14:28)</a>:</h4>
<p>i.e., maybe they are scattered through the "index space"</p>



<a name="177911993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177911993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177911993">(Oct 11 2019 at 14:29)</a>:</h4>
<p>The problem is when you have a crate with a lot of ids, which then could have less ids in the future.</p>



<a name="177912041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912041">(Oct 11 2019 at 14:29)</a>:</h4>
<p>yeah, that's what I was referring to by "high water mark"</p>



<a name="177912057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912057">(Oct 11 2019 at 14:29)</a>:</h4>
<p>Usually crates grow larger though, but there could be like an edge case with recursive types, etc. that crates a lot of ids due to an error.</p>



<a name="177912147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912147">(Oct 11 2019 at 14:30)</a>:</h4>
<p>are the <code>DepNodeIndex</code> values visible outside the graph?</p>



<a name="177912151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912151">(Oct 11 2019 at 14:30)</a>:</h4>
<p><em>Presently</em> we dont' store the dep-graph on error</p>



<a name="177912159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912159">(Oct 11 2019 at 14:30)</a>:</h4>
<p>(But obviously we'd like to change that eventually)</p>



<a name="177912179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912179">(Oct 11 2019 at 14:30)</a>:</h4>
<p>i.e. are we free to re-assign them during serialization if fragmentation gets too high?</p>



<a name="177912217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912217">(Oct 11 2019 at 14:31)</a>:</h4>
<p>it seems like if we are doing a "remove old node" sweep</p>



<a name="177912227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912227">(Oct 11 2019 at 14:31)</a>:</h4>
<p>it's not hard to imagine a "compression step" as well</p>



<a name="177912247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912247">(Oct 11 2019 at 14:31)</a>:</h4>
<p>not saying it has to block this PR, but there seems to be room to fix that in the future if we had a problem</p>



<a name="177912253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912253">(Oct 11 2019 at 14:31)</a>:</h4>
<p>(is there any fundamental reason that is hard?)</p>



<a name="177912259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912259">(Oct 11 2019 at 14:31)</a>:</h4>
<blockquote>
<p>i.e. are we free to re-assign them during serialization if fragmentation gets too high?</p>
</blockquote>
<p>basically this, yes</p>



<a name="177912273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912273">(Oct 11 2019 at 14:31)</a>:</h4>
<p>I'm trying to remember if the query result cache uses these indices as keys or something</p>



<a name="177912338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912338">(Oct 11 2019 at 14:32)</a>:</h4>
<blockquote>
<p>are the <code>DepNodeIndex</code> values visible outside the graph?</p>
</blockquote>
<p><span class="user-mention" data-user-id="116466">@Zoxc</span>, do you recall <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="177912339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912339">(Oct 11 2019 at 14:32)</a>:</h4>
<p>The query result cache does indeed use them as keys.</p>



<a name="177912398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912398">(Oct 11 2019 at 14:32)</a>:</h4>
<p>ok I confess I don't really remember anything about query result cache</p>



<a name="177912399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912399">(Oct 11 2019 at 14:32)</a>:</h4>
<p>So if we want to garbage collect them, it must be done in sync with the query result cache.</p>



<a name="177912408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912408">(Oct 11 2019 at 14:33)</a>:</h4>
<p>presumably this is stored on the disk ?</p>



<a name="177912416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912416">(Oct 11 2019 at 14:33)</a>:</h4>
<p>well, right now the cache is entirely re-written anyway :)</p>



<a name="177912433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912433">(Oct 11 2019 at 14:33)</a>:</h4>
<blockquote>
<p>So if we want to garbage collect them, it must be done in sync with the query result cache.</p>
</blockquote>
<p>yeah, I guess the question is "is that hard?"</p>



<a name="177912459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912459">(Oct 11 2019 at 14:33)</a>:</h4>
<p>compression would have to record the mapping</p>



<a name="177912468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912468">(Oct 11 2019 at 14:34)</a>:</h4>
<p>I think the query result cache will require garbage collection anyway though, for it to be incremental (I have a branch with that), since it uses interned recursive stuff like types.</p>



<a name="177912516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912516">(Oct 11 2019 at 14:34)</a>:</h4>
<p>and cache serialization would map on the fly during serialization?</p>



<a name="177912604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912604">(Oct 11 2019 at 14:35)</a>:</h4>
<blockquote>
<p>well, right now the cache is entirely re-written anyway :)</p>
</blockquote>
<p>sorry I misunderstood this -- you mean "the compiler re-writes the cache after every exection"</p>



<a name="177912613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912613">(Oct 11 2019 at 14:35)</a>:</h4>
<p>I thought you meant "it has been fully refactored" or something</p>



<a name="177912621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912621">(Oct 11 2019 at 14:35)</a>:</h4>
<p>We'd probably want to garbage collect all the incremental state either before loading it or after compilation. Doing it on-the-fly is going to make the query code messier.</p>



<a name="177912630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912630">(Oct 11 2019 at 14:35)</a>:</h4>
<p>yes please :)</p>



<a name="177912689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912689">(Oct 11 2019 at 14:36)</a>:</h4>
<p>with on-the-fly I mean during serialization</p>



<a name="177912718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912718">(Oct 11 2019 at 14:36)</a>:</h4>
<p>instead of going into the query tables and rewriting there before serialization</p>



<a name="177912760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912760">(Oct 11 2019 at 14:37)</a>:</h4>
<p>(ps, for those following the hackmd, I'm finding lots of weird bugs owing to it being tiled to half a screen, hence the weird formatting :) I need my separate monitor! at a coffee house right now though...)</p>



<a name="177912763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912763">(Oct 11 2019 at 14:37)</a>:</h4>
<p>There's no separate serialization step with <a href="https://github.com/rust-lang/rust/pull/60035" target="_blank" title="https://github.com/rust-lang/rust/pull/60035">https://github.com/rust-lang/rust/pull/60035</a>. We serialize while executing.</p>



<a name="177912784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912784">(Oct 11 2019 at 14:37)</a>:</h4>
<p>I think the real question regarding GC is whether we think it's necessary <em>right now</em></p>



<a name="177912795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912795">(Oct 11 2019 at 14:37)</a>:</h4>
<p>and separately whether we see a <em>path forward</em></p>



<a name="177912821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912821">(Oct 11 2019 at 14:37)</a>:</h4>
<p>I guess I mean like "should it block landing this PR", is question 1, and maybe also "how soon would we want to fix it"</p>



<a name="177912872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912872">(Oct 11 2019 at 14:38)</a>:</h4>
<p>I .. feel like it will probably be a problem at some point</p>



<a name="177912884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912884">(Oct 11 2019 at 14:38)</a>:</h4>
<p>but I also don't know that it needs to block current PR</p>



<a name="177912890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912890">(Oct 11 2019 at 14:38)</a>:</h4>
<p>I'd also like to do a time check - we are 40 minutes in</p>



<a name="177912914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912914">(Oct 11 2019 at 14:38)</a>:</h4>
<p>For <em>me</em> this has been very helpful, I understand much better what's happening, and I hope that for those who haven't been as actively participating it's been at least eductional :)</p>



<a name="177912917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912917">(Oct 11 2019 at 14:38)</a>:</h4>
<p>I don't think we need it now. Also having tons of ids likely won't affect performance much.</p>



<a name="177912932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912932">(Oct 11 2019 at 14:38)</a>:</h4>
<p>But I want to give a chance to turn to another topic</p>



<a name="177912959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912959">(Oct 11 2019 at 14:39)</a>:</h4>
<p>We might as well garbage collect ids if we are garbage collecting the query result cache in the future though.</p>



<a name="177912966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> qmx <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912966">(Oct 11 2019 at 14:39)</a>:</h4>
<p>it has been highly educational indeed</p>



<a name="177912976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912976">(Oct 11 2019 at 14:39)</a>:</h4>
<p>we should also determine if want to do this at all</p>



<a name="177912987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177912987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177912987">(Oct 11 2019 at 14:39)</a>:</h4>
<p>yes, that could be a good topic :)</p>



<a name="177913000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913000">(Oct 11 2019 at 14:39)</a>:</h4>
<p>Which seems like it should be decided as part of broader picture</p>



<a name="177913017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913017">(Oct 11 2019 at 14:39)</a>:</h4>
<p>I'm not saying we shouldn't but there has been no discussion about whether <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> is where we want to go</p>



<a name="177913114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913114">(Oct 11 2019 at 14:40)</a>:</h4>
<p>Can we summarize in a few words what <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> is aiming to do? (Maybe <span class="user-mention" data-user-id="116466">@Zoxc</span>?)</p>



<a name="177913173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913173">(Oct 11 2019 at 14:41)</a>:</h4>
<p>As in, do we want incremental data structures for the dep graph and query result cache or are we fine with a discrete step writing the incremental state taking up all the time in the clean incremental benchmarks? =P</p>



<a name="177913257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913257">(Oct 11 2019 at 14:42)</a>:</h4>
<p>Let me rephase that sarcasm into something more productive: can we lay out the motivations :)</p>



<a name="177913270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913270">(Oct 11 2019 at 14:42)</a>:</h4>
<p>As in, what is the right approach to make these more incremental</p>



<a name="177913349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913349">(Oct 11 2019 at 14:43)</a>:</h4>
<p>I need to skim <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> more closely</p>



<a name="177913375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913375">(Oct 11 2019 at 14:43)</a>:</h4>
<p>the PR description says</p>
<blockquote>
<p>This PR changes how we save the dep graph. Instead of storing the nodes in memory until the end of the compilation they are streamed to a file (in the background with parallel_compiler). This should hopefully reduce the memory usage with incremental compilation somewhat.</p>
</blockquote>



<a name="177913384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913384">(Oct 11 2019 at 14:43)</a>:</h4>
<p>But that doesn't feel complete</p>



<a name="177913400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913400">(Oct 11 2019 at 14:44)</a>:</h4>
<p>Or is it? I was assuming that dep-graph loading was also be affected</p>



<a name="177913451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913451">(Oct 11 2019 at 14:44)</a>:</h4>
<p>I'll quote myself =P</p>
<blockquote>
<p>This PR (<a href="https://github.com/rust-lang/rust/pull/62038" target="_blank" title="https://github.com/rust-lang/rust/pull/62038">https://github.com/rust-lang/rust/pull/62038</a>) is intended as an incremental step towards <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> which goes further and removes the current dep graph from memory and instead stores it in an incremental key-value store on disk. There we apply changes to the on disk dep graph as we execute and we only need write the changes to the dep graph instead of writing the entire dep graph at the end.</p>
</blockquote>



<a name="177913463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913463">(Oct 11 2019 at 14:44)</a>:</h4>
<p>The dep graph loading isn't really affected.</p>



<a name="177913476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913476">(Oct 11 2019 at 14:44)</a>:</h4>
<p>So in that model we would store a "diff" as we execute?</p>



<a name="177913507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913507">(Oct 11 2019 at 14:45)</a>:</h4>
<p>I don't think I had fully processed that part of the text before :)</p>



<a name="177913533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913533">(Oct 11 2019 at 14:45)</a>:</h4>
<p>Kind of. We still have a old dep graph in memory, but a new dep graph on disk which we change as we execute.</p>



<a name="177913562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913562">(Oct 11 2019 at 14:46)</a>:</h4>
<p>So unlike <a href="https://github.com/rust-lang/rust/pull/62038" target="_blank" title="https://github.com/rust-lang/rust/pull/62038">https://github.com/rust-lang/rust/pull/62038</a> it doesn't need to copy the dep graph when loading.</p>



<a name="177913610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913610">(Oct 11 2019 at 14:46)</a>:</h4>
<p>We have a copy on disk we can modify.</p>



<a name="177913627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913627">(Oct 11 2019 at 14:46)</a>:</h4>
<p>I'll make an observation: we probably don't have enough time to really talk out the new PR in a lot of technical depth.</p>



<a name="177913650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913650">(Oct 11 2019 at 14:46)</a>:</h4>
<p>Maybe we should do a 2nd meeting on that, as a follow-up?</p>



<a name="177913682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913682">(Oct 11 2019 at 14:47)</a>:</h4>
<p>Do we think that we can land the current PR either way? Off hand, it seems like it may just be a useful step period.</p>



<a name="177913848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913848">(Oct 11 2019 at 14:48)</a>:</h4>
<p>/me looks at <a href="https://perf.rust-lang.org/compare.html?start=4a365a29d64bec75d107214319a129ba68fc12a3&amp;end=7830caefb62c9c8d3fb7a742c66c64c89bf3aafe&amp;stat=wall-time" target="_blank" title="https://perf.rust-lang.org/compare.html?start=4a365a29d64bec75d107214319a129ba68fc12a3&amp;end=7830caefb62c9c8d3fb7a742c66c64c89bf3aafe&amp;stat=wall-time">https://perf.rust-lang.org/compare.html?start=4a365a29d64bec75d107214319a129ba68fc12a3&amp;end=7830caefb62c9c8d3fb7a742c66c64c89bf3aafe&amp;stat=wall-time</a> again</p>



<a name="177913882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913882">(Oct 11 2019 at 14:48)</a>:</h4>
<p>I guess the other question is whether people have other ideas for tackling the problems <span class="user-mention" data-user-id="116466">@Zoxc</span>  is trying to tackle, which reminds me that I think it'd be good to define those a bit more closely (you mentioned timing in incremental benchmarks, <span class="user-mention" data-user-id="116466">@Zoxc</span>, can you elaborate a bit more?)</p>



<a name="177913956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177913956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177913956">(Oct 11 2019 at 14:49)</a>:</h4>
<p>The documentation in the rustc-guide should also be updated if the PR lands</p>



<a name="177914040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> qmx <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914040">(Oct 11 2019 at 14:50)</a>:</h4>
<p>one thing that got me wondering: do we have rough figures on the footprint of the depgraph, both in memory and in disk?</p>



<a name="177914046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914046">(Oct 11 2019 at 14:50)</a>:</h4>
<div class="message_inline_image"><a href="https://media.giphy.com/media/5wWf7H89PisM6An8UAU/source.gif" target="_blank" title="https://media.giphy.com/media/5wWf7H89PisM6An8UAU/source.gif"><img src="https://media.giphy.com/media/5wWf7H89PisM6An8UAU/source.gif"></a></div>



<a name="177914074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914074">(Oct 11 2019 at 14:50)</a>:</h4>
<p>also the wins in the PR might go away on a fully loaded system, right? because we are offloading work to the background</p>



<a name="177914088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914088">(Oct 11 2019 at 14:50)</a>:</h4>
<p>I don't want to waste time writing the entire dep graph and query result cache to disk each execution. In the clean incremental benchmark pretty much nothing changes so it's extremely wasteful.</p>



<a name="177914167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914167">(Oct 11 2019 at 14:51)</a>:</h4>
<p><span class="user-mention" data-user-id="124287">@mw</span> The instruction count regresses only slightly though, so at worst it will be pretty close.</p>



<a name="177914221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914221">(Oct 11 2019 at 14:52)</a>:</h4>
<blockquote>
<p>one thing that got me wondering: do we have rough figures on the footprint of the depgraph, both in memory and in disk?</p>
</blockquote>
<p>I was wondering the same thing, I don't know the answer, but I know that I have had trouble with huge amounts of incremental data from time to time. I don't know that this PR will affect that, I guess it could a <em>little</em> but I assume it's mostly from serialized reuslts and not the graph itself.</p>



<a name="177914224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914224">(Oct 11 2019 at 14:52)</a>:</h4>
<p>We pretty much move work from the query system to the background thread.</p>



<a name="177914240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914240">(Oct 11 2019 at 14:52)</a>:</h4>
<blockquote>
<p>I don't want to waste time writing the entire dep graph and query result cache to disk each execution. In the clean incremental benchmark pretty much nothing changes so it's extremely wasteful.</p>
</blockquote>
<p>This does feel like a very solid motivation :)</p>



<a name="177914277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914277">(Oct 11 2019 at 14:53)</a>:</h4>
<p>I remember <span class="user-mention" data-user-id="124287">@mw</span> you and I talking a bit about things like "mmap'ing" incremental results (or at least making it so that loading and saving is very cheap)</p>



<a name="177914337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914337">(Oct 11 2019 at 14:53)</a>:</h4>
<p>It feels like this PR by <span class="user-mention" data-user-id="116466">@Zoxc</span> also moves in that direction, since mutating the graph is more in line with that? (I guess it's somewhat separable)</p>



<a name="177914341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914341">(Oct 11 2019 at 14:53)</a>:</h4>
<p>Memory stats from <a href="https://github.com/rust-lang/rust/pull/60035" target="_blank" title="https://github.com/rust-lang/rust/pull/60035">https://github.com/rust-lang/rust/pull/60035</a>: <a href="https://perf.rust-lang.org/compare.html?start=eeedd3a6e15d43d0cd3e860f36be737cb2c941ca&amp;end=cfe977fc791e1a9305d2b79e47b448dfa50abb4a&amp;stat=max-rss" target="_blank" title="https://perf.rust-lang.org/compare.html?start=eeedd3a6e15d43d0cd3e860f36be737cb2c941ca&amp;end=cfe977fc791e1a9305d2b79e47b448dfa50abb4a&amp;stat=max-rss">https://perf.rust-lang.org/compare.html?start=eeedd3a6e15d43d0cd3e860f36be737cb2c941ca&amp;end=cfe977fc791e1a9305d2b79e47b448dfa50abb4a&amp;stat=max-rss</a></p>



<a name="177914420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914420">(Oct 11 2019 at 14:54)</a>:</h4>
<p>This is because we don't have to retain the old graph in memory?</p>



<a name="177914439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914439">(Oct 11 2019 at 14:54)</a>:</h4>
<p>The new dep graph is only on disk. The old is still in memory.</p>



<a name="177914444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914444">(Oct 11 2019 at 14:54)</a>:</h4>
<p>In <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a>, <span class="user-mention" data-user-id="116466">@Zoxc</span>, do we always dump out a full new graph each time?</p>



<a name="177914464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914464">(Oct 11 2019 at 14:54)</a>:</h4>
<blockquote>
<p>I remember <span class="user-mention silent" data-user-id="124287">mw</span> you and I talking a bit about things like "mmap'ing" incremental results (or at least making it so that loading and saving is very cheap)</p>
</blockquote>
<p>Yes, a while ago. That would be independent of making the graph more incremental</p>



<a name="177914469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914469">(Oct 11 2019 at 14:54)</a>:</h4>
<blockquote>
<p>The new dep graph is only on disk. The old is still in memory.</p>
</blockquote>
<p>yeah, sorry, I meant to say the <em>whole</em> graph</p>



<a name="177914470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914470">(Oct 11 2019 at 14:54)</a>:</h4>
<p>Which suggest that most of the compiler memory usage is just the dep graph in some cases...</p>



<a name="177914553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914553">(Oct 11 2019 at 14:55)</a>:</h4>
<blockquote>
<p>In <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a>, <span class="user-mention silent" data-user-id="116466">Zoxc</span>, do we always dump out a full new graph each time?</p>
</blockquote>
<p>in other words, how I am understanding this PR is something like this:</p>
<ul>
<li>load old dep graph</li>
<li>as we "evaluate" the new graph, dump out the nodes but we don't actively keep them in memory</li>
<li>at the end, we have a new graph and can delete the old one</li>
</ul>



<a name="177914568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914568">(Oct 11 2019 at 14:55)</a>:</h4>
<p>this is based on basically zero reading of the PR itself :)</p>



<a name="177914624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914624">(Oct 11 2019 at 14:56)</a>:</h4>
<p>so feel free to correct me</p>



<a name="177914736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914736">(Oct 11 2019 at 14:57)</a>:</h4>
<p>We only 'dump' out nodes that changed or a new relative to the old dep graph, but it otherwise sounds right.</p>



<a name="177914759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914759">(Oct 11 2019 at 14:57)</a>:</h4>
<p>Do we delete nodes from the old graph?</p>



<a name="177914844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914844">(Oct 11 2019 at 14:58)</a>:</h4>
<p>No. We delete the entire old graph from the disk (and all incremental state) from the previous session.</p>



<a name="177914906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914906">(Oct 11 2019 at 14:59)</a>:</h4>
<p>The old dep graph is read-only in memory and doesn't change.</p>



<a name="177914937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177914937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177914937">(Oct 11 2019 at 14:59)</a>:</h4>
<p>So if something doesn't change, and we delete it, but don't write a new copy, what happens to it?</p>



<a name="177915072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915072">(Oct 11 2019 at 15:00)</a>:</h4>
<p>We make a copy of the entire incremental state in the start of the compiler, and we only mutate that copy of the dep graph</p>



<a name="177915139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915139">(Oct 11 2019 at 15:01)</a>:</h4>
<p>OK I don't understand but it doesn't matter</p>



<a name="177915151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915151">(Oct 11 2019 at 15:01)</a>:</h4>
<p>I started taking some notes on "conclusions" in the hackmd</p>



<a name="177915161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915161">(Oct 11 2019 at 15:01)</a>:</h4>
<p>pasting current status here</p>



<a name="177915163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915163">(Oct 11 2019 at 15:01)</a>:</h4>
<ul>
<li>We had a good discussion of the PR in question. I don't think we raised any red flags or anything, the approach seems solid.</li>
<li>The real question is whether we want to move in he <strong>overall direction</strong> proposed by <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a></li>
<li>The goal here is to reduce the cost of loading/saving the dep-graph</li>
<li><a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> proposed to do so by incrementally dumping out changed nodes and not retaining them in memory</li>
<li>
<p>This we barely touched on -- some open questions for me<br>
    * Are there alternative designs we have in mind?<br>
    * Is <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> itself an "end state" or a stepping stone?</p>
</li>
<li>
<p>Conclusion:<br>
    * Follow-up meeting to dig into design of <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a> and maybe discuss alternatives<br>
    * In parallel, Niko will review <a href="https://github.com/rust-lang/rust/issues/62038" target="_blank" title="https://github.com/rust-lang/rust/issues/62038">#62038</a></p>
</li>
</ul>



<a name="177915198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915198">(Oct 11 2019 at 15:01)</a>:</h4>
<p>In particular, the "conclusion" there is kind of a "what do you all think of this"?</p>



<a name="177915243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915243">(Oct 11 2019 at 15:02)</a>:</h4>
<p>Ah we did not discuss documentation</p>



<a name="177915289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915289">(Oct 11 2019 at 15:02)</a>:</h4>
<p>I think we should make the graph and the result cache more incremental</p>



<a name="177915296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915296">(Oct 11 2019 at 15:02)</a>:</h4>
<p>But I think I've made clear what I Think we sohuld do there and we can discuss it somewhat separately</p>



<a name="177915327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915327">(Oct 11 2019 at 15:02)</a>:</h4>
<p>I would like a more detailed description of what the final state looks like</p>



<a name="177915372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915372">(Oct 11 2019 at 15:02)</a>:</h4>
<p>To be clear, I am not proposing to land <a href="https://github.com/rust-lang/rust/issues/62038" target="_blank" title="https://github.com/rust-lang/rust/issues/62038">#62038</a> before we discuss <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a></p>



<a name="177915375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915375">(Oct 11 2019 at 15:02)</a>:</h4>
<p>i.e. the incremental file format for the dep graph</p>



<a name="177915400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915400">(Oct 11 2019 at 15:03)</a>:</h4>
<p>But I thought it would be useful to do some review of it while my understanding is fresh :)</p>



<a name="177915449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915449">(Oct 11 2019 at 15:03)</a>:</h4>
<p>regarding <a href="https://github.com/rust-lang/rust/issues/62038" target="_blank" title="https://github.com/rust-lang/rust/issues/62038">#62038</a>, it does regress memory usage quite a bit in some cases: <a href="https://perf.rust-lang.org/compare.html?start=4a365a29d64bec75d107214319a129ba68fc12a3&amp;end=7830caefb62c9c8d3fb7a742c66c64c89bf3aafe&amp;stat=max-rss" target="_blank" title="https://perf.rust-lang.org/compare.html?start=4a365a29d64bec75d107214319a129ba68fc12a3&amp;end=7830caefb62c9c8d3fb7a742c66c64c89bf3aafe&amp;stat=max-rss">https://perf.rust-lang.org/compare.html?start=4a365a29d64bec75d107214319a129ba68fc12a3&amp;end=7830caefb62c9c8d3fb7a742c66c64c89bf3aafe&amp;stat=max-rss</a></p>



<a name="177915479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915479">(Oct 11 2019 at 15:03)</a>:</h4>
<p>That's useful data</p>



<a name="177915746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915746">(Oct 11 2019 at 15:06)</a>:</h4>
<p>So <span class="user-mention" data-user-id="116466">@Zoxc</span> how do you feel about the plan of </p>
<ul>
<li>reviewing <a href="https://github.com/rust-lang/rust/issues/60238" target="_blank" title="https://github.com/rust-lang/rust/issues/60238">#60238</a> but not landing before we</li>
<li>discuss <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a>, which means we should do some prep on documenting the details</li>
</ul>
<p>I would expect to hold a follow-up meeting in ~3 weeks -- next week is busy, week after that is planning meeting. But that seems ok.</p>



<a name="177915836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915836">(Oct 11 2019 at 15:06)</a>:</h4>
<p>And I guess I want to know if there are alternative designs in mind :)</p>



<a name="177915848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915848">(Oct 11 2019 at 15:06)</a>:</h4>
<p>Or anyone has strong objections to this change</p>



<a name="177915860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915860">(Oct 11 2019 at 15:06)</a>:</h4>
<p>(Feel free to message me privately if you prefer :)</p>



<a name="177915877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915877">(Oct 11 2019 at 15:07)</a>:</h4>
<p>It seems fine given that <a href="https://github.com/rust-lang/rust/pull/62038" target="_blank" title="https://github.com/rust-lang/rust/pull/62038">https://github.com/rust-lang/rust/pull/62038</a> has drawbacks fixed by <a href="https://github.com/rust-lang/rust/pull/60035" target="_blank" title="https://github.com/rust-lang/rust/pull/60035">https://github.com/rust-lang/rust/pull/60035</a>.</p>



<a name="177915944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915944">(Oct 11 2019 at 15:07)</a>:</h4>
<p>Yes, I was going to mention that</p>



<a name="177915954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177915954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177915954">(Oct 11 2019 at 15:07)</a>:</h4>
<p>it'd be best to land them in close succession</p>



<a name="177916017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916017">(Oct 11 2019 at 15:08)</a>:</h4>
<p>OK, I gotta go. I've occupied this cafe seat for too long.</p>



<a name="177916039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916039">(Oct 11 2019 at 15:08)</a>:</h4>
<p>I'm not sure the drawback are that severe, but we should decide that we want to do something like 60035.</p>



<a name="177916048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916048">(Oct 11 2019 at 15:08)</a>:</h4>
<p>for the next discussion we might want to think about whether we also want to tackle saving the dep-graph if compilation errors or if that is off the table for the time being</p>



<a name="177916086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916086">(Oct 11 2019 at 15:08)</a>:</h4>
<p>I do think we want something like <a href="https://github.com/rust-lang/rust/issues/60035" target="_blank" title="https://github.com/rust-lang/rust/issues/60035">#60035</a></p>



<a name="177916111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916111">(Oct 11 2019 at 15:08)</a>:</h4>
<p>Yes, I want to spend a bit of time trying to prepare for next discussion, <span class="user-mention" data-user-id="124287">@mw</span> and <span class="user-mention" data-user-id="116466">@Zoxc</span></p>



<a name="177916137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916137">(Oct 11 2019 at 15:09)</a>:</h4>
<p>but I'd like to have a clearer picture and some evaluation of it</p>



<a name="177916140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916140">(Oct 11 2019 at 15:09)</a>:</h4>
<p>let's create a hackmd talk and I'll reach out to you all to schedule some time to take notes in it</p>



<a name="177916188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916188">(Oct 11 2019 at 15:09)</a>:</h4>
<p>ok, seems like we're on same page, I feel the same -- this work seems to be in the right direction; I'd like to understand it better, but overall I'm feeling positive</p>



<a name="177916302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916302">(Oct 11 2019 at 15:10)</a>:</h4>
<p>I also want to give a shout out to <span class="user-mention" data-user-id="116466">@Zoxc</span> for pursuing so much of this work. It's very cool stuff. =)</p>



<a name="177916597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916597">(Oct 11 2019 at 15:13)</a>:</h4>
<p>alright, thanks everyone! I think it is very useful to discussion bigger changes like the ones proposed here!</p>



<a name="177916609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/design%20meeting%202019-10-11/near/177916609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/design.20meeting.202019-10-11.html#177916609">(Oct 11 2019 at 15:13)</a>:</h4>
<p>/me needs to run</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>