<html>
<head><meta charset="utf-8"><title>`ReadOnlyBodyAndCache` ergonomics · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html">`ReadOnlyBodyAndCache` ergonomics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="191950494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191950494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191950494">(Mar 26 2020 at 21:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116114">@Paul Faria</span>  Why do I need a <code>ReadOnlyBodyAndCache</code> to immutably visit a MIR body?</p>



<a name="191951999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191951999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191951999">(Mar 26 2020 at 21:32)</a>:</h4>
<p>So there was work done for the parallelization effort to remove interior mutability since it would cause issues with parallelization. I had worked through this design with Oli (can't find his handle at the moment). Unfortunately the maintainable version required the cache and body to be independent, but still tracked together.</p>



<a name="191952035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191952035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191952035">(Mar 26 2020 at 21:33)</a>:</h4>
<p>The cache lazily computes some cases on read, which is why it affects immutable Mir bodies.</p>



<a name="191952291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191952291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191952291">(Mar 26 2020 at 21:35)</a>:</h4>
<p>At the moment, the cache holds only the predecessors of each basic block (reverse CFG). When would we need to access this when immutably visiting a MIR body?</p>



<a name="191952492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191952492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191952492">(Mar 26 2020 at 21:37)</a>:</h4>
<p>Also, <code>ReadOnlyBodyAndCache</code> can't recompute anything lazily, since it just has a <code>&amp;Cache</code>.</p>



<a name="191952619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191952619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191952619">(Mar 26 2020 at 21:39)</a>:</h4>
<p>My mistake, I made the comment without reviewing the code. In that case there are some usages where the visitors read the data from the cache, but it's guaranteed to have already been precomputed. This is the PR where this went in for reference: <a href="https://github.com/rust-lang/rust/pull/64736" title="https://github.com/rust-lang/rust/pull/64736">https://github.com/rust-lang/rust/pull/64736</a></p>



<a name="191952921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191952921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191952921">(Mar 26 2020 at 21:42)</a>:</h4>
<p>I believe I tried making versions where the cache wasn't needed so &amp;Body could be passed through, but there were so many interdependencies that I could never get it to compile. There were other version proposed that didn't require these explicits types, but they were much more fragile in the sense that a change in one part of the compiler could inadvertently cause a panic in another (I believe this was when we experimented with manually clearing and recomputing the cache at certain points during compilation).</p>



<a name="191952955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191952955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191952955">(Mar 26 2020 at 21:42)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span>  (not sure why, but couldn't link you in the earlier comment on Mobile)</p>



<a name="191953763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191953763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191953763">(Mar 26 2020 at 21:51)</a>:</h4>
<p>If you're working on something I've got plenty of free time the next few days to pair if that would help.</p>



<a name="191954605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191954605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191954605">(Mar 26 2020 at 22:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116114">@Paul Faria</span> Can you point me to a place in the code or a comment that illustrates why<code>visit_body</code> doesn't take <code>&amp;mir::Body</code>? If we need to always keep a reference to the predecessor cache with the body, why do we still pass a plain <code>mir::Body</code> anywhere?</p>



<a name="191954953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191954953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191954953">(Mar 26 2020 at 22:05)</a>:</h4>
<p>My assumption was that <code>ReadOnlyBodyAndCache</code> would gradually replace <code>&amp;mir::Body</code> throughout the codebase and then be renamed to <code>BodyRef</code>, since having to choose whether each function takes <code>&amp;mir::Body</code> or <code>ReadOnlyBodyAndCache</code> is minorly annoying. Do you recall discussing this? Do you also find the status quo confusing or am I alone in this?</p>



<a name="191958175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191958175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191958175">(Mar 26 2020 at 22:40)</a>:</h4>
<p>I agree with you that it is not easy to work with, there were easier proposals, but they made me very uncomfortable regarding the panics I mentioned above. I had some personal events occur that kept me from working on this for the last few months, so I'll have to review the code to see if/where there's a comment describing the behavior (I'll take care of that tomorrow since I'll be on and off tonight). I might have only changed Body to BodyAndCache where it was required simply because it touched so many pieces of the compiler, and I wanted to minimize the impact of the initial change.</p>



<a name="191958218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191958218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191958218">(Mar 26 2020 at 22:41)</a>:</h4>
<p>I definitely hadn't intended to stop there, but the personal events took up all of my spare time for the last few months. As of earlier this week that all opened up so I'll have lots of free time to continue the work on this.</p>



<a name="191958543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191958543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191958543">(Mar 26 2020 at 22:45)</a>:</h4>
<p>No worries. If you can't think of a reason not to, I'll have a go at changing the signature of <code>visit_body</code>.</p>



<a name="191958681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191958681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191958681">(Mar 26 2020 at 22:47)</a>:</h4>
<p>As for broader changes, there's no rush, I just wanted to know if there's a longer-term plan in place.</p>



<a name="191960525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191960525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191960525">(Mar 26 2020 at 23:10)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> already tried that in the <code>--bless</code> <code>mir-opt</code> PR and I think it works</p>



<a name="191960542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191960542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191960542">(Mar 26 2020 at 23:10)</a>:</h4>
<p>but I had him use a <code>TypeVisitor</code> instead for more correctness and smaller diff</p>



<a name="191960859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/191960859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#191960859">(Mar 26 2020 at 23:15)</a>:</h4>
<p>See  <a href="https://github.com/rust-lang/rust/issues/70449" title="https://github.com/rust-lang/rust/issues/70449">#70449</a>, which does the bare minimum. I could change some of the surrounding function signatures back as well, but it's not a high priority.</p>



<a name="192015452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192015452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192015452">(Mar 27 2020 at 13:22)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> I like the change. Looks like it will be easier to use visitors.</p>



<a name="192196749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192196749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192196749">(Mar 29 2020 at 22:12)</a>:</h4>
<p>So every time I create a <code>ReadOnlyBodyAndCache</code>, I have to populate the cache. This means that before <a href="https://github.com/rust-lang/rust/issues/70449" title="https://github.com/rust-lang/rust/issues/70449">#70449</a> every time I needed to call a <code>Visitor</code> impl, we had to compute the reverse CFG. Is this correct? This seems very wasteful.</p>



<a name="192196867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192196867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192196867">(Mar 29 2020 at 22:15)</a>:</h4>
<p>(<a href="https://github.com/rust-lang/rust/issues/70449" title="https://github.com/rust-lang/rust/issues/70449">#70449</a> doesn't actually remove any uses of <code>ReadOnlyBodyAndCache</code>, so there's no perf benefits, but someone could go in now and remove them)</p>



<a name="192441093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192441093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192441093">(Mar 31 2020 at 19:53)</a>:</h4>
<p>It just ensures that the cache is precomputed before you can create a <code>ReadOnlyBodyAndCache</code>.  If it was already computed before, then it's a no-op.</p>



<a name="192441200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192441200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192441200">(Mar 31 2020 at 19:54)</a>:</h4>
<p>So if you create two <code>ReadOnlyBodyAndCache</code> from one <code>BodyAndCache</code>, the cache should only be computed once, not twice.</p>



<a name="192449696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192449696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192449696">(Mar 31 2020 at 21:07)</a>:</h4>
<p>Said another way, what percentage of the times when I'm forced to create a <code>ReadOnlyBodyAndCache</code> to call <code>visit_body</code>do I actually use it to look at predecessors?</p>



<a name="192464372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192464372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192464372">(Mar 31 2020 at 23:03)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="116114">@Paul Faria</span>  I'd like to revert <a href="https://github.com/rust-lang/rust/issues/64736" title="https://github.com/rust-lang/rust/issues/64736">#64736</a> in favor of a <code>Mutex&lt;Option&lt;...&gt;&gt;</code> to hold the predecessors cache. With the current solution, each function which doesn't need mutable access to a given <code>Body</code> must encode whether any of its callees plan to compute the reverse CFG  into its type signature. This makes things like adding support for backward dataflow analyses to the current framework, which I am working on today, more difficult than it should be. Only backward dataflow analyses need access to the reverse CFG, but I am forced to either precompute the predecessor graph for <em>all</em> analyses (<code>ReadOnlyBodyAndCache</code>), or keep around a mutable reference to the body (<code>&amp;mut BodyAndCache</code>) so I can compute it on demand, despite the fact that dataflow does not actually mutate the MIR.</p>



<a name="192464648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192464648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192464648">(Mar 31 2020 at 23:07)</a>:</h4>
<p>Invalidating the predecessor cache won't actually require taking the lock, since any operation that would invalidate the cache requires a unique reference (<code>&amp;mut</code>) to the MIR anyway. That means we only actually lock when calling <code>predecessors</code>, and I don't think it's worth the current complexity to avoid a few uncontended mutex operations.</p>



<a name="192475910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192475910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192475910">(Apr 01 2020 at 01:55)</a>:</h4>
<p>The only other parts of the compiler that might be affected are in <code>librustc_codegen_ssa</code> and <code>librustc_mir/borrow_check</code>. I can't remember how it was all tied together at the moment, but do you think it would cause any issues with those parts of the compiler? It definitely sounds easier to use than what I came up with, and I think none of the stages will affect the same body simultaneously. I think <span class="user-mention" data-user-id="124288">@oli</span> can speak best to that.</p>



<a name="192495291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192495291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192495291">(Apr 01 2020 at 08:10)</a>:</h4>
<p>Hmm... While I do like the typed approach we have right now, it is a lot of complexity...</p>



<a name="192495425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192495425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192495425">(Apr 01 2020 at 08:12)</a>:</h4>
<p>Another alternative would be to just move the cache back into the body and force run the predecessor computation at the end of <code>optimized_mir</code></p>



<a name="192569634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192569634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192569634">(Apr 01 2020 at 18:08)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span>  was that the version where we had to manually recompute the cache rather than it being computed on demand? I vaguely remember running into hidden panics because it wasn't always obvious where a part of the compiler might invalidate the cache. If so, I also remember worrying about future changes to the compiler possibly causing panics in areas of code unrelated to the changes. My concern was that would be even more complicated to debug because it wouldn't be obvious to anyone not familiar with the cache.</p>



<a name="192714725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192714725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192714725">(Apr 02 2020 at 19:33)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Thoughts? We still need a solution for computing predecessors during borrow checking and the optimization pipeline. It would be much easier if this could be done without requiring <code>&amp;mut Body</code> in these places.</p>



<a name="192714913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192714913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192714913">(Apr 02 2020 at 19:35)</a>:</h4>
<p>I suggested something at some point but I forget where</p>



<a name="192714951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192714951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192714951">(Apr 02 2020 at 19:35)</a>:</h4>
<p>which would handle terminators differently</p>



<a name="192714976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192714976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192714976">(Apr 02 2020 at 19:35)</a>:</h4>
<p>and replacing a terminator would automatically adjust predecessors, incrementally</p>



<a name="192715006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192715006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192715006">(Apr 02 2020 at 19:35)</a>:</h4>
<p>i.e. make MIR a managed (control-flow) graph</p>



<a name="192715025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192715025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192715025">(Apr 02 2020 at 19:35)</a>:</h4>
<p>instead of doing full recomptations after invalidations</p>



<a name="192715102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192715102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192715102">(Apr 02 2020 at 19:36)</a>:</h4>
<p>you could never get a <code>&amp;mut Terminator</code></p>



<a name="192715164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192715164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192715164">(Apr 02 2020 at 19:37)</a>:</h4>
<p>but instead you'd have e.g. <code>TerminatorMutRef&lt;'a&gt;</code> instead of <code>&amp;'a mut Terminator</code> or w/e, without being able to mutate the <code>BasicBlock</code> destinations</p>



<a name="192716402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192716402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192716402">(Apr 02 2020 at 19:47)</a>:</h4>
<p>That would be ideal. Since the predecessor graph would always be computed and up-to-date, <code>&amp;Body</code> could be used everywhere. However, it's going to be a lot of work to audit all existing callers of <code>basic_blocks_mut</code>, and I would like to find a stopgap solution.</p>



<a name="192716438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192716438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192716438">(Apr 02 2020 at 19:47)</a>:</h4>
<p>well, you wouldn't audit, you'd just hammer them to fit the new API shape :P</p>



<a name="192716513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192716513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192716513">(Apr 02 2020 at 19:48)</a>:</h4>
<p>they don't have to cooperate to preserve correctness, they can be forced to use an API that does</p>



<a name="192716648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192716648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192716648">(Apr 02 2020 at 19:49)</a>:</h4>
<p>Replace audit with update then</p>



<a name="192717009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/192717009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#192717009">(Apr 02 2020 at 19:52)</a>:</h4>
<p>That sounds like work I might enjoy, if no one else gets to it</p>



<a name="193670696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193670696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193670696">(Apr 11 2020 at 17:31)</a>:</h4>
<p>I'm going to submit a PR replacing <code>BodyAndCache</code> with interior mutability on <code>Body</code>. Besides helping me finish backward dataflow, it will be easier to migrate to the incremental approach, which will also use only a single type.</p>



<a name="193672414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672414">(Apr 11 2020 at 18:13)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> so basically we're reverting the BodyAndCache approach?</p>



<a name="193672454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672454">(Apr 11 2020 at 18:14)</a>:</h4>
<p>oh I see by incremental you mean the "managed CFG" approach</p>



<a name="193672460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672460">(Apr 11 2020 at 18:14)</a>:</h4>
<p>where you never get direct mutable access to <code>BasicBlock</code> targets in a <code>TerminatorKind</code></p>



<a name="193672470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672470">(Apr 11 2020 at 18:14)</a>:</h4>
<p>Yeah,  and by "incremental" I meant the approach you proposed</p>



<a name="193672491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672491">(Apr 11 2020 at 18:15)</a>:</h4>
<p>why did we even go to <code>BodyAndCache</code>? the parallelism effort to remove locks?</p>



<a name="193672537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672537">(Apr 11 2020 at 18:16)</a>:</h4>
<p>Correct. The choice was between <code>Mutex&lt;PredecessorCache&gt;</code> and the status quo.</p>



<a name="193672540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672540">(Apr 11 2020 at 18:16)</a>:</h4>
<p>well, not <code>Mutex</code></p>



<a name="193672549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672549">(Apr 11 2020 at 18:16)</a>:</h4>
<p>Do we have a custom lock type?</p>



<a name="193672550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672550">(Apr 11 2020 at 18:16)</a>:</h4>
<p>there are special types that are <code>Cell</code>/<code>RefCell</code> when parallelism isn't enabled</p>



<a name="193672556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672556">(Apr 11 2020 at 18:17)</a>:</h4>
<p>everything uses those</p>



<a name="193672558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672558">(Apr 11 2020 at 18:17)</a>:</h4>
<p>IIRC the name might be <code>Lock</code> for what's needed here</p>



<a name="193672568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672568">(Apr 11 2020 at 18:17)</a>:</h4>
<p>it wouldn't hurt to name them <code>CellOrAtomic</code>, <code>RefCellOrMutex</code> and <code>RefCellOrRwLock</code> :P</p>



<a name="193672637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672637">(Apr 11 2020 at 18:18)</a>:</h4>
<p>also <code>Lrc</code> would be <code>RcOrArc</code></p>



<a name="193672666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672666">(Apr 11 2020 at 18:19)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span>  How about <code>Arrc&lt;T&gt;</code> <span aria-label="pirate" class="emoji emoji-2620" role="img" title="pirate">:pirate:</span>  ? ;)</p>



<a name="193672672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672672">(Apr 11 2020 at 18:19)</a>:</h4>
<p>... the point is to be clear about what it is :P</p>



<a name="193672716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193672716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193672716">(Apr 11 2020 at 18:20)</a>:</h4>
<p>IIRC the L in <code>Lrc</code> doesn't really mean anything</p>



<a name="193680899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193680899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193680899">(Apr 11 2020 at 21:38)</a>:</h4>
<p>Doing a perf run on <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> now.</p>



<a name="193680909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/193680909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#193680909">(Apr 11 2020 at 21:38)</a>:</h4>
<p>I think perf uses the single-threaded compiler? So this will only give part of the picture.</p>



<a name="194298586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194298586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194298586">(Apr 16 2020 at 12:54)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> any way I can help out? I started a new job recently, so I was unavailable the last few weeks. I should have time now, a couple hours before and after work (US EST timezone atm)</p>



<a name="194299614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194299614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194299614">(Apr 16 2020 at 13:02)</a>:</h4>
<p>If not I'll just help out rustc-dev-guide for the time being</p>



<a name="194328804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194328804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194328804">(Apr 16 2020 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116114">@Paul Faria</span> <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> is a small regression in performance. Do you recall whether the original PR that replaced the <code>RefCell</code> had any perf impact? <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> is equivalent to the <code>RefCell</code> approach for the single-threaded compiler, which I'm pretty sure what is used by <a href="http://perf.rust-lang.org" title="http://perf.rust-lang.org">perf.rust-lang.org</a></p>



<a name="194329100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194329100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194329100">(Apr 16 2020 at 16:11)</a>:</h4>
<p>AFAICT, the regression is in <code>metadata_register_crate</code>, so it's encoding/decoding that's slow.</p>



<a name="194329515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194329515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194329515">(Apr 16 2020 at 16:15)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> I think we don't (or used to not) encode caches and we don't (or used to not) compute them on decoding</p>



<a name="194329722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194329722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194329722">(Apr 16 2020 at 16:16)</a>:</h4>
<p>Yeah <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> includes the old no-op impls for encoding/decoding: <a href="https://github.com/rust-lang/rust/pull/71044/commits/b3922699b9744f0b894d8309f8d107859d1cfa83#diff-f3e3c79bda8c6a5aa3cd4fa1f57c002cR47" title="https://github.com/rust-lang/rust/pull/71044/commits/b3922699b9744f0b894d8309f8d107859d1cfa83#diff-f3e3c79bda8c6a5aa3cd4fa1f57c002cR47">https://github.com/rust-lang/rust/pull/71044/commits/b3922699b9744f0b894d8309f8d107859d1cfa83#diff-f3e3c79bda8c6a5aa3cd4fa1f57c002cR47</a></p>



<a name="194330390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194330390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194330390">(Apr 16 2020 at 16:21)</a>:</h4>
<p>I also added some <code>#[inline]</code>, which helped a bit. I just found an <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/query/on_disk_cache.rs#L925" title="https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/query/on_disk_cache.rs#L925"><code>emit_unit</code></a> impl that is used cross-crate but not <code>#[inline]</code>. I'll fix that.</p>



<a name="194330469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194330469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194330469">(Apr 16 2020 at 16:21)</a>:</h4>
<p>oh dear</p>



<a name="194330527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194330527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194330527">(Apr 16 2020 at 16:21)</a>:</h4>
<p>/me forgets about <code>#[inline]</code> all the time</p>



<a name="194331653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194331653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194331653">(Apr 16 2020 at 16:29)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> These primitive impls would likely benefit from inlining as well right?<br>
<a href="https://github.com/rust-lang/rust/blob/4e4d49d60fd696c4036d438292673a2d7fd34519/src/libserialize/serialize.rs#L391" title="https://github.com/rust-lang/rust/blob/4e4d49d60fd696c4036d438292673a2d7fd34519/src/libserialize/serialize.rs#L391">https://github.com/rust-lang/rust/blob/4e4d49d60fd696c4036d438292673a2d7fd34519/src/libserialize/serialize.rs#L391</a></p>



<a name="194331693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194331693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194331693">(Apr 16 2020 at 16:29)</a>:</h4>
<p>but those get inlined already, don't they?</p>



<a name="194331724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194331724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194331724">(Apr 16 2020 at 16:30)</a>:</h4>
<p>the methods are generic</p>



<a name="194331774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194331774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194331774">(Apr 16 2020 at 16:30)</a>:</h4>
<p>Ah yes. My bad</p>



<a name="194331827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194331827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194331827">(Apr 16 2020 at 16:30)</a>:</h4>
<p>it's only <code>emit_foo</code> in a non-generic <code>impl</code> that's the problem</p>



<a name="194332539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194332539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194332539">(Apr 16 2020 at 16:35)</a>:</h4>
<p>Oooh. I found a gem: <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/query/on_disk_cache.rs#L910" title="https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/query/on_disk_cache.rs#L910">https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/query/on_disk_cache.rs#L910</a></p>



<a name="194332652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194332652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194332652">(Apr 16 2020 at 16:36)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">encoder_methods</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$($name</span>:<span class="nc">ident</span><span class="p">(</span><span class="cp">$ty</span>:<span class="nc">ty</span><span class="p">);)</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">        </span><span class="cp">$(</span><span class="k">fn</span> <span class="cp">$name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="cp">$ty</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Self</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">encoder</span><span class="p">.</span><span class="cp">$name</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="o">*</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="194333250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194333250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194333250">(Apr 16 2020 at 16:41)</a>:</h4>
<p>at least the first one's fast XD</p>



<a name="194388679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194388679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194388679">(Apr 17 2020 at 01:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">ecstatic-morse</span> <a href="#narrow/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics/near/194328804" title="#narrow/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics/near/194328804">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116114">Paul Faria</span> <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> is a small regression in performance. Do you recall whether the original PR that replaced the <code>RefCell</code> had any perf impact? <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> is equivalent to the <code>RefCell</code> approach for the single-threaded compiler, which I'm pretty sure what is used by <a href="http://perf.rust-lang.org" title="http://perf.rust-lang.org">perf.rust-lang.org</a></p>
</blockquote>
<p>I remember doing a perf analysis with <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> months ago and we saw that there was no major changes in perf. I don't remember if this was before or after I addressed all of the comments though. There could have been other changes since then that maybe have a different impact now? I remember wanting to go back and review which fns needed to be marked inline, but never had time to take care of that.</p>



<a name="194388850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194388850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Faria <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194388850">(Apr 17 2020 at 02:00)</a>:</h4>
<p>We had run it, but the results aren't available anymore: <a href="https://github.com/rust-lang/rust/pull/64736#issuecomment-548308975" title="https://github.com/rust-lang/rust/pull/64736#issuecomment-548308975">https://github.com/rust-lang/rust/pull/64736#issuecomment-548308975</a> .</p>



<a name="194395325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194395325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194395325">(Apr 17 2020 at 04:35)</a>:</h4>
<p>Old perf runs are deleted from the server occasionally.</p>



<a name="194701056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194701056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194701056">(Apr 20 2020 at 16:35)</a>:</h4>
<p>Inlining <code>emit_unit</code> fixed the perf problem.</p>



<a name="194741048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194741048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194741048">(Apr 20 2020 at 22:24)</a>:</h4>
<p>I have to say I'm not <em>super</em> psyched to see more mutexes back in, but I won't stand in the way for now</p>



<a name="194741083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194741083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194741083">(Apr 20 2020 at 22:25)</a>:</h4>
<p>That said, I guess I should review the PR, I'd be happy if we can keep the mutex so that it only is held long enough to return an <code>Arc&lt;X&gt;</code> or something</p>



<a name="194741113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194741113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194741113">(Apr 20 2020 at 22:25)</a>:</h4>
<p>as opposed to returning a mutex guard, which seems like it opens the door to deadlocks if you are manipulating two MIRs at once (granted, we rarely do that, and probably never access preds when we do, but still)</p>



<a name="194741140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194741140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194741140">(Apr 20 2020 at 22:25)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="194742820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194742820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194742820">(Apr 20 2020 at 22:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics/near/194741083" title="#narrow/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics/near/194741083">said</a>:</p>
<blockquote>
<p>That said, I guess I should review the PR, I'd be happy if we can keep the mutex so that it only is held long enough to return an <code>Arc&lt;X&gt;</code> or something</p>
</blockquote>
<p>Since you can only mutate the MIR via unique ownership (<code>&amp;mut</code>), I believe we could use an <code>AtomicPtr&lt;PredecessorCache&gt;</code> instead of a <code>Lock&lt;PredecessorCache&gt;</code>. Because invalidating the predecessor cache requires unique ownership of the <code>AtomicPtr</code> as well as the MIR, the invalidator knows that they are responsible for freeing the predecessor cache if one exists. Those with shared ownership would compute the predecessor cache and then compare and swap the result into the <code>AtomicPtr</code>.</p>



<a name="194743119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194743119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194743119">(Apr 20 2020 at 22:50)</a>:</h4>
<p>If a shared owner of the MIR loses a compare-and-swap, they throw away their copy of the predecessor cache and <code>load</code> the one that won the race.</p>



<a name="194743177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194743177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194743177">(Apr 20 2020 at 22:51)</a>:</h4>
<p>Since we always know who is responsible for freeing the cache, there's no need for hazard pointers or epoch-based reclamation or other approaches.</p>



<a name="194743874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194743874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194743874">(Apr 20 2020 at 23:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> ^</p>



<a name="194746165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194746165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194746165">(Apr 20 2020 at 23:39)</a>:</h4>
<p>I guess the single-threaded version of this is <code>Cell&lt;Option&lt;PredecessorCache&gt;&gt;</code> with <code>Cell::set</code>/<code>Cell::get_mut</code>.</p>



<a name="194746712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194746712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194746712">(Apr 20 2020 at 23:47)</a>:</h4>
<p>Err, no. That doesn't quite work. You need to be able to go from a shared reference to the <code>Cell</code> to a shared reference to the predecessor cache.</p>



<a name="194823545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823545">(Apr 21 2020 at 15:58)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> sure, that's kind of a micro-optimization though. THe main thing I wanted was a <code>Mutex&lt;Arc&lt;PredecessorData&gt;&gt;</code> and an API like</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">predecessor_map</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">PredecessorData</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* lazilly compute and return */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="194823570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823570">(Apr 21 2020 at 15:58)</a>:</h4>
<p>it would <em>also</em> be ok to use a CAS, but I'm not very concerned</p>



<a name="194823598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823598">(Apr 21 2020 at 15:59)</a>:</h4>
<p>I am surprised that the mutator always has <code>&amp;mut self</code>, maybe I don't understand what's going on</p>



<a name="194823608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823608">(Apr 21 2020 at 15:59)</a>:</h4>
<p>the main thing I do <em>not</em> want is</p>



<a name="194823644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823644">(Apr 21 2020 at 15:59)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">predecessor_map</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReadGuard</span><span class="o">&lt;</span><span class="na">&#39;_</span><span class="p">,</span><span class="w"> </span><span class="n">PredecessorData</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>



<a name="194823751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823751">(Apr 21 2020 at 16:00)</a>:</h4>
<p>I mean I guess it's not really possible to deadlock, since computing one set of predecessors can't in turn compute another set of predecessors</p>



<a name="194823832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823832">(Apr 21 2020 at 16:00)</a>:</h4>
<p>but I still prefer the <code>Arc</code> setup because it's sort of <em>obvious</em> that it's fine...</p>



<a name="194823919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194823919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194823919">(Apr 21 2020 at 16:01)</a>:</h4>
<p>all that said, the biggest thing I want is clear docs on every mutex explaining </p>
<ol>
<li>Why it's there, who locks it and why</li>
<li>Why it won't lead to deadlocks</li>
</ol>
<p>and further that every mutex is in a private field where one audit the accesses with relative ease</p>



<a name="194825687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194825687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194825687">(Apr 21 2020 at 16:13)</a>:</h4>
<p>That's fine too. Do you want me to r- <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a>? I would prefer to let it land and then switch to <code>Mutex&lt;Arc&lt;PredecessorCache&gt;&gt;</code> in a follow-up PR since <a href="https://github.com/rust-lang/rust/issues/71044" title="https://github.com/rust-lang/rust/issues/71044">#71044</a> is liable to bitrot. AFAIK, we never actually access the predecessor cache for a MIR body concurrently from different threads, so deadlock won't be an issue in the interim.</p>



<a name="194828217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194828217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194828217">(Apr 21 2020 at 16:31)</a>:</h4>
<p>(deleted)</p>



<a name="194831488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194831488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194831488">(Apr 21 2020 at 16:56)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> I am fine with follow-up PR</p>



<a name="194831510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194831510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194831510">(Apr 21 2020 at 16:57)</a>:</h4>
<p>and yeah it's not that I think there is an <em>actual</em> bug</p>



<a name="194831544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194831544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194831544">(Apr 21 2020 at 16:57)</a>:</h4>
<p>it's that, in terms of the parallel work (which is sorta stalled, but yeah) we were going for "guarantee that things are documented and as easily verified as possible"</p>



<a name="194831587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194831587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194831587">(Apr 21 2020 at 16:57)</a>:</h4>
<p>if you want to open an issue to track the refactoring that might be nice</p>



<a name="194831600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194831600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194831600">(Apr 21 2020 at 16:58)</a>:</h4>
<p>For sure. I'm in full agreement with eliminating all potential sources of deadlock.</p>



<a name="194831699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194831699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194831699">(Apr 21 2020 at 16:58)</a>:</h4>
<p>I'm working on the follow-up now XD, so an issue won't be necessary unless you want one for other reasons.</p>



<a name="194837030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/%60ReadOnlyBodyAndCache%60%20ergonomics/near/194837030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/.60ReadOnlyBodyAndCache.60.20ergonomics.html#194837030">(Apr 21 2020 at 17:39)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/71392" title="https://github.com/rust-lang/rust/issues/71392">#71392</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>