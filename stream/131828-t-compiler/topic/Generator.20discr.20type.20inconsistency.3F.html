<html>
<head><meta charset="utf-8"><title>Generator discr type inconsistency? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html">Generator discr type inconsistency?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271822292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271822292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271822292">(Feb 14 2022 at 13:00)</a>:</h4>
<p>Hi, while working on async fn debuginfo I stumbled across something that I can't quite make sense of: Currently debuginfo assumes that generator discriminants are always <code>u32</code>,  as specified in <a href="https://github.com/rust-lang/rust/blob/902e59057ee723dd6fda6e757b408d487a388139/compiler/rustc_middle/src/ty/sty.rs#L691-L695">GeneratorSubsts::discr_ty</a>, but when extracting the tag from the layout, it usually is something smaller. The layout code does indeed use the smallest possible integer type it seems: <a href="https://github.com/rust-lang/rust/blob/902e59057ee723dd6fda6e757b408d487a388139/compiler/rustc_middle/src/ty/layout.rs#L1588">https://github.com/rust-lang/rust/blob/902e59057ee723dd6fda6e757b408d487a388139/compiler/rustc_middle/src/ty/layout.rs#L1588</a></p>
<p>Is this just a bug or am I misunderstanding something here? Both versions seemed to be used in various placed.</p>
<p>Maybe <span class="user-mention" data-user-id="116883">@tmandry</span> would know what's going on?</p>



<a name="271823758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271823758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271823758">(Feb 14 2022 at 13:13)</a>:</h4>
<p>There is a difference between the discriminant and tag. A tag is one possible encoding of a discriminant. Niche filling is another.</p>



<a name="271826749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271826749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271826749">(Feb 14 2022 at 13:40)</a>:</h4>
<p>Which of the two describes how many bytes the discriminant actually takes up in memory (inside of an enum or a generator)?</p>



<a name="271828031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271828031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271828031">(Feb 14 2022 at 13:50)</a>:</h4>
<p>The tag. The tag is the actual encoding of the discriminant in memory if a tagged layout is chosen.</p>



<a name="271837572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271837572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271837572">(Feb 14 2022 at 15:00)</a>:</h4>
<p>Thanks!</p>



<a name="271840117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271840117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271840117">(Feb 14 2022 at 15:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F/near/271828031">said</a>:</p>
<blockquote>
<p>... if a tagged layout is chosen.</p>
</blockquote>
<p>That sounds like it might be different for niche layout enums. Is that true? Currently, the debuginfo code uses <a href="https://github.com/rust-lang/rust/blob/b321742c6c27494897a88cd5ac17ac20aa3469a1/compiler/rustc_codegen_llvm/src/debuginfo/metadata.rs#L2194-L2205">the following code</a> for determining the right integer type for the discriminant:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Variants</span>::<span class="n">Multiple</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tag_encoding</span>: <span class="nc">TagEncoding</span>::<span class="n">Niche</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">tag_field</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Find the integer type of the correct size.</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tag_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">tag</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Int</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">F32</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Integer</span>::<span class="n">I32</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">F64</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Integer</span>::<span class="n">I64</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">Pointer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">cx</span><span class="p">.</span><span class="n">data_layout</span><span class="p">().</span><span class="n">ptr_sized_integer</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">to_ty</span><span class="p">(</span><span class="n">cx</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// other cases omitted</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271840335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271840335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271840335">(Feb 14 2022 at 15:18)</a>:</h4>
<p>That is, it also looks at the tag (and nothing else)</p>



<a name="271842440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271842440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271842440">(Feb 14 2022 at 15:33)</a>:</h4>
<p>IIRC there are 4 possible layouts:</p>
<ul>
<li>Uninhabited: There is no layout for uninhabited types because they cannot exist at runtime</li>
<li>Univariant: If there is only one variant there is no need to store a tag because we always know which variant is active. If there is any data in the variant, the layout corresponds to the layout of that data, otherwise we are a ZST.</li>
<li>Directly tagged: There is tag field and the value of the discriminant (which is different than the <code>VariantIdx</code>) is used as the tag. </li>
<li>Niche: There is a specific place to store the tag but the tag does not match the discriminants. Therefore, the type of the tag and the type of the discriminant can be (and often are) different.</li>
</ul>
<p>From what I've seen, the debuginfo code doesn't consistently use the terms "tag" and "discriminant" correctly.</p>



<a name="271842500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Generator%20discr%20type%20inconsistency%3F/near/271842500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Generator.20discr.20type.20inconsistency.3F.html#271842500">(Feb 14 2022 at 15:33)</a>:</h4>
<p>So of these "directly tagged" and "niche" are both still "tagged" in the sense a tag does exist in memory. For the other two layouts, there are no tags.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>