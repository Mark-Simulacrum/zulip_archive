<html>
<head><meta charset="utf-8"><title>Queries with `()` keys · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html">Queries with `()` keys</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263932549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263932549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263932549">(Dec 06 2021 at 22:14)</a>:</h4>
<p>I was profiling the compiler's use of <code>FxHasher</code> for hash tables yesterday. I found that ~3.5% of all <code>FxHasher</code> invocations are on an empty sequence, i.e. hashing <code>()</code> or some other unit type. This surprised me.</p>
<p>I did some follow-up and got stack traces like these ones:</p>
<div class="codehilite"><pre><span></span><code>#1: 0x7f3348e850cd: dhat::ad_hoc_event (lib.rs:1227:18)
#2: 0x7f33489b6a6c: &lt;rustc_hash::FxHasher as core::hash::Hasher&gt;::finish (lib.rs:147:13)
#3: 0x7f33489b6a6c: rustc_query_system::query::plumbing::hash_for_shard::&lt;()&gt; (plumbing.rs:54:5)
#4: 0x7f33489b6a6c: &lt;rustc_query_system::query::plumbing::QueryCacheStore&lt;rustc_query_system::query::caches::ArenaCache&lt;(), rustc_hir::lang_items::LanguageItems&gt;&gt;&gt;::get_lookup (plumbing.rs:62:24)
#5: 0x7f33489b6a6c: &lt;rustc_query_system::query::caches::ArenaCache&lt;(), rustc_hir::lang_items::LanguageItems&gt; as rustc_query_system::query::caches::QueryCache&gt;::lookup::&lt;&amp;rustc_hir::lang_items::LanguageItems, rustc_query_system::query::plumbing::try_get_cached&lt;rustc_middle::ty::context::TyCtxt, rustc_query_system::query::caches::ArenaCache&lt;(), rustc_hir::lang_items::LanguageItems&gt;, &amp;rustc_hir::lang_items::LanguageItems, &lt;&amp;rustc_hir::lang_items::LanguageItems as core::clone::Clone&gt;::clone&gt;::{closure#0}&gt; (caches.rs:186:30)
#6: 0x7f33489b6a6c: rustc_query_system::query::plumbing::try_get_cached::&lt;rustc_middle::ty::context::TyCtxt, rustc_query_system::query::caches::ArenaCache&lt;(), rustc_hir::lang_items::LanguageItems&gt;, &amp;rustc_hir::lang_items::LanguageItems, &lt;&amp;rustc_hir::lang_items::LanguageItems as core::clone::Clone&gt;::clone&gt; (plumbing.rs:368:5)
#7: 0x7f33489b6a6c: &lt;rustc_middle::ty::query::TyCtxtAt&gt;::get_lang_items (query.rs:232:30)
#8: 0x7f33489b6a6c: &lt;rustc_middle::ty::context::TyCtxt&gt;::get_lang_items (query.rs:222:17)
#9: 0x7f33489b6a6c: &lt;rustc_middle::ty::context::TyCtxt&gt;::lang_items (context.rs:1221:9)
</code></pre></div>



<a name="263932830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263932830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263932830">(Dec 06 2021 at 22:15)</a>:</h4>
<p>Which took me to this query:</p>
<div class="codehilite"><pre><span></span><code>    query get_lang_items(_: ()) -&gt; LanguageItems {
</code></pre></div>



<a name="263932942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263932942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263932942">(Dec 06 2021 at 22:16)</a>:</h4>
<p>AFAICT, it's effectively a query where there is only one possible key. I.e. "get all the lang items for the crate"</p>



<a name="263933069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263933069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263933069">(Dec 06 2021 at 22:17)</a>:</h4>
<p>There are a few other queries like that: <code>limits</code>, <code>entry_fn</code>, <code>features_query</code></p>



<a name="263933160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263933160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263933160">(Dec 06 2021 at 22:18)</a>:</h4>
<p>I think every query gets its own sharded hash table, is that right?</p>



<a name="263933237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263933237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263933237">(Dec 06 2021 at 22:19)</a>:</h4>
<p>A rough count suggests that 36 of our 264(?) queries have <code>()</code> keys</p>



<a name="263933301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263933301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263933301">(Dec 06 2021 at 22:20)</a>:</h4>
<p>It's a bit silly to have an entire hash table for a single entry, effectively.</p>



<a name="263933321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263933321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263933321">(Dec 06 2021 at 22:20)</a>:</h4>
<p>I guess it's like this because queries are so macro-ified?</p>



<a name="263935139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263935139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263935139">(Dec 06 2021 at 22:39)</a>:</h4>
<p>There is now a macro to specify how the results should be stored :) It's the <code>storage()</code> directive in rustc_middle/query/mod.rs.</p>



<a name="263935206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263935206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263935206">(Dec 06 2021 at 22:40)</a>:</h4>
<p>I guess nobody really noticed the perf impact.</p>



<a name="263936806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263936806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263936806">(Dec 06 2021 at 22:57)</a>:</h4>
<p>I tried addressing this in <a href="https://github.com/rust-lang/rust/pull/86119">https://github.com/rust-lang/rust/pull/86119</a> but the perf results were disappointing</p>



<a name="263936842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263936842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263936842">(Dec 06 2021 at 22:58)</a>:</h4>
<p>I'll rebase and re-run it to see if anything has changed</p>



<a name="263940012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Queries%20with%20%60%28%29%60%20keys/near/263940012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Queries.20with.20.60().60.20keys.html#263940012">(Dec 06 2021 at 23:33)</a>:</h4>
<p>Still seemed like a net win, albeit a small one. I wouldn't necessarily expect a big win based on my measurements, but I was certainly curious about how/why null-hashing was happening <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>