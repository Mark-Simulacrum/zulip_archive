<html>
<head><meta charset="utf-8"><title>using i96 on a target without a i128 data layout · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html">using i96 on a target without a i128 data layout</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250289419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289419">(Aug 22 2021 at 19:30)</a>:</h4>
<p>Hello!</p>
<p>I am currently working on a rustc backend for nvvm ir, which is a subset of LLVM IR (llvm ir with restrictions) used for compiling stuff to cuda kernels using nvidia's libnvvm. Im close to it working, but i am running into an issue im uncertain on how to resolve. the nvptx data layout:</p>
<div class="codehilite"><pre><span></span><code>e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v16:16:16-v32:32:32-v64:64:64-v128:128:128-n16:32:64
</code></pre></div>
<p>Does not specify i128, which is a big problem. I got around this for <code>i128</code> by using <code>&lt;2 x i64&gt;</code> which kind of worked. But annoyingly enough, rust also generates <code>i96</code> for functions such as <code>_ZN4core7unicode12unicode_data11conversions8to_lower17h7496522699630263E</code>. This causes libnvvm to segfault or to yield an error because LLVM's behavior for integers is to use the next highest data layout integer, which in this case is none because <code>i128</code> is not specified. </p>
<p>I was wondering if anyone knew of an easy-ish way of solving this. Is there maybe an LLVM pass for transforming integers such as this? I filed a bug with NVIDIA for i128 and they stated they are working on i128 support for cuda 11.5 and full support for cuda 12, but it will be a while before thats released.</p>



<a name="250289512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289512">(Aug 22 2021 at 19:32)</a>:</h4>
<p>This issue yielded some insights <a href="https://github.com/rust-lang/rust/issues/38824">https://github.com/rust-lang/rust/issues/38824</a><br>
Im thinking i could maybe write a function pass to convert ints over <code>i64</code> to vectors and then back in the body, but that feels hacky and i dont have much experience with llvm passes.</p>



<a name="250289637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289637">(Aug 22 2021 at 19:35)</a>:</h4>
<p>i96 is probably created by the abi calculation code. Search for cast_to in rustc_target/src/abi/call.</p>



<a name="250289720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289720">(Aug 22 2021 at 19:37)</a>:</h4>
<p>there are no results of it in nvptx</p>



<a name="250289847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289847">(Aug 22 2021 at 19:40)</a>:</h4>
<p>right, that code is for <code>extern "C"</code>. the rust abi calculation is in rustc_middle/src/ty/layout.rs. this happens at <a href="https://github.com/rust-lang/rust/blob/7481e6d1a415853a96dcec11a052caaa02859b5a/compiler/rustc_middle/src/ty/layout.rs#L3015">https://github.com/rust-lang/rust/blob/7481e6d1a415853a96dcec11a052caaa02859b5a/compiler/rustc_middle/src/ty/layout.rs#L3015</a></p>



<a name="250289857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289857">(Aug 22 2021 at 19:40)</a>:</h4>
<p>oh i see</p>



<a name="250289862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289862">(Aug 22 2021 at 19:40)</a>:</h4>
<p>yeah in nvptx, there are no calling conventions, everything uses the ptx calling convention</p>



<a name="250289884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289884">(Aug 22 2021 at 19:41)</a>:</h4>
<p>you could make <code>max_by_val_size</code> by equal to 1 times the pointer size instead of 2 times.</p>



<a name="250289933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289933">(Aug 22 2021 at 19:42)</a>:</h4>
<p>inside my codegen?</p>



<a name="250289941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289941">(Aug 22 2021 at 19:42)</a>:</h4>
<p>nvm i am blind</p>



<a name="250289948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289948">(Aug 22 2021 at 19:43)</a>:</h4>
<p>Hmm i don't think patching rustc is really an option here, i think i would unintentionally break either the ptx backend or something else</p>



<a name="250289953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250289953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250289953">(Aug 22 2021 at 19:43)</a>:</h4>
<p>there are big differences between the llvm ptx backend and libnvvm</p>



<a name="250290018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290018">(Aug 22 2021 at 19:44)</a>:</h4>
<p>the altermative would be to patch cg_llvm to treat every PassMode::Cast as PassMode::Indirect I think.</p>



<a name="250290024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290024">(Aug 22 2021 at 19:44)</a>:</h4>
<p>i am not using cg_llvm, this is a completely separate codegen, albeit it takes a lot from cg_llvm</p>



<a name="250290031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290031">(Aug 22 2021 at 19:44)</a>:</h4>
<p>in any case changing <code>max_by_val_size</code> will at most cause a perf regression afaict.</p>



<a name="250290043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290043">(Aug 22 2021 at 19:45)</a>:</h4>
<p>eh i dont think it makes a difference in cuda kernels</p>



<a name="250290044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290044">(Aug 22 2021 at 19:45)</a>:</h4>
<blockquote>
<p>i am not using cg_llvm, this is a completely separate codegen, albeit it takes a lot from cg_llvm</p>
</blockquote>
<p>Yeah, I mean your codegen.</p>



<a name="250290052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290052">(Aug 22 2021 at 19:45)</a>:</h4>
<p>ah ok</p>



<a name="250290060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290060">(Aug 22 2021 at 19:45)</a>:</h4>
<p>abi code scares me</p>



<a name="250290071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290071">(Aug 22 2021 at 19:45)</a>:</h4>
<p>understandable</p>



<a name="250290115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290115">(Aug 22 2021 at 19:46)</a>:</h4>
<p>whats the diff between Cast and Indirect?</p>



<a name="250290119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290119">(Aug 22 2021 at 19:46)</a>:</h4>
<p>I had to spent quite a lot of time reading through it and refactoring it to make it more readable to implement the abi handling in cg_clif.</p>



<a name="250290123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290123">(Aug 22 2021 at 19:46)</a>:</h4>
<p>oof thats painful</p>



<a name="250290150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290150">(Aug 22 2021 at 19:47)</a>:</h4>
<p>i mostly copy and pasted the abi code from cg_llvm, it surprisingly works so im not complaining</p>



<a name="250290151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290151">(Aug 22 2021 at 19:47)</a>:</h4>
<p>The difference between Cast and Indirect is that Cast will take the raw bytes of the argument amd stuff them in one or more registers. Indirect will cause it to be passed either as a pointer or at a specific stack offset depending on the <code>on_stack</code> argument.</p>



<a name="250290204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290204">(Aug 22 2021 at 19:48)</a>:</h4>
<p>hmm yeah but the funny thing is cuda doesnt really have a stack <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="250290211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290211">(Aug 22 2021 at 19:48)</a>:</h4>
<p>it has a lot of registers but everything not in registers is spilled to local memory</p>



<a name="250290290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290290">(Aug 22 2021 at 19:50)</a>:</h4>
<p>how would i go about treating casts as indirect? from what im seeing i cant really transform cast to indirect since it doesnt have the same data</p>



<a name="250290310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290310">(Aug 22 2021 at 19:50)</a>:</h4>
<p>actually it seems doable</p>



<a name="250290321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290321">(Aug 22 2021 at 19:51)</a>:</h4>
<p>If there is a match on the pass mode take the <code>Cast</code> match arm and handle it as if it is <code>Indirect</code> with <code>on_stack</code> set to false.</p>



<a name="250290327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290327">(Aug 22 2021 at 19:51)</a>:</h4>
<p>i see</p>



<a name="250290332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290332">(Aug 22 2021 at 19:51)</a>:</h4>
<p>store has some scary code for cast but im guessing i can just delete that</p>



<a name="250290381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290381">(Aug 22 2021 at 19:52)</a>:</h4>
<p>Yeah, that is the code to handle the stuffing of the raw bytes into one or more registers. It is ugly.</p>



<a name="250290387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290387">(Aug 22 2021 at 19:52)</a>:</h4>
<p>makes sense</p>



<a name="250290395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290395">(Aug 22 2021 at 19:52)</a>:</h4>
<p>is PassMode::Cast used for anything else or is it just this kind of thing?</p>



<a name="250290399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290399">(Aug 22 2021 at 19:52)</a>:</h4>
<p>Just this.</p>



<a name="250290403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290403">(Aug 22 2021 at 19:52)</a>:</h4>
<p>oh that should work fine then</p>



<a name="250290412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290412">(Aug 22 2021 at 19:53)</a>:</h4>
<p>although debugging this if it doesnt work will be interesting because gpus dont really segfault</p>



<a name="250290502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290502">(Aug 22 2021 at 19:56)</a>:</h4>
<p>had to make an entire script to isolate every function in the core llvm ir file using <code>llvm-extract</code> and try to compile every individual function because libnvvm loves to segfault instead of yielding useful errors, pain</p>



<a name="250290540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290540">(Aug 22 2021 at 19:56)</a>:</h4>
<p>Can you compile it with assertions enabled or is it closed-source?</p>



<a name="250290549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290549">(Aug 22 2021 at 19:57)</a>:</h4>
<p>im running it with llvm 7 compiled with assertions</p>



<a name="250290553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290553">(Aug 22 2021 at 19:57)</a>:</h4>
<p>its closed source for now while i work on it but it will be open source once its usable</p>



<a name="250290562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290562">(Aug 22 2021 at 19:57)</a>:</h4>
<p>I mean is libnvvm closed-source?</p>



<a name="250290566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290566">(Aug 22 2021 at 19:57)</a>:</h4>
<p>oh, yep</p>



<a name="250290603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290603">(Aug 22 2021 at 19:58)</a>:</h4>
<p><span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span></p>



<a name="250290605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290605">(Aug 22 2021 at 19:58)</a>:</h4>
<p>now you know my pain <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="250290609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290609">(Aug 22 2021 at 19:58)</a>:</h4>
<p>LLVM loves to SIGSEGV when assertions  would otherwise fail.</p>



<a name="250290612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290612">(Aug 22 2021 at 19:58)</a>:</h4>
<p>its the library that nvcc (the cuda compiler) uses to compile gpu kernels to ptx, it contains some proprietary opts so its closed source</p>



<a name="250290625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290625">(Aug 22 2021 at 19:59)</a>:</h4>
<p>which is why im writing a backend for it instead of just trying to use the llvm ptx backend (which doesnt even work on windows because of dll stuff :( )</p>



<a name="250290639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290639">(Aug 22 2021 at 19:59)</a>:</h4>
<p>it also allows for special treatment of things at a codegen level which is helpful</p>



<a name="250290699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290699">(Aug 22 2021 at 20:00)</a>:</h4>
<p>Stallman should have ready his email. Then LLVM would have been part of GCC and thus GPL licensed...</p>



<a name="250290717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290717">(Aug 22 2021 at 20:00)</a>:</h4>
<p>haha</p>



<a name="250290735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290735">(Aug 22 2021 at 20:01)</a>:</h4>
<p>you have no idea how much pain ive been through with this codegen...</p>



<a name="250290742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290742">(Aug 22 2021 at 20:01)</a>:</h4>
<p>i initially used llvm 12 when i realized nvvm only works with llvm 7 bytecode</p>



<a name="250290754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290754">(Aug 22 2021 at 20:01)</a>:</h4>
<p>then there was all of the debugging for i128, transformations, adding libdevice intrinsics, fixing segfaults, etc</p>



<a name="250290768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290768">(Aug 22 2021 at 20:02)</a>:</h4>
<p>compiler_builtins finally compiles, now i need to fix this i96 thing and it <em>should</em> compile</p>



<a name="250290810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290810">(Aug 22 2021 at 20:02)</a>:</h4>
<p>How much optimizations are missed due to using LLVM 7 instead of 12?</p>



<a name="250290828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290828">(Aug 22 2021 at 20:03)</a>:</h4>
<p>Depending on how good those nvidia optimizations are maybe it would actually be slower.</p>



<a name="250290829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290829">(Aug 22 2021 at 20:03)</a>:</h4>
<p>Not much i dont think</p>



<a name="250290835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290835">(Aug 22 2021 at 20:03)</a>:</h4>
<p>the gpu optimizations should make up for it</p>



<a name="250290888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290888">(Aug 22 2021 at 20:04)</a>:</h4>
<p>considering cuda uses it, nvidia is very inclined to make stuff go fast</p>



<a name="250290904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290904">(Aug 22 2021 at 20:05)</a>:</h4>
<p>it should be easy to bench either ways</p>



<a name="250290923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290923">(Aug 22 2021 at 20:05)</a>:</h4>
<p><em>Just</em> get an AMD GPU. At least they upstream their stuff instead of keeping it closed sourve.</p>



<a name="250290924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290924">(Aug 22 2021 at 20:05)</a>:</h4>
<p>and using a custom codegen, i can make special attributes for gpu hints which should improve performance on select kernels. It also makes shared memory implementation easier</p>



<a name="250290975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250290975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250290975">(Aug 22 2021 at 20:06)</a>:</h4>
<p>yeah but CUDA is <em>the</em> system for gpu computing, i use it at the research lab i work at, its fast, has plenty of libraries, and almost all tools support it</p>



<a name="250291002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291002">(Aug 22 2021 at 20:07)</a>:</h4>
<p>I know. AMD has so much opportunity, yet somehow at least to me they seem to be focused just on gaming.</p>



<a name="250291005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291005">(Aug 22 2021 at 20:07)</a>:</h4>
<p>i wish nvidia would open source nvcc fully, but i get why they wouldnt want to, because nvidia dominates the gpu computing/scientific computing fields by a gigantic amount</p>



<a name="250291059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291059">(Aug 22 2021 at 20:08)</a>:</h4>
<p>yeah amd is a great choice if you just do gaming, but if you do 3d rendering and computing like me, nvidia is just the better choice for now</p>



<a name="250291070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291070">(Aug 22 2021 at 20:09)</a>:</h4>
<p>especially rendering since they have rtx and optix, plus, blender's cycles X is dropping opencl support</p>



<a name="250291093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291093">(Aug 22 2021 at 20:09)</a>:</h4>
<p>Hopefully they will either get Vulkan compute or HSA support soonish.</p>



<a name="250291132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291132">(Aug 22 2021 at 20:10)</a>:</h4>
<p>anyways id love for rust to be used more for cuda, right now its super painful so my goal is to make rust more viable and hopefully make nvidia notice the benefits rust would have for gpu kernels, especially for safety and maybe even performance</p>



<a name="250291164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291164">(Aug 22 2021 at 20:11)</a>:</h4>
<p>the thing with vulkan and using spirv is that it just doesnt match cuda performance usually, also, launching a cuda kernel is much easier than launching vulkan. Also, cuda has amazing profilers like nsight, as well as more features such as async memory copies and graphs</p>



<a name="250291230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250291230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250291230">(Aug 22 2021 at 20:13)</a>:</h4>
<p>im excited for spirv computing, but for now it seems like computing is just pushed to the side and its mostly just for shaders</p>



<a name="250294199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250294199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250294199">(Aug 22 2021 at 21:37)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> hmm i changed cast to be treated as indirect, but now its trying to do some... odd things with bitcasts</p>
<div class="codehilite"><pre><span></span><code>(val, dest_ty) = (
    ({ [0 x i64], i64, [0 x i16], i16, [0 x i8], i8, [5 x i8] }* %0),
    float,
)
</code></pre></div>



<a name="250294376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250294376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250294376">(Aug 22 2021 at 21:42)</a>:</h4>
<p>its trying to call <code>i32 @"_ZN4core3f3221_$LT$impl$u20$f32$GT$7to_bits17h09dd8e2a9b5ccbcbE"(float)</code> and it errors at </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">casted_args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_tys</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">iter</span><span class="p">())</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">enumerate</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">expected_ty</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">actual_val</span><span class="p">))</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">actual_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">val_ty</span><span class="p">(</span><span class="n">actual_val</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">expected_ty</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">actual_ty</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">bitcast</span><span class="p">(</span><span class="n">actual_val</span><span class="p">,</span><span class="w"> </span><span class="n">expected_ty</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">actual_val</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">})</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="250294409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250294409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250294409">(Aug 22 2021 at 21:43)</a>:</h4>
<p>for some reason its making a really odd struct type for this and trying to pass it off as a float</p>



<a name="250294633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250294633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250294633">(Aug 22 2021 at 21:49)</a>:</h4>
<p>i think perhaps i need to only treat PassMode::Cast s that are for <code>i96</code></p>



<a name="250294885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250294885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250294885">(Aug 22 2021 at 21:55)</a>:</h4>
<p>then again i dont see why it would be trying to pass a 40 bit aggregate off as a float</p>



<a name="250297036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297036">(Aug 22 2021 at 22:46)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> data layout is not required to specify the details for every possible type.</p>



<a name="250297067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297067">(Aug 22 2021 at 22:47)</a>:</h4>
<p>the way these are defined, there's a meaningful default for every bit width and data layouts are only required for the situtations where the defaults don't work right.</p>



<a name="250297188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297188">(Aug 22 2021 at 22:50)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> hmm well the answer i got by nvidia on why i96 and i128 segfaulted is that the nvptx data layout does not specify i128</p>



<a name="250297274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297274">(Aug 22 2021 at 22:53)</a>:</h4>
<p>Segfaulted at what stage? runtime?</p>



<a name="250297322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297322">(Aug 22 2021 at 22:54)</a>:</h4>
<p><a href="https://llvm.org/docs/LangRef.html#data-layout">Data layout</a> portion on llvm's langref.</p>



<a name="250297330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297330">(Aug 22 2021 at 22:55)</a>:</h4>
<p>segfaulted at compile time</p>



<a name="250297336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297336">(Aug 22 2021 at 22:55)</a>:</h4>
<p>after all the bytecode was done and fed to libnvvm and called compile</p>



<a name="250297383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297383">(Aug 22 2021 at 22:56)</a>:</h4>
<p>so that just sounds like a bug in libnvvm in case it happens to consume LLVM-IR directly.</p>



<a name="250297396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297396">(Aug 22 2021 at 22:57)</a>:</h4>
<p>yeah it is a bug in libnvvm, i already filed a bug for it and they said they are working on it, but id rather not wait on nvidia, waiting on large corporations usually ends badly</p>



<a name="250297397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297397">(Aug 22 2021 at 22:57)</a>:</h4>
<p>I guess it could be the case that libnvvm adds additional requirements to the IR passed to it over what LLVM requires, but then its no longer LLVM-compatible.</p>



<a name="250297400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297400">(Aug 22 2021 at 22:57)</a>:</h4>
<p>it absolutely does</p>



<a name="250297402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297402">(Aug 22 2021 at 22:57)</a>:</h4>
<p>NVVM IR is a subset of llvm ir</p>



<a name="250297405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297405">(Aug 22 2021 at 22:57)</a>:</h4>
<p><a href="https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html">https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html</a></p>



<a name="250297454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297454">(Aug 22 2021 at 22:58)</a>:</h4>
<p>all NVVM IR should be valid LLVM IR</p>



<a name="250297467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297467">(Aug 22 2021 at 22:58)</a>:</h4>
<p>which is also why im not just using cg_llvm, because it makes incompatible nvvm ir</p>



<a name="250297477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297477">(Aug 22 2021 at 22:59)</a>:</h4>
<p>anyways, any clue why rustc is trying to pass off that aggregate as a float? o.O</p>



<a name="250297629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297629">(Aug 22 2021 at 23:01)</a>:</h4>
<p>I'd guess there's a mismatch of indices somewhere that happens because some other part of the compiler still thinks that particular thing should be passed around some other way.</p>



<a name="250297671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297671">(Aug 22 2021 at 23:02)</a>:</h4>
<p><code>i32 @"_ZN4core3f3221_$LT$impl$u20$f32$GT$7to_bits17h09dd8e2a9b5ccbcbE"(float)</code> looks like a correct signature though.</p>



<a name="250297731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297731">(Aug 22 2021 at 23:04)</a>:</h4>
<p>so I'd suspect one layer above – i.e. the arguments of the calling function perhaps are handled wrong.</p>



<a name="250297736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297736">(Aug 22 2021 at 23:04)</a>:</h4>
<p>yeah it is</p>



<a name="250297753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297753">(Aug 22 2021 at 23:05)</a>:</h4>
<p>its trying to call <code>core[2fcb]::f32::{impl#0}::to_bits</code></p>



<a name="250297767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297767">(Aug 22 2021 at 23:05)</a>:</h4>
<p>and i <em>think</em> its when codegenning this function <code>_ZN59_$LT$f32$u20$as$u20$core$$num$$dec2flt$$rawfp$$RawFloat$GT$14integer_decode17h31743191f0f0e4a9E</code></p>



<a name="250297821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297821">(Aug 22 2021 at 23:07)</a>:</h4>
<p>the weird aggregate comes from <code>backend_type</code></p>



<a name="250297835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250297835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250297835">(Aug 22 2021 at 23:08)</a>:</h4>
<p>which just gets the llvm type of <code>TyAndLayout</code></p>



<a name="250313962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/using%20i96%20on%20a%20target%20without%20a%20i128%20data%20layout/near/250313962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/using.20i96.20on.20a.20target.20without.20a.20i128.20data.20layout.html#250313962">(Aug 23 2021 at 06:03)</a>:</h4>
<p>Yep it appears like treating PassMode::Cast as PassMode::Indirect does not work, i even tried only doing this for integer casts over 64 bits, but nothing seems to work, its still sprouting wrong casts</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>