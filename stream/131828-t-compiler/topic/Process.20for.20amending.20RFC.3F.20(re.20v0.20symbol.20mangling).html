<html>
<head><meta charset="utf-8"><title>Process for amending RFC? (re v0 symbol mangling) · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html">Process for amending RFC? (re v0 symbol mangling)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261137860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261137860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261137860">(Nov 11 2021 at 14:07)</a>:</h4>
<p>It looks like we'll want to extend the v0 symbol mangling scheme to allow for "vendor-specific suffixes" because LLVM will append <code>.llvm.&lt;numbers&gt;</code> to some symbols during ThinLTO (see <a href="https://github.com/rust-lang/rust/pull/89917#issuecomment-963755731">https://github.com/rust-lang/rust/pull/89917#issuecomment-963755731</a> for more info).</p>
<p>What's the process for making a change to an RFC? Do we just open a PR to the RFC repo? It looks like we've done that <a href="https://github.com/rust-lang/rfcs/pull/3130">here</a> for example and the RFC got updated without much discussion. I wonder if that is visible enough though? Maybe do an FCP on the PR that amends the RFC?</p>



<a name="261138745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261138745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261138745">(Nov 11 2021 at 14:15)</a>:</h4>
<p>I think an amendment to the RFC is fine, but I also would encourage us to move the "canonical" docs into something like src/doc/rustc (or the unstable book, since it's not technically stable yet) -- and then we can edit with PRs to rust-lang/rust (maybe FCP'd)</p>



<a name="261139316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261139316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261139316">(Nov 11 2021 at 14:20)</a>:</h4>
<p>I'm fine with any approach as long as there a single source of truth.</p>



<a name="261147594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261147594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261147594">(Nov 11 2021 at 15:29)</a>:</h4>
<p>I would also lean towards migrating the docs to the unstable book and then to the rustc book.  They will need to be captured outside of the RFC eventually, and now seems as good as time as any.</p>



<a name="261163308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261163308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261163308">(Nov 11 2021 at 17:34)</a>:</h4>
<p><span class="user-mention" data-user-id="124287">@mw</span> I'm surprised that sticks around in the final binary.</p>



<a name="261163340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261163340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261163340">(Nov 11 2021 at 17:34)</a>:</h4>
<p>Or is this about intermediate objects?</p>



<a name="261171835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261171835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261171835">(Nov 11 2021 at 18:55)</a>:</h4>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>nm librustc_driver-535ad5bbd58fc935.so  <span class="p">|</span> grep --count -F .llvm.
<span class="go">22865</span>
</code></pre></div>



<a name="261175884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261175884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261175884">(Nov 11 2021 at 19:33)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Final binary. I'm seeing lots of non-demangled <code>.llvm.&lt;numbers&gt;</code> symbols in Cachegrind output, because the Valgrind (libiberty) v0 demangler doesn't handle the suffixes.</p>



<a name="261194251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261194251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261194251">(Nov 11 2021 at 23:05)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Huh. Any idea why those suffixes stick around in the final binary?</p>



<a name="261198573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261198573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261198573">(Nov 12 2021 at 00:09)</a>:</h4>
<p>Symbols wouldn't go away unless you strip them</p>



<a name="261259361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261259361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261259361">(Nov 12 2021 at 14:30)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> As I understand it, ThinLTO needs to make some previously private symbols public so they can be accessed from other object files (e.g. if a function <code>fn foo() -&gt; u32 { return some_large_private_fn(); }</code> gets imported into another module, <code>some_large_private_fn</code> must be reachable externally. But since there might be other symbols called <code>some_large_private_fn</code> somewhere else, the suffix is added to disambiguate the name. Since ThinLTO still works with separate object files and there can also be regular object files in the mix, a ThinLTO'd object file (after codegen) still has to look like a regular object file to the linker.</p>



<a name="261262533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261262533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261262533">(Nov 12 2021 at 14:53)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>, to clarify: you expected all <code>.llvm.</code> symbols to be removed from the final binary because all relocations referring to them have been replaced by actual addresses?</p>



<a name="261263070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261263070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261263070">(Nov 12 2021 at 14:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span>, <span class="user-mention" data-user-id="120518">@Eric Huss</span> if we move the specification from the RFC into documentation then I think the <a href="https://doc.rust-lang.org/reference/">Reference</a> would be the best place. It already has sections on linkage, ABI, and the runtime, for example.</p>



<a name="261263147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261263147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261263147">(Nov 12 2021 at 14:57)</a>:</h4>
<p>Seems OK to me.</p>



<a name="261264075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261264075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261264075">(Nov 12 2021 at 15:02)</a>:</h4>
<p>It would also be good to update the RFC to contain a note that the official specification lives at <code>{url}</code>.</p>



<a name="261268283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261268283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261268283">(Nov 12 2021 at 15:28)</a>:</h4>
<p><span class="user-mention" data-user-id="124287">@mw</span> Ah, I see! No, I had expected the suffixes to disappear, but that's because I thought they were modifications of public symbols, not private ones.</p>



<a name="261281097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261281097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261281097">(Nov 12 2021 at 17:00)</a>:</h4>
<p>I would prefer not to make it part of the reference, as the reference focuses on the behavior of the language. From my understanding, this is somewhat outside of the language definition, but more of an implementation issue, right?  I also think it will be easier to maintain in the rustc repo.</p>
<p>The section on linkage needs to be rewritten so that it is not so much about <code>rustc</code>.  The others are relevant to how the language behavior interfaces with the system.  It doesn't seem like the mangling scheme is something that surfaces in the language?</p>



<a name="261508680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261508680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261508680">(Nov 15 2021 at 15:04)</a>:</h4>
<p>I agree that the mangling is not part of the language as such. But it's also more than an implementation detail of <code>rustc</code>. I still think that the reference would be good place for hosting its definition -- but I don't have a strong opinion about it. I'm also fine with just keeping the RFC up-to-date (it does have a change-log section after all).</p>



<a name="261510782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261510782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261510782">(Nov 15 2021 at 15:17)</a>:</h4>
<p>It seems like something other compilers would want to match, yeah - otherwise there's compatibility issues if you want to get gdb or valgrind to demangle symbols</p>



<a name="261512289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Process%20for%20amending%20RFC%3F%20%28re%20v0%20symbol%20mangling%29/near/261512289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20(re.20v0.20symbol.20mangling).html#261512289">(Nov 15 2021 at 15:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/Process.20for.20amending.20RFC.3F.20.28re.20v0.20symbol.20mangling.29/near/261510782">said</a>:</p>
<blockquote>
<p>It seems like something other compilers would want to match, yeah - otherwise there's compatibility issues if you want to get gdb or valgrind to demangle symbols</p>
</blockquote>
<p>The larger compatibility issues would be if you wanted to link rlib/dylib code from different compilers, but that's not currently possible (you can't even do it between rustc versions). As long as valgrind/gdb support exists for both schemes, it should work fine. Although I agree that <code>v0</code> mangling should be more than just an implementation-detail, as it's a good advisory option for other compilers, similar to things like the UCG (which can inform implementors on layout/option choices, despite not being normative and constraining them).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>