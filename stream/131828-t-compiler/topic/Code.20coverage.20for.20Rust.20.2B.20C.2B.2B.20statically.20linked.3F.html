<html>
<head><meta charset="utf-8"><title>Code coverage for Rust + C++ statically linked? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html">Code coverage for Rust + C++ statically linked?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262898789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262898789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlie Davis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262898789">(Nov 27 2021 at 23:35)</a>:</h4>
<p>Hey, folks. I'm working on code coverage for a codebase that statically links Rust code into C++ DLLs / shared objects.  The Rust code is compiled using <code>crate-type = ["staticlib"]</code>, which works great. But when I compiled with <code>-Zinstrument-coverage</code>, then the Rust static lib does not contain the guts of <code>profiler_builtins</code>, so it fails to find those paths.  I could hard-code that path, but since the filename has a version hash in it, that's not really a stable solution.</p>
<p>Also, is it possible to perform code coverage analysis across C++ _and_ Rust?  As in, run Clang with <code>--coverage</code>?  I tried this, and it successfully produces a <code>profraw</code> file, but <code>grcov</code> was not able to analyze it.  I'm not super-familiar with the file types used in LLVM's coverage world, so I'm not sure how to debug this.</p>



<a name="262899589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262899589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262899589">(Nov 27 2021 at 23:58)</a>:</h4>
<p>You need to use <code>-fprofile-instr-generate -fcoverage-mapping</code> with Clang, not <code>--coverage</code>. Also make sure that you are using Clang 13 (since Rust nightly uses LLVM 13).</p>



<a name="262899805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262899805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlie Davis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262899805">(Nov 28 2021 at 00:02)</a>:</h4>
<p>Ah, super!  I'll try that.</p>



<a name="262899873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262899873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlie Davis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262899873">(Nov 28 2021 at 00:04)</a>:</h4>
<p>Will Clang handle linking the profiler_builtins?</p>



<a name="262901938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262901938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262901938">(Nov 28 2021 at 01:06)</a>:</h4>
<p>Yes.</p>



<a name="262902161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262902161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlie Davis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262902161">(Nov 28 2021 at 01:13)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> That indeed worked. Thanks much!</p>



<a name="262902210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262902210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262902210">(Nov 28 2021 at 01:14)</a>:</h4>
<p>Great! I have a similar setup but inverted: a Rust program that uses a C staticlib. Those flags worked for me.</p>



<a name="262902434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262902434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlie Davis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262902434">(Nov 28 2021 at 01:21)</a>:</h4>
<p>With some of the coverage toolchains that I've used in the past, you could create a file that contained coverage baselines, like "src/foo/zap must be at least 88% coverage", and then in CI pipelines could trigger a warning/error if coverage dropped below those baselines.  Is there anything like that which works with LLVM-based coverage files?</p>



<a name="262902681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262902681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262902681">(Nov 28 2021 at 01:29)</a>:</h4>
<p>Is there a way to output just the coverage percentage programmatically? If so that should be pretty easy to check even with a shell script</p>



<a name="262902749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/Code%20coverage%20for%20Rust%20%2B%20C%2B%2B%20statically%20linked%3F/near/262902749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlie Davis <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/Code.20coverage.20for.20Rust.20.2B.20C.2B.2B.20statically.20linked.3F.html#262902749">(Nov 28 2021 at 01:30)</a>:</h4>
<p>I don't see anything yet, but I haven't dug too deeply, yet.  Really, any reliable form of baseline would work.  A percentage covered per file would be a good enough signal to start with.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>