<html>
<head><meta charset="utf-8"><title>moving items to core unstably · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html">moving items to core unstably</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277958533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277958533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277958533">(Apr 05 2022 at 23:38)</a>:</h4>
<p>This came up when I was reviewing <a href="https://github.com/rust-lang/rust/pull/94079">https://github.com/rust-lang/rust/pull/94079</a>. In that PR <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> pointed out that re-export stability isn't checked by the compiler, which surprised me, since I hadn't run into any warnings when I was setting up my error in core PR which does something very similar: <a href="https://github.com/rust-lang/rust/pull/90328">https://github.com/rust-lang/rust/pull/90328</a></p>
<p>I had hoped that it would work in the error-in-core PR since in that case we were introducing a new module, so in theory the unstable attribute was being applied to <code>mod core::error;</code> and that would make any usage of <code>core::error</code> produce an error. In Vadim's PR's case there was already a <code>core::ffi</code> module so that wasn't an option.</p>
<p>After some digging it turns out it sort of works but mostly doesn't.</p>
<ul>
<li><code>use core::error;</code> does correctly produce a warning for use of an unstable feature <a href="https://github.com/rust-lang/rust/pull/90328/files#diff-1e1de53b51b61f48e07e7424fa8ee998bb9690853304d02a63e2316e4f0fa38d">https://github.com/rust-lang/rust/pull/90328/files#diff-1e1de53b51b61f48e07e7424fa8ee998bb9690853304d02a63e2316e4f0fa38d</a></li>
<li>But <code>impl core::error::Error for MyType {}</code> works juuuuust fine.... <a href="https://github.com/rust-lang/rust/pull/90328/files#diff-c3b23dcebfc9d27e8813a31ccb2ecb16f6be21af3952d7e5bb6a27fc52a2afad">https://github.com/rust-lang/rust/pull/90328/files#diff-c3b23dcebfc9d27e8813a31ccb2ecb16f6be21af3952d7e5bb6a27fc52a2afad</a></li>
</ul>
<p>I talked to Vadim about it and he's gonna look into using a type alias for the CStr issue to allow it to be unstable in core but have a stable type alias, but for the error in core issue I need to figure something else out. I'm noodling around in the <code>rustc_middle/.../stability.rs</code> and wondering how bad of an idea it would be to just also check the parent module's stability, but generally I'm curious if y'all have ideas for how we could better support unstable moves of types and traits from std into core.</p>



<a name="277960451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277960451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277960451">(Apr 06 2022 at 00:07)</a>:</h4>
<p>Is it inherently hard to fix the compiler to check this consistently? Seems better than hacking around it somehow ...</p>



<a name="277963753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277963753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277963753">(Apr 06 2022 at 01:00)</a>:</h4>
<p>no idea! that's is very much my question here</p>



<a name="277963783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277963783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277963783">(Apr 06 2022 at 01:01)</a>:</h4>
<p>for the CStr issue vadim explained that it would be a pretty big body of work to fix</p>



<a name="277963794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277963794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277963794">(Apr 06 2022 at 01:01)</a>:</h4>
<p>because we'd have to move the stability attribute checking to an earlier stage of the compiler</p>



<a name="277965465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277965465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277965465">(Apr 06 2022 at 01:33)</a>:</h4>
<p>It would be useful to figure out exactly what isn't being checked. Is it any item in <code>std::error</code>, i.e. an issue with propagating the attribute to module children? Does it only happen when implementing an unstable trait? Something else?</p>



<a name="277976582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277976582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277976582">(Apr 06 2022 at 05:15)</a>:</h4>
<p>I had to use type aliases for the <code>std::os::raw::c_*</code> types when adding them to <code>core::ffi::c_*</code>. I'd love to have been able to <code>#[stable] pub use</code> instead.</p>



<a name="277976636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277976636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277976636">(Apr 06 2022 at 05:16)</a>:</h4>
<p>I think in general we could use type aliases for now, instead of re-exports of types.</p>



<a name="277976651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277976651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277976651">(Apr 06 2022 at 05:17)</a>:</h4>
<p>We don't have stable trait aliases, but I wonder if we could use the unstable trait_alias feature?</p>



<a name="277993042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/277993042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#277993042">(Apr 06 2022 at 08:48)</a>:</h4>
<p>It's my recollection that you can't currently <em>implement</em> traits through trait aliases.</p>
<p>(I don't know if that's an intentional restriction or not.)</p>



<a name="278043641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/278043641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#278043641">(Apr 06 2022 at 15:43)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> from my quick poke around it looks like it's the former, it isn't propagating/checking the stableness of the parent module</p>



<a name="278045082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/278045082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#278045082">(Apr 06 2022 at 15:53)</a>:</h4>
<p>Gotcha. That shouldn't be terribly hard to fix then, I don't think - it just needs to call <code>tcx.parent(def_id)</code> in a loop until it gets to the crate root, to see if any parent is unstable</p>



<a name="278045182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/278045182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#278045182">(Apr 06 2022 at 15:54)</a>:</h4>
<p>(this is basically how <code>doc(hidden)</code> checking works in rustdoc)</p>



<a name="278052570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/278052570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#278052570">(Apr 06 2022 at 16:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably/near/278045082">said</a>:</p>
<blockquote>
<p>Gotcha. That shouldn't be terribly hard to fix then, I don't think - it just needs to call <code>tcx.parent(def_id)</code> in a loop until it gets to the crate root, to see if any parent is unstable</p>
</blockquote>
<p>okay cool! this sounds like what I was thinking as a possible fix for the specific issue for error, and it looks like Vadim was able to use a type alias for CStr/CString so we might be fine for now with this approach. I'll go ahead and open a PR to add the parent stability check, tyty ^_^</p>



<a name="278637787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/moving%20items%20to%20core%20unstably/near/278637787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably.html#278637787">(Apr 12 2022 at 01:31)</a>:</h4>
<p>got an initial version of the PR <a href="https://github.com/rust-lang/rust/pull/95956">https://github.com/rust-lang/rust/pull/95956</a></p>
<p>but apparently i need to figure out a way to fix the panic macro because apparently it calls some publicly re-exported functions from core::panicking through the unstable <code>rt</code> module. Not really sure how it worked before because they appear to be unstable in rustdoc: <a href="https://doc.rust-lang.org/stable/core/panicking/fn.panic_fmt.html">https://doc.rust-lang.org/stable/core/panicking/fn.panic_fmt.html</a>, but I'll have to figure that out next time I have a chance to work on this</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>