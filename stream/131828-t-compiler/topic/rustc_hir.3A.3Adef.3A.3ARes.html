<html>
<head><meta charset="utf-8"><title>rustc_hir::def::Res · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html">rustc_hir::def::Res</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269070440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269070440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269070440">(Jan 24 2022 at 08:08)</a>:</h4>
<p><code>rustc_hir::def::Res</code> is allocated frequently in arenas, within the <code>rustc_hir::Path</code> and <code>rustc_hir::PathSegment</code> types. <code>Res</code> is 24 bytes in size, but if the <code>Ref::SelfTy</code> variant was removed it would be 12 bytes.</p>



<a name="269070462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269070462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269070462">(Jan 24 2022 at 08:08)</a>:</h4>
<p>I want to shrink it, not quite sure how to do it yet.</p>



<a name="269070539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269070539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269070539">(Jan 24 2022 at 08:09)</a>:</h4>
<p>I could just <code>Box</code> it, but really the inner type should be hir-arena-allocated too, like <code>Res</code> itself, I guess</p>



<a name="269070638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269070638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269070638">(Jan 24 2022 at 08:10)</a>:</h4>
<p><code>PathSegment</code> is also pretty awful, 56 bytes, lots of optional stuff, very clunky, but also not obvious how to shrink it (other than by shrinking <code>Res</code>)</p>



<a name="269168923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269168923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269168923">(Jan 24 2022 at 20:35)</a>:</h4>
<p>How often do users of Res need to access the trait, rather than the impl?</p>



<a name="269168950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269168950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269168950">(Jan 24 2022 at 20:35)</a>:</h4>
<p>And how easy is it to get from an impl to the trait it's impl-ing?</p>



<a name="269169012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269169012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269169012">(Jan 24 2022 at 20:35)</a>:</h4>
<p>What if you dropped the first member of the tuple, and let callers go find it via the impl if they need it?</p>



<a name="269169194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269169194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269169194">(Jan 24 2022 at 20:36)</a>:</h4>
<p>Or, correction:</p>



<a name="269169274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269169274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269169274">(Jan 24 2022 at 20:37)</a>:</h4>
<p>It's possible to have a SelfTy with the first field Some and the second None, because the Self could appear <em>in</em> the trait definition rather than an impl. But do you ever need <em>both</em>, or could the <code>(Option, Option)</code> become an enum covering the case of "in trait" and "in impl" and never need the trait if it has the impl?</p>



<a name="269169963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269169963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269169963">(Jan 24 2022 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> I'm digging through every reference to <code>SelfTy</code> in the compiler, and it <em>looks</em> like there's a concrete set of valid states that the compiler expects and cares about. (Diagnostics cover more cases, but diagnostics can take slow-paths tracking things down.)</p>



<a name="269170110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269170110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269170110">(Jan 24 2022 at 20:45)</a>:</h4>
<p>(It does look like it'd be a pain to untangle, though.)</p>



<a name="269170287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269170287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269170287">(Jan 24 2022 at 20:46)</a>:</h4>
<p>Also, the <code>bool</code> seems like it could get folded into an enum variant to take up no space. (Ideally it could get folded into the <code>Res</code> discriminant so that the variants of SelfTy take up no space, but that'd be more of a pain given all the things referencing SelfTy.)</p>



<a name="269175230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175230">(Jan 24 2022 at 21:27)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I'm certainly prepared to split up SelfTy into multiple variants. At first I thought that a <code>(Some,Some)</code> pairing was impossible, but <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/late.rs#L1305">https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/late.rs#L1305</a> suggests otherwise. Indeed, that file has all four combinations of the <code>(Option,Option)</code></p>



<a name="269175624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175624">(Jan 24 2022 at 21:30)</a>:</h4>
<p>I admit I don't understand well the two Options; I find the comment on <code>SelfTy</code>a bit unclear</p>



<a name="269175746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175746">(Jan 24 2022 at 21:31)</a>:</h4>
<p>I did see that file, when I was looking. But it <em>seemed</em> to me that when the <code>(Some, Some)</code> case is <em>processed</em> (rather than generated), it was promptly checked for consistency.</p>



<a name="269175760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175760">(Jan 24 2022 at 21:31)</a>:</h4>
<p>I guess the first example is the <code>Some,None</code> pairing, the second example is the <code>None,Some</code> pairing, and the third example is the <code>Some,Some</code> pairing. (And the <code>None,None</code> pairing is used in the code seemingly for an error case)</p>



<a name="269175891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175891">(Jan 24 2022 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> sorry, what does "consistency" mean here?</p>



<a name="269175948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175948">(Jan 24 2022 at 21:33)</a>:</h4>
<p>I wasn't following it completely, but it <em>seemed</em> like in cases where both fields were Some, they were required to be a trait and an impl of that same trait.</p>



<a name="269175978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269175978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269175978">(Jan 24 2022 at 21:33)</a>:</h4>
<p>Which would <em>suggest</em> that it might be OK to assume that the trait was findable from the impl.</p>



<a name="269177414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269177414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269177414">(Jan 24 2022 at 21:46)</a>:</h4>
<p>I think it <em>might</em> be sufficient to have four cases: SelfDummyTy for <code>(None, None)</code>, SelfTraitTy for <code>(Some, None)</code>, SelfImplTy for <code>(_, Some(_, false))</code>, and SelfImplForbidGenericsTy for <code>(_, Some(_, true))</code>. Those seemed like the cases that got unique handling.</p>



<a name="269177451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269177451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269177451">(Jan 24 2022 at 21:46)</a>:</h4>
<p>I'm not <em>sure</em> how much SelfDummyTy is actually needed except for diagnostics, but that may become obvious when trying to translate that.</p>



<a name="269489835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/269489835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#269489835">(Jan 26 2022 at 22:05)</a>:</h4>
<p>Right, but the latter two are still the same size as <code>SelfTy</code></p>



<a name="271748812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_hir%3A%3Adef%3A%3ARes/near/271748812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes.html#271748812">(Feb 13 2022 at 14:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc_hir.3A.3Adef.3A.3ARes/near/269168950">said</a>:</p>
<blockquote>
<p>And how easy is it to get from an impl to the trait it's impl-ing?</p>
</blockquote>
<p>It's trivial: the query <code>tcx.impl_trait_ref</code> does it.</p>
<p>I'm not sure that we need to keep a full <code>DefId</code> in the <code>SelfTy</code>. This variant should not appear in metadata (to be verified).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>