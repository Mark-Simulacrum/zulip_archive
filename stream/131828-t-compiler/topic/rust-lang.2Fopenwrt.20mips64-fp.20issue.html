<html>
<head><meta charset="utf-8"><title>rust-lang/openwrt mips64-fp issue · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-lang.2Fopenwrt.20mips64-fp.20issue.html">rust-lang/openwrt mips64-fp issue</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263746564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-lang/openwrt%20mips64-fp%20issue/near/263746564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-lang.2Fopenwrt.20mips64-fp.20issue.html#263746564">(Dec 05 2021 at 03:25)</a>:</h4>
<p>I'm working to integrate <code>rust-lang</code> into the OpenWrt build system (still), and have gotten to the point I've moved to more detailed testing.  While compiling <code>suricata</code>, it compiles fine, but when ran on-device, throws the below <code>SIGILL</code>.  At this point, I'm just trying to find out the point of failure; is it with the toolchains I'm building or with <code>suricata</code> and it's interactions with Openwrt.  </p>
<div class="codehilite"><pre><span></span><code>Program received signal SIGILL, Illegal instruction.
0x000000aaab6e0b08 in compiler_builtins::float::mul::__muldf3 ()
(gdb) bt
#0  0x000000aaab6e0b08 in compiler_builtins::float::mul::__muldf3 ()
#1  0x000000aaab6df894 in __muldf3 ()
#2  0x000000aaaaf773b8 in ParseSizeString (size=0xfff7ff0a80 &quot;100kb&quot;, res=0xffffffd968) at util-misc.c:134
#3  0x000000aaaaf77804 in ParseSizeStringU32 (size=&lt;optimized out&gt;, res=0xaaaba95f50 &lt;cfglist+48&gt;) at util-misc.c:190
#4  0x000000aaaadca418 in HTPConfigParseParameters (cfg_prec=0xaaaba95f20 &lt;cfglist&gt;, s=0xfff7dad200, tree=0xfff64071f0)
    at app-layer-htp.c:2558
#5  0x000000aaaadd0354 in HTPConfigParseParameters (tree=&lt;optimized out&gt;, s=&lt;optimized out&gt;,
    cfg_prec=0xaaaba95f20 &lt;cfglist&gt;) at app-layer-htp.c:2495
#6  HTPConfigure () at app-layer-htp.c:2857
#7  0x000000aaaadd0b04 in RegisterHTPParsers () at app-layer-htp.c:3156
#8  0x000000aaaaddca1c in AppLayerParserRegisterProtocolParsers () at app-layer-parser.c:1590
#9  0x000000aaaada1a78 in AppLayerSetup () at app-layer.c:846
#10 0x000000aaaaf3560c in PostConfLoadedSetup (suri=0xaaabaab910 &lt;suricata&gt;) at suricata.c:2495
#11 PostConfLoadedSetup (suri=0xaaabaab910 &lt;suricata&gt;) at suricata.c:2441
#12 0x000000aaaaf368d4 in SuricataMain (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at suricata.c:2778
#13 0x000000aaaad9c154 in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at main.c:22
(gdb) display/i $pc
1: x/i $pc
=&gt; 0xaaab6e0b08 &lt;_ZN17compiler_builtins5float3mul8__muldf317hb2507f21e2c57c28E&gt;:        dmfc1   a4,$f12
(gdb)
</code></pre></div>
<p><code>dmfc1</code> is valid <code>Doubleword Move from Floating Point</code> in MIPS, and I ran into issues before with rust and the <code>musl</code> targets.  </p>
<p>I've changed the <code>linux_musl_base.rs</code> to set <code>base.crt_static_default = false;</code>, and I'm building the toolchain(s) and targetting <code>mips64-unknown-linux-muslabi64</code></p>
<p>Suggestions on what might be checked in <code>rust-lang</code>?</p>



<a name="263756679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-lang/openwrt%20mips64-fp%20issue/near/263756679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-lang.2Fopenwrt.20mips64-fp.20issue.html#263756679">(Dec 05 2021 at 08:22)</a>:</h4>
<blockquote>
<p><code>dmfc1</code> is valid <code>Doubleword Move from Floating Point</code> in MIPS, and I ran into issues before with rust and the <code>musl</code> targets.  </p>
</blockquote>
<p>Does your specific device support this instruction?</p>



<a name="263759079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-lang/openwrt%20mips64-fp%20issue/near/263759079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-lang.2Fopenwrt.20mips64-fp.20issue.html#263759079">(Dec 05 2021 at 09:30)</a>:</h4>
<p>Yes, AFAIK, it's standard in MIPS64. (<a href="https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MIPS_Architecture_MIPS64_InstructionSet_%20AFP_P_MD00087_06.05.pdf">https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MIPS_Architecture_MIPS64_InstructionSet_%20AFP_P_MD00087_06.05.pdf</a>) Pg 196</p>
<p>My issue right now is that I don't know where the issue might be.  It could very well be a Suricata issue, but I wanted to make sure I wasn't just missing something simple in the rust-lang toolchain.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>