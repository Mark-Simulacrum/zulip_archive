<html>
<head><meta charset="utf-8"><title>possible compiler bug with macro expansion? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html">possible compiler bug with macro expansion?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266528441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> devsnek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528441">(Dec 31 2021 at 23:13)</a>:</h4>
<p>is it intentional that this fails or is it some sort of compiler bug? </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"u32"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">works</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">map</span><span class="o">!</span><span class="p">(</span><span class="cp">$arg</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">broken</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$arg</span>:<span class="nc">ty</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">map</span><span class="o">!</span><span class="p">(</span><span class="cp">$arg</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">works</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">broken</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>   Compiling playground v0.0.1 (/playground)
error: no rules expected the token `u32`
  --&gt; src/main.rs:15:14
   |
1  | macro_rules! map {
   | ---------------- when calling this macro
...
15 |         map!($arg)
   |              ^^^^ no rules expected this token in macro call
...
21 |     broken!(u32);
   |     ------------ in this macro invocation
   |
   = note: this error originates in the macro `broken` (in Nightly builds, run with -Z macro-backtrace for more info)

error: could not compile `playground` due to previous error
</code></pre></div>



<a name="266528600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528600">(Dec 31 2021 at 23:17)</a>:</h4>
<p>Yes, I think this is intentional. When the <code>ty</code> gets matched in <code>broken</code>, it's internally wrapped up and prevented from being matched as a different thing in the future. Then, when matching <code>map</code>, ig it looks for an ident (u32) and finds instead a type. <code>works!</code> is different because <code>tt</code>s are exempt from this rule</p>



<a name="266528657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528657">(Dec 31 2021 at 23:18)</a>:</h4>
<p>See</p>
<blockquote>
<p>When forwarding a matched fragment to another macro-by-example, matchers in the second macro will see an opaque AST of the fragment type. The second macro can't use literal tokens to match the fragments in the matcher, only a fragment specifier of the same type. The ident, lifetime, and tt fragment types are an exception, and can be matched by literal tokens. The following illustrates this restriction:</p>
</blockquote>
<p>from <a href="https://doc.rust-lang.org/reference/macros-by-example.html">https://doc.rust-lang.org/reference/macros-by-example.html</a></p>



<a name="266528672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> devsnek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528672">(Dec 31 2021 at 23:18)</a>:</h4>
<p>is there a workaround? i don't know a way to pass a ty down with this behavior</p>



<a name="266528694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528694">(Dec 31 2021 at 23:19)</a>:</h4>
<p>Really depends on what exactly you want to do. You can either match on a <code>ident</code> in the outer macro, match on a <code>ty</code> in the inner macro, or do other stuff depending</p>



<a name="266528759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> devsnek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528759">(Dec 31 2021 at 23:20)</a>:</h4>
<p>you mean match on <code>ty</code> in <code>map</code>? how would i do that</p>



<a name="266528769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528769">(Dec 31 2021 at 23:20)</a>:</h4>
<p>Same way as in <code>broken</code></p>



<a name="266528772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> devsnek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528772">(Dec 31 2021 at 23:21)</a>:</h4>
<p>i don't understand, map needs to match specific tokens</p>



<a name="266528833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528833">(Dec 31 2021 at 23:22)</a>:</h4>
<p>Right, that's the thing this is specifically designed to prevent. The  other option you have is to add more cases to <code>broken</code>, where you match exactly on <code>ident</code> first and then forward that to <code>map</code> (<code>ident</code> is also one of the exceptions to this rule), falling back to <code>ty</code> otherwise</p>



<a name="266528851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> devsnek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528851">(Dec 31 2021 at 23:23)</a>:</h4>
<p>i can't match on ident, there are actual types being used</p>



<a name="266528918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528918">(Dec 31 2021 at 23:24)</a>:</h4>
<p>Types and idents are not mutually exclusive; with your <code>u32</code> case it would work just fine</p>



<a name="266528934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/possible%20compiler%20bug%20with%20macro%20expansion%3F/near/266528934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> devsnek <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/possible.20compiler.20bug.20with.20macro.20expansion.3F.html#266528934">(Dec 31 2021 at 23:24)</a>:</h4>
<p><code>&amp;str</code> for example. <code>$(tt)+</code> won't work because it is ambiguous</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>