<html>
<head><meta charset="utf-8"><title>how to suggest `use` for tokio_main #87613 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html">how to suggest `use` for tokio_main #87613</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261519548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261519548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261519548">(Nov 15 2021 at 16:13)</a>:</h4>
<p>Hey, I’m looking at <a href="https://github.com/rust-lang/rust/issues/87613">#87613</a> and am flip-flopping between wildly different ways to approach the problem</p>



<a name="261519675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261519675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261519675">(Nov 15 2021 at 16:14)</a>:</h4>
<p>Here is the heart of the problem: <code>#[tokio::main]</code> is a procedural macro (invoked as an attribute), and part of what it does is <em>delete</em> the <code>async</code> keyword from its expansion.</p>



<a name="261520005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520005">(Nov 15 2021 at 16:16)</a>:</h4>
<p>An unintended side-effect of this is that if you start with an <code>async fn</code>-item, you get an <code>fn</code>-item, and the spans you extract from that <code>fn</code>-item start six characters further into the stream than the original <code>async fn</code>-item. Meanwhile, the <code>UsePlacementFinder</code> in <code>rustc_resolve</code> will often end up trying to use those new spans as the basis for its suggestions of what <code>use</code>-items to insert into your code.</p>



<a name="261520145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520145">(Nov 15 2021 at 16:17)</a>:</h4>
<p>And because the expanded <code>fn</code>-item has a span that starts six characters later, the suggested <code>use</code>-item also starts six characters later. Notably, the <code>use</code>-item it suggests starts immediately after the <code>async</code> keyword that is still sitting around in the source text.</p>



<a name="261520288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520288">(Nov 15 2021 at 16:18)</a>:</h4>
<p>This is what ends up causing weird looking suggestions like: </p>
<div class="codehilite"><pre><span></span><code>help: consider importing one of these items
  |
2 | async use std::process::Command;
  |       ^^^^^^^^^^^^^^^^^^^^^^^^^^
2 | async use tokio::process::Command;
  |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre></div>



<a name="261520407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520407">(Nov 15 2021 at 16:19)</a>:</h4>
<p>It feels like a better fallback for not finding any extern crate / existing use is to insert into the top of the file (well, after any <code>#![foo]</code> attributes, including module doc comments)</p>



<a name="261520445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520445">(Nov 15 2021 at 16:19)</a>:</h4>
<p>Or the top of the module, rather</p>



<a name="261520459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520459">(Nov 15 2021 at 16:19)</a>:</h4>
<p>sure, yeah</p>



<a name="261520461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520461">(Nov 15 2021 at 16:19)</a>:</h4>
<p>I’ve been musing about trying to do that.</p>



<a name="261520571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520571">(Nov 15 2021 at 16:20)</a>:</h4>
<p>Is there an expectation that users "get wrong" the place to put the use commonly? (That is, do we have to synthesize a line number)?</p>



<a name="261520628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520628">(Nov 15 2021 at 16:20)</a>:</h4>
<p>It feels like a simpler fix may be to just not try to put other stuff on the same line as the suggestion</p>



<a name="261520644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520644">(Nov 15 2021 at 16:20)</a>:</h4>
<p>i.e., find a blank line or "create" one or something</p>



<a name="261520671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520671">(Nov 15 2021 at 16:20)</a>:</h4>
<p>Hmm. I don’t know. I think the main issue is exactly the case where there’s a nested module</p>



<a name="261520714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520714">(Nov 15 2021 at 16:21)</a>:</h4>
<p>in the common case, there won’t be a nested module, and indeed, the start of the file will be just fine</p>



<a name="261520765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520765">(Nov 15 2021 at 16:21)</a>:</h4>
<p>well, in particular, my thinking is -- the problem here is that we generate <code>async use</code> because we're trying to create a snippet from the existing line</p>



<a name="261520782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520782">(Nov 15 2021 at 16:21)</a>:</h4>
<p>but when the <code>fn</code>-item occurs inside another module, then I think it will be best to indeed direct the user to <em>some</em> appropriate line number</p>



<a name="261520784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520784">(Nov 15 2021 at 16:21)</a>:</h4>
<p>but it's not clear to me that just using that line number but not the line's contents is a bad idea</p>



<a name="261520922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520922">(Nov 15 2021 at 16:22)</a>:</h4>
<p>I guess that breaks down for editor suggestions?</p>



<a name="261520931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520931">(Nov 15 2021 at 16:22)</a>:</h4>
<p>Ah I see. Take the line number from the span of the given <code>fn</code>-item, but construct a span that starts from … column zero of that line?</p>



<a name="261520952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261520952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261520952">(Nov 15 2021 at 16:22)</a>:</h4>
<p>something like that, yeah.</p>



<a name="261521029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521029">(Nov 15 2021 at 16:22)</a>:</h4>
<p>I don’t yet know if our span operations even make such a construction easy</p>



<a name="261521036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521036">(Nov 15 2021 at 16:22)</a>:</h4>
<p>Let me look</p>



<a name="261521082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521082">(Nov 15 2021 at 16:23)</a>:</h4>
<p>(obviously, that fails for <code>mod foo { fn bar() { ... } }</code> or some such, all on one line)</p>



<a name="261521092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521092">(Nov 15 2021 at 16:23)</a>:</h4>
<p>Yeah</p>



<a name="261521189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521189">(Nov 15 2021 at 16:23)</a>:</h4>
<p>and also, editor suggestions will indeed go nuts on the column zero based suggestion when you have something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[tokio::main]</span><span class="w"></span>
<span class="cm">/* multi line</span>
<span class="cm">comment */</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="w"></span>
</code></pre></div>



<a name="261521277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521277">(Nov 15 2021 at 16:24)</a>:</h4>
<p>it seems like we really want "blank line, not in anything" top of this module</p>



<a name="261521292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521292">(Nov 15 2021 at 16:24)</a>:</h4>
<p>which may be complicated to actually get</p>



<a name="261521357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521357">(Nov 15 2021 at 16:24)</a>:</h4>
<p>(re:editor suggestions, I'm not actually sure rust-analyzer uses these, at least, so maybe it's not really that important)</p>



<a name="261521452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521452">(Nov 15 2021 at 16:25)</a>:</h4>
<p>In any case, anything that ends up making us <em>not</em> emit the <code>async</code> in the suggested <code>use</code>-item will be a huge improvement</p>



<a name="261521479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521479">(Nov 15 2021 at 16:25)</a>:</h4>
<p>IOW, maybe not making this MachineApplicable and instead just showing the use statement and leaving it to the user to insert it seems potentially fine to me</p>



<a name="261521506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521506">(Nov 15 2021 at 16:25)</a>:</h4>
<p>(still with a decent-ish line number, but without any surrounding context)</p>



<a name="261521515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261521515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261521515">(Nov 15 2021 at 16:26)</a>:</h4>
<p>yeah</p>



<a name="261565469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261565469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261565469">(Nov 15 2021 at 21:57)</a>:</h4>
<p>BTW, there are some similar duplicates for that issue (<a href="https://github.com/rust-lang/rust/issues/89810">#89810</a> and <a href="https://github.com/rust-lang/rust/issues/86241">#86241</a>), you may want to consolidate them.</p>
<p>I like the idea of:  if there are other <code>use</code> items, group with them.  If not, place at the top of the module (after any inner attributes).  </p>
<p>(Ideally the <code>UsePlacementFinder</code> would be as good as rust-analyzer.  I wonder how hard it would be to have it be similar?)</p>



<a name="261593517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593517">(Nov 16 2021 at 03:28)</a>:</h4>
<p>after some exploration of the design space here, my current preferred approach is this: continue falling back on a span derived from the given item where the resolution error occurred (the macro-generated <code>fn main</code> in this case), <em>but</em>, when generating the suggestion, uee a new output mode that avoids transcribing the surrounding text, replacing all non-whitespace with space characters.</p>



<a name="261593606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593606">(Nov 16 2021 at 03:30)</a>:</h4>
<p>so for my current unit test, this currently produces the following output:</p>
<div class="codehilite"><pre><span></span><code>error[E0433]: failed to resolve: use of undeclared type `Command`
  --&gt; /home/ubuntu/Dev/Rust/rust-87613/src/test/ui/proc-macro/amputate-span.rs:48:5
   |
48 |     Command::new(&quot;git&quot;);
   |     ^^^^^^^ not found in this scope
   |
help: consider importing this struct
   |
47 |              use std::process::Command;
   |
</code></pre></div>



<a name="261593702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593702">(Nov 16 2021 at 03:31)</a>:</h4>
<p>the reasoning behind this: <em>any</em> choice of indentation is going to be a heuristic. The current system actually yields a very effective heuristic much of the time, since most of  the time, the span of the item has a <code>.lo</code> field that corresponds perfectly to the indentation you want to use.</p>



<a name="261593792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593792">(Nov 16 2021 at 03:32)</a>:</h4>
<p>the other options that we’re exploring above, of trying to place it at the top of the module, are going to be hard to get the indentation right, at least based on our current architecture.</p>



<a name="261593874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593874">(Nov 16 2021 at 03:34)</a>:</h4>
<p>(for example: when inserting into an inline module, you don’t get a span for the start of that <code>mod { … }</code>; it is a span that instead starts covers the <code>…</code> alone. So you’d have to do some guessing to figure out how far to indent the <code>use</code>-item that you suggest</p>



<a name="261593941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593941">(Nov 16 2021 at 03:35)</a>:</h4>
<p>Another option of course is to just abandon trying to produce a suggestion that has an indentation that matches the context of where it occurs. But this seems like a strict regression in quality compared to the approach I’m prototyping now.</p>



<a name="261593961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261593961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261593961">(Nov 16 2021 at 03:35)</a>:</h4>
<p>Anyway I should have a Pull Request up soon</p>



<a name="261596850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261596850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261596850">(Nov 16 2021 at 04:31)</a>:</h4>
<p>PR is now up: <a href="https://github.com/rust-lang/rust/issues/90941">#90941</a></p>



<a name="261597241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/how%20to%20suggest%20%60use%60%20for%20tokio_main%20%2387613/near/261597241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613.html#261597241">(Nov 16 2021 at 04:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/131828-t-compiler/topic/how.20to.20suggest.20.60use.60.20for.20tokio_main.20.2387613/near/261593792">said</a>:</p>
<blockquote>
<p>the other options that we’re exploring above, of trying to place it at the top of the module, are going to be hard to get the indentation right, at least based on our current architecture.</p>
</blockquote>
<p>(they would also  run afoul of inline attributes. You’d want to try to skip over those. Seems easier to just go with what I’ve proposed in PR <a href="https://github.com/rust-lang/rust/issues/90941">#90941</a>)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>