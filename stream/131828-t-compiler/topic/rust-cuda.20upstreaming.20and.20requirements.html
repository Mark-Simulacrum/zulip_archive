<html>
<head><meta charset="utf-8"><title>rust-cuda upstreaming and requirements · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html">rust-cuda upstreaming and requirements</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264110948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264110948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264110948">(Dec 08 2021 at 04:32)</a>:</h4>
<p>There was also another issue i was wondering about, the codegen exposes internal things to cuda_std, then cuda_std provides a stable interface to them, it is kind of impossible to do anything with the codegen unless you also use cuda_std. How would this issue be resolved? it would be a bit useless to have a stable target and an unstable interface to it</p>



<a name="264110987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264110987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264110987">(Dec 08 2021 at 04:33)</a>:</h4>
<p>Would we have to stabilize an interface to the codegen through something like core::arch or something?</p>



<a name="264111064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111064">(Dec 08 2021 at 04:34)</a>:</h4>
<p>But then you get into the issue of having to bump MSRV every time the codegen wants to add a new feature, because now cuda_std only works with that stable version and up</p>



<a name="264111195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111195">(Dec 08 2021 at 04:36)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> should prob also rename this thread to something better, like rust-cuda upstreaming or something</p>



<a name="264111242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111242">(Dec 08 2021 at 04:37)</a>:</h4>
<p>Either that, or core exposes the internal stuff through itself, like declaring a kernel, then cuda_std builds on top of that, but then you still have the MSRV issue</p>



<a name="264111306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111306">(Dec 08 2021 at 04:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements/near/264110987">said</a>:</p>
<blockquote>
<p>Would we have to stabilize an interface to the codegen through something like core::arch or something?</p>
</blockquote>
<p>Ideally you'd expose appropriate target-specific intrinsics, and then if someone wants to implement that same target on another codegen they could implement those same intrinsics.</p>



<a name="264111324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111324">(Dec 08 2021 at 04:39)</a>:</h4>
<p>Another alternative would be to expose higher-level mechanisms in <code>std</code>.</p>



<a name="264111333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111333">(Dec 08 2021 at 04:39)</a>:</h4>
<p>Well the codegen actually communicates mostly through attrs</p>



<a name="264111336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111336">(Dec 08 2021 at 04:39)</a>:</h4>
<p>We've also talked about the idea of having <code>-Zbuild-std</code> work for a std that comes from <a href="http://crates.io">crates.io</a>...</p>



<a name="264111341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111341">(Dec 08 2021 at 04:39)</a>:</h4>
<p>currently for declaring kernels and declaring address spaces for statics</p>



<a name="264111346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111346">(Dec 08 2021 at 04:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements/near/264111333">said</a>:</p>
<blockquote>
<p>Well the codegen actually communicates mostly through attrs</p>
</blockquote>
<p>(Side note: those would need to get reviewed for stabilization, orthogonally to the target being upstreamed.)</p>



<a name="264111353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111353">(Dec 08 2021 at 04:39)</a>:</h4>
<p>Yeah</p>



<a name="264111419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111419">(Dec 08 2021 at 04:40)</a>:</h4>
<p>There aren't a ton of things that need special codegen handling, and i could prob knock most of those out before stabilization, but im not sure</p>



<a name="264111440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111440">(Dec 08 2021 at 04:40)</a>:</h4>
<p>the 2 major things are <code>#[nvvm_internal(kernel)]</code>, and <code>#[nvvm_internal(address_space(...)]</code></p>



<a name="264111445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111445">(Dec 08 2021 at 04:41)</a>:</h4>
<p>FWIW, "address spaces for statics" (and for non-statics) is something I'd love to have a <em>general</em> attribute for, not just cuda.</p>



<a name="264111465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111465">(Dec 08 2021 at 04:41)</a>:</h4>
<p>Yeah i could probably PR the stuff i did to cg_nvvm back to cg_llvm for that</p>



<a name="264111466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111466">(Dec 08 2021 at 04:41)</a>:</h4>
<p><code>#[address_space(...)]</code> should be a thing, no <code>nvvm</code> required.</p>



<a name="264111477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111477">(Dec 08 2021 at 04:41)</a>:</h4>
<p>hmm yeah but nobody remembers address space numbers for cuda ;)</p>



<a name="264111484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111484">(Dec 08 2021 at 04:41)</a>:</h4>
<p>They should ideally have semantic names. :)</p>



<a name="264111521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111521">(Dec 08 2021 at 04:42)</a>:</h4>
<p>(or strings interpretable by the target, perhaps)</p>



<a name="264111523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111523">(Dec 08 2021 at 04:42)</a>:</h4>
<p>like target-specific options?</p>



<a name="264111535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111535">(Dec 08 2021 at 04:42)</a>:</h4>
<p>Can you give me an example of what the CUDA address spaces actually are?</p>



<a name="264111550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111550">(Dec 08 2021 at 04:43)</a>:</h4>
<p>theres 4 of them, global, shared, constant, and local, global is normal memory every thread can use, shared is super fast memory shared in individual blocks, constant is global mem but read-only, local is thread-local memory</p>



<a name="264111569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111569">(Dec 08 2021 at 04:43)</a>:</h4>
<p>each one has its own weird things, like anything declared in shared will be uninitialized no matter if u specify an initializer (libnvvm will delete it)</p>



<a name="264111571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111571">(Dec 08 2021 at 04:43)</a>:</h4>
<p>So, I think something like <code>#[address_space("constant")]</code> or <code>#[address_space("local")]</code> might make sense.</p>



<a name="264111612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111612">(Dec 08 2021 at 04:44)</a>:</h4>
<p>although one big thing i do is automatically put any freeze/non-mutable static in constant addrspace, but thats mostly a codegen detail</p>



<a name="264111625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111625">(Dec 08 2021 at 04:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements/near/264111569">said</a>:</p>
<blockquote>
<p>each one has its own weird things, like anything declared in shared will be uninitialized no matter if u specify an initializer (libnvvm will delete it)</p>
</blockquote>
<p>One nice thing about the compiler semantically understanding the address spaces: we should warn or possibly error if you have an initializer then.</p>



<a name="264111631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111631">(Dec 08 2021 at 04:44)</a>:</h4>
<p>but then that gets into target-specific handling...</p>



<a name="264111632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111632">(Dec 08 2021 at 04:44)</a>:</h4>
<p>a lot of it</p>



<a name="264111637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111637">(Dec 08 2021 at 04:44)</a>:</h4>
<p>That's fine, the address spaces <em>can</em> be target specific.</p>



<a name="264111648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111648">(Dec 08 2021 at 04:44)</a>:</h4>
<p>it would have to be a very unsafe attr, but we dont have those yet</p>



<a name="264111666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111666">(Dec 08 2021 at 04:45)</a>:</h4>
<p>We have attributes that you can't write if you have <code>deny(unsafe_code)</code>.</p>



<a name="264111670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111670">(Dec 08 2021 at 04:45)</a>:</h4>
<p>hmm</p>



<a name="264111673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111673">(Dec 08 2021 at 04:45)</a>:</h4>
<p>Like no_mangle.</p>



<a name="264111681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111681">(Dec 08 2021 at 04:45)</a>:</h4>
<p>oh can you really not do that?</p>



<a name="264111682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111682">(Dec 08 2021 at 04:45)</a>:</h4>
<p>i didnt know that</p>



<a name="264111684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111684">(Dec 08 2021 at 04:45)</a>:</h4>
<p>i mean, i know how no_mangle can cause ub</p>



<a name="264111729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111729">(Dec 08 2021 at 04:46)</a>:</h4>
<p>We did a review a while back and marked any attribute that could cause UB as effectively unsafe.</p>



<a name="264111745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111745">(Dec 08 2021 at 04:46)</a>:</h4>
<p>Yeah the address space issue isnt too bad, but the <code>#[kernel]</code> issue is much more target-specific</p>



<a name="264111757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111757">(Dec 08 2021 at 04:46)</a>:</h4>
<p>So, can you explain what <code>#[kernel]</code> identifies in CUDA? An entry point?</p>



<a name="264111772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111772">(Dec 08 2021 at 04:47)</a>:</h4>
<p>(I know what a kernel is in general, I'm asking what the attribute means.)</p>



<a name="264111782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111782">(Dec 08 2021 at 04:47)</a>:</h4>
<p>It does a lot of things actually, it does safety checks like making sure params are Copy, it marks the function extern C, it forces it to have no return value, (not added yet) it parses some custom attributes for optimization, it tells the codegen to not remove it during DCE, and tells libnvvm its a kernel</p>



<a name="264111830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111830">(Dec 08 2021 at 04:48)</a>:</h4>
<p>So, my <em>first</em> guess would be to make it an ABI. <code>extern "cuda-kernel"</code>.</p>



<a name="264111837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111837">(Dec 08 2021 at 04:48)</a>:</h4>
<p>We already have target-specific ABIs.</p>



<a name="264111839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111839">(Dec 08 2021 at 04:48)</a>:</h4>
<p>thats kind of a thing, <code>extern "ptx-kernel"</code>, but its broken currently</p>



<a name="264111846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111846">(Dec 08 2021 at 04:48)</a>:</h4>
<p>We could fix it. :)</p>



<a name="264111848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111848">(Dec 08 2021 at 04:48)</a>:</h4>
<p>Yeah</p>



<a name="264111850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111850">(Dec 08 2021 at 04:49)</a>:</h4>
<p>Seems preferable, rather than an attribute.</p>



<a name="264111859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111859">(Dec 08 2021 at 04:49)</a>:</h4>
<p>the codegen also does some special abi handling for it, like guaranteeing the pass modes of certain things</p>



<a name="264111867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111867">(Dec 08 2021 at 04:49)</a>:</h4>
<p>That sounds even more like an <code>extern "ABI"</code>. :)</p>



<a name="264111872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111872">(Dec 08 2021 at 04:49)</a>:</h4>
<p>im also not 100% sure, but i think you are not allowed to call kernels from other kernels or other functions</p>



<a name="264111881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111881">(Dec 08 2021 at 04:49)</a>:</h4>
<p>so that may need a little bit of rustc handling</p>



<a name="264111946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111946">(Dec 08 2021 at 04:50)</a>:</h4>
<p>That still seems OK to me, in terms of how much we expect rustc to know about a target-specific ABI.</p>



<a name="264111972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111972">(Dec 08 2021 at 04:51)</a>:</h4>
<p>nvvm also has some special properties u can provide for kernels through metadata which are helpful <a href="https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#global-property-annotation-chapter-11">https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#global-property-annotation-chapter-11</a></p>



<a name="264111987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111987">(Dec 08 2021 at 04:51)</a>:</h4>
<p>minctasm, reqntid, and maxntid</p>



<a name="264111992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264111992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264111992">(Dec 08 2021 at 04:51)</a>:</h4>
<p>i havent implemented them yet but i plan to in the future</p>



<a name="264112135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264112135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264112135">(Dec 08 2021 at 04:54)</a>:</h4>
<p>Other than that, i don't think theres anything else that needs special codegen communication</p>



<a name="264112145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264112145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264112145">(Dec 08 2021 at 04:54)</a>:</h4>
<p>everything else is inline asm or intrinsics</p>



<a name="264112160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264112160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264112160">(Dec 08 2021 at 04:54)</a>:</h4>
<p>although i cant link to llvm intrinsics on stable because its unstable <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="264112366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264112366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264112366">(Dec 08 2021 at 04:59)</a>:</h4>
<p>so that will probably be a blocker for stabilization since you need llvm intrinsics to do literally anything inside of a cuda kernel, including querying the thread id</p>



<a name="264112376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264112376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264112376">(Dec 08 2021 at 04:59)</a>:</h4>
<p>well... you can use inline asm but that is kind of cursed and probably inefficient</p>



<a name="264116615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264116615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264116615">(Dec 08 2021 at 06:24)</a>:</h4>
<p>You could wrap those intrinsics in stable APIs.</p>



<a name="264116621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264116621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264116621">(Dec 08 2021 at 06:25)</a>:</h4>
<p>(even if the stable APIs just re-export the intrinsics.)</p>



<a name="264208980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264208980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264208980">(Dec 08 2021 at 19:40)</a>:</h4>
<p>Yeah, core::arch::nvptx already has some of them, but its unstable because of stdsimd, so we may have to decouple arch::nvptx from stdsimd, since stdsimd is years away from being stable. Its missing a lot of things too but that can be fixed</p>



<a name="264209135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264209135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264209135">(Dec 08 2021 at 19:41)</a>:</h4>
<p>As for per-kernel attributes, im not sure what could be done, i dont see a way to do it without a special attr</p>



<a name="264209401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264209401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264209401">(Dec 08 2021 at 19:43)</a>:</h4>
<p>Also, for address spaces, the only reason i could do it in my codegen is because libnvvm has the concept of generic pointers (not in a specific addrspace), so i could just addrspacecast the global from specific to generic when rustc wants it, otherwise, its kind of impossible to do because rustc would need to keep track of addrspaces since llvm doesnt allow things like bitcasting between addrspaces</p>



<a name="264209501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264209501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264209501">(Dec 08 2021 at 19:44)</a>:</h4>
<p>although i think llvm has an InferAddressSpaces pass which can "expand" generic address spaces to specific</p>



<a name="264209804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264209804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264209804">(Dec 08 2021 at 19:46)</a>:</h4>
<p>As for the ptx-kernel abi, should i open an issue of some sort detailing what needs to be done? that can be fixed before upstreaming the whole codegen</p>



<a name="264211672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264211672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264211672">(Dec 08 2021 at 19:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements/near/264209804">said</a>:</p>
<blockquote>
<p>As for the ptx-kernel abi, should i open an issue of some sort detailing what needs to be done? that can be fixed before upstreaming the whole codegen</p>
</blockquote>
<p>Makes sense to me.</p>



<a name="264212195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264212195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264212195">(Dec 08 2021 at 20:02)</a>:</h4>
<p>Alright, most of the work id say is deciding on how different types should be passed through the ABI. Which is <strong>very</strong> important because if it is unpredictable it can yield some nice unsoundness</p>



<a name="264212386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rust-cuda%20upstreaming%20and%20requirements/near/264212386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rust-cuda.20upstreaming.20and.20requirements.html#264212386">(Dec 08 2021 at 20:04)</a>:</h4>
<p>Currently the codegen defines the following pass modes for the following types:</p>
<ul>
<li>ADTs are always passed by value.</li>
<li>Arrays are passed by value</li>
<li>Slices are passed as 2 params, pointer and length.</li>
<li>ZSTs are ignored</li>
<li>Primitives map to special ptx types, 128 bit numbers are passed as byte arrays (same as structs)</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>