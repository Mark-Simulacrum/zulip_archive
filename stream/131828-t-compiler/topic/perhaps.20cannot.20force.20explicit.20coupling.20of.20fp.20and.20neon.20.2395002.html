<html>
<head><meta charset="utf-8"><title>perhaps cannot force explicit coupling of fp and neon #95002 · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html">perhaps cannot force explicit coupling of fp and neon #95002</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275721527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275721527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275721527">(Mar 17 2022 at 20:30)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="281757">@Jubilee</span></p>



<a name="275722039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275722039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275722039">(Mar 17 2022 at 20:34)</a>:</h4>
<p>background context for others following along: a month ago, we were looking at PR <a href="https://github.com/rust-lang/rust/issues/91608">#91608</a> in a T-compiler meeting</p>



<a name="275722043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275722043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275722043">(Mar 17 2022 at 20:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bweekly.5D.202022-02-17.20.2354818/near/272275351">said</a>:</p>
<blockquote>
<p>I'm OK with a compromise solution where we force both features to be enabled/disabled together. But I don't want to merge the features since they are separate in the ISA spec.</p>
</blockquote>



<a name="275722103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275722103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275722103">(Mar 17 2022 at 20:34)</a>:</h4>
<p>the above was the rough compromise that we said we'd look into in that meeting, and we said we'd have further conversation on the PR itself</p>



<a name="275722197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275722197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275722197">(Mar 17 2022 at 20:35)</a>:</h4>
<p>since then, <a href="https://github.com/rust-lang/rust/issues/95002">#95002</a> was filed</p>



<a name="275722201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275722201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275722201">(Mar 17 2022 at 20:35)</a>:</h4>
<p>Hello.</p>
<p>So in <a href="https://github.com/rust-lang/rust/issues/91608">#91608</a> I brought up an issue that we went back and forth on.<br>
In brief, the issue is this:<br>
Rust developers consider <code>"+neon"</code> to mean functionally the same thing as <code>"+fp, +neon"</code>.<br>
I proposed simply eliminating both, and having one feature as a superset: <code>"+neon"</code>.<br>
This is in accordance with the semantics of the machine: the instructions and architectural state are tied to the same bit to initialize in the firmware, and the Arm manuals do mention the two features separately, they also specify the features <strong>cannot</strong> be configured on or off separately. That no public compiler should allow such.</p>



<a name="275722604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275722604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275722604">(Mar 17 2022 at 20:39)</a>:</h4>
<p>The reason they are expressed as separate for AArch64 is because in AArch32 state, they <strong>are</strong>. There is another possible FPU. It is not so in AArch64. The machine is defined to have one baseline architectural float processor, the "Neon" Advanced SIMD unit, that handles both vector instructions and floating point instructions, matching common practice in e.g. x86-64 which does the same with SSE2 and xmm registers.</p>



<a name="275723241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275723241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275723241">(Mar 17 2022 at 20:41)</a>:</h4>
<p>meanwhile, <span class="user-mention" data-user-id="382356">@Adam Gemmell</span> has posted PR <a href="https://github.com/rust-lang/rust/issues/95044">#95044</a> as a fix for <a href="https://github.com/rust-lang/rust/issues/95002">#95002</a></p>



<a name="275723526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275723526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275723526">(Mar 17 2022 at 20:43)</a>:</h4>
<p>where <a href="https://github.com/rust-lang/rust/issues/95044">#95044</a> makes the presence of "neon" (on the function's features, for aarch64) implicitly add "fp" to that feature list, if necessary</p>



<a name="275723638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275723638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275723638">(Mar 17 2022 at 20:44)</a>:</h4>
<p>In x86's "long mode", however, the x87 FPU is still available as a separate unit that can handle separate instructions, this is not the same for AArch64 which only has Neon and in fact the "Neon" feature in AArch64 is subtly different from the "Neon" feature in AArch32 in several ways. Ahem.</p>
<p>Yes.<br>
<a href="https://github.com/rust-lang/rust/issues/95002">#95002</a> is only a problem because the existing practice is to treat <code>"+neon"</code> as <code>"+neon, +fp"</code>.</p>



<a name="275723780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275723780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275723780">(Mar 17 2022 at 20:45)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> so just to clarify: something called "neon" <em>is</em> available on AArch32? Is there anything in the Arm ARM about mixing "neon" and "fp" in the context of AArch32 ?</p>



<a name="275723806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275723806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275723806">(Mar 17 2022 at 20:45)</a>:</h4>
<p>Correct.</p>



<a name="275724180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724180">(Mar 17 2022 at 20:48)</a>:</h4>
<p>At this point the breakage shown in <a href="https://github.com/rust-lang/rust/issues/95002">#95002</a> does seem to make a case for having "neon" imply "fp" in the context of AArch64. (I don't yet have a position for other contexts, and I'm not sure whether the way its <em>implemented</em> in PR <a href="https://github.com/rust-lang/rust/issues/95044">#95044</a> is exactly how I would do it, but that's probably because <code>&amp;mut iter().stuff().collect()</code> makes me pretty nervous.)</p>



<a name="275724422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724422">(Mar 17 2022 at 20:50)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> is already assigned as a reviewer for PR <a href="https://github.com/rust-lang/rust/issues/95044">#95044</a>, and <a href="https://github.com/rust-lang/rust/issues/95002">#95002</a> has been flagged as a stable-to-nightly regression. I'm confident we'll address this within a week. Hopefully even sooner.</p>



<a name="275724511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724511">(Mar 17 2022 at 20:50)</a>:</h4>
<p>I'm looking at it now.</p>



<a name="275724528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724528">(Mar 17 2022 at 20:50)</a>:</h4>
<p>thanks!</p>



<a name="275724565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724565">(Mar 17 2022 at 20:51)</a>:</h4>
<p>The situation is still a bit muddy though, I need to double-check some stuff.</p>



<a name="275724577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724577">(Mar 17 2022 at 20:51)</a>:</h4>
<p>The story for how floating point works on pre-AArch64 Arm is...<br>
...complicated.</p>
<p>Which actually is why I am relatively insistent on trying to expose the simplest interface possible for AArch64. It is absolute hell to debug floating point feature toggles on x86-64 if you tinker with them, to even understand what is happening.</p>



<a name="275724739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724739">(Mar 17 2022 at 20:52)</a>:</h4>
<p>I would rather avoid another "have you tried both <code>-sse2</code> and <code>-sse</code>?" if we can.</p>



<a name="275724759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724759">(Mar 17 2022 at 20:52)</a>:</h4>
<p>Personally I would prefer if all the dependencies between features were explicitly handled in rustc, rather than passing the responsibility off to LLVM.</p>



<a name="275724798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724798">(Mar 17 2022 at 20:52)</a>:</h4>
<p>I agree.</p>



<a name="275724931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275724931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275724931">(Mar 17 2022 at 20:53)</a>:</h4>
<p>I think that we can probably do several things to improve the Rust ABI situation if we do.</p>



<a name="275725217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275725217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275725217">(Mar 17 2022 at 20:55)</a>:</h4>
<p>Looking, and we don't have a <code>"+fp"</code> feature for "just Arm" (AArch32).</p>



<a name="275725404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275725404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275725404">(Mar 17 2022 at 20:56)</a>:</h4>
<p>The closest thing is <code>vfp2</code></p>



<a name="275725506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275725506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275725506">(Mar 17 2022 at 20:57)</a>:</h4>
<p>Yeah, we have +neon for AArch32 and also all these:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="p">(</span><span class="s">"vfp2"</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">sym</span>::<span class="n">arm_target_feature</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="s">"vfp3"</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">sym</span>::<span class="n">arm_target_feature</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="s">"vfp4"</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">sym</span>::<span class="n">arm_target_feature</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="s">"fp-armv8"</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">sym</span>::<span class="n">arm_target_feature</span><span class="p">)),</span><span class="w"></span>
</code></pre></div>



<a name="275726612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275726612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275726612">(Mar 17 2022 at 21:03)</a>:</h4>
<p>The ARM target features are a mess and need to be completely reworked eventually, I don't want to think too hard about them right now.</p>



<a name="275726621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275726621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275726621">(Mar 17 2022 at 21:03)</a>:</h4>
<p>(The 32-bit ones that is)</p>



<a name="275726630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275726630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275726630">(Mar 17 2022 at 21:03)</a>:</h4>
<p>Yeah, I frankly don't claim to fully understand the nuances of the floating point units <strong>before</strong> the Neon FPU, aside from that they are addressed in a different manner and that they are why AArch32 machines have the ABIs of<br>
"software float"<br>
"hardware float"<br>
"do parameter-passing and and linkage as software float but use hardware float in the actual functions"</p>



<a name="275726712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275726712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275726712">(Mar 17 2022 at 21:04)</a>:</h4>
<p>regardless, best not to overcalibrate on them.</p>



<a name="275727642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275727642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275727642">(Mar 17 2022 at 21:11)</a>:</h4>
<p>Ah, so in AArch32, the Neon and VFPvN registers overlap, and Neon fully overlaps any VFP unit.</p>



<a name="275729676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275729676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275729676">(Mar 17 2022 at 21:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002/near/275723780">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> so just to clarify: something called "neon" <em>is</em> available on AArch32? Is there anything in the Arm ARM about mixing "neon" and "fp" in the context of AArch32 ?</p>
</blockquote>
<p>so the answer is for AArch32 FPUs, if Neon is also present and enabled then you have the entire architectural state also.<br>
An AArch32 FPU may support Neon and not VFP instructions, however.</p>



<a name="275730093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275730093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275730093">(Mar 17 2022 at 21:28)</a>:</h4>
<p>So the VFP and Neon instruction sets share the same architectural state but they are "actually separate".</p>



<a name="275732255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275732255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275732255">(Mar 17 2022 at 21:46)</a>:</h4>
<p>Actually looking at configurations, however, I think it progresses in the same way in actual practice between all the control registers and the hardware. Things that have Neon have both VFPv3 and Neon.</p>



<a name="275732488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275732488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275732488">(Mar 17 2022 at 21:48)</a>:</h4>
<p>I had seen a report of an Arm CPU that uses Neon only, but it seems to also have VFPv3 enabled.</p>



<a name="275732984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275732984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275732984">(Mar 17 2022 at 21:53)</a>:</h4>
<p>I'm pretty sure that NEON support implies VFPv3.</p>



<a name="275733253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275733253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275733253">(Mar 17 2022 at 21:55)</a>:</h4>
<p>Yeah.</p>
<p>I think the actual difference is that for some compilers, toggling Neon without VFP (<code>-mfpu="neon"</code> vs. <code>-mfpu="neon-vfp3"</code>) prompts the compiler to <strong>prefer</strong> Neon instructions, which can result in some computations coming out differently. That goes away in AArch64 though, as it's fully conformant.</p>



<a name="275743516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275743516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275743516">(Mar 17 2022 at 23:46)</a>:</h4>
<p>I rebased <a href="https://github.com/rust-lang/rust/pull/91608">https://github.com/rust-lang/rust/pull/91608</a>.<br>
So as to summarize the above meandering, since it's a lot: as far as we can tell, Neon always implies full FPU support, regardless of mode, even though the mode changes a fair number of nuances about how that actually works. On AArch64, Neon is the minimum.</p>



<a name="275744477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275744477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275744477">(Mar 17 2022 at 23:59)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95002">#95002</a> arising at all is kind of <strong>why</strong> I said that we should do it:<br>
It is less fragile and more error-resilient to simply <strong>not</strong> have a configuration option that is not separately meaningful.</p>



<a name="275792656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275792656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275792656">(Mar 18 2022 at 12:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002/near/275724739">said</a>:</p>
<blockquote>
<p>I would rather avoid another "have you tried both <code>-sse2</code> and <code>-sse</code>?" if we can.</p>
</blockquote>
<p>if <code>+neon</code> implies <code>+fp</code>, then can we go ahead and make <code>+sse2</code> imply <code>+sse</code>?</p>



<a name="275812599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275812599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275812599">(Mar 18 2022 at 14:50)</a>:</h4>
<p>I'm pretty sure that <code>+sse2</code> implies <code>+sse</code>.</p>



<a name="275812643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275812643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275812643">(Mar 18 2022 at 14:50)</a>:</h4>
<p>Or maybe I'm misunderstanding what is meant?</p>



<a name="275812703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275812703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275812703">(Mar 18 2022 at 14:51)</a>:</h4>
<p>At the codegen backend level maybe, but not at the frontend level.</p>



<a name="275815172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275815172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275815172">(Mar 18 2022 at 15:07)</a>:</h4>
<p>That's interesting.</p>



<a name="275815837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275815837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275815837">(Mar 18 2022 at 15:12)</a>:</h4>
<p>I'm not sure I understand what that means.  Either <code>-Ctarget-feature=+sse2</code> or <code>#[target_feature="sse2"]</code> should also imply sse.  What is meant by "frontend" here?</p>



<a name="275815964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275815964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275815964">(Mar 18 2022 at 15:13)</a>:</h4>
<p>Or perhaps that is in regards to how it interacts with a different backend like cg_clif?</p>



<a name="275817531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275817531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275817531">(Mar 18 2022 at 15:23)</a>:</h4>
<p><code>#[cfg(target_feature = "...")]</code> and checking validity of <code>#[target_feature(enable = "...")]</code> are handled by the frontend, not the backend.</p>



<a name="275817684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275817684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275817684">(Mar 18 2022 at 15:24)</a>:</h4>
<p>The frontend currently doesn't know anything about the relation between features. Except for a hard coded error that neon requires fp enabled I think.</p>



<a name="275818389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275818389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275818389">(Mar 18 2022 at 15:29)</a>:</h4>
<p>Ah, yea, the <code>cfg</code> checking isn't aware of the <code>#[target_feature]</code>.  I believe that is <a href="https://github.com/rust-lang/rust/issues/42515">#42515</a>?  I think the RFC indicated that should work, but that is difficult (impossible?) to do today?</p>



<a name="275819316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275819316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275819316">(Mar 18 2022 at 15:35)</a>:</h4>
<p>Unsafety checking for calls to functions with target features also currently doesn't know about implied features.</p>



<a name="275823079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275823079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275823079">(Mar 18 2022 at 16:01)</a>:</h4>
<p>In LLVM SSE support is represented as a level, rather than bitset. That is, <code>+sse3</code> will set SSE level to SSE3, and thus all SSE revisions before will be enabled. This extends all the way to AVX512: <a href="https://github.com/llvm/llvm-project/blob/920c2e576377281e52adba3e3244fb8a930d3841/llvm/lib/Target/X86/X86Subtarget.h#L637-L648">https://github.com/llvm/llvm-project/blob/920c2e576377281e52adba3e3244fb8a930d3841/llvm/lib/Target/X86/X86Subtarget.h#L637-L648</a></p>



<a name="275823435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275823435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275823435">(Mar 18 2022 at 16:03)</a>:</h4>
<p>I'm not sure if we should encode this sort of thing at the rustc level, primarily because there's nothing preventing Intel or AMD waking one day and deciding that “screw SSE2 in particular” and releasing a chip that has SSE, and AVX but not SSE2.</p>



<a name="275853453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275853453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275853453">(Mar 18 2022 at 19:45)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> It is architecturally incoherent to have SSE3 and not SSE1 and SSE2.<br>
You are correct, however, that it is not so for AVX!<br>
In fact, Intel made chips that had the prototype versions of AVX512 but not SSE support.</p>



<a name="275854030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275854030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275854030">(Mar 18 2022 at 19:50)</a>:</h4>
<p>However, my opinion is that such is not an AMD64 platform, because quite simply, the AMD64 platform is <strong>defined by</strong> including SSE2 support.<br>
Though I suspect what they specifically dropped support, if memory serves, was for legacy encodings.<br>
There are VEX and EVEX encodings of "SSE" instructions, that can only be executed by AVX-enabled processors.</p>



<a name="275854273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275854273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275854273">(Mar 18 2022 at 19:52)</a>:</h4>
<p>this is, IMO, a fundamental problem with the current ways of representing these features. We don't have a good way of saying, "AVX512 but only the xmm and ymm registers, not the full zmm, so it <del>doesn't downclock</del> is calling-convention-compatible with AVX functions?"</p>



<a name="275854343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275854343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275854343">(Mar 18 2022 at 19:53)</a>:</h4>
<p>another related issue: <a href="https://github.com/rust-lang/rust/issues/89586">https://github.com/rust-lang/rust/issues/89586</a></p>



<a name="275858567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275858567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275858567">(Mar 18 2022 at 20:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002/near/275853453">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> It is architecturally incoherent to have SSE3 and not SSE1 and SSE2.<br>
You are correct, however, that it is not so for AVX!<br>
In fact, Intel made chips that had the prototype versions of AVX512 but not SSE support.</p>
</blockquote>
<p>I don't see why that's the case, since SSE2/3/4a  have all only added instructions, and there's nothing to stop them from removing support for these instructions from e.g. decoder.</p>



<a name="275858593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275858593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275858593">(Mar 18 2022 at 20:27)</a>:</h4>
<p>Or more plausibly for somebody to disable one of these for a VM guest.</p>



<a name="275859157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275859157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275859157">(Mar 18 2022 at 20:32)</a>:</h4>
<p>ultimately the thing is that LLVM does not have a stability promise as stringent as we do in this regard.</p>



<a name="275859240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275859240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275859240">(Mar 18 2022 at 20:33)</a>:</h4>
<p>if we make a mistake, we'll live with it forever, just like C is living with e.g. intmax_t. LLVM? if they really want to they can just make a breaking change and pass on the responsibility onto the frontends.</p>



<a name="275859338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275859338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275859338">(Mar 18 2022 at 20:34)</a>:</h4>
<p>Only so-so. The strings can be ignored.</p>



<a name="275859817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275859817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275859817">(Mar 18 2022 at 20:38)</a>:</h4>
<p>IMO, SSE and AVX are actually multiple features, properly considered, before even considering the leveling scheme:</p>
<ul>
<li><strong>feature partie un:</strong> the architectural presence of the xmm, ymm, or zmm registers</li>
<li><strong>feature partie deux:</strong> the instructions that use them</li>
<li><strong>feature partie trois</strong>: the legacy, VEX, and EVEX encodings of these instructions</li>
</ul>



<a name="275860164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275860164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275860164">(Mar 18 2022 at 20:42)</a>:</h4>
<p>that may seem incredibly pedantic but consider the interactions between:</p>
<ul>
<li>legacy-encoded xmm-addressing SSE instructions</li>
<li>VEX-encoded xmm-addressing SSE instructions</li>
<li>VEX-encoded ymm-addressing AVX instructions</li>
</ul>



<a name="275860261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275860261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275860261">(Mar 18 2022 at 20:43)</a>:</h4>
<p>you can combine the xmm+SSE+VEX set with ymm+AVX+VEX <strong>xor</strong> xmm+SSE+legacy</p>



<a name="275860328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275860328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275860328">(Mar 18 2022 at 20:44)</a>:</h4>
<p>combining ymm+AVX+VEX with xmm+SSE+legacy starts triggering speed penalties at minimum.</p>



<a name="275861256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275861256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275861256">(Mar 18 2022 at 20:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002/near/275858567">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002/near/275853453">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> It is architecturally incoherent to have SSE3 and not SSE1 and SSE2.<br>
You are correct, however, that it is not so for AVX!<br>
In fact, Intel made chips that had the prototype versions of AVX512 but not SSE support.</p>
</blockquote>
<p>I don't see why that's the case, since SSE2/3/4a  have all only added instructions, and there's nothing to stop them from removing support for these instructions from e.g. decoder.</p>
</blockquote>
<p>Theoretically, but in a practical sense the only time instruction sets go away is if they get no adoption or don't serve their intended purpose (e.g. MPX).</p>



<a name="275862731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275862731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275862731">(Mar 18 2022 at 21:06)</a>:</h4>
<p>Anyways, as far as AArch64 goes, a more important detail is that the registers are enabled and disabled via the same bit in the processor for both "NEON" and "floating point" functionality, which is why I view having a separate "bit" on the Rust side as unnecessary.</p>



<a name="275862971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275862971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275862971">(Mar 18 2022 at 21:08)</a>:</h4>
<p>Note that it is more complex for AArch32: unlike x86, where "long mode" is reached via transition from protected mode, a processor can have <strong>only</strong> the AArch64 state!</p>



<a name="275863724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275863724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275863724">(Mar 18 2022 at 21:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002/near/275862971">said</a>:</p>
<blockquote>
<p>Note that it is more complex for AArch32: unlike x86, where "long mode" is reached via transition from protected mode, a processor can have <strong>only</strong> the AArch64 state!</p>
</blockquote>
<p>I've seen hypotheses that x86-64 could do the same: start in long mode, and omit 16-bit mode.</p>



<a name="275863867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275863867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275863867">(Mar 18 2022 at 21:15)</a>:</h4>
<p>(Such CPUs don't currently exist, but architecturally it'd be feasible, and current OSes wouldn't care.)</p>



<a name="275864231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275864231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275864231">(Mar 18 2022 at 21:18)</a>:</h4>
<p>I imagine so, I just note it because it's a distinctly different approach.</p>



<a name="275864676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275864676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275864676">(Mar 18 2022 at 21:23)</a>:</h4>
<p>Even if you omitted 16-bit mode, most instructions we think of as "x86-64" instructions actually have a naturally equivalent semantics in protected mode (thus x86-32), and the architectural state is preserved largely as-is. A32 vs. A64 just wholesale tosses that idea.</p>



<a name="275873102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/275873102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#275873102">(Mar 18 2022 at 23:05)</a>:</h4>
<p>And SSE instructions vs. the addressing registers is more obvious when you have things like the new "crc32" feature in LLVM, which, instead of having an <code>(xmm, sse, _)</code> tuple, is <code>(r32, sse4.2, _)</code>.</p>



<a name="276132551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/perhaps%20cannot%20force%20explicit%20coupling%20of%20fp%20and%20neon%20%2395002/near/276132551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/perhaps.20cannot.20force.20explicit.20coupling.20of.20fp.20and.20neon.20.2395002.html#276132551">(Mar 22 2022 at 00:59)</a>:</h4>
<p>Another issue came up: <a href="https://github.com/rust-lang/rust/issues/95122">https://github.com/rust-lang/rust/issues/95122</a><br>
And now <a href="https://github.com/rust-lang/rust/pull/91608">https://github.com/rust-lang/rust/pull/91608</a> includes a fix for it as well.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>