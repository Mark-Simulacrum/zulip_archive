<html>
<head><meta charset="utf-8"><title>function names in `#[track_caller]` · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html">function names in `#[track_caller]`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250883323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250883323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250883323">(Aug 27 2021 at 04:54)</a>:</h4>
<p>Hi, not sure if <a class="stream" data-stream-id="257204" href="/#narrow/stream/257204-project-error-handling">#project-error-handling</a> or <a class="stream" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler">#t-compiler</a> is the best place for this, I'm quite new here.</p>
<p>I am experimenting with <code>#[feature(try_trait_v2)]</code> to write a new <code>Result</code> type. It uses <code>#[track_caller]</code> and <code>FromResidual</code> to automatically append the location of every <code>?</code> invocation to a running stack trace.</p>
<p>My experiments have been a success, but I'm very bummed that I cannot retrieve the <em>function name</em> of the caller from a <code>panic::Location</code>. Having <code>file</code> and <code>line</code> is workable, but having <code>function</code> as well would be pretty damn sweet.</p>
<p>I'd like to ask the community for its opinion on adding the ability to get the caller's function name from <code>#[track_caller]</code>/<code>panic::Location</code>, at least optionally.</p>
<p>There would obviously be code size concerns, so I think a compiler option similar to the <code>-Z location-detail</code> option mentioned <a href="https://github.com/rust-lang/rust/issues/70580">here</a> would be good.</p>
<p>I'd be willing to take a stab at a very rough POC for this. I skimmed through the compiler code and noticed that the <code>caller_location</code> and <code>type_name</code> intrinsics are already very close together, almost begging to be paired up <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span> </p>
<p>What's the process for getting the ball rolling on this if people are generally not opposed to the idea? I was going to make an issue, but GitHub suggested that feature requests should go to the forums.</p>



<a name="250911775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250911775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250911775">(Aug 27 2021 at 10:31)</a>:</h4>
<p>It'll actually be very helpful for rust-for-linux if we can get the function name from <code>Location</code> and the function name is terminated with a <code>\0</code>. There are many C code in the kernel that expects a function name string when called (aka. poor man's track caller <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span>).</p>



<a name="250912435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250912435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250912435">(Aug 27 2021 at 10:38)</a>:</h4>
<p>Another even more powerful extension to track caller would be add a state to it, e.g. <code>AtomicUsize</code>. Kernel has a dead-lock detection called lockdep. It requires a <code>static</code> state at the callsite that creates a mutex. In C it's all wrapped in a macro so user just calls <code>mutex_init</code> but rust-for-linux has to implement it as a macro. If a <code>Location</code> has a state it would also such function to be implemented as a function as well.</p>



<a name="250931587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250931587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250931587">(Aug 27 2021 at 13:30)</a>:</h4>
<p>not everything in rust that can call is a "function" per se.</p>



<a name="250931661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250931661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250931661">(Aug 27 2021 at 13:31)</a>:</h4>
<p>0 termination is a different matter altogether as well.</p>



<a name="250932788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250932788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250932788">(Aug 27 2021 at 13:39)</a>:</h4>
<p>I don't think it would be a huge deal to add a terminating null, but guaranteeing that would be a different matter.</p>



<a name="250932973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250932973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250932973">(Aug 27 2021 at 13:40)</a>:</h4>
<p>because the current APIs return regular rust slices, and its probably not a great design to say "hey we return this, but you can also find a null byte after so feel free to use this for your c needs"</p>



<a name="250933246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250933246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250933246">(Aug 27 2021 at 13:42)</a>:</h4>
<p>I kinda want to say that I wanted function names in the past too sometimes, but in practice I find that module name, line and filename are sufficient enough to me. And I hack on tracing stuff a lot.</p>



<a name="250975378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/250975378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#250975378">(Aug 27 2021 at 18:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60/near/250933246">said</a>:</p>
<blockquote>
<p>I kinda want to say that I wanted function names in the past too sometimes, but in practice I find that module name, line and filename are sufficient enough to me. And I hack on tracing stuff a lot.</p>
</blockquote>
<p>File name and line number is sufficient for diagnosing problems, but it makes the process slower as a human. Often I can get a very good idea about the root cause of an error just by looking at a backtrace that has all the function names. Without function names, I'd have to go digging through code to even form an idea of what's going wrong.</p>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60/near/250931587">said</a>:</p>
<blockquote>
<p>not everything in rust that can call is a "function" per se.</p>
</blockquote>
<p>True, but I think everything in Rust that can call has a useful representation from the <code>type_name</code> intrinsic. See <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=df5975cd589ae7286a769e1c70e7715d">this playground demo</a>.</p>



<a name="254569571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/function%20names%20in%20%60%23%5Btrack_caller%5D%60/near/254569571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60.html#254569571">(Sep 23 2021 at 17:05)</a>:</h4>
<p>I think the point is that some types have non-useful names: closures and generators are printed without differentiation or with their location and nothing else. impl Trait types have similar issues. But I agree that these names might be <em>good enough</em>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>