<html>
<head><meta charset="utf-8"><title>rustc_codegen_ssa, did it pan out? · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html">rustc_codegen_ssa, did it pan out?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254851064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254851064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254851064">(Sep 25 2021 at 16:13)</a>:</h4>
<p>Do we think rustc_codegen_ssa pan out as a way to extract some supposedly common parts around building a crate to a SSA-like IR? As far as I know none of the non-llvm backends actually use parts of <code>rustc_codegen_ssa</code> that are not strictly required for an alternative codegen backend (i.e. traits like <code>CodegenBackend</code> trait and maybe linker invocation stuff?)</p>



<a name="254851146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254851146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254851146">(Sep 25 2021 at 16:14)</a>:</h4>
<p>I was kinda thinking it might be a good idea to replace <code>rustc_codegen_ssa</code> with just <code>rustc_codegen</code> that contains the strictly required parts for implementing a codegen backend and then merging all of the SSA-like stuff back into the <code>_llvm</code>?</p>



<a name="254851176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254851176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254851176">(Sep 25 2021 at 16:15)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span> <span class="user-mention" data-user-id="133247">@bjorn3</span> ^</p>



<a name="254852133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254852133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254852133">(Sep 25 2021 at 16:30)</a>:</h4>
<p>cg_gcc and rust-gpu use cg_ssa heavily. only cg_clif uses a small part of it.</p>



<a name="254852240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254852240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254852240">(Sep 25 2021 at 16:32)</a>:</h4>
<p>cg_ssa is biased towards llvm, but it works reasonably well with codegen backends that are somewhat similar to llvm, like gcc.</p>



<a name="254852266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254852266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254852266">(Sep 25 2021 at 16:32)</a>:</h4>
<p>it could be improved a lot though IMHO.</p>



<a name="254854495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254854495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254854495">(Sep 25 2021 at 17:07)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="404242">@antoyo</span></p>



<a name="254855257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254855257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254855257">(Sep 25 2021 at 17:18)</a>:</h4>
<p>Yes, rustc_codegen_gcc uses rustc_codegen_ssa. I had to use many hacks to make it work though, so it'd be great to improve it. I won't be able to implement some features without changing its API.</p>
<p>My plan was to start proposing changes to cg_ssa once cg_gcc is merged, but here are some areas I'd like to see improvements:</p>
<ul>
<li>rvalue vs lvalue</li>
<li>landing pads (unwinding)</li>
<li>handling of basic blocks (mostly an issue for intrinsics that don't exist in gcc)</li>
<li>function vs value</li>
<li>
<p>AST-based IR vs instruction-based IR<br>
** Example: dereference of pointers in wrong basic block</p>
</li>
<li>
<p>separate aggregate operations (structs, arrays, vectors)</p>
</li>
</ul>
<p>I did talk about those in <a href="https://www.linuxplumbersconf.org/event/11/contributions/903/">my talk at the LPC</a>.</p>
<p>I can provide more details now if needed.</p>



<a name="254856805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254856805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254856805">(Sep 25 2021 at 17:41)</a>:</h4>
<p>Is there a transcript or a recording of the talk?</p>



<a name="254858165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254858165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254858165">(Sep 25 2021 at 18:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/254856805">said</a>:</p>
<blockquote>
<p>Is there a transcript or a recording of the talk?</p>
</blockquote>
<p>Yes, <a href="https://youtu.be/ORwYx5_zmZo?t=5794">here's the recording of that particular slide</a>.</p>
<div class="youtube-video message_inline_image"><a data-id="ORwYx5_zmZo" href="https://youtu.be/ORwYx5_zmZo?t=5794"><img src="https://uploads.zulipusercontent.net/05fc1b0dd842fb4d6b6b22481b2ef6c1a53b612b/68747470733a2f2f692e7974696d672e636f6d2f76692f4f52775978355f7a6d5a6f2f64656661756c742e6a7067"></a></div>



<a name="254867430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254867430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254867430">(Sep 25 2021 at 20:18)</a>:</h4>
<p>My concern with attempting to make <code>_ssa</code> fit more use-cases is that even if we sit down and take all our knowledge into account and design a perfect interface, some other backend will come around and the new well considered interface won't be all that suitable for it.</p>



<a name="254867531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254867531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254867531">(Sep 25 2021 at 20:20)</a>:</h4>
<p>(I also have a feeling that MIR itself is pretty close to a generally great interface here)</p>



<a name="254868311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254868311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254868311">(Sep 25 2021 at 20:33)</a>:</h4>
<p>MIR is way too high-level. You need to reimplement the algorithms for getting and setting discriminants, unsize coercions and worst of all the abi handling. The former werw relatively straight forward to reimplement, but the abi handling too me so many iterations to get right. IMHO the abj handling code in cg_clif right now is much cleaner than the one in cg_ssa. When using cg_ssa this doesn't matter though as the codegen backend basically only needs to implement loads, stores, stack allocation and a way to set param abi flags I think. The rest is handled within cg_ssa. That includes <code>#[track_caller]</code>, <code>extern "rust-call"</code>, indirect and vtable calls (requires making the fat self pointer thin) and abi adjustments.</p>



<a name="254868851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254868851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254868851">(Sep 25 2021 at 20:42)</a>:</h4>
<p>Right, I didn't mean in terms of what is least effort, but in terms of what's most generally usable without resorting to hacks. ABI computation code, at least parts of it that end up describing what's an ABI look like, sounds like something that could be a part of the target code, rather than backend code.</p>



<a name="254868899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254868899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254868899">(Sep 25 2021 at 20:42)</a>:</h4>
<p>Much like layout code isn't part of the backend but rather its own kinda independent component.</p>



<a name="254868949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254868949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254868949">(Sep 25 2021 at 20:43)</a>:</h4>
<p>Of course there's a downside to not sharing all this code between backends in that with increasing number of backends, the effort to keep all of them updated is also going to increase much more significantly.</p>



<a name="254869288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254869288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254869288">(Sep 25 2021 at 20:48)</a>:</h4>
<p>So from what I'm gathering, the way I should be approaching what I'd like to do is trying to extract and/or move and/or refactor the generally reusable components out of <code>_ssa</code> and we can reconsider other stuff later.</p>



<a name="254869324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254869324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254869324">(Sep 25 2021 at 20:48)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> would clif be at all interested in having <code>_ssa</code> parts that are required to implement a codegen backend split out into its own crate?</p>



<a name="254870482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254870482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254870482">(Sep 25 2021 at 21:06)</a>:</h4>
<p>re abi handling the abi adjustment calculation is handled in a backend independent way in rustc_target and I do use it in cg_clif. The actual performing of these abi adjustements and many other details can't really be done in a generic way without ending up with an interface similar to cg_ssa.</p>



<a name="254870658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254870658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254870658">(Sep 25 2021 at 21:09)</a>:</h4>
<p>I want to try to replace the abi handling code in cg_ssa with that of cg_clif and share it with cg_clif. Sharing may require require replacing cg_ssa's Operand and Place with cg_clif's equivalents though to avoid regressing codegen quality of cg_clif.</p>



<a name="254870902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254870902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254870902">(Sep 25 2021 at 21:13)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> would clif be at all interested in having <code>_ssa</code> parts that are required to implement a codegen backend split out into its own crate?</p>
</blockquote>
<p>I think dissolving cg_ssa will require too much code duplication between backends. On the other hand I would apploud any effort at reducing the LLVMisms in cg_ssa.</p>



<a name="254883711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254883711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254883711">(Sep 26 2021 at 00:48)</a>:</h4>
<p>After working on my own codegen, i would say cg_ssa absolutely did work out for the most part. It made modifying cg_llvm into something that could be used to compile gpu kernels almost scarily simple in relation to how much work it would have been to reimplement the mir lowering. </p>
<p>However, i do think theres still way too many lingering remains of cg_llvm inside cg_ssa, things like the linking logic (why is it all in cg_ssa?). Moreover i feel like control over what the codegen wants to do for optimization should be given back to the codegen. Instead of thin_lto, optimize, etc methods.</p>
<p>I also think docs on it are severely lacking, especially on the actual methods in cg_ssa, i had to do a lot of digging and a lot of bothering bjorn about what some things did ;)</p>



<a name="254884205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254884205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254884205">(Sep 26 2021 at 00:57)</a>:</h4>
<p>i do think that MIR is not low level enough compared to simple operations through traits. I think the lower level interface of cg_ssa is definitely a win. However, i also believe that more control over how cg_ssa actually lowers the MIR would be nice. Something like being able to override how cg_ssa codegens a statement or a function. Maybe going through traits once again that describe mir lowering, not sure.</p>



<a name="254928165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254928165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254928165">(Sep 26 2021 at 12:37)</a>:</h4>
<blockquote>
<p>things like the linking logic (why is it all in cg_ssa?)</p>
</blockquote>
<p>Because it is the same for the majority of the codegen backends. Cg_llvm, cg_gcc and cg_clif need the exact same code for linking as they all produce regular object files as required by conventional linkers.</p>
<blockquote>
<p>Moreover i feel like control over what the codegen wants to do for optimization should be given back to the codegen. Instead of thin_lto, optimize, etc methods.</p>
</blockquote>
<p>I think you can avoid the codegen driver entirely and only use cg_ssa for codegening individual functions.</p>



<a name="254933894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/254933894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#254933894">(Sep 26 2021 at 14:05)</a>:</h4>
<p>One thing I'd like is actually having more stuff in <code>cg_ssa</code>: in <code>cg_gcc</code> there are a bunch of functions copied from <code>cg_llvm</code>, some of them identical, some of them almost identical and could be made the same with a few changes in <code>cg_ssa</code> I guess.</p>



<a name="255247464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255247464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255247464">(Sep 28 2021 at 16:36)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> <span class="user-mention" data-user-id="404242">@antoyo</span> It sounds silly but why not put the linking logic as well as the functions ur talking about in a separate crate, called cg_cpu/cg_cpu_utils or something? I dont really think cg_ssa is the place for it, i think cg ssa should be for abstracting mir lowering and thats it</p>



<a name="255252306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255252306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255252306">(Sep 28 2021 at 17:05)</a>:</h4>
<p>That would be an option. cg_ssa is currently for pretty much everything that only backends use.</p>



<a name="255264711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255264711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255264711">(Sep 28 2021 at 17:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255247464">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <span class="user-mention silent" data-user-id="404242">antoyo</span> It sounds silly but why not put the linking logic as well as the functions ur talking about in a separate crate, called cg_cpu/cg_cpu_utils or something? I dont really think cg_ssa is the place for it, i think cg ssa should be for abstracting mir lowering and thats it</p>
</blockquote>
<p>Which functions? The changes I'd like are refactor of cg_ssa.</p>



<a name="255264832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255264832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255264832">(Sep 28 2021 at 17:38)</a>:</h4>
<p>yeah and i think as rust is targeted for more generic outputs (e.g. spirv or ptx), it would be nice to make cg_ssa just a mir lowering interface and moving the cpu specific stuff elsewhere. cg_ssa is nice but it has some... odd things inside. Random odd functions that are very much cpu-specific (im looking at you insert_reference_to_gdb_debug_scripts_section_global). It feels to me like its for cpu codegen first, and other codegen is just "yeah u can prob do that but it wasnt exactly made for that"</p>



<a name="255264931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255264931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255264931">(Sep 28 2021 at 17:39)</a>:</h4>
<blockquote>
<p>refactor of cg_ssa</p>
</blockquote>
<p>What changes would that entail exactly?</p>



<a name="255265331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255265331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255265331">(Sep 28 2021 at 17:41)</a>:</h4>
<p>Im not super familiar with odd things found outside of using cg_ssa without llvm (because my codegen uses llvm, just an older version and a subset that libnvvm accepts). Could you give some examples?</p>



<a name="255265435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255265435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255265435">(Sep 28 2021 at 17:42)</a>:</h4>
<p>I am familiar with cpu-specific things like linking logic, theres plenty of those "niche" functions in there</p>



<a name="255277393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255277393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255277393">(Sep 28 2021 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255264931">said</a>:</p>
<blockquote>
<blockquote>
<p>refactor of cg_ssa</p>
</blockquote>
<p>What changes would that entail exactly?</p>
</blockquote>
<p>I shared them <a href="#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/254855257">above</a>.</p>



<a name="255278698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255278698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255278698">(Sep 28 2021 at 18:57)</a>:</h4>
<p>oh right i totally forgot, my bad</p>



<a name="255278730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255278730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255278730">(Sep 28 2021 at 18:58)</a>:</h4>
<p>why are basic blocks an issue for intrinsics?</p>



<a name="255278922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255278922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255278922">(Sep 28 2021 at 18:59)</a>:</h4>
<p>are u talking about like, basic block jump/goto things?</p>



<a name="255280384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255280384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255280384">(Sep 28 2021 at 19:07)</a>:</h4>
<p>for value vs function couldnt you represent value as an enum in the codegen?</p>



<a name="255283357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255283357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255283357">(Sep 28 2021 at 19:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255278730">said</a>:</p>
<blockquote>
<p>why are basic blocks an issue for intrinsics?</p>
</blockquote>
<p>I need to do stuff like <a href="https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/intrinsic/mod.rs#L186-L190">this</a> which is error-prone.</p>



<a name="255283697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255283697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255283697">(Sep 28 2021 at 19:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255280384">said</a>:</p>
<blockquote>
<p>for value vs function couldnt you represent value as an enum in the codegen?</p>
</blockquote>
<p>That would still be inconvenient. Just so you understand better, currently I do <a href="https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/builder.rs#L403">unsafe casts</a> (function defined <a href="https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/context.rs#L223">here</a>).</p>



<a name="255287082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255287082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255287082">(Sep 28 2021 at 19:51)</a>:</h4>
<p>Is cg_ssa something that supplies helpers and gets used as a library, or an abstraction layer with hooks?</p>



<a name="255287724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255287724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255287724">(Sep 28 2021 at 19:55)</a>:</h4>
<p>it provides as a library the core traits etc that an actual backend needs to implement to be considered a codegen backend. In addition to that it contains some common code around linker invocation and artifact management as well as an abstraction with some convenience implementation for SSA-like backends.</p>



<a name="255287749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255287749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255287749">(Sep 28 2021 at 19:55)</a>:</h4>
<p>basically it has a lot of stuff that doesn't necessarily need to be a single crate.</p>



<a name="255288037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255288037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255288037">(Sep 28 2021 at 19:56)</a>:</h4>
<p>I think one valid approach to making cg_ssa abstractions more suitable for backends such as the cg_gcc one, might be splitting up cg_ssa into parts that are required for a cg (<code>rustc_codegen</code> perhaps?) and not required (remains in <code>cg_ssa</code>) and then we could e.g. introduce something like <code>cg_ssa2</code> to simplify the efforts in re-abstraction or somesuch.</p>



<a name="255288748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255288748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255288748">(Sep 28 2021 at 20:01)</a>:</h4>
<p>Since cg_gcc is gonna get merged soon, I'll want to start making changes to cg_ssa. What would be the process to do that?</p>



<a name="255289104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255289104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255289104">(Sep 28 2021 at 20:03)</a>:</h4>
<p>I don't see a problem with changing cg_ssa itself either ^^</p>



<a name="255289372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255289372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255289372">(Sep 28 2021 at 20:04)</a>:</h4>
<p>Good. I still wonder what would be the process. Do I need to do a RFC or something?</p>



<a name="255289542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255289542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255289542">(Sep 28 2021 at 20:05)</a>:</h4>
<p>Just PRs seem fine</p>



<a name="255289564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255289564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255289564">(Sep 28 2021 at 20:05)</a>:</h4>
<p>(maybe MCPs)</p>



<a name="255297369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255297369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255297369">(Sep 28 2021 at 20:52)</a>:</h4>
<p>Feel free to cc me on cg_ssa PRs.</p>



<a name="255299607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255299607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255299607">(Sep 28 2021 at 21:07)</a>:</h4>
<p>I think cg_ssa2 would be a weird name for it, i propose:</p>
<ul>
<li>rustc_codegen OR rustc_codegen_ssa: contains the CodegenBackend trait, the bare bones for what can be considered a codegen, as well as convenience traits for doing the MIR lowering for you. BUT contains zero (unlikely but close to zero) cpu specific things like linking.</li>
<li>rustc_codegen_cpu: contains all of the utils that cg_clif, cg_llvm, and cg_gcc for linking and such, that cg_spirv and cg_nvvm do not need.</li>
</ul>



<a name="255300295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255300295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255300295">(Sep 28 2021 at 21:12)</a>:</h4>
<p>Honestly, i think the best long term thing that rustc could do is introduce LIR, but thats a ton of work</p>



<a name="255300415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255300415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255300415">(Sep 28 2021 at 21:13)</a>:</h4>
<p>because then codegens could just retrieve the LIR (which can be optimized beforehand by rustc too), and then rewrite and analyze the entire structure of a function instead of blindly providing functions for adding instructions and such</p>



<a name="255300561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255300561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255300561">(Sep 28 2021 at 21:14)</a>:</h4>
<p>So if for example, cg_gcc cannot deal with a basic block instruction, it can go in and analyze and modify the LIR on its own before it codegens it</p>



<a name="255301184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa%2C%20did%20it%20pan%20out%3F/near/255301184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F.html#255301184">(Sep 28 2021 at 21:17)</a>:</h4>
<p>And additionally, because LIR would be optimization-friendly (because it would be monomorphized and very simplistic), it would open up more opportunities for optimization for backends that dont use an optimizing codegen already (cg_clif and cg_spirv)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>