<html>
<head><meta charset="utf-8"><title>debug generates PLT relocations · t-compiler · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/index.html">t-compiler</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html">debug generates PLT relocations</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255026368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255026368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255026368">(Sep 27 2021 at 10:40)</a>:</h4>
<p>Hi, I am doing a strange thing where I am (ab)using the ELF support in the Watcom linker to create DPMI executables with Rust. However, for <code>_memset</code> (and the likes), rustc generates <code>R_386_PLT32</code> relocations in <strong>debug</strong> whereas in <strong>release</strong> it generates <code>R_386_PC32</code>. Issue is that the Watcom linker does not support PLT relocations. Is there any way to not generate <code>R_386_PLT32</code> relocations in debug? I have tried using <code>-Z plt=off</code> but that does not seem to do anything (this is 32-bit x86 code).</p>
<p>Example:</p>
<div class="codehilite"><pre><span></span><code>readelf -r target/dos/debug/deps/libcore-1f0298ee783f3e78.rlib | grep _memset
00000089  00024504 R_386_PLT32       00000000   _memset
0000009a  00024502 R_386_PC32        00000000   _memset
00000089  00024504 R_386_PLT32       00000000   _memset
00000089  00024504 R_386_PLT32       00000000   _memset
...
</code></pre></div>
<p>whereas release gives</p>
<div class="codehilite"><pre><span></span><code> readelf -r target/dos/release/deps/libcore-57b25a09c66a3e47.rlib  | grep _memset
00000225  0000c702 R_386_PC32        00000000   _memset
000002ac  0000c702 R_386_PC32        00000000   _memset
0000000e  0000b702 R_386_PC32        00000000   _memset
0000001c  0000b702 R_386_PC32        00000000   _memset
00000335  0000b702 R_386_PC32        00000000   _memset
00000016  00007302 R_386_PC32        00000000   _memset
00000023  00007302 R_386_PC32        00000000   _memset
...
</code></pre></div>



<a name="255055830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255055830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255055830">(Sep 27 2021 at 14:20)</a>:</h4>
<p><span class="user-mention" data-user-id="298746">@Albert Cervin</span> What target triple are you compiling for?</p>



<a name="255056116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255056116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255056116">(Sep 27 2021 at 14:22)</a>:</h4>
<p>i686-unknown-none-elf</p>



<a name="255071920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255071920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255071920">(Sep 27 2021 at 15:53)</a>:</h4>
<p>Are you buiding with <code>-Z build-std</code>?</p>



<a name="255072216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255072216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255072216">(Sep 27 2021 at 15:54)</a>:</h4>
<p>I suspect that this is an LLVM issue</p>



<a name="255075174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255075174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255075174">(Sep 27 2021 at 16:11)</a>:</h4>
<p>Yes, exactly. It seems to be an LLVM issue yes (the code that disables decides to not use a PLT reloc seems to check for x64). However, that does not explain the difference between debug and release?</p>



<a name="255077347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255077347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255077347">(Sep 27 2021 at 16:25)</a>:</h4>
<p>My guess is that there's a pass which only runs in release mode</p>



<a name="255077376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255077376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255077376">(Sep 27 2021 at 16:25)</a>:</h4>
<p>which is responsible for adjusting relocations in some way</p>



<a name="255094385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255094385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255094385">(Sep 27 2021 at 18:14)</a>:</h4>
<p>Could it be <a href="https://bugs.llvm.org//show_bug.cgi?id=36674#c6">https://bugs.llvm.org//show_bug.cgi?id=36674#c6</a>?</p>



<a name="255107246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255107246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255107246">(Sep 27 2021 at 19:36)</a>:</h4>
<p>This is actually for the references to for example <code>memset</code> in the init of slices (e.g. <code>[0; 4]</code>). How are those generated?</p>



<a name="255107962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255107962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255107962">(Sep 27 2021 at 19:41)</a>:</h4>
<p>Seems to be this: <a href="https://github.com/rust-lang/rust/blob/22719efcc570b043f2e519d6025e5f36eab38fe2/compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp#L1446">https://github.com/rust-lang/rust/blob/22719efcc570b043f2e519d6025e5f36eab38fe2/compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp#L1446</a></p>



<a name="255109467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255109467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255109467">(Sep 27 2021 at 19:51)</a>:</h4>
<p>which, I guess, should ultimately end up here: <a href="https://github.com/llvm/llvm-project/blob/f7e82e4fa849376ea9226220847a098dc92d74a0/llvm/lib/Target/X86/X86Subtarget.cpp#L217">https://github.com/llvm/llvm-project/blob/f7e82e4fa849376ea9226220847a098dc92d74a0/llvm/lib/Target/X86/X86Subtarget.cpp#L217</a>, but seems not to</p>



<a name="255110395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255110395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255110395">(Sep 27 2021 at 19:57)</a>:</h4>
<p>for _some_ cases of <code>memset</code></p>



<a name="255111000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255111000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255111000">(Sep 27 2021 at 20:01)</a>:</h4>
<p>Could it be that some are generated by LLVM and some by "core" as indicated here: <a href="https://github.com/rust-lang/rust/blob/0273e3bce7a0ce49e96a9662163e2380cb87e0be/library/core/src/lib.rs#L24">https://github.com/rust-lang/rust/blob/0273e3bce7a0ce49e96a9662163e2380cb87e0be/library/core/src/lib.rs#L24</a> and they somehow get annotated differently?</p>



<a name="255111509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255111509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255111509">(Sep 27 2021 at 20:04)</a>:</h4>
<p>For example, we can see that <code>fmt_int</code> is generated differently for u8 and u128:</p>
<p>u8</p>
<div class="codehilite"><pre><span></span><code>Relocation section &#39;.rel.text.__ZN4core3fmt3num12GenericRadix7fmt_int17hf5976642c34c8537E&#39; at offset 0x2ae44 contains 36 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00000025  00016902 R_386_PC32        00000000   __ZN49_$LT$u8$u20[...]
00000046  00017602 R_386_PC32        00000000   __ZN4core3cmp5imp[...]
00000089  00024504 R_386_PLT32       00000000   _memset
</code></pre></div>
<p>u128</p>
<div class="codehilite"><pre><span></span><code>Relocation section &#39;.rel.text.__ZN4core3fmt3num12GenericRadix7fmt_int17hf666fec66e88c170E&#39; at offset 0x2af64 contains 36 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
00000050  00022502 R_386_PC32        00000000   __ZN51_$LT$u128$u[...]
000000a5  00017c02 R_386_PC32        00000000   __ZN4core3cmp5imp[...]
000000e7  00024502 R_386_PC32        00000000   _memset
</code></pre></div>
<p>note PLT32 for u8 and PC32 for u128</p>



<a name="255113230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255113230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255113230">(Sep 27 2021 at 20:16)</a>:</h4>
<p>Furthermore, here is a Godbolt example: <a href="https://godbolt.org/z/7GdeeP8bc">https://godbolt.org/z/7GdeeP8bc</a>. Note that, when adding <code>-C relocation-model=static</code>, the call to <code>getenv</code> loses its' "@PLT" label but the <code>memcpy</code> call from the array initialization does not which, seems like a bug to me.</p>



<a name="255205998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255205998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255205998">(Sep 28 2021 at 12:15)</a>:</h4>
<p>Would be grateful for any pointers as to where to start looking where this "@PLT" call comes from <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="255940821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/131828-t-compiler/topic/debug%20generates%20PLT%20relocations/near/255940821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Cervin <a href="https://zulip-archive.rust-lang.org/stream/131828-t-compiler/topic/debug.20generates.20PLT.20relocations.html#255940821">(Oct 03 2021 at 10:14)</a>:</h4>
<p>Debugging this further, it is definitely an LLVM thing, it relies on link-time-relaxation of the PLT calls (which of course makes a lot of sense)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>