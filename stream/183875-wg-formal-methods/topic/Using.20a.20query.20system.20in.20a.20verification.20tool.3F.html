<html>
<head><meta charset="utf-8"><title>Using a query system in a verification tool? · wg-formal-methods · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/index.html">wg-formal-methods</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html">Using a query system in a verification tool?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258817684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/258817684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#258817684">(Oct 23 2021 at 11:07)</a>:</h4>
<p>Hey! Does anyone have experience using a query system like <code>salsa</code> to architecture their tool? I find that integrating with the <code>rustc</code> api pushes you in that direction already. However, I was wondering how a query system could 'extend' the queries from <code>rustc</code>, would you have to wrap all the <code>tcx.*</code> queries?</p>



<a name="258822638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/258822638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vytautas Astrauskas [he/him] <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#258822638">(Oct 23 2021 at 13:13)</a>:</h4>
<p>We tried to adapt <code>salsa</code> and failed because it does not support types with lifetimes.</p>



<a name="259724208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259724208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259724208">(Oct 30 2021 at 10:52)</a>:</h4>
<p>ah hmm that seems fairly limiting, especially if you want to return data which contains <code>rustc</code> datastructures</p>



<a name="259724228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259724228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259724228">(Oct 30 2021 at 10:52)</a>:</h4>
<p>is <code>salsa</code> what <code>rust-analyzer</code> uses?</p>



<a name="259725092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259725092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259725092">(Oct 30 2021 at 11:13)</a>:</h4>
<p>yes. rust-analyzer doesn't use arenas in the way that rustc does, because it runs continually over long periods of time, so the restriction isn't really a problem</p>



<a name="259725234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259725234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259725234">(Oct 30 2021 at 11:16)</a>:</h4>
<p>i'm not sure i quite understand why running for a long time would mean that there would be no need to return lifetime dependent data</p>



<a name="259725238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259725238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259725238">(Oct 30 2021 at 11:17)</a>:</h4>
<p>is there any hope that salsa will grow that ability? perhaps thanks to higher rank lifetimes?</p>



<a name="259725813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259725813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259725813">(Oct 30 2021 at 11:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F/near/259725234">said</a>:</p>
<blockquote>
<p>i'm not sure i quite understand why running for a long time would mean that there would be no need to return lifetime dependent data</p>
</blockquote>
<p>As I understand it, rustc can store a lot of data in arenas that just get cleaned up at the end of the compiler session at once, and it uses references into those arenas a lot. rust-analyzer can't do that: it runs for a long time, and the database evolves continuously, so it can't just clean up once at the end, and there can't be any data that is guaranteed to live for the whole lifetime of the database. Hence it mostly uses individual ref-counted pieces of data that can be created and destroyed independently, so it doesn't need (and isn't able to use) references as much.</p>



<a name="259725883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259725883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259725883">(Oct 30 2021 at 11:32)</a>:</h4>
<p>I'm not sure what lifetimes data returned by a salsa query <em>could</em> depend on. But I'm not an expert in salsa, and maybe there have been considerations about it</p>



<a name="259977357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259977357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259977357">(Nov 02 2021 at 10:36)</a>:</h4>
<p>Well the lifetime of the database, right?</p>



<a name="259977405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259977405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259977405">(Nov 02 2021 at 10:37)</a>:</h4>
<p>I see the difference now, and honestly a verification tool could fall in either camp though <em>ideally</em> the latter</p>



<a name="259977440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259977440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259977440">(Nov 02 2021 at 10:37)</a>:</h4>
<p>but fundamentally I would need queries that return data which comes from rustc (and thus has a lifetime)</p>



<a name="259977617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259977617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259977617">(Nov 02 2021 at 10:38)</a>:</h4>
<p>I guess as long as I'm using the rustc api, i'm going to be going against the grain of salsa. Perhaps I should see if I can use the rustc query system instead</p>



<a name="259978933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259978933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259978933">(Nov 02 2021 at 10:52)</a>:</h4>
<p>argh, it seems to not really be extensible, the <code>rustc_query_system</code> crate (reasonably) assumes it will only be used in the context of rustc</p>



<a name="259985181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/259985181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#259985181">(Nov 02 2021 at 11:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F/near/259977357">said</a>:</p>
<blockquote>
<p>Well the lifetime of the database, right?</p>
</blockquote>
<p>right, but I don't really see how there could be any data with the database's lifetime that a query could have access to, since you're writing the queries only with access to the database trait</p>



<a name="260301279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Using%20a%20query%20system%20in%20a%20verification%20tool%3F/near/260301279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Using.20a.20query.20system.20in.20a.20verification.20tool.3F.html#260301279">(Nov 04 2021 at 16:57)</a>:</h4>
<p>something something HRTB?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>