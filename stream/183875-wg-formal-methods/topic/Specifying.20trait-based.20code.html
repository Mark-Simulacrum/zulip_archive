<html>
<head><meta charset="utf-8"><title>Specifying trait-based code · wg-formal-methods · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/index.html">wg-formal-methods</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html">Specifying trait-based code</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268702442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268702442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268702442">(Jan 20 2022 at 14:48)</a>:</h4>
<p>Hi all!</p>



<a name="268702516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268702516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268702516">(Jan 20 2022 at 14:48)</a>:</h4>
<p>I figured i'd ask around to see if people have ideas / opinions on the best approaches to specifying trait based code, and more specifically specifying traits from <code>std</code>.</p>



<a name="268702781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268702781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268702781">(Jan 20 2022 at 14:50)</a>:</h4>
<p>The core problem is that we would like to attach specifications to traits methods, typically as <code>requires</code> and <code>ensures</code> clauses. This on its own is not an issue, but where we start encountering issues is when we want to specify the behavior of pre-existing stdlib traits like <code>Ord</code> or <code>Eq</code></p>



<a name="268702912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268702912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268702912">(Jan 20 2022 at 14:51)</a>:</h4>
<p>Why do we encounter an issue? Well, specifying the behavior of these traits requires <em>extending</em> them, either adding a <em>new super trait</em> or at minima adding a new item to the trait, which is used to reflect the "logical" behavior of this trait</p>



<a name="268702949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268702949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268702949">(Jan 20 2022 at 14:51)</a>:</h4>
<p>to illustrate what I mean, I'll give an example specification for a simplified Eq</p>



<a name="268703120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268703120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268703120">(Jan 20 2022 at 14:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code>#[allow(unused)]
pub trait Eq {
    #[predicate]
    fn log_eq(self, _: Self) -&gt; bool;

    #[ensures(result == self.log_eq(o))]
    fn eq(&amp;self, o: &amp;Self) -&gt; bool;

    #[law]
    #[ensures(x == x)]
    fn refl(x: Self);

    #[law]
    #[requires(x == y)]
    #[ensures(y == x)]
    fn symmetry(x: Self, y: Self);

    #[law]
    #[requires(x == y)]
    #[requires(y == z)]
    #[ensures(x == z)]
    fn transitivity(x: Self, y: Self, z: Self);
}
</code></pre></div>



<a name="268703212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268703212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268703212">(Jan 20 2022 at 14:53)</a>:</h4>
<p>here we specify <code>eq</code> in terms of a <em>pure, logical relation</em> <code>log_eq</code>, and some laws which we add to the trait</p>



<a name="268703698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268703698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268703698">(Jan 20 2022 at 14:56)</a>:</h4>
<p>the issue which appears is one of 'hooking' into the pre-existing traits. If we want to allow users to benefit from operator notations, we need to somehow make it so that the <em>actual</em> <code>eq</code> has a specification, not just some home-grown trait we happen to have (<a href="https://github.com/xldenis/creusot/blob/master/creusot-contracts/src/std/eq.rs">https://github.com/xldenis/creusot/blob/master/creusot-contracts/src/std/eq.rs</a>)</p>



<a name="268703902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268703902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268703902">(Jan 20 2022 at 14:58)</a>:</h4>
<p>There are many different ways we can tackle the solution to this problem, but they all involve various degrees of hackery, I'm interested if others have encountered a similar problem or have preferred opinions. I can also lay out the approach we are taking in Creusot to address this</p>



<a name="268713868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268713868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268713868">(Jan 20 2022 at 15:57)</a>:</h4>
<p>How reasonable is it to add this stuff to the "real" <code>Eq</code>, at least from Creusot's point of view? That is, Creusot replaces the existing trait with this one, and any rust code compiled while Creusot is involved will think this is what the official <code>Eq</code> trait looks like</p>



<a name="268714185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268714185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268714185">(Jan 20 2022 at 15:59)</a>:</h4>
<p>more generally it seems like you might want to compile a custom version of <code>std</code> with these annotations</p>



<a name="268726544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268726544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268726544">(Jan 20 2022 at 17:20)</a>:</h4>
<p>That is a possibility, but I'm not sure how feasible that is?</p>



<a name="268726616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268726616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268726616">(Jan 20 2022 at 17:20)</a>:</h4>
<p>especially since I think the issue is really having a custom <code>core</code>?</p>



<a name="268731968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268731968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268731968">(Jan 20 2022 at 17:57)</a>:</h4>
<p>I actually remember discussing this option with my advisors and a major downside was maintenance, if we have a patched std, I foresee a lot of annoying rebase issues</p>



<a name="268943444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/268943444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#268943444">(Jan 22 2022 at 07:29)</a>:</h4>
<p>You are probably going to run into similar issues when trying to write specifications for methods on slices, which require an <code>impl&lt;T&gt; [T] {}</code>, rustc will complain because that is a lang item and there can only be one of those :) One work-around could be to use procedural macros that read out the refined specifications and stores these somewhere, but then doesn't actually let the code be passed on to rustc in order to avoid compilation errors (or let it pass through, but rename the trait through the macro - renaming <code>impl</code> blocks for slices will be trickier than renaming traits, though).</p>



<a name="269012428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/269012428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#269012428">(Jan 23 2022 at 11:20)</a>:</h4>
<p>Yes that’s sort of what I’m doing right now, I have a macro that allows you to attach specifications to external items, including traits.</p>



<a name="269012443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/269012443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#269012443">(Jan 23 2022 at 11:21)</a>:</h4>
<p>We also allow you to refine the trait bounds on a method so long as those refined bounds imply the original.</p>



<a name="269012491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/Specifying%20trait-based%20code/near/269012491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/Specifying.20trait-based.20code.html#269012491">(Jan 23 2022 at 11:22)</a>:</h4>
<p>This allows us to swap in a trait which refines <code>Eq</code> with additional items for specification.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>