<html>
<head><meta charset="utf-8"><title>formal methods doc follow-up discussion · wg-formal-methods · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/index.html">wg-formal-methods</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html">formal methods doc follow-up discussion</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276628196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276628196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276628196">(Mar 25 2022 at 14:40)</a>:</h4>
<p>this is to continue discussion of <a href="https://hackmd.io/qLk-wnwtStOhCOBeF5YuOw?view">https://hackmd.io/qLk-wnwtStOhCOBeF5YuOw?view</a></p>



<a name="276628207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276628207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276628207">(Mar 25 2022 at 14:40)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="276628445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276628445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276628445">(Mar 25 2022 at 14:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bsteering.20meeting.5D.202022-03-25.20compiler-team.23488.2C.20.23498/near/276627982">said</a>:</p>
<blockquote>
<p>this also plays into the cargo issues since cargo doesn't clean / invalidate it</p>
</blockquote>
<p>Could a <code>cmeta</code> file (or equivalent) be put in the <code>rlib</code> archive and then you wouldn’t need to worry about cleaning it up separately? I think there’s some logic somewhere in the compiler for reading the metadata out of the <code>rlib</code> files by looking up a known filename in the archive.</p>



<a name="276628693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276628693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276628693">(Mar 25 2022 at 14:44)</a>:</h4>
<p>that owuld definitely work</p>



<a name="276628744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276628744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276628744">(Mar 25 2022 at 14:44)</a>:</h4>
<p>either that or cargo would need a mechanism to be taught about additional metadata files</p>



<a name="276628841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276628841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276628841">(Mar 25 2022 at 14:45)</a>:</h4>
<p>For the <a class="stream" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler">#t-compiler</a> folks that are interested in these concerns, there's plenty more detail that we can go into</p>



<a name="276634512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276634512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276634512">(Mar 25 2022 at 15:21)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> okay, so, maybe here we can dig into my questions about why its hard to add more info in a post-hoc manner to traits/methods</p>



<a name="276635111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635111">(Mar 25 2022 at 15:25)</a>:</h4>
<p>Yea!</p>



<a name="276635241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635241">(Mar 25 2022 at 15:26)</a>:</h4>
<p>So, let's consider a simple example: a simplified <code>Eq</code> trait</p>



<a name="276635313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635313">(Mar 25 2022 at 15:26)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="nb">Eq</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">o</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276635452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635452">(Mar 25 2022 at 15:27)</a>:</h4>
<p>In how far are the pre- and postconditions and invariants similar between tools? Can we add basic support to rustc, just without actually interpreting them? (Or maybe treating them as debug assertions?)</p>



<a name="276635503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635503">(Mar 25 2022 at 15:27)</a>:</h4>
<p>the question of the specification language used by tools is a seperate issue imo</p>



<a name="276635625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635625">(Mar 25 2022 at 15:28)</a>:</h4>
<p>I am trying to work with different tool teams to bring people behind a single language, but its still very early</p>



<a name="276635652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635652">(Mar 25 2022 at 15:28)</a>:</h4>
<p>Suppose that we which to say that every impl of <code>Eq</code> defines an <em>equivalence relation</em> for the type being implemented</p>



<a name="276635816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635816">(Mar 25 2022 at 15:29)</a>:</h4>
<p>This means, that we need implementors to also provide a definition of <code>equiv</code> which is <em>logical</em> predicate characterizing what it means for two values of this type to be equivalent</p>



<a name="276635953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635953">(Mar 25 2022 at 15:30)</a>:</h4>
<p>I'm not saying they have to be exactly equal, but if you could have special functions defined and interpreted by the tool, would it be possible to lower the pre- and postconditions to MIR and include it in the crate metadata without handling it in any other way?</p>



<a name="276635993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276635993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276635993">(Mar 25 2022 at 15:30)</a>:</h4>
<p>oh yea, i actually had a bullet point about that in my document</p>



<a name="276636020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636020">(Mar 25 2022 at 15:30)</a>:</h4>
<p>if MIR had opaque support for contract / contract expressions</p>



<a name="276636034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636034">(Mar 25 2022 at 15:30)</a>:</h4>
<p>that would be major</p>



<a name="276636127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636127">(Mar 25 2022 at 15:31)</a>:</h4>
<p>but it wouldn't solve the issue of 'extenral specifications' unless we can assign contracts to definitions</p>



<a name="276636137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636137">(Mar 25 2022 at 15:31)</a>:</h4>
<p>They can be represented as empty functions defined in a library part of the tool, right? Say <code>fn equiv&lt;T&gt;(a: T, b: T) {}</code>.</p>



<a name="276636197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636197">(Mar 25 2022 at 15:32)</a>:</h4>
<p>yea, that's not far from what i do, except its not an empty function</p>



<a name="276636243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636243">(Mar 25 2022 at 15:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion/near/276636127">said</a>:</p>
<blockquote>
<p>but it wouldn't solve the issue of 'extenral specifications' unless we can assign contracts to definitions</p>
</blockquote>
<p>True.</p>



<a name="276636277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636277">(Mar 25 2022 at 15:32)</a>:</h4>
<p>but the real issue is that when user code uses <code>==</code> that translates to a call on <code>Eq::eq</code></p>



<a name="276636302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636302">(Mar 25 2022 at 15:32)</a>:</h4>
<p>and we need someway to define the contract that <code>eq</code> should have (which here would be <code>ensures(self.equiv(other))</code></p>



<a name="276636364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636364">(Mar 25 2022 at 15:33)</a>:</h4>
<p>but the issue is that contract is only valid for types which are also <code>Equiv</code></p>



<a name="276636444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636444">(Mar 25 2022 at 15:33)</a>:</h4>
<p>for <em>normal</em> functions is is not an issue since we can provide wrappers in a library which have stricter bounds on types</p>



<a name="276636485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636485">(Mar 25 2022 at 15:33)</a>:</h4>
<p>like i could make a <code>veri-std</code> crate which re-exports <code>std</code> methods and types but with <code>Equiv</code> instead of <code>Eq</code> or whatever</p>



<a name="276636561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636561">(Mar 25 2022 at 15:34)</a>:</h4>
<p>but i can't do that for things like <code>eq</code>, <code>index</code>, <code>add</code> which are <em>hardcoded</em> to be the <code>core</code> traits</p>



<a name="276636692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636692">(Mar 25 2022 at 15:35)</a>:</h4>
<p>The other alternative is to package a custom <code>std</code> but then this imposes a huge maintenance burden. Perhaps in the long term when verification tools unite around a common specification language it will be possible</p>



<a name="276636795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636795">(Mar 25 2022 at 15:36)</a>:</h4>
<p>I think those are orthogonal problems. On one hand you have lowering and storing the contracts themself. This would be solved by my proposal of adding rustc support I think. On the other hand you have adding contracts to external types, for which I don't have a solution.</p>



<a name="276636831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636831">(Mar 25 2022 at 15:36)</a>:</h4>
<p>agreed. lowering and storing contracts is a seperate problem</p>



<a name="276636889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636889">(Mar 25 2022 at 15:37)</a>:</h4>
<p>but I thought that <span class="user-mention" data-user-id="116083">@pnkfelix</span> was asking about the second issue</p>



<a name="276636973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276636973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276636973">(Mar 25 2022 at 15:37)</a>:</h4>
<p>but there are some relatively minor things i think that could be added to store and lower contracts which would make things sooo much less hacky</p>



<a name="276637076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276637076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276637076">(Mar 25 2022 at 15:38)</a>:</h4>
<p>as it stands my lowering is <em>hacky</em> and involves patching <code>mir_built</code></p>



<a name="276637135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276637135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276637135">(Mar 25 2022 at 15:38)</a>:</h4>
<p>in part because contracts need to have access to either the function parameters and types (pre/post) or be evaluated in whatever lexical scope they are found (assertions)</p>



<a name="276637330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276637330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276637330">(Mar 25 2022 at 15:40)</a>:</h4>
<p>as I said in the document I (and prusti afaik) do this by using closures but this is hacky as it pollutes the MIR of the annotated function and we must be careful not to trigger mir lowering on those closures</p>



<a name="276637751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276637751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276637751">(Mar 25 2022 at 15:43)</a>:</h4>
<p>I think the proper way to do it with rustc changes would be to do something like promoted mir for storing the mir bodies of the contracts and then have preconditions be functions which copies the argument list from the function it is a contract on. Have postconditions do the same, but also add outputs as arguments. Assertions should get their own terminator kind which is like a function call, except calling a contract function.</p>



<a name="276637870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276637870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276637870">(Mar 25 2022 at 15:44)</a>:</h4>
<p>I don't think that can be done without rustc changes though.</p>



<a name="276638475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276638475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276638475">(Mar 25 2022 at 15:48)</a>:</h4>
<p>yea, I would argue that contracts shouldn't be represented as MIR but otherwise agreed</p>



<a name="276638512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276638512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276638512">(Mar 25 2022 at 15:49)</a>:</h4>
<p>(THIR is a better IR for contracts imo)</p>



<a name="276638794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276638794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276638794">(Mar 25 2022 at 15:50)</a>:</h4>
<p>it makes handling structures like <code>forall</code> much simpler</p>



<a name="276642821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276642821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276642821">(Mar 25 2022 at 16:15)</a>:</h4>
<p>so, just to make sure I understand the problem here...</p>



<a name="276643032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643032">(Mar 25 2022 at 16:16)</a>:</h4>
<p>the "obvious" way I would attach contracts would be to assume that the crate-name+module-path-to-item (+ method name, when refering to a method attached to an item like a trait or the inherent impl for a struct/enum/union) can serve as a unique identifier</p>



<a name="276643065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643065">(Mar 25 2022 at 16:17)</a>:</h4>
<p>but <span class="user-mention silent" data-user-id="124288">oli</span> pointed out in the mtg earlier that you cannot assume those paths remain stable</p>



<a name="276643130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643130">(Mar 25 2022 at 16:17)</a>:</h4>
<p>Is that <em>the</em> reason you cannot take that strategy? or am I missing something even more disastrous with that idea?</p>



<a name="276643336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643336">(Mar 25 2022 at 16:18)</a>:</h4>
<p>(I am also assuming globally unique crate names, which is similarly problematic since crates can be given local names that the compiler is responsible for mapping to the associated object code. Its arguably just another instance of the instability problem that <span class="user-mention silent" data-user-id="124288">oli</span> pointed out.)</p>



<a name="276643436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643436">(Mar 25 2022 at 16:19)</a>:</h4>
<p>the problem isn't so much figuring out how to address the definitions, as you said, the fully qualified / disambiguated name suffices</p>



<a name="276643551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643551">(Mar 25 2022 at 16:20)</a>:</h4>
<p>the real issue is that in general adding specifications requires you to tighten trait bounds on a function</p>



<a name="276643641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643641">(Mar 25 2022 at 16:20)</a>:</h4>
<p>mmm. so there's potentially a viral propagation when you do that?</p>



<a name="276643649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643649">(Mar 25 2022 at 16:20)</a>:</h4>
<p>yea</p>



<a name="276643748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643748">(Mar 25 2022 at 16:21)</a>:</h4>
<p>because if you give a spec to <code>Eq</code>, that spec should force you to show (via the trait system) that you have a well-behaved instance of <code>Eq</code></p>



<a name="276643908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643908">(Mar 25 2022 at 16:22)</a>:</h4>
<p>for normal methods its not an issue as we can just provide wrappers around types / functions with the appropriate bounds</p>



<a name="276643967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276643967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276643967">(Mar 25 2022 at 16:22)</a>:</h4>
<p>but for anything tied to operators or core traits like <code>Copy</code>, that's nto a choice</p>



<a name="276644108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644108">(Mar 25 2022 at 16:23)</a>:</h4>
<p>I think the statement that "wrappers can solve this" doesn't help me understand, because I would assume that the virality issues arise then too</p>



<a name="276644126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644126">(Mar 25 2022 at 16:23)</a>:</h4>
<p>hmm sorry. let me try to rephrase</p>



<a name="276644266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644266">(Mar 25 2022 at 16:24)</a>:</h4>
<p>i.e. I can totally understand that adding a spec ends up generating proof obligations for all the things that call into that spec</p>



<a name="276644280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644280">(Mar 25 2022 at 16:24)</a>:</h4>
<p>So the issue is that when you're verifying code, you inevitably end up interacting with things that come from outside (whether that's <code>std</code> or another crate)</p>



<a name="276644327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644327">(Mar 25 2022 at 16:25)</a>:</h4>
<p>you end up needing some mechanism to say 'ok, assume that <code>Vec::foo</code> has the spec <code>S</code></p>



<a name="276644366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644366">(Mar 25 2022 at 16:25)</a>:</h4>
<p>which is what we can call an 'external specification declaration'</p>



<a name="276644386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644386">(Mar 25 2022 at 16:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion/near/276644266">said</a>:</p>
<blockquote>
<p>i.e. I can totally understand that adding a spec ends up generating proof obligations for all the things that call into that spec</p>
</blockquote>
<p>but what I don't understand is if the common solution is to go through and figure out the corresponding specs that need to be added to all callers, and recurse as needed. Or if the common solution solution is some sort of tool to automatically attach specs (i.e. "any instance of T: Eq implies this corresponding proof obligation.")</p>



<a name="276644478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644478">(Mar 25 2022 at 16:26)</a>:</h4>
<p>if i understand what you're saying, I'm going with the second option</p>



<a name="276644578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644578">(Mar 25 2022 at 16:26)</a>:</h4>
<p><a href="https://github.com/xldenis/creusot/blob/febd73b261b36210a4afdbc4f1ac83cdd32bdc2f/creusot-contracts/src/std/fun.rs#L79-L83">https://github.com/xldenis/creusot/blob/febd73b261b36210a4afdbc4f1ac83cdd32bdc2f/creusot-contracts/src/std/fun.rs#L79-L83</a></p>



<a name="276644606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644606">(Mar 25 2022 at 16:27)</a>:</h4>
<p>this shows how i use an <code>extern_spec</code> macro to give a spec to  <code>call_once</code></p>



<a name="276644618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644618">(Mar 25 2022 at 16:27)</a>:</h4>
<p>hmm. okay.</p>



<a name="276644661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644661">(Mar 25 2022 at 16:27)</a>:</h4>
<p>the idea being that now every time <code>call_once</code> appears in the code, we force you to prove that you have <code>F: FnOnceSpec</code> also be true</p>



<a name="276644669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644669">(Mar 25 2022 at 16:27)</a>:</h4>
<p>(beyond just <code>F: FnOnce</code></p>



<a name="276644767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644767">(Mar 25 2022 at 16:28)</a>:</h4>
<p>is <code>F: FnOnceSpec</code> there itself an instance of a type: trait bound, that is interpreted by the Rust trait system?</p>



<a name="276644786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644786">(Mar 25 2022 at 16:28)</a>:</h4>
<p>or is it something specific to Creusot that <code>rustc</code> has no knowledge of?</p>



<a name="276644802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644802">(Mar 25 2022 at 16:28)</a>:</h4>
<p>its fully integrated into rust</p>



<a name="276644823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644823">(Mar 25 2022 at 16:28)</a>:</h4>
<p>(creusot leverages the rust trait / type system for specs)</p>



<a name="276644843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644843">(Mar 25 2022 at 16:28)</a>:</h4>
<p>Okay. okay. I think that helps me understand better the limitations you're hitting.</p>



<a name="276644849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276644849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276644849">(Mar 25 2022 at 16:29)</a>:</h4>
<p>it comes from above in the file: <a href="https://github.com/xldenis/creusot/blob/febd73b261b36210a4afdbc4f1ac83cdd32bdc2f/creusot-contracts/src/std/fun.rs#L5-L11">https://github.com/xldenis/creusot/blob/febd73b261b36210a4afdbc4f1ac83cdd32bdc2f/creusot-contracts/src/std/fun.rs#L5-L11</a></p>



<a name="276645139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645139">(Mar 25 2022 at 16:31)</a>:</h4>
<p>I fully acknowledge that 'extern specs' are truly twisting rustc's arm,</p>



<a name="276645215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645215">(Mar 25 2022 at 16:31)</a>:</h4>
<p>no, this helps.</p>



<a name="276645249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645249">(Mar 25 2022 at 16:32)</a>:</h4>
<p>I'm still wrapping my head around whether its the architecture that <em>I</em> would try to adopt if I were making a FM tool</p>



<a name="276645297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645297">(Mar 25 2022 at 16:32)</a>:</h4>
<p>but I think I at least understand where you are coming from.</p>



<a name="276645446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645446">(Mar 25 2022 at 16:33)</a>:</h4>
<p>I think if i were building the 'official rust FM tool' i wouldn't necessarily do this, though it would probably still be very useful in practice</p>



<a name="276645460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645460">(Mar 25 2022 at 16:33)</a>:</h4>
<p>(to avoid needing to fork all your deps)</p>



<a name="276645556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645556">(Mar 25 2022 at 16:34)</a>:</h4>
<p>I think my gut reaction is more based on "wait, this cannot possibly work." and yet you're showing that it does. <span aria-label="lol" class="emoji emoji-1f606" role="img" title="lol">:lol:</span></p>



<a name="276645590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645590">(Mar 25 2022 at 16:34)</a>:</h4>
<p>oh but it is <em>haacky</em> :)</p>



<a name="276645735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645735">(Mar 25 2022 at 16:35)</a>:</h4>
<p>Could we have some way to specify "semantic" source patches and then recompile the sysroot while applying a patch to add the contracts? Such patches could be of the form "add this attribute to an item available at this path".</p>



<a name="276645808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645808">(Mar 25 2022 at 16:36)</a>:</h4>
<p>but for example in the case of <code>eq</code> we also would need to add a super trait</p>



<a name="276645884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645884">(Mar 25 2022 at 16:36)</a>:</h4>
<p>I wonder if the language would benefit just supporting that as a first class feature.</p>



<a name="276645887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645887">(Mar 25 2022 at 16:36)</a>:</h4>
<p>because if we want to say that </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[ensures(self.equiv(rhs))]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="276645891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645891">(Mar 25 2022 at 16:36)</a>:</h4>
<p>The patches should resolve re-exports to prevent breaking when a definition moves.</p>



<a name="276645916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645916">(Mar 25 2022 at 16:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion/near/276645884">said</a>:</p>
<blockquote>
<p>I wonder if the language would benefit just supporting that as a first class feature.</p>
</blockquote>
<p>what, semantic patches?</p>



<a name="276645954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276645954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276645954">(Mar 25 2022 at 16:37)</a>:</h4>
<p>no, introducing new traits that are automatically super traits of one or more other traits</p>



<a name="276646101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646101">(Mar 25 2022 at 16:38)</a>:</h4>
<p>(you'd need to specify <em>how</em> they get automatically supported; e.g. provide implementations of all non-default methods for each of the relevant subtraits)</p>



<a name="276646103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646103">(Mar 25 2022 at 16:38)</a>:</h4>
<p>the coherence and resolution implications seem sketch</p>



<a name="276646201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646201">(Mar 25 2022 at 16:39)</a>:</h4>
<p>I suppose the potential for diamond implementation hierarchies could be a problem.</p>



<a name="276646251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646251">(Mar 25 2022 at 16:39)</a>:</h4>
<p>I'm not sure if that's the same as <span class="user-mention" data-user-id="312719">@Xavier Denis</span> 's concerns re coherence+resolution</p>



<a name="276646339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646339">(Mar 25 2022 at 16:40)</a>:</h4>
<p>anyway I'm majorly diverting the discussion. ignore that train of thought.</p>



<a name="276646497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646497">(Mar 25 2022 at 16:41)</a>:</h4>
<p>Yea that and the need for default impls</p>



<a name="276646707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646707">(Mar 25 2022 at 16:42)</a>:</h4>
<p>I think that an <code>extern_spec!</code> system is important in practice for a verification tool / platform but I also think that its very nature means it will be hacky to some degree</p>



<a name="276646749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646749">(Mar 25 2022 at 16:43)</a>:</h4>
<p>It certainly seems to have much in common with a proper contract system</p>



<a name="276646765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646765">(Mar 25 2022 at 16:43)</a>:</h4>
<p>which Rust doesn't have a standard story for today</p>



<a name="276646774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646774">(Mar 25 2022 at 16:43)</a>:</h4>
<p>but <em>should</em>, IMO</p>



<a name="276646895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276646895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276646895">(Mar 25 2022 at 16:44)</a>:</h4>
<p>(I guess it, like <code>#[bench]</code>, was something we figured we'd let the community figure out rather than screw it up ourselves...)</p>



<a name="276647052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276647052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276647052">(Mar 25 2022 at 16:45)</a>:</h4>
<p>yea, as bjorn3 was saying:  some sort of opaque support for contracts and lowering them could be added to rustc</p>



<a name="276647176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276647176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276647176">(Mar 25 2022 at 16:46)</a>:</h4>
<p>without having to go into the questions of the semantics of the actual contract language, a mechanism to attach some expressions representing a contract and have them lowered with minimal pollution of MIR</p>



<a name="276730404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/276730404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vytautas Astrauskas [he/him] <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#276730404">(Mar 26 2022 at 15:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion/near/276647176">said</a>:</p>
<blockquote>
<p>without having to go into the questions of the semantics of the actual contract language, a mechanism to attach some expressions representing a contract and have them lowered with minimal pollution of MIR</p>
</blockquote>
<p>I think that for tools that aim to verify that unsafe code does not cause UB, it is essential that the verified MIR matches the one that is compiled because (as was mentioned in the stable MIR document) UB may potentially be removed when lowering from source Rust to MIR. This, unfortunately, is very hard to achieve with specifications based on procedural macros.</p>



<a name="277130978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277130978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Federico Poli <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277130978">(Mar 30 2022 at 11:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion/near/276635953">said</a>:</p>
<blockquote>
<p>I'm not saying they have to be exactly equal, but if you could have special functions defined and interpreted by the tool, would it be possible to lower the pre- and postconditions to MIR and include it in the crate metadata without handling it in any other way?</p>
</blockquote>
<p>That would be great! I'm not sure how Creusot does it, but in Prusti contracts are already procedural macros that desugar to the "special functions" that you mentioned (and more stuff). We link the pre/postcondition-function to the function to be verified by using attributes and UUIDs. For example, <a href="https://github.com/viperproject/prusti-dev/blob/620565ca946b01fb105a4559eec07ec57bc308e0/prusti-tests/tests/parse/ui/true.rs#L8-L9">this</a> becomes <a href="https://github.com/viperproject/prusti-dev/blob/620565ca946b01fb105a4559eec07ec57bc308e0/prusti-tests/tests/parse/ui/true.stdout#L20-L27">this</a>.</p>
<p>Our current challenge is that to retrieve the contract from an external crate we need to obtain the <em>borrow-checked MIR</em> of external functions. Not the <em>optimized</em> one. One option that should already be possible is to serialize/deserialize the borrow-checked MIR to disk on our own, but storing it in the crate's metadata seems much more maintainable, less error prone etc.</p>
<p>Are there known limitations on the size of the metadata of a crate? The borrow-checked MIR that we might have to serialize is <code>BodyWithBorrowckFacts</code>, which includes the Polonius facts.</p>



<a name="277134315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277134315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Federico Poli <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277134315">(Mar 30 2022 at 12:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion/near/276644661">said</a>:</p>
<blockquote>
<p>the idea being that now every time <code>call_once</code> appears in the code, we force you to prove that you have <code>F: FnOnceSpec</code> also be true beyond just <code>F: FnOnce</code></p>
</blockquote>
<p>I'm trying to understand your idea. If every <code>FnOnce</code> is forced to also be <code>FnOnceSpec</code>, is adding the <code>FnOnceSpec</code>'s methods directly to <code>FnOnce</code> instead of creating the new trait a more or less equivalent alternative? The additional methods could be marked in a special way to be sure that rustc ignores them when lowering MIR to LLVM IR and so on.</p>



<a name="277137936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277137936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277137936">(Mar 30 2022 at 12:44)</a>:</h4>
<blockquote>
<p>That would be great! I'm not sure how Creusot does it, but in Prusti contracts are already procedural macros that desugar to the "special functions" that you mentioned (and more stuff). We link the pre/postcondition-function to the function to be verified by using attributes and UUIDs. For example, this becomes this.</p>
</blockquote>
<p>In MIR I do something similar, a proc macro parses the contracts and produces a function with a 'HOAS' version of the contract, that is: the expression <code>requires(a ==&gt; b)</code> becomes something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">requires_uuuuuuuid</span><span class="p">(</span><span class="n">a</span><span class="w"> </span>: <span class="nc">T1</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span>: <span class="nc">T2</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"> </span><span class="n">creusot_contracts</span>::<span class="n">stubs</span>::<span class="n">implies</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>similar to prusti i then link these contract functions to their original program function using attributes. <br>
When dealing with invariants I do the same trick but use a <em>closure</em> instead. </p>
<blockquote>
<p>Our current challenge is that to retrieve the contract from an external crate we need to obtain the borrow-checked MIR of external functions. Not the optimized one. One option that should already be possible is to serialize/deserialize the borrow-checked MIR to disk on our own, but storing it in the crate's metadata seems much more maintainable, less error prone etc.</p>
</blockquote>
<p>My solution to this is twofold: 1. I translate contracts from THIR, 2. I produce an IR which i then serialize into a custom metadata file (<code>.cmeta</code>) using existing serialization infrastructure. I posted about this in <a class="stream-topic" data-stream-id="183875" href="/#narrow/stream/183875-wg-formal-methods/topic/Encoding.20custom.20metadata">#wg-formal-methods &gt; Encoding custom metadata</a> .  This has given me a pretty complete solution, though it can interact poorly with cargo's caching system</p>



<a name="277138051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277138051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277138051">(Mar 30 2022 at 12:45)</a>:</h4>
<blockquote>
<p>I'm trying to understand your idea. If every FnOnce is forced to also be FnOnceSpec, is adding the FnOnceSpec's methods directly to FnOnce instead of creating the new trait a more or less equivalent alternative? The additional methods could be marked in a special way to be sure that rustc ignores them when lowering MIR to LLVM IR and so on. </p>
</blockquote>
<p>The case of <code>FnOnceSpec</code> is special because <code>FnOnce</code> is special and hardcoded into the compiler. But more broadly, sure all of these could be done easily if we could extend standard library traits. But that would require forking / patching the standard library (lots of maintenance work to follow) and also causes an issue where you need to specify and prove every instace of those traits</p>



<a name="277138147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277138147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277138147">(Mar 30 2022 at 12:46)</a>:</h4>
<p>What I'm attempting to do is find a way to bring specifications to std in a 'open world' or incremental manner, so that it doesn't imply "maintain a whole fork of std alone"</p>



<a name="277138491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277138491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277138491">(Mar 30 2022 at 12:49)</a>:</h4>
<p>For example, if we use a <code>EqSpec</code> trait to specify <code>eq</code>, this doesn't break every existing instance of <code>Eq</code> out there by adding new, undefined predicates. Instead, if we want to use <code>eq</code> in our <em>verified</em> program we must show that we also have <code>EqSpec</code> for that type</p>



<a name="277138522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277138522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277138522">(Mar 30 2022 at 12:49)</a>:</h4>
<p>so we just have to provide instances for the types we actually use</p>



<a name="277143008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277143008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Federico Poli <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277143008">(Mar 30 2022 at 13:19)</a>:</h4>
<blockquote>
<p>similar to prusti i then link these contract functions to their original program function using attributes.<br>
When dealing with invariants I do the same trick but use a closure instead.</p>
</blockquote>
<p>Same in Prusti <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
<blockquote>
<p>My solution to this is twofold: 1. I translate contracts from THIR, 2. I produce an IR which i then serialize into a custom metadata file (.cmeta) using existing serialization infrastructure. I posted about this in #wg-formal-methods &gt; Encoding custom metadata . This has given me a pretty complete solution, though it can interact poorly with cargo's caching system</p>
</blockquote>
<p>Is that the THIR generated by the proc macros? If so, how do you lower those to MIR in the end? Do you take all contracts from the external crates and generate local functions? (I guess not)</p>
<blockquote>
<p>But that would require forking / patching the standard library (lots of maintenance work to follow)</p>
</blockquote>
<p>Not necessarily, if the compiler gives support to inject via the API "ghost" methods into existing traits. (With "ghost" I mean code that is guaranteed by the compiler to be removed before lowering to LLVM IR. Something like a <code>#[ghost]</code> attribute, which would be useful for verification tools anyway.) That said, I don't have a full solution in mind. I was just trying to understand if the additional supertraits that you described are in the end equivalent to adding methods to the trait definitions.</p>
<blockquote>
<p>What I'm attempting to do is find a way to bring specifications to std in a 'open world' or incremental manner, so that it doesn't imply "maintain a whole fork of std alone"</p>
</blockquote>
<p>I completely agree  <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
<p>What do you mean with undefined predicates?</p>



<a name="277153955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277153955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277153955">(Mar 30 2022 at 14:34)</a>:</h4>
<blockquote>
<p>Not necessarily, if the compiler gives support to inject via the API "ghost" methods into existing traits. (With "ghost" I mean code that is guaranteed by the compiler to be removed before lowering to LLVM IR. Something like a #[ghost] attribute, which would be useful for verification tools anyway.) That said, I don't have a full solution in mind. I was just trying to understand if the additional supertraits that you described are in the end equivalent to adding methods to the trait definitions.</p>
</blockquote>
<p>But if you inject methods into <code>Eq</code> how do you give an actual value for say <code>Vec</code> or <code>HashMap</code>, the whole point of injecitng methods into traits is that each impl should define them in a unique manner. So I don't think its possible for rust to add 'ghost methods' for us. </p>
<blockquote>
<p>Is that the THIR generated by the proc macros? If so, how do you lower those to MIR in the end? Do you take all contracts from the external crates and generate local functions? (I guess not)</p>
</blockquote>
<p>I don't lower logical functions to MIR at all. In fact I erase them so that they have no MIR. I also don't generate local functions for external contracts, I just deserialize their IR much like how you can request <code>optimized_mir</code> for external functions, except that here it's a format appropriate for predicates.</p>



<a name="277245142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277245142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Federico Poli <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277245142">(Mar 31 2022 at 07:57)</a>:</h4>
<blockquote>
<p>But if you inject methods into <code>Eq</code> how do you give an actual value for say <code>Vec</code> or <code>HashMap</code>, the whole point of injecitng methods into traits is that each impl should define them in a unique manner. So I don't think its possible for rust to add 'ghost methods' for us. </p>
</blockquote>
<p>If a method declaration <code>fn equiv(&amp;self, other: &amp;Self) -&gt; bool</code> can be injected into <code>Eq</code>, then I would also expect to be able to inject different implementations into <code>impl Eq for Vec</code>, <code>HashMap</code> etc. Adding a single supertrait as you suggested looks like a smaller change to the compiler's API.</p>
<blockquote>
<p>I don't lower logical functions to MIR at all. In fact I erase them so that they have no MIR. I also don't generate local functions for external contracts, I just deserialize their IR much like how you can request <code>optimized_mir</code> for external functions, except that here it's a format appropriate for predicates.</p>
</blockquote>
<p>Ah, I see. Thanks!</p>



<a name="277270445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/183875-wg-formal-methods/topic/formal%20methods%20doc%20follow-up%20discussion/near/277270445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/183875-wg-formal-methods/topic/formal.20methods.20doc.20follow-up.20discussion.html#277270445">(Mar 31 2022 at 12:09)</a>:</h4>
<blockquote>
<p>If a method declaration fn equiv(&amp;self, other: &amp;Self) -&gt; bool can be injected into Eq, then I would also expect to be able to inject different implementations into impl Eq for Vec, HashMap etc. Adding a single supertrait as you suggested looks like a smaller change to the compiler's API.</p>
</blockquote>
<p>Ah of course, if you can inject into trait declarations you would be able to inject into instances, that makes sense. I still think that it would be more painful to use as i think the upfront cost is much higher than what I suggest.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>