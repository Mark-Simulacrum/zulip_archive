<html>
<head><meta charset="utf-8"><title>Handling snippet errors · clippy · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/index.html">clippy</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html">Handling snippet errors</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265507049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/265507049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#265507049">(Dec 19 2021 at 23:43)</a>:</h4>
<p>We currently have a "best practice" of - "if an error occurs when acquiring a snippet string, then downgrade the suggestion applicability". I propose changing this to "...don't emit a suggestion". The reason is that these errors should be very rare and I don't think it is worth the complexity of passing <code>&amp;mut applicability</code> through various utils. Omitting the suggestion would be easier after <a href="https://github.com/rust-lang/rust-clippy/issues/7797">rust-lang/rust-clippy#7797</a>.</p>



<a name="265507139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/265507139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#265507139">(Dec 19 2021 at 23:45)</a>:</h4>
<p>...<code>snippet</code>, <code>snippet_opt</code> and <code>snippet_with_applicability</code> could be replaced with one <code>snippet</code> that returns <code>Option</code>.</p>



<a name="265519005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/265519005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#265519005">(Dec 20 2021 at 04:03)</a>:</h4>
<p>tbh i find the passing-mut-applicability thing to be pretty elegant, but this is fair</p>



<a name="265537193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/265537193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#265537193">(Dec 20 2021 at 09:08)</a>:</h4>
<p>I think that with the code as it is right now it's better to have <code>snippet_with_applicability</code> as it doesn't require extra option handling in the linting code. However, if we switch to <code>span_clippy_lint</code> we could have the closure return an <code>Result</code> or <code>Option</code> which would allow easy handling of the returned <code>Option</code> with the <code>?</code> operator. That would also give a higher intensive to only construct the suggestion inside the diagnostic closure.</p>



<a name="265537393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/265537393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#265537393">(Dec 20 2021 at 09:11)</a>:</h4>
<p>One advantage of <code>snippet_with_applicability</code> is that it also checks if the given <code>Span</code> comes from a macro. Most lints ignore macros but it might be good to have a util function like <code>adjust_applicability</code> that replaces this check for easy access and possibly easier refactoring <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="265548491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/265548491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#265548491">(Dec 20 2021 at 11:04)</a>:</h4>
<p>IMO dropping the suggestion in all cases where the applicability would get downgraded is not a good idea. Having a suggestion with (for example) a placeholder in it, because some snippet could not be generated is usually better than having no suggestion at all. E.g. having <code>replace it with: `.some_function(..)` </code> , where <code>..</code> is a placeholder, because the snippet of the arguments couldn't get generated, is still better than not knowing how to fix this error without looking up the lint documentation.</p>



<a name="266902096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/266902096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jason Newcomb <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#266902096">(Jan 05 2022 at 06:21)</a>:</h4>
<p>Snippet only fails when the source can't be read, which should basically never happen, and invalid spans. The only way to get an invalid span either we created it, or a proc macro created it (I don't think rustc verifies these). I'm in favour of just having a single fixed placeholder and just returning a <code>String</code> instead of <code>Cow&lt;str&gt;</code>.</p>
<p>Dropping the  suggestion in the case of an invalid span is probably fine since it's either from a proc macro (which we don't want to lint usually), or we screwed up the lint (maybe we want to emit something here). If it's just that the source can't be read then the suggestion is probably fine, we just can't give a specific one.</p>
<p>If <a href="https://github.com/rust-lang/rust/issues/7986">#7986</a> ends up working out my plan is to automatically handle applicability from failed snippets which will end up solving this problem.</p>



<a name="266952654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/266952654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#266952654">(Jan 05 2022 at 15:56)</a>:</h4>
<blockquote>
<p>Snippet only fails when the source can't be read, which should basically never happen, and invalid spans. The only way to get an invalid span either we created it, or a proc macro created it (I don't think rustc verifies these). I'm in favour of just having a single fixed placeholder and just returning a String instead of Cow&lt;str&gt;.</p>
</blockquote>
<p>FWIW rustdoc has been intentionally switching away from span_to_snippet for consistency, and also because the standard library's sources often aren't available</p>



<a name="266952762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/266952762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#266952762">(Jan 05 2022 at 15:57)</a>:</h4>
<p>cc <a href="https://github.com/rust-lang/rust/pull/86282">https://github.com/rust-lang/rust/pull/86282</a></p>



<a name="266960427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/266960427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#266960427">(Jan 05 2022 at 16:59)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> wait what? the stdlib sources being unavailable should not affect span_to_snippet; aiui that stuff is hardcoded</p>



<a name="266960456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/266960456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#266960456">(Jan 05 2022 at 16:59)</a>:</h4>
<p>oh maybe they do</p>



<a name="266960482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Handling%20snippet%20errors/near/266960482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Handling.20snippet.20errors.html#266960482">(Jan 05 2022 at 16:59)</a>:</h4>
<p>either way we don't really span_to_snippet on foreign spans</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>