<html>
<head><meta charset="utf-8"><title>Ignoring specific lints in tests · clippy · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/index.html">clippy</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html">Ignoring specific lints in tests</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262372838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262372838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jesse Szwedko <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262372838">(Nov 22 2021 at 20:23)</a>:</h4>
<p>Is there an easy way to enable a lint, but only for non-test code? I would like to enable  the <code>print_stdout</code> and <code>dbg_macro</code> lints to catch stray debug statements but still allow those to be used in tests (that is: <code>cfg(test)</code>). I realize that I can add an <code>allow</code> for each test module, but I was looking for something that would apply across the entire crate.</p>



<a name="262373608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262373608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262373608">(Nov 22 2021 at 20:31)</a>:</h4>
<p>I think you can use <code>tcx.sess.parse_sess.config.contains_key(sym::test)</code></p>



<a name="262374038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262374038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262374038">(Nov 22 2021 at 20:35)</a>:</h4>
<p>I would have expected <code>#![cfg_attr(not(test), warn(clippy::print_stdout, clippy::dbg_macro))]</code> to work. But testing it out myself, it doesn't. It seems like Clippy lints are run on tests by default, but no other lints or errors are emitted. See <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=30f793f842c8e86b2d0595790489b7bc">Playground</a>, see the different behavior whe using "Test", "Build", and "Clippy".</p>



<a name="262374262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262374262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262374262">(Nov 22 2021 at 20:37)</a>:</h4>
<p>oh oh I thought Jesse was modifying clippy</p>



<a name="262374301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262374301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262374301">(Nov 22 2021 at 20:37)</a>:</h4>
<p>I wonder if it makes sense to make those two lints have a different default for test modules than for other modules?</p>



<a name="262374458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262374458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262374458">(Nov 22 2021 at 20:38)</a>:</h4>
<p>I wouldn't say so. stdout output in tests is suppressed by default IIRC and dbg! macro usage in tests also seems a bit of a edge case to me.</p>



<a name="262383977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262383977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jesse Szwedko <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262383977">(Nov 22 2021 at 22:05)</a>:</h4>
<p>Thanks for the thoughts! And yeah, I could see having these specific lints (perhaps along with <code>print_stderr</code>) not apply to tests. Is there precedent for that for other lints?</p>



<a name="262384368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262384368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jesse Szwedko <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262384368">(Nov 22 2021 at 22:08)</a>:</h4>
<p>We often have <code>println</code> and <code>dbg</code> in tests to provide additional context if the test fails. By default it is suppressed if the test passes, but output if it fails.</p>



<a name="262449655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262449655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262449655">(Nov 23 2021 at 12:39)</a>:</h4>
<p>To run clippy on tests, you can use <code>--tests</code> (or <code>--all-targets</code>).</p>



<a name="262450602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262450602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262450602">(Nov 23 2021 at 12:49)</a>:</h4>
<p>Yeah, but for some reason Clippy runs on tests by default. I haven't really looked into that yet though. But it also happens with clippy-driver, so it probably is Clippy's fault and not something cargo does.</p>



<a name="262451043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262451043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262451043">(Nov 23 2021 at 12:54)</a>:</h4>
<p>When you say "runs on tests", do you just mean any function with a <code>#[test]</code> attribute? Because those are still compiled normally unless you add <code>#[cfg(test)]</code> somewhere</p>



<a name="262451064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262451064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262451064">(Nov 23 2021 at 12:54)</a>:</h4>
<p>So it doesn't seem like a bug that clippy looks at them</p>



<a name="262451229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262451229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262451229">(Nov 23 2021 at 12:56)</a>:</h4>
<p>See this <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=30f793f842c8e86b2d0595790489b7bc">Playground</a> link. Even though the module is marked with <code>cfg(test)</code>, Clippy runs on the functions inside the module. But even if there are compile errors or things rustc lints should complain about, only Clippy lints are triggered inside the <code>cfg(test)</code> module.</p>



<a name="262453955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262453955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262453955">(Nov 23 2021 at 13:21)</a>:</h4>
<p>Oh interesting, yeah that does seem strange. I would expect that module to get stripped altogether before clippy even sees it</p>



<a name="262454702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262454702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262454702">(Nov 23 2021 at 13:26)</a>:</h4>
<p>Yes, <code>cfg</code> attributes should be resolved before Clippy actually runs. ....unless those lints are pre-expansion passes. Let me check that.</p>



<a name="262455033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262455033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262455033">(Nov 23 2021 at 13:29)</a>:</h4>
<p>Yes, they are. So the fix is to not have them as pre-expansion passes. Which we want to do anyway. But linting on macro usage is hard when they are already expended. And we don't want to add more code that matches the exact expansion of the macro...</p>



<a name="262457336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262457336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262457336">(Nov 23 2021 at 13:48)</a>:</h4>
<p><span class="user-mention" data-user-id="452655">@Jesse Szwedko</span> So  <code>#![cfg_attr(not(test), warn(clippy::lints))]</code> should work in general. But sadly for the exact two lints you asked about, it doesn't work.</p>



<a name="262464271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262464271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262464271">(Nov 23 2021 at 14:41)</a>:</h4>
<blockquote>
<p>And we don't want to add more code that matches the exact expansion of the macro...</p>
</blockquote>
<p>I'm getting close to a general solution for this.</p>



<a name="262473405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Ignoring%20specific%20lints%20in%20tests/near/262473405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jesse Szwedko <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests.html#262473405">(Nov 23 2021 at 15:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264664">flip1995</span> <a href="#narrow/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests/near/262457336">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="452655">Jesse Szwedko</span> So  <code>#![cfg_attr(not(test), warn(clippy::lints))]</code> should work in general. But sadly for the exact two lints you asked about, it doesn't work.</p>
</blockquote>
<p>Ah, gotcha, yeah I see. Well, it's good to know how to do this for other lints at least :)</p>
<p><a href="https://github.com/vectordotdev/vector/pull/10125">https://github.com/vectordotdev/vector/pull/10125</a> is what I ended up with after adding these new restriction lints. Allowing for the places where we do actually want to print was a bit messy since I couldn't put the attribute directly on the macro and instead had to wrap the println macros with their own blocks and add the attribute there. It seemed worth the trade-off to me though as we accidentally left a stray debug println in our last release.</p>
<p>Thanks for the discussion all!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>