<html>
<head><meta charset="utf-8"><title>lints for I-unsound · clippy · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/index.html">clippy</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html">lints for I-unsound</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276462560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276462560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276462560">(Mar 24 2022 at 11:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/122652-new-members/topic/compiler.202022/near/273210386">said</a>:</p>
<blockquote>
<p>Hi <span class="user-mention silent" data-user-id="373570">Jaic1</span> one good way to get into compiler work is via writing lints. There are several unsoundness issues that we could write lints for. If that sounds like something you'd like to do, we can start brainstorming in <a class="stream" data-stream-id="257328" href="/#narrow/stream/257328-clippy">#clippy</a>  which bug to start with and how to best go about it.</p>
</blockquote>
<p>I am trying to write some lints in clippy for <a href="https://github.com/rust-lang/rust/issues?page=1&amp;q=is%3Aopen+is%3Aissue+label%3AI-unsound">I-unsound</a> issues in rustc. After skimming some issues, I find two issues that might be suitable (other recommendation?) :</p>
<ol>
<li><a href="https://github.com/rust-lang/rust/issues/70022">Statics don't support alignments larger than the page size</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/88901">A Lifetime-generic Copy impl can allow fields which are only Copy when 'static</a></li>
</ol>



<a name="276462674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276462674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276462674">(Mar 24 2022 at 11:38)</a>:</h4>
<p>FYI, below are my summary of the two issues:</p>
<ol>
<li>It is an issue that is relevant to type alignment and statics. Specifically, if the program has a static whose type alignment is larger than the page size (typically 4KB), then the type alignment cannot be fulfilled, which is considered to be unsound. Writing a lint for this issue seems straightforward.</li>
<li>It is an issue that is relevant to lifetime, Copy impl and specialization. Specifically, say, we have a wrapper type Bar: <code>struct Bar&lt;'lt&gt;(Foo&lt;'lt&gt;);</code> and a lifetime-generic Copy impl for Bar: <code>impl&lt;'any&gt; Copy for Bar&lt;'any&gt; {}</code>. At this time, the borrow checker would require that <code>Foo&lt;'lt&gt;</code> should be Copy over all lifetime parameter, but a specialized Copy impl with static lifetime for Foo: <code>impl Copy for Foo&lt;'static&gt; {}</code> can mistakenly fulfill the requirement.</li>
</ol>



<a name="276462699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276462699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276462699">(Mar 24 2022 at 11:39)</a>:</h4>
<p>Besides these two, does anyone have other recommendation?<br>
By the way, I am not sure how large the scope of (unsound) problem that clippy can help is.</p>



<a name="276468101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276468101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276468101">(Mar 24 2022 at 12:33)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="373570">@Jaic1</span>,</p>
<p>from the given description, it sounds like 1. should be simple to detect. However, I'm not sure how the page size for the targeted platform can be determined and what the lint should suggest (if anything). If you figure this out, it should be a nice and simple lint. Otherwise, you can take a look at our <a href="https://github.com/rust-lang/rust-clippy/labels/good-first-issue">good-first-issues</a>. (I don't know any nice <code>good-first-issues</code> from the top of my head :)) You're also always welcome to ask for help or mentoring :).</p>
<blockquote>
<p>By the way, I am not sure how large the scope of (unsound) problem that clippy can help is.</p>
</blockquote>
<p>Clippy directly interfaces with rustc, while we can't change the code, we can warn the user of mistakes.</p>



<a name="276472693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276472693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276472693">(Mar 24 2022 at 13:08)</a>:</h4>
<p>One possible solution for the page size would be to make it configurable with a default of 4KB.</p>
<p>As for the second issue, this seems like something that should be fixed in rustc directly rather than a Clippy lint.</p>



<a name="276491269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276491269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276491269">(Mar 24 2022 at 15:22)</a>:</h4>
<p>yea, the second example needs to be fixed in rustc. The hard part is figuring out how to detect it, so doing it in clippy first has little advantages</p>



<a name="276819873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276819873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276819873">(Mar 28 2022 at 02:11)</a>:</h4>
<p>UPDATE: I open up a PR for the first unsound issue above, here's the <a href="https://github.com/rust-lang/rust-clippy/pull/8593">pointer</a> (in case someone is interested in it)</p>



<a name="276974604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276974604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276974604">(Mar 29 2022 at 08:46)</a>:</h4>
<p>Hi, I have a question about debugging HIR. (Don't know if it is appropriate to ask here.)</p>
<p>If there is a better way to beautify the output of a HIR node during debugging? Currently I am using <code>println!("{:?}", hir_node)</code>.<br>
Thanks!</p>



<a name="276975090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276975090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276975090">(Mar 29 2022 at 08:51)</a>:</h4>
<p>I sometimes use <code>println!("{:#?}", node)</code>, that makes the output slightly better but not perfect. I would also be interested if someone else has a nicer solution :)</p>



<a name="276975245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276975245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276975245">(Mar 29 2022 at 08:52)</a>:</h4>
<p>And I reduce it to the smallest node. You can also ask this question over in <code>t-compiler/help</code> to get some more input :)</p>



<a name="276976141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276976141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276976141">(Mar 29 2022 at 09:01)</a>:</h4>
<p>Oh, I forgot the <code>#</code> there. It is now much better!</p>



<a name="276981626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/276981626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#276981626">(Mar 29 2022 at 09:57)</a>:</h4>
<p>Just using <code>dbg!(node)</code> should also give you nice output, including Clippy src line information from what <code>dbg!</code> macro that output originated.</p>



<a name="277369234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277369234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277369234">(Apr 01 2022 at 04:16)</a>:</h4>
<p>Hey, guys. If I have an <code>item</code> (whose <code>ItemKind</code> is known to be among struct, enum and union) in hir, how do I get its <code>hir_ty</code> (which should be a <code>Path</code>), or more precisely can I make a trivial/fake <code>hir_ty</code> for this <code>item</code>.</p>



<a name="277383204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277383204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277383204">(Apr 01 2022 at 08:16)</a>:</h4>
<p>Do you need a hir ty? Or would just calling <code>tcx.type_of(def_id)</code> also give you the info you need?</p>



<a name="277389654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277389654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277389654">(Apr 01 2022 at 09:17)</a>:</h4>
<p>Yeah, I want a hir ty.</p>



<a name="277392314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277392314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277392314">(Apr 01 2022 at 09:44)</a>:</h4>
<p>What are you using it for? Is some function expecting you to pass it one?</p>



<a name="277396158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277396158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277396158">(Apr 01 2022 at 10:20)</a>:</h4>
<p>I am doing a recursion myself. The inputs of the recursion are a mir ty and a hir ty which are related. Inside the recursion, I am destructing the mir ty and hir ty at the same time. But sometimes hir tys with generics cannot follow the destruction of mir, so I choose to fall back to use the mir ty (known to be an adt) to query the hir ty (of the definition of that adt) that is needed for a deeper recursion. And currently I can only use the mir ty to get the relevant hir item.</p>



<a name="277397165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277397165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277397165">(Apr 01 2022 at 10:30)</a>:</h4>
<p>Hmm... in that case, couldn't you extract out the part where you process Path into a separate function and call it directly instead of building a path and then calling the general function that just takes the path apart again?</p>



<a name="277398611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/lints%20for%20I-unsound/near/277398611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jaic1 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/lints.20for.20I-unsound.html#277398611">(Apr 01 2022 at 10:46)</a>:</h4>
<p>Sounds feasible, maybe I should extend the hir ty input of the general function or extract another (possibly recursive) function.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>