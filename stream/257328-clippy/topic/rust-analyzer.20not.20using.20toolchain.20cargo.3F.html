<html>
<head><meta charset="utf-8"><title>rust-analyzer not using toolchain cargo? · clippy · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/index.html">clippy</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html">rust-analyzer not using toolchain cargo?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257575188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257575188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Hamovitz <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257575188">(Oct 14 2021 at 17:39)</a>:</h4>
<p>Hi all — first-time contributor here, hoping to tackle <a href="https://github.com/rust-lang/rust-clippy/issues/2868">https://github.com/rust-lang/rust-clippy/issues/2868</a>. Hate to come in with a dev environment question but this is really befuddling me. I'm using VSCode on Windows. Anyone know how to get rust-analyzer to use the cargo from in-use toolchain in the directory? rust-analyzer is complaining that <code>cargo metadata --manifest-path C:\path\to\nightly/rustc-src/rust/compiler/rustc/Cargo.toml</code> is failing because Cargo 1.55 doesn't support <code>edition2021</code>, but <code>rustup which</code> cargo points to the nightly exe, <code>cargo -V</code> says <code>cargo 1.57.0-nightly (d56b42c54 2021-09-27)</code>, and I can run that command fine in the terminal. Here's the full error from rust-analyzer: </p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<p>rust-analyzer failed to load workspace: Failed to read Cargo metadata for Rust sources: Failed to run <code>cargo metadata --manifest-path C:\Users\hamov\.rustup\toolchains\nightly-2021-10-07-x86_64-pc-windows-msvc\lib/rustlib/rustc-src/rust/compiler/rustc/Cargo.toml</code>: <code>cargo metadata</code> exited with an error: error: failed to parse manifest at <code>C:\Users\hamov\.rustup\toolchains\nightly-2021-10-07-x86_64-pc-windows-msvc\lib\rustlib\rustc-src\rust\compiler\rustc\Cargo.toml</code> Caused by: feature <code>edition2021</code> is required The package requires the Cargo feature called <code>edition2021</code>, but that feature is not stabilized in this version of Cargo (1.55.0 (32da73ab1 2021-08-23)). Consider trying a newer version of Cargo (this may require the nightly release). See <a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#edition-2021">https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#edition-2021</a> for more information about the status of this feature.</p>
</div></div>
<p>If I add <code>"rust-analyzer.cargo.features": ["edition2021"]</code> to the settings, it still errors, but now because that's unnecessary?? Full error:</p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<p>rust-analyzer failed to load workspace: Failed to read Cargo metadata from Cargo.toml file c:\Users\hamov\Documents\code\rust-clippy\Cargo.toml, cargo 1.57.0-nightly (d56b42c54 2021-09-27): Failed to run <code>cargo metadata --manifest-path c:\Users\hamov\Documents\code\rust-clippy\Cargo.toml</code>: <code>cargo metadata</code> exited with an error: error: none of the selected packages contains these features: edition2021</p>
</div></div>
<p>Any help would be appreciated!</p>



<a name="257590921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257590921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257590921">(Oct 14 2021 at 19:24)</a>:</h4>
<p>Hey hey, those errors are new to me (Also using VS Code) Have you tried running <code>cargo check</code> once to make sure that it fetches the correct nightly toolchain?</p>



<a name="257591057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257591057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257591057">(Oct 14 2021 at 19:25)</a>:</h4>
<p>Otherwise, I've looked at my settings and they don't seem special.</p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<p>"rust-analyzer.cargo.allFeatures": true,<br>
"rust-analyzer.checkOnSave.allTargets": false,<br>
"rust-analyzer.checkOnSave.enable": false,<br>
"rust-analyzer.cargo.features": ["metadata-collector-lint"],</p>
</div></div>
<p>None of these should effect the environment</p>



<a name="257591621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257591621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257591621">(Oct 14 2021 at 19:28)</a>:</h4>
<p>I actually don't use <code>cargo check</code> with rust-analyzer now that I think about it. I only use it for inline hints etc and use a task to see if it compiles <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="257599684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257599684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Hamovitz <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257599684">(Oct 14 2021 at 20:24)</a>:</h4>
<p>Yah <code>cargo check</code> works fine. In fact even <code>cargo test</code> works and all pass.</p>



<a name="257609920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257609920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Hamovitz <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257609920">(Oct 14 2021 at 21:35)</a>:</h4>
<p>ah found it <a href="https://github.com/rust-analyzer/rust-analyzer/issues/10445">https://github.com/rust-analyzer/rust-analyzer/issues/10445</a>. evidently r-a doesn't detect the workspace toolchain in at least some circumstances. looks like someone filed a PR to fix it a few hours ago <span aria-label="relieved" class="emoji emoji-1f60c" role="img" title="relieved">:relieved:</span></p>
<p>For others: the workaround is to set the global default toolchain to the nightly you're using (currently clippy is set to use <code>2021-10-07</code>)</p>



<a name="257655506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/257655506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ThibsG <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#257655506">(Oct 15 2021 at 07:11)</a>:</h4>
<p>yeah I just run into this problem couple of days ago, same workaround for me <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="258196367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/rust-analyzer%20not%20using%20toolchain%20cargo%3F/near/258196367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/rust-analyzer.20not.20using.20toolchain.20cargo.3F.html#258196367">(Oct 19 2021 at 13:43)</a>:</h4>
<p>I also ran into this problem like a week ago. But since it will be fixed on Thursday (stabilization of 1.56), I didn't bother writing documentation about it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>