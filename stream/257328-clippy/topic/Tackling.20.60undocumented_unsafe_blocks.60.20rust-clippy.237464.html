<html>
<head><meta charset="utf-8"><title>Tackling `undocumented_unsafe_blocks` rust-clippy#7464 · clippy · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/index.html">clippy</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html">Tackling `undocumented_unsafe_blocks` rust-clippy#7464</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248607223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/248607223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#248607223">(Aug 06 2021 at 13:02)</a>:</h4>
<p>I'm currently trying to see how an <code>undocumented_unsafe_blocks</code> lint could be implemented in clippy. AFAICT there are two possible solutions:</p>
<ul>
<li>use plain comments (<code>// SAFETY: ...</code>): this is the most natural approach, and is currently used in the standard library. However since comments are not included in the AST, this would require some hacks to get them. The way I'd do it is getting the source code from the <code>SourceMap</code> and lexing it with <code>rustc_lexer</code>.</li>
<li>use doc comments (<code>/// SAFETY: ...</code>): this would probably be more surprising, but it can lead to some interesting ideas. Doc comments are kept in the AST (though discarded in the HIR), so no hacks would be required. The main problem which probably kills the idea is that attributes on expressions are experimental (<a href="https://github.com/rust-lang/rust/issues/15701">#15701</a>).</li>
</ul>
<p>Would the hacks required for using plain comments be OK for use in clippy? Are there any other solutions I missed?</p>



<a name="248612387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/248612387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#248612387">(Aug 06 2021 at 13:44)</a>:</h4>
<p>We have some lints which snip the code using <code>Span</code>s and then make a decision based on the returned <code>String</code>. However, all of them are Allow-by-default. Adding this in a similar fashion would be okay IMO, but probably also require it to be Allow-by-default. I would wait for some more feedback before diving into this.</p>
<p>Another possibility would be to also put the lint behind the same feature gate as the "doc comments on statement feature". <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="248614921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/248614921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#248614921">(Aug 06 2021 at 14:03)</a>:</h4>
<p>Discussed this with <span class="user-mention" data-user-id="369415">@xFrednet</span> and we noted that only attributes on expressions <em>inside statements</em> are experimental. So the following is accepted on stable:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// SAFETY: ...</span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>But this is not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// SAFETY: ...</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* some reaaaaaaaaaaly long expression that causes line wrap */</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But most interestingly:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// SAFETY: ...</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// SAFETY: ...</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p><em>is</em> accepted.</p>



<a name="249064923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/249064923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#249064923">(Aug 11 2021 at 03:29)</a>:</h4>
<p>I would probably use normal comments, snippets, and lexer. We have some lexer usage in SpanlessEq I believe.</p>



<a name="249177677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/249177677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#249177677">(Aug 11 2021 at 22:26)</a>:</h4>
<p>I have a close-to-working prototype</p>



<a name="249182782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/249182782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#249182782">(Aug 11 2021 at 23:28)</a>:</h4>
<p>Opened <a href="https://github.com/rust-lang/rust-clippy/issues/7557">clippy#7557</a></p>



<a name="249193197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/Tackling%20%60undocumented_unsafe_blocks%60%20rust-clippy%237464/near/249193197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/Tackling.20.60undocumented_unsafe_blocks.60.20rust-clippy.237464.html#249193197">(Aug 12 2021 at 03:04)</a>:</h4>
<p>Cool! Are you going to avoid lexing the entire file? You could get a span from the end of the previous statement to the start of the unsafe block.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>