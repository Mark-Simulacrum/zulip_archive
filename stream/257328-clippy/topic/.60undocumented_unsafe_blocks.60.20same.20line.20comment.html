<html>
<head><meta charset="utf-8"><title>`undocumented_unsafe_blocks` same line comment · clippy · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/index.html">clippy</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/.60undocumented_unsafe_blocks.60.20same.20line.20comment.html">`undocumented_unsafe_blocks` same line comment</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275162039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/%60undocumented_unsafe_blocks%60%20same%20line%20comment/near/275162039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jason Newcomb <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/.60undocumented_unsafe_blocks.60.20same.20line.20comment.html#275162039">(Mar 13 2022 at 16:11)</a>:</h4>
<p>This is only thing blocking <a href="https://github.com/rust-lang/rust-clippy/pull/8450">#8450</a>: what to do about safety comments preceding the unsafe block on the same line. e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cm">/* SAFETY: reasoning */</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">foo</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This is currently supported, but has some issues. It's hard to fit a decent comment and the unsafe block in one line. Something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cm">/* SAFETY: `verify_stuff` ensures `foo` is valid */</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">foo</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is about as short as you could reasonably get and still justify that it's safe.</p>
<p>It also leads into the question of how to handle something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">foo</span><span class="p">(</span><span class="cm">/* SAFETY: it's good */</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">bar</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">baz</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>Does the comment here apply to only the first unsafe block, or both of them? Even worse would be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cm">/* SAFETY: it's good */</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">bar</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">baz</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Overall I'd say it's better to only check the preceding lines just to avoid having to deal with that problem.</p>



<a name="275177684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257328-clippy/topic/%60undocumented_unsafe_blocks%60%20same%20line%20comment/near/275177684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Macleod <a href="https://zulip-archive.rust-lang.org/stream/257328-clippy/topic/.60undocumented_unsafe_blocks.60.20same.20line.20comment.html#275177684">(Mar 13 2022 at 22:09)</a>:</h4>
<p>Checking for usage with <a href="http://cs.github.com">cs.github.com</a> and a grep of downloaded crates the only occurrence I could find <a href="https://github.com/rust-lang/rust/blob/21b0325c68421b00c6c91055ac330bd5ffe1ea6b/src/tools/clippy/tests/ui/undocumented_unsafe_blocks.rs#L94">is in the clippy test suite</a>, so it should be no problem to omit support for that</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>