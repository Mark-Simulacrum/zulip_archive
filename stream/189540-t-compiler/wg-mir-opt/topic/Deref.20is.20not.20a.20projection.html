<html>
<head><meta charset="utf-8"><title>Deref is not a projection · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html">Deref is not a projection</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="176962780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176962780" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176962780">(Sep 30 2019 at 19:01)</a>:</h4>
<blockquote>
<p>btw, if there's anything const-eval or mir-opt related that needs more manpower I would be happy to help.</p>
</blockquote>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span>  This could conflict with <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> but I think not too much (I'll let them be the judge of it). Removing <code>Deref</code> from the list of <code>ProjectionElem</code>s is something that was discussed at the all hands this year. I'm not sure how easy it is. <span class="user-mention" data-user-id="120791">@RalfJ</span> mentioned stacked borrows may not be able to handle it. I believe the issue is that <code>(*y).z;</code> is not the same thing as <code>(&amp;*y).z</code> (because the former never touched stacked borrows because no (new!) references were involved). We can't just have an <code>Rvalue::Reborrow</code> and a <code>Rvalue::Deref</code> to differentiate, because <code>(*large_type).x</code> should not create a local to store <code>large_type</code> in just to read the <code>x</code> field a moment later. One proposition (I think, I may have projected a bit) was to have an <code>Rvalue::DerefProject</code> that first dereferences the <code>PlaceBase</code> before applying the projection. This scheme does not have the problem of large locals, as you only ever put pointers into locals</p>



<a name="176962850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176962850" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176962850">(Sep 30 2019 at 19:02)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span>, too</p>



<a name="176963089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963089" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963089">(Sep 30 2019 at 19:04)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Is there some place I can read up on the motivations for this change? Were there minutes for the all-hands discussion perhaps?</p>



<a name="176963099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963099" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963099">(Sep 30 2019 at 19:04)</a>:</h4>
<p>yes, sec</p>



<a name="176963122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963122" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963122">(Sep 30 2019 at 19:04)</a>:</h4>
<p>also motivation: <code>Deref</code> just makes all algorithms horrible</p>



<a name="176963151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963151" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963151">(Sep 30 2019 at 19:05)</a>:</h4>
<p>^ I may have had some experience with this yes XD</p>



<a name="176963229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963229">(Sep 30 2019 at 19:06)</a>:</h4>
<blockquote>
<blockquote>
<p>btw, if there's anything const-eval or mir-opt related that needs more manpower I would be happy to help.</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="118594">ecstatic-morse</span>  This could conflict with <span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> but I think not too much (I'll let them be the judge of it). Removing <code>Deref</code> from the list of <code>ProjectionElem</code>s is something that was discussed at the all hands this year. I'm not sure how easy it is. <span class="user-mention silent" data-user-id="120791">RalfJ</span> mentioned stacked borrows may not be able to handle it. I believe the issue is that <code>(*y).z;</code> is not the same thing as <code>(&amp;*y).z</code> (because the former never touched stacked borrows because no (new!) references were involved). We can't just have an <code>Rvalue::Reborrow</code> and a <code>Rvalue::Deref</code> to differentiate, because <code>(*large_type).x</code> should not create a local to store <code>large_type</code> in just to read the <code>x</code> field a moment later. One proposition (I think, I may have projected a bit) was to have an <code>Rvalue::DerefProject</code> that first dereferences the <code>PlaceBase</code> before applying the projection. This scheme does not have the problem of large locals, as you only ever put pointers into locals</p>
</blockquote>
<p>unsure how much would this conflict with Place 2.0 next steps but I'd say let's find out what that is :P</p>



<a name="176963244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963244" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963244">(Sep 30 2019 at 19:06)</a>:</h4>
<p><a href="https://paper.dropbox.com/doc/Topic-MIR-2.0-and-MIR-Optimizations--Ak6z9Grd9UDtDZpvxqGy1fydAg-BwHR7kOhxDwL6vuAUoSTQ" target="_blank" title="https://paper.dropbox.com/doc/Topic-MIR-2.0-and-MIR-Optimizations--Ak6z9Grd9UDtDZpvxqGy1fydAg-BwHR7kOhxDwL6vuAUoSTQ">https://paper.dropbox.com/doc/Topic-MIR-2.0-and-MIR-Optimizations--Ak6z9Grd9UDtDZpvxqGy1fydAg-BwHR7kOhxDwL6vuAUoSTQ</a></p>



<a name="176963262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963262" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963262">(Sep 30 2019 at 19:06)</a>:</h4>
<p>search for "instead of embedding"</p>



<a name="176963356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963356" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963356">(Sep 30 2019 at 19:08)</a>:</h4>
<p>also "legal in MIR right"</p>



<a name="176963469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963469" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963469">(Sep 30 2019 at 19:09)</a>:</h4>
<p>the stacked borrows problem only occurs if we inject <code>&amp;*</code>, but my reading of <span class="user-mention" data-user-id="119009">@eddyb</span> 's comment and my own interpretation of a <code>DerefProject</code> <code>Rvalue</code> would avoid that</p>



<a name="176963557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963557" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963557">(Sep 30 2019 at 19:10)</a>:</h4>
<p>I think the only problem is that reborrows aren't possible anymore LOL oops</p>



<a name="176963584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963584" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963584">(Sep 30 2019 at 19:10)</a>:</h4>
<p>I'll probably have to read Ralf's blog posts on stacked borrows to better understand the concerns around reborrowing</p>



<a name="176963614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963614" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963614">(Sep 30 2019 at 19:10)</a>:</h4>
<p>I'm hoping to just avoid them entirely</p>



<a name="176963660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963660" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963660">(Sep 30 2019 at 19:11)</a>:</h4>
<p>"them" being "injecting new reborrows where they weren't before"</p>



<a name="176963861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963861" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963861">(Sep 30 2019 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> can you explain what was the idea with <code>Deref</code>?</p>



<a name="176963879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963879">(Sep 30 2019 at 19:13)</a>:</h4>
<p>so remove it from Place's projection</p>



<a name="176963898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176963898" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176963898">(Sep 30 2019 at 19:13)</a>:</h4>
<p>but how do you represent a deref instead?</p>



<a name="176964023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964023" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964023">(Sep 30 2019 at 19:15)</a>:</h4>
<p>Ah okay. Did anyone float an alternative to or concerns about <code>Rvalue::DerefProject(Place&lt;'tcx&gt;)</code>? It seems like it solves all the problems here.</p>



<a name="176964025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964025" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964025">(Sep 30 2019 at 19:15)</a>:</h4>
<p>so right now if you have <code>(*a.b).c</code> you have <code>a, [b, deref, c]</code> as the place, after this change we'd have <code>let tmp = a.b; (*tmp).c</code></p>



<a name="176964133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964133" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964133">(Sep 30 2019 at 19:16)</a>:</h4>
<blockquote>
<p>Ah okay. Did anyone float an alternative to or concerns about <code>Rvalue::DerefProject(Place&lt;'tcx&gt;)</code>? It seems like it solves all the problems here.</p>
</blockquote>
<p>I think other topics were more important and we were kinda going off on the wrong train of thought because noone grokked the stacked borrows problem fast enough to figure out that it's not a problem</p>



<a name="176964424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964424" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964424">(Sep 30 2019 at 19:19)</a>:</h4>
<p>Since <code>let tmp = a.b; (*tmp).c</code> translates the latter expression to <code>DerefProject(Place { base: tmp, projection: [c] })</code> but requires the base to always be dereferenced before use, we don't need any deref projections anymore</p>



<a name="176964445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964445" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964445">(Sep 30 2019 at 19:19)</a>:</h4>
<p>some of the codegen code was in fact doing this. Injecting a local for the pointer</p>



<a name="176964463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964463" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964463">(Sep 30 2019 at 19:19)</a>:</h4>
<p>or at least an llvm immediate</p>



<a name="176964505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964505">(Sep 30 2019 at 19:20)</a>:</h4>
<p>well ok that was required anyway</p>



<a name="176964525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964525" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964525">(Sep 30 2019 at 19:20)</a>:</h4>
<p>but I mean, there was extra code making sure the deref works out</p>



<a name="176964553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964553" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964553">(Sep 30 2019 at 19:20)</a>:</h4>
<p>so if we have a mir local or magic codegen code makes no difference except that the former makes for much cleaner code</p>



<a name="176964609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964609" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964609">(Sep 30 2019 at 19:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span>  remember the "iterate forward then backward" stuff when you made places be slices instead of recursive? That's what's going away if we do this</p>



<a name="176964845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964845" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964845">(Sep 30 2019 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> Wouldn't a reborrow be expressed as <code>Rvalue::DerefProject(Place { base: tmp, projection: [borrow, ..] })</code>. Like I said, I don't fully understand the semantics around reborrowing so maybe I'm too focused on this.</p>



<a name="176964870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964870" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964870">(Sep 30 2019 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> there's no borrow projection ;)</p>



<a name="176964883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964883" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964883">(Sep 30 2019 at 19:25)</a>:</h4>
<p>we have <code>Rvalue::Ref</code></p>



<a name="176964896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964896" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964896">(Sep 30 2019 at 19:25)</a>:</h4>
<p>ohhhhh<br>
duh</p>



<a name="176964901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964901" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964901">(Sep 30 2019 at 19:25)</a>:</h4>
<p>Now I get it.</p>



<a name="176964923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964923" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964923">(Sep 30 2019 at 19:25)</a>:</h4>
<p>place projections are supposed to just be fancy ways to write byte offsets</p>



<a name="176964930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964930">(Sep 30 2019 at 19:25)</a>:</h4>
<p>Removing deref from projections seems like a really nice simplification to me. <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> </p>
<p>I'm a little concerned you're going to run into issues with generators like I did a few weeks ago. There's code now that does <code>_1 = (*_2).foo</code> where <code>_2</code> is a generator. At some point, I needed to get the layout of the place base (the generator) which triggers a query cycle. It's ok right now because most places just need to know the layout of the destination and bypass the intermediate deref but that may no longer be the case after we do this change.</p>



<a name="176964955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176964955" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176964955">(Sep 30 2019 at 19:25)</a>:</h4>
<p>But we really need to solve that issue anyway...</p>



<a name="176965060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965060">(Sep 30 2019 at 19:26)</a>:</h4>
<p>I think the generator thing would still work, as we'd just do <code>Rvalue::DerefProject(Place { base: _2, projection: [foo] })</code> and not change anything else compared to right now</p>



<a name="176965124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965124" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965124">(Sep 30 2019 at 19:27)</a>:</h4>
<p>but yes, that cycle sucks. Do we have an open issue for it? I remember posting a possible solution a la your mir/promoted split</p>



<a name="176965147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965147" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965147">(Sep 30 2019 at 19:27)</a>:</h4>
<p>No, I'm not aware of an open issue.</p>



<a name="176965159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965159" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965159">(Sep 30 2019 at 19:27)</a>:</h4>
<p>Let me find that idea though...</p>



<a name="176965178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965178" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965178">(Sep 30 2019 at 19:28)</a>:</h4>
<p>ah thanks <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> I gotta run in 3 minutes</p>



<a name="176965243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965243" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965243">(Sep 30 2019 at 19:28)</a>:</h4>
<p>I mean we could have an <code>Rvalue::ReborrowProject</code> to do <code>(&amp;*x)</code> and <code>(&amp;*x).foo</code>, but I still don't fully understand the problem I'm trying to solve XD.</p>



<a name="176965255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965255" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965255">(Sep 30 2019 at 19:28)</a>:</h4>
<p>(Context is here <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Using.20.60InterpCx.60.20more/near/175509886" title="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Using.20.60InterpCx.60.20more/near/175509886">https://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Using.20.60InterpCx.60.20more/near/175509886</a>)</p>



<a name="176965760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176965760" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176965760">(Sep 30 2019 at 19:34)</a>:</h4>
<blockquote>
<p>I mean we could have an <code>Rvalue::ReborrowProject</code> to do <code>(&amp;*x)</code> and <code>(&amp;*x).foo</code>, but I still don't fully understand the problem I'm trying to solve XD.</p>
</blockquote>
<p>yea, I mean ideally we'd not do any semantic changes in a PR that adds <code>DerefProject</code> and <code>ReborrowProject</code> (the latter is <code>Rvalue::Ref</code> btw) and then think about possible changes later</p>



<a name="176976860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/176976860" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#176976860">(Sep 30 2019 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> sorry, I was away from Zulip, yeah makes a lot of sense, it was that I wasn't sure what was the plan :)</p>



<a name="177018488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177018488" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177018488">(Oct 01 2019 at 03:50)</a>:</h4>
<blockquote>
<blockquote>
<p>I mean we could have an <code>Rvalue::ReborrowProject</code> to do <code>(&amp;*x)</code> and <code>(&amp;*x).foo</code>, but I still don't fully understand the problem I'm trying to solve XD.</p>
</blockquote>
<p>yea, I mean ideally we'd not do any semantic changes in a PR that adds <code>DerefProject</code> and <code>ReborrowProject</code> (the latter is <code>Rvalue::Ref</code> btw) and then think about possible changes later</p>
</blockquote>
<p>So currently when we do a reborrow (<code>_2 = (&amp;*_1)</code>), we have an rvalue like <code>Rvalue::Ref(Place { projections: [.., Deref] })</code>. This lets passes that need to handle reborrows specifically do so by matching on the <code>Rvalue</code>. Const qualification makes use of this, for example, to ensure that <code>_2 = (&amp;*_1)</code> behaves the same as <code>_2 = _1</code> w.r.t. qualification. I don't think we want to encode reborrows as an <code>Rvalue::DerefProject</code> followed by an <code>Rvalue::Ref</code>, since then those passes that try to handle reborrows will need to look at multiple statements. That's why I proposed a separate <code>Rvalue::ReborrowProject</code>, so we would have an <code>Rvalue</code> variant for each of <code>*x</code>, <code>&amp;x</code> and <code>(&amp;*x)</code>.</p>



<a name="177022916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177022916" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177022916">(Oct 01 2019 at 04:48)</a>:</h4>
<p>Also, feel free to ping me if I don't reply in a timely fashion, I'm bad at checking zulip, and I've yet to find a way to filter notifications by topic</p>



<a name="177027946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177027946" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177027946">(Oct 01 2019 at 06:43)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span>  yea, you're right. I realized the same thing an hour after going offline :D</p>



<a name="177271588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177271588" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177271588">(Oct 03 2019 at 18:17)</a>:</h4>
<p>I'm putting together a design doc for this so people can comment asynchronously. Perhaps someone will foresee an issue with the <code>Deref</code>/<code>Reborrow</code> strategy. Also, I want to call these <code>DerefBase</code> and <code>ReborrowBase</code>. I think this is clearer than using <code>Project</code> as a suffix. The design doc will include a strategy for splitting this into many small PRs that can be assigned, worked on and reviewed concurrently, since this will touch a lot of code.</p>



<a name="177333919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177333919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177333919">(Oct 04 2019 at 12:34)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@ecstatic-morse</span> nice!</p>



<a name="177372343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177372343" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177372343">(Oct 04 2019 at 19:39)</a>:</h4>
<p>One issue is that all other <code>Rvalue</code>s also operate on <code>Place</code>s, either directly or via <code>Operand</code>. Is it more efficient for some <code>Rvalue</code>s to operate on a deref projection directly than if the pointee was copied to a local variable and the passed to the <code>Rvalue</code>?</p>



<a name="177372366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177372366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177372366">(Oct 04 2019 at 19:39)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> ^</p>



<a name="177378193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177378193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177378193">(Oct 04 2019 at 20:56)</a>:</h4>
<p>Okay, I wrote up <a href="https://paper.dropbox.com/doc/Proposal-Deref-is-not-a-Projection--AmBy_zSe6GUL3hdQOLemeTVEAQ-aGnvFEPxejaDOXWDvfcf0" target="_blank" title="https://paper.dropbox.com/doc/Proposal-Deref-is-not-a-Projection--AmBy_zSe6GUL3hdQOLemeTVEAQ-aGnvFEPxejaDOXWDvfcf0">a proposal</a> with a few of the design constraints. Please edit if you can think of more.</p>



<a name="177378554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177378554" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177378554">(Oct 04 2019 at 21:00)</a>:</h4>
<p>It's also a bit light on motivation besides simplifying passes that need to check for <code>Deref</code>.</p>



<a name="177379856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177379856" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177379856">(Oct 04 2019 at 21:17)</a>:</h4>
<p>The original MIR optimization doc alludes to some benefits in codegen. Perhaps someone who better understands this could comment?</p>



<a name="177524612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177524612" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177524612">(Oct 07 2019 at 14:32)</a>:</h4>
<p>one challenge is figuring out how to integrate this work with the borrow checker -- currently we benefit quite a bit from the fact that the "places" that the borrow checker wants to consider are "mostly" 1-to-1 with MIR places</p>



<a name="177524661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177524661" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177524661">(Oct 07 2019 at 14:33)</a>:</h4>
<p>I had vaguely assumed that we would approach this by having some kind of specially known operations for creating places, with a (by construction, probably) guarantee that the intermediate values are not used elsewhere</p>



<a name="177524864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177524864" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177524864">(Oct 07 2019 at 14:35)</a>:</h4>
<p>sorry, that's not very specific, there are a lot of moving parts to such an idea, since it interacts also with e.g. miri</p>



<a name="177524904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177524904" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177524904">(Oct 07 2019 at 14:35)</a>:</h4>
<p>but basically the idea was that where today we have a complex notion of <code>Place</code> like <code>*(a.b.c[3]).d</code> or whatever</p>



<a name="177524913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177524913" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177524913">(Oct 07 2019 at 14:35)</a>:</h4>
<p>we might instead break that down into smaller operations:</p>



<a name="177525000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177525000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177525000">(Oct 07 2019 at 14:36)</a>:</h4>
<div class="codehilite"><pre><span></span>Place1 := a
Place2 := Place1.b
Place3 := Place2.c
Place4 := Place3[3]
Place5 := *Place4
Place6 := Place5.d
FinalReference = &amp;Place6
</pre></div>



<a name="177525068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177525068" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177525068">(Oct 07 2019 at 14:37)</a>:</h4>
<p>where a "place value" is not a <em>real</em> value -- at least not to the <em>borrow checker</em> -- it must be linear (always consumed exactly once) and it must be "converted" to a real value, e.g. by a <code>&amp;</code> operation</p>



<a name="177525097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177525097" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177525097">(Oct 07 2019 at 14:37)</a>:</h4>
<p>borrows might be somewhat special here; I guess all other uses of places are in operands that either copy or move? (well, assignments are also like borrows)</p>



<a name="177541338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177541338" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177541338">(Oct 07 2019 at 17:29)</a>:</h4>
<p>Interesting, I would have expected that removing <code>Deref</code> from the list of MIR <code>Place</code> projections would make them even <em>more</em> similar to the "places" that the borrow checker wants to consider. Admittedly I don't know the borrow checker very well, so perhaps I'm wrong about this. How does the borrow checker track borrows of a deref currently?</p>



<a name="177541640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177541640" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177541640">(Oct 07 2019 at 17:33)</a>:</h4>
<p>Regarding the virtual place idea, it seems to me like a different mental model around the existing <code>Place</code> representation. Once again, I don't know a lot about the existing borrow checker; things might be more clear if I did. Currently a "place value" is a <code>Place</code>, the smaller operations are projections, and the place is "converted" to a real value when it is passed to an <code>Rvalue</code> (<code>Rvalue::Ref</code> in your example).</p>



<a name="177551841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177551841" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177551841">(Oct 07 2019 at 19:34)</a>:</h4>
<blockquote>
<p>Interesting, I would have expected that removing <code>Deref</code> from the list of MIR <code>Place</code> projections would make them even <em>more</em> similar to the "places" that the borrow checker wants to consider. Admittedly I don't know the borrow checker very well, so perhaps I'm wrong about this. How does the borrow checker track borrows of a deref currently?</p>
</blockquote>
<p>specifically the case the borrow checker tracks is derefs of <code>Box&lt;T&gt;</code></p>



<a name="177551951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177551951" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177551951">(Oct 07 2019 at 19:35)</a>:</h4>
<p>an alternative to all of this would be to leave <code>Place</code> during borrow check, but potentially "lower" to some other representation before optimizing (basically splitting up places that involve derefs)</p>



<a name="177555843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177555843" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177555843">(Oct 07 2019 at 20:15)</a>:</h4>
<p>One thing to mention is that, if there's not any additional efficiencies in codegen, this change won't have any performance benefits that couldn't be gained from caching <code>Place::is_indirect</code>. If it makes the borrow checker analysis more convoluted, it's probably not worth doing.</p>



<a name="177555972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177555972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177555972">(Oct 07 2019 at 20:16)</a>:</h4>
<blockquote>
<p>an alternative to all of this would be to leave <code>Place</code> during borrow check, but potentially "lower" to some other representation before optimizing (basically splitting up places that involve derefs)</p>
</blockquote>
<p>This is intriguing. It seems like we could capture any efficiency gains in codegen with a much smaller set of changes.</p>



<a name="177556038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177556038" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177556038">(Oct 07 2019 at 20:17)</a>:</h4>
<p>This is contingent on the existence of potential  gains in codegen <span aria-label="smile" class="emoji emoji-263a" role="img" title="smile">:smile:</span>, which I'm assuming exist thanks to an offhand comment in meeting notes.</p>



<a name="177598265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177598265" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177598265">(Oct 08 2019 at 09:48)</a>:</h4>
<p>I thought the MIR borrowchecker has quite a bunch of workarounds around <code>Deref</code> projections, too</p>



<a name="177620366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620366">(Oct 08 2019 at 14:26)</a>:</h4>
<p>We do have to reason about them</p>



<a name="177620371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620371" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620371">(Oct 08 2019 at 14:26)</a>:</h4>
<p>But I wouldn't call them workarounds</p>



<a name="177620477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620477" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620477">(Oct 08 2019 at 14:26)</a>:</h4>
<p>It's true that when you have (e.g.) derefs of <code>&amp;mut</code> etc we have some special logic for borrowing such a thing</p>



<a name="177620482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620482" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620482">(Oct 08 2019 at 14:27)</a>:</h4>
<p>but I don't know that any of this logic would go away</p>



<a name="177620512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620512" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620512">(Oct 08 2019 at 14:27)</a>:</h4>
<p>and for sure we can't <em>just</em> remove them without something that takes their place that is not a move</p>



<a name="177620518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620518" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620518">(Oct 08 2019 at 14:27)</a>:</h4>
<p>I meant that there's additional logic to unwind derefs in the middle of projection lists</p>



<a name="177620571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620571" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620571">(Oct 08 2019 at 14:27)</a>:</h4>
<p>I'm not sure what "unwind" means here</p>



<a name="177620683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620683" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620683">(Oct 08 2019 at 14:28)</a>:</h4>
<p>there is some special logic to account particularly for cases like</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w"></span>
<span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="177620693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620693" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620693">(Oct 08 2019 at 14:28)</a>:</h4>
<p>maybe that's what you're referring to?</p>



<a name="177620722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620722" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620722">(Oct 08 2019 at 14:28)</a>:</h4>
<p>at the same time, we have to also permit things like <code>let x = &amp;mut self.foo; let y = &amp;mut self.bar;</code></p>



<a name="177620725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620725" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620725">(Oct 08 2019 at 14:28)</a>:</h4>
<p>well, you may have [a, b, c, deref, d, e, f], and the compiler has a bunch of logic that fiddles up to the deref, does an operation, then does deref operations, then continues until the next deref</p>



<a name="177620751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620751" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620751">(Oct 08 2019 at 14:28)</a>:</h4>
<p>which means that we have one borrow of <code>(*self).foo</code></p>



<a name="177620755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620755" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620755">(Oct 08 2019 at 14:29)</a>:</h4>
<p>and one borrow of <code>(*self).bar</code></p>



<a name="177620764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620764" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620764">(Oct 08 2019 at 14:29)</a>:</h4>
<p>and we have to know that they are disjoint</p>



<a name="177620778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620778">(Oct 08 2019 at 14:29)</a>:</h4>
<p>that only makes sense if you consider the <em>whole path</em></p>



<a name="177620797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620797" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620797">(Oct 08 2019 at 14:29)</a>:</h4>
<blockquote>
<p>well, you may have [a, b, c, deref, d, e, f], and the compiler has a bunch of logic that fiddles up to the deref, does an operation, then does deref operations, then continues until the next deref</p>
</blockquote>
<p>not really</p>



<a name="177620830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620830" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620830">(Oct 08 2019 at 14:29)</a>:</h4>
<p>at least I'm not sure what that is</p>



<a name="177620840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620840" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620840">(Oct 08 2019 at 14:29)</a>:</h4>
<p>maybe I'm forgetting things :)</p>



<a name="177620864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620864" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620864">(Oct 08 2019 at 14:29)</a>:</h4>
<blockquote>
<p>at the same time, we have to also permit things like <code>let x = &amp;mut self.foo; let y = &amp;mut self.bar;</code></p>
</blockquote>
<p>this is the high order bit though, we have to reason about this "borrowed path"</p>



<a name="177620920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620920" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620920">(Oct 08 2019 at 14:30)</a>:</h4>
<p>codegen has it definitely, and I thought I saw the same pattern in borrowck when reviewing <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> 's PRs</p>



<a name="177620961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620961" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620961">(Oct 08 2019 at 14:30)</a>:</h4>
<p>there are definitely some cases where deref is "different" -- which are there to handle the loop case</p>



<a name="177620972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620972">(Oct 08 2019 at 14:30)</a>:</h4>
<p>these two examples don't have any <code>Deref</code> projection</p>



<a name="177620988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620988" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620988">(Oct 08 2019 at 14:30)</a>:</h4>
<p>but I don't think it really "unwinds" quite in the way you suggest</p>



<a name="177620989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177620989" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177620989">(Oct 08 2019 at 14:30)</a>:</h4>
<blockquote>
<p>these two examples don't have any <code>Deref</code> projection</p>
</blockquote>
<p>yes they do</p>



<a name="177621005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621005">(Oct 08 2019 at 14:30)</a>:</h4>
<p>typically <code>self: &amp;mut Struct</code></p>



<a name="177621028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621028" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621028">(Oct 08 2019 at 14:31)</a>:</h4>
<p>so <code>&amp;mut self.bar</code> =&gt; <code>&amp;mut (*self).bar</code></p>



<a name="177621037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621037" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621037">(Oct 08 2019 at 14:31)</a>:</h4>
<p>sorry, that was kind of hidden :)</p>



<a name="177621045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621045">(Oct 08 2019 at 14:31)</a>:</h4>
<p>ah right</p>



<a name="177621103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621103" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621103">(Oct 08 2019 at 14:31)</a>:</h4>
<p>the key point being that if you did <code>&amp;mut *self</code> as a separate step, you'd have two overlapping borrows</p>



<a name="177621127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621127" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621127">(Oct 08 2019 at 14:31)</a>:</h4>
<p>so the suggestion in <a href="https://paper.dropbox.com/doc/aGnvFEPxejaDOXWDvfcf0" target="_blank" title="https://paper.dropbox.com/doc/aGnvFEPxejaDOXWDvfcf0">https://paper.dropbox.com/doc/aGnvFEPxejaDOXWDvfcf0</a> would still keep all possibilities for that around, but we'd need to track extra state possibly</p>



<a name="177621231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621231" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621231">(Oct 08 2019 at 14:32)</a>:</h4>
<p>this is why I was proposing that we might want to have some explicit "intermediate steps" that we know will always be intermedaites</p>



<a name="177621265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621265" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621265">(Oct 08 2019 at 14:32)</a>:</h4>
<p>well it would be an entirely new <code>Rvalue</code>, thus borrowck could work with it</p>



<a name="177621288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621288">(Oct 08 2019 at 14:32)</a>:</h4>
<p>but I see how that would complicate things</p>



<a name="177621320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621320" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621320">(Oct 08 2019 at 14:33)</a>:</h4>
<p>it might be ok if it's an rvalue, but I feel like it's different from an rvalue</p>



<a name="177621466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621466" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621466">(Oct 08 2019 at 14:34)</a>:</h4>
<p>you mean the <code>&amp;mut *self</code> shouldn't even be stored in a local but in one of these intermediate locals?</p>



<a name="177621551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621551" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621551">(Oct 08 2019 at 14:34)</a>:</h4>
<p>that's what I mean</p>



<a name="177621583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621583" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621583">(Oct 08 2019 at 14:35)</a>:</h4>
<p>but I also mean that <code>&amp;mut *self</code> and <code>*self</code> are different</p>



<a name="177621620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621620">(Oct 08 2019 at 14:35)</a>:</h4>
<p>basically, there are two places where we use "places" to be "by-ref" -- i.e., to get at the <em>memory they refer to</em> and now <em>the value in that memory</em></p>



<a name="177621634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621634">(Oct 08 2019 at 14:35)</a>:</h4>
<p>the lhs of an assignment, and a borrow</p>



<a name="177621762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621762" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621762">(Oct 08 2019 at 14:36)</a>:</h4>
<p>"rvalue" (to me) is meant to be something that creates a value -- in this case, I'm not 100% sure what the value is... a pointer I guess? it doesn't have a proper rust type</p>



<a name="177621834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621834" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621834">(Oct 08 2019 at 14:36)</a>:</h4>
<p>I guess it could be <code>&amp;mut T</code> -- but the borrow that creates it is somehow different</p>



<a name="177621951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177621951" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177621951">(Oct 08 2019 at 14:37)</a>:</h4>
<p>well... the <code>*self</code> part is an rvalue reference in c++, which is technically of type <code>T</code></p>



<a name="177622027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622027" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622027">(Oct 08 2019 at 14:38)</a>:</h4>
<p>right, so this is the new thing :)</p>



<a name="177622041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622041" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622041">(Oct 08 2019 at 14:38)</a>:</h4>
<p>MIR doesn't have "references" right now</p>



<a name="177622045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622045" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622045">(Oct 08 2019 at 14:38)</a>:</h4>
<p>those are handled by places</p>



<a name="177622056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622056" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622056">(Oct 08 2019 at 14:38)</a>:</h4>
<p>but now we're kind of producing a new kind of value, which is a reference to a place</p>



<a name="177622075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622075" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622075">(Oct 08 2019 at 14:38)</a>:</h4>
<p>and I am sort of saying "maybe that's good, but we should put some strict limitations on how they are used"</p>



<a name="177622100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622100" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622100">(Oct 08 2019 at 14:38)</a>:</h4>
<p>i.e., they are intermediaries used to build up <em>proper values</em>, which are producing by "borrowing" them</p>



<a name="177622120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622120">(Oct 08 2019 at 14:39)</a>:</h4>
<p>or consuming them</p>



<a name="177622122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622122" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622122">(Oct 08 2019 at 14:39)</a>:</h4>
<p>this would also integrate with miri, in that the borrow operation is the point where we "claim memory"</p>



<a name="177622163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622163" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622163">(Oct 08 2019 at 14:39)</a>:</h4>
<p>right, they can be </p>
<ul>
<li>consumed to build new "references" -- need a better name</li>
<li>assigned to (which consumes them)</li>
<li>or borrowed (which creates a <code>&amp;</code> value)</li>
</ul>



<a name="177622234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622234" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622234">(Oct 08 2019 at 14:40)</a>:</h4>
<p><code>Operand::Copy</code> and <code>Move</code> would also be operating on these places</p>



<a name="177622254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622254" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622254">(Oct 08 2019 at 14:40)</a>:</h4>
<p>mm... yes, ok</p>



<a name="177622275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622275" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622275">(Oct 08 2019 at 14:40)</a>:</h4>
<p>so they can be</p>



<a name="177622290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622290" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622290">(Oct 08 2019 at 14:40)</a>:</h4>
<ul>
<li>consumed to build new "references" -- need a better name</li>
<li>assigned to (which consumes them)</li>
<li>copied/moved (via an Operand)</li>
<li>or borrowed (which creates a <code>&amp;</code> value)</li>
</ul>



<a name="177622334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622334" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622334">(Oct 08 2019 at 14:41)</a>:</h4>
<p>so... this is all the places where <code>Place</code>s are used right now?</p>



<a name="177622342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622342" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622342">(Oct 08 2019 at 14:41)</a>:</h4>
<p>of course :)</p>



<a name="177622349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622349" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622349">(Oct 08 2019 at 14:41)</a>:</h4>
<p>the new thing is the first bullet, I guess</p>



<a name="177622366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622366" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622366">(Oct 08 2019 at 14:41)</a>:</h4>
<p>i.e., the idea is that where we now have a complex, compound place</p>



<a name="177622385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622385" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622385">(Oct 08 2019 at 14:41)</a>:</h4>
<p>we'd only have some simpler form, and there'd be some way to do a "deref-projection"</p>



<a name="177622395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622395">(Oct 08 2019 at 14:41)</a>:</h4>
<p>in the limit, you could have all places just be variables</p>



<a name="177622413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622413" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622413">(Oct 08 2019 at 14:42)</a>:</h4>
<p>this is kind of the "per MIR place interning" I guess but baked in :P</p>



<a name="177622475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622475" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622475">(Oct 08 2019 at 14:42)</a>:</h4>
<p>(not quite, because projections would be copied everywhere)</p>



<a name="177622481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622481" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622481">(Oct 08 2019 at 14:42)</a>:</h4>
<blockquote>
<p>in the limit, you could have all places just be variables</p>
</blockquote>
<p>not <em>variables</em> really</p>



<a name="177622488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622488" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622488">(Oct 08 2019 at 14:42)</a>:</h4>
<p><em>place variables</em></p>



<a name="177622498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622498">(Oct 08 2019 at 14:42)</a>:</h4>
<p>so we're flattening places to be just <code>(PlaceBase, PlaceElem)</code> instead of <code>(PlaceBase, Box&lt;[PlaceElem]&gt;)</code></p>



<a name="177622502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622502" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622502">(Oct 08 2019 at 14:42)</a>:</h4>
<p>i.e., <code>P2 = P1.f</code></p>



<a name="177622524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622524" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622524">(Oct 08 2019 at 14:42)</a>:</h4>
<p>well, I think what might be better would be to keep "GEP-like" projections</p>



<a name="177622534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622534" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622534">(Oct 08 2019 at 14:42)</a>:</h4>
<p>and so the only real new thing is <code>P1 = *P2</code></p>



<a name="177622571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622571" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622571">(Oct 08 2019 at 14:43)</a>:</h4>
<p>and runtime index ops</p>



<a name="177622582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622582" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622582">(Oct 08 2019 at 14:43)</a>:</h4>
<p>mm, yes,</p>



<a name="177622584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622584" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622584">(Oct 08 2019 at 14:43)</a>:</h4>
<p>and that</p>



<a name="177622601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622601" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622601">(Oct 08 2019 at 14:43)</a>:</h4>
<p>so you can "embed" <code>foo.a.b</code> as a place</p>



<a name="177622646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622646" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622646">(Oct 08 2019 at 14:43)</a>:</h4>
<p>I guess it means that <code>PlaceBase</code> now includes some kind of <code>PlaceRef</code> alternative, so it isn't always "rooted" in a local</p>



<a name="177622694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622694" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622694">(Oct 08 2019 at 14:44)</a>:</h4>
<p>and we have some kind of "single use" restriction on PlaceRefs</p>



<a name="177622716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622716" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622716">(Oct 08 2019 at 14:44)</a>:</h4>
<p>(stronger than SSA, in other words)</p>



<a name="177622727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622727" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622727">(Oct 08 2019 at 14:44)</a>:</h4>
<p>yes</p>



<a name="177622778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622778">(Oct 08 2019 at 14:45)</a>:</h4>
<p>and we also have a new <code>Statement::Project</code> or sth that takes a <code>PlaceLocalId</code> and a <code>Place</code>?</p>



<a name="177622849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622849" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622849">(Oct 08 2019 at 14:46)</a>:</h4>
<p>yeah</p>



<a name="177622898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622898" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622898">(Oct 08 2019 at 14:46)</a>:</h4>
<p>well wait</p>



<a name="177622925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622925">(Oct 08 2019 at 14:46)</a>:</h4>
<p>I am imagining something like <code>ProjectDeref</code> and <code>ProjectIndex</code></p>



<a name="177622940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622940">(Oct 08 2019 at 14:46)</a>:</h4>
<p>hmm... can we at that point just make the current <code>Place</code> be <code>Box&lt;[(Place, NonGEPProj)]&gt;</code>?</p>



<a name="177622994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622994">(Oct 08 2019 at 14:47)</a>:</h4>
<p>well no</p>



<a name="177622999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177622999" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177622999">(Oct 08 2019 at 14:47)</a>:</h4>
<p>uh</p>



<a name="177623009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623009" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623009">(Oct 08 2019 at 14:47)</a>:</h4>
<p>let me untangle my thought</p>



<a name="177623026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623026">(Oct 08 2019 at 14:47)</a>:</h4>
<p>I am imagining</p>
<div class="codehilite"><pre><span></span>Place =
  X // local variable
| P // place variable
| Place `.` Field

Statement =
  Place = Rvalue
| P := * Place
| P := Place [ Place ]
| ...
</pre></div>



<a name="177623097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623097" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623097">(Oct 08 2019 at 14:48)</a>:</h4>
<p>sorry, I think easiest with grammars for some reason :)</p>



<a name="177623106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623106" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623106">(Oct 08 2019 at 14:48)</a>:</h4>
<p>those map to enums in a fairly straightforward way I guess</p>



<a name="177623121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623121" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623121">(Oct 08 2019 at 14:48)</a>:</h4>
<p>also, I probably excluded some "GEP-like" place options</p>



<a name="177623151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623151" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623151">(Oct 08 2019 at 14:48)</a>:</h4>
<p>oh, I think <span class="user-mention" data-user-id="119009">@eddyb</span> wanted to make "pull out constants" as the base of a place, so we might also include <code>P := Static</code> or something</p>



<a name="177623169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623169" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623169">(Oct 08 2019 at 14:49)</a>:</h4>
<p>I'm using <code>:=</code> as the "define a new place variable" notation</p>



<a name="177623224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623224">(Oct 08 2019 at 14:49)</a>:</h4>
<p>since we have a "single use" rule, do we even need place variables? Can't we make places just be a <code>(PlaceBase, [Proj])</code> for <code>enum Proj { NonGepProj(NonGepProj), GepProj(Vec&lt;PlaceElem&gt;) }</code> ?</p>



<a name="177623308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623308" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623308">(Oct 08 2019 at 14:50)</a>:</h4>
<p>isn't that what we have now :)</p>



<a name="177623323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623323" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623323">(Oct 08 2019 at 14:50)</a>:</h4>
<p>maybe I don't understand what <code>NonGepProj</code> is meant to be</p>



<a name="177623346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623346" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623346">(Oct 08 2019 at 14:50)</a>:</h4>
<p>hm... yea sorry, ignore that</p>



<a name="177623369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623369" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623369">(Oct 08 2019 at 14:51)</a>:</h4>
<p>I think that "place variables" could be lowered to real values in a fairly easy way</p>



<a name="177623379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623379" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623379">(Oct 08 2019 at 14:51)</a>:</h4>
<p>basically they become pointers</p>



<a name="177623392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623392" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623392">(Oct 08 2019 at 14:51)</a>:</h4>
<p>which seems worth pointing out</p>



<a name="177623406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623406" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623406">(Oct 08 2019 at 14:51)</a>:</h4>
<p>(and maybe their Rust type is even <code>*mut Foo</code> or something)</p>



<a name="177623423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623423" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623423">(Oct 08 2019 at 14:51)</a>:</h4>
<p>you want to be able to turn MIR with place variables to MIR without them?</p>



<a name="177623428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623428" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623428">(Oct 08 2019 at 14:51)</a>:</h4>
<p>presumably optimizations would start to handle them that way</p>



<a name="177623444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623444" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623444">(Oct 08 2019 at 14:51)</a>:</h4>
<p>right, you can just start treating them as pointers, right?</p>



<a name="177623502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623502" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623502">(Oct 08 2019 at 14:52)</a>:</h4>
<p>after borrowck that should be possible</p>



<a name="177623518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623518" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623518">(Oct 08 2019 at 14:52)</a>:</h4>
<p>I think that is the point of all this, roughly speaking</p>



<a name="177623530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623530">(Oct 08 2019 at 14:52)</a>:</h4>
<p>that borrow-ck gets to view them as special</p>



<a name="177623537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623537" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623537">(Oct 08 2019 at 14:52)</a>:</h4>
<p>but afterwards we just kind of "forget" that</p>



<a name="177623541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623541">(Oct 08 2019 at 14:52)</a>:</h4>
<p>iirc miri should just work if you turned a borrowchecked program into one using raw pointers everywhere</p>



<a name="177623552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623552" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623552">(Oct 08 2019 at 14:52)</a>:</h4>
<p>that said, if polonius is a success</p>



<a name="177623566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623566" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623566">(Oct 08 2019 at 14:52)</a>:</h4>
<p>well, nm</p>



<a name="177623596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623596" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623596">(Oct 08 2019 at 14:53)</a>:</h4>
<p>it's just that -- it's plausible borrowck could be integrated differently</p>



<a name="177623608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623608" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623608">(Oct 08 2019 at 14:53)</a>:</h4>
<p>as polonius creates a kind of "layer" between MIR and its input</p>



<a name="177623626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623626" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623626">(Oct 08 2019 at 14:53)</a>:</h4>
<p>(which is risky, since that was one of the things MIR was meant to fix :) but the layer is fairly simple, not complex like EUV)</p>



<a name="177623665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623665">(Oct 08 2019 at 14:54)</a>:</h4>
<p>I don't think that changes anything too fundamental though</p>



<a name="177623730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623730" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623730">(Oct 08 2019 at 14:54)</a>:</h4>
<p>the tl;dr is that we want some way to easily extract the path that was borrowed "in full"</p>



<a name="177623760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623760" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623760">(Oct 08 2019 at 14:54)</a>:</h4>
<p>while later kind of converting to a simpler IR with less complex structure</p>



<a name="177623831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623831">(Oct 08 2019 at 14:55)</a>:</h4>
<p>(maybe these "place references" are actually locals of type <code>*mut T</code> and a special flag, even?)</p>



<a name="177623855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623855" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623855">(Oct 08 2019 at 14:55)</a>:</h4>
<p>right, similar to how we need the generator stuff up to a point and then just never use those statements again</p>



<a name="177623879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623879" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623879">(Oct 08 2019 at 14:55)</a>:</h4>
<blockquote>
<p>(maybe these "place references" are actually locals of type <code>*mut T</code> and a special flag, even?)</p>
</blockquote>
<p>we could teach <code>TyKind</code> about them</p>



<a name="177623974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623974" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623974">(Oct 08 2019 at 14:56)</a>:</h4>
<p>true</p>



<a name="177623998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177623998" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177623998">(Oct 08 2019 at 14:56)</a>:</h4>
<p>(I guess that could serve as the flag)</p>



<a name="177624058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177624058" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177624058">(Oct 08 2019 at 14:57)</a>:</h4>
<p>and would probably serve as a canary for accidentally using a local without checking the flag</p>



<a name="177711903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177711903" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177711903">(Oct 09 2019 at 13:12)</a>:</h4>
<p>yeah the <code>&amp;</code> would have to be somehow special-magic for Stacked Borrows to make this work... but I expect the same special-magic will be needed to make the borrow checker work so that should be fine</p>



<a name="177711975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177711975" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177711975">(Oct 09 2019 at 13:13)</a>:</h4>
<p>also this is "funny" timing, one PhD student here is just right now working on extending our formal MIR-like model with support for <code>*</code> in paths...</p>



<a name="177712057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177712057" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177712057">(Oct 09 2019 at 13:14)</a>:</h4>
<p>but given that the borrow checker still has to support existing code, I'd actually be surprised if borrow checking would work on paths that don't have <code>*</code>. it seems more likely that the borrow checker will work on a notion of paths that's separate from what MIR does?</p>



<a name="177947083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177947083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177947083">(Oct 11 2019 at 20:39)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> that's exactly it; MIR would have a more limited notion of paths, but borrow checker would be able to reconstruct its more extended notion in a simple way from the MIR</p>



<a name="177989883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Deref%20is%20not%20a%20projection/near/177989883" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/189540-t-compiler/wg-mir-opt/topic/Deref.20is.20not.20a.20projection.html#177989883">(Oct 12 2019 at 13:59)</a>:</h4>
<p>that'll be... interesting ;)</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>