<html>
<head><meta charset="utf-8"><title>`x &amp; false == false` · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html">`x &amp; false == false`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="203698991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203698991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203698991">(Jul 13 2020 at 10:31)</a>:</h4>
<p>if you have some other issues that need hands let me know! I'd like to help out where I can</p>



<a name="203699515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203699515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203699515">(Jul 13 2020 at 10:37)</a>:</h4>
<p>We have a moderate list <a href="https://github.com/rust-lang/rust/issues?q=is%3Aopen+is%3Aissue+label%3AA-mir-opt">https://github.com/rust-lang/rust/issues?q=is%3Aopen+is%3Aissue+label%3AA-mir-opt</a> but I need to pick out good entry level optimizations. It's not like most of them are really hard per se, but if you have to learn rustc contribution and mir optimizations at the same time, it's better to start with something that isn't gonna be a 4 week rabbit hole</p>



<a name="203700402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700402">(Jul 13 2020 at 10:48)</a>:</h4>
<p>oooh I have one for you</p>



<a name="203700403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700403">(Jul 13 2020 at 10:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/72751">https://github.com/rust-lang/rust/issues/72751</a></p>



<a name="203700405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700405">(Jul 13 2020 at 10:48)</a>:</h4>
<p>This one is great</p>



<a name="203700428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700428">(Jul 13 2020 at 10:49)</a>:</h4>
<p><code>x &amp; false</code> is guaranteed <code>false</code> but const prop can't figure that out</p>



<a name="203700568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700568">(Jul 13 2020 at 10:50)</a>:</h4>
<p>If you look at <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1ef992fe05b4e49b40ff5f63acc796d5">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1ef992fe05b4e49b40ff5f63acc796d5</a>, and click (MIR in the menu in the top left corner), you can see that there's a <code>BitAnd</code> operation that doesn't actually make sense</p>



<a name="203700597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700597">(Jul 13 2020 at 10:51)</a>:</h4>
<p>you can basically follow the instructions in <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/multiple.20return.20terminators/near/203699347">https://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/multiple.20return.20terminators/near/203699347</a></p>



<a name="203700598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700598">(Jul 13 2020 at 10:51)</a>:</h4>
<p>to get started</p>



<a name="203700610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700610">(Jul 13 2020 at 10:51)</a>:</h4>
<p>but you won't create your own new optimization, you'll work on <code>src/librustc_mir/transform/const_prop.rs</code></p>



<a name="203700952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203700952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203700952">(Jul 13 2020 at 10:56)</a>:</h4>
<p>basically you have to change <a href="https://github.com/rust-lang/rust/blob/9d09331e00b02f81c714b0c41ce3a38380dd36a2/src/librustc_mir/transform/const_prop.rs#L534">https://github.com/rust-lang/rust/blob/9d09331e00b02f81c714b0c41ce3a38380dd36a2/src/librustc_mir/transform/const_prop.rs#L534</a> into a match and add arms for <code>BitAnd</code> and <code>BitOr</code></p>



<a name="203701047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203701047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203701047">(Jul 13 2020 at 10:57)</a>:</h4>
<p>if the type of the values being operated on is <code>bool</code>, then the idea is to read the left and right side of the operators, but read them fallibly. We're fine with one value not existing in case the other has a short circuiting value</p>



<a name="203701176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203701176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203701176">(Jul 13 2020 at 10:59)</a>:</h4>
<p>though, now that I'm looking at this, I think you need to work at <a href="https://github.com/rust-lang/rust/blob/9d09331e00b02f81c714b0c41ce3a38380dd36a2/src/librustc_mir/transform/const_prop.rs#L613">https://github.com/rust-lang/rust/blob/9d09331e00b02f81c714b0c41ce3a38380dd36a2/src/librustc_mir/transform/const_prop.rs#L613</a> instead of inside the function being called from there</p>



<a name="203701561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203701561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203701561">(Jul 13 2020 at 11:03)</a>:</h4>
<p>Cool :) I’ve got my rustc working already so I’ll take a look this afternoon</p>



<a name="203746321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203746321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203746321">(Jul 13 2020 at 17:47)</a>:</h4>
<p>ok I think I understand how all these functions fit together to decide prop</p>



<a name="203746346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203746346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203746346">(Jul 13 2020 at 17:47)</a>:</h4>
<p>I'll add support for &amp;&amp; and || and push a PR this evening</p>



<a name="203746809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203746809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203746809">(Jul 13 2020 at 17:50)</a>:</h4>
<p>how do I add a new testcase?</p>



<a name="203746876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203746876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203746876">(Jul 13 2020 at 17:51)</a>:</h4>
<p>nvm i think i found it in the book</p>



<a name="203747048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203747048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203747048">(Jul 13 2020 at 17:52)</a>:</h4>
<p>You can take a look at some of the existing tests (for example <code>src/test/mir-opt/const_prop/aggregate.rs</code>). The main thing to notice is the <code>// EMIT_MIR rustc.main.ConstProp.diff</code> directive.</p>



<a name="203747087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203747087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203747087">(Jul 13 2020 at 17:53)</a>:</h4>
<p>After you add your new test file, you can run <code>./x.py test --stage 1 -i --bless src/test/mir-opt</code> to have it generate the diff file for you</p>



<a name="203747451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203747451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203747451">(Jul 13 2020 at 17:56)</a>:</h4>
<p>just did that :)</p>



<a name="203750160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203750160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203750160">(Jul 13 2020 at 18:15)</a>:</h4>
<p>:'( built the compiler without <code>trace!</code> and <code>debug!</code></p>



<a name="203757986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203757986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203757986">(Jul 13 2020 at 19:15)</a>:</h4>
<p>hmm, it seems like this specific optimization is just an instance of a more general pattern where constant prop doesn't work if only one arg is defined</p>



<a name="203758012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758012">(Jul 13 2020 at 19:15)</a>:</h4>
<p>for example: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=618c614caefa638e6b5782e519b07e03">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=618c614caefa638e6b5782e519b07e03</a></p>



<a name="203758070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758070">(Jul 13 2020 at 19:16)</a>:</h4>
<p>we should expect <code>a  + 0 == a</code></p>



<a name="203758098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758098">(Jul 13 2020 at 19:16)</a>:</h4>
<p>at the very least for all builtin types, no?</p>



<a name="203758225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758225">(Jul 13 2020 at 19:17)</a>:</h4>
<p>it's all because <code>check_binary_op</code> which is meant to verify if there are overflows expects both args to be defined and if not will abort the constant propagation for that BinaryOp</p>



<a name="203758347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758347">(Jul 13 2020 at 19:18)</a>:</h4>
<p>it needs both args in order to call <code>overflowing_binary_op</code>. </p>
<p>PS: I'm logging my work here hopefully it doesn't bother anyone :) let me know otherwise</p>



<a name="203758366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758366">(Jul 13 2020 at 19:18)</a>:</h4>
<p>Yes, you're correct.</p>



<a name="203758411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758411">(Jul 13 2020 at 19:19)</a>:</h4>
<p>IMO this feels a bit more like a "peephole optimization" to me than something that has to go in <code>const_prop</code></p>



<a name="203758439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758439">(Jul 13 2020 at 19:19)</a>:</h4>
<p>yea honestly that's the feeling im getting</p>



<a name="203758477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758477">(Jul 13 2020 at 19:20)</a>:</h4>
<p>I feel like we have an existing pass for that kind of thing</p>



<a name="203758503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758503">(Jul 13 2020 at 19:20)</a>:</h4>
<p>One sec</p>



<a name="203758539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758539">(Jul 13 2020 at 19:20)</a>:</h4>
<p>Yeah <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/instcombine.rs">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/instcombine.rs</a></p>



<a name="203758542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758542">(Jul 13 2020 at 19:20)</a>:</h4>
<p>instcombine?</p>



<a name="203758544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758544">(Jul 13 2020 at 19:20)</a>:</h4>
<p>yea</p>



<a name="203758668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758668">(Jul 13 2020 at 19:22)</a>:</h4>
<p>Given that you don't need any interpreter state to recognize the <code>a + 0 == a</code> case (or any of the other binary operators) that pass seems like a better fit for this to me</p>



<a name="203758740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758740">(Jul 13 2020 at 19:22)</a>:</h4>
<p>yea, is it run for several iterations?</p>



<a name="203758782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758782">(Jul 13 2020 at 19:22)</a>:</h4>
<p>Not currently it looks like</p>



<a name="203758789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758789">(Jul 13 2020 at 19:22)</a>:</h4>
<p>these kind of identity opts can ripple through</p>



<a name="203758847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758847">(Jul 13 2020 at 19:23)</a>:</h4>
<p>If it doesn't hurt our perf benchmarks, I don't think there would be any objection to making it do so</p>



<a name="203758984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203758984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203758984">(Jul 13 2020 at 19:24)</a>:</h4>
<p>Alternatively, we might 80% of the cases just by running it twice during the optimization pipeline.</p>



<a name="203759044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759044">(Jul 13 2020 at 19:24)</a>:</h4>
<p>I don't have an issue running it to a fixed point though.</p>



<a name="203759124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759124">(Jul 13 2020 at 19:25)</a>:</h4>
<p>I think a constant number of iterations probs is good enough</p>



<a name="203759137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759137">(Jul 13 2020 at 19:25)</a>:</h4>
<p>or bounded fixpoint</p>



<a name="203759184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759184">(Jul 13 2020 at 19:25)</a>:</h4>
<p>I'll start by implementing the opt :)</p>



<a name="203759199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759199">(Jul 13 2020 at 19:25)</a>:</h4>
<p>Yeah, I'd start with that</p>



<a name="203759223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759223">(Jul 13 2020 at 19:25)</a>:</h4>
<p>I don't think running it multiple times will be very beneficial currently</p>



<a name="203759349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759349">(Jul 13 2020 at 19:26)</a>:</h4>
<p>it's trivial to write examples that defeat a single pass but uncertain how common they are in practice</p>



<a name="203759395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759395">(Jul 13 2020 at 19:27)</a>:</h4>
<p>ie: <code>y &amp; (x &amp; false)</code></p>



<a name="203759938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759938">(Jul 13 2020 at 19:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60/near/203758668">said</a>:</p>
<blockquote>
<p>Given that you don't need any interpreter state to recognize the <code>a + 0 == a</code> case (or any of the other binary operators) that pass seems like a better fit for this to me</p>
</blockquote>
<p>I do though, since I need to evaluate the places? unless I misunderstood you</p>



<a name="203759972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203759972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203759972">(Jul 13 2020 at 19:31)</a>:</h4>
<p>I'd say go a head and include some examples of that kind of expression in the MIR tests you add. When we make <code>InstrCombine</code> iterate, we should see those expressions get optimized.</p>



<a name="203760199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760199">(Jul 13 2020 at 19:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60/near/203759938">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60/near/203758668">said</a>:</p>
<blockquote>
<p>Given that you don't need any interpreter state to recognize the <code>a + 0 == a</code> case (or any of the other binary operators) that pass seems like a better fit for this to me</p>
</blockquote>
<p>I do though, since I need to evaluate the places? unless I misunderstood you</p>
</blockquote>
<p>Hmm I was thinking that if this ran after <code>ConstProp</code>, then we'd see things like </p>
<div class="codehilite"><pre><span></span><code><span class="n">_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckedAdd</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="n">_3</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="mi">0</span><span class="k">i32</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="203760311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760311">(Jul 13 2020 at 19:34)</a>:</h4>
<p>So you'd just walk every MIR statement looking for things like <code>CheckedAdd</code> or <code>Add</code> where one of the arguments is <code>const 0i{size}</code></p>



<a name="203760356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760356">(Jul 13 2020 at 19:34)</a>:</h4>
<p>for whatever reason in the original bitand example</p>



<a name="203760365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760365">(Jul 13 2020 at 19:34)</a>:</h4>
<p>the false is not propagated</p>



<a name="203760404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760404">(Jul 13 2020 at 19:35)</a>:</h4>
<p>so in the original example we get <code>BitAnd(_X, _Y)</code></p>



<a name="203760416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760416">(Jul 13 2020 at 19:35)</a>:</h4>
<p>Hmm</p>



<a name="203760436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760436">(Jul 13 2020 at 19:35)</a>:</h4>
<p>seems like there could be a seperate issue propagating bools?</p>



<a name="203760459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760459">(Jul 13 2020 at 19:35)</a>:</h4>
<p>I'll start by adding this peephole opt for binary operations</p>



<a name="203760531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760531">(Jul 13 2020 at 19:36)</a>:</h4>
<p>then i'll figure out why <code>false</code> is not propagating</p>



<a name="203760636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760636">(Jul 13 2020 at 19:37)</a>:</h4>
<p>Is this what you're seeing? <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=5352bfb0576e4efc33a357bde970def7">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=5352bfb0576e4efc33a357bde970def7</a></p>



<a name="203760667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760667">(Jul 13 2020 at 19:37)</a>:</h4>
<blockquote>
<p>_4 = BitAnd(move _5, const false); // scope 0 at src/lib.rs:2:10: 2:21</p>
</blockquote>



<a name="203760740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760740">(Jul 13 2020 at 19:38)</a>:</h4>
<p>look at oli's example</p>



<a name="203760743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760743">(Jul 13 2020 at 19:38)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1ef992fe05b4e49b40ff5f63acc796d5">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1ef992fe05b4e49b40ff5f63acc796d5</a></p>



<a name="203760791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760791">(Jul 13 2020 at 19:38)</a>:</h4>
<p><code> _3 = const false;</code><br>
<code>_5 = BitAnd(move _3, move _4); </code></p>



<a name="203760827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760827">(Jul 13 2020 at 19:38)</a>:</h4>
<p>Oh</p>



<a name="203760834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760834">(Jul 13 2020 at 19:38)</a>:</h4>
<p>Gotcha</p>



<a name="203760842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760842">(Jul 13 2020 at 19:38)</a>:</h4>
<p>ohhh i think that's cuz the bitand</p>



<a name="203760873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760873">(Jul 13 2020 at 19:39)</a>:</h4>
<p>Yeah, we don't do partial propagation yet</p>



<a name="203760881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760881">(Jul 13 2020 at 19:39)</a>:</h4>
<p>is inserted during lowering</p>



<a name="203760913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760913">(Jul 13 2020 at 19:39)</a>:</h4>
<p><code>ConstProp</code> currently really wants to evaluate &amp; replace the entire statement</p>



<a name="203760927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760927">(Jul 13 2020 at 19:39)</a>:</h4>
<p>ah nvm, I thought it could have been from a pass between const prop and instcombine</p>



<a name="203760943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760943">(Jul 13 2020 at 19:39)</a>:</h4>
<p>yep, I noticed :P</p>



<a name="203760946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760946">(Jul 13 2020 at 19:39)</a>:</h4>
<p>Not just whatever parts it knows the values to</p>



<a name="203760950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203760950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203760950">(Jul 13 2020 at 19:39)</a>:</h4>
<p>Heh</p>



<a name="203761057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203761057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203761057">(Jul 13 2020 at 19:40)</a>:</h4>
<p>but couldn't it still propagate <code>_3</code> into <code>_5</code>?</p>



<a name="203761064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203761064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203761064">(Jul 13 2020 at 19:40)</a>:</h4>
<p>it knows it's value...</p>



<a name="203761375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203761375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203761375">(Jul 13 2020 at 19:43)</a>:</h4>
<p><code>InstCombine</code> is also run before <code>ConstProp</code></p>



<a name="203765924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203765924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203765924">(Jul 13 2020 at 20:21)</a>:</h4>
<p>hmm seems like for this opt to be useful it has to be in <code>ConstProp</code> and I'll need to write something like <code>eval_rval_into_place</code> which only does binaryops with missing args</p>



<a name="203766100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203766100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203766100">(Jul 13 2020 at 20:23)</a>:</h4>
<p>or, I need to get constant prop to properly propagate simple constants into rvalues + flip the ordering between the passes</p>



<a name="203767532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203767532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203767532">(Jul 13 2020 at 20:35)</a>:</h4>
<p>That's true. Putting it in const props seems fine.</p>



<a name="203770376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203770376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203770376">(Jul 13 2020 at 20:58)</a>:</h4>
<p>in summary: rustc only propagates constants into binops if both args are constant. this means that when an operation uses a non-constant value, propagation isn't done. this prevents writing a simple peephole opt which folds neutral elements / top elements for <code>&amp;</code>, <code>|</code>, <code>+</code>, <code>-</code>, <code>/</code> etc..</p>



<a name="203801054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801054">(Jul 14 2020 at 05:55)</a>:</h4>
<p>Hellu</p>



<a name="203801057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801057">(Jul 14 2020 at 05:55)</a>:</h4>
<p>I think it makes sense to run this after const-prop</p>



<a name="203801059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801059">(Jul 14 2020 at 05:55)</a>:</h4>
<p>Um</p>



<a name="203801068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801068">(Jul 14 2020 at 05:55)</a>:</h4>
<p>Also!</p>



<a name="203801123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801123">(Jul 14 2020 at 05:56)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> I'm getting ready to write my thesis on mir-opts. I plan to complete the current const-prop implementation, by letting it go past blocks</p>



<a name="203801128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801128">(Jul 14 2020 at 05:57)</a>:</h4>
<p>Currently const-prop propagates constants more or less forever</p>



<a name="203801133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801133">(Jul 14 2020 at 05:57)</a>:</h4>
<p>Like "const" constants</p>



<a name="203801142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801142">(Jul 14 2020 at 05:57)</a>:</h4>
<p>But we don't have the same yet for local variables that <em>also happen to reduce to a constant at compile time</em>, if that makes sense</p>



<a name="203801203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801203">(Jul 14 2020 at 05:59)</a>:</h4>
<p>I will be working on that so don't worry</p>



<a name="203801205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801205">(Jul 14 2020 at 05:59)</a>:</h4>
<p>I'll cover those bases for you</p>



<a name="203801206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801206">(Jul 14 2020 at 05:59)</a>:</h4>
<p><span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>️</p>



<a name="203801271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801271">(Jul 14 2020 at 06:00)</a>:</h4>
<p>We have an algorithm ready (that oli and I think is correct). I just need to get past bureaucracy with uni now ^^</p>



<a name="203801294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801294">(Jul 14 2020 at 06:01)</a>:</h4>
<p>But yeah, coming back to local vars. The reason they don't get propagated further is that we have restricted their propagation to just their own blocks</p>



<a name="203801338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801338">(Jul 14 2020 at 06:02)</a>:</h4>
<p>Because when you get into other blocks you have to be aware of control flow</p>



<a name="203801442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801442">(Jul 14 2020 at 06:05)</a>:</h4>
<p>I think it makes sense to add your opt in const-prop. </p>
<p>Adding zero, multiplying by one, multiplying by zero, doing &amp; false and | true, are all edge cases of expression evaluation that can result in simplified expressions at compile time.</p>



<a name="203801501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203801501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203801501">(Jul 14 2020 at 06:06)</a>:</h4>
<p>So... I think it makes sense. To add it to const-prop. <span class="user-mention" data-user-id="124288">@oli</span> what do you think?</p>



<a name="203807018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203807018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203807018">(Jul 14 2020 at 07:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60/near/203760873">said</a>:</p>
<blockquote>
<p>Yeah, we don't do partial propagation yet</p>
</blockquote>
<p>that's why I wanted to do this in const prop first. Another reason is that in contrast to <code>a + 0</code>, we can continue const propping after <code>true | a</code>, so if we do it in const prop we don't need a fixed point iteration</p>



<a name="203923934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/203923934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#203923934">(Jul 15 2020 at 07:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60/near/203758668">said</a>:</p>
<blockquote>
<p>Given that you don't need any interpreter state to recognize the <code>a + 0 == a</code> case (or any of the other binary operators) that pass seems like a better fit for this to me</p>
</blockquote>
<p>well there can be advantages to doing both together, if a const-prop simplification and an instcombine mutually depend on each other.<br>
out constprop likely is not powerful enough for that though.</p>



<a name="204267081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204267081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204267081">(Jul 17 2020 at 22:31)</a>:</h4>
<p>I got <code>x || false</code> and <code>x &amp;&amp; true</code> working :) but getting cases like <code>x + 0</code> working is awkward with the current const_prop setup and would be better suited to instcombine currently I think.</p>



<a name="204287918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204287918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204287918">(Jul 18 2020 at 06:46)</a>:</h4>
<p>sounds good, let's do nop integer math on non-constants in a separate PR</p>



<a name="204316058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204316058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204316058">(Jul 18 2020 at 20:18)</a>:</h4>
<p>I noticed however that constant prop misses a lot of opportunities currently, it doesn't actually push constants into the operands of rvalues!</p>



<a name="204316078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204316078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204316078">(Jul 18 2020 at 20:19)</a>:</h4>
<p>this makes it easy to get code like _1 = 5; _2 = x + _1 it'd be nice for it to at least constprop _1 into _2</p>



<a name="204316713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204316713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204316713">(Jul 18 2020 at 20:36)</a>:</h4>
<p>I think it's just a matter of adding another case to the visitor so that we properly substitute into operands</p>



<a name="204327366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204327366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204327366">(Jul 19 2020 at 02:01)</a>:</h4>
<p>As a side question: is this at least an optimization the LLVM catches later in the compilation? and then adding this to MIR just helps generics and miri and such?</p>



<a name="204338095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204338095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204338095">(Jul 19 2020 at 07:55)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> the one that Xavier just mentioned? Yes. This is something that LLVM catches later.</p>



<a name="204338155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204338155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204338155">(Jul 19 2020 at 07:56)</a>:</h4>
<p>Adding this to MIR helps because MIR is more aware of everything. LLVM has to do a lot of work to optimize our code. Doing it in MIR is more efficient.</p>



<a name="204338160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204338160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204338160">(Jul 19 2020 at 07:57)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> it actually does push them, but it cannot currently do so for all cases. Locals aren't propagated outside of their own block.</p>



<a name="204338199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204338199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204338199">(Jul 19 2020 at 07:58)</a>:</h4>
<p>That is what I'll be working on</p>



<a name="204338200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204338200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204338200">(Jul 19 2020 at 07:58)</a>:</h4>
<p>Because the code that you posted should and will be able to propagate ^^</p>



<a name="204338325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204338325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204338325">(Jul 19 2020 at 08:01)</a>:</h4>
<p>I'm not yet coding it because I have to wait on uni to start my thesis. But it's the first on my list, and oli and I have an algorithm in mind to do the propagation without breaking correct code.</p>



<a name="204341076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204341076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204341076">(Jul 19 2020 at 09:31)</a>:</h4>
<p>I checked it doesn’t and they are marked as always propagate</p>



<a name="204341118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204341118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204341118">(Jul 19 2020 at 09:32)</a>:</h4>
<p>The problem is the code only propagates into a statement if that statement itself is good to propagate</p>



<a name="204341126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204341126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204341126">(Jul 19 2020 at 09:32)</a>:</h4>
<p>But I’ll leave it to toy</p>



<a name="204341132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204341132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204341132">(Jul 19 2020 at 09:33)</a>:</h4>
<p>it only propagates into assignments to locals if the entire local is constant</p>



<a name="204341140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204341140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204341140">(Jul 19 2020 at 09:33)</a>:</h4>
<p>if you have <code>x + known_to_be_const</code>, there's no partial propagation happening</p>



<a name="204341149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204341149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204341149">(Jul 19 2020 at 09:33)</a>:</h4>
<p>discussion and impl about that continues in <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/const.20prop.20into.20operands/near/204339934">https://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/const.20prop.20into.20operands/near/204339934</a></p>



<a name="204342305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204342305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204342305">(Jul 19 2020 at 10:08)</a>:</h4>
<p>Yep that’s what I meant</p>



<a name="204364529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204364529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204364529">(Jul 19 2020 at 18:28)</a>:</h4>
<p>Ahhh I see, my bad</p>



<a name="204364530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204364530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Fischer <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204364530">(Jul 19 2020 at 18:28)</a>:</h4>
<p>:)</p>



<a name="204478010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204478010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204478010">(Jul 20 2020 at 21:22)</a>:</h4>
<p>weeiiird... I'm getting a bizarre failure from my changes</p>



<a name="204478017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204478017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204478017">(Jul 20 2020 at 21:22)</a>:</h4>
<p>but it's not actually the optimization??</p>



<a name="204480305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204480305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204480305">(Jul 20 2020 at 21:47)</a>:</h4>
<p>it seems related to running these lines:</p>
<div class="codehilite"><pre><span></span><code>                    let l = this.ecx.eval_operand(left, None);
                    let r = this.ecx.eval_operand(right, None);

                    if let (Ok(_), Ok(_)) = (&amp;l, &amp;r) {
                        this.ecx.eval_rvalue_into_place(rvalue, place)?;
                        return Ok(());
                    }
</code></pre></div>



<a name="204480332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204480332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204480332">(Jul 20 2020 at 21:47)</a>:</h4>
<p>but i really don't see how that would cause <code>crossbeam-utils</code> to no longer compile</p>



<a name="204491776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/%60x%20%26%20false%20%3D%3D%20false%60/near/204491776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/.60x.20.26.20false.20.3D.3D.20false.60.html#204491776">(Jul 20 2020 at 22:31)</a>:</h4>
<p>if i replace the <code>if let</code> by using <code>is_ok</code> everything compiles?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>