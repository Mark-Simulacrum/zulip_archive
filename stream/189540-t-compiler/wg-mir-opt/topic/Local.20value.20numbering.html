<html>
<head><meta charset="utf-8"><title>Local value numbering · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html">Local value numbering</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264248964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264248964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264248964">(Dec 09 2021 at 02:26)</a>:</h4>
<p>I realized that we could implement local value numbering today and filed an issue: <a href="https://github.com/rust-lang/rust/issues/91688">https://github.com/rust-lang/rust/issues/91688</a></p>



<a name="264248972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264248972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264248972">(Dec 09 2021 at 02:26)</a>:</h4>
<p>It doesn't need SSA unlike GVN</p>



<a name="264388828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264388828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264388828">(Dec 10 2021 at 00:44)</a>:</h4>
<p>So I've taken a stab at this and I'm quickly running into questions about what <code>&amp;</code> and <code>&amp;mut</code> are allowed to alias. Since the unsafe code guidelines aren't ready yet, I wonder what basic uncontroversial things I can do.</p>



<a name="264389062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264389062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264389062">(Dec 10 2021 at 00:47)</a>:</h4>
<p>Right now I'm just assuming that <code>&amp;</code> and <code>&amp;mut</code> are allowed to alias everything, even locals. Obviously this needs to be expanded in the future.</p>



<a name="264389136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264389136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264389136">(Dec 10 2021 at 00:48)</a>:</h4>
<p><code>&amp;mut</code> can only alias when stacked/reborrowed, no?</p>



<a name="264389936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264389936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264389936">(Dec 10 2021 at 00:59)</a>:</h4>
<p>hmm, well I guess NLL end can happen within a BB too</p>



<a name="264393551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264393551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264393551">(Dec 10 2021 at 01:46)</a>:</h4>
<p>Can we assume immutability behind <code>&amp;</code> modulo UnsafeCell? Combined with pointer provenance that could let us use LVN to eliminate redundant loads like a[i] where <code>a</code> is <code>&amp;[int]</code>, which is something LLVM cannot do as easily.</p>



<a name="264393571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264393571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264393571">(Dec 10 2021 at 01:46)</a>:</h4>
<p>BTW it's looking like LVN isn't that hard to implement. GVN is harder of course because we would need SSA.</p>



<a name="264398470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264398470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264398470">(Dec 10 2021 at 03:19)</a>:</h4>
<p>I think that's also a borrowck kind of question. If that's a continuous <code>a</code>, then yes it's immutable for <code>T: Freeze</code>.</p>



<a name="264398555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264398555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264398555">(Dec 10 2021 at 03:20)</a>:</h4>
<p>If LVN normalized two expressions to the same <code>a</code>, then you'd need to make sure there were no writes between.</p>



<a name="264421688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264421688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264421688">(Dec 10 2021 at 09:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="384014">Patrick Walton</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Local.20value.20numbering/near/264393551">said</a>:</p>
<blockquote>
<p>Can we assume immutability behind <code>&amp;</code> modulo UnsafeCell?</p>
</blockquote>
<p>Only one level deep without further analysis (see <code>&amp;&amp;AtomicU8</code>, for example), but yes.  You can probably re-use the same checking that <code>static</code>s use to know they can go in read-only memory.</p>



<a name="264435803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264435803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264435803">(Dec 10 2021 at 11:50)</a>:</h4>
<blockquote>
<p>You can probably re-use the same checking that statics use to know they can go in read-only memory.</p>
</blockquote>
<p>That is <code>ty.is_freeze(tcx.at(DUMMY_SP), ParamEnv::reveal_all())</code>: <a href="https://github.com/rust-lang/rust/blob/574d37568029f5c637557a87426ade54770d9a14/compiler/rustc_codegen_ssa/src/traits/type_.rs#L82">https://github.com/rust-lang/rust/blob/574d37568029f5c637557a87426ade54770d9a14/compiler/rustc_codegen_ssa/src/traits/type_.rs#L82</a></p>



<a name="264506520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264506520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264506520">(Dec 10 2021 at 20:53)</a>:</h4>
<p>I have a WIP at <a href="https://github.com/pcwalton/rust/tree/value-numbering">https://github.com/pcwalton/rust/tree/value-numbering</a></p>



<a name="264506625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264506625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264506625">(Dec 10 2021 at 20:54)</a>:</h4>
<p>It can do simple copy propagation, but causes ICEs sometimes right now because it doesn't rewrite StorageLive/StorageDead yet.</p>



<a name="264506662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264506662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264506662">(Dec 10 2021 at 20:54)</a>:</h4>
<p>Also it can do basic common subexpression elimination.</p>



<a name="264585457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264585457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264585457">(Dec 11 2021 at 21:21)</a>:</h4>
<p>I wish pointer provenance info were more accessible to <code>rustc_mir_transform</code> instead of being local to borrowck</p>



<a name="264917004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264917004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264917004">(Dec 14 2021 at 20:01)</a>:</h4>
<p>So it should be able to properly optimize <a href="https://rust.godbolt.org/z/7f6Gff7Ms">https://rust.godbolt.org/z/7f6Gff7Ms</a> once I implement a pass to promote needlessly-mutable locals to immutable.</p>



<a name="264917124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264917124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264917124">(Dec 14 2021 at 20:02)</a>:</h4>
<p>This is an optimization that LLVM cannot do.</p>



<a name="264923073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Local%20value%20numbering/near/264923073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Local.20value.20numbering.html#264923073">(Dec 14 2021 at 20:49)</a>:</h4>
<p>And it's working now, in a simple test :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>