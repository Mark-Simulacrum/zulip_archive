<html>
<head><meta charset="utf-8"><title>MaybeLiveLocals and Discriminants · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html">MaybeLiveLocals and Discriminants</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249276975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/249276975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> niluxv <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#249276975">(Aug 12 2021 at 18:54)</a>:</h4>
<p>While trying to write a mir dead assignment elimination based on live variable analysis I noticed that <code>MaybeLiveLocals</code> kills a local when it's discriminant is set. This surprised me somewhat (it made me delete "dead" assignments to fields of locals with discriminants, which weren't dead). Is this expected behaviour? And when the discriminant of a local is modified, need all fields of the local be set (immidiately) before the discriminant modification? (More generally is there documentation on requirements on mir to be valid?) And is there a fast way to check whether a local has a discriminant (e.g. without looking up the type)?</p>



<a name="250790025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/250790025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#250790025">(Aug 26 2021 at 15:24)</a>:</h4>
<p>Do you have example MIR?</p>



<a name="250982538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/250982538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#250982538">(Aug 27 2021 at 19:24)</a>:</h4>
<p>no for the last question, whether disciminant is present is a property of the type.</p>



<a name="250982837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/250982837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#250982837">(Aug 27 2021 at 19:27)</a>:</h4>
<p>MIR has no documented validity properties AFAIK. There are obviously correct constructions, obviously incorrect ones and those in between. We try to stay within the first category.</p>



<a name="250983297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/250983297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#250983297">(Aug 27 2021 at 19:30)</a>:</h4>
<p>It is complicated by the fact that what's considered obviously valid mir depends on its position in the pipeline.</p>



<a name="250983358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/250983358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#250983358">(Aug 27 2021 at 19:31)</a>:</h4>
<p>borrowck has certain needs that e.g. cg_llvm doesn't.</p>



<a name="255941936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255941936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255941936">(Oct 03 2021 at 10:34)</a>:</h4>
<p>Within block liveness results will be incorrect so that doesn't seem right. The only real user of MaybeLiveLocals is state transform, which is concerned with liveness at basic block boundaries, so is probably unaffected (in fact it might improve the precision of the analysis?). Still, seems very subtle if this behavior was intentional. Maybe <span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span>  will know, if it was?</p>



<a name="255968488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255968488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255968488">(Oct 03 2021 at 18:06)</a>:</h4>
<p>I can't speak to intent, since I (hopefully) just translated the existing liveness pass to fit within the framework, but the underlying problem is that <code>MaybeLiveLocals</code> is field-insensitive, so it doesn't differentiate between total writes and partial ones. Presumably this was all that the generator state transform needed (although I don't know for sure). This isn't called out explicitly in the <code>MaybeLiveLocals</code> docs, and it's a pretty big footgun. I suspect this is part of why <code>dest_prop</code>is currently unsound?</p>
<p>To do the kind of optimization the OP desires, you would need a field-sensitive version of variable liveness. Maybe that should just replace the field-insensitive one since the latter is prone to misuse?</p>



<a name="255968657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255968657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255968657">(Oct 03 2021 at 18:09)</a>:</h4>
<p>I don't think the generator state transform is hot, and it might benefit from a more careful treatment of live variables.</p>



<a name="255971350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255971350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255971350">(Oct 03 2021 at 18:53)</a>:</h4>
<p>As I understand, the question is essentially about this change <a href="https://github.com/rust-lang/rust/pull/73774/commits/558c8a8c3c7e7cdf83703a044f085e89d71680e8">https://github.com/rust-lang/rust/pull/73774/commits/558c8a8c3c7e7cdf83703a044f085e89d71680e8</a>. While analysis remains field-insensitive, it does make a distinction between partial and complete writes. In particular, SetDiscriminant has a Store context, which will translate into Def, and if there are no projections the SetDiscriminant statement will kill the whole local.</p>



<a name="255973703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255973703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255973703">(Oct 03 2021 at 19:28)</a>:</h4>
<p>Ah, okay. It's starting to come back to me now. Yes I think it's wrong to treat <code>SetDiscriminant</code> as a definition of a variable. I should have handled that in the PR you linked.</p>



<a name="255973748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255973748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255973748">(Oct 03 2021 at 19:29)</a>:</h4>
<p>Out of curiousity, what does the MIR look like when we assign to an <code>enum</code> typed local? Is it </p>
<div class="codehilite"><pre><span></span><code>SetDiscriminant(p, MyVariant);
(p as variant#MyVariant) = data;
</code></pre></div>
<p>or vice versa? Something else?</p>



<a name="255973864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255973864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255973864">(Oct 03 2021 at 19:31)</a>:</h4>
<p>If so, we won't give reasonable liveness info for enums without something more advanced, right?</p>



<a name="255973913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255973913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255973913">(Oct 03 2021 at 19:32)</a>:</h4>
<p>(It's been a while since I've had to think about MIR semantics)</p>



<a name="255974873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255974873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255974873">(Oct 03 2021 at 19:47)</a>:</h4>
<p>From the playground, it looks like:</p>
<div class="codehilite"><pre><span></span><code>        ((_3 as Some).0: i32) = const 4_i32;
        discriminant(_3) = 1;
</code></pre></div>



<a name="255975244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255975244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255975244">(Oct 03 2021 at 19:52)</a>:</h4>
<p>That means that the generator transform depends on <code>discriminant(_3) = 1</code> killing <code>_3</code> to handle enum-typed locals, right?</p>



<a name="255975294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255975294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255975294">(Oct 03 2021 at 19:53)</a>:</h4>
<p>So we'd need to provide some alternative. We can't just make the obviously correct change.</p>



<a name="255975351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255975351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255975351">(Oct 03 2021 at 19:54)</a>:</h4>
<p>Well, we could, but probably shouldn't, since generators would get bigger.</p>



<a name="255975381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255975381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255975381">(Oct 03 2021 at 19:55)</a>:</h4>
<p>Does all of this sound correct <span class="user-mention" data-user-id="352985">@tm</span>? Or did I mess something up?</p>



<a name="255977872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255977872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255977872">(Oct 03 2021 at 20:35)</a>:</h4>
<p>That sounds right. I would be quite curious to learn about practical significance of this, I don't really have an intuition how important providing an alternative would be.</p>



<a name="255978214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/255978214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#255978214">(Oct 03 2021 at 20:40)</a>:</h4>
<p>Yeah, it's clear to me that the current implementation of <code>MaybeLiveLocals</code> isn't suitable for doing the kind of dead store removal that the OP wanted. I don't even know that a field-sensitive live variables is tractable. Should  we just document the current behavior around <code>SetDiscriminant</code> and preserve the status quo?</p>



<a name="262708145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/262708145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> niluxv <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#262708145">(Nov 25 2021 at 13:56)</a>:</h4>
<p>Sorry for the long silence. Thanks everyone for the answers. <span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span> Yes, it would be great if the documentation reflected this somewhat non-obvious behaviour.<br>
<span class="user-mention" data-user-id="352985">@tm</span> I don't think it is very important. How to do these kinds of optimisations for enum types is very non-obvious anyway, it is just important to know that when using the <code>MaybeLiveLocals</code> analysis, types with discriminants must be ignored for optimisations.</p>



<a name="262709393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/262709393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> niluxv <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#262709393">(Nov 25 2021 at 14:06)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">borrowed_enum</span><span class="p">(</span><span class="n">x</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">yref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">yref</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>gives the mir given in the attached .dot file, which also shows the live variable analysis results. <a href="/user_uploads/4715/pYD7iZKyxibMo47LTs4tQh9q/mir_dataflow_lva_testing.borrowed_enum.-.liveness.-..dot">mir_dataflow_lva_testing.borrowed_enum.-.liveness.-..dot</a> <br>
On line 4 the discriminant of local <code>_2</code> is modified, which kills <code>_2</code> in the live variable analysis (therefore the assignment on line 3 becomes dead, but it is not actually dead).</p>



<a name="262863612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals%20and%20Discriminants/near/262863612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/MaybeLiveLocals.20and.20Discriminants.html#262863612">(Nov 27 2021 at 09:19)</a>:</h4>
<p><span class="user-mention" data-user-id="401145">@niluxv</span>: <span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> documented the current behaviour of  MaybeLiveLocals in <a href="https://github.com/rust-lang/rust/issues/89532">#89532</a>. Sorry about lack of followup on Zulip.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>