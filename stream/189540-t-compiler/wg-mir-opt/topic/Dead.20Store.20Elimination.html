<html>
<head><meta charset="utf-8"><title>Dead Store Elimination · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html">Dead Store Elimination</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="198596821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198596821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198596821">(May 24 2020 at 19:42)</a>:</h4>
<p>Do we have a pass that can eliminate stores that are never read? Const prop can leave a lot of those behind when it runs.</p>



<a name="198596901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198596901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198596901">(May 24 2020 at 19:45)</a>:</h4>
<p><code>SimplifyLocals</code> does a rather naive form of DSE</p>



<a name="198596971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198596971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198596971">(May 24 2020 at 19:47)</a>:</h4>
<p>Specifically it removes stores to locals where the local is never read, rather than where the stored value is never read.</p>



<a name="198597081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198597081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198597081">(May 24 2020 at 19:48)</a>:</h4>
<p>Ah I see, that should already help</p>



<a name="198601990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198601990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198601990">(May 24 2020 at 21:52)</a>:</h4>
<p>More robust DSE is one of the things I wanted to implement now that intrablock liveness is easy to compute.</p>



<a name="198602950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198602950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198602950">(May 24 2020 at 22:20)</a>:</h4>
<p>I think I'll work on that next week.</p>



<a name="198608305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/198608305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#198608305">(May 25 2020 at 01:14)</a>:</h4>
<p>Somewhat related, I'm working on being able to remove locals that are only used for debug info while still preserving the debug info data.</p>



<a name="204696357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/204696357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Vandel Sillesen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#204696357">(Jul 22 2020 at 17:24)</a>:</h4>
<p>Hi! I played around with the playground, looking for simple MIR optimizations. In this code <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2018&amp;gist=5e51319bc039ba93e4006ce775988439">https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2018&amp;gist=5e51319bc039ba93e4006ce775988439</a> "x" is const so no side effects and completely dead. It is however not removed. </p>
<p>I'm reviving this topic as that seems to be the "more robust DSE" being talked about. Any progress on that <span class="user-mention" data-user-id="118594">@ecstatic-morse</span> , <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> ? If not, I could be interested in giving a (simple) pass a shot. Would this fit inside SimplifyLocals, or should it be pulled out into a separate dead-code-elimination pass?</p>



<a name="204696784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/204696784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#204696784">(Jul 22 2020 at 17:27)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="139182">@Simon Vandel Sillesen</span>! I've actually got a PR up that's waiting to merge that resolves that <a href="https://github.com/rust-lang/rust/pull/73210">https://github.com/rust-lang/rust/pull/73210</a></p>



<a name="204696869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/204696869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#204696869">(Jul 22 2020 at 17:28)</a>:</h4>
<p>(The thing that's causing <code>x</code> to hang around is because it's being used by debuginfo)</p>



<a name="204714755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/204714755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Simon Vandel Sillesen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#204714755">(Jul 22 2020 at 19:57)</a>:</h4>
<p>Alright, that sounds good!</p>



<a name="204714945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/204714945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#204714945">(Jul 22 2020 at 19:59)</a>:</h4>
<p>If you're looking for an optimization to work on, I think <span class="user-mention" data-user-id="124288">@oli</span>  has some "beginner" ones in mind <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="261892568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/261892568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#261892568">(Nov 18 2021 at 07:00)</a>:</h4>
<p><span class="user-mention" data-user-id="118594">@Dylan MacKenzie (ecstatic-morse)</span> and I were discussing Dead Store Elimination w.r.t. drop flags today, here:<br>
<a href="#narrow/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations/near/261882149">https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/MIR.20and.20LLVM.20IR.20observations/near/261882149</a><br>
and here: <a href="#narrow/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination">https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/Drop.20flags.20and.20dead.20store.20elimination</a></p>
<p>I might try to implement this tomorrow. I'm happy to hear any advice, pitfalls, pointers to prior work, reasons why I shouldn't do it, etc. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="262028093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262028093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262028093">(Nov 19 2021 at 05:12)</a>:</h4>
<p>I'm puzzled by step 2 in <a href="https://rustc-dev-guide.rust-lang.org/mir/optimizations.html">https://rustc-dev-guide.rust-lang.org/mir/optimizations.html</a>. How can I generate the MIR dump for a new optimization before I've implemented the optimization?</p>



<a name="262028484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262028484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262028484">(Nov 19 2021 at 05:20)</a>:</h4>
<p>I'm also not sure if I want a .diff or a .after.mir or a .before.mir</p>



<a name="262028703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262028703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262028703">(Nov 19 2021 at 05:25)</a>:</h4>
<p>I've used <code>// EMIT_MIR dse.main.DeduplicateBlocks.after.mir</code> just to get something going. But the output I get in <code>dse.main.DeduplicateBlocks.after.mir</code> after running <code>./x.py test --bless src/test/mir-opt/dse.rs</code> isn't the same as the output in <code>mir_dump/dse.main.005-022.DeduplicateBlocks.after.mir</code> after running <code>rustc dse.rs -Zdump-mir=all</code>.</p>



<a name="262028789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262028789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262028789">(Nov 19 2021 at 05:27)</a>:</h4>
<p>Oh, if I use `rustc -O <a href="http://dse.rs">dse.rs</a> -Zdump-mir=all" I get output that matches</p>



<a name="262028847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262028847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262028847">(Nov 19 2021 at 05:28)</a>:</h4>
<p>Huh, weird, with <code>-O</code> I get MIR that looks less optimized</p>



<a name="262029103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262029103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262029103">(Nov 19 2021 at 05:33)</a>:</h4>
<p>Oh, the difference is the presence/absence of <code>StorageLive</code> in my basic block of interest. Looks like <code>emit_lifetime_markers</code> says they should remain in optimized builds</p>



<a name="262029172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262029172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262029172">(Nov 19 2021 at 05:34)</a>:</h4>
<p>So now I'm puzzled by the mir testing: if optimized builds and debug builds produce different MIR, how do the tests work with both kinds of builds?</p>



<a name="262029851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262029851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262029851">(Nov 19 2021 at 05:47)</a>:</h4>
<p>Back to my first question: if I implement the new optimization as a no-op to start with, then it makes more sense to generate an initial .diff (or .after.mir) file.</p>



<a name="262030152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262030152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262030152">(Nov 19 2021 at 05:53)</a>:</h4>
<p>I've not followed those instructions. I just implement the transform (based on what I see in dump-mir) and then emit a diff.</p>



<a name="262030164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262030164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262030164">(Nov 19 2021 at 05:54)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> did you write <a href="https://rustc-dev-guide.rust-lang.org/mir/optimizations.html">https://rustc-dev-guide.rust-lang.org/mir/optimizations.html</a>?</p>



<a name="262030242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262030242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262030242">(Nov 19 2021 at 05:55)</a>:</h4>
<p>Does that predate first class diffs in Mir opt Tests or something?</p>



<a name="262058469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262058469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262058469">(Nov 19 2021 at 12:11)</a>:</h4>
<p>yea, diffs came a bit later</p>



<a name="262261599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262261599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262261599">(Nov 21 2021 at 21:27)</a>:</h4>
<p>I'm still wondering about this:</p>
<blockquote>
<p>if optimized builds and debug builds produce different MIR, how do the tests work with both kinds of builds?</p>
</blockquote>



<a name="262261993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262261993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262261993">(Nov 21 2021 at 21:37)</a>:</h4>
<p>compiletest typically passes -Copt-level=3, IIRC</p>



<a name="262262005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262262005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262262005">(Nov 21 2021 at 21:37)</a>:</h4>
<p>er, looks like =1 actually</p>



<a name="262262052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262262052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262262052">(Nov 21 2021 at 21:38)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/65f3f8b220f020e562c5dd848ff7319257a7ba45/src/tools/compiletest/src/runtest.rs#L1820">https://github.com/rust-lang/rust/blob/65f3f8b220f020e562c5dd848ff7319257a7ba45/src/tools/compiletest/src/runtest.rs#L1820</a></p>



<a name="262262739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262262739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262262739">(Nov 21 2021 at 21:55)</a>:</h4>
<p>But also <code>Zmir-opt-level=4</code>, <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> , thanks</p>



<a name="262283805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262283805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262283805">(Nov 22 2021 at 06:37)</a>:</h4>
<p>I have finished a draft of the Dead Store Elimination pass.</p>
<p>The good news is that it works! It eliminates the unnecessary drop flags, and passes tests.</p>
<p>The bad news is that it has very little effect on compilation speed. On a couple of big example I looked at (e.g. webrender) <code>cargo llvm-lines</code> says the number of lines dropped by 0.1-0.3%, and a local benchmarking run of opt builds showed negligible changes.</p>



<a name="262286479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262286479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262286479">(Nov 22 2021 at 07:29)</a>:</h4>
<p>Did</p>



<a name="262297142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262297142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262297142">(Nov 22 2021 at 09:41)</a>:</h4>
<p>(I didn't notice I had sent an unfinished message earlier)</p>



<a name="262317149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262317149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian Wielgosik <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262317149">(Nov 22 2021 at 13:19)</a>:</h4>
<blockquote>
<p>The bad news is that it has very little effect on compilation speed</p>
</blockquote>
<p>I'm guessing it's because these are cleaned up extremely early in LLVM, like in first SROA?</p>



<a name="262381064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262381064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262381064">(Nov 22 2021 at 21:38)</a>:</h4>
<blockquote>
<p>Did you implement the simplified boolean only intra-block version you mentioned in another thread?</p>
</blockquote>
<p>It is intra-block and constants of all types, though in practice I've only seen it have an effect on booleans.</p>



<a name="262381196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262381196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262381196">(Nov 22 2021 at 21:39)</a>:</h4>
<blockquote>
<p>I'm guessing it's because these are cleaned up extremely early in LLVM, like in first SROA?</p>
</blockquote>
<p>I think it's more just that there aren't that many of these dead stores. Eliminating them only reduced the amount of LLVM IR by 0.1-0.3% in the programs I looked at. So if LLVM compile time is proportional to code size (probably a reasonable assumption for rough calculations?) the potential for improvement is just very small.</p>



<a name="262384402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262384402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262384402">(Nov 22 2021 at 22:08)</a>:</h4>
<p>On the intra-BB vs inter-BB front: I was just looking at the MIR some more, and it looks like some inter-BB analysis could do better.</p>



<a name="262384483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262384483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262384483">(Nov 22 2021 at 22:09)</a>:</h4>
<p>E.g. I see <code>_202 = const false;</code> in five different BBs, and then this:</p>
<div class="codehilite"><pre><span></span><code>    bb127 (cleanup): {
        switchInt(_202) -&gt; [false: bb109, otherwise: bb126]; // scope 3 at counts.rs:22:5: 22:6
    }
</code></pre></div>



<a name="262384610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262384610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262384610">(Nov 22 2021 at 22:10)</a>:</h4>
<p>I see that same pattern with quite a few drop flags</p>



<a name="262384716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262384716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262384716">(Nov 22 2021 at 22:11)</a>:</h4>
<p>So <code>bb126</code> is dead in this case</p>



<a name="262384787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262384787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262384787">(Nov 22 2021 at 22:12)</a>:</h4>
<p>Which means that <code>bb127</code> is useless</p>



<a name="262385684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262385684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262385684">(Nov 22 2021 at 22:19)</a>:</h4>
<p>Oh, interesting; my intra-bb DSE is making it more obvious that some of these drop flags are useless. E.g. there was a <code>_202 = const true</code> in the code that my DSE removed. After that, all the assignments are <code>_202 = const false</code>.</p>



<a name="262385731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262385731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262385731">(Nov 22 2021 at 22:19)</a>:</h4>
<p>So I think I can now do a very simple pass looking for <code>bool</code>s that are only ever assigned as false, to identify useless drop flags.</p>



<a name="262385750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262385750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262385750">(Nov 22 2021 at 22:20)</a>:</h4>
<p>And then I can get rid of some <code>switchInt</code>s and some BBs, perhaps</p>



<a name="262386216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262386216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262386216">(Nov 22 2021 at 22:24)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> could you post the example where the drop flags were useless? I'm surprised that drop elaboration would emit them in the first place.</p>



<a name="262386520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262386520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262386520">(Nov 22 2021 at 22:27)</a>:</h4>
<p><code>_199</code>, <code>_200</code>, <code>_201</code>, and <code>_202</code> are all useless:</p>
<p><a href="/user_uploads/4715/7yiVg-T1iOAXwaa3uVKyEs8U/counts.mir">counts.mir</a></p>



<a name="262386601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262386601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262386601">(Nov 22 2021 at 22:28)</a>:</h4>
<p>In each case, there is one BB where the drop flag is assigned true and then shortly after assigned false. All other assignments are false.</p>



<a name="262386744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262386744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262386744">(Nov 22 2021 at 22:29)</a>:</h4>
<p>Here's the Rust code:</p>
<p><a href="/user_uploads/4715/F6hAmdNA_rwtuf7_VcPDqRnq/counts.rs">counts.rs</a></p>



<a name="262386763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262386763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262386763">(Nov 22 2021 at 22:30)</a>:</h4>
<p>I'm compiling with <code>rustc counts.rs --emit=mir</code></p>



<a name="262386864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262386864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262386864">(Nov 22 2021 at 22:30)</a>:</h4>
<p>It may well be that "make drop flag insertion smarter" is the right path forward here, rather than cleaning up the mess afterwards</p>



<a name="262387227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262387227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262387227">(Nov 22 2021 at 22:34)</a>:</h4>
<p>Thanks! I'm on my phone now but I'll investigate it later. Part of the core function of drop elaboration is to eliminate useless drops, so it shouldn't be doing that. I expected to be outputting some useless stores to drop flags (since tracking that while doing everything else is hard, but cleaning up later is easy)</p>



<a name="262387400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262387400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262387400">(Nov 22 2021 at 22:35)</a>:</h4>
<p>Ok, thanks. It wasn't quite as obvious that these drops were useless before I did my DSE pass, which eliminated the <code>true</code> assignments.</p>



<a name="262388124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262388124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262388124">(Nov 22 2021 at 22:43)</a>:</h4>
<p>Well the theory behind drop elaboration is that if a variable is known to be moved from (or known not to be moved from) along all possible code paths, we won't emit any drop flags at all. It could be that there's some optimization in between drop elaboration and your DSE pass that makes this true, or there might be some imprecision in drop elaboration.</p>



<a name="262393440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262393440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262393440">(Nov 22 2021 at 23:43)</a>:</h4>
<p>Looks like the former. I just looked at <code>mir_dump/counts.do_main.003-005.ElaborateDrops.after.mir</code> (where the drop flags are named <code>_255</code>..<code>_260</code>) and things look very different there. All the drop flags are set to <code>true</code> in some BBs and <code>false</code> in others and there are no BBs where a single drop flag is set twice.</p>



<a name="262394705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262394705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262394705">(Nov 22 2021 at 23:57)</a>:</h4>
<p>Where is your DSE pass in the optimization pipeline currently?</p>



<a name="262397752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262397752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262397752">(Nov 23 2021 at 00:33)</a>:</h4>
<p>Right at the end, after DeduplicateBlocks</p>



<a name="262502791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262502791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262502791">(Nov 23 2021 at 19:35)</a>:</h4>
<blockquote>
<p>All the drop flags are set to true in some BBs and false in others and there are no BBs where a single drop flag is set twice</p>
</blockquote>
<p>Looking again, I was wrong about that. Still, things do look quite different immediately after <code>ElaborateDrops</code>.</p>



<a name="262506856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262506856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262506856">(Nov 23 2021 at 20:08)</a>:</h4>
<p>Ah, I see <code>SimplifyCfg</code> runs multiple times. The <code>003-010.SimplifyCfg-elaborate-drops</code> run is important for my test code. After that runs is when we see some BBs that assign multiple times to the same drop flag. So I think I could run the DSE any time after that. Doing it before the final <code>SimplifyCfg</code> pass might work well.</p>



<a name="262528654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262528654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262528654">(Nov 23 2021 at 23:25)</a>:</h4>
<p>Is there an easy way to ask "is this MIR operation a <code>_var = const true</code> or <code>_var = const false</code>? I'm finding the MIR types surprisingly deeply nested and hard to navigate</p>



<a name="262528759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262528759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262528759">(Nov 23 2021 at 23:26)</a>:</h4>
<p>ATM I have this and it's still not specific enough</p>
<div class="codehilite"><pre><span></span><code>if let Rvalue::Use(Operand::Constant(box Constant { literal: ConstantKind::Ty(..), .. })) = rval
</code></pre></div>



<a name="262529752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262529752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262529752">(Nov 23 2021 at 23:40)</a>:</h4>
<p>Here's what I ended up with:</p>
<div class="codehilite"><pre><span></span><code>    fn visit_assign(&amp;mut self, place: &amp;Place&lt;&#39;tcx&gt;, rval: &amp;Rvalue&lt;&#39;tcx&gt;, _loc: Location) {
        // njn: currently restricting to constants, could be more expansive
        if place.projection.is_empty() {
            if let Rvalue::Use(Operand::Constant(box Constant { literal: ConstantKind::Ty(ty::Const { val: ty::ConstKind::Value(ConstValue::Scalar(Scalar::Int
(scalar_int))), .. }), .. })) = rval {
                match scalar_int {
                    &amp;ScalarInt::FALSE =&gt; eprintln!(&quot;FALSE&quot;),
                    &amp;ScalarInt::TRUE =&gt; eprintln!(&quot;TRUE&quot;),
                    _ =&gt; eprintln!(&quot;OTHER&quot;),
                }
            }
        }
        eprintln!(&quot;  {:?} = {:?}&quot;, place.local, rval);
    }
</code></pre></div>



<a name="262529768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262529768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262529768">(Nov 23 2021 at 23:40)</a>:</h4>
<p>It works, but seems very clunky.</p>



<a name="262529774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262529774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262529774">(Nov 23 2021 at 23:40)</a>:</h4>
<p>(deleted)</p>



<a name="262547556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262547556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262547556">(Nov 24 2021 at 05:16)</a>:</h4>
<p>Ok, I have a draft of this pass working. It successfully removes the drop flags that are always <code>false</code> and changes the <code>switchInt</code>s on these flags to <code>goto</code> statements. I also moved it just after <code>RemoveNoopLandingPads</code>, which means that <code>SimplifyCfg</code> runs after it and removes the basic blocks that end up containing just a single <code>goto</code>, and <code>SimplifyLocals</code> also runs after it and removes the dead locals. It passes tests.</p>



<a name="262547577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262547577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262547577">(Nov 24 2021 at 05:17)</a>:</h4>
<p>Although it does more than before, the bad news is that the MIR reduction is still small enough (less than 1%) that it doesn't have a meaningful effect on performance <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="262623299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262623299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262623299">(Nov 24 2021 at 18:11)</a>:</h4>
<p>Is that true in both debug and release?</p>



<a name="262625046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262625046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262625046">(Nov 24 2021 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Dead.20Store.20Elimination/near/262547556">said</a>:</p>
<blockquote>
<p>Ok, I have a draft of this pass working. It successfully removes the drop flags that are always <code>false</code> and changes the <code>switchInt</code>s on these flags to <code>goto</code> statements. I also moved it just after <code>RemoveNoopLandingPads</code>, which means that <code>SimplifyCfg</code> runs after it and removes the basic blocks that end up containing just a single <code>goto</code>, and <code>SimplifyLocals</code> also runs after it and removes the dead locals. It passes tests.</p>
</blockquote>
<p>Const propagation should do some of this already, although it's intra-block only IIRC. That might be part of why you're not seeing the changes you hoped for.</p>



<a name="262641237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262641237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262641237">(Nov 24 2021 at 21:15)</a>:</h4>
<blockquote>
<p>Is that true in both debug and release?</p>
</blockquote>
<p>Yes. MIR reduction seems slightly higher in debug.</p>



<a name="262641351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Dead%20Store%20Elimination/near/262641351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Dead.20Store.20Elimination.html#262641351">(Nov 24 2021 at 21:17)</a>:</h4>
<blockquote>
<p>Const propagation should do some of this already, although it's intra-block only IIRC. That might be part of why you're not seeing the changes you hoped for.</p>
</blockquote>
<p>It runs before my new pass. My new pass does exactly what I expected it to, it's just the effect is smaller overall than I'd hoped.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>