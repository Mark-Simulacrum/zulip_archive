<html>
<head><meta charset="utf-8"><title>Array indexing in mir opt tests · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html">Array indexing in mir opt tests</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272318513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272318513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272318513">(Feb 17 2022 at 20:30)</a>:</h4>
<p>I'm writing MIR opt tests, and I'd like to get an index into an array into the same basic block as some other code. Specifically, I want a place where the projection consists of just a single <code>Index</code>. Is there a way to get this kind of MIR to be emitted? I'd considered asking the test runner to run const prop + branch simplification first, but writing tests that aren't out by that is a little annoying.</p>



<a name="272318892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272318892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272318892">(Feb 17 2022 at 20:34)</a>:</h4>
<p>Oh nevermind, I got it, what I was doing before worked with only little modification</p>



<a name="272394570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272394570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272394570">(Feb 18 2022 at 12:20)</a>:</h4>
<p>Follow up question now: I've written my optimization, and it passes <code>src/test/ui</code> and the MIR opt tests I've written. Unfortunately, it breaks a bunch of other MIR opt tests by optimizing the test out. Is there some way to ask the mir opt test suite to not run a particular pass for some tests? I could modify the actual test code to try and prevent my optimization from kicking in, but that seems both error prone and not very future proof</p>



<a name="272396692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272396692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272396692">(Feb 18 2022 at 12:42)</a>:</h4>
<p>Is your opt essentially replacing the other opts? Should we remove them?</p>



<a name="272397081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272397081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272397081">(Feb 18 2022 at 12:47)</a>:</h4>
<p>Not replacing. My opt is doing some basic dead store elimination, restricted to within a single basic block. This affects all the opt tests that just write things to locals and never use them again</p>



<a name="272397214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272397214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272397214">(Feb 18 2022 at 12:48)</a>:</h4>
<p>For example, many of the simplify locals tests are just completely removed by this, although because that pass can do reasoning across bbs its definitely not replaced</p>



<a name="272397844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272397844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272397844">(Feb 18 2022 at 12:55)</a>:</h4>
<p>Is adding a <code>-Z run-pass=PassName</code> the right thing to do here? This might be a good thing to have for the mir opt test suite, but I'm a little unsure of how to implement it because there isn't a clear distinction between mandatory and optional passes</p>



<a name="272398227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272398227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272398227">(Feb 18 2022 at 12:59)</a>:</h4>
<p>For example, my tests would also benefit from not having const prop run, but there's a comment above that pass that says that it's at least some level of necessary. Not sure if it could safely be disabled for mir opt tests that don't want to deal with it</p>



<a name="272398834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272398834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272398834">(Feb 18 2022 at 13:05)</a>:</h4>
<p>Disabling passes is not really possible, no. There is desire to write a pass manager that can do that, but we didn't get to it yet</p>



<a name="272399387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272399387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272399387">(Feb 18 2022 at 13:10)</a>:</h4>
<p>Hm, ok. In the meantime I guess I'm gonna put in some <code>core::hint::black_box(());</code>s to break up bbs</p>



<a name="272405949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272405949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272405949">(Feb 18 2022 at 14:11)</a>:</h4>
<p>I've filed <a href="https://github.com/rust-lang/rust/issues/94118">#94118</a> , and was able to fix all but one of the tests. I'll wait for review to give feedback on what to do about the last one</p>



<a name="272446167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Array%20indexing%20in%20mir%20opt%20tests/near/272446167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Array.20indexing.20in.20mir.20opt.20tests.html#272446167">(Feb 18 2022 at 19:29)</a>:</h4>
<p>Last I hit this I ended up adding a bunch of </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline(never)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">unknown</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"> </span><span class="fm">unimplemented!</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>to fix all the <code>if true</code> tests by changing them to <code>if unknown()</code>, though that PR never got checked in.</p>
<p><a href="https://github.com/rust-lang/rust/pull/91222/files#diff-b168614f658f0442c56097971389891a9f6bde7baaa0d09e3c38d4c276aa0121R12">https://github.com/rust-lang/rust/pull/91222/files#diff-b168614f658f0442c56097971389891a9f6bde7baaa0d09e3c38d4c276aa0121R12</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>