<html>
<head><meta charset="utf-8"><title>Meaning of MIR Opt Levels · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html">Meaning of MIR Opt Levels</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276709208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276709208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276709208">(Mar 26 2022 at 06:27)</a>:</h4>
<p><a href="https://github.com/rust-lang/compiler-team/issues/319">This MCP</a> lists the highest possible MIR opt level as level 3. <code>rustc_mir_transform</code> currently contains 7 passes that run only on MIR opt level 4 - this is also what compiletest enables. Has the meaning of the MIR opt levels changed, and is the MCP out of date? How does opt level 4 distinguish itself from the <code>-Zunsound-mir-opts</code> flag?</p>



<a name="276710276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276710276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276710276">(Mar 26 2022 at 06:56)</a>:</h4>
<p>We introduced a new level between 1 and 2 for when optimizations are enabled. Old: 0 no opt, 1 default, 2 more opt, 3 all opt. New: 0 no opt, 1 debug mode default, 2 release mode default, 3 more opt, 4 all opt.</p>



<a name="276710300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276710300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276710300">(Mar 26 2022 at 06:57)</a>:</h4>
<p>-Zunsound-mir-opts is for broken optimizations. Opt level 4 is for slow optimizations and maybe also those that break debuginfo.</p>



<a name="276746267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746267">(Mar 26 2022 at 21:16)</a>:</h4>
<p>So I don't find it very useful to think in terms of "amount" of opts - what is the selection criteria for opt level 3 vs 4 right now?</p>



<a name="276746371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746371">(Mar 26 2022 at 21:19)</a>:</h4>
<p>Maybe mir-level-4 is "never run this on stable"?</p>



<a name="276746434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746434">(Mar 26 2022 at 21:20)</a>:</h4>
<p>But for what reason? It seems that the obvious reasons are "it's slow to run" which is covered by 3 and "it's unsound" which is covered by the unsound opts flag</p>



<a name="276746449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746449">(Mar 26 2022 at 21:21)</a>:</h4>
<p>Oh, hmm, there's an "it's not an optimization but a pessimization" reason</p>



<a name="276746455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746455">(Mar 26 2022 at 21:21)</a>:</h4>
<p>If that's the one that is represented by level 4 though, that should really be documented somewhere</p>



<a name="276746606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746606">(Mar 26 2022 at 21:25)</a>:</h4>
<p>Uh... afaicr level 4 is for new opts that we still need to figure out where to place and whether they are fine. Basically what the MCP wanted under a special experimental flag</p>



<a name="276746669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746669">(Mar 26 2022 at 21:26)</a>:</h4>
<p>2 and 3 are allowed to mess with debug info, but we really try to avoid breaking debug info for any opts</p>



<a name="276746743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746743">(Mar 26 2022 at 21:28)</a>:</h4>
<p>Ah, I see. "Don't know" is a good option too. So opt level 3 includes MIR opts that are either slow to run or pessimize code?</p>



<a name="276746784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746784">(Mar 26 2022 at 21:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels/near/276746606">said</a>:</p>
<blockquote>
<p>Uh... afaicr level 4 is for new opts that we still need to figure out where to place and whether they are fine. Basically what the MCP wanted under a special experimental flag</p>
</blockquote>
<p>Hmm, actually, shouldn't opts that we're not confident are fine go into the unsound MIR opts bucket until we know otherwise?</p>



<a name="276746975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746975">(Mar 26 2022 at 21:32)</a>:</h4>
<p>Weeeelll... you can't change the mir opt level on stable... so it's nightly only, and we want ppl to actually try them out. The unsound bucket is for when we know it's unsound</p>



<a name="276746986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746986">(Mar 26 2022 at 21:33)</a>:</h4>
<p>Do we actually have any pessimization opts?</p>



<a name="276746993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276746993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276746993">(Mar 26 2022 at 21:33)</a>:</h4>
<p>If we had I feel like they'd deserve a separate flag</p>



<a name="276747547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276747547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276747547">(Mar 26 2022 at 21:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels/near/276746975">said</a>:</p>
<blockquote>
<p>Weeeelll... you can't change the mir opt level on stable... so it's nightly only, and we want ppl to actually try them out. The unsound bucket is for when we know it's unsound</p>
</blockquote>
<p>Hmm, ok, fair. So summarizing from the perspective of a rustc contributor: <code>-Zunsound-mir-opts</code> is for opts that we either know are unsound or at least have a semi-specific reason to believe are unsound. Then, opt levels are:</p>
<ul>
<li>0: Only "mandatory" passes, ie passes that will cause ICEs later on in rustc if they don't run</li>
<li>1: Only opts that have no negative impact on debugability</li>
<li>2: Opts that may have a negative impact on debugability and do not fall into either of the next two categories</li>
<li>3: Opts that may be slow to execute but would otherwise belong in 2</li>
<li>4: Opts that either a) break debug info in unacceptable ways or b) we are less confident are sound, although they have passed code review and we have not identified a specific reason for concern</li>
</ul>



<a name="276747709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276747709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276747709">(Mar 26 2022 at 21:50)</a>:</h4>
<p>the classic opt-level 2/3 difference of "3 might pessimize binary size" might apply too -- like an aggressive MIR unroller might want to be level 3 even if it runs quickly?</p>



<a name="276747794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276747794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276747794">(Mar 26 2022 at 21:52)</a>:</h4>
<p>That sounds reasonable, edited</p>



<a name="276747919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276747919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276747919">(Mar 26 2022 at 21:55)</a>:</h4>
<p>Yeah, so it sounds like opt level 4 can be summed up with "opts that are broken, or potentially broken, but not in a way that is unsound." ie something that <em>hugely</em> pessimizes binary size (maybe it starts monomorphizing lifetimes or something) would go in there too</p>



<a name="276803733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276803733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276803733">(Mar 27 2022 at 19:31)</a>:</h4>
<p>What would be the best place to document this? Should it go in the rustc dev guide?</p>



<a name="276878716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276878716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276878716">(Mar 28 2022 at 14:11)</a>:</h4>
<p>The rustc dev guide already has a section on MIR opts IIRC so that would be the best place.</p>



<a name="276954340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276954340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emanuel Lima <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276954340">(Mar 29 2022 at 03:31)</a>:</h4>
<p>Sorry for the noob question, but where do I see which MIR pass belong to which opt level?</p>



<a name="276955334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276955334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276955334">(Mar 29 2022 at 03:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="262681">Emanuel Lima</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels/near/276954340">said</a>:</p>
<blockquote>
<p>Sorry for the noob question, but where do I see which MIR pass belong to which opt level?</p>
</blockquote>
<p>MIR passes usually define a <code>is_enabled</code> function that the pass manager uses to decide if they should run or not. For example <a href="https://github.com/rust-lang/rust/blob/ad5b6f6b72091261ac421d1331b2350f628d1fcb/compiler/rustc_mir_transform/src/dest_prop.rs#L120-L126">here</a>. This is a function on the <code>MirPass</code> trait, and it has a default impl that always returns true, meaning that if no such function is defined they run on all opt levels</p>



<a name="276955472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276955472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276955472">(Mar 29 2022 at 03:58)</a>:</h4>
<p>Btw, this is also where they check for the <code>-Zunsound-mir-opts</code> flag if they only run with the flag turned on</p>



<a name="276955486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276955486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emanuel Lima <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276955486">(Mar 29 2022 at 03:58)</a>:</h4>
<p>Right, but there is no documentation on which passes are present for a given level?</p>



<a name="276955516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Meaning%20of%20MIR%20Opt%20Levels/near/276955516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Meaning.20of.20MIR.20Opt.20Levels.html#276955516">(Mar 29 2022 at 03:59)</a>:</h4>
<p>Not as far as I know, no</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>