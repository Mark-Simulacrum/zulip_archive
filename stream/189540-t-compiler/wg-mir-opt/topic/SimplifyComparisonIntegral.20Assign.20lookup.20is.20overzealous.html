<html>
<head><meta charset="utf-8"><title>SimplifyComparisonIntegral Assign lookup is overzealous · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html">SimplifyComparisonIntegral Assign lookup is overzealous</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262840499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/262840499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#262840499">(Nov 26 2021 at 22:55)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/6d246f0c8d3063fea86abbb65a824362709541ba/compiler/rustc_mir_transform/src/simplify_comparison_integral.rs#L162-L192">https://github.com/rust-lang/rust/blob/6d246f0c8d3063fea86abbb65a824362709541ba/compiler/rustc_mir_transform/src/simplify_comparison_integral.rs#L162-L192</a></p>
<p>This code iterates on the basic block's statements in reverse order to find <code>_3 = Eq(_4, const 1)</code>, but it doesn't stop at the first occurrence of <code>_3 = …</code> and instead continues the lookup until it finds <code>_3 = Eq(…, const …)</code>.</p>
<p>Doesn't that mean that if <code>_3</code> is shadowed, then the pass will miscompile?</p>



<a name="262840577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/262840577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#262840577">(Nov 26 2021 at 22:57)</a>:</h4>
<p>It's trivial to fix, just want to doublecheck that my reading of the code was correct first, and to know if there is a way to write a test for that. My understanding is that the compiler won't produce such MIR anyway when compiling Rust code.</p>



<a name="262873266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/262873266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#262873266">(Nov 27 2021 at 13:28)</a>:</h4>
<p>Also, if <code>_4</code> is modified between the <code>Eq</code> and the <code>SwitchInt</code> terminator, that pass will misbehave again, right?</p>



<a name="263111094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263111094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263111094">(Nov 30 2021 at 08:03)</a>:</h4>
<p>Using <code>if</code> results in MIR always copying the source place, whereas <code>match</code> can be used to achieve miscompilation.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">i</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">no</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">is_the_answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">is_the_answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">is_the_answer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kc">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>-O -Z mir-opt-level=0</code> gives:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code>        <span class="nf">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
        <span class="nf">ret</span>
</code></pre></div>
<p>whereas <code>-O -Z mir-opt-level=1</code> gives:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code>        <span class="nf">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
        <span class="nf">cmp</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">42</span>
        <span class="nf">cmove</span>   <span class="no">eax</span><span class="p">,</span> <span class="no">edi</span>
        <span class="nf">ret</span>
</code></pre></div>



<a name="263114092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263114092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263114092">(Nov 30 2021 at 08:44)</a>:</h4>
<p>Thanks for the help <span class="user-mention" data-user-id="361356">@fee1-dead</span>! Will make a PR today.</p>



<a name="263150332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263150332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263150332">(Nov 30 2021 at 14:15)</a>:</h4>
<p>This showcases the "looking for <code>_3 = Eq(…)</code> too far" part, but what about my second question, about <code>_4</code> being modified between the <code>Eq</code> and the <code>SwitchInt</code>?</p>



<a name="263151019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263151019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263151019">(Nov 30 2021 at 14:20)</a>:</h4>
<p>Also, even if <code>_4</code> isn't modified, what happens if <code>_3</code> is actually used in a different block?</p>



<a name="263264809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263264809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263264809">(Dec 01 2021 at 09:43)</a>:</h4>
<p>the problem with _4 is that it is always copying, which I cannot seem to eliminate in the source code.</p>



<a name="263269175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263269175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263269175">(Dec 01 2021 at 10:24)</a>:</h4>
<p>So I'm probably right but there is no known way to trigger that misbehaviour from Rust code input, is that it?</p>



<a name="263275369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263275369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263275369">(Dec 01 2021 at 11:20)</a>:</h4>
<p>I don't think that's a sufficient condition for optimization soundness</p>



<a name="263275443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263275443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263275443">(Dec 01 2021 at 11:21)</a>:</h4>
<p>it should not cause miscompilation for <em>any</em> valid MIR, not just the ones that happened to get generated by the current frontend. A future optimization could change the input to this one and cause a miscompilation</p>



<a name="263279949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263279949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263279949">(Dec 01 2021 at 12:09)</a>:</h4>
<p>I 100% agree with that sentiment, but I don't know if there is infra to test that a MIR pass compiles stuff correctly with handcrafted MIR input</p>



<a name="263280220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280220">(Dec 01 2021 at 12:12)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> the reality is that today any valid MIR is a set exactly matching MIR generated by rustc for any valid Rust code.</p>



<a name="263280258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280258">(Dec 01 2021 at 12:13)</a>:</h4>
<p>MIR does not have its own specification and I'm not seeing one such materializing anytime soon.</p>



<a name="263280279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280279">(Dec 01 2021 at 12:13)</a>:</h4>
<p>well that's not exactly true though, various MIR optimizations transform the code in a significant manner</p>



<a name="263280292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280292">(Dec 01 2021 at 12:13)</a>:</h4>
<p>(which in some ways is a good indication that MIR optimizations aren't really operating in a well defined space)</p>



<a name="263280363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280363">(Dec 01 2021 at 12:14)</a>:</h4>
<p>and while there isn't a specification yet (though that's what Ferrocene is meant to be i believe)</p>



<a name="263280366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280366">(Dec 01 2021 at 12:14)</a>:</h4>
<p>Yeah, SimplifyComparisonIntegral doesn't describe how it expects the code to look like, so anyone can change another pass and produce code that breaks that pass' invariants and cause a miscompile, right?</p>



<a name="263280414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280414">(Dec 01 2021 at 12:14)</a>:</h4>
<p>I think we should make a best effort attempt at preserving 'semantics' of mir</p>



<a name="263280575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280575">(Dec 01 2021 at 12:16)</a>:</h4>
<p>and there are some various simple properties we should guarantee of MIR, even today like: MIR should be well-typed and should borrow check</p>



<a name="263280830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280830">(Dec 01 2021 at 12:19)</a>:</h4>
<p>Well, here's another thing, MIR doesn't always mean the same thing across the compilation pipeline ^^</p>



<a name="263280856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280856">(Dec 01 2021 at 12:19)</a>:</h4>
<p>by “borrow check” I assume you mean the non-lexical borrow check analysis that we run on early MIR.</p>



<a name="263280945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263280945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263280945">(Dec 01 2021 at 12:20)</a>:</h4>
<p>MIR is not suitable for that analysis after drop elaboration/borrowck runs to the best of my knowledge.</p>



<a name="263281251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281251">(Dec 01 2021 at 12:23)</a>:</h4>
<p>Which in some ways might warrant giving it a different name. There were some suggestions for introducing a LIR in the past.</p>



<a name="263281568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281568">(Dec 01 2021 at 12:26)</a>:</h4>
<p>whether the analysis as implemented breaks for technical reasons is one thing</p>



<a name="263281588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281588">(Dec 01 2021 at 12:26)</a>:</h4>
<p>but I would find it quite worrying if it broke on a <em>semantic</em> level</p>



<a name="263281651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281651">(Dec 01 2021 at 12:27)</a>:</h4>
<p>I feel like the rules should still apply 'on paper', no?</p>



<a name="263281757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281757">(Dec 01 2021 at 12:28)</a>:</h4>
<p>if they don't then that would mean that post-opt mir could include aliased <code>&amp;mut</code> or invalid pointers which would mean that rust's memory safety flies out the window</p>



<a name="263281863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281863">(Dec 01 2021 at 12:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/263280830">said</a>:</p>
<blockquote>
<p>Well, here's another thing, MIR doesn't always mean the same thing across the compilation pipeline ^^</p>
</blockquote>
<p>also what do you mean by this?</p>



<a name="263281945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263281945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263281945">(Dec 01 2021 at 12:30)</a>:</h4>
<p>MIR should have consistent semantics, we just use a few different dialects</p>



<a name="263282010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263282010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263282010">(Dec 01 2021 at 12:30)</a>:</h4>
<p>(ie poly/mono morphized mir, (de) aggregated mir, etc...)</p>



<a name="263282114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263282114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263282114">(Dec 01 2021 at 12:31)</a>:</h4>
<p>Only one of those dialects is suitable for borrowck. borrowck requires MIR to be in a certain shape and this shape is not preserved past a certain point in the pipeline.</p>



<a name="263282214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263282214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263282214">(Dec 01 2021 at 12:32)</a>:</h4>
<p>In other words borrow-checkable is not a property of MIR proper.</p>



<a name="263282963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263282963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263282963">(Dec 01 2021 at 12:39)</a>:</h4>
<p>Once lifetime erasure occurs we certainly can't do borrowck, right? IIRC that happens while it is still "MIR"</p>



<a name="263283214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263283214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263283214">(Dec 01 2021 at 12:42)</a>:</h4>
<p>At which point is MIR monomorphized btw?</p>



<a name="263283276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263283276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263283276">(Dec 01 2021 at 12:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/263281757">said</a>:</p>
<blockquote>
<p>if they don't then that would mean that post-opt mir could include aliased <code>&amp;mut</code> or invalid pointers which would mean that rust's memory safety flies out the window</p>
</blockquote>
<p>I think the way this works is that once you pass the point where borrow checking is possible, you are limited to optimizations that don't introduce reads to pointers or other things that aren't validated by the input MIR</p>



<a name="263283355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263283355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263283355">(Dec 01 2021 at 12:43)</a>:</h4>
<blockquote>
<p>At which point is MIR monomorphized btw?</p>
</blockquote>
<p>Never. Codegen does this on the fly</p>



<a name="263283416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263283416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263283416">(Dec 01 2021 at 12:43)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="124288">@oli</span>, for a second I thought my understanding was completely wrong <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="263284313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263284313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263284313">(Dec 01 2021 at 12:50)</a>:</h4>
<blockquote>
<p>Once lifetime erasure occurs we certainly can't do borrowck, right? IIRC that happens while it is still "MIR"</p>
</blockquote>
<p>Lifetimes are erased before MIR is built. Mir borrowck figures them out all anew</p>



<a name="263284437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263284437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263284437">(Dec 01 2021 at 12:52)</a>:</h4>
<p>After mir borrowck MIR only needs to satisfy Rust's borrowing rules dynamically. Basically miri is the current "spec"</p>



<a name="263284490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263284490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263284490">(Dec 01 2021 at 12:52)</a>:</h4>
<p>I think you can replace all references by pointers in mir and nothing changes</p>



<a name="263284520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263284520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263284520">(Dec 01 2021 at 12:52)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="120791">@RalfJ</span> MIR spec discussions xD</p>



<a name="263284763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263284763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263284763">(Dec 01 2021 at 12:55)</a>:</h4>
<p>So anyway, are there MIR-only tests, where the input itself is MIR code?</p>



<a name="263290586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263290586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263290586">(Dec 01 2021 at 13:37)</a>:</h4>
<p>Nope</p>



<a name="263290611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263290611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263290611">(Dec 01 2021 at 13:37)</a>:</h4>
<p>But we want that.</p>



<a name="263290727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263290727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263290727">(Dec 01 2021 at 13:38)</a>:</h4>
<p>Just that no one got around to writing a parser</p>



<a name="263305652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263305652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263305652">(Dec 01 2021 at 15:17)</a>:</h4>
<p>There are other issues as well afaik such as resolution / interning etc...</p>



<a name="263306412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263306412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263306412">(Dec 01 2021 at 15:21)</a>:</h4>
<p>well... we could avoid that if we made a parser that allows parsing regular Rust code but "simply" switches to a different parser in certain functions. Basically extend the Rust language to support a much simpler system that parses directly to MIR</p>



<a name="263319013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/263319013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#263319013">(Dec 01 2021 at 16:41)</a>:</h4>
<p>Should the test for that bug be a normal unit test that checks that the return value of <code>foo(42)</code> is 0?</p>



<a name="264168826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264168826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264168826">(Dec 08 2021 at 15:14)</a>:</h4>
<p>MIR definitely has a semantics, but it is indeed not very clearly specified currently -- 'whatever Miri does' is a reasonable approximation in many cases</p>



<a name="264168959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264168959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264168959">(Dec 08 2021 at 15:15)</a>:</h4>
<p>regarding the MIR semantic rules changing, that is what I am tracking at <a href="https://github.com/rust-lang/rust/issues/86299">https://github.com/rust-lang/rust/issues/86299</a>. I think we should make this explicit with some <code>enum</code> in the MIR body and each pass ensuring it runs on MIR of the right kind. but right now we don't have very fundamental changes in what the same MIR means, I think.</p>



<a name="264169212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264169212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264169212">(Dec 08 2021 at 15:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/263282214">said</a>:</p>
<blockquote>
<p>In other words borrow-checkable is not a property of MIR proper.</p>
</blockquote>
<p>borrow-checkable is not a property of MIR semantics though. basically there is a certain kind of 'normal form' that MIR must be in for the borrowck analysis to be maximally effective, but MIR outside that normal form still follows the exact same rules -- the analysis is just not smart enough to do a good job on such MIR. (ideally the analysis would still be <em>correct</em>, and just reject too many things. I am not sure if that is the case.)</p>



<a name="264188912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264188912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264188912">(Dec 08 2021 at 17:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/263290727">said</a>:</p>
<blockquote>
<p>Just that no one got around to writing a parser</p>
</blockquote>
<p>that would be a large amount of work. Does this need a MCP? Opening an issue to rust-lang/rust would be a good idea, I will do that...</p>



<a name="264189532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264189532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264189532">(Dec 08 2021 at 17:27)</a>:</h4>
<p>We have <a href="https://github.com/rust-lang/miri/issues/196">https://github.com/rust-lang/miri/issues/196</a> where <span class="user-mention" data-user-id="119009">@eddyb</span> suggests that we basically write MIR with fake Rust code that won't pass regular compilation, but that can be trivially converted to MIR</p>



<a name="264189602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264189602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264189602">(Dec 08 2021 at 17:27)</a>:</h4>
<p>heh yeah</p>



<a name="264189744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264189744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264189744">(Dec 08 2021 at 17:28)</a>:</h4>
<p>basically a straightforward AST/HIR -&gt; MIR lowering that still relies on name resolution and whatnot (I guess we don't need typeck since all the types would be explicit but we do need some amount of name resolution)</p>



<a name="264189814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264189814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264189814">(Dec 08 2021 at 17:29)</a>:</h4>
<p>(or we could generate inference variables where necessary and run the MIR typeck used by borrowck :P)</p>



<a name="264189887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264189887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264189887">(Dec 08 2021 at 17:29)</a>:</h4>
<p>How would it be possible to generate arbitrary control flow including irreducible control flow?</p>



<a name="264190105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190105">(Dec 08 2021 at 17:30)</a>:</h4>
<p>I think the idea is to not allow arbitrary <code>if</code> block contents, but just work with something like goto and labels</p>



<a name="264190174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190174">(Dec 08 2021 at 17:31)</a>:</h4>
<p>definitely would have to be a complete CFG</p>



<a name="264190269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190269">(Dec 08 2021 at 17:31)</a>:</h4>
<p>Rust doesn't have a goto statement. Maybe it could be done like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">'</span><span class="na">a</span>: <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="nl">'b</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="nl">'c</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="o">'</span><span class="na">b</span>: <span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">'</span><span class="na">c</span>: <span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="264190270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190270">(Dec 08 2021 at 17:31)</a>:</h4>
<p>like what I imagine is taking the current MIR output and making <em>minimal</em> changes to get it to be valid Rust <em>syntax</em></p>



<a name="264190400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190400">(Dec 08 2021 at 17:32)</a>:</h4>
<p>We could also <em>just</em> add <code>Goto</code> to the AST and reject it later ;)</p>



<a name="264190412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190412">(Dec 08 2021 at 17:32)</a>:</h4>
<p>I would not write <code>if</code>, I would write <code>SwitchInt</code></p>



<a name="264190502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190502">(Dec 08 2021 at 17:33)</a>:</h4>
<p><code>match foo { true =&gt; break 'b, false =&gt; break 'c }</code>? The current <code>SwitchInt</code> syntax doesn't parse as rust.</p>



<a name="264190570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190570">(Dec 08 2021 at 17:33)</a>:</h4>
<p>Or even <code>Goto("'a")</code>? AST would interpret it as a struct ctor</p>



<a name="264190631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190631">(Dec 08 2021 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264190570">said</a>:</p>
<blockquote>
<p>Or even <code>Goto("'a")</code>? AST would interpret it as a struct ctor</p>
</blockquote>
<p><code>Goto(block2)</code> is what I was imagining</p>



<a name="264190705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190705">(Dec 08 2021 at 17:34)</a>:</h4>
<p>name resolution would have to not emit errors and just silently record a resolution if one exists, IMO</p>



<a name="264190725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190725">(Dec 08 2021 at 17:34)</a>:</h4>
<p><code>Goto::&lt;'a&gt;</code></p>



<a name="264190731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190731">(Dec 08 2021 at 17:34)</a>:</h4>
<p>tho you can do something even funnier and import a fake library</p>



<a name="264190734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190734">(Dec 08 2021 at 17:34)</a>:</h4>
<p><code>break 'a</code> is the closest to a goto we have. It just requires jumping out of a block instead of into an arbitrary block.</p>



<a name="264190769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190769">(Dec 08 2021 at 17:35)</a>:</h4>
<p>existing labels won't work because of their name resolution semantics</p>



<a name="264190804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190804">(Dec 08 2021 at 17:35)</a>:</h4>
<p>you need something like <code>block1 = {...}; block2 = {...}; ...</code></p>



<a name="264190842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264190842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264190842">(Dec 08 2021 at 17:35)</a>:</h4>
<p>Existing labels are already required to be unique within a function.</p>



<a name="264191094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191094">(Dec 08 2021 at 17:36)</a>:</h4>
<p>Looks like it is just a warning.</p>



<a name="264191384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191384">(Dec 08 2021 at 17:38)</a>:</h4>
<p>what I mean is that they resolve lexically so you can't know what... well I guess you can do your own resolution nvm</p>



<a name="264191436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191436">(Dec 08 2021 at 17:38)</a>:</h4>
<p>Just opened <a href="https://github.com/rust-lang/rust/issues/91669">#91669</a>, since mir-opt tests will also benefit from this.</p>



<a name="264191451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191451">(Dec 08 2021 at 17:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264190731">said</a>:</p>
<blockquote>
<p>tho you can do something even funnier and import a fake library</p>
</blockquote>
<p><span class="user-mention" data-user-id="124288">@oli</span> imagine building MIR up as a CTFE combinator library lol</p>



<a name="264191517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191517">(Dec 08 2021 at 17:39)</a>:</h4>
<p>oh no XD</p>



<a name="264191631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191631">(Dec 08 2021 at 17:40)</a>:</h4>
<p>Even better allow programs running in miri to use the compiler interfaces used to build MIR!</p>



<a name="264191678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191678">(Dec 08 2021 at 17:40)</a>:</h4>
<p>How would we separate <code>move _place</code>s from copies?</p>



<a name="264191713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191713">(Dec 08 2021 at 17:40)</a>:</h4>
<p><code>move!()</code> or <code>copy!()</code>?</p>



<a name="264191714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191714">(Dec 08 2021 at 17:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264191631">said</a>:</p>
<blockquote>
<p>Even better allow programs running in miri to use the compiler interfaces used to build MIR!</p>
</blockquote>
<p><span aria-label="head bandage" class="emoji emoji-1f915" role="img" title="head bandage">:head_bandage:</span>  <span aria-label="explosion" class="emoji emoji-1f4a5" role="img" title="explosion">:explosion:</span></p>



<a name="264191801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191801">(Dec 08 2021 at 17:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264191678">said</a>:</p>
<blockquote>
<p>How would we separate <code>move _place</code>s from copies?</p>
</blockquote>
<p>I mean those are <code>Move(place)</code> and <code>Copy(place)</code></p>



<a name="264191817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264191817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264191817">(Dec 08 2021 at 17:41)</a>:</h4>
<p>the <code>move</code> keyword is just cutesy</p>



<a name="264192812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264192812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264192812">(Dec 08 2021 at 17:48)</a>:</h4>
<p>That would be ambiguous with <code>Rvalue::Aggregate</code>.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ <span class="nb">echo</span> <span class="s1">'pub struct Foo(u8); pub fn bar(arg: u8) -&gt; Foo { Foo(arg) }'</span> <span class="p">|</span> rustc +nightly - -Zdump-mir<span class="o">=</span>bar --crate-type lib
$ cat mir_dump/rust_out.bar.001-000.CheckPackedRef.before.mir
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// MIR for `bar` before CheckPackedRef</span>

<span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">_1</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">debug</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_1</span><span class="p">;</span><span class="w">                     </span><span class="c1">// in scope 0 at &lt;anon&gt;:1:32: 1:35</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_0</span>: <span class="nc">Foo</span><span class="p">;</span><span class="w">                     </span><span class="c1">// return place in scope 0 at &lt;anon&gt;:1:44: 1:47</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_2</span>: <span class="kt">u8</span><span class="p">;</span><span class="w">                      </span><span class="c1">// in scope 0 at &lt;anon&gt;:1:54: 1:57</span>

<span class="w">    </span><span class="n">bb0</span>: <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">StorageLive</span><span class="p">(</span><span class="n">_2</span><span class="p">);</span><span class="w">                 </span><span class="c1">// scope 0 at &lt;anon&gt;:1:54: 1:57</span>
<span class="w">        </span><span class="n">_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_1</span><span class="p">;</span><span class="w">                         </span><span class="c1">// scope 0 at &lt;anon&gt;:1:54: 1:57</span>
<span class="w">        </span><span class="n">_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="n">_2</span><span class="p">);</span><span class="w">               </span><span class="c1">// scope 0 at &lt;anon&gt;:1:50: 1:58</span>
<span class="w">        </span><span class="n">StorageDead</span><span class="p">(</span><span class="n">_2</span><span class="p">);</span><span class="w">                 </span><span class="c1">// scope 0 at &lt;anon&gt;:1:57: 1:58</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">                          </span><span class="c1">// scope 0 at &lt;anon&gt;:1:60: 1:60</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="264192903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264192903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264192903">(Dec 08 2021 at 17:49)</a>:</h4>
<p>Say there is a struct called <code>Move</code>. Does <code>_0 = Move(_2)</code> mean a move of <code>_2</code> or a copy of <code>_2</code> wrapped in the <code>Move</code> struct?</p>



<a name="264194013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264194013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264194013">(Dec 08 2021 at 17:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264192903">said</a>:</p>
<blockquote>
<p>Say there is a struct called <code>Move</code>.</p>
</blockquote>
<p>never say that! <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> But yeah, all of this would be perma-unstable as we would only use this for testing.</p>



<a name="264385178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264385178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264385178">(Dec 10 2021 at 00:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264191713">said</a>:</p>
<blockquote>
<p><code>move!()</code> or <code>copy!()</code>?</p>
</blockquote>
<p>How about just add a <code>mir!</code> builtin macro and do all the parsing there</p>



<a name="264394043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral%20Assign%20lookup%20is%20overzealous/near/264394043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous.html#264394043">(Dec 10 2021 at 01:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/SimplifyComparisonIntegral.20Assign.20lookup.20is.20overzealous/near/264191631">said</a>:</p>
<blockquote>
<p>Even better allow programs running in miri to use the compiler interfaces used to build MIR!</p>
</blockquote>
<p>finally, <code>eval</code> in Rust :D</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>