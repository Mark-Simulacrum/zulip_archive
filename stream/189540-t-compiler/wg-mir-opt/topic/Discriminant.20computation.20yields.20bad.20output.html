<html>
<head><meta charset="utf-8"><title>Discriminant computation yields bad output · t-compiler/wg-mir-opt · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/index.html">t-compiler/wg-mir-opt</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html">Discriminant computation yields bad output</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264944294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264944294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264944294">(Dec 14 2021 at 23:29)</a>:</h4>
<p>Maybe this has been discussed somewhere before (also I'm definitely underqualified to for this conversation), but: I've been working on improving the output of code <a href="https://godbolt.org/z/qdPe99WqG">like this</a> over the last few days (see <a href="https://github.com/rust-lang/rust/issues/91840">#91840</a> and I have a follow up PR that helps in some other cases) but no changes that I've been able to make have been able to get either of these to optimize into the single comparison that we'd want them to be.</p>
<p>Fundamentally, I think the underlying issue here is that optimizers (both MIR passes and LLVM) have a hard time reasoning about what's going on because the control flow is divided up into two steps: First the discriminant of the enum is computed, and then the value of the discriminant is branched on. In order for the optimizer to get this right, it has to propagate the constraints that the discriminant taking a certain value implies.</p>
<p>I'm also working on improved layout optimizations right now, and so am especially concerned about this because these kinds of things getting mis-optimized is obviously liable to turn into a major problem the more aggressively we put things in niches.</p>
<p>Has some more fundamental change here been considered? I'm (again, besides extremely underqualified) imagining something like a <code>switchVariant</code> terminator where what this compiles to is decided at monomorphization time (or whenever the full layout of the enum is known). This would make it possible for the <code>Option&lt;NonZeroU32&gt;</code> equality comparison to look something more like this to LLVM:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That's something I at least have some hope of getting compiled into the right thing.</p>



<a name="264944436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264944436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264944436">(Dec 14 2021 at 23:31)</a>:</h4>
<p>(Not that this does get compiled right, <a href="https://godbolt.org/z/E3h9rjfPs">but then what does</a>)</p>



<a name="264949038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264949038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264949038">(Dec 15 2021 at 00:25)</a>:</h4>
<p>It probably doesn't need a new terminator, but having codegen_ssa special-case the <code>_N = discriminant(_M); switchInt (_N)</code> pattern might be profitable.</p>
<p>It seems like <code>discriminant</code> directly always returns <code>isize</code>, and I recall from looking at suboptimal <code>?</code> codegen that maybe part of what confused it was that it was always switching on an extended-then-truncated value.  (And there's no <code>trunc exact</code> in LLVM to make that more obvious.)  It might be that switching directly could make it easier.</p>
<p>Alternatively, maybe the <code>discriminant</code> MIR rvalue could be typed differently?  <code>Result</code> would be much happier if it could just <code>br</code> on the <code>i1</code> it read rather than needing it <code>switch</code> it.  That wouldn't work for a fully-generic <code>T</code>, but do we need it to work for that case?  Certainly <code>match</code> isn't ever switchInt'ing over a discriminant for a fully-generic type...</p>



<a name="264950250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264950250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264950250">(Dec 15 2021 at 00:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output/near/264949038">said</a>:</p>
<blockquote>
<p>It probably doesn't need a new terminator, but having codegen_ssa special-case the <code>_N = discriminant(_M); switchInt (_N)</code> pattern might be profitable.</p>
</blockquote>
<p>That might be enough. The thing I am slightly worried about is this encouraging other optimizations to make use of the discriminant being an integer and then eg doing arithmetic or something with it, probably this is a non-issue though.</p>
<blockquote>
<p>It seems like <code>discriminant</code> directly always returns <code>isize</code></p>
</blockquote>
<p>(and sometimes <code>usize</code>, as I recently learned via an ICE)</p>
<blockquote>
<p>Alternatively, maybe the <code>discriminant</code> MIR rvalue could be typed differently?  <code>Result</code> would be much happier if it could just <code>br</code> on the <code>i1</code> it read rather than needing it <code>switch</code> it.</p>
</blockquote>
<p>So I suppose its possible to special-case two variant enums (might be possible to just write an optimization pass for this though). But if we do not want to special case, then I think this is actually equivalent to my suggestion. What the <code>switchVariant</code> is effectively doing is <code>_N = discriminant(_M);</code> but now <code>_N</code> has some opaque non-integer type, and then "switching" on <code>_N</code> is a type specific operation.</p>



<a name="264950796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264950796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264950796">(Dec 15 2021 at 00:48)</a>:</h4>
<p>Doing this thing pre-monomorphization is difficult when faced with layout optimizations though, because the correct way to codegen switching on the variant of a type like this is very dependent on the generic parameters:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">E</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">U</span><span class="p">(</span><span class="n">U</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">V</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>ie if all three parameters are <code>u8</code> then this should be an LLVM <code>switchInt</code>, but on <code>E&lt;(NonZeroU8, u8), NonZeroU8, ()&gt;</code> this should be two <code>icmp + br</code>s (asuming that type gets the 2 byte layout)</p>



<a name="264951534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264951534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264951534">(Dec 15 2021 at 00:56)</a>:</h4>
<p>In other words, forcing the non-monomorphized layout for <code>E</code> to pick some small set of values for its discriminants and then come monomorphization time generate whatever code is necessary for <code>discriminant</code> to meet that contract seems less than optimal</p>



<a name="264952594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264952594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264952594">(Dec 15 2021 at 01:10)</a>:</h4>
<p>The huge advantage of just matching "last statement was assign-from-discriminant" is that you don't have to implement the new thing in all the backends.  The MIR could just try to move it as late as possible, if it's not already at the end of the block in practice.</p>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output/near/264950250">said</a>:</p>
<blockquote>
<p>The thing I am slightly worried about is this encouraging other optimizations to make use of the discriminant being an integer and then eg doing arithmetic or something with it, probably this is a non-issue though.</p>
</blockquote>
<p>That's an interesting canonicalization question.  For something like this &lt;<a href="https://rust.godbolt.org/z/Wc8qjcqMf">https://rust.godbolt.org/z/Wc8qjcqMf</a>&gt; I could see an argument that it'd be <em>good</em> for the MIR to have <code>_2 = discriminant(_1); discriminant(_0) = !_2;</code> -- certainly LLVM can't do that today, generating <code>icmp</code>+<code>zext</code> instead of just <code>xor 1</code>.</p>



<a name="264953346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264953346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264953346">(Dec 15 2021 at 01:21)</a>:</h4>
<p>Why can't LLVM do this today? In both the MIR and the pre-opt LLVM IR the fallthrough branch on the <code>switchInt</code> is correctly marked as unreachable, so the optimization should be allowed no?</p>



<a name="264953807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264953807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264953807">(Dec 15 2021 at 01:28)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/issues/85133#issuecomment-904185574">https://github.com/rust-lang/rust/issues/85133#issuecomment-904185574</a> for some previous investigation</p>
<p>(I think it <em>ought</em> to be able to do it -- there's no fundamental semantic problem -- it just doesn't right now.)</p>



<a name="264953965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264953965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264953965">(Dec 15 2021 at 01:30)</a>:</h4>
<p>Oh that is... extremely unforunate. It also might explain why one change I had made locally does not cause any perf changes</p>



<a name="264954526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264954526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264954526">(Dec 15 2021 at 01:39)</a>:</h4>
<p>That's also why I wish there was a <code>trunc exact</code> (like there's a <code>udiv exact</code>).  If we could emit <code>load i8; trunc exact i8 to i1; br</code> then it'd know it doesn't need the extra <code>cmp</code>, but since it's just <code>trunc i8 to i1</code> it loses track of the fact that that's a noop.</p>



<a name="264995785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264995785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264995785">(Dec 15 2021 at 11:26)</a>:</h4>
<p>I've got a POC for switching on tags directly but I need to clean it up first</p>



<a name="264996641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/264996641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#264996641">(Dec 15 2021 at 11:34)</a>:</h4>
<p>My POC just does the switching on tags at monomorphization time after finding a <code>…; _1 = discriminant(x); switchInt _1 { … }</code> block</p>



<a name="265224923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265224923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265224923">(Dec 16 2021 at 21:53)</a>:</h4>
<p>I'm super-excited for this!</p>
<p>If you want another test, in <a href="https://github.com/rust-lang/rust/issues/91998">#91998</a> I noticed that the length of an option iterator is suboptimal: &lt;<a href="https://rust.godbolt.org/z/q3rYjahPb">https://rust.godbolt.org/z/q3rYjahPb</a>&gt;.  Would be great to be able to leave the obvious code and have it just work thanks to your PR.</p>



<a name="265277373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265277373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265277373">(Dec 17 2021 at 10:19)</a>:</h4>
<p>Regarding the code from the Iterator PR: I think that should be merged, and that it is obvious code on its own. I dislike a lot that adapters don't redefine those methods</p>



<a name="265277623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265277623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265277623">(Dec 17 2021 at 10:22)</a>:</h4>
<p>And I checked and AFAICT my patch doesn't help :(</p>



<a name="265281460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265281460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265281460">(Dec 17 2021 at 10:59)</a>:</h4>
<p>I think what could help is noticing that the switch is exhaustive, and making it have a single arm</p>



<a name="265281642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265281642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265281642">(Dec 17 2021 at 11:00)</a>:</h4>
<p>Nope, still <code>icmp</code> in there</p>



<a name="265284408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265284408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265284408">(Dec 17 2021 at 11:29)</a>:</h4>
<p>Oh, yeah, I think it makes sense to override all those as in that PR.</p>
<p>The thing that's less obvious to me is whether using <code>discriminant_value</code> for <code>Option::len</code> is a good change.</p>



<a name="265303814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265303814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265303814">(Dec 17 2021 at 14:41)</a>:</h4>
<p>That seems like a bit of a hack. I'm curious why LLVM cannot remove the <code>icmp</code></p>



<a name="265304044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265304044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265304044">(Dec 17 2021 at 14:43)</a>:</h4>
<p>I feel like when LLVM optimises <code>%6 = load i32, i32* %5, align 4, !range !1</code>, it drops the range info, and then it cannot remember that the damn arg is always 0 or 1</p>



<a name="265304591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265304591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265304591">(Dec 17 2021 at 14:47)</a>:</h4>
<p>That already came up elsewhere: <a href="https://github.com/rust-lang/rust/issues/49572">https://github.com/rust-lang/rust/issues/49572</a></p>



<a name="265371483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265371483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265371483">(Dec 17 2021 at 22:39)</a>:</h4>
<p>Yeah, it's also come up in <a href="https://github.com/rust-lang/rust/issues/85133#issuecomment-904185574">https://github.com/rust-lang/rust/issues/85133#issuecomment-904185574</a></p>



<a name="265375112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265375112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265375112">(Dec 17 2021 at 23:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output/near/264952594">said</a>:</p>
<blockquote>
<p>The huge advantage of just matching "last statement was assign-from-discriminant" is that you don't have to implement the new thing in all the backends.  The MIR could just try to move it as late as possible, if it's not already at the end of the block in practice.</p>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output/near/264950250">said</a>:</p>
<blockquote>
<p>The thing I am slightly worried about is this encouraging other optimizations to make use of the discriminant being an integer and then eg doing arithmetic or something with it, probably this is a non-issue though.</p>
</blockquote>
<p>That's an interesting canonicalization question.  For something like this &lt;<a href="https://rust.godbolt.org/z/Wc8qjcqMf">https://rust.godbolt.org/z/Wc8qjcqMf</a>&gt; I could see an argument that it'd be <em>good</em> for the MIR to have <code>_2 = discriminant(_1); discriminant(_0) = !_2;</code> -- certainly LLVM can't do that today, generating <code>icmp</code>+<code>zext</code> instead of just <code>xor 1</code>.</p>
</blockquote>
<p>Value numbering could help here because it has to compute alias info, which gives the optimizer more flexibility when moving statements around.</p>



<a name="265375178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265375178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265375178">(Dec 17 2021 at 23:19)</a>:</h4>
<p>It could even get a special case for "discriminant-of" Operands and rewrite them directly into get-discriminant + switch</p>



<a name="265382630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265382630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265382630">(Dec 18 2021 at 01:10)</a>:</h4>
<p>Also, this is probably obvious, but with MIR inlining + value numbering + enhanced inst combine we could probably just do this optimization ourselves and save ourselves all this trouble.</p>



<a name="265422951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265422951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265422951">(Dec 18 2021 at 15:01)</a>:</h4>
<p>I don't see how a MIR pass can improve discriminant switches when you need layout info to do the improvement</p>



<a name="265422960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant%20computation%20yields%20bad%20output/near/265422960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nox <a href="https://zulip-archive.rust-lang.org/stream/189540-t-compiler/wg-mir-opt/topic/Discriminant.20computation.20yields.20bad.20output.html#265422960">(Dec 18 2021 at 15:01)</a>:</h4>
<p>Ah, I guess you meant for that case specifically</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>