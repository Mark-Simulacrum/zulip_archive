<html>
<head><meta charset="utf-8"><title>thir for const generics · project-thir-unsafeck · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/index.html">project-thir-unsafeck</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html">thir for const generics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251363450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251363450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251363450">(Aug 31 2021 at 10:35)</a>:</h4>
<p>hey <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> <span class="user-group-mention silent" data-user-group-id="3805">project-const-generics</span> needs some simplified ast to compare for equality of two generic constants, e.g. to check that <code>N - 1</code> and <code>N - 1</code> are the same. We currently use the unoptimized mir for this: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_trait_selection/traits/const_evaluatable/fn.mir_abstract_const.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_trait_selection/traits/const_evaluatable/fn.mir_abstract_const.html</a></p>
<p>This has afaict the same issues as unsafeck as we drop some information when building the mir, so for example <code>N as u8 as u8</code> is considered the same as just <code>N as u8</code>.</p>



<a name="251363870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251363870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251363870">(Aug 31 2021 at 10:39)</a>:</h4>
<p>so we're also looking to replace the mir based ast with one using thir. Are there still some noteworthy refactoring of either the <code>thir_body</code> query or the structure of the thir itself planned for unsafeck? In this case it would probably make sense to wait for these until we use the thir for const generics. Switching to thir here has pretty much no time constraint, so we could also wait for a year without many issues :p</p>



<a name="251364265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251364265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251364265">(Aug 31 2021 at 10:43)</a>:</h4>
<p>dont we just get rid of the built thir after constructing mir?</p>



<a name="251364294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251364294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251364294">(Aug 31 2021 at 10:43)</a>:</h4>
<p>i thought it wasn't kept around so how would that work with unifying consts across crates</p>



<a name="251364348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251364348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251364348">(Aug 31 2021 at 10:44)</a>:</h4>
<p>this project group added a new query <code>thir_body</code> for this which returns the thir</p>



<a name="251364445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251364445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251364445">(Aug 31 2021 at 10:44)</a>:</h4>
<p>right which takes a LocalDefId which brings back to cross-crate unifying of consts</p>



<a name="251364459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251364459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251364459">(Aug 31 2021 at 10:44)</a>:</h4>
<p>it uses <code>Steal&lt;Thir&lt;'tcx&gt;&gt;</code> so mir building (probably) is going to get rid of the thir and all queries which need the hir  have to get called before this</p>



<a name="251364531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251364531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251364531">(Aug 31 2021 at 10:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics/near/251364445">said</a>:</p>
<blockquote>
<p>right which takes a LocalDefId which brings back to cross-crate unifying of consts</p>
</blockquote>
<p>we can encode the <code>AbstractConst</code> for all local constants so we don't rely on the thir for constants from external crates</p>



<a name="251380748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251380748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251380748">(Aug 31 2021 at 13:05)</a>:</h4>
<blockquote>
<p>Are there still some noteworthy refactoring of either the <code>thir_body</code> query or the structure of the thir itself planned for unsafeck?</p>
</blockquote>
<p>We wanted to try changing the exhaustiveness checker to use the <code>thir_body</code> query instead of re-lowering all patterns (for performance), and that might require some changes to how patterns are represented THIR.</p>



<a name="251381528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/278509-project-thir-unsafeck/topic/thir%20for%20const%20generics/near/251381528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/278509-project-thir-unsafeck/topic/thir.20for.20const.20generics.html#251381528">(Aug 31 2021 at 13:10)</a>:</h4>
<blockquote>
<p>it uses <code>Steal&lt;Thir&lt;'tcx&gt;&gt;</code> so mir building (probably) is going to get rid of the thir and all queries which need the hir  have to get called before this</p>
</blockquote>
<p>Correct, that's what we do for unsafeck: <a href="https://github.com/rust-lang/rust/blob/fe37929e4cba2c5c21e6805805769630c736bc3d/compiler/rustc_mir_build/src/build/mod.rs#L47-L55">https://github.com/rust-lang/rust/blob/fe37929e4cba2c5c21e6805805769630c736bc3d/compiler/rustc_mir_build/src/build/mod.rs#L47-L55</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>