<html>
<head><meta charset="utf-8"><title>#68171 · t-compiler/wg-parallel-rustc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/index.html">t-compiler/wg-parallel-rustc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html">#68171</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="187317373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187317373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187317373">(Feb 03 2020 at 23:40)</a>:</h4>
<p>I think some other folks should probably weigh in (this is the "parallel always runs all pieces"). We appear to be at an impasse with Zoxc and I'm not sure how to move forward. A design meeting has been suggested; we can pursue that I guess.</p>



<a name="187606726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187606726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187606726">(Feb 07 2020 at 01:53)</a>:</h4>
<p>We do want to remove all <code>FatalError</code>s in case none of this will matter, so I don't really feel like it warrants a design meeting.</p>



<a name="187607173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607173">(Feb 07 2020 at 02:05)</a>:</h4>
<p>I know that you don't think we need determinism here, but my counter argument is that executing all the iterations is useful for our test suite (so it matches the non-parallel compiler) and it also doesn't really cost us anything.</p>
<p>The case you seem to be concerned about where a fatal error will poison the global state can happen with any parallelism. Say for example:</p>
<div class="codehilite"><pre><span></span><span class="n">join</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fatal_error_which_poisons_global_state</span><span class="p">();</span><span class="w"></span>
<span class="p">},</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">function_which_ICEs_on_poisoned_global_state</span><span class="p">()</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</pre></div>


<p>So to have any parallelism our fatal errors must not poison global state or cause any ICEs. Once we remove all fatal errors this won't be a concern though.</p>



<a name="187607254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607254">(Feb 07 2020 at 02:06)</a>:</h4>
<p>I'm mostly concerned about it being more complicated (at least, we need to think about it a little when adding new parallel abstractions).</p>



<a name="187607277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607277">(Feb 07 2020 at 02:07)</a>:</h4>
<p>Maybe that's a false concern, but I also don't really see that it buys us that much -- for the test suite, -Zthreads=1 seems fine for where it matters. And, as you say, eventually we'll not have fatal errors in which case it won't matter even more so long as we sort or so.</p>



<a name="187607321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607321">(Feb 07 2020 at 02:08)</a>:</h4>
<p>Do you agree that we don't need determinism? i.e., that error output need not be deterministic?</p>



<a name="187607323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607323">(Feb 07 2020 at 02:08)</a>:</h4>
<p>I think that's the first point of disagreement</p>



<a name="187607718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607718">(Feb 07 2020 at 02:18)</a>:</h4>
<p><code>-Zthreads=1</code> just makes the error output deterministic, it doesn't make it match the non-parallel compiler. I do not want to have separate test outputs for the parallel compiler or sort test output (and basically touch all test files).</p>



<a name="187607800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187607800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187607800">(Feb 07 2020 at 02:20)</a>:</h4>
<p>I think our error output should be as deterministic as possible, especially if it doesn't come at a performance cost or complexity cost. In this case the performance cost is not relevant and the complexity is contained to <code>sync.rs</code> abstractions.</p>



<a name="187608033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608033">(Feb 07 2020 at 02:27)</a>:</h4>
<p>I think the complexity cost in mental overhead is higher than that. At least for me having to think "this iterator will continue to run" even on panics is not something that most Rust code is used to</p>



<a name="187608090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608090">(Feb 07 2020 at 02:28)</a>:</h4>
<p>No matter what we'd not be touching all files. x.py test --stage 1 src/test/ui --bless passes almost entirely for me on a parallel compiler with almost no changes</p>



<a name="187608100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608100">(Feb 07 2020 at 02:28)</a>:</h4>
<p>maybe 4 files or so</p>



<a name="187608187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608187">(Feb 07 2020 at 02:30)</a>:</h4>
<p>Try removing all <code>catch_panic</code> calls from <code>sync.rs</code>, since you want to undo that design decision.</p>



<a name="187608208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608208">(Feb 07 2020 at 02:30)</a>:</h4>
<p>I also think that we need <code>catch_panic</code> in this case anyway, since we don't want changes to Rayon iterators to affect rustc's test output.</p>



<a name="187608530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608530">(Feb 07 2020 at 02:39)</a>:</h4>
<p>It was my impression that this is not a design decision in the sense that we've not really discussed it, more so that it is "just a choice" that was made at some point.</p>



<a name="187608540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608540">(Feb 07 2020 at 02:40)</a>:</h4>
<p>I also don't think isolating ourselves from hypothetical rayon changes is necessary</p>



<a name="187608588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608588">(Feb 07 2020 at 02:40)</a>:</h4>
<p>and catch panic wouldn't help there anyway, since (non fatal) errors are going to get emitted in different orders regardless?</p>



<a name="187608593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608593">(Feb 07 2020 at 02:40)</a>:</h4>
<p>even across different runs</p>



<a name="187608596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608596">(Feb 07 2020 at 02:40)</a>:</h4>
<p>well, at least, presuming rayon is non-deterministic, which it must be</p>



<a name="187608763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608763">(Feb 07 2020 at 02:44)</a>:</h4>
<p>I'm pretty sure it was discussed, but it was probably years ago =P</p>



<a name="187608779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608779">(Feb 07 2020 at 02:45)</a>:</h4>
<p>Rayon is deterministic with 1 thread (which we use for tests)</p>



<a name="187608906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608906">(Feb 07 2020 at 02:49)</a>:</h4>
<p>okay, so:</p>
<ul>
<li>for tests, it really doesn't matter what we do here, since:<ul>
<li>fallout is quite low in practice, not many tests need to change from deterministic differences with parallelism</li>
<li>parallel compilers in -Zthreads=1 are going to be deterministic</li>
</ul>
</li>
<li>in normal compilation, we're never deterministic with error order anyway<ul>
<li>since rayon's order is inherently non-deterministic</li>
<li>catching panics only indicates that we are more likely to see all errors</li>
</ul>
</li>
</ul>



<a name="187608907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187608907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187608907">(Feb 07 2020 at 02:49)</a>:</h4>
<p>does that represent an accurate summary from your perspective?</p>



<a name="187609167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187609167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187609167">(Feb 07 2020 at 02:56)</a>:</h4>
<p>The tests case isn't accurate. For tests 2 decisions was made:<br>
1) Use <code>-Zthread=1</code> to make the output of the parallel compiler deterministic. This is an alternative to sorting the error message order for tests (which I think is bad since error order matter, in particular the first error should always be a usable one).</p>
<p>2) Use <code>catch_panic</code>to ensure all the parallel parts execute in both the parallel compiler and the non-parallel compiler. This ensures they both output the same set of error messages (ignoring the order). This is an alternative to manually marking which errors appear in the parallel and the non-parallel compiler in test files. Note that sorting doesn't help here.</p>



<a name="187609274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187609274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187609274">(Feb 07 2020 at 02:58)</a>:</h4>
<p>Hm, so is it accurate that we could only use catch_panic if -Zthreads=1, to satisfy your concern over test determinism?</p>
<p>(I'm not saying that's a good idea -- it would increase complexity -- but just to make sure I understand)</p>



<a name="187609384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187609384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187609384">(Feb 07 2020 at 03:01)</a>:</h4>
<p>(I'm off for the night, but I think we should keep discussing here, this has felt more productive than the PR)</p>



<a name="187609504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187609504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187609504">(Feb 07 2020 at 03:04)</a>:</h4>
<p>Yeah, you need both 1) <code>-Zthreads=1</code> and 2) <code>catch_panic</code> to make the test output for the non-parallel and parallel compiler match.</p>



<a name="187636565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187636565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187636565">(Feb 07 2020 at 12:56)</a>:</h4>
<p>is the reason that we need catch panic, over just -Zthreads=1, that rayon (even in "deterministic mode" with one thread) does not execute an iterator/join sequentially, exactly like non-parallel compilers would?</p>



<a name="187637569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187637569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187637569">(Feb 07 2020 at 13:12)</a>:</h4>
<p>I think it executes them sequentially, but on a panic it will abort some iterations, but not others (it uses <code>catch_panic</code> internally), so it doesn't match the non-parallel compiler which in <code>master</code> aborts all later iterations</p>



<a name="187637689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187637689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187637689">(Feb 07 2020 at 13:14)</a>:</h4>
<p>I think it would be helpful, for me, if we had a document or so that said "here is how rayon -Zthreads=1 differs from regular iterators" for each API we use in rayon</p>



<a name="187637737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187637737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187637737">(Feb 07 2020 at 13:14)</a>:</h4>
<p>because to me it sounds like there is <em>some</em> difference, but I don't have a good handle on it</p>



<a name="187637749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187637749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187637749">(Feb 07 2020 at 13:14)</a>:</h4>
<p>and perhaps that difference is one that we could resolve upstream (or say that it is acceptable)</p>



<a name="187637907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187637907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187637907">(Feb 07 2020 at 13:16)</a>:</h4>
<p>We can just use <code>catch_panic</code> to get the behavior we want from Rayon iterators. We don't need to change the upstream, especially since we won't keep the  <code>catch_panic</code> long-term.</p>



<a name="187638509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187638509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187638509">(Feb 07 2020 at 13:26)</a>:</h4>
<p>That's possibly true, yes. But I would be hesitant to sign off on that as a reviewer without understanding the behavior we're patching over</p>



<a name="187638551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187638551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187638551">(Feb 07 2020 at 13:27)</a>:</h4>
<p>And I still feel like if the order is not the same as in the non-rayon case, then maybe we're not actually getting determinism due to the global state issues I mentioned before. If the order is the same, then I'm confused why we need to catch panics ourselves.</p>



<a name="187640005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187640005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187640005">(Feb 07 2020 at 13:46)</a>:</h4>
<p>The order is not the problem, it is which iterations which will execute once one (or more) iteration panics that differs.</p>



<a name="187640151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187640151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187640151">(Feb 07 2020 at 13:48)</a>:</h4>
<p>My PR uses <code>catch_panic</code> so Rayon iterator will see no panics and thus always execute all iterations. So we don't have to rely on how Rayon deals with panics there.</p>



<a name="187645969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187645969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187645969">(Feb 07 2020 at 14:59)</a>:</h4>
<p>I realize that. I'm asking - what is the default behavior?</p>



<a name="187646441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187646441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187646441">(Feb 07 2020 at 15:04)</a>:</h4>
<p>I'm guessing it groups up chunks to run in a single thread and then runs these in parallel, but the iterator code isn't very readable so I don't know.</p>



<a name="187648423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187648423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187648423">(Feb 07 2020 at 15:23)</a>:</h4>
<p>I think if we can't get the order to be the same then it doesn't matter that much as to whether we're catching panics or not.</p>



<a name="187649545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187649545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187649545">(Feb 07 2020 at 15:35)</a>:</h4>
<p>Again, the order is not the problem, it seems to match.</p>



<a name="187650401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187650401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187650401">(Feb 07 2020 at 15:44)</a>:</h4>
<p>But rayon catches panics already at some non-single-item level?</p>



<a name="187650412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187650412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187650412">(Feb 07 2020 at 15:45)</a>:</h4>
<p>(Why?)</p>



<a name="187652137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187652137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187652137">(Feb 07 2020 at 16:03)</a>:</h4>
<p>It uses <code>join</code> I think which require <code>catch_panic</code> for soundness</p>



<a name="187652409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187652409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187652409">(Feb 07 2020 at 16:06)</a>:</h4>
<p>hm, I guess that makes sense.</p>



<a name="187652426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187652426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187652426">(Feb 07 2020 at 16:06)</a>:</h4>
<p>Do we agree that there's no point in us catching panics inside rustc when there are multiple threads?</p>



<a name="187653046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653046">(Feb 07 2020 at 16:12)</a>:</h4>
<p>Doing that will give us a deterministic set of errors, but the ordering of them will still be non-deterministic</p>



<a name="187653091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653091">(Feb 07 2020 at 16:13)</a>:</h4>
<p>hm, I don't follow</p>



<a name="187653214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653214">(Feb 07 2020 at 16:14)</a>:</h4>
<p>it is definitely true that if we don't catch panics in the many thread case that we may not execute the same work</p>



<a name="187653222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653222">(Feb 07 2020 at 16:14)</a>:</h4>
<p>Assuming Rayon iterators picks their chunks dynamically (which would make sense), but I don't know if they actually do that</p>



<a name="187653408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653408">(Feb 07 2020 at 16:16)</a>:</h4>
<p>The goals you are setting are:</p>
<ul>
<li>-Zthreads=1 behaves <em>identically</em> (ordering, what code is run) to the single-threaded non-parallel compiler</li>
<li>Multiple threads: ???</li>
</ul>



<a name="187653420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653420">(Feb 07 2020 at 16:16)</a>:</h4>
<p>Is that accurate?</p>



<a name="187653509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653509">(Feb 07 2020 at 16:18)</a>:</h4>
<p>Multiple threads: Should emit the same set of error messages as the non-parallel compiler, but possibly in a different order</p>



<a name="187653759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653759">(Feb 07 2020 at 16:20)</a>:</h4>
<p>(and the first bullet is as you understand?)</p>



<a name="187653840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653840">(Feb 07 2020 at 16:21)</a>:</h4>
<p>Yeah</p>



<a name="187653962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187653962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187653962">(Feb 07 2020 at 16:22)</a>:</h4>
<p>Okay, so I'm not sure that I entirely agree with these constraints. But I think I now understand them, at least.</p>



<a name="187654006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187654006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187654006">(Feb 07 2020 at 16:23)</a>:</h4>
<p>Goals:</p>
<ul>
<li>-Zthreads=1 behaves identically (ordering, what code is run) to the single-threaded non-parallel compiler</li>
<li>Multiple threads: same errors, potentially different ordering, non-deterministic ordering is expected</li>
</ul>



<a name="187654343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187654343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187654343">(Feb 07 2020 at 16:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116466">@Zoxc</span> So I think I would prefer that we not roll this code into <a href="http://sync.rs" target="_blank" title="http://sync.rs">sync.rs</a> (at least for the calls to rayon), and instead have it live inside upstream rayon. It seems similar conceptually to <a href="https://docs.rs/rayon/1.3.0/rayon/iter/trait.ParallelIterator.html#method.panic_fuse" target="_blank" title="https://docs.rs/rayon/1.3.0/rayon/iter/trait.ParallelIterator.html#method.panic_fuse">panic_fuse</a>, just doing the reverse. What do you think about upstreaming it instead of having it in <a href="http://sync.rs" target="_blank" title="http://sync.rs">sync.rs</a>?</p>



<a name="187654988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187654988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187654988">(Feb 07 2020 at 16:35)</a>:</h4>
<p>It might work as a combinator (which ensure all iterators run in the presence of panics). That way users can select to pay the cost for it.</p>
<p>cc <span class="user-mention" data-user-id="138448">@cuviper</span>  <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="187655555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187655555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187655555">(Feb 07 2020 at 16:41)</a>:</h4>
<p>Or maybe it won't help much, since we still need to deal with the non-parallel cases</p>



<a name="187655648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187655648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187655648">(Feb 07 2020 at 16:42)</a>:</h4>
<p>Well, we're going to jettison the non-parallel case eventually</p>



<a name="187656094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187656094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187656094">(Feb 07 2020 at 16:48)</a>:</h4>
<p>And <code>FatalError</code>s, in which case we wouldn't need said combinator</p>



<a name="187656193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187679-t-compiler/wg-parallel-rustc/topic/%2368171/near/187656193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187679-t-compiler/wg-parallel-rustc/topic/.2368171.html#187656193">(Feb 07 2020 at 16:49)</a>:</h4>
<p>A delayed-panic combinator does sound interesting, even if rustc ends up not needing it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>