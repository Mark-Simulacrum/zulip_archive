<html>
<head><meta charset="utf-8"><title>[Idea] Different approach · t-lang/project-never-type · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/index.html">t-lang/project-never-type</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html">[Idea] Different approach</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250202532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250202532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250202532">(Aug 21 2021 at 07:18)</a>:</h4>
<p>I was reading the gist <a href="https://gist.github.com/nikomatsakis/7a07b265dc12f5c3b3bd0422018fa660">https://gist.github.com/nikomatsakis/7a07b265dc12f5c3b3bd0422018fa660</a> . I want to create my implementation proposal as a thinking exercise. Review comments are very welcome!</p>
<p>In rust type system, at least in the user-facing parts, the subtyping relations are very strict. Currently, a prerequisite is that the <code>TyKind</code>s(including stuff like <code>AdtDef</code>) needs to be the same. If it's changing significantly, it has to be a coercion.</p>
<p>In common plt theories, though, bottom types has the subtyping relations that  <code>Bottom &lt;: AnyType</code>. I think it's clear that <code>!</code> could not represent the bottom type well. Instead, it's just a simple uninhabited type with some compiler magic.  For example, <code>! &lt;: ()</code> doesn't hold.</p>
<h1>Proposal</h1>
<p>So my proposal here is:</p>
<ol>
<li>introduce a compiler internal <code>{diverging}</code> type to represent the real bottom type.  It acts a little like <code>{integer}</code> and cannot be specified by user directly.</li>
<li>support the coercion <code>! -&gt; {diverging}</code>. (maybe extend to other uninhabited types in the future?)</li>
<li>support the subtyping treatment of <code>{diverging} &lt;: Any type variable</code> in obligation processing.</li>
<li>For type checking fallback, replace all inferred occurances of <code>{diverging}</code> with <code>!</code>  (since <code>{diverging} &lt;: !</code>), to make them user-facing. </li>
<li>replace all remaining uninferred type variables with <code>()</code>.</li>
</ol>
<h1>Does this conform to bug 66173?</h1>
<p>I think so, </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">something</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pattern1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Default</span>::<span class="n">default</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="n">pattern2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"..."</span><span class="p">),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>The coercion relationships:</p>
<div class="codehilite"><pre><span></span><code>?T -&gt; ?M
! -&gt; ?M
</code></pre></div>
<p>leads to:<code> ?T &lt;: ?M,    ! coerces to {diverging}, {diverging} &lt;: ?M</code><br>
Since the third sentence is trivial from rule, We will no longer solve <code>?M</code> with <code>{diverging}</code>, instead, we'll rely on fallback to solve <code>?M</code> and <code>?T</code> with <code>()</code>.</p>
<h1>Does this conform to bug 66757?</h1>
<p>I think so.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">E</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;!&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">_</span>: <span class="o">!</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">E</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[allow(unreachable_code)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">never</span>: <span class="o">!</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">E</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;!&gt;&gt;</span>::<span class="n">from</span><span class="p">(</span><span class="n">never</span><span class="p">);</span><span class="w">  </span><span class="c1">// Ok</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">E</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span>::<span class="n">from</span><span class="p">(</span><span class="n">never</span><span class="p">);</span><span class="w">  </span><span class="c1">// Inference fails here</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Since generics "suppresses" coercions, and <code>never</code> has type <code>!</code> here, the <code>! -&gt; {diverging}</code> coercion won't happen, then  I think the inference will succeed.</p>
<h1>Disadvantages</h1>
<ul>
<li>Complexities from new compiler builtin type</li>
<li>Complexities from extending subtyping rules.</li>
</ul>
<p>I wonder what people think about this. Did i make any reasoning mistakes? <span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125270">@scottmcm</span></p>



<a name="250399427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250399427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250399427">(Aug 23 2021 at 19:24)</a>:</h4>
<p>I think this is indeed quite similar to what I proposed</p>



<a name="250399440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250399440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250399440">(Aug 23 2021 at 19:24)</a>:</h4>
<p>I'm not 100% sure if it's <em>exactly</em> the same, do you think it is?</p>



<a name="250607210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250607210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250607210">(Aug 25 2021 at 11:30)</a>:</h4>
<p>I think it's a little bit different in principle. Basically the only difference is to make <code>{diverging}</code> a real type instead of a property of the type variable itself.</p>



<a name="250643609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250643609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremiah Senkpiel <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250643609">(Aug 25 2021 at 16:25)</a>:</h4>
<p>That's also the difference I understood, where Niko's tries to unify to another type (<code>!</code> or <code>()</code>) Charles's keeps <code>{diverging}</code> as an internal "bottom" type, which I think allows it to address 66757 "easier"</p>



<a name="250666387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250666387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250666387">(Aug 25 2021 at 19:08)</a>:</h4>
<p>Yeah. I'm more wondering, does it behave differently, and if so, on what examples?</p>



<a name="250750538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250750538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250750538">(Aug 26 2021 at 10:19)</a>:</h4>
<p>I... I think i cannot finish this comparison only by brain prediction. If i've got time maybe i'll see whether i can implement this on my fork as a prototype to compare. Let's just leave this as an potential idea for now.</p>



<a name="250780396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/259160-t-lang/project-never-type/topic/%5BIdea%5D%20Different%20approach/near/250780396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/259160-t-lang/project-never-type/topic/.5BIdea.5D.20Different.20approach.html#250780396">(Aug 26 2021 at 14:26)</a>:</h4>
<p>I like it, in any case :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>