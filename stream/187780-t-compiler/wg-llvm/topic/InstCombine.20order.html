<html>
<head><meta charset="utf-8"><title>InstCombine order · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/InstCombine.20order.html">InstCombine order</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253723617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/InstCombine%20order/near/253723617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/InstCombine.20order.html#253723617">(Sep 17 2021 at 10:52)</a>:</h4>
<p>I was looking at <a href="https://github.com/rust-lang/rust/pull/88834">https://github.com/rust-lang/rust/pull/88834</a> where <code>(X &amp; 0b1100_0000) == 0b1000_0000</code> is manually optimized to <code>X as i8 &lt; 0b1100_0000</code> and I was wondering if this optimization couldn't be done in LLVM. I made a proof-of-concept patch (<a href="https://github.com/falk-hueffner/llvm-project/commit/6588246b3fbd5a6bba35bb30b56bf102dc3f0bb7">https://github.com/falk-hueffner/llvm-project/commit/6588246b3fbd5a6bba35bb30b56bf102dc3f0bb7</a>) but now I get a test failure in <code>merge-icmp.ll/test2</code>. It seems that this new transformation impedes folding <code>(X &amp; C1) == C2 &amp;&amp; (X &amp; C3) == C4</code>. Is there some way to work around this, like enforcing a different order of transformations?</p>



<a name="253726174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/InstCombine%20order/near/253726174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/InstCombine.20order.html#253726174">(Sep 17 2021 at 11:17)</a>:</h4>
<p>No, it's not possible to control folding order. The only hard guarantee is that InstSimplify runs before InstCombine for a given instruction, but that doesn't help you here. You'd have to adjust other folds to handle the new canonical pattern.</p>



<a name="253728055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/InstCombine%20order/near/253728055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/InstCombine.20order.html#253728055">(Sep 17 2021 at 11:34)</a>:</h4>
<p>I see, thanks. Looks like I might be able to do that by adapting <code>decomposeBitTestICmp</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>