<html>
<head><meta charset="utf-8"><title>Whole Program Devirtualization #68262 · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Whole.20Program.20Devirtualization.20.2368262.html">Whole Program Devirtualization #68262</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261625466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Whole%20Program%20Devirtualization%20%2368262/near/261625466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Whole.20Program.20Devirtualization.20.2368262.html#261625466">(Nov 16 2021 at 11:08)</a>:</h4>
<p>I'm currently working on <a href="https://github.com/rust-lang/rust/issues/68262">#68262</a> and I'm stuck with an annoying problem:</p>
<p>So in order for LLVM to find unused "virtual" functions, you have to add the <a href="https://llvm.org/docs/TypeMetadata.html#vcall-visibility-metadata"><code>!vcall_visibility</code></a> type metadata to vtables and then use the <a href="https://llvm.org/docs/LangRef.html#llvm-type-checked-load-intrinsic"><code>llvm.type.checked.load</code></a> intrinsic to load the functions from the vtable. This I  <a href="https://github.com/rust-lang/rust/compare/master...flip1995:pk-vfe">managed to do</a>.</p>
<p>Now the problem is, that the <code>llvm.type.checked.load</code> intrinsic cannot be lowered to machine code by LLVM. So before lowering to MC, LLVM has to run the <a href="https://llvm.org/doxygen/structllvm_1_1WholeProgramDevirtPass.html">WholeProgramDevirtPass</a> to get rid of those intrinsic calls and replace them with normal <code>load</code>s.</p>
<p>This pass is only enabled during post-link LTO though. So effectively you have to keep LLVM bitcode until linking and then pass that to the linker. I found, that this can be done with the <a href="https://doc.rust-lang.org/rustc/linker-plugin-lto.html"><code>Clinker-plugin-lto</code></a> flag. </p>
<p>But I found that this only works if I compile a single crate without dependencies. When using <code>cargo</code> with <code>RUSTFLAGS="-Clinker-plugin-lto"</code> it will try to lower the dependencies to MC (to produce the rlib) anyway and will therefore fail, since the intrinsic calls are still there.</p>
<p>So my question is: Is there a way to keep LLVM bitcode for all deps and the current crate until the final step where everything is linked together?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>