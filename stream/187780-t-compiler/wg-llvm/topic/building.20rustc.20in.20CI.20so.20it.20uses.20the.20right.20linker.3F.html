<html>
<head><meta charset="utf-8"><title>building rustc in CI so it uses the right linker? · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html">building rustc in CI so it uses the right linker?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271907801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271907801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271907801">(Feb 15 2022 at 00:04)</a>:</h4>
<p>New hurdle today, in the wake of the <code>uwtable</code> attribute changes in LLVM: with my patch applied <a href="https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/8366#61fdb221-c8c7-49b6-8193-29f252ea2dfa">we get a test failure</a> in <code>[run-make] run-make-fulldeps/static-nobundle</code> because <code>gold</code> is using some too-old LLVM bits. Anyone have a pointer to the dance I need to do to convince Rust to use the right linker?</p>



<a name="271974419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271974419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271974419">(Feb 15 2022 at 13:40)</a>:</h4>
<p>I don't get why that tries to read bitcode at all. I don't see any LTO flags.</p>



<a name="271975176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271975176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271975176">(Feb 15 2022 at 13:46)</a>:</h4>
<p>We compile tests with -O by default I think, which likely turns on thinlto iirc?</p>



<a name="271975470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271975470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271975470">(Feb 15 2022 at 13:48)</a>:</h4>
<p>-Clto=false might work, or if you have a better linker I think target.$target has a linker opt in config.toml</p>



<a name="271975841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271975841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271975841">(Feb 15 2022 at 13:51)</a>:</h4>
<p>LTO isn't used by that test: <a href="https://github.com/rust-lang/rust/blob/master/src/test/run-make-fulldeps/static-nobundle/Makefile">https://github.com/rust-lang/rust/blob/master/src/test/run-make-fulldeps/static-nobundle/Makefile</a> Even if it would be, it doesn't use linker plugin LTO, so the linker should never see any bitcode.</p>



<a name="271976019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271976019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271976019">(Feb 15 2022 at 13:52)</a>:</h4>
<p>Wait, it doesn't use <code>-Cembed-bitcode=no</code>, so bitcode is included in the rust object filed. The linket should ignore it though as rustc doesn't enable LTO for the linker.</p>



<a name="271976148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271976148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271976148">(Feb 15 2022 at 13:53)</a>:</h4>
<p>Is it possible that gold unconditionally reads LLVM bitcode?</p>



<a name="271984782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271984782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271984782">(Feb 15 2022 at 14:51)</a>:</h4>
<p>Not sure about that. <span class="user-mention" data-user-id="478017">@Krasimir Georgiev</span> was looking into this and came up with <a href="https://github.com/rust-lang/rust/pull/94023/files">https://github.com/rust-lang/rust/pull/94023/files</a>, which seems a little hacky?</p>



<a name="271985706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/271985706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Krasimir Georgiev <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#271985706">(Feb 15 2022 at 14:57)</a>:</h4>
<p>Hey! It's the system(?) <code>nm</code> that appears to unconditionally try to read LLVM bitcode via an LTO plugin, I guess, and in this case it's not recent enough to pick up the head LLVM changes:<br>
<a href="https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/8380#ef6f41b5-8595-49a6-be37-0eff80e0ccb5/253-740">https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/8380#ef6f41b5-8595-49a6-be37-0eff80e0ccb5/253-740</a><br>
In my PR I try adapting the test the other way around, to use the llvm-nm from the llvm installation that rust itself is based on, which should be able to understand this rustc llvm bitcode. I saw this <code>LLVM_BIN_DIR</code> pattern in a few other run-make-fulldeps tests, e.g., <a href="https://github.com/rust-lang/rust/blob/55697574915ca58c3fcd7b1c854c1c93e002dc85/src/test/run-make-fulldeps/issue-64153/Makefile#L20">https://github.com/rust-lang/rust/blob/55697574915ca58c3fcd7b1c854c1c93e002dc85/src/test/run-make-fulldeps/issue-64153/Makefile#L20</a></p>



<a name="272034999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/272034999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#272034999">(Feb 15 2022 at 20:43)</a>:</h4>
<p>Either approach sounds fine to me.</p>



<a name="272035039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/building%20rustc%20in%20CI%20so%20it%20uses%20the%20right%20linker%3F/near/272035039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/building.20rustc.20in.20CI.20so.20it.20uses.20the.20right.20linker.3F.html#272035039">(Feb 15 2022 at 20:43)</a>:</h4>
<p>Though that does sound like another argument for why we shouldn't be using the <code>.llvmbc</code> section name.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>