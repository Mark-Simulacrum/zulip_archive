<html>
<head><meta charset="utf-8"><title>Weird Codegen for Function Arguments · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html">Weird Codegen for Function Arguments</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274335910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Weird%20Codegen%20for%20Function%20Arguments/near/274335910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html#274335910">(Mar 06 2022 at 23:57)</a>:</h4>
<p>I was thinking about a UCG, and stumbled across this example: <a href="https://godbolt.org/z/heEhEzM7a">https://godbolt.org/z/heEhEzM7a</a>, LLVM IR: <a href="https://godbolt.org/z/dohsxMfaq">https://godbolt.org/z/dohsxMfaq</a> . The codegen makes sense given the output of <code>opt</code>, but the result still seems questionable. I'm not sure what the fix here is though. Could/should rustc be emitting better LLVM IR? Is <code>opt</code> missing an optimization? What would the "correct" LLVM IR even look like?</p>



<a name="274340650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Weird%20Codegen%20for%20Function%20Arguments/near/274340650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html#274340650">(Mar 07 2022 at 01:44)</a>:</h4>
<p>i assume you mean the unnecessary stack-to-stack copy in <code>example::f</code>?<br>
there's nothing that i immediately see wrong with <code>example::check</code></p>



<a name="274340665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Weird%20Codegen%20for%20Function%20Arguments/near/274340665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html#274340665">(Mar 07 2022 at 01:44)</a>:</h4>
<p>if that is what you meant:</p>
<p>the sysv abi (used because we're calling an <code>extern "C"</code> function on x64 linux) requires us to pass that argument on the stack<br>
in order to do this in the general case, the extra stack copy is required, since the argument might not be at the stack position where we need it</p>
<p>potentially, a special case could be added to llvm's x86 backend to avoid the copy when the argument is already in the right place (and either the caller is readonly or the argument is unused after the call?)<br>
but this may be nontrivial</p>
<p>this is not related to ir or middle-end optimizations (<code>opt</code>)<br>
the ir is ~identical for <code>extern "C"</code> and <code>extern "Rust"</code>, except for <code>byval</code> on the argument (which is added specifically for this purpose)<br>
<a href="https://godbolt.org/z/T35j13dWT">https://godbolt.org/z/T35j13dWT</a></p>



<a name="274340670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Weird%20Codegen%20for%20Function%20Arguments/near/274340670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html#274340670">(Mar 07 2022 at 01:44)</a>:</h4>
<p>C-only example: <a href="https://godbolt.org/z/Yc7nY4Eoh">https://godbolt.org/z/Yc7nY4Eoh</a></p>



<a name="274341275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Weird%20Codegen%20for%20Function%20Arguments/near/274341275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html#274341275">(Mar 07 2022 at 01:59)</a>:</h4>
<p>relevant llvm issues:<br>
<a href="https://github.com/llvm/llvm-project/issues/30982">https://github.com/llvm/llvm-project/issues/30982</a><br>
<a href="https://github.com/llvm/llvm-project/issues/14770">https://github.com/llvm/llvm-project/issues/14770</a></p>



<a name="274342158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Weird%20Codegen%20for%20Function%20Arguments/near/274342158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Weird.20Codegen.20for.20Function.20Arguments.html#274342158">(Mar 07 2022 at 02:16)</a>:</h4>
<p>Those issues are interesting, thanks</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>