<html>
<head><meta charset="utf-8"><title>SIMD [iu]8 tests now SIGILL in --release · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html">SIMD [iu]8 tests now SIGILL in --release</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252553079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252553079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252553079">(Sep 09 2021 at 00:16)</a>:</h4>
<p>Issue is: <a href="https://github.com/rust-lang/rust/issues/88769">https://github.com/rust-lang/rust/issues/88769</a><br>
Only happens with optimizations on.</p>



<a name="252553491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252553491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252553491">(Sep 09 2021 at 00:22)</a>:</h4>
<p>Specifically, <code>-Copt-level=2</code> or <code>3</code>, not 1.</p>



<a name="252582799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252582799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252582799">(Sep 09 2021 at 07:30)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="k">fn</span> <span class="nf">horizontal_product</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">LANES</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">test_helpers</span>::<span class="n">test_1</span><span class="p">(</span><span class="o">&amp;|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">test_helpers</span>::<span class="n">prop_assert_biteq</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="cp">$vector</span>::<span class="o">&lt;</span><span class="n">LANES</span><span class="o">&gt;</span>::<span class="n">from_array</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">horizontal_product</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">x</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">copied</span><span class="p">().</span><span class="n">fold</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="cp">$scalar</span><span class="p">,</span><span class="w"> </span><span class="cp">$scalar</span>::<span class="n">wrapping_mul</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">            </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Looks like it is something about this test that causes it to implode.</p>



<a name="252619997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252619997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252619997">(Sep 09 2021 at 12:55)</a>:</h4>
<p>do we have a stack trace? when I hear SIGILL/SIGTRAP/SIGSEGV my intuition is that the code generally makes its way into some branch that has a trap or unreachable in it.</p>



<a name="252620217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252620217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252620217">(Sep 09 2021 at 12:56)</a>:</h4>
<p>ah, in the case LLVM crashes, its generally an assertion triggering of some sort.</p>



<a name="252623584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252623584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252623584">(Sep 09 2021 at 13:18)</a>:</h4>
<p>Does it still happen when simply calling <code>horizontal_product</code>, or is it related to the test as a whole?</p>



<a name="252643944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252643944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252643944">(Sep 09 2021 at 15:19)</a>:</h4>
<p>Well calling the underlying <code>simd_reduce_mul_ordered</code> doesn't seem to do it.</p>



<a name="252645387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252645387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252645387">(Sep 09 2021 at 15:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release/near/252623584">said</a>:</p>
<blockquote>
<p>Does it still happen when simply calling <code>horizontal_product</code>, or is it related to the test as a whole?</p>
</blockquote>
<p>hellow posted a minimization that reproduces the assertion, I believe it is correct. It involves almost the entire test.<br>
<a href="https://github.com/rust-lang/rust/issues/88769#issuecomment-916017553">https://github.com/rust-lang/rust/issues/88769#issuecomment-916017553</a></p>



<a name="252645950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252645950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252645950">(Sep 09 2021 at 15:32)</a>:</h4>
<p>No rustc backtrace, just vibes.</p>



<a name="252650915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/252650915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#252650915">(Sep 09 2021 at 16:01)</a>:</h4>
<p>I genuinely am baffled.</p>



<a name="253180167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/253180167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#253180167">(Sep 14 2021 at 00:15)</a>:</h4>
<p>This remains an issue, seemingly after the submodule merge. Do our nightlies use our in-tree LLVM or do they pull from CI or something?</p>



<a name="253180899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/253180899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#253180899">(Sep 14 2021 at 00:25)</a>:</h4>
<p>nightlies use the current in-tree LLVM submodule hash.</p>



<a name="253181319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/253181319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#253181319">(Sep 14 2021 at 00:30)</a>:</h4>
<p>That is very weird then because the exact hash is after the submodule merge.</p>



<a name="253181436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/253181436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#253181436">(Sep 14 2021 at 00:32)</a>:</h4>
<p>plausible that there were potentially multiple different issues.</p>



<a name="253181773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/253181773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#253181773">(Sep 14 2021 at 00:37)</a>:</h4>
<p>love it, falling out of the optimization tree and hitting every single opt error branch on the way down.</p>



<a name="253182363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/SIMD%20%5Biu%5D8%20tests%20now%20SIGILL%20in%20--release/near/253182363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/SIMD.20.5Biu.5D8.20tests.20now.20SIGILL.20in.20--release.html#253182363">(Sep 14 2021 at 00:46)</a>:</h4>
<p>It's still failing on the same test, so I'm guessing it's a closely related bug, though the original minimal reproduction seems fixed</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>