<html>
<head><meta charset="utf-8"><title>translating multi-crate build into LLVM IR #91671 · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html">translating multi-crate build into LLVM IR #91671</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266438146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438146">(Dec 30 2021 at 15:57)</a>:</h4>
<p>I’ve been trying to dissect a nasty LLVM bug</p>



<a name="266438152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438152">(Dec 30 2021 at 15:57)</a>:</h4>
<p>involving LTO</p>



<a name="266438218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438218">(Dec 30 2021 at 15:58)</a>:</h4>
<p>Issue <a href="https://github.com/rust-lang/rust/issues/91671">#91671</a></p>



<a name="266438249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438249">(Dec 30 2021 at 15:59)</a>:</h4>
<p>Here’s my Question: I’ve got a <a href="https://github.com/pnkfelix/issue-91671-a64-doctestfail/blob/4f2e874fa404ca462e1993c20368ed1629bd2a2c/repro.sh#L9">repro.sh script</a> that involves building three crates. We segfault on the third build.</p>



<a name="266438260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438260">(Dec 30 2021 at 15:59)</a>:</h4>
<p>what I would <em>like</em> is to reduce that into something that I can file with the LLVM folks. I.e. LLVM-IR files</p>



<a name="266438424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438424">(Dec 30 2021 at 16:00)</a>:</h4>
<p>I can do <code>—emit llvm-ir</code> for the first two builds, but I’m not sure what I should do to process that output into something that the third invocation will use</p>



<a name="266438473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438473">(Dec 30 2021 at 16:01)</a>:</h4>
<p>/me looks at the <a href="http://repro.sh">repro.sh</a> script and realizes that he should push the updated version that targets aarch64 Linux rather than Darwin</p>



<a name="266438740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438740">(Dec 30 2021 at 16:05)</a>:</h4>
<p>This topic was moved by <span class="user-mention silent" data-user-id="116083">pnkfelix</span> to <a class="stream-topic" data-stream-id="238009" href="/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bweekly.5D.202021-12-30.20.2354818">#t-compiler/meetings &gt; [weekly] 2021-12-30 #54818</a></p>



<a name="266438813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266438813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266438813">(Dec 30 2021 at 16:06)</a>:</h4>
<p>@_<strong>Notification Bot|100006</strong> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR/near/266438740">said</a>:</p>
<blockquote>
<p>This topic was moved by <span class="user-mention silent" data-user-id="116083">pnkfelix</span> to <a class="stream-topic" data-stream-id="238009" href="/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bweekly.5D.202021-12-30.20.2354818">#t-compiler/meetings &gt; [weekly] 2021-12-30 #54818</a></p>
</blockquote>
<p>(it wasn’t, not really. Its more that I accidentally moved more messages than I intended.)</p>



<a name="266439220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266439220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266439220">(Dec 30 2021 at 16:13)</a>:</h4>
<p>As you are dealing with a backend bug, you should be able to add -C save-temps on the final rustc command and then run all bitcode files through llc and see what crashes.</p>



<a name="266501472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266501472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266501472">(Dec 31 2021 at 12:40)</a>:</h4>
<p>I had a very hard time trying to figure out lto bugs myself too. Anything I would get out of rustc would not reproduce anything with llc anymore.</p>



<a name="266501476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266501476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266501476">(Dec 31 2021 at 12:40)</a>:</h4>
<p>probably because I was invoking llc just very slightly differently or something.</p>



<a name="266501485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/266501485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#266501485">(Dec 31 2021 at 12:40)</a>:</h4>
<p>alas I don't really have any suggestions or advice here <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="268856365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268856365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268856365">(Jan 21 2022 at 15:19)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="133224">@Nikita Popov</span> , if you have time, I’d love to pick your brain to learn how you reduced <a href="https://github.com/llvm/llvm-project/issues/53315">https://github.com/llvm/llvm-project/issues/53315</a></p>



<a name="268856397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268856397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268856397">(Jan 21 2022 at 15:19)</a>:</h4>
<p>/me is going to add a <a href="https://github.com/rust-lang/llvm/issues/53315">llvm#53315</a> rewrite rule now (the link currently generated is rust-lang/llvm/53315)</p>



<a name="268858239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268858239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268858239">(Jan 21 2022 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I added <code>-C save-temps</code> to the last rustc command, then checked that the final bitcode crashes <code>llc -O0</code> and then ran llvm-reduce with <code>! build/bin/llc -O0 -o /dev/null &lt; $1</code> test script. Plus some minimal manual cleanup (function names...)</p>



<a name="268864797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268864797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268864797">(Jan 21 2022 at 16:15)</a>:</h4>
<p>I tried several times to use <code>-C save-temps</code>, but I never identified the correct file to feed into <code>llc</code>. Which one was it that you fed into it?</p>



<a name="268865038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268865038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268865038">(Jan 21 2022 at 16:16)</a>:</h4>
<p>I just realized that you suggested feeding <em>all</em> bitcode files into <code>llc</code> above. (I misread it originally, I think.) So do you just loop through each file in the directory and pass it to <code>llc</code>? Let me see what that does for me now</p>



<a name="268866505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268866505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268866505">(Jan 21 2022 at 16:26)</a>:</h4>
<p>That's what I usually do when I don't know which one it is. In this case I just tried the <code>rcgu.bc</code> one and that worked.</p>



<a name="268866577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268866577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268866577">(Jan 21 2022 at 16:27)</a>:</h4>
<p>Also, Florian Hahn on the LLVM side suggested this nice little trick: Add a call to <code>F.getParent()-&gt;dump()</code> to the start of <code>SafeStackLegacyPass::runOnFunction</code> (in llvm/lib/CodeGen/SafeStack.cpp), and that will spit out the .ll content that was fed into that pass.</p>



<a name="268866689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268866689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268866689">(Jan 21 2022 at 16:28)</a>:</h4>
<p>I just now used the output of that dump, and fed it into <code>llc -O0</code> like you said, and it also reproduced the problem. So I’m thrilled. Thanks <span class="user-mention" data-user-id="133224">@Nikita Popov</span> for all your help here!</p>



<a name="268866888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268866888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268866888">(Jan 21 2022 at 16:29)</a>:</h4>
<p>(so now I have two ways to go about this. I’m going to see about putting this info into the rustc-dev-guide in some fashion.)</p>



<a name="268866892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268866892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268866892">(Jan 21 2022 at 16:30)</a>:</h4>
<p>maybe you can do that with this option?</p>
<div class="codehilite"><pre><span></span><code>--print-before=&lt;string&gt; - Print IR before specified passes
</code></pre></div>

<p>e.g. passed via <code>-Cllvm-args=--print-before=...</code></p>



<a name="268867068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268867068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268867068">(Jan 21 2022 at 16:31)</a>:</h4>
<p>For backend crashes you usually don't need anything fancy, as they tend to reduce cleanly. It's a bit more tricky for the middle-end, because you need to reduce both the test case and the optimization pipeline.</p>



<a name="268867246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268867246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268867246">(Jan 21 2022 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> Main problem with -print is that it only prints the IR unit the pass runs on, so you get just the function, without any referenced declarations, globals, metadata etc. Adding a manual dump call can be easier to get the whole module :) Probably that should be exposed by some flag...</p>



<a name="268867330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/268867330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#268867330">(Jan 21 2022 at 16:32)</a>:</h4>
<p>Yes, I wasn’t able to feed the output of <code>-print</code> just now to reproduce the problem. But I agree with <span class="user-mention" data-user-id="133224">@Nikita Popov</span> , this seems like a potentially useful variant to add to llvm</p>



<a name="269437599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269437599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269437599">(Jan 26 2022 at 16:16)</a>:</h4>
<p>Hey, <span class="user-mention" data-user-id="133224">@Nikita Popov</span> , when you were looking at <a href="https://github.com/llvm/llvm-project/issues/53315">llvm#53315</a>, did you try your patched build against my repro? I ask because I finally have gotten around to cherry-picking the patch, and I’m still seeing <em>a</em> segfault (though it could well have a different root cause).</p>



<a name="269439050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269439050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269439050">(Jan 26 2022 at 16:25)</a>:</h4>
<p>Nope, I didn't try to bootstrap rustc with that. A compiler segfault or at runtime?</p>



<a name="269439643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269439643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269439643">(Jan 26 2022 at 16:29)</a>:</h4>
<p>Compiler segfault</p>



<a name="269439663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269439663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269439663">(Jan 26 2022 at 16:29)</a>:</h4>
<p>or, well, maybe linker, need to check</p>



<a name="269439670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269439670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269439670">(Jan 26 2022 at 16:29)</a>:</h4>
<p>but not at runtime</p>



<a name="269439753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269439753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269439753">(Jan 26 2022 at 16:29)</a>:</h4>
<p>Anyway, I just wanted to see if you had evidence to contrary before I spent more time on it</p>



<a name="269440032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269440032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269440032">(Jan 26 2022 at 16:31)</a>:</h4>
<p>I just tried my LLVM trunk llc against the original bitcode file and that at least doesn't crash anymore.</p>



<a name="269440108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269440108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269440108">(Jan 26 2022 at 16:31)</a>:</h4>
<p>I’ll come back around in here when I have more info. I’m doing a Debug build of LLVM now to feed into it.</p>



<a name="269447056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269447056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269447056">(Jan 26 2022 at 17:14)</a>:</h4>
<p>Oh, <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span> , I didn’t do the cherry-pick correctly</p>



<a name="269447094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269447094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269447094">(Jan 26 2022 at 17:14)</a>:</h4>
<p>(or rather, I cherry-picked, but then the build automatically moved back to the previous commit.)</p>



<a name="269449426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269449426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269449426">(Jan 26 2022 at 17:29)</a>:</h4>
<p>Okay, build of my repro is now failing with a more reasonable error during link: </p>
<div class="codehilite"><pre><span></span><code>error: linking with `cc` failed: exit status: 1
  |
  = note: &quot;cc&quot; &quot;/tmp/rust_out2.dir/demo.demo.f366c950-cgu.0.rcgu.o&quot; &quot;-Wl,--as-needed&quot; &quot;-L&quot; &quot;/tmp/deps&quot; &quot;-L&quot; &quot;/tmp/deps&quot; &quot;-L&quot; &quot;/media/pnkfelix/Rust/i\
ssue_91671/rust-91671/objdir-dbgopt/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/aarch64-unknown-linux-gnu/lib&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-znoe\
xecstack&quot; &quot;-L&quot; &quot;/media/pnkfelix/Rust/issue_91671/rust-91671/objdir-dbgopt/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/aarch64-unknown-linux-gn\
u/lib&quot; &quot;-o&quot; &quot;/tmp/rust_out2.dir/demo&quot; &quot;-Wl,--gc-sections&quot; &quot;-pie&quot; &quot;-Wl,-zrelro,-znow&quot; &quot;-nodefaultlibs&quot;
  = note: /usr/bin/ld: /tmp/rust_out2.dir/demo.demo.f366c950-cgu.0.rcgu.o: Relocations in generic ELF (EM: 183)
          /usr/bin/ld: /tmp/rust_out2.dir/demo.demo.f366c950-cgu.0.rcgu.o: Relocations in generic ELF (EM: 183)
          /usr/bin/ld: /tmp/rust_out2.dir/demo.demo.f366c950-cgu.0.rcgu.o: Relocations in generic ELF (EM: 183)
          /usr/bin/ld: /tmp/rust_out2.dir/demo.demo.f366c950-cgu.0.rcgu.o: error adding symbols: file in wrong format
          collect2: error: ld returned 1 exit status
</code></pre></div>



<a name="269449477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269449477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269449477">(Jan 26 2022 at 17:29)</a>:</h4>
<p>(so, sorry for the noise. My mistake.)</p>



<a name="269582389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269582389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269582389">(Jan 27 2022 at 14:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671/near/269447094">said</a>:</p>
<blockquote>
<p>(or rather, I cherry-picked, but then the build automatically moved back to the previous commit.)</p>
</blockquote>
<p>The usual x.py submodules footgun <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="269681986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269681986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269681986">(Jan 28 2022 at 03:30)</a>:</h4>
<p>yep. So now I've posted a note to the rustc-dev-guide about it: <a href="https://github.com/rust-lang/rustc-dev-guide/pull/1291/files">https://github.com/rust-lang/rustc-dev-guide/pull/1291/files</a></p>



<a name="269682020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269682020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269682020">(Jan 28 2022 at 03:31)</a>:</h4>
<p>and expanded the dev-guide's treatment on debugging LLVM: <a href="https://github.com/rust-lang/rustc-dev-guide/pull/1290">https://github.com/rust-lang/rustc-dev-guide/pull/1290</a></p>



<a name="269682095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/269682095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#269682095">(Jan 28 2022 at 03:32)</a>:</h4>
<p>and, finally, I tested the cherry-pick on my M1. It resolves the problem, so I'm proposing we backport it to our LLVM fork: <a href="https://github.com/rust-lang/llvm-project/pull/129">https://github.com/rust-lang/llvm-project/pull/129</a></p>



<a name="270469773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/270469773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#270469773">(Feb 02 2022 at 22:35)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="133224">@Nikita Popov</span> , regarding the <a href="https://github.com/rust-lang/rust/pull/93426#issuecomment-1024299821">CI failure</a> on <a href="https://github.com/rust-lang/rust/issues/93426">#93426</a>: is that a known intermittent issue with <code>compiletest</code> or something else?</p>



<a name="270474712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/translating%20multi-crate%20build%20into%20LLVM%20IR%20%2391671/near/270474712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/translating.20multi-crate.20build.20into.20LLVM.20IR.20.2391671.html#270474712">(Feb 02 2022 at 23:19)</a>:</h4>
<p>The CI failure looks like <a href="https://github.com/rust-lang/rust/issues/93384">#93384</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>