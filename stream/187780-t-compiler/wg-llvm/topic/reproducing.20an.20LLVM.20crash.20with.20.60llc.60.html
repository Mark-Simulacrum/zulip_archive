<html>
<head><meta charset="utf-8"><title>reproducing an LLVM crash with `llc` · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html">reproducing an LLVM crash with `llc`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259533994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259533994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259533994">(Oct 29 2021 at 14:41)</a>:</h4>
<p>I've got some code which I'm testing out compiling to wasm64 which is crashing in LLVM. I've narrowed it down to the production of debuginfo, and I'm trying to get a file to report to upstream LLVM. To that end I've got a bitcode file from LLVM (via <code>-C save-temps</code>) which I believe is the bitcode that rustc is using to generate the object, and then the object file is zero bytes which I believe confirms the behavior where it's crashing creating the object file.</p>
<p>Unfortunately though I can't get <code>llc</code> to crash. Historically I've had to fiddle with various options to <code>llc</code> to get it to crash as well to ensure it's running with the same settings that rustc configures, but I was curious if others know of any tips/tricks to get <code>llc</code> to crash in the same way as llvm-as-invoked-by-<code>rustc</code>? Or otherwise does anyone know if debuginfo passes various options behind the scenes to LLVM and/or how to configure llc to produce debuginfo the same way as the compiler?</p>



<a name="259535637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259535637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259535637">(Oct 29 2021 at 14:53)</a>:</h4>
<p>Is this an unoptimized build? Note that llc defaults to <code>-O2</code>, so you have to pass <code>-O0</code> explicitly.</p>



<a name="259535806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259535806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259535806">(Oct 29 2021 at 14:54)</a>:</h4>
<p>yeah this is an unoptimized rust build that crashes and unfortunately <code>-O0</code> to llc doesn't seem to help</p>



<a name="259535846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259535846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259535846">(Oct 29 2021 at 14:54)</a>:</h4>
<p>the specific bug is that a relocation is being generated in rustc which crashes, but w/e I do I can't seem to get llc to generate the same relocation</p>



<a name="259535889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259535889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259535889">(Oct 29 2021 at 14:55)</a>:</h4>
<p><code>-filetype=obj</code> maybe relevant if the crash is in the MC layer</p>



<a name="259535906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259535906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259535906">(Oct 29 2021 at 14:55)</a>:</h4>
<p>yeah   that's there too :(</p>



<a name="259536044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259536044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259536044">(Oct 29 2021 at 14:56)</a>:</h4>
<p>the relevant rustc reproduction bits are <code>-C embed-bitcode=no -C debuginfo=1 --target wasm64-unknown-unknown -C codegen-units=1</code>, and the llc args so far are <code>-filetype=obj -o foo.o -O0</code></p>



<a name="259536078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259536078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259536078">(Oct 29 2021 at 14:56)</a>:</h4>
<p>I've tried lots of other flags to llc like <code>--relocation-model=static</code> but nothing seems to do the trick</p>



<a name="259536476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259536476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259536476">(Oct 29 2021 at 14:59)</a>:</h4>
<p>Hm, then I don't know ^^ LLVMRustCreateTargetMachine has the custom options that should be relevant for the llc context.</p>



<a name="259536791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259536791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259536791">(Oct 29 2021 at 15:01)</a>:</h4>
<p>If you're already set code and relocation model, I'm not sure what else would be relevant here</p>



<a name="259537223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259537223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259537223">(Oct 29 2021 at 15:04)</a>:</h4>
<p>yeah going as far as <code>-filetype=obj -o foo.o -O0 --relocation-model=static --mattr=+bulk-memory,+mutable-globals,+sign-ext,+nontrapping-fptoint --trap-unreachable -mcpu=generic -mtriple=wasm64-unknown-unknown --thread-model=single --code-model=medium</code> even doesn't seem to get llc to crash... well in any case I'll keep poking or otherwise just skip debuginfo for now and hope it gets fixed at some point upstream</p>



<a name="259919869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/reproducing%20an%20LLVM%20crash%20with%20%60llc%60/near/259919869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/reproducing.20an.20LLVM.20crash.20with.20.60llc.60.html#259919869">(Nov 01 2021 at 20:54)</a>:</h4>
<p>it took me way too long to find this but it was <code>-generate-arange-section</code>, that argument causes llc to crash</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>