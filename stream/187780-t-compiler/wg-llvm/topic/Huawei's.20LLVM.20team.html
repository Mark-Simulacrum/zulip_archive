<html>
<head><meta charset="utf-8"><title>Huawei&#x27;s LLVM team · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html">Huawei&#x27;s LLVM team</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255995695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/255995695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#255995695">(Oct 04 2021 at 01:50)</a>:</h4>
<p>I've talked to Huawei's LLVM team and they are interested in helping out the Rust project. However they don't have a clear idea of what kind of help they could provide. They would like us to identify 5-10 issues as starting points for areas where they can contribute.</p>



<a name="255998975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/255998975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#255998975">(Oct 04 2021 at 02:44)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="239881">@Josh Triplett</span></p>



<a name="256035753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256035753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256035753">(Oct 04 2021 at 10:22)</a>:</h4>
<p>From my own backburner, a couple that come to mind and aren't Rust specific: better lowering for signed integer multiplication with overflow; bringing the LKK strength reduction for division/modulo over the finish line; fixing (where its implemented) or implementing inline-asm stack probes; <code>loop { match { ... } }</code> not becoming a straightforward state machine (<a href="https://github.com/rust-lang/rust/issues/80630">https://github.com/rust-lang/rust/issues/80630</a>) etc.</p>
<p>Lowerings and strength reductions also need to be extended to work within vectors and for non-native integer sizes. e.g. right now dividing <code>x / 10u128</code> will not replace the division with multiplications and shifts, even though LLVM is perfectly capable of this for <code>u32</code> for instance.</p>
<p><a href="https://github.com/rust-lang/rust/issues/72356">https://github.com/rust-lang/rust/issues/72356</a> sounds fun.</p>



<a name="256127232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256127232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256127232">(Oct 04 2021 at 20:27)</a>:</h4>
<p>could the various issues with the <code>NonZero</code> types be worthwhile to look at, you think ? there are a bunch of them, <a href="https://github.com/rust-lang/rust/issues/49572">#49572</a> <a href="https://github.com/rust-lang/rust/issues/51346">#51346</a> or <a href="https://github.com/rust-lang/rust/issues/49892">#49892</a>. (they seemed not exactly trivial to solve, but at the same time, maybe the gain wouldn't be worth the work)</p>



<a name="256157990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256157990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256157990">(Oct 05 2021 at 00:50)</a>:</h4>
<p>Maybe some form of <a href="https://github.com/rust-lang/rust/issues/85133">#85133</a>? That affects codegen for the<code>?</code> operator, which is currently subpar. There's some analysis re: LLVM in  <a href="https://github.com/rust-lang/rust/issues/85133#issuecomment-904185574">https://github.com/rust-lang/rust/issues/85133#issuecomment-904185574</a>, though I don't know how accurate it is.</p>



<a name="256173065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256173065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256173065">(Oct 05 2021 at 03:54)</a>:</h4>
<p>mostly joking: they could bang up GlobalISel on x86_64 so we can use it instead of trying and failing to use FastISel</p>



<a name="256174776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256174776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256174776">(Oct 05 2021 at 04:15)</a>:</h4>
<p>I'd love to see support for automatically handling the interaction between reserved registers and inline assembly, so that it's possible to safely use registers that <em>might</em> be reserved in certain configurations but aren't in the current configuration.</p>



<a name="256174833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256174833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256174833">(Oct 05 2021 at 04:16)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/85056">https://github.com/rust-lang/rust/issues/85056</a></p>



<a name="256340520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256340520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256340520">(Oct 06 2021 at 00:33)</a>:</h4>
<p>cc: <span class="user-mention" data-user-id="120791">@RalfJ</span> , who always seems to have a laundry list of LLVM issues caused by mishandling or incomplete treatment of pointer provenance. I think there are at least 2 or 3 open tracked bugs here, last I checked, although I'm not sure how actionable they all are.</p>



<a name="256439105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256439105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256439105">(Oct 06 2021 at 16:16)</a>:</h4>
<p>in general, they could join the LLVM notification group:<br>
<a href="https://rustc-dev-guide.rust-lang.org/notification-groups/about.html#join">https://rustc-dev-guide.rust-lang.org/notification-groups/about.html#join</a></p>



<a name="256674655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256674655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256674655">(Oct 08 2021 at 01:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/Huawei's.20LLVM.20team/near/256340520">said</a>:</p>
<blockquote>
<p>cc: <span class="user-mention silent" data-user-id="120791">RalfJ</span> , who always seems to have a laundry list of LLVM issues caused by mishandling or incomplete treatment of pointer provenance. I think there are at least 2 or 3 open tracked bugs here, last I checked, although I'm not sure how actionable they all are.</p>
</blockquote>
<p>yeah, that would be for example <a href="https://bugs.llvm.org/show_bug.cgi?id=34548">https://bugs.llvm.org/show_bug.cgi?id=34548</a>, <a href="https://bugs.llvm.org/show_bug.cgi?id=35229">https://bugs.llvm.org/show_bug.cgi?id=35229</a>. However, these are pretty deep conceptual issues; ultimately this is about pinning down the details of the LLVM memory model (not the concurrency parts, but the sequential parts, and provenance specifically).</p>



<a name="256674692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/256674692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#256674692">(Oct 08 2021 at 01:17)</a>:</h4>
<p>also if they have any capacity to help with the long-running slow-moving effort of killing undef and spreading poison, that would help a lot to establish solid foundations for LLVM language semantics</p>



<a name="257420506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/257420506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#257420506">(Oct 13 2021 at 19:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/Huawei's.20LLVM.20team/near/256127232">said</a>:</p>
<blockquote>
<p>could the various issues with the <code>NonZero</code> types be worthwhile to look at, you think ? there are a bunch of them, <a href="https://github.com/rust-lang/rust/issues/49572">#49572</a> <a href="https://github.com/rust-lang/rust/issues/51346">#51346</a> or <a href="https://github.com/rust-lang/rust/issues/49892">#49892</a>. (they seemed not exactly trivial to solve, but at the same time, maybe the gain wouldn't be worth the work)</p>
</blockquote>
<p>These being non-trivial seems like it'd make them a good candidate for an experienced team to look at.  My recollection is that the problem was that there isn't a place in the instructions to preserve the information, and that sounds like the kind of bigger change that would be nearly impossible for someone new to LLVM to do holistically.</p>



<a name="258244899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/258244899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#258244899">(Oct 19 2021 at 18:06)</a>:</h4>
<p>(Basically what Dylan mentioned, but phrased more generally)</p>
<p>It'd be great to get some extra smarts around discriminant preservation paths.  <a href="https://github.com/rust-lang/rust/issues/88616#issuecomment-913877197">https://github.com/rust-lang/rust/issues/88616#issuecomment-913877197</a> has a nice simple example.  Something like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">baz</span><span class="p">(</span><span class="n">x</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">y</span><span class="o">|</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Does an unnecessary icmp+xor+zext / test+setne (&lt;<a href="https://rust.godbolt.org/z/5EhEEfPxq">https://rust.godbolt.org/z/5EhEEfPxq</a>&gt;) to copy over the discriminant when it could just be kept directly.</p>
<p>I think an improvement here could potentially help basically everything that returns Option/Result, so could be a pervasive win (albeit small in each place).</p>



<a name="262083541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262083541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262083541">(Nov 19 2021 at 15:46)</a>:</h4>
<p>Another item, which came up regarding the Rust in the Linux kernel effort:<br>
<a href="https://rust.godbolt.org/z/7rqfbj58b">https://rust.godbolt.org/z/7rqfbj58b</a><br>
The compiler should be able to fold that all down to a constant <code>10</code>, but it can't figure out that the unwrap can never panic.</p>



<a name="262084073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262084073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262084073">(Nov 19 2021 at 15:49)</a>:</h4>
<p><code>unwrap_unchecked</code> makes it efficient, but that shouldn't be necessary.</p>



<a name="262084167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262084167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262084167">(Nov 19 2021 at 15:49)</a>:</h4>
<p><code>-C panic=abort</code> also makes it efficient.</p>



<a name="262084868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262084868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262084868">(Nov 19 2021 at 15:54)</a>:</h4>
<p>But it'd be nice if some combination of rustc and LLVM could manage to constant-fold this even when <code>panic=unwind</code>.</p>



<a name="262086636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262086636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262086636">(Nov 19 2021 at 16:05)</a>:</h4>
<p>random drive-by-comment but this looks like perhaps a codegen issue with rustc:</p>



<a name="262086918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262086918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262086918">(Nov 19 2021 at 16:06)</a>:</h4>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code>  <span class="nv">%_3</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i64</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
<span class="c">;; ...</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">bitcast</span> <span class="kt">i64</span><span class="p">*</span> <span class="nv">%_3</span> <span class="k">to</span> <span class="kt">i32</span><span class="p">*</span>
  <span class="k">store</span> <span class="kt">i32</span> <span class="m">1</span><span class="p">,</span> <span class="kt">i32</span><span class="p">*</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
<span class="c">;; ...</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i64</span><span class="p">,</span> <span class="kt">i64</span><span class="p">*</span> <span class="nv">%_3</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv">%tmp.sroa.0.0.extract.trunc.i.i.i</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%3</span> <span class="k">to</span> <span class="kt">i32</span>
  <span class="nv">%switch.i</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="kt">i32</span> <span class="nv">%tmp.sroa.0.0.extract.trunc.i.i.i</span><span class="p">,</span> <span class="m">0</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv">%switch.i</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb1.i</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb2</span>
</code></pre></div>
<p>this is allocating an <code>i64</code> temporary, storing 32-bits to it, loading 64-bits, then truncating back to 32-bits. LLVM is most likely getting confused about the 32-bit store and the 64-bit load and realizing it can't propagate there</p>



<a name="262088845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262088845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262088845">(Nov 19 2021 at 16:18)</a>:</h4>
<p>Oh, interesting! If I change u32 to u64 everywhere in the above godbolt example, it all constant-folds away.</p>



<a name="262088898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262088898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262088898">(Nov 19 2021 at 16:19)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="458794">@Wedson Almeida Filho</span> <span class="user-mention" data-user-id="382653">@ojeda</span></p>



<a name="262102337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262102337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262102337">(Nov 19 2021 at 17:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/Huawei's.20LLVM.20team/near/262083541">said</a>:</p>
<blockquote>
<p>Another item, which came up regarding the Rust in the Linux kernel effort:<br>
<a href="https://rust.godbolt.org/z/7rqfbj58b">https://rust.godbolt.org/z/7rqfbj58b</a><br>
The compiler should be able to fold that all down to a constant <code>10</code>, but it can't figure out that the unwrap can never panic.</p>
</blockquote>
<p>That looks like it might be related to what morse also suggested &lt;<a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/Huawei's.20LLVM.20team/near/256157990">https://rust-lang.zulipchat.com/#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/Huawei's.20LLVM.20team/near/256157990</a>&gt; -- just at const-fold time instead of run-time.</p>
<p>Part of the problem with it is that LLVM (as I understand it) currently insists on that <code>icmp</code> even when we annotate the load as already only ever being <code>0</code> or <code>1</code>.</p>
<p>Related: I'm surprised that there's no <code>trunc exact</code> the way there's <code>[su]div exact</code> and <code>[lr]shr exact</code>, to help tell the optimizer that the it doesn't need to mask when emitting it.</p>



<a name="262173119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Huawei%27s%20LLVM%20team/near/262173119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Huawei&#x27;s.20LLVM.20team.html#262173119">(Nov 20 2021 at 09:16)</a>:</h4>
<p>I reported <a href="https://bugs.llvm.org/show_bug.cgi?id=52568">https://bugs.llvm.org/show_bug.cgi?id=52568</a> for the store/load forwarding issue. Not sure on the best way to fix that.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>