<html>
<head><meta charset="utf-8"><title>codegen regression from intrinsics::unreachable/llvm.assume · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/codegen.20regression.20from.20intrinsics.3A.3Aunreachable.2Fllvm.2Eassume.html">codegen regression from intrinsics::unreachable/llvm.assume</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267674717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/codegen%20regression%20from%20intrinsics%3A%3Aunreachable/llvm.assume/near/267674717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/codegen.20regression.20from.20intrinsics.3A.3Aunreachable.2Fllvm.2Eassume.html#267674717">(Jan 12 2022 at 02:16)</a>:</h4>
<p>For fun, I've been sprinkling some <code>if !(precondition) { intrinsics::unreachable() }</code> around the standard library. I just did <code>slice::from_raw_parts</code>/<code>slice::from_raw_parts_mut</code> and broke the two codegen tests, <code>vec-optimizes-away</code> and <code>slice-as-chunks</code>. The IR with my changes is a bit surprising. For example:</p>
<div class="codehilite"><pre><span></span><code>_RNvNtCs3auNwKs0KWq_5alloc5alloc15exchange_malloc.exit: ; preds = %start
  %_17.i.i.i.i.i.i.i.i.i.i.i = ptrtoint i8* %0 to i64
  %pmoda.i.i.i.i.i.i.i.i.i.i.i = and i64 %_17.i.i.i.i.i.i.i.i.i.i.i, 3
  %.not.i.i.i.i.i.i = icmp eq i64 %pmoda.i.i.i.i.i.i.i.i.i.i.i, 0
  tail call void @llvm.assume(i1 %.not.i.i.i.i.i.i) #5
  tail call void @__rust_dealloc(i8* nonnull %0, i64 12, i64 4) #5, !noalias !2
  ret i32 6
}
</code></pre></div>
<p>I'm pretty sure that's the codegen for <code>intrinsics::is_aligned_and_not_null</code>. It is surprising to me that I was able to put do a similar procedure to nearly every other <code>unsafe fn</code> with preconditions that are possible to detect at runtime in <code>core</code> and I didn't see a codegen regression.</p>
<p>I see that the LangRef says this</p>
<blockquote>
<p>Note that the optimizer might limit the transformations performed on values used by the llvm.assume intrinsic in order to preserve the instructions only used to form the intrinsic’s input argument.<br>
Is that what's going on here? Does <code>llvm.assume</code> have to be used very sparingly to not produce a regression? Or would the extra IR in these tests I broke be removed in codegen?</p>
</blockquote>



<a name="267691775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/codegen%20regression%20from%20intrinsics%3A%3Aunreachable/llvm.assume/near/267691775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/codegen.20regression.20from.20intrinsics.3A.3Aunreachable.2Fllvm.2Eassume.html#267691775">(Jan 12 2022 at 08:01)</a>:</h4>
<p>Yes, llvm.assume needs to be used sparingly. It's a tradeoff, not a universal win. Using it for alignment assumptions is a particularly bad idea.</p>



<a name="267806982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/codegen%20regression%20from%20intrinsics%3A%3Aunreachable/llvm.assume/near/267806982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> (Saethlin) Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/codegen.20regression.20from.20intrinsics.3A.3Aunreachable.2Fllvm.2Eassume.html#267806982">(Jan 13 2022 at 00:13)</a>:</h4>
<p>That's unfortunate, but at least the tests are doing their job :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>