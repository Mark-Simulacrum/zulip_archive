<html>
<head><meta charset="utf-8"><title>adapt for llvm Canonicalize SPF to min/max intrinsics · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html">adapt for llvm Canonicalize SPF to min/max intrinsics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273081599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273081599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Krasimir Georgiev <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273081599">(Feb 24 2022 at 12:21)</a>:</h4>
<p><span class="user-mention" data-user-id="133224">@Nikita Popov</span> it seems we'll need to adapt rust for <a href="https://github.com/llvm/llvm-project/commit/a266af721153fab6452094207b09ed265ab0be7b">https://github.com/llvm/llvm-project/commit/a266af721153fab6452094207b09ed265ab0be7b</a> <code>[InstCombine] Canonicalize SPF to min/max intrinsics</code>: <a href="https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/8593#2d586d37-6393-4994-86b4-f35d49a6802c/631-633">https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/8593#2d586d37-6393-4994-86b4-f35d49a6802c/631-633</a></p>



<a name="273608250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273608250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Krasimir Georgiev <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273608250">(Mar 01 2022 at 09:00)</a>:</h4>
<p>Assuming the new LLVM behavior is correct [it became more clever], what would be the course of action to adapt the tests? Do we have a mechanism to say "run this codegen test only if LLVM version is &lt;=X"?</p>



<a name="273632806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273632806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273632806">(Mar 01 2022 at 12:32)</a>:</h4>
<p>We don't really want to have any tests that gate on old LLVM versions. That's a recipe for tests that eventually get never run.</p>



<a name="273643348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273643348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273643348">(Mar 01 2022 at 13:53)</a>:</h4>
<p>Yeah, I feel that. Maybe I can try and make the CHECK line sufficiently fancy to accept either form?</p>



<a name="273684535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273684535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273684535">(Mar 01 2022 at 18:06)</a>:</h4>
<p>I think something like this would be fine: <a href="https://gist.github.com/nikic/5cde11abd3e4fc85e95a85ac93f86c11">https://gist.github.com/nikic/5cde11abd3e4fc85e95a85ac93f86c11</a></p>



<a name="273686630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273686630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273686630">(Mar 01 2022 at 18:21)</a>:</h4>
<p>Actually, having thought about this again, I would be okay with <code>max-llvm-version</code> annotation if it is in a test revision where we have another revision with equivalent <code>min-llvm-version</code>.</p>



<a name="273686710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273686710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273686710">(Mar 01 2022 at 18:21)</a>:</h4>
<p>revisions right now act a lot like <code>must_pass(all(revisions))</code> whereas we really want <code>must_pass(any(revisions))</code> kinda thing for this.</p>



<a name="273687007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273687007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273687007">(Mar 01 2022 at 18:23)</a>:</h4>
<p>for forward-looking llvm-master stuff, having a min/max-llvm pair sounds great</p>



<a name="273687190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273687190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273687190">(Mar 01 2022 at 18:24)</a>:</h4>
<p>once it hits rust-llvm, we can possibly drop the older one, but we might as well keep it for compat testing anyway</p>



<a name="273704921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273704921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273704921">(Mar 01 2022 at 20:25)</a>:</h4>
<p>Looking at this some more, an <code>icmp ugt</code> and <code>select</code> get replaced with a <code>tail call llvm.umax.i64(...)</code> which seems virtuous. Is it sufficient for the spirit of the test to look only for the <code>icmp ugt</code> or <code>tail call llvm.umax.i64</code> and ignore the <code>select</code> entirely? I think so, but I'm not quite confident enough to send a patch.</p>



<a name="273707046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273707046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273707046">(Mar 01 2022 at 20:42)</a>:</h4>
<p><a href="https://github.com/durin42/rust/commit/2c072ac0a9295dee65470731225c3855eac6083a">https://github.com/durin42/rust/commit/2c072ac0a9295dee65470731225c3855eac6083a</a> is what I've written. If I don't hear any screaming I guess I'll send it as a PR?</p>



<a name="273708620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273708620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273708620">(Mar 01 2022 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="316805">@durin42</span> You also need a CHECK-NOT line for umax.</p>



<a name="273708819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273708819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273708819">(Mar 01 2022 at 20:57)</a>:</h4>
<p>Oh shucks I forgot to put that in the commit but wrote it locally. I'll add that. Otherwise may as well send the PR?</p>



<a name="273709071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273709071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273709071">(Mar 01 2022 at 20:58)</a>:</h4>
<p>Yeah</p>



<a name="273709242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273709242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273709242">(Mar 01 2022 at 21:00)</a>:</h4>
<p>Thanks!</p>



<a name="273709565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/adapt%20for%20llvm%20Canonicalize%20SPF%20to%20min/max%20intrinsics/near/273709565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/adapt.20for.20llvm.20Canonicalize.20SPF.20to.20min.2Fmax.20intrinsics.html#273709565">(Mar 01 2022 at 21:01)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/94496">https://github.com/rust-lang/rust/pull/94496</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>