<html>
<head><meta charset="utf-8"><title>LLVM HEAD DWARF validation failures · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html">LLVM HEAD DWARF validation failures</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260059722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260059722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260059722">(Nov 02 2021 at 21:22)</a>:</h4>
<p>"Fun" Rust integration failure at HEAD: <a href="https://github.com/llvm/llvm-project/commit/7c3fa5278544d3830838148ac912cc4b927d1b5b">https://github.com/llvm/llvm-project/commit/7c3fa5278544d3830838148ac912cc4b927d1b5b</a> broke a handful of tests (<a href="https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/5854#e1a004b6-7437-4d10-8ea9-410fa054fe35">https://buildkite.com/llvm-project/rust-llvm-integrate-prototype/builds/5854#e1a004b6-7437-4d10-8ea9-410fa054fe35</a>) for Rust code, mercifully covered by some codegen tests. Anyone have any idea if this requires rust codegen changes to make LLVM happy, or is the validator encoding too many C++ assumptions?</p>



<a name="260060558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260060558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260060558">(Nov 02 2021 at 21:30)</a>:</h4>
<p>what is an "ODR" type?</p>



<a name="260060836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260060836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260060836">(Nov 02 2021 at 21:33)</a>:</h4>
<p>I think it's a one-definition-rule thing? That's the only ODR I know in C++</p>



<a name="260060946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260060946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260060946">(Nov 02 2021 at 21:34)</a>:</h4>
<p>ah yeah.</p>
<blockquote>
<p>linkonce_odr, weak_odr<br>
   Some languages allow differing globals to be merged, such as two functions with different semantics. Other languages, such as C++, ensure that only equivalent globals are ever merged (the “one definition rule” — “ODR”). Such languages can use the linkonce_odr and weak_odr linkage types to indicate that the global will only be merged with equivalent globals. These linkage types are otherwise the same as their non-odr versions.</p>
</blockquote>



<a name="260062784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260062784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260062784">(Nov 02 2021 at 21:52)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
<p>First Error</p>
</div><div class="spoiler-content" aria-hidden="true">
<blockquote>
<hr>
<p>enum type is not a scope; check enum type ODR violation<br>
!45 = !DICompositeType(tag: DW_TAG_enumeration_type, name: "Result", scope: !46, file: !2, baseType: !48, size: 8, align: 8, flags: DIFlagEnumClass, elements: !49)<br>
!9112 = distinct !DISubprogram(name: "expect&lt;(), core::fmt::Error&gt;", linkageName: "_ZN4core6result19Result$LT$T$C$E$GT$6expect17he26f9fa8a8ad40e5E", scope: !45, file: !1564, line: 1252, type: !9113, scopeLine: 1252, flags: DIFlagPrototyped, spFlags: DISPFlagLocalToUnit | DISPFlagDefinition, unit: !42, templateParams: !9122, retainedNodes: !9115)<br>
enum type is not a scope; check enum type ODR violation<br>
!45 = !DICompositeType(tag: DW_TAG_enumeration_type, name: "Result", scope: !46, file: !2, baseType: !48, size: 8, align: 8, flags: DIFlagEnumClass, elements: !49)<br>
!9112 = distinct !DISubprogram(name: "expect&lt;(), core::fmt::Error&gt;", linkageName: "_ZN4core6result19Result$LT$T$C$E$GT$6expect17he26f9fa8a8ad40e5E", scope: !45, file: !1564, line: 1252, type: !9113, scopeLine: 1252, flags: DIFlagPrototyped, spFlags: DISPFlagLocalToUnit | DISPFlagDefinition, unit: !42, templateParams: !9122, retainedNodes: !9115)<br>
LLVM ERROR: Broken module found, compilation aborted!</p>
</blockquote>
</div></div>
<div class="spoiler-block"><div class="spoiler-header">
<p>Heavily Edited Head and Tail of Second Error</p>
</div><div class="spoiler-content" aria-hidden="true">
<blockquote>
<p>failed to decode compiler output as json:</p>
<p>line:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="nt">"message"</span><span class="p">:</span><span class="s2">"`m` is ambiguous"</span><span class="p">,</span><span class="nt">"code"</span><span class="p">:{</span><span class="nt">"code"</span><span class="p">:</span><span class="s2">"E0659"</span><span class="p">,</span><span class="nt">"explanation"</span><span class="p">:</span><span class="s2">"An item usage is ambiguous.\n\nErroneous code example:\n\n```compile_fail,edition2018,E0659\npub mod moon {\n    pub fn foo() {}\n}\n\npub mod earth {\n    pub fn foo() {}\n}\n\nmod collider {\n    pub use crate::moon::*;\n    pub use crate::earth::*;\n}\n\nfn main() {\n    crate::collider::foo(); // ERROR: `foo` is ambiguous\n}\n```\n\nThis error generally appears when two items with the same name are imported into\na module. Here, the `foo` functions are imported and reexported from the\n`collider` module and therefore, when we're using `collider::foo()`, both\nfunctions collide.\n\nTo solve this error, the best solution is generally to keep the path before the\nitem when using it. Example:\n\n```edition2018\npub mod moon {\n    pub fn foo() {}\n}\n\npub mod earth {\n    pub fn foo() {}\n}\n\nmod collider {\n    pub use crate::moon;\n    pub use crate::earth;\n}\n\nfn main() {\n    crate::collider::moon::foo(); // ok!\n    crate::collider::earth::foo(); // ok!\n}\n```\n"</span><span class="p">},</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"error"</span>
</code></pre></div>
<p>output:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="nt">"message"</span><span class="p">:</span><span class="s2">"`m` is ambiguous"</span><span class="p">,</span><span class="nt">"code"</span><span class="p">:{</span><span class="nt">"code"</span><span class="p">:</span><span class="s2">"E0659"</span><span class="p">,</span><span class="nt">"explanation"</span><span class="p">:</span><span class="s2">"An item usage is ambiguous.\n\nErroneous code example:\n\n```compile_fail,edition2018,E0659\npub mod moon {\n    pub fn foo() {}\n}\n\npub mod earth {\n    pub fn foo() {}\n}\n\nmod collider {\n    pub use crate::moon::*;\n    pub use crate::earth::*;\n}\n\nfn main() {\n    crate::collider::foo(); // ERROR: `foo` is ambiguous\n}\n```\n\nThis error generally appears when two items with the same name are imported into\na module. Here, the `foo` functions are imported and reexported from the\n`collider` module and therefore, when we're using `collider::foo()`, both\nfunctions collide.\n\nTo solve this error, the best solution is generally to keep the path before the\nitem when using it. Example:\n\n```edition2018\npub mod moon {\n    pub fn foo() {}\n}\n\npub mod earth {\n    pub fn foo() {}\n}\n\nmod collider {\n    pub use crate::moon;\n    pub use crate::earth;\n}\n\nfn main() {\n    crate::collider::moon::foo(); // ok!\n    crate::collider::earth::foo(); // ok!\n}\n```\n"</span><span class="p">},</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"error"</span><span class="p">,</span>
<span class="p">{</span><span class="nt">"message"</span><span class="p">:</span><span class="s2">"`m` is ambiguous"</span><span class="p">,</span><span class="nt">"code"</span><span class="p">:{</span><span class="nt">"code"</span><span class="p">:</span><span class="s2">"E0659"</span><span class="p">,</span><span class="nt">"explanation"</span><span class="p">:</span><span class="s2">"An item usage is ambiguous.\n\nErroneous code example:\n\n```compile_fail,edition2018,E0659\npub mod moon {\n    pub fn foo() {}\n}\n\npub mod earth {\n    pub fn foo() {}\n}\n\nmod collider {\n    pub use crate::moon::*;\n    pub use crate::earth::*;\n}\n\nfn main() {\n    crate::collider::foo(); // ERROR: `foo` is ambiguous\n}\n```\n\nThis error generally appears when two items with the same name are imported into\na module. Here, the `foo` functions are imported and reexported from the\n`collider` module and therefore, when we're using `collider::foo()`, both\nfunctions collide.\n\nTo solve this error, the best solution is generally to keep the path before the\nitem when using it. Example:\n\n```edition2018\npub mod moon {\n    pub fn foo() {}\n}\n\npub mod earth {\n    pub fn foo() {}\n}\n\nmod collider {\n    pub use crate::moon;\n    pub use crate::earth;\n}\n\nfn main() {\n    crate::collider::moon::foo(); // ok!\n    crate::collider::earth::foo(); // ok!\n}\n```\n"</span><span class="p">},</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"error"</span><span class="p">,</span>
</code></pre></div>
<p>( ...this is repeated SEVERAL times, with a lot of extra data midway. )</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="nt">"message"</span><span class="p">:</span><span class="s2">"aborting due to 8 previous errors"</span><span class="p">,</span><span class="nt">"code"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"error"</span><span class="p">,</span><span class="nt">"spans"</span><span class="p">:[],</span><span class="nt">"children"</span><span class="p">:[],</span><span class="nt">"rendered"</span><span class="p">:</span><span class="s2">"error: aborting due to 8 previous errors\n\n"</span><span class="p">}</span>
<span class="p">{</span><span class="nt">"message"</span><span class="p">:</span><span class="s2">"For more information about this error, try `rustc --explain E0659`."</span><span class="p">,</span><span class="nt">"code"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">"level"</span><span class="p">:</span><span class="s2">"failure-note"</span><span class="p">,</span><span class="nt">"spans"</span><span class="p">:[],</span><span class="nt">"children"</span><span class="p">:[],</span><span class="nt">"rendered"</span><span class="p">:</span><span class="err">"For more information about this error, try `rustc --explain E0659`.json</span>
</code></pre></div>
<p>thread '[ui] ui/macros/restricted-shadowing-legacy.rs' panicked at 'explicit panic', src/tools/compiletest/src/json.rs:121:21<br>
note: run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace</p>
<p>failures:<br>
    [ui] ui/backtrace-debuginfo.rs<br>
    [ui] ui/macros/restricted-shadowing-legacy.rs</p>
<p>test result: FAILED. 12274 passed; 2 failed; 96 ignored; 0 measured; 0 filtered out; finished in 178.12s</p>
<p>Some tests failed in compiletest suite=ui mode=ui host=x86_64-unknown-linux-gnu target=x86_64-unknown-linux-gnu</p>
</blockquote>
</div></div>



<a name="260063087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260063087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260063087">(Nov 02 2021 at 21:55)</a>:</h4>
<p><span class="user-mention" data-user-id="316805">@durin42</span> So my limited understanding of C++ says that this is going off the idea that an <code>enum</code> is not valid for scoping in C++, and this is applying a very C++ specific semantics to the relevant type. So, yes.</p>



<a name="260063845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260063845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260063845">(Nov 02 2021 at 22:01)</a>:</h4>
<p>this diff conflates two different changes into one <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="260063881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260063881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260063881">(Nov 02 2021 at 22:01)</a>:</h4>
<p>Or rather, there are scoped enums in C++, but in Rust we don't have such a distinctly separate notion of scoped and unscoped, as far as I can discern. My references include<br>
<a href="https://releases.llvm.org/13.0.0/docs/LangRef.html#linkage-types">https://releases.llvm.org/13.0.0/docs/LangRef.html#linkage-types</a><br>
<a href="https://en.cppreference.com/w/cpp/language/enum">https://en.cppreference.com/w/cpp/language/enum</a></p>



<a name="260063896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260063896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260063896">(Nov 02 2021 at 22:01)</a>:</h4>
<p>I don't see how the tag change could possibly affect rust at all, so its gonna be the verifier one.</p>



<a name="260063926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260063926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260063926">(Nov 02 2021 at 22:01)</a>:</h4>
<p>Yeah, that matches my limited understanding of C++ as well. Should we be bouncing into the phabricator revision and asking for a revert? or changing our IR somehow?</p>



<a name="260064062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064062">(Nov 02 2021 at 22:03)</a>:</h4>
<p>yeah, this looks like the notional "culprit":</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Verifier::verifyODRTypeAsScopeOperand</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MDNode</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MD</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast_or_null</span><span class="o">&lt;</span><span class="n">DICompositeType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="p">).</span><span class="n">getScope</span><span class="p">()))</span><span class="w"></span>
<span class="w">      </span><span class="c1">// Of all the supported tags for DICompositeType(see visitDICompositeType)</span>
<span class="w">      </span><span class="c1">// we know that enum type cannot be a scope.</span>
<span class="w">      </span><span class="n">AssertDI</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getTag</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dwarf</span><span class="o">::</span><span class="n">DW_TAG_enumeration_type</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="s">"enum type is not a scope; check enum type ODR "</span><span class="w"></span>
<span class="w">               </span><span class="s">"violation"</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MD</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="260064343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064343">(Nov 02 2021 at 22:05)</a>:</h4>
<p>Mmmmaayyybe we should be representing our enums as enum classes?<br>
glancing at this: <a href="http://wiki.dwarfstd.org/index.php?title=C%2B%2B0x:_Strongly_typed_enumerations">http://wiki.dwarfstd.org/index.php?title=C%2B%2B0x:_Strongly_typed_enumerations</a></p>



<a name="260064385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064385">(Nov 02 2021 at 22:05)</a>:</h4>
<p>(I'd have caught this sometime last week but stresses in real life came up, sorry about that)</p>



<a name="260064484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064484">(Nov 02 2021 at 22:06)</a>:</h4>
<p>We can certainly try. I wonder if that emits compatible code, that sounds a little spooky.</p>



<a name="260064851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064851">(Nov 02 2021 at 22:09)</a>:</h4>
<p>With that musing I am at the limit of my knowledge, intuition, scholarship, and diplomacy, so I can't actually speak to a course of action.</p>



<a name="260064909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064909">(Nov 02 2021 at 22:10)</a>:</h4>
<p>I'm trying to raise one of the notional subject matter experts at work, hopefully I have something to try tomorrow...</p>



<a name="260064956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064956">(Nov 02 2021 at 22:10)</a>:</h4>
<p>clang represents an enum class as a <code>DW_TAG_enumeration_type</code> as well.</p>



<a name="260064962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260064962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260064962">(Nov 02 2021 at 22:10)</a>:</h4>
<p>Thanks though, that was helpful.</p>



<a name="260065058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260065058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260065058">(Nov 02 2021 at 22:11)</a>:</h4>
<p>and if its put into a namespace, it gets a <code>scope</code> too.</p>



<a name="260065214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260065214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260065214">(Nov 02 2021 at 22:12)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> it sounds like you don't think the enum class trick would help? is that correct?</p>



<a name="260065493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260065493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260065493">(Nov 02 2021 at 22:15)</a>:</h4>
<p>I'm not sure there is a trick to be had, since enum class is already a enumeration_type DW_TAG.</p>



<a name="260065627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260065627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260065627">(Nov 02 2021 at 22:16)</a>:</h4>
<p>So wait, is this just an invalid change?</p>



<a name="260066288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260066288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260066288">(Nov 02 2021 at 22:23)</a>:</h4>
<p>hm, can enum class have methods? first stack overflow hit says no.</p>



<a name="260066359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260066359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260066359">(Nov 02 2021 at 22:24)</a>:</h4>
<p>the way we use scopes here is that a method on a <code>enum</code> (<code>expect</code>) is scoped to the enum type itself (which it is).</p>



<a name="260066434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260066434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260066434">(Nov 02 2021 at 22:24)</a>:</h4>
<p><a href="https://reviews.llvm.org/D111770#3081290">https://reviews.llvm.org/D111770#3081290</a> seems to raise a fairly related concern here.</p>



<a name="260066605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260066605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260066605">(Nov 02 2021 at 22:26)</a>:</h4>
<p>and using <code>scope</code>s like this is fairly well established, so I don't see why there would be a need for LLVM to go out of their way to prevent this specifically for enumeration types. I would say that this warrants a revert and a llvm-dev thread if such a check wants to be reintroduced.</p>



<a name="260066838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260066838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260066838">(Nov 02 2021 at 22:29)</a>:</h4>
<p>Oh, lol. Yes, I incorrectly assumed they can have methods. Guess not.</p>



<a name="260077800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260077800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260077800">(Nov 03 2021 at 00:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures/near/260066605">said</a>:</p>
<blockquote>
<p>I would say that this warrants a revert and a llvm-dev thread if such a check wants to be reintroduced.</p>
</blockquote>
<p>do you want to bring it up or should I? you probably have a better handle on it, but I'm happy to try and negotiate it if you'd prefer</p>



<a name="260078957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260078957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260078957">(Nov 03 2021 at 01:08)</a>:</h4>
<p>Just heard back from Blaikie, and he says it's clearly invalid, and we should send a patch to revert the validator part of the change and include a test case that explains why it's valid (maybe with some Rust sample code in a comment). So I'll tackle that tomorrow. Thanks!</p>



<a name="260102579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260102579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260102579">(Nov 03 2021 at 08:39)</a>:</h4>
<p><span class="user-mention" data-user-id="316805">@durin42</span> I'm currently trying to recover from a minor burnout and get some rest between jobs so I'm trying to avoid actively involving myself with software for a little while. I'll appreciate if you can handle it and if not please ping e.g. Nikita for help.</p>



<a name="260712502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260712502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260712502">(Nov 08 2021 at 20:14)</a>:</h4>
<p>I'm finally working on a fix for this (it's been a week for personal reasons), and I'm down to wanting to try and produce a useful LLVM IR testcase from Rust code, and I'm a little fuzzy on how I can anger this particular LLVM edge case. Anyone around that might have a sense of the magic dance to tick it off?</p>



<a name="260716883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260716883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260716883">(Nov 08 2021 at 20:49)</a>:</h4>
<p>(Specifically: I'm having trouble coaxing rustc to emit something with a <code>DW_TAG_enumeration_type</code> in the IR, so I'm missing something.)</p>



<a name="260719016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260719016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260719016">(Nov 08 2021 at 21:06)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">E</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">f</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="p">...</span>
<span class="nv nv-Anonymous">!6</span> <span class="p">=</span> <span class="nv">!DICompositeType</span><span class="p">(</span><span class="nl">tag:</span> <span class="err">DW_TAG_enumeration_</span><span class="k">type</span><span class="p">,</span> <span class="nl">name:</span> <span class="s">"E"</span><span class="p">,</span> <span class="nl">scope:</span> <span class="nv nv-Anonymous">!8</span><span class="p">,</span> <span class="nl">file:</span> <span class="nv nv-Anonymous">!7</span><span class="p">,</span> <span class="nl">baseType:</span> <span class="nv nv-Anonymous">!9</span><span class="p">,</span> <span class="nl">size:</span> <span class="m">8</span><span class="p">,</span> <span class="nl">align:</span> <span class="m">8</span><span class="p">,</span> <span class="nl">flags:</span> <span class="err">DIFlagEnumClass</span><span class="p">,</span> <span class="nl">elements:</span> <span class="nv nv-Anonymous">!10</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div>



<a name="260719351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260719351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260719351">(Nov 08 2021 at 21:09)</a>:</h4>
<p>How'd you generate that? I was trying to use compiler explorer and it's not giving me the goods, even with <code>--emit=llvm-ir -g -C no-prepopulate-passes</code> which seemed like it should work based on the one testcase in-tree</p>



<a name="260719499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260719499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260719499">(Nov 08 2021 at 21:10)</a>:</h4>
<p>I generated that with <code>rustc --crate-type=lib a.rs --emit llvm-ir -g</code>.</p>



<a name="260720043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260720043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260720043">(Nov 08 2021 at 21:16)</a>:</h4>
<p>Huh, thanks. I wonder why compiler explorer hates me today.</p>



<a name="260720621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260720621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260720621">(Nov 08 2021 at 21:21)</a>:</h4>
<p>You have to uncheck Filters -&gt; Directives</p>



<a name="260725341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260725341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260725341">(Nov 08 2021 at 22:02)</a>:</h4>
<p>Also do beware that compiler explorer cuts the output at 5000 lines or something and the metadata appears at the end of the file.</p>



<a name="260725561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20HEAD%20DWARF%20validation%20failures/near/260725561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20HEAD.20DWARF.20validation.20failures.html#260725561">(Nov 08 2021 at 22:04)</a>:</h4>
<p>traps everywhere, it seems! But I've got a <a href="https://github.com/durin42/llvm-project/commit/24fbc4ee225374e9cdde72fd0385b5f952e049f4">patch drafted</a> and am running it by some LLVM folks that talked me through this at work. Hopefully have them on phabricator tomorrow.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>