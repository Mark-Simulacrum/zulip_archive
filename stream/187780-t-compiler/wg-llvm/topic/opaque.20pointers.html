<html>
<head><meta charset="utf-8"><title>opaque pointers · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html">opaque pointers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="247967117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/247967117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#247967117">(Aug 02 2021 at 20:27)</a>:</h4>
<p>I saw <a href="https://github.com/rust-lang/rust/issues/86873">#86873</a> for opaque pointer support -- is there any other work in progress?</p>



<a name="247967145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/247967145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#247967145">(Aug 02 2021 at 20:27)</a>:</h4>
<p>I was thinking of tackling <code>call</code>/<code>invoke</code> myself</p>



<a name="247971475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/247971475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#247971475">(Aug 02 2021 at 21:05)</a>:</h4>
<p>There's <a href="https://github.com/rust-lang/rust/pull/87695">https://github.com/rust-lang/rust/pull/87695</a> for GEPs.</p>



<a name="247973947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/247973947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#247973947">(Aug 02 2021 at 21:29)</a>:</h4>
<p>great! after GEP and calls, is anything left?</p>



<a name="247975005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/247975005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#247975005">(Aug 02 2021 at 21:40)</a>:</h4>
<p>There's also a couple of explicit <code>element_type()</code> calls, but basically that should be it.</p>



<a name="248288484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248288484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248288484">(Aug 03 2021 at 22:23)</a>:</h4>
<p>here's <code>call</code>/<code>invoke</code>: <a href="https://github.com/rust-lang/rust/pull/87743">https://github.com/rust-lang/rust/pull/87743</a></p>



<a name="248517200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248517200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248517200">(Aug 05 2021 at 18:33)</a>:</h4>
<p>I just added a check to my PR so <code>element_type</code> only allows arrays and vectors</p>



<a name="248518435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248518435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248518435">(Aug 05 2021 at 18:43)</a>:</h4>
<p>once that lands, we might be ready to try <code>ptr</code> with LLVM 13?</p>



<a name="248521336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248521336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248521336">(Aug 05 2021 at 19:02)</a>:</h4>
<p>We might be ready, but LLVM isn't :)</p>



<a name="248521633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248521633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248521633">(Aug 05 2021 at 19:05)</a>:</h4>
<p>heh</p>



<a name="248521680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248521680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248521680">(Aug 05 2021 at 19:05)</a>:</h4>
<p>well, we can better kick the tires to help get LLVM ready then</p>



<a name="248522771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248522771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248522771">(Aug 05 2021 at 19:15)</a>:</h4>
<p>I'll need to check what the check does but aren't vectors of pointers a thing?</p>



<a name="248522889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248522889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248522889">(Aug 05 2021 at 19:16)</a>:</h4>
<p>They are, but shouldn't be relevant here? That would be the element type being a pointer, not getting an element type on a pointer.</p>



<a name="248522936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248522936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248522936">(Aug 05 2021 at 19:16)</a>:</h4>
<p>I see.</p>



<a name="248524311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248524311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248524311">(Aug 05 2021 at 19:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/opaque.20pointers/near/248521680">said</a>:</p>
<blockquote>
<p>well, we can better kick the tires to help get LLVM ready then</p>
</blockquote>
<p>At least we'll have a frontend to test with :)</p>



<a name="248992496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/248992496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#248992496">(Aug 10 2021 at 15:12)</a>:</h4>
<p>is there anything yet for the <code>byval</code> attribute? I remember that sticking out like a sore thumb back in 2015 or whenever I last looked at opaque pointers</p>



<a name="249017407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249017407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249017407">(Aug 10 2021 at 18:28)</a>:</h4>
<p><a href="https://llvm.org/docs/LangRef.html#parameter-attributes">https://llvm.org/docs/LangRef.html#parameter-attributes</a></p>
<blockquote>
<p>byval(&lt;ty&gt;)</p>
</blockquote>
<p>Seems to be the case.</p>



<a name="249017761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249017761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249017761">(Aug 10 2021 at 18:31)</a>:</h4>
<p>That was already the case before LLVM 12 though I think.</p>



<a name="249017898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249017898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249017898">(Aug 10 2021 at 18:32)</a>:</h4>
<p>LLVM 9 it seems: <a href="https://github.com/rust-lang/rust/issues/62474">#62474</a></p>



<a name="249017951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249017951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249017951">(Aug 10 2021 at 18:32)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/commit/eb338220911fbcf0661e4f8802b23d0bd4e5d077">eb338220911fbcf0661e4f8802b23d0bd4e5d077</a></p>



<a name="249018176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249018176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249018176">(Aug 10 2021 at 18:35)</a>:</h4>
<p>ah wow nice</p>



<a name="249018574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249018574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249018574">(Aug 10 2021 at 18:38)</a>:</h4>
<p>disappointing that it's not a size, which means LLVM gets to keep its weird type-dependence for it, but it should be enough for opaque pointers</p>



<a name="249037449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249037449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249037449">(Aug 10 2021 at 21:02)</a>:</h4>
<p>that's how opaque pointers work in general though – type moved to the instruction that's it.</p>



<a name="249078076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078076">(Aug 11 2021 at 07:53)</a>:</h4>
<p>some of the discussion back then was about the size - after all, size and alignment are all <code>byval</code> should care about. it's not like instructions that need to reason about <em>values</em> of the type, there's no <code>T</code> value <code>byval(T)</code> copies, only <code>sizeof(T)</code> bytes. and I guess <code>alloca</code> should be similar</p>



<a name="249078107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078107">(Aug 11 2021 at 07:53)</a>:</h4>
<p>eventually I hope to use <code>[i8 x N]</code> types in every "unnecessarily typed" part of the IR like this</p>



<a name="249078180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078180">(Aug 11 2021 at 07:54)</a>:</h4>
<p>(the way we lower miri constant data has been a great success IMO)</p>



<a name="249078632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078632">(Aug 11 2021 at 08:00)</a>:</h4>
<p>Yeah, there is still a lot of unnecessary type information. It's just very hard to remove any of it while pointer types are still there. For migration purposes it's easiest to keep everything else typed.</p>



<a name="249078699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078699">(Aug 11 2021 at 08:00)</a>:</h4>
<p>I do hope we'll be able to remove GEP types once we have opaque pointers. Most other type usages are fairly harmless.</p>



<a name="249078786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078786">(Aug 11 2021 at 08:01)</a>:</h4>
<p>redesigning GEP to be an "multi-indexing offset expression", or splitting it into multiple instructions, is probably the hardest thing one could do</p>



<a name="249078875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078875">(Aug 11 2021 at 08:02)</a>:</h4>
<p>I never figured out how <code>inbounds</code> semantics work with one <code>GEPi</code> with N indices vs N <code>GEPi</code>s</p>



<a name="249078931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249078931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249078931">(Aug 11 2021 at 08:03)</a>:</h4>
<p>(the "simplest" thing would be forcing the backend to emit multiplications but I kinda doubt LLVM passes are going to like working with that)</p>



<a name="249079061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249079061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249079061">(Aug 11 2021 at 08:04)</a>:</h4>
<p>anyway let's get opaque pointers first, then we can experiment with firewalling LLVM and feeding it <code>[iN x M]</code> (approximating alignment where possible) in as many places as we can</p>



<a name="249079252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/249079252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#249079252">(Aug 11 2021 at 08:07)</a>:</h4>
<p><code>rustc_codegen_spirv</code> suffered a bit from "mapping Rust types to backend ones 1:1 <em>seems</em> plausible", and ripping up that kind of thing as much as possible should help with improving its design</p>



<a name="250053888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/250053888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#250053888">(Aug 19 2021 at 21:50)</a>:</h4>
<p>TIL there's an option to make all pointers opaque</p>



<a name="250053899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/250053899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#250053899">(Aug 19 2021 at 21:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ RUSTFLAGS_NOT_BOOTSTRAP=-Cllvm-args=-force-opaque-pointers ./x.py build
</code></pre></div>



<a name="250053925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/250053925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#250053925">(Aug 19 2021 at 21:51)</a>:</h4>
<p>it will crash quickly though <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="250054152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/250054152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#250054152">(Aug 19 2021 at 21:53)</a>:</h4>
<p>I added a few easy bypasses, like <code>if (ptr-&gt;isOpaque()) return;</code>, but SROA <code>getAdjustedPtr</code> looks like it will really need a type</p>



<a name="250054350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/250054350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#250054350">(Aug 19 2021 at 21:55)</a>:</h4>
<p>(I'm testing on main <code>36d51386195e3d606e0d40495f1135ab180bd6ae^</code>, because that commit changes API that I don't want to deal with right now)</p>



<a name="250087905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/250087905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#250087905">(Aug 20 2021 at 07:47)</a>:</h4>
<p>SROA can likely switch to i8 geps. It currently just tries really, really hard to construct geps without having to insert bitcasts.</p>



<a name="272723454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/272723454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#272723454">(Feb 21 2022 at 18:48)</a>:</h4>
<p>Great to hear this is coming along well, <span class="user-mention silent" data-user-id="133224">Nikita Popov</span>!  Thanks for all the work on it <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> </p>
<p>For those not reading LLVM weekly: &lt;<a href="https://discourse.llvm.org/t/opaque-pointers-status-update/60296">https://discourse.llvm.org/t/opaque-pointers-status-update/60296</a>&gt;</p>



<a name="272734720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/272734720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#272734720">(Feb 21 2022 at 21:01)</a>:</h4>
<p>There's a first perf run for rust here: <a href="https://github.com/rust-lang/rust/pull/94214#issuecomment-1046925689">https://github.com/rust-lang/rust/pull/94214#issuecomment-1046925689</a></p>



<a name="272734805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/opaque%20pointers/near/272734805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/opaque.20pointers.html#272734805">(Feb 21 2022 at 21:02)</a>:</h4>
<p>Take it with a big grain of salt, because there are some regressions on check builds, so we probably end up missing some optimizations.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>