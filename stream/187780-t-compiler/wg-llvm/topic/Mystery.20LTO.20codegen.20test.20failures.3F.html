<html>
<head><meta charset="utf-8"><title>Mystery LTO codegen test failures? · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html">Mystery LTO codegen test failures?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250488961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250488961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250488961">(Aug 24 2021 at 14:00)</a>:</h4>
<p>I'm closing in on having a green build against upstream LLVM HEAD (which I need for $EMPLOYER), and I'm now down to two mysterious failures. Here's one:</p>
<div class="codehilite"><pre><span></span><code>---- [codegen] codegen/sanitizer-recover.rs#MSAN-RECOVER-LTO stdout ----

error in revision `MSAN-RECOVER-LTO`: compilation failed!
status: exit status: 1
command: &quot;/usr/local/google/home/augie/Programming/big/rust/build/x86_64-unknown-linux-gnu/stage1/bin/rustc&quot; &quot;/usr/local/google/home/augie/Programming/big/rust/src/test/codegen/sanitizer-recover.rs&quot; &quot;-Zthreads=1&quot; &quot;--target=x86_64-unknown-linux-gnu&quot; &quot;--cfg&quot; &quot;msan_recover_lto&quot; &quot;--out-dir&quot; &quot;/usr/local/google/home/augie/Programming/big/rust/build/x86_64-unknown-linux-gnu/test/codegen/sanitizer-recover.MSAN-RECOVER-LTO&quot; &quot;-Crpath&quot; &quot;-O&quot; &quot;-Cdebuginfo=0&quot; &quot;-Lnative=/usr/local/google/home/augie/Programming/big/rust/build/x86_64-unknown-linux-gnu/native/rust-test-helpers&quot; &quot;-Zsanitizer=memory&quot; &quot;-Zsanitizer-recover=memory&quot; &quot;-C&quot; &quot;lto=fat&quot; &quot;-L&quot; &quot;/usr/local/google/home/augie/Programming/big/rust/build/x86_64-unknown-linux-gnu/test/codegen/sanitizer-recover.MSAN-RECOVER-LTO/auxiliary&quot; &quot;--emit=llvm-ir&quot;
stdout:
------------------------------------------

------------------------------------------
stderr:
------------------------------------------
error: failed to get bitcode from object file for LTO (Bitcode section not found in object file)

error: aborting due to previous error


------------------------------------------
</code></pre></div>
<p>I see this even when I'm using the <code>rustc/13.0-2021-08-08</code> branch of LLVM, so could this be environmental somehow? I'm puzzled.</p>



<a name="250542484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250542484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250542484">(Aug 24 2021 at 20:17)</a>:</h4>
<p>You need to cherry-pick <a href="https://reviews.llvm.org/D107216">https://reviews.llvm.org/D107216</a>.</p>



<a name="250543298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250543298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250543298">(Aug 24 2021 at 20:24)</a>:</h4>
<p>Ah, if you're using the branch that shouldn't happen, it already includes that change ... but that was how this issue manifested.</p>



<a name="250551910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250551910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250551910">(Aug 24 2021 at 21:30)</a>:</h4>
<p>Okay, I'll double-check tomorrow. Maybe I didn't do a clean-enough build and it didn't rebuild the relevant bits. I've been burned by that before.</p>



<a name="250551980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250551980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250551980">(Aug 24 2021 at 21:30)</a>:</h4>
<p>Oh, and isn't that patch on LLVM main now?</p>



<a name="250554686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250554686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250554686">(Aug 24 2021 at 21:54)</a>:</h4>
<p>Nope, as MaskRay did not agree with the revert :)</p>



<a name="250555148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/250555148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#250555148">(Aug 24 2021 at 21:59)</a>:</h4>
<p>I'll pester tstellar about it, otherwise he'll hear from me when this hits our distros... :)</p>



<a name="252551522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252551522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252551522">(Sep 08 2021 at 23:55)</a>:</h4>
<p>MaskRay agreed to revert it on 13.x, but we'll still have to figure something out going forward</p>



<a name="252587151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252587151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252587151">(Sep 09 2021 at 08:10)</a>:</h4>
<p>That's disappointing but not exactly unexpected. This LLVM release has been almost exclusively about mitigating MaskRay, so that just adds one more thing.</p>



<a name="252587509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252587509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252587509">(Sep 09 2021 at 08:13)</a>:</h4>
<p>I think for llvmbc we'll have to follow the suggestion of embedding the bitcode in inline assembly (ugh). For the <code>.rustc</code> section we should switch to the object crate, which would at least allow making that part codegen backend independent. Might require additional support in the object crate, as I think that would make it required for all targets.</p>



<a name="252590067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252590067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252590067">(Sep 09 2021 at 08:34)</a>:</h4>
<p>I think only wasm writing is not yet supported by object. Wasm doesn't support dynamic libraries yet.</p>



<a name="252653150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252653150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252653150">(Sep 09 2021 at 16:16)</a>:</h4>
<p>did someone run over MaskRay's dog or</p>



<a name="252668135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252668135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252668135">(Sep 09 2021 at 17:59)</a>:</h4>
<p><span class="user-mention" data-user-id="316805">@durin42</span> Out of curiosity, what are you doing with Rust on LLVM HEAD? I'm always interested in people's usage of compiler toolchains.</p>



<a name="252669023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252669023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252669023">(Sep 09 2021 at 18:05)</a>:</h4>
<p>We use LLVM HEAD for our C/C++ toolchain, so if we want ThinLTO and sanitizers to work in mixed-language binaries (and that's basically a hard requirement) we need to use LLVM HEAD for Rust as well.</p>



<a name="252669228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252669228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252669228">(Sep 09 2021 at 18:06)</a>:</h4>
<p>So in general I expect to be chasing build breaks or codegen regressions within a day or two of the regression.</p>



<a name="252704107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252704107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252704107">(Sep 09 2021 at 22:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316805">durin42</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F/near/252669023">said</a>:</p>
<blockquote>
<p>We use LLVM HEAD for our C/C++ toolchain, so if we want ThinLTO and sanitizers to work in mixed-language binaries (and that's basically a hard requirement) we need to use LLVM HEAD for Rust as well.</p>
</blockquote>
<p>Ah, that makes sense.</p>



<a name="252852472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252852472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252852472">(Sep 10 2021 at 21:21)</a>:</h4>
<p>On this front: is there any interest in some sort of CI for this as part of the Rust project? I talked to LLVM folks and they don't want to privilege anything that's out of tree, but it seems like a thing that might make sense for Rust to host?</p>



<a name="252868581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252868581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252868581">(Sep 11 2021 at 00:28)</a>:</h4>
<p>Since Rust's CI is always green, it would mean we'd commit to always supporting some HEAD of LLVM.</p>



<a name="252868638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252868638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252868638">(Sep 11 2021 at 00:28)</a>:</h4>
<p>AFAIK there is an effort by somebody to run Rust + LLVM HEAD CI on the LLVM side (probably not super official?), but I don't recall who was it who's driving this.</p>



<a name="252869274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252869274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252869274">(Sep 11 2021 at 00:39)</a>:</h4>
<p>"some sort of CI" doesn't have to mean gating CI</p>



<a name="252869354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/252869354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#252869354">(Sep 11 2021 at 00:40)</a>:</h4>
<p>it could be a scheduled GitHub Action, nightly or so</p>



<a name="253108103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/253108103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#253108103">(Sep 13 2021 at 15:23)</a>:</h4>
<p>I'd rather more often than nightly, so that in theory it can be something I can put a rotation of teammates on to get things fixed promptly enough we don't slow down our C++ compiler releases (which will jeopardize my Rust work if it happens, sadly)</p>



<a name="253108236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/253108236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#253108236">(Sep 13 2021 at 15:24)</a>:</h4>
<p>I'm pretty sure it was Christian that works with me that was trying to do some Rust+LLVM CI on the LLVM side, and that got very harshly vetoed so I didn't feel like trying to fight the battle over there again.</p>



<a name="255409301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/Mystery%20LTO%20codegen%20test%20failures%3F/near/255409301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/Mystery.20LTO.20codegen.20test.20failures.3F.html#255409301">(Sep 29 2021 at 14:32)</a>:</h4>
<p>Is there anyplace I can follow the D107216 saga? Is any work ongoing with that?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>