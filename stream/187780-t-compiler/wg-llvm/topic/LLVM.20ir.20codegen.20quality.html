<html>
<head><meta charset="utf-8"><title>LLVM ir codegen quality · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html">LLVM ir codegen quality</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255074401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255074401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255074401">(Sep 27 2021 at 16:06)</a>:</h4>
<p>I have been working on an llvm backend for cranelift for the last week or so. Today I managed to get it working on a reasonable set of programs. Just for fun I tried to benchmark with <a href="https://github.com/ebobby/simple-raytracer">https://github.com/ebobby/simple-raytracer</a> and compare it to cg_llvm. It seems to be much faster even though I didn't use any optimizations for the llvm cranelift backend, while cg_llvm does do some optimizations by default even in debug mode. It also prevents any pointer provenance based optimizations as it uses ptrtoint and inttoptr everywhere as cg_clif doesn't have a separate pointer type.</p>
<p>cg_llvm: 7437 milliseconds elapsed.<br>
cg_clif + llvm backend: 4692 milliseconds elapsed.</p>
<p>This seems to indicate that cg_clif produces significantly higher quality ir, such that even after translation from clif ir to llvm ir it is much better.</p>
<p>As cg_clif + llvm backend doesn't support debuginfo, here is a run with cg_llvm with debuginfo disabled:</p>
<p>cg_llvm + debuginfo=0: 7088 milliseconds elapsed.</p>
<p>I have spent a considerable amount of time optimizing the ir produced by cg_clif, which may be the reason for this runtime perf difference, but I didn't expect the difference to be this big.</p>



<a name="255074655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255074655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255074655">(Sep 27 2021 at 16:08)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="123586">@nagisa</span></p>



<a name="255074658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255074658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255074658">(Sep 27 2021 at 16:08)</a>:</h4>
<p><code>-Cno-prepopulate-passes</code> would be the right way to disable optimizations with cg_llvm</p>



<a name="255074811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255074811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255074811">(Sep 27 2021 at 16:09)</a>:</h4>
<p>cg_llvm + debuginfo=0 + -Cno-prepopulate-passes: 8805 milliseconds elapsed.</p>



<a name="255074935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255074935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255074935">(Sep 27 2021 at 16:09)</a>:</h4>
<p>ha <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="255609687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255609687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255609687">(Sep 30 2021 at 17:02)</a>:</h4>
<p>do you have any measurement of the resulting performance?</p>



<a name="255609835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255609835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255609835">(Sep 30 2021 at 17:03)</a>:</h4>
<p>e.g. I wonder how much "It also prevents any pointer provenance based optimizations" is a problem, and perhaps if that short-cuts a lot of the LLVM runtime cost</p>



<a name="255609887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255609887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255609887">(Sep 30 2021 at 17:03)</a>:</h4>
<p>basically, whether it's faster just because it's doing less</p>



<a name="255610219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255610219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255610219">(Sep 30 2021 at 17:05)</a>:</h4>
<p>of course, if we can "do less" while keeping all optimizations, that would be great :)</p>



<a name="255612558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255612558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255612558">(Sep 30 2021 at 17:20)</a>:</h4>
<p>What are the resulting binary sizes?</p>



<a name="255616317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255616317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255616317">(Sep 30 2021 at 17:42)</a>:</h4>
<p>This was actually about runtime performance. I haven't checked compile time performance, but I expect it to be worse than cg_llvm as it uses an intermediate ir. The main point here is that by generating better quality ir (which I think won't result in more than a couple percent cost of translation as cg_clif does it too) in cg_llvm, the debug mode runtime performance can be significantly improved.</p>



<a name="255616483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255616483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255616483">(Sep 30 2021 at 17:43)</a>:</h4>
<p>oh, that's elapsed time of _running_ the raytracer? wow!</p>



<a name="255616660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255616660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255616660">(Sep 30 2021 at 17:44)</a>:</h4>
<p>Yes! I was very much surprised myself!</p>



<a name="255617126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255617126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255617126">(Sep 30 2021 at 17:47)</a>:</h4>
<p>Hang on, I am not sure if I disabled <code>-Zmir-opt-level=3</code>for libstd. If I didn't, then this is much less impressive.</p>



<a name="255617205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255617205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255617205">(Sep 30 2021 at 17:48)</a>:</h4>
<p>I think I will need to redo the benchmark tomorrow.</p>



<a name="255751311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255751311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255751311">(Oct 01 2021 at 14:18)</a>:</h4>
<p>Less impressive, though still faster:</p>
<div class="codehilite"><pre><span></span><code>Benchmark #1: target/x86_64-unknown-linux-gnu/debug/main
  Time (mean ± σ):      6.643 s ±  0.011 s    [User: 6.641 s, System: 0.002 s]
  Range (min … max):    6.630 s …  6.665 s    10 runs

Benchmark #2: ./raytracer_cg_llvm
  Time (mean ± σ):      7.419 s ±  0.018 s    [User: 7.416 s, System: 0.003 s]
  Range (min … max):    7.390 s …  7.449 s    10 runs

Summary
  &#39;target/x86_64-unknown-linux-gnu/debug/main&#39; ran
    1.12 ± 0.00 times faster than &#39;./raytracer_cg_llvm&#39;
</code></pre></div>
<p><code>target/x86_64-unknown-linux-gnu/debug/main</code> is cg_clif + llvm backend<br>
<code>./raytracer_cg_llvm</code> is cg_llvm</p>



<a name="255751888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255751888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255751888">(Oct 01 2021 at 14:22)</a>:</h4>
<p>Compiling it:</p>
<p>cg_clif + llvm backend: <code>    Finished dev [unoptimized] target(s) in 45.92s</code><br>
cg_llvm: <code>    Finished dev [unoptimized] target(s) in 17.83s</code></p>
<p>note that cg_clif + llvm backend is single threaded while cg_llvm is multi threaded. Forcing both to use a single thread using <code>-j1</code> gives:</p>
<p>cg_clif + llvm backend: <code>    Finished dev [unoptimized] target(s) in 1m 03s</code><br>
cg_llvm: <code>    Finished dev [unoptimized] target(s) in 32.37s</code></p>



<a name="255751963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/LLVM%20ir%20codegen%20quality/near/255751963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/LLVM.20ir.20codegen.20quality.html#255751963">(Oct 01 2021 at 14:23)</a>:</h4>
<p>So cg_clif + llvm backend is about twice as slow as cg_llvm. Presumably due to translation overhead.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>