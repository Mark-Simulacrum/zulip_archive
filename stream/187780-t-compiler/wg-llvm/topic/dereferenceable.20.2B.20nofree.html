<html>
<head><meta charset="utf-8"><title>dereferenceable + nofree · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html">dereferenceable + nofree</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255855978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255855978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255855978">(Oct 02 2021 at 09:16)</a>:</h4>
<p>Before I go shout at people, does rust suffer from the C++ "references are not necessarily dereferenceable until the end of the function" problem in its current uses of dereferenceable?</p>



<a name="255856007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255856007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255856007">(Oct 02 2021 at 09:17)</a>:</h4>
<p>I'm aware of <a href="https://github.com/rust-lang/rust/issues/63787">https://github.com/rust-lang/rust/issues/63787</a>, but from reading that issue this seems like a clear case of incorrect reference use, not of references arguments not being dereferenceable for the whole function.</p>



<a name="255856138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255856138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255856138">(Oct 02 2021 at 09:19)</a>:</h4>
<p>There is a also <a href="https://github.com/rust-lang/rust/blob/b6057bf7b7ee7c58e6a39ead02eaa13b75f908c2/compiler/rustc_middle/src/ty/layout.rs#L3049-L3055">https://github.com/rust-lang/rust/blob/b6057bf7b7ee7c58e6a39ead02eaa13b75f908c2/compiler/rustc_middle/src/ty/layout.rs#L3049-L3055</a>, which is an example where we currently don't use dereferenceable, but could if it had "dereferenceable on entry" semantics.</p>



<a name="255857111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255857111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255857111">(Oct 02 2021 at 09:36)</a>:</h4>
<p>There are two instances where this can be true, I believe. References that materialize in a middle of a function (and their scope is therefore less than the entire function; I'm not sure if its at all possible to apply <code>dereferenceable</code> to these at all in that case) and the currently fictional <code>&amp;own</code> I think.</p>



<a name="255857143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255857143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255857143">(Oct 02 2021 at 09:36)</a>:</h4>
<p>The first case matters if we started applying <code>dereferenceable</code> to instructions rather than function attributes, but I don't think we do?</p>



<a name="255857521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255857521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255857521">(Oct 02 2021 at 09:42)</a>:</h4>
<p>I could imagine that NLL lifetimes have potential for causing problems in the motivating example from the RFC too:</p>
<div class="codehilite"><pre><span></span><code>o = deref(N) alloc();
if (c) free(o)
while(true) {
  if (c) break;
  // With the current semantics, we will hoist o.f above the loop
  v = o.f;
}
</code></pre></div>



<a name="255857618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255857618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255857618">(Oct 02 2021 at 09:44)</a>:</h4>
<p>What I had in mind here is mainly dereferenceable use for function attributes. But the case of return values is interesting -- do we currently place dereferenceable on returns?</p>



<a name="255857668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255857668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255857668">(Oct 02 2021 at 09:45)</a>:</h4>
<p>Similar for <code>!dereferenceable</code> metadata on loads, but I'm pretty sure we don't use that.</p>



<a name="255857715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255857715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255857715">(Oct 02 2021 at 09:46)</a>:</h4>
<p>I'm not sure… I can't say I've seen any dereferenceables on returns or instructions. only on arguments.</p>



<a name="255858128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255858128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255858128">(Oct 02 2021 at 09:53)</a>:</h4>
<p>Looks like we do: <a href="https://rust.godbolt.org/z/Ej5W6Kseb">https://rust.godbolt.org/z/Ej5W6Kseb</a></p>



<a name="255876910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255876910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255876910">(Oct 02 2021 at 15:00)</a>:</h4>
<p>I think <a href="https://github.com/rust-lang/rust/issues/55005">#55005</a> is a similar question</p>



<a name="255877549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/dereferenceable%20%2B%20nofree/near/255877549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/dereferenceable.20.2B.20nofree.html#255877549">(Oct 02 2021 at 15:11)</a>:</h4>
<p>Thanks! Skimming through that, it seems like the main open question there is whether <code>!Freeze</code> references should be considered dereferenceable for the whole function or not.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>