<html>
<head><meta charset="utf-8"><title>NewPM compile-time issues · t-compiler/wg-llvm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/index.html">t-compiler/wg-llvm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html">NewPM compile-time issues</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257424674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257424674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257424674">(Oct 13 2021 at 19:37)</a>:</h4>
<p>We have three issues with pathological compile-time increases with the new pass manager: <a href="https://github.com/rust-lang/rust/issues/89524">https://github.com/rust-lang/rust/issues/89524</a> <a href="https://github.com/rust-lang/rust/issues/89647">https://github.com/rust-lang/rust/issues/89647</a> <a href="https://github.com/rust-lang/rust/issues/89609">https://github.com/rust-lang/rust/issues/89609</a> cc <span class="user-mention" data-user-id="138448">@cuviper</span></p>



<a name="257424816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257424816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257424816">(Oct 13 2021 at 19:38)</a>:</h4>
<p>do you have any sense whether they are related?</p>



<a name="257425142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257425142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257425142">(Oct 13 2021 at 19:41)</a>:</h4>
<p>For the first one, the root cause is pathological inlining of recursive calls (drop_in_place).</p>



<a name="257425209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257425209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257425209">(Oct 13 2021 at 19:41)</a>:</h4>
<p>I didn't look at the others, but based on your description it sounds like inlining is the problem for the s390x one as well?</p>



<a name="257425407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257425407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257425407">(Oct 13 2021 at 19:42)</a>:</h4>
<p>the expansion in the s390x one looks loop-related, but I don't know, maybe inlining is involved too</p>



<a name="257425481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257425481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257425481">(Oct 13 2021 at 19:43)</a>:</h4>
<p>I want to try that new opt-pass reducer, but I think that wants an actual crash</p>



<a name="257428422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257428422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257428422">(Oct 13 2021 at 20:02)</a>:</h4>
<p>After InlinerPass: 929<br>
After PostOrderFunctionAttrsPass: 5580<br>
...<br>
After InlinerPass: 5129<br>
After InlinerPass: 150185<br>
...</p>



<a name="257428540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257428540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257428540">(Oct 13 2021 at 20:03)</a>:</h4>
<p>This is on the s390x test case. So yeah, I think this is an inlining issue as well. Things just tends to get stuck in loop passes once you get to functions with hundreds of thousands of instructions.</p>



<a name="257431559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257431559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257431559">(Oct 13 2021 at 20:22)</a>:</h4>
<p>For the first issue, the patch at <a href="https://reviews.llvm.org/D98481">https://reviews.llvm.org/D98481</a> fixes the issue. I just checked it with the s390x case as well, and it brings time down to 4s there as well (not quite the same as legacy pm but good enough)</p>



<a name="257431672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257431672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257431672">(Oct 13 2021 at 20:23)</a>:</h4>
<p>I did a perf run for that one at <a href="https://github.com/rust-lang/rust/pull/89830">https://github.com/rust-lang/rust/pull/89830</a>, which shows that it does have some impact on performance in practice (regressions &lt;1% on check builds)</p>



<a name="257431960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257431960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257431960">(Oct 13 2021 at 20:25)</a>:</h4>
<p>Which is fine for us I think, but the upstream patch seems to be stalled</p>



<a name="257441665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257441665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257441665">(Oct 13 2021 at 21:31)</a>:</h4>
<p>good find, thanks!</p>



<a name="257441808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257441808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257441808">(Oct 13 2021 at 21:32)</a>:</h4>
<p>I wonder why s390x in particular inlines poorly on that input</p>



<a name="257447620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257447620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257447620">(Oct 13 2021 at 22:16)</a>:</h4>
<p>The s390x architecture is particularly distinct and LLVM in many ways encodes an "x86-first" view of the world.</p>



<a name="257447710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257447710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257447710">(Oct 13 2021 at 22:17)</a>:</h4>
<p>To a certain extent Rust does too, honestly.</p>



<a name="257447989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257447989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257447989">(Oct 13 2021 at 22:19)</a>:</h4>
<p>yeah, sure, we even encode that as "Tier 1", though we've now added aarch64 there too</p>



<a name="257448234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257448234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257448234">(Oct 13 2021 at 22:21)</a>:</h4>
<p>but here, I'm wondering why it's different in <code>opt</code> that's sort of target-neutral, not down in <code>llc</code> codegen</p>



<a name="257448338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257448338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257448338">(Oct 13 2021 at 22:22)</a>:</h4>
<p>I'm guessing it's something in <code>SystemZTargetTransformInfo</code>, like unroll options</p>



<a name="257492678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/257492678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#257492678">(Oct 14 2021 at 07:39)</a>:</h4>
<p>Likely due to differences in the cost model. Something probably happens to go just below/above a threshold somewhere for the s390x target.</p>



<a name="258075508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258075508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258075508">(Oct 18 2021 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> On a tangentially related note, <a href="https://reviews.llvm.org/D111575">https://reviews.llvm.org/D111575</a> may be of interest to you. Might help to cut down NewPM memory usage on 32-bit hosts at a relatively minor compile-time impact.</p>



<a name="258075941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258075941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258075941">(Oct 18 2021 at 18:24)</a>:</h4>
<p>oh interesting! we may have to figure out heuristics for turning that on, if not <em>always</em> for 32-bit hosts</p>



<a name="258076054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258076054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258076054">(Oct 18 2021 at 18:25)</a>:</h4>
<p>Should at least check how much difference it makes (for instructions &amp; max-rss) on our workloads.</p>



<a name="258076537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258076537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258076537">(Oct 18 2021 at 18:28)</a>:</h4>
<p>Anyway, I'm not sure how to move forward on the compile-time issue.</p>



<a name="258076806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258076806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258076806">(Oct 18 2021 at 18:30)</a>:</h4>
<p>are there any <code>-Cllvm-args</code> we can offer to work around it?</p>



<a name="258076857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258076857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258076857">(Oct 18 2021 at 18:30)</a>:</h4>
<p>this will reach beta soon, and it would be nice to at least have something for relnotes if it goes stable</p>



<a name="258077177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258077177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258077177">(Oct 18 2021 at 18:33)</a>:</h4>
<p>Don't think there's anything directly relevant. Maybe reducing inlining threshold would work?</p>



<a name="258077663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258077663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258077663">(Oct 18 2021 at 18:36)</a>:</h4>
<p>I think our best bet right now would be to cherry-pick the inliner patch until there is a solution more acceptable for upstream -- unfortunately I don't have a lot of confidence that there will be one.</p>



<a name="258154792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258154792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258154792">(Oct 19 2021 at 07:46)</a>:</h4>
<p>Nice result on the memory usage front: <a href="https://perf.rust-lang.org/compare.html?start=5dab47dcd8267b8769421b46532414ec36d625e3&amp;end=cfe9eecdf01985dff182ce388fe843987d1da888">https://perf.rust-lang.org/compare.html?start=5dab47dcd8267b8769421b46532414ec36d625e3&amp;end=cfe9eecdf01985dff182ce388fe843987d1da888</a> <a href="https://perf.rust-lang.org/compare.html?start=5dab47dcd8267b8769421b46532414ec36d625e3&amp;end=cfe9eecdf01985dff182ce388fe843987d1da888&amp;stat=max-rss">https://perf.rust-lang.org/compare.html?start=5dab47dcd8267b8769421b46532414ec36d625e3&amp;end=cfe9eecdf01985dff182ce388fe843987d1da888&amp;stat=max-rss</a></p>



<a name="258166686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258166686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258166686">(Oct 19 2021 at 09:37)</a>:</h4>
<p>And best of all the instruction count regression is constently less than 1% and the fast majority less than 0.4%.</p>



<a name="258166776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/258166776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#258166776">(Oct 19 2021 at 09:38)</a>:</h4>
<p>So it may be acceptable to land it for all platforms.</p>



<a name="261972480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/261972480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#261972480">(Nov 18 2021 at 18:53)</a>:</h4>
<p>Has there been any change on this? As far as I can tell, we're just waiting on <a href="https://reviews.llvm.org/D98481">https://reviews.llvm.org/D98481</a> right? The last comment there was over a month ago, just trying to make sure I understand the status.</p>



<a name="261973681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/261973681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#261973681">(Nov 18 2021 at 19:02)</a>:</h4>
<p>no change that I know of</p>



<a name="274264531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274264531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274264531">(Mar 05 2022 at 20:55)</a>:</h4>
<p>I'm tired of arguing with these people, so I'm suggesting that we cherry-pick the current version of the patch. PR is <a href="https://github.com/rust-lang/llvm-project/pull/133">https://github.com/rust-lang/llvm-project/pull/133</a>.</p>



<a name="274270068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274270068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274270068">(Mar 05 2022 at 22:53)</a>:</h4>
<p>I am happy to see whatever you think will fix this problem appear in rustc.</p>
<p>But just to make sure I understand where this puts us, are we going to be in a situation where programs may build fine with the rustc distributed by rustup, but if a distro or whoever links in their LLVM, programs may fail to build due to timeout/OOM?</p>



<a name="274271501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274271501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274271501">(Mar 05 2022 at 23:23)</a>:</h4>
<p>Yup, that's right. In practice this means that distros will have to apply the patch as well.</p>



<a name="274272103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274272103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274272103">(Mar 05 2022 at 23:36)</a>:</h4>
<p>love it.</p>



<a name="274330933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274330933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274330933">(Mar 06 2022 at 22:07)</a>:</h4>
<p>So, they're proposing to land this under a default-disabled option. I'm not sure we should accept.</p>



<a name="274331015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274331015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274331015">(Mar 06 2022 at 22:09)</a>:</h4>
<p>For one, that is problematic where linker plugin LTO is concerned, unless we want people to become experts on LLVM internals and start passing stuff like <code>-Wl,-mllvm,-enable-unbounded-cross-scc-inlining=0</code> in their build system.</p>



<a name="274331415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274331415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274331415">(Mar 06 2022 at 22:17)</a>:</h4>
<p>And second, it's not a rust-specific problem (I've been told that at least Apple also cherry-picked the earlier variant of the patch), so fixing this just for us doesn't sit quite right.</p>



<a name="274331488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274331488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274331488">(Mar 06 2022 at 22:19)</a>:</h4>
<p>So I think we may be better off forcing a distro-level solution than accepting a default-disabled option.</p>



<a name="274331939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274331939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274331939">(Mar 06 2022 at 22:29)</a>:</h4>
<p>Though possibly I'm sufficiently pissed off by these people that I'm taking a needlessly antagonistic position...</p>



<a name="274334194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274334194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274334194">(Mar 06 2022 at 23:14)</a>:</h4>
<p>Or both: land the default-disabled option and enable it in rustc, and also patch it to default enabled in rust-llvm and our distros to cover to and other uses.</p>



<a name="274334479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274334479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274334479">(Mar 06 2022 at 23:21)</a>:</h4>
<p>Yeah, that makes sense. I guess a default-disabled option is strictly better than nothing :) Though if it lands default-disabled, it's probably never going to get enabled...</p>



<a name="274339154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274339154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274339154">(Mar 07 2022 at 01:09)</a>:</h4>
<p>I'd be actually quite curious how many people complain about performance regression(s) if distros end up picking this patch, enabled by default in their repos.</p>



<a name="274339265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274339265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274339265">(Mar 07 2022 at 01:11)</a>:</h4>
<p>I do recall multiple instances where my patch would be rejected because it would cause unbounded code size/comptime perf increase in the past.</p>



<a name="274339363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274339363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274339363">(Mar 07 2022 at 01:13)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> there ain't a more performant program that just produces the side effects without any computation, a enabled-by-default pass that evaluates any computation and leaves the side effects in, could be on the table by the sound of it, halting problem be damned...</p>



<a name="274340300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274340300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274340300">(Mar 07 2022 at 01:34)</a>:</h4>
<p>Just to make sure I'm following, the perf concerns in review with the latest patch are only theoretical, right?</p>



<a name="274340446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274340446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274340446">(Mar 07 2022 at 01:38)</a>:</h4>
<p>It is possible to construct a test case that produces a worse codegen, so not quite.</p>



<a name="274343286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274343286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274343286">(Mar 07 2022 at 02:41)</a>:</h4>
<p>That makes sense. I'm just imagining a world where this gets turned on more and more places, and whenever someone complains about huge compile time the first answer is always "did you pass this flag" and an attempt at explaining why this isn't the default.</p>
<p>But what do I know, I'm just here because we couldn't upgrade our toolchain due to this bug and it'll be addressed in Rust soon.</p>



<a name="274362035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274362035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274362035">(Mar 07 2022 at 08:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/187780-t-compiler.2Fwg-llvm/topic/NewPM.20compile-time.20issues/near/274340300">said</a>:</p>
<blockquote>
<p>Just to make sure I'm following, the perf concerns in review with the latest patch are only theoretical, right?</p>
</blockquote>
<p>Yes, it's purely theoretical at this point, which makes it so annoying. I could understand if they bothered to run some benchmarks, saw a regression and said "I consider this regression a blocking issue, please find a way to preserve performance for this case". But that would make it an actionable concern that could actually be resolved, so that's no good.</p>



<a name="274417951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274417951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> durin42 <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274417951">(Mar 07 2022 at 16:34)</a>:</h4>
<p>I'll poke some folks at Google about this, since if it's effectively-required to have this for Rust then it's hard to imagine we wouldn't carry the patch as well.</p>



<a name="274458564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274458564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274458564">(Mar 07 2022 at 21:14)</a>:</h4>
<p>Yeah, it's not a non-concern so much as it's an airy concern... the form of the concern without the substance.</p>



<a name="274677103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274677103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274677103">(Mar 09 2022 at 11:58)</a>:</h4>
<p>Yay, in the end <a href="https://reviews.llvm.org/D121084">https://reviews.llvm.org/D121084</a> got merged upstream and is in LLVM 14.0.0.</p>



<a name="274685988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187780-t-compiler/wg-llvm/topic/NewPM%20compile-time%20issues/near/274685988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nikita Popov <a href="https://zulip-archive.rust-lang.org/stream/187780-t-compiler/wg-llvm/topic/NewPM.20compile-time.20issues.html#274685988">(Mar 09 2022 at 13:21)</a>:</h4>
<p>PR: <a href="https://github.com/rust-lang/rust/pull/94764">https://github.com/rust-lang/rust/pull/94764</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>