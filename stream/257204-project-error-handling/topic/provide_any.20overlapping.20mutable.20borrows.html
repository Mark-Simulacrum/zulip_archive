<html>
<head><meta charset="utf-8"><title>provide_any overlapping mutable borrows · project-error-handling · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/index.html">project-error-handling</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html">provide_any overlapping mutable borrows</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271016300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271016300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271016300">(Feb 07 2022 at 17:52)</a>:</h4>
<p>RE: <a href="https://github.com/nrc/provide-any/blob/dfff4e26f8f21842a7dcc19fc6a544f14bf4b18b/src/tests.rs#L76">https://github.com/nrc/provide-any/blob/dfff4e26f8f21842a7dcc19fc6a544f14bf4b18b/src/tests.rs#L76</a></p>
<div class="codehilite"><pre><span></span><code>    fn provide_mut&lt;&#39;a&gt;(&amp;&#39;a mut self, req: &amp;mut Requisition&lt;&#39;a&gt;) {
        req.provide_mut::&lt;String&gt;(&amp;mut self.s);
    }
</code></pre></div>
<p>The <code>provide</code> APIs require that the lifetime of the provided type is exactly <code>'a</code>. This is fine for shared borrows, but means that Rust won't let us pass multiple similar exclusive borrows. For example, <code>.provide_mut(&amp;mut self.s).provide_mut(self.s.as_mut_str())</code> won't compile.</p>



<a name="271018937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271018937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271018937">(Feb 07 2022 at 18:08)</a>:</h4>
<p>The first solution that comes to mind is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Demand</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">within</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="nc">C</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">DemandWithin</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DemandWithin</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">cx</span>: <span class="nc">C</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">demand</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">Demand</span><span class="o">&lt;'</span><span class="na">b</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">DemandWithin</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">provide</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">AnyUnowned</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">fulfill</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271019656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271019656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271019656">(Feb 07 2022 at 18:13)</a>:</h4>
<p>which would let an error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">provide_context_mut</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">demand</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Demand</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">demand</span><span class="p">.</span><span class="n">within</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">provide</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">provide</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">as_mut_str</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271283623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271283623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271283623">(Feb 09 2022 at 14:15)</a>:</h4>
<p>That's a good point!</p>



<a name="271291283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271291283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271291283">(Feb 09 2022 at 15:06)</a>:</h4>
<p>I think even more importantly, this will allow <code>provide_context_mut</code> to give its own context types, and then call <code>provide_context</code> too. Which would make the decision between <code>get_context</code>/<code>get_context_mut</code> obvious: use the highest permission you can :)</p>



<a name="271292529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271292529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271292529">(Feb 09 2022 at 15:14)</a>:</h4>
<p>I'm not sure how to implement DemandWithin::Provide - it must return <code>self</code>, but <a href="http://self.cx">self.cx</a> will be consumed by the call to fulfill?</p>



<a name="271293398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271293398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271293398">(Feb 09 2022 at 15:20)</a>:</h4>
<p>yup, the declaration of <code>DemandWithin</code> is more descriptive than anything else :P We'd want to use <code>MaybeUninit</code> (using the <code>Demand</code> to track whether it's been used) or <code>Option</code></p>



<a name="271294414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271294414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271294414">(Feb 09 2022 at 15:26)</a>:</h4>
<p>ah, I see, so the 'within' stuff only lets the calls to provide type check, we'd still need to do something unsafe to implement it</p>



<a name="271320474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271320474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271320474">(Feb 09 2022 at 17:57)</a>:</h4>
<p>Nah, it wouldn't have to be. The unsafe would just be a performance optimization</p>



<a name="271320500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271320500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271320500">(Feb 09 2022 at 17:57)</a>:</h4>
<p>I'll implement it on my alt design real quick</p>



<a name="271322431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271322431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271322431">(Feb 09 2022 at 18:07)</a>:</h4>
<p>Here ya go: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=1e4c0a195b7330d7a2a769aaab31756d">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=1e4c0a195b7330d7a2a769aaab31756d</a></p>



<a name="271322536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271322536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271322536">(Feb 09 2022 at 18:08)</a>:</h4>
<p>unsafe could be used to optimize the overhead of that Option if we really wanted. The <code>unwrap</code> will never panic</p>



<a name="271323166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/provide_any%20overlapping%20mutable%20borrows/near/271323166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Plecra <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/provide_any.20overlapping.20mutable.20borrows.html#271323166">(Feb 09 2022 at 18:11)</a>:</h4>
<p>oh - I've used the new API in <code>&lt;Bar as Foo&gt;::food_mut</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>