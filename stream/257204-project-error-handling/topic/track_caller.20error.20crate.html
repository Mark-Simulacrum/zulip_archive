<html>
<head><meta charset="utf-8"><title>track_caller error crate · project-error-handling · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/index.html">project-error-handling</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html">track_caller error crate</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251622547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251622547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251622547">(Sep 01 2021 at 20:17)</a>:</h4>
<p>In response to <a href="https://github.com/rust-lang/rust/issues/87401">https://github.com/rust-lang/rust/issues/87401</a>, I'd like to start a conversation on error tracing.</p>
<h1>Motivation</h1>
<p>Libraries like <code>anyhow</code> provide easy access to backtraces when producing error values. However, there are a few major problems with using runtime backtrace collection:</p>
<ol>
<li>A backtrace only provides call stack information for the current thread. At my work, errors often pass from one thread to another on their way up to their final consumer.</li>
<li>Runtime backtrace collection can be complicated and expensive. At my work, errors are common, so this performance overhead is meaningful.</li>
</ol>
<h1>Propagation Tracking</h1>
<p>The solution is something I'm calling <strong>error propagation tracking</strong>, which differs from error backtracing. Rather than taking a point-in-time snapshot from the top of some thread's stack, it assembles a backtrace incrementally as the actual error object propagates through different parts of the code.</p>
<p>At my work, we do this in our C code by wrapping all return values in a special <code>forward_error</code> macro that appends the current <code>__func__</code>, <code>__file__</code>, and <code>__line__</code> to a running stack of code locations. </p>
<p>I have experimented with implementing propagation tracking in Rust by writing a wrapper around <code>std::result::Result</code>, adding <code>#[track_caller]</code> to <code>from_residual</code>, and pushing a <code>panic::Location</code> onto a running stack each time an error value is propagated via <code>?</code>.</p>
<h1>Discussion</h1>
<p>Here's what I want to do here:</p>
<ul>
<li>Solicit opinions from other people who have similar desires or use cases for error propagation tracking.</li>
<li>Discuss how I may aid the development of a public crate for this use case.</li>
</ul>
<p>I could start by cleaning up the experiment I wrote at work and putting that up on GitHub for folks to see how I approached it. Sound good?</p>
<p>See also <a href="#narrow/stream/131828-t-compiler/topic/function.20names.20in.20.60.23.5Btrack_caller.5D.60">this topic</a> I started in <a class="stream" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler">#t-compiler</a> regarding getting function names from <code>panic::Location</code>.</p>



<a name="251636496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251636496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251636496">(Sep 01 2021 at 22:02)</a>:</h4>
<blockquote>
<p>Sound good?</p>
</blockquote>
<p>Sounds like a perfect first step</p>



<a name="251777281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251777281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251777281">(Sep 02 2021 at 20:00)</a>:</h4>
<p><a href="https://github.com/BGR360/propagate">https://github.com/BGR360/propagate</a></p>



<a name="251922993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251922993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251922993">(Sep 03 2021 at 18:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251777281">said</a>:</p>
<blockquote>
<p><a href="https://github.com/BGR360/propagate">https://github.com/BGR360/propagate</a></p>
</blockquote>
<p>sorry I didn't have chance to review this yesterday, taking a look at it now</p>



<a name="251923010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923010">(Sep 03 2021 at 18:24)</a>:</h4>
<p>first thing that sticks out to me is the <code>new_err</code> method</p>



<a name="251923050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923050">(Sep 03 2021 at 18:24)</a>:</h4>
<p>I really want to find ways to structure the usage so that this is never necessary</p>



<a name="251923073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923073">(Sep 03 2021 at 18:25)</a>:</h4>
<p>my instinct is that we should try relying heavily on <code>try { }</code> blocks</p>



<a name="251923254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923254">(Sep 03 2021 at 18:26)</a>:</h4>
<p>and then have the <code>from_residual</code> impl handle constructing the error stack</p>



<a name="251923308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923308">(Sep 03 2021 at 18:26)</a>:</h4>
<p>and rely on people to just use <code>Err(error)?</code> when they need to return a new error rather than using <code>Resuilt::new_err(error)</code></p>



<a name="251923371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923371">(Sep 03 2021 at 18:27)</a>:</h4>
<p>Also I expect it will be better received if the recommended workflow isn't to import and override the <code>std::result::Result</code> type</p>



<a name="251923414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923414">(Sep 03 2021 at 18:27)</a>:</h4>
<p>We've talked about this in libs API discussions before and our general recommendation is to not introduce new identifiers that overlap with identifiers in the std and core preludes</p>



<a name="251923484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923484">(Sep 03 2021 at 18:28)</a>:</h4>
<p>because these can cause significant confusion when new devs encounter the source code and can be ambiguous in certain debugging situations</p>



<a name="251923519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923519">(Sep 03 2021 at 18:28)</a>:</h4>
<p>having a prelude for the crate is fine, but it shouldn't bring in things as <code>Result</code>, probably better to stick to something like <code>TrackedResult</code> or <code>TracedResult</code></p>



<a name="251923621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251923621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251923621">(Sep 03 2021 at 18:29)</a>:</h4>
<p>ill try using this in one of my personal projects and see how I feel about the rest of the API and play with it a bit</p>



<a name="251941409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251941409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251941409">(Sep 03 2021 at 21:01)</a>:</h4>
<p>also it looks like a lot of the doc tests are broken</p>



<a name="251941600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251941600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251941600">(Sep 03 2021 at 21:02)</a>:</h4>
<p>curious why you set <code>doctest = false</code></p>



<a name="251951318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251951318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251951318">(Sep 03 2021 at 22:44)</a>:</h4>
<p>actually, after playing with this a bunch this might be a good candidate for another module in <code>trial-and-error</code></p>



<a name="251957136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957136">(Sep 04 2021 at 00:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251941600">said</a>:</p>
<blockquote>
<p>curious why you set <code>doctest = false</code></p>
</blockquote>
<p>was too lazy to make the doctests compile</p>



<a name="251957203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957203">(Sep 04 2021 at 00:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251923073">said</a>:</p>
<blockquote>
<p>my instinct is that we should try relying heavily on <code>try { }</code> blocks</p>
</blockquote>
<p>this is something I'll need to read up on, have never touched <code>try</code></p>



<a name="251957241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957241">(Sep 04 2021 at 00:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251957136">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251941600">said</a>:</p>
<blockquote>
<p>curious why you set <code>doctest = false</code></p>
</blockquote>
<p>was too lazy to make the doctests compile</p>
</blockquote>
<p>hehe, fair</p>



<a name="251957334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957334">(Sep 04 2021 at 00:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251923371">said</a>:</p>
<blockquote>
<p>Also I expect it will be better received if the recommended workflow isn't to import and override the <code>std::result::Result</code> type</p>
</blockquote>
<p>Good point. I brought in bias from my use case, which has no real need to ever touch <code>std::result::Result</code> again given the replacement exists. But setting that up would trivial for a user of the propagate crate; they just make their own prelude for their own code</p>



<a name="251957376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957376">(Sep 04 2021 at 00:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251951318">said</a>:</p>
<blockquote>
<p>actually, after playing with this a bunch this might be a good candidate for another module in <code>trial-and-error</code></p>
</blockquote>
<p>What is that?</p>



<a name="251957795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957795">(Sep 04 2021 at 00:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251923073">said</a>:</p>
<blockquote>
<p>my instinct is that we should try relying heavily on <code>try { }</code> blocks</p>
</blockquote>
<p>Okay those are less involved than I thought. Can you paint for me a clearer picture of what you're thinking it would look like if we made use of <code>try</code>?</p>



<a name="251957843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957843">(Sep 04 2021 at 00:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251957376">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251951318">said</a>:</p>
<blockquote>
<p>actually, after playing with this a bunch this might be a good candidate for another module in <code>trial-and-error</code></p>
</blockquote>
<p>What is that?</p>
</blockquote>
<p>It's a crate we're currently working on for experiments</p>



<a name="251957888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251957888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251957888">(Sep 04 2021 at 00:16)</a>:</h4>
<p>right now it has a <code>boxerrror_replacement</code> module and <code>error_reporter</code> module</p>



<a name="251958314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958314">(Sep 04 2021 at 00:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251957795">said</a>:</p>
<blockquote>
<p>Can you paint for me a clearer picture of what you're thinking it would look like if we made use of <code>try</code>?</p>
</blockquote>
<p>Nevermind, I didn't read close enough. Your idea is to require <code>Err(error)?</code> and then let <code>from_residual</code> convert it to the wrapped type. Would that not work without a <code>try</code> block?</p>



<a name="251958556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958556">(Sep 04 2021 at 00:27)</a>:</h4>
<p>The error conversion works either way with try blocks but you always have to use question mark inside of it and you never do ok wrapping</p>



<a name="251958620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958620">(Sep 04 2021 at 00:28)</a>:</h4>
<p>Which solves the forwarding concern that you have in the docs since with try blocks you have no choice but to forward correctly by using the question mark operator</p>



<a name="251958643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958643">(Sep 04 2021 at 00:28)</a>:</h4>
<p>noiiiice. you do have to rely on users actually using try blocks though, yes?</p>



<a name="251958647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958647">(Sep 04 2021 at 00:28)</a>:</h4>
<p>And it also makes it so you don't have to worry about shadowing Ok</p>



<a name="251958675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958675">(Sep 04 2021 at 00:29)</a>:</h4>
<p>Yeah it's up to users to use it but I don't think it will take much encouragement if they already have to enable other nightly features just to use the crate</p>



<a name="251958697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958697">(Sep 04 2021 at 00:29)</a>:</h4>
<p>And if all the examples use it and the APIs are much nicer to use with try blocks then I think people will just use try blocks</p>



<a name="251958754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958754">(Sep 04 2021 at 00:30)</a>:</h4>
<p>Also getting more people testing try blocks and the new trait would be really good so we can iron those out and get stabilized faster</p>



<a name="251958808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958808">(Sep 04 2021 at 00:31)</a>:</h4>
<p>Another thing to consider is the burden of duplicating all of the <code>std::result::Result</code> functionality. In theory, I think one could achieve the same behavior using <code>std::result::Result</code> if it had <code>#[track_caller]</code> on its <code>from_residual</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(trait_specialization)]</span><span class="w"></span>

<span class="sd">/// Specializes the blanket `From&lt;T&gt; for T` implementation so we can capture all invocations of</span>
<span class="sd">/// `From::from` that `from_residual` makes.</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">From</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[track_caller]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">e</span>: <span class="nc">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">push_caller</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span>: <span class="nb">From</span>::<span class="n">from</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">error</span><span class="p">),</span><span class="w"> </span><span class="n">stack</span>: <span class="nc">e</span><span class="p">.</span><span class="n">stack</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251958834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958834">(Sep 04 2021 at 00:31)</a>:</h4>
<p>Yeah but we talked in the original issue about this and how that would cause some pretty serious perf issues across the ecosystem</p>



<a name="251958903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958903">(Sep 04 2021 at 00:32)</a>:</h4>
<p>Oh wait you mean with specialization</p>



<a name="251958952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958952">(Sep 04 2021 at 00:33)</a>:</h4>
<p>That might be a valid specialization but There's a decent chance it's not</p>



<a name="251958968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958968">(Sep 04 2021 at 00:33)</a>:</h4>
<p>I don't know all the cases of when it's okay to specialize versus when it's not but I know usually when you specialize a generic impl with another generic impl it starts running into soundness issues</p>



<a name="251958975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251958975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251958975">(Sep 04 2021 at 00:33)</a>:</h4>
<p>Because lifetime dependencies can start sneaking in</p>



<a name="251959021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959021">(Sep 04 2021 at 00:34)</a>:</h4>
<p>This is blocking a lot of other changes I want to make involving error handling</p>



<a name="251959062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959062">(Sep 04 2021 at 00:35)</a>:</h4>
<p>Yes, specialization <strong>and</strong> <code>#[track_caller]</code> on <code>from_residual</code>.</p>
<p>I can understand how adding <code>#[track_caller]</code> to <code>from_residual</code> would cause code bloat, but I failed to understand where the perf hit would come from when it was brought up on GH.</p>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251958968">said</a>:</p>
<blockquote>
<p>I don't know all the cases of when it's okay to specialize versus when it's not but I know usually when you specialize a generic impl with another generic impl it starts running into soundness issues</p>
</blockquote>
<p>To my naive mind, this use does seem to fall under "more specific" <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> . But yeah I believe you when you say it probably gets hairy.</p>



<a name="251959199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959199">(Sep 04 2021 at 00:37)</a>:</h4>
<blockquote>
<p>To my naive mind, this use does seem to fall under "more specific"</p>
</blockquote>
<p>yea, the issue in particular pops up when you try to specialize <code>std::fmt::Debug</code> with <code>std::fmt::Error</code>, where error is clearly more specific than <code>Debug</code> but because the impls can depend on lifetimes the impls may not always apply</p>



<a name="251959203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959203">(Sep 04 2021 at 00:37)</a>:</h4>
<p><a href="https://smallcultfollowing.com/babysteps/blog/2018/02/09/maximally-minimal-specialization-always-applicable-impls/#the-soundness-problem">https://smallcultfollowing.com/babysteps/blog/2018/02/09/maximally-minimal-specialization-always-applicable-impls/#the-soundness-problem</a></p>



<a name="251959257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959257">(Sep 04 2021 at 00:38)</a>:</h4>
<blockquote>
<p>but I failed to understand where the perf hit would come from when it was brought up on GH.</p>
</blockquote>
<p>was the suggestion in the github issue something other than adding #[track_caller] to from_residual?</p>



<a name="251959263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959263">(Sep 04 2021 at 00:38)</a>:</h4>
<p>I may have misunderstood if that's the case</p>



<a name="251959332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959332">(Sep 04 2021 at 00:39)</a>:</h4>
<blockquote>
<p>was the suggestion in the github issue something other than adding #[track_caller] to from_residual?</p>
</blockquote>
<p>nope, you got it. I'm probably missing something obvious, but I don't know why <code>#[track_caller]</code> adds a perf hit</p>



<a name="251959409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959409">(Sep 04 2021 at 00:40)</a>:</h4>
<p>is it a compiler perf hit? or a runtime perf hit?</p>



<a name="251959411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959411">(Sep 04 2021 at 00:40)</a>:</h4>
<p>runtime perf</p>



<a name="251959497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959497">(Sep 04 2021 at 00:42)</a>:</h4>
<p>I'm not sure exactly how it ends up causing the perf hit, I would expect a lot of the location data to optimize away, but @dtolnay indicated he thought it highly likely there would be a noticeable perf hit in our libs-api team meeting</p>



<a name="251959537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959537">(Sep 04 2021 at 00:43)</a>:</h4>
<p>iirc track caller works by transparently adding an extra argument to the function before lowering it to llvm ir</p>



<a name="251959558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959558">(Sep 04 2021 at 00:43)</a>:</h4>
<p>so I'm assuming it increases stack frame sizes</p>



<a name="251959573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959573">(Sep 04 2021 at 00:44)</a>:</h4>
<p>also it adds a lot more static locations to the final binary, increasing the binary size</p>



<a name="251959623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959623">(Sep 04 2021 at 00:44)</a>:</h4>
<p>and i would expect most of what goes unused to get optimized away but I'm guessing that doesn't happen always</p>



<a name="251959675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959675">(Sep 04 2021 at 00:45)</a>:</h4>
<blockquote>
<p>so I'm assuming it increases stack frame sizes</p>
</blockquote>
<p>By no more than 8 bytes per frame I would think. The <code>panic::Location</code>s are statically allocated and <code>Location::caller()</code> gives a reference to one.</p>
<p>Anyway, sounds like it's at least worth getting clarity on and not totally ruling it out until we do.</p>



<a name="251959688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959688">(Sep 04 2021 at 00:46)</a>:</h4>
<p>yea</p>



<a name="251959736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251959736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251959736">(Sep 04 2021 at 00:46)</a>:</h4>
<p>we're not certain it will cause perf problems so it's almost certainly worth testing</p>



<a name="251960110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960110">(Sep 04 2021 at 00:52)</a>:</h4>
<p>I'm off work all next week so I'll have time to play around with this more. I will try switching over to using <code>try</code> blocks and see how that goes.</p>
<p>I also plan to generalize the <code>ErrorStack</code> so users can customize how they store their stack of locations. Roughly:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Stack</span>: <span class="nb">Default</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Iter</span>: <span class="nb">IntoIterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">push_location</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span>: <span class="kp">&amp;</span><span class="nc">panic</span>::<span class="n">Location</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">iter</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Iter</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">Stack</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">error</span>: <span class="nc">E</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">stack</span>: <span class="nc">S</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">Stack</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultStack</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This will be necessary for my use case at work to help us convert traces between Rust and C code.</p>



<a name="251960294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960294">(Sep 04 2021 at 00:55)</a>:</h4>
<p>Oh cool</p>



<a name="251960325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960325">(Sep 04 2021 at 00:55)</a>:</h4>
<p>and of course all names are stored in the bike shed <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="251960375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960375">(Sep 04 2021 at 00:56)</a>:</h4>
<p>So this is becoming more similar to the air return trace proposal I've written in the past</p>



<a name="251960380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960380">(Sep 04 2021 at 00:56)</a>:</h4>
<p>Error*</p>



<a name="251960400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960400">(Sep 04 2021 at 00:56)</a>:</h4>
<p>link? haven't come across that yet</p>



<a name="251960406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960406">(Sep 04 2021 at 00:56)</a>:</h4>
<p>And I'm wondering if instead ErrorStack should be the thing that gets swapped out and implements the trait</p>



<a name="251960427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960427">(Sep 04 2021 at 00:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251960406">said</a>:</p>
<blockquote>
<p>And I'm wondering if instead ErrorStack should be the thing that gets swapped out and implements the trait</p>
</blockquote>
<p>hm, probably</p>



<a name="251960453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960453">(Sep 04 2021 at 00:57)</a>:</h4>
<p><a href="https://mobile.twitter.com/yaahc_/status/1253771822920634369?s=19">https://mobile.twitter.com/yaahc_/status/1253771822920634369?s=19</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://mobile.twitter.com/yaahc_/status/1253771822920634369?s=19"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/eeaff3a60f7422ff43d15ea1fba5c17154dd4cc3/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313236303734363233383532373332343136322f6f4d4a48724846435f6e6f726d616c2e6a7067"></a><p>Proof Of Concept: Error Return Traces in rust

aka lightweight backtraces <a href="https://t.co/5u4mBYRjQp">https://twitter.com/yaahc_/status/1253771822920634369/photo/1</a></p><span>- Yaah (@yaahc_)</span><div class="twitter-image"><a href="https://t.co/5u4mBYRjQp"><img src="https://uploads.zulipusercontent.net/a4078737b4d3366f66dcf9c9e3f7dc57c3b249f7/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f45575a4b7a426756634141663177752e6a70673a7468756d62"></a></div><div class="twitter-image"><a href="https://t.co/5u4mBYRjQp"><img src="https://uploads.zulipusercontent.net/7d18ee4d2b4d9d5aa34505d432c991a492dcbd6e/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f45575a4b7a2d4255774141484149522e6a70673a7468756d62"></a></div><div class="twitter-image"><a href="https://t.co/5u4mBYRjQp"><img src="https://uploads.zulipusercontent.net/ff5fd3e919ab98789660a8971c9dc4aaffb41794/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f45575a4b306d37566341416a724f712e6a70673a6c61726765"></a></div></div></div>



<a name="251960558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960558">(Sep 04 2021 at 00:59)</a>:</h4>
<p>The trait is like a subset of yours, where it only has the push_location method</p>



<a name="251960566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960566">(Sep 04 2021 at 00:59)</a>:</h4>
<p>And it goes on the error type itself</p>



<a name="251960678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960678">(Sep 04 2021 at 01:00)</a>:</h4>
<p>And that error type could be a wrapper like ErrorStack that handles the storage for inner error types or some c ffi friendly equivalent or even stored directly in a vec within your error type</p>



<a name="251960717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960717">(Sep 04 2021 at 01:01)</a>:</h4>
<p>The solution I've always imagined for this is a combination between this track trait and generic member access in order to get the locations back out of errors in the chain</p>



<a name="251960797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960797">(Sep 04 2021 at 01:02)</a>:</h4>
<p>But I've never really liked the solution because I've always implicitly assumed that you would be duplicating vecs on multiple errors in a chain of sources and it would just be really inefficient to spread the storage across all the errors</p>



<a name="251960858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251960858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251960858">(Sep 04 2021 at 01:04)</a>:</h4>
<p>Tho it has the really cool property of letting you associate each return with the source in the chain that actually captured it</p>



<a name="251961273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961273">(Sep 04 2021 at 01:11)</a>:</h4>
<p>Perhaps:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">TracedError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">StackEntry</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">error</span>: <span class="nc">E</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">push_location</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span>: <span class="kp">&amp;</span><span class="nc">Location</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">err</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">E</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">convert_err</span><span class="o">&lt;</span><span class="n">F</span>: <span class="nb">From</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TracedError</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* some trait method(s) to access StackEntry's */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">TracedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SomeDefaultImpl</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">S</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251961342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961342">(Sep 04 2021 at 01:12)</a>:</h4>
<p>I think most of these methods could be bounds on other traits where they're needed</p>



<a name="251961361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961361">(Sep 04 2021 at 01:13)</a>:</h4>
<p>I'm definitely n00b at making good interfaces, please massage it to your will.</p>



<a name="251961392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961392">(Sep 04 2021 at 01:13)</a>:</h4>
<p>So instead of convert error you have the from residual impl require E: Into&lt;F&gt; + TracedError</p>



<a name="251961685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961685">(Sep 04 2021 at 01:19)</a>:</h4>
<p>edit: actually I don't think I can explain this without just ending up rewriting the error return trace stuff I'd written before</p>



<a name="251961923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961923">(Sep 04 2021 at 01:23)</a>:</h4>
<p>let me see if I can dig up a copy of that</p>



<a name="251961981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961981">(Sep 04 2021 at 01:24)</a>:</h4>
<p>yea i think that might be lost to an old PC</p>



<a name="251961986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251961986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251961986">(Sep 04 2021 at 01:24)</a>:</h4>
<p>dangit</p>



<a name="251962235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962235">(Sep 04 2021 at 01:29)</a>:</h4>
<p>I think my plan ends up breaking when you try to write <code>impl&lt;E, F&gt; From&lt;E&gt; for ErrorStack&lt;F&gt; where F: From&lt;E&gt;</code></p>



<a name="251962237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962237">(Sep 04 2021 at 01:29)</a>:</h4>
<p>lets see if that's an illegal from impl</p>



<a name="251962318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962318">(Sep 04 2021 at 01:30)</a>:</h4>
<p>yup</p>



<a name="251962319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962319">(Sep 04 2021 at 01:30)</a>:</h4>
<p>error[E0119]: conflicting implementations of trait <code>std::convert::From&lt;ErrorStack&lt;_&gt;&gt;</code> for type <code>ErrorStack&lt;_&gt;</code><br>
 --&gt; src/main.rs:3:1<br>
  |<br>
3 | impl&lt;E, F&gt; From&lt;E&gt; for ErrorStack&lt;F&gt; where F: From&lt;E&gt; {<br>
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>
  |<br>
  = note: conflicting implementation in crate <code>core</code>:</p>
<div class="codehilite"><pre><span></span><code>      - impl&lt;T&gt; From&lt;T&gt; for T;
</code></pre></div>



<a name="251962336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962336">(Sep 04 2021 at 01:30)</a>:</h4>
<p>would that be any different with <code>#[trait_specialization]</code>?</p>



<a name="251962363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962363">(Sep 04 2021 at 01:31)</a>:</h4>
<p>i think in theory but it requires lattice specialization</p>



<a name="251962369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962369">(Sep 04 2021 at 01:31)</a>:</h4>
<p>and that isn't something on the near horizon</p>



<a name="251962435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962435">(Sep 04 2021 at 01:32)</a>:</h4>
<p>I think this can work</p>



<a name="251962658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962658">(Sep 04 2021 at 01:36)</a>:</h4>
<p>My experience wrestling with conflicting impls when making the prototype led me to a point where the only bounds I included were bounds for the inner error types. I think that's what caused the <code>convert_inner</code> function to be born.</p>



<a name="251962676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962676">(Sep 04 2021 at 01:37)</a>:</h4>
<p>yea</p>



<a name="251962688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962688">(Sep 04 2021 at 01:37)</a>:</h4>
<p>But you may very well come up with something better that works, cuz my type-fu is still beginner</p>



<a name="251962755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962755">(Sep 04 2021 at 01:38)</a>:</h4>
<p>yea I'm not sure I can, I'll keep thinking about it but so far I don't see a way</p>



<a name="251962772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962772">(Sep 04 2021 at 01:39)</a>:</h4>
<p>hmmm</p>



<a name="251962784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962784">(Sep 04 2021 at 01:39)</a>:</h4>
<p>maybe you can leave the From impls to the types being wrapped by <code>ErrorStack</code></p>



<a name="251962789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962789">(Sep 04 2021 at 01:39)</a>:</h4>
<p>and not try having a single generic impl to rule them all</p>



<a name="251962795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962795">(Sep 04 2021 at 01:39)</a>:</h4>
<p>I think that might make it work</p>



<a name="251962877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962877">(Sep 04 2021 at 01:40)</a>:</h4>
<p>where you have a <code>Result&lt;T, E&gt; { Ok(T), Err(E) }</code> and a <code>type TracedResult&lt;T, E&gt; = Result&lt;T, ErrorStack&lt;E&gt;&gt;;</code></p>



<a name="251962896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962896">(Sep 04 2021 at 01:41)</a>:</h4>
<p>where the type alias is something you'd provide for convenience or a pattern which you could copy to introduce alternative wrapper types</p>



<a name="251962954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962954">(Sep 04 2021 at 01:42)</a>:</h4>
<p>Then the FromResidual impl on <code>Result</code> just requires <code>F: From&lt;E&gt; + Traced</code> and <code>Traced</code> just does <code>push_location</code></p>



<a name="251962971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962971">(Sep 04 2021 at 01:42)</a>:</h4>
<p>ooh</p>



<a name="251962975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962975">(Sep 04 2021 at 01:43)</a>:</h4>
<p>wait fk no I think that ends up still not working</p>



<a name="251962995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251962995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251962995">(Sep 04 2021 at 01:43)</a>:</h4>
<p>you need to write <code>impl&lt;E&gt; From&lt;E&gt; for ErrorStack&lt;MyError&gt;</code></p>



<a name="251963002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963002">(Sep 04 2021 at 01:43)</a>:</h4>
<p>which is illegal I think</p>



<a name="251963055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963055">(Sep 04 2021 at 01:44)</a>:</h4>
<p>not positive tho</p>



<a name="251963059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963059">(Sep 04 2021 at 01:44)</a>:</h4>
<p>time to test</p>



<a name="251963062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963062">(Sep 04 2021 at 01:44)</a>:</h4>
<p>oh yes I'm remembering now that this was a huge pain in my ass.</p>



<a name="251963086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963086">(Sep 04 2021 at 01:45)</a>:</h4>
<p>I did initially want to use <code>from_residual</code> to both go from <code>E</code> to <code>ErrorStack&lt;E&gt;</code> and from <code>ErrorStack&lt;E&gt;</code> to <code>ErrorStack&lt;F&gt;</code>, but couldn't find a way to avoid conflicting impls</p>



<a name="251963164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963164">(Sep 04 2021 at 01:46)</a>:</h4>
<p>it works so long as <code>ErrorStack</code> is hardcoded into the <code>Result</code> I think</p>



<a name="251963181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963181">(Sep 04 2021 at 01:46)</a>:</h4>
<p>I tried some heinous things like defining an <code>auto trait NotStackError</code> that I put all over the place in trait bounds.</p>



<a name="251963188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963188">(Sep 04 2021 at 01:46)</a>:</h4>
<p>lol</p>



<a name="251963200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963200">(Sep 04 2021 at 01:47)</a>:</h4>
<p>but yea</p>



<a name="251963205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963205">(Sep 04 2021 at 01:47)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// Starts a new stack when a [`std::result::Result`] is coerced to a [`Result`] using `?`.</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">From</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">FromResidual</span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">result</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="n">Infallible</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[track_caller]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from_residual</span><span class="p">(</span><span class="n">residual</span>: <span class="nc">std</span>::<span class="n">result</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="n">Infallible</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">residual</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span>::<span class="n">result</span>::<span class="nb">Result</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span>::<span class="n">result</span>::<span class="nb">Result</span>::<span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ErrorStack</span>::<span class="n">new</span><span class="p">(</span><span class="nb">From</span>::<span class="n">from</span><span class="p">(</span><span class="n">e</span><span class="p">))),</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251963208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963208">(Sep 04 2021 at 01:47)</a>:</h4>
<p>this compiles just fine</p>



<a name="251963490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963490">(Sep 04 2021 at 01:53)</a>:</h4>
<p>oh but that's not what you meant</p>



<a name="251963497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963497">(Sep 04 2021 at 01:53)</a>:</h4>
<p>you mean when you tried taking ErrorStack out of Result and into the <code>FromResidual</code> impl</p>



<a name="251963499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963499">(Sep 04 2021 at 01:53)</a>:</h4>
<p>and yea that wouldn't work</p>



<a name="251963582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963582">(Sep 04 2021 at 01:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251961273">said</a>:</p>
<blockquote>
<p>Perhaps:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">TracedError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">StackEntry</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">error</span>: <span class="nc">E</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">push_location</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span>: <span class="kp">&amp;</span><span class="nc">Location</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">err</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">E</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">convert_err</span><span class="o">&lt;</span><span class="n">F</span>: <span class="nb">From</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TracedError</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* some trait method(s) to access StackEntry's */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">TracedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SomeDefaultImpl</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">S</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>does this compile?</p>



<a name="251963603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963603">(Sep 04 2021 at 01:55)</a>:</h4>
<p>I feel like it shouldn't because it looks like <code>S&lt;E&gt;</code> is a bare trait object</p>



<a name="251963646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963646">(Sep 04 2021 at 01:56)</a>:</h4>
<p>basically a HKT</p>



<a name="251963648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963648">(Sep 04 2021 at 01:56)</a>:</h4>
<p>i thiink</p>



<a name="251963655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963655">(Sep 04 2021 at 01:56)</a>:</h4>
<p>where you're trying to use the trait as a type constructor</p>



<a name="251963683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963683">(Sep 04 2021 at 01:57)</a>:</h4>
<p>Would this work?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">TracedError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SomeDefaultImpl</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">S</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251963712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963712">(Sep 04 2021 at 01:57)</a>:</h4>
<p>not sure</p>



<a name="251963714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963714">(Sep 04 2021 at 01:57)</a>:</h4>
<p>dubious</p>



<a name="251963798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963798">(Sep 04 2021 at 01:59)</a>:</h4>
<p>Going back a bit, did you arrive at thinking we can't get this to work?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">type</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>If that's the case, then idk how we'd get <code>Err(error)?</code> to work for wrapping.</p>



<a name="251963910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963910">(Sep 04 2021 at 02:00)</a>:</h4>
<p>yea I don't see how we can make that work but I'm not sure</p>



<a name="251963994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251963994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251963994">(Sep 04 2021 at 02:02)</a>:</h4>
<p>in general im not sure how to make the <code>ErrorStack</code> type generic and get that same convenience as the current API that hard codes the ErrorStack type</p>



<a name="251964013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964013">(Sep 04 2021 at 02:02)</a>:</h4>
<p>but i suspect there might be a clever way</p>



<a name="251964023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964023">(Sep 04 2021 at 02:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/251960110">said</a>:</p>
<blockquote>
<p>I'm off work all next week so I'll have time to play around with this more. I will try switching over to using <code>try</code> blocks and see how that goes.</p>
<p>I also plan to generalize the <code>ErrorStack</code> so users can customize how they store their stack of locations. Roughly:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Stack</span>: <span class="nb">Default</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Iter</span>: <span class="nb">IntoIterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">push_location</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">loc</span>: <span class="kp">&amp;</span><span class="nc">panic</span>::<span class="n">Location</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">iter</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Iter</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">Stack</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">error</span>: <span class="nc">E</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">stack</span>: <span class="nc">S</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span>: <span class="nc">Stack</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultStack</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This will be necessary for my use case at work to help us convert traces between Rust and C code.</p>
</blockquote>
<p>this may be the right path</p>



<a name="251964202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964202">(Sep 04 2021 at 02:06)</a>:</h4>
<p>I'm not sure how that approach makes the inherent challenge any easier. The inherent challenge being we need two from_residuals that probably conflict:</p>
<ul>
<li><code>Result&lt;_, wrapped&gt; -&gt; Result&lt;_, wrapped&gt;</code></li>
<li><code>Result&lt;_, not_wrapped&gt; -&gt; Result&lt;_, wrapped&gt;</code></li>
</ul>
<p>But I think we can solve that by introducing a new trait to serve the role of <code>From</code> for converting unwrapped to wrapped.</p>



<a name="251964238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964238">(Sep 04 2021 at 02:07)</a>:</h4>
<p>I think those get disambiguated by one being <code>FromResidual&lt;propagate::Result&gt;</code> and the other being <code>FromResidual&lt;std::Result&gt;</code></p>



<a name="251964325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964325">(Sep 04 2021 at 02:08)</a>:</h4>
<p>and then we don't rely on <code>ErrorStack::from</code></p>



<a name="251964330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964330">(Sep 04 2021 at 02:08)</a>:</h4>
<p>we use <code>ErrorStack::new</code></p>



<a name="251964333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964333">(Sep 04 2021 at 02:08)</a>:</h4>
<p>then we don't have conflicting From impls</p>



<a name="251964341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964341">(Sep 04 2021 at 02:09)</a>:</h4>
<p>this is the same approach used in <code>trial-and-error</code></p>



<a name="251964362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964362">(Sep 04 2021 at 02:09)</a>:</h4>
<p><a href="https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs">https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs</a></p>



<a name="251964419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964419">(Sep 04 2021 at 02:10)</a>:</h4>
<p><a href="https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L121">https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L121</a> this does the wrapping</p>



<a name="251964429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964429">(Sep 04 2021 at 02:10)</a>:</h4>
<p>this one handles one that's already been wrapped</p>



<a name="251964430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964430">(Sep 04 2021 at 02:10)</a>:</h4>
<p><a href="https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L133">https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L133</a></p>



<a name="251964444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964444">(Sep 04 2021 at 02:11)</a>:</h4>
<p>tho this doesn't need to keep doing From</p>



<a name="251964447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964447">(Sep 04 2021 at 02:11)</a>:</h4>
<p>so it may actually not apply</p>



<a name="251964449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964449">(Sep 04 2021 at 02:11)</a>:</h4>
<p><span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="251964459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251964459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251964459">(Sep 04 2021 at 02:11)</a>:</h4>
<p>worth trying and seeing what the compiler says imo</p>



<a name="251965160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965160">(Sep 04 2021 at 02:24)</a>:</h4>
<p>What about this. The key here is not using <code>From</code> as a bound for any of the <code>FromResidual</code> impls.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">WrapError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">e</span>: <span class="nc">E</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">ConvertError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">convert</span><span class="p">(</span><span class="n">e</span>: <span class="nc">E</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">From</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">WrapError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">From</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ConvertError</span><span class="o">&lt;</span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="nb">Err</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">type</span> <span class="nc">TracedResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorStack</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>

<span class="sd">/// Wraps error variant in an ErrorStack, starts new stack</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nc">WrapError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">FromResidual</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;!</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="sd">/// Converts ErrorStack to ErrorStack, pushes a location</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nc">ConvertError</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">FromResidual</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;!</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251965292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965292">(Sep 04 2021 at 02:27)</a>:</h4>
<p>i'll try it</p>



<a name="251965731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965731">(Sep 04 2021 at 02:35)</a>:</h4>
<p>I think i got it working</p>



<a name="251965732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965732">(Sep 04 2021 at 02:35)</a>:</h4>
<p>let me push rq</p>



<a name="251965742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965742">(Sep 04 2021 at 02:35)</a>:</h4>
<p>not sure</p>



<a name="251965753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965753">(Sep 04 2021 at 02:35)</a>:</h4>
<p>i might have some messed up defaulted parameters on some trait impls</p>



<a name="251965815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965815">(Sep 04 2021 at 02:36)</a>:</h4>
<p>tell me if this is remotely close to what you meant / need <span class="user-mention" data-user-id="435059">@Ben Reeves</span></p>



<a name="251965847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965847">(Sep 04 2021 at 02:37)</a>:</h4>
<p><a href="https://github.com/yaahc/propagate/commit/7f0b769814c6de320c160f3d44e13b63493a5d3d">https://github.com/yaahc/propagate/commit/7f0b769814c6de320c160f3d44e13b63493a5d3d</a></p>



<a name="251965864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251965864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251965864">(Sep 04 2021 at 02:37)</a>:</h4>
<p>its extremely messy</p>



<a name="251966093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251966093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251966093">(Sep 04 2021 at 02:42)</a>:</h4>
<p>oops i tried commenting thinking it was a PR and i could aggregate multiple into a review. we can just chat here</p>



<a name="251966151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251966151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251966151">(Sep 04 2021 at 02:42)</a>:</h4>
<p>there is a PR</p>



<a name="251966158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251966158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251966158">(Sep 04 2021 at 02:42)</a>:</h4>
<p><a href="https://github.com/BGR360/propagate/pull/1">https://github.com/BGR360/propagate/pull/1</a> includes that commit</p>



<a name="251966900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251966900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251966900">(Sep 04 2021 at 02:58)</a>:</h4>
<p>ok yeah i think this is coming together for me</p>



<a name="251967285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251967285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251967285">(Sep 04 2021 at 03:04)</a>:</h4>
<p>This looks pretty nice.</p>
<p>I was stuck on assuming that <code>Err</code> would be shadowed by <code>propagate::Result::Err</code>. Because of that I assumed we would need a third <code>FromResidual</code> impl to enable the <code>Err(error)?</code> wrapping. But with your approach it just uses the existing <code>FromResidual&lt;std::result::Result&gt;</code>.</p>
<p>I'm not a huge fan of seeing <code>propagate::Ok(..)</code>. Is that fully unnecessary if the user always uses <code>try</code> blocks?</p>



<a name="251967408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251967408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251967408">(Sep 04 2021 at 03:06)</a>:</h4>
<p>It still comes up in match statements if you don't bring it into scope</p>



<a name="251967417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251967417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251967417">(Sep 04 2021 at 03:06)</a>:</h4>
<p>But everywhere else it would be gone if you use try blocks</p>



<a name="251967515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251967515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251967515">(Sep 04 2021 at 03:08)</a>:</h4>
<p>That's probably a good thing actually. <code>propagate::Err(e) =&gt; {}</code>makes it more obvious that <code>e</code> is not the wrapped value</p>



<a name="251967538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/251967538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#251967538">(Sep 04 2021 at 03:09)</a>:</h4>
<p>Though it's not really symmetric; <code>propagate::Ok(t) =&gt; {}</code> is in fact just <code>T</code>.</p>



<a name="252486880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/252486880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Chen (he/him) <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#252486880">(Sep 08 2021 at 16:03)</a>:</h4>
<p>One thought I had while looking over the implementation is that it would nice if it wasn't necessary for users to have to do <code>Ok(result?)</code> in order to include the function in the stack trace. I have no idea if there's a more ergonomic work-around for this though <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="252543554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/252543554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#252543554">(Sep 08 2021 at 22:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300743">Sean Chen (he/him)</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/252486880">said</a>:</p>
<blockquote>
<p>One thought I had while looking over the implementation is that it would nice if it wasn't necessary for users to have to do <code>Ok(result?)</code> in order to include the function in the stack trace. Either that or if the type system could catch when the user forgot to do this. I have no idea how or if these are possible though <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>
</blockquote>
<p>I agree. The only way we see of doing this is for the user to use <code>try</code> blocks:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">propagate</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">bar</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">propagate</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">()</span><span class="o">?</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>You don't need <code>Ok</code> because it's a try block, and the compiler will force you to do <code>foo()?</code> instead of  it won't work with <code>foo()</code></p>
<p>See the updated main branch for these two examples:<br>
<a href="https://github.com/BGR360/propagate/blob/5cb618e/examples/usage.rs">examples/usage.rs</a><br>
<a href="https://github.com/BGR360/propagate/blob/5cb618e/examples/usage.rs">examples/usage_no_try.rs</a></p>



<a name="253701527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253701527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253701527">(Sep 17 2021 at 07:24)</a>:</h4>
<p>Ok all, after much churning and re-writing, I think I've landed on something that I like.</p>
<p>Please see the updated <a href="https://github.com/BGR360/propagate">Propagate repo</a>, now complete with rendered rustdocs, and let me know what you think of the current design of the crate.</p>



<a name="253782376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782376">(Sep 17 2021 at 18:00)</a>:</h4>
<p><span class="user-mention" data-user-id="435059">@Ben Reeves</span> oh wow, the example in the readme looks beautiful</p>



<a name="253782550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782550">(Sep 17 2021 at 18:01)</a>:</h4>
<p>o and the traced trait</p>



<a name="253782569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782569">(Sep 17 2021 at 18:01)</a>:</h4>
<p>this looks great!</p>



<a name="253782693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782693">(Sep 17 2021 at 18:02)</a>:</h4>
<p>o now I really wanna know if this could be made to act like <code>eyre</code></p>



<a name="253782733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782733">(Sep 17 2021 at 18:02)</a>:</h4>
<p>where the stack is also the formatter and general context</p>



<a name="253782783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782783">(Sep 17 2021 at 18:02)</a>:</h4>
<p>so it could also do things like capture a backtrace+spantrace when you first convert it into a propagate::Result</p>



<a name="253782789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782789">(Sep 17 2021 at 18:02)</a>:</h4>
<p>and you could do custom output</p>



<a name="253782883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782883">(Sep 17 2021 at 18:03)</a>:</h4>
<p>hmmm</p>



<a name="253782900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253782900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253782900">(Sep 17 2021 at 18:03)</a>:</h4>
<p>actually this is kinda converging on eyre's old design</p>



<a name="253783007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253783007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253783007">(Sep 17 2021 at 18:04)</a>:</h4>
<p>where it was decided against because of how it's locally instantiated and conversion between context types gets confusing</p>



<a name="253783122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253783122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253783122">(Sep 17 2021 at 18:04)</a>:</h4>
<p>regardless</p>



<a name="253783129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253783129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253783129">(Sep 17 2021 at 18:04)</a>:</h4>
<p>this is fantastic work</p>



<a name="253786953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253786953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253786953">(Sep 17 2021 at 18:30)</a>:</h4>
<p>Not sure I grok all of what you're saying here, but I'm pleased to have my work praised <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> </p>
<p>I would be interested in hearing more about "eyre's old design" that was decided against, and what exactly you mean by "locally instantiated" and "context types" and "spantrace"</p>



<a name="253787044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787044">(Sep 17 2021 at 18:31)</a>:</h4>
<p>so eyre used to be defined as <code>eyre::Report&lt;H&gt;</code> where H was the <code>EyreHandler</code></p>



<a name="253787070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787070">(Sep 17 2021 at 18:31)</a>:</h4>
<p>and instead it got changed to have a <code>Box&lt;dyn EyreHandler&gt;</code> internally</p>



<a name="253787192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787192">(Sep 17 2021 at 18:32)</a>:</h4>
<p>and a global hook for installing a function that constructs the <code>EyreHandler</code> that all <code>Report</code>'s use to construct the correct user defined type and store it as a trait object</p>



<a name="253787228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787228">(Sep 17 2021 at 18:32)</a>:</h4>
<p>the job of this trait object is two fold</p>



<a name="253787261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787261">(Sep 17 2021 at 18:32)</a>:</h4>
<p>first, it stores context alongside your error types that you want to have available in all error reports</p>



<a name="253787271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787271">(Sep 17 2021 at 18:32)</a>:</h4>
<p>things like a Backtrace</p>



<a name="253787288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787288">(Sep 17 2021 at 18:32)</a>:</h4>
<p>so the default handler that <code>eyre</code> provides mimics the exact behavior of anyhow</p>



<a name="253787315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787315">(Sep 17 2021 at 18:33)</a>:</h4>
<p>it has an <code>Option&lt;Backtrace&gt;</code> in the conetxt type and nothing else</p>



<a name="253787356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787356">(Sep 17 2021 at 18:33)</a>:</h4>
<p>and when you construct one it checks if the <code>&amp;dyn Error</code> its being associated with already captured a backtrace</p>



<a name="253787361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787361">(Sep 17 2021 at 18:33)</a>:</h4>
<p>and if it doesn't it captures one then</p>



<a name="253787369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787369">(Sep 17 2021 at 18:33)</a>:</h4>
<p>guaruanteeing a backtrace is available</p>



<a name="253787398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787398">(Sep 17 2021 at 18:33)</a>:</h4>
<p><code>SpanTrace</code> is <code>tracing</code>'s <code>Backtrace</code> equivalent</p>



<a name="253787475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787475">(Sep 17 2021 at 18:34)</a>:</h4>
<p>instead of capturing all the active stack frames it captures all the active <code>tracing::Span</code>s</p>



<a name="253787488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787488">(Sep 17 2021 at 18:34)</a>:</h4>
<p>including runtime information</p>



<a name="253787595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787595">(Sep 17 2021 at 18:35)</a>:</h4>
<p><a href="https://docs.rs/color-eyre/0.5.11/color_eyre/">https://docs.rs/color-eyre/0.5.11/color_eyre/</a> is crate that defines an alternative <code>EyreHandler</code> type that captures a backtrace and a spantrace and can also store suggestions and other custom sections</p>



<a name="253787652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787652">(Sep 17 2021 at 18:35)</a>:</h4>
<p>so that kinda really expands on how you can use a "context type" which is more or less just a description of what that <code>EyreHandler</code> trait object does</p>



<a name="253787677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787677">(Sep 17 2021 at 18:35)</a>:</h4>
<p>your ErrorStack type is quite similar</p>



<a name="253787693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787693">(Sep 17 2021 at 18:35)</a>:</h4>
<p>in that it's storing additional context</p>



<a name="253787712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787712">(Sep 17 2021 at 18:35)</a>:</h4>
<p>but its restricted in that it's only caring about one type of context, <code>Location</code></p>



<a name="253787834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787834">(Sep 17 2021 at 18:36)</a>:</h4>
<p>you could in theory create a custom <code>Result</code> type to wrap an <code>eyre::Report</code> and a custom context type and that same <code>Traced</code> trait and reimplement a lot of the stuff in <code>propagate</code> and have it instead downcast the trait object in the <code>Report</code> and then insert the <code>Location</code> every time you use <code>?</code></p>



<a name="253787902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787902">(Sep 17 2021 at 18:37)</a>:</h4>
<p>actually I don't even think the traced trait would be necessary</p>



<a name="253787907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787907">(Sep 17 2021 at 18:37)</a>:</h4>
<p>it would all be statically known types in that case</p>



<a name="253787947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787947">(Sep 17 2021 at 18:37)</a>:</h4>
<p>though you cannot generalize it, because the trait object can only give access to the internals by downcasting to concrete known types</p>



<a name="253787971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253787971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253787971">(Sep 17 2021 at 18:37)</a>:</h4>
<p>so there are tradeoffs</p>



<a name="253788039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788039">(Sep 17 2021 at 18:38)</a>:</h4>
<p>We could add the <code>trace</code> method to the <code>EyreHandler</code> trait</p>



<a name="253788059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788059">(Sep 17 2021 at 18:38)</a>:</h4>
<p>and add a <code>Result</code> type the same as what you have</p>



<a name="253788115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788115">(Sep 17 2021 at 18:38)</a>:</h4>
<p>alternatively we could add a more general generic member access style method</p>



<a name="253788120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788120">(Sep 17 2021 at 18:38)</a>:</h4>
<p>for inserting arbitrary context</p>



<a name="253788150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788150">(Sep 17 2021 at 18:39)</a>:</h4>
<p>it could be as simple as <code>fn add_context(&amp;mut self, context: Box&lt;dyn Any&gt;)</code></p>



<a name="253788181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788181">(Sep 17 2021 at 18:39)</a>:</h4>
<p>which could then have the <code>trace</code> method built on top of it</p>



<a name="253788314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788314">(Sep 17 2021 at 18:40)</a>:</h4>
<p>but that would still require a custom resuilt type to do the insertion and active downcasting to get the locations back out of those boxed type erased values</p>



<a name="253788362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788362">(Sep 17 2021 at 18:40)</a>:</h4>
<p>so there's lots of tradeoffs in this space but your approach of moving the generic to the <code>Result</code> instead of as a parameter on the <code>Error</code> type is new</p>



<a name="253788379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788379">(Sep 17 2021 at 18:40)</a>:</h4>
<p>so I'm really eager to see how it plays out</p>



<a name="253788398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788398">(Sep 17 2021 at 18:41)</a>:</h4>
<p>but it would probably be a good idea to familiarize yourself with <code>eyre</code> as well since it is very similar conceptually</p>



<a name="253788445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788445">(Sep 17 2021 at 18:41)</a>:</h4>
<p>and in the future we may want to combine the lessons learned in these two crates</p>



<a name="253788659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788659">(Sep 17 2021 at 18:42)</a>:</h4>
<p>because I can imagine a version of <code>eyre</code> that has the same parameter on the Result type, and it has a default type that is a globally instantiated hook / type erased trait object, but where you can replace it with a custom type</p>



<a name="253788712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788712">(Sep 17 2021 at 18:43)</a>:</h4>
<p>I'll have to do some remembering about the previous versions and the negatives that caused us to switch and do some thinking about if they do or don't apply with this newer design</p>



<a name="253788965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253788965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253788965">(Sep 17 2021 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253788379">said</a>:</p>
<blockquote>
<p>so I'm really eager to see how it plays out</p>
</blockquote>
<p>Plays out with whom? Not sure I have many wannabe users lined up at the door, aside from Qumulo of course.</p>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253788398">said</a>:</p>
<blockquote>
<p>but it would probably be a good idea to familiarize yourself with <code>eyre</code> as well since it is very similar conceptually</p>
</blockquote>
<p>Agreed, will do as time allows.</p>



<a name="253789081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253789081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253789081">(Sep 17 2021 at 18:45)</a>:</h4>
<p>I'll be convening with coworkers next week to see if the current incarnation of <code>propagate</code> would be a satisfactory approach. Some folks are really pining to have this be an optional feature of <code>std::Result</code> and worry that having to work with two different result types in a codebase will be too annoying.</p>



<a name="253789412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253789412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253789412">(Sep 17 2021 at 18:48)</a>:</h4>
<blockquote>
<p>Plays out with whom? </p>
</blockquote>
<p>Plays out for you at work mainly, though I think we could in theory attract more test users and feedback if we include it in trial-and-error</p>



<a name="253789526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253789526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253789526">(Sep 17 2021 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253789081">said</a>:</p>
<blockquote>
<p>I'll be convening with coworkers next week to see if the current incarnation of <code>propagate</code> would be a satisfactory approach. Some folks are really pining to have this be an optional feature of <code>std::Result</code> and worry that having to work with two different result types in a codebase will be too annoying.</p>
</blockquote>
<p>that's a super legitimate worry, I think in theory we could argue that it would be better to have the fully featured if slightly slower Result in std and leave the performance optimized Result types for crates that need to avoid the extra codegen</p>



<a name="253789593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253789593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253789593">(Sep 17 2021 at 18:49)</a>:</h4>
<p>but obviously that's going to be a more long term solution and it's not guaranteed that it will be accepted</p>



<a name="253790667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253790667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253790667">(Sep 17 2021 at 18:57)</a>:</h4>
<p>I'll try and study <code>eyre</code> this weekend, maybe gain some new inspiration. Quite a whirlwind of different approaches and tradeoffs, makes my head spin <span aria-label="flushed" class="emoji emoji-1f633" role="img" title="flushed">:flushed:</span></p>



<a name="253790724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253790724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253790724">(Sep 17 2021 at 18:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253790667">said</a>:</p>
<blockquote>
<p>I'll try and study <code>eyre</code> this weekend, maybe gain some new inspiration. Quite a whirlwind of different approaches and tradeoffs, makes my head spin <span aria-label="flushed" class="emoji emoji-1f633" role="img" title="flushed">:flushed:</span></p>
</blockquote>
<p>lmk if you have any questions :D</p>



<a name="253804837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253804837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253804837">(Sep 17 2021 at 20:44)</a>:</h4>
<p>Would be nice if your readme had examples of the output you can expect if some error occurred.</p>



<a name="253805127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253805127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253805127">(Sep 17 2021 at 20:46)</a>:</h4>
<p>From the description it sounds to me like the error trace will only include the locations of where in the source an error has occurred.  I have personally avoided that kind of approach for I tend to find it hard to relate these back to what actually went wrong, even with source code at hand.</p>



<a name="253989906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/253989906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#253989906">(Sep 20 2021 at 02:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253805127">said</a>:</p>
<blockquote>
<p>From the description it sounds to me like the error trace will only include the locations of where in the source an error has occurred.</p>
</blockquote>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> It tracks the location where the error occurred and every location where the <code>?</code> operator is applied to it on the way up the stack. I should find a way to make that more obvious in the readme</p>



<a name="254122747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254122747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254122747">(Sep 20 2021 at 21:39)</a>:</h4>
<p>Alright, I presented the Propagate crate to one of our more seasoned Rustaceans at work today, and I think I'm becoming convinced that this approach is not really a satisfying solution to the underlying issue.</p>
<p>There are some really notable issues with having two distinct Result types, even if you give them different names.</p>



<a name="254122921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254122921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254122921">(Sep 20 2021 at 21:40)</a>:</h4>
<p><span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="254122960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254122960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254122960">(Sep 20 2021 at 21:41)</a>:</h4>
<p>lol</p>



<a name="254123557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254123557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254123557">(Sep 20 2021 at 21:46)</a>:</h4>
<p>For one, reliable usage of the Propagate crate is sort of predicated on all <code>std::result::Result</code>s being "leaf" nodes in the error chain. If you produce a <code>std::result::Result</code> in the middle of propagating a <code>propagate::Result</code>, you lose all the error trace information.</p>
<p>For example, say you want to implement a <code>std::ops::TryFrom</code> on a type, and the method for doing the conversion involves calling fallible application code that returns <code>propagate::Result</code>. If that fallible application code produces an error, you will forfeit any error trace information when you go to return the <code>std::result::Result</code> from <code>try_from</code>.</p>
<p>This issue could probably be solved by doing something similar to <code>eyre</code>, where <code>propagate::Result::Err</code> stores a trait object that implements the necessary methods. That way you can go back and forth between <code>std::result::Result</code> and <code>propagate::Result</code> and not lose any information. But this is not the only issue.</p>



<a name="254123690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254123690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254123690">(Sep 20 2021 at 21:47)</a>:</h4>
<p>There is of course the issue of user confusion ("why is there two result types? when do I use which?"), which is of debatable importance.</p>



<a name="254123868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254123868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254123868">(Sep 20 2021 at 21:49)</a>:</h4>
<p>Another point my colleague brought up is that, from a Rust community perspective, this approach is kind of problematic. He likened it to the discourse going around the community about async vs sync APIs. I'm not too familiar, but he says he hears a lot of people complaining that so many libraries these days need to define two sets of APIs: one for sync and one for async.</p>



<a name="254123939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254123939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254123939">(Sep 20 2021 at 21:49)</a>:</h4>
<p>If we release <code>propagate</code>, then if libraries want to make use of it, they have to find a way to satisfy users who want to use <code>propagate</code> and users who don't.</p>



<a name="254124532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254124532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254124532">(Sep 20 2021 at 21:55)</a>:</h4>
<p>Long story short, the new shiny golden egg in my crosshairs is trying to see what we can do to <code>std::result::Result</code> to make it enable this sort of tracing.</p>
<p>The very rough idea is to trait-specialize the <code>FromResidual</code> on <code>Result</code> to handle the case where the error type is traceable (i.e., wants to receive tracing information as it is propagated).</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FromResidual</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;!</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Traced</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Traced</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cp">#[track_caller]</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">from_residual</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="254124803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254124803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254124803">(Sep 20 2021 at 21:57)</a>:</h4>
<p>Alternatively, rather than introducing a new <code>Traced</code> trait to the std library, it could be another method on the <code>Error</code> trait.</p>



<a name="254125381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125381">(Sep 20 2021 at 22:01)</a>:</h4>
<p>I don't think adding a <code>Traced</code> trait would have any advantages over just adding <code>#[track_caller]</code> to the FromResidual impl for <code>Result</code></p>



<a name="254125435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125435">(Sep 20 2021 at 22:02)</a>:</h4>
<p>since you'd still have to hook into <code>?</code> somehow for <code>std::result::Result</code> which would result in the same codegen I expect</p>



<a name="254125459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125459">(Sep 20 2021 at 22:02)</a>:</h4>
<p>Oh, another issue I forgot to mention is that, even if you ignore all the other issues, you still get no insight into the propagation of <code>std::result::Result</code>'s. One scenario where that could be useful is parsing with <code>FromStr</code>. If parsing fails for some really deeply nested type, it would be nice to see more detail into where it failed.</p>
<p>Maybe not everybody would want Result tracing to be turned on by default in the std library, but that type of problem has been solved before with compile flags like <code>panic={unwind,abort}</code>. Granted it'll be a hard sell.</p>



<a name="254125584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125584">(Sep 20 2021 at 22:03)</a>:</h4>
<p>My guess is the best bet is arguing that the default <code>std::result::Result</code> should support <code>track_caller</code> and that more optimized <code>Result</code> types should be left to 3rd party libraries</p>



<a name="254125586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125586">(Sep 20 2021 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/254125381">said</a>:</p>
<blockquote>
<p>I don't think adding a <code>Traced</code> trait would have any advantages over just adding <code>#[track_caller]</code> to the FromResidual impl for <code>Result</code></p>
</blockquote>
<p>I'm not seeing how you can implement propagation tracing by only modifying the existing <code>FromResidual for Result</code>. You'd have nowhere to store the trace.</p>



<a name="254125708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125708">(Sep 20 2021 at 22:04)</a>:</h4>
<p>ah you're right, it has to be actively done in every from_residual call</p>



<a name="254125747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125747">(Sep 20 2021 at 22:05)</a>:</h4>
<p>which would need to be in the <code>std::Result</code> from_residual impl</p>



<a name="254125748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254125748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254125748">(Sep 20 2021 at 22:05)</a>:</h4>
<p>brain fart</p>



<a name="254126196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126196">(Sep 20 2021 at 22:09)</a>:</h4>
<p><span class="user-mention" data-user-id="435059">@Ben Reeves</span> regarding the loss of trace information when round tripping through a std::result::Result, you could do something similar to what I do here in trial-and-error</p>



<a name="254126197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126197">(Sep 20 2021 at 22:09)</a>:</h4>
<p><a href="https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L141">https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L141</a></p>



<a name="254126210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126210">(Sep 20 2021 at 22:09)</a>:</h4>
<p><a href="https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L68-L73">https://github.com/yaahc/trial-and-error/blob/main/src/boxerror_replacement.rs#L68-L73</a></p>



<a name="254126321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126321">(Sep 20 2021 at 22:10)</a>:</h4>
<p>where when it goes from <code>propagate::Result</code> -&gt; <code>std::result::Result</code> it bundles the trace with the error and type erases it, and then you can try to check for that when going backwards</p>



<a name="254126326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126326">(Sep 20 2021 at 22:10)</a>:</h4>
<p>not sure if that will apply well here though</p>



<a name="254126331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126331">(Sep 20 2021 at 22:10)</a>:</h4>
<p>this one assumes everything is type erased</p>



<a name="254126692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126692">(Sep 20 2021 at 22:14)</a>:</h4>
<p>I don't think we have a super strict need for error types to be non-type-erased, so I think that would be a fine limitation</p>



<a name="254126726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126726">(Sep 20 2021 at 22:14)</a>:</h4>
<p>If I'm correct in understanding that "type erased" means "hidden behind a trait object"</p>



<a name="254126735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126735">(Sep 20 2021 at 22:14)</a>:</h4>
<p>yup</p>



<a name="254126980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254126980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254126980">(Sep 20 2021 at 22:17)</a>:</h4>
<p>but yea, the <code>Traced</code> trait solution seems identical to <a href="https://paper.dropbox.com/doc/Collaborative-Summary-3-Fact-Finding-Pre-RFCs-around-Error-Handling-Reporting--BSzjky_QLvb5ReDhXm4PN2OAAg-dnShKo1SsHtdF4Yheeoco">https://paper.dropbox.com/doc/Collaborative-Summary-3-Fact-Finding-Pre-RFCs-around-Error-Handling-Reporting--BSzjky_QLvb5ReDhXm4PN2OAAg-dnShKo1SsHtdF4Yheeoco</a></p>



<a name="254127038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254127038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254127038">(Sep 20 2021 at 22:17)</a>:</h4>
<p>tho that's old and based on the old Try trait</p>



<a name="254127117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254127117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254127117">(Sep 20 2021 at 22:18)</a>:</h4>
<p>either way though I think it will probably end up depending on generic member acecss</p>



<a name="254127124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254127124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254127124">(Sep 20 2021 at 22:18)</a>:</h4>
<p>which also solves the leaf error issue</p>



<a name="254127164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254127164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254127164">(Sep 20 2021 at 22:18)</a>:</h4>
<p>and if you're not familiar with generic member access: <a href="https://github.com/rust-lang/rfcs/pull/2895">https://github.com/rust-lang/rfcs/pull/2895</a></p>



<a name="254127620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254127620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254127620">(Sep 20 2021 at 22:23)</a>:</h4>
<p>You're always a wealth of knowledge, thank you <span aria-label="praise" class="emoji emoji-1f64c" role="img" title="praise">:praise:</span></p>



<a name="254127646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254127646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254127646">(Sep 20 2021 at 22:23)</a>:</h4>
<p>^_^</p>



<a name="254146961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254146961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254146961">(Sep 21 2021 at 02:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/254126196">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> regarding the loss of trace information when round tripping through a std::result::Result, you could do something similar to what I do here in trial-and-error</p>
</blockquote>
<p>How does <a href="https://github.com/yaahc/trial-and-error/blob/be72da7e4ae602724a4bae60e6914bb7d598697a/src/boxerror_replacement.rs#L141">this impl</a> even work? I thought you couldn't have an implementation where both the trait and implementee are from foreign crates.</p>



<a name="254147058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254147058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254147058">(Sep 21 2021 at 02:26)</a>:</h4>
<p>DynResult is local, and (I believe) only the first "uncovered" type from left to right needs to be local to allow it, or something like that? These rules were somewhat recently changed, let me find the RFC</p>



<a name="254147074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254147074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254147074">(Sep 21 2021 at 02:27)</a>:</h4>
<p><a href="https://rust-lang.github.io/rfcs/2451-re-rebalancing-coherence.html">https://rust-lang.github.io/rfcs/2451-re-rebalancing-coherence.html</a></p>



<a name="254147576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254147576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254147576">(Sep 21 2021 at 02:34)</a>:</h4>
<p>Thanks!</p>



<a name="254154370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254154370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254154370">(Sep 21 2021 at 04:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253989906">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/253805127">said</a>:</p>
<blockquote>
<p>From the description it sounds to me like the error trace will only include the locations of where in the source an error has occurred.</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> It tracks the location where the error occurred and every location where the <code>?</code> operator is applied to it on the way up the stack. I should find a way to make that more obvious in the readme</p>
</blockquote>
<p>Readme now has a much more motivating example: <a href="https://github.com/BGR360/propagate/commit/141d3d6262de1b76d4cc0cfd1d1dfeeadf320402?short_path=b335630#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5">https://github.com/BGR360/propagate/commit/141d3d6262de1b76d4cc0cfd1d1dfeeadf320402?short_path=b335630#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5</a></p>



<a name="254157973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254157973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254157973">(Sep 21 2021 at 05:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="220273">Jane Lusby</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/254126980">said</a>:</p>
<blockquote>
<p>but yea, the <code>Traced</code> trait solution seems identical to <a href="https://paper.dropbox.com/doc/Collaborative-Summary-3-Fact-Finding-Pre-RFCs-around-Error-Handling-Reporting--BSzjky_QLvb5ReDhXm4PN2OAAg-dnShKo1SsHtdF4Yheeoco">https://paper.dropbox.com/doc/Collaborative-Summary-3-Fact-Finding-Pre-RFCs-around-Error-Handling-Reporting--BSzjky_QLvb5ReDhXm4PN2OAAg-dnShKo1SsHtdF4Yheeoco</a></p>
</blockquote>
<p>Gave this a read, wish I would have found this sooner. I didn't know about Zig's error return traces, but they are exactly what I want!!</p>
<p>Maybe I'll start using "return tracing" instead of "propagation tracing" as a more "agreed upon" term for this.</p>
<p>A lot of the comments on that document do seem to suggest that people were in favor of adding support for this... <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span> Guess it's just a matter of waiting for supporting features?</p>
<blockquote>
<p>either way though I think it will probably end up depending on generic member acecss</p>
</blockquote>
<p>Could you explain why?</p>
<blockquote>
<p>which also solves the leaf error issue</p>
</blockquote>
<p>Could you explain how?</p>



<a name="254173732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254173732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254173732">(Sep 21 2021 at 08:44)</a>:</h4>
<p>In that if you're using a traced trait or method on error types you need a way to extract that location data back out of those error types later</p>



<a name="254173798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254173798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254173798">(Sep 21 2021 at 08:45)</a>:</h4>
<p>Generic member access is the mechanism that lets you extract information such as locations as a slice or as an iterator or whatever through dyn error trait objects</p>



<a name="254173880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254173880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254173880">(Sep 21 2021 at 08:46)</a>:</h4>
<p>And this helps a leaf errors because you can have this information be extracted from source multiple errors deep in a chain and it doesn't really matter what interfaces it gets returned through or how it gets rewrapped</p>



<a name="254173964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254173964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254173964">(Sep 21 2021 at 08:46)</a>:</h4>
<p>The downside of this is that you end up running into duplicated storage of the same vecs of locations theoretically if you're storing them in each error in a chain of errors</p>



<a name="254174150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/254174150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#254174150">(Sep 21 2021 at 08:48)</a>:</h4>
<p>But for example even with the propagate crate kind of as it is right now if you had generic member access you could type erase the error and stack of locations when roundtripping through a std result and then when reporting your locations you could use generic number access to get back the older stack and recombine them in the final report</p>



<a name="255490149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255490149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255490149">(Sep 29 2021 at 23:07)</a>:</h4>
<p>Just as a little update, I hit a breakthrough and was able to prototype a trait-specialized <code>std::Result</code> using the sound(er) <code>#[feature(min_specialization)]</code> rather than the unsound <code>#[feature(specialization)]</code>: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=9bc783874eeecdc3c6f68625cace9bcb">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=9bc783874eeecdc3c6f68625cace9bcb</a></p>
<p>The breakthrough is the usage of a marker trait configured with <code>#[rustc_specialization_trait]</code> that users would implement on all of their <code>Traced</code> error types, so the compiler can enforce the <a href="https://smallcultfollowing.com/babysteps/blog/2018/02/09/maximally-minimal-specialization-always-applicable-impls/">"always applicable"</a> rule on the user side of things.</p>
<p>Very exciting, this might be the direction Qumulo takes for its error handling, since many are opposed to working with two different result types.</p>



<a name="255490453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255490453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255490453">(Sep 29 2021 at 23:10)</a>:</h4>
<p>Oh and the other key thing is that this approach doesn't require type erasure using boxes or what-have-you. Purely static dispatch with specialized treatment of <code>Traced</code> error types is achieved.</p>



<a name="255492188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255492188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255492188">(Sep 29 2021 at 23:28)</a>:</h4>
<p>ooo</p>



<a name="255492194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255492194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255492194">(Sep 29 2021 at 23:28)</a>:</h4>
<p>that looks fancy!</p>



<a name="255492442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255492442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255492442">(Sep 29 2021 at 23:31)</a>:</h4>
<p>So I'm guessing the next step is to implement a PR adding Traced to std unstably using the specialization marker and then we get the compiler team to review it to make sure it's all sound</p>



<a name="255495277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255495277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255495277">(Sep 30 2021 at 00:01)</a>:</h4>
<p>Yeah, I'll try to get it working on a fork.</p>
<p>Looking again, I think the marker trait is redundant. It's used in std to make existing traits specializable without breaking things.</p>
<p>Since <code>Traced</code> is a wholly new trait I think we can annotate it directly with <code>#[rustc_specialization_trait]</code>.</p>



<a name="255885480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/255885480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Chen (he/him) <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#255885480">(Oct 02 2021 at 17:29)</a>:</h4>
<p>That's a really neat and elegant solution <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="256177073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177073">(Oct 05 2021 at 04:44)</a>:</h4>
<p>Well that was pretty quick to code up. I think I spent more time setting up my rustc repo and rust analyzer than I did actually writing the code and tests.</p>



<a name="256177085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177085">(Oct 05 2021 at 04:44)</a>:</h4>
<p>Draft PR imminent</p>



<a name="256177213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177213">(Oct 05 2021 at 04:46)</a>:</h4>
<p>Lol</p>



<a name="256177218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177218">(Oct 05 2021 at 04:46)</a>:</h4>
<p>Hype</p>



<a name="256177505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177505">(Oct 05 2021 at 04:50)</a>:</h4>
<p>my poor 2015 macbook is NOT having a fun time running rust-analyzer on this repo</p>



<a name="256177724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177724">(Oct 05 2021 at 04:53)</a>:</h4>
<p>Yuuuup</p>



<a name="256177729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177729">(Oct 05 2021 at 04:53)</a>:</h4>
<p>anyway: <a href="https://github.com/rust-lang/rust/pull/89547">https://github.com/rust-lang/rust/pull/89547</a></p>
<p>it's got working tests</p>



<a name="256177732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177732">(Oct 05 2021 at 04:53)</a>:</h4>
<p>I tried streaming rustc dev once</p>



<a name="256177781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177781">(Oct 05 2021 at 04:54)</a>:</h4>
<p>Not a good idea to do obs and rust analyzer on the same machine it turns out</p>



<a name="256177960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256177960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256177960">(Oct 05 2021 at 04:56)</a>:</h4>
<p>Very cool</p>



<a name="256178415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256178415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256178415">(Oct 05 2021 at 05:01)</a>:</h4>
<p>I really wish I understood specialization in rust better</p>



<a name="256178477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256178477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256178477">(Oct 05 2021 at 05:02)</a>:</h4>
<p>I feel confused wondering where you need to add <code>default</code></p>



<a name="256178495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256178495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256178495">(Oct 05 2021 at 05:02)</a>:</h4>
<p>surprised you can just put it on the impl you're specializing, rather than needing to opt in on the trait definition</p>



<a name="256178953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256178953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256178953">(Oct 05 2021 at 05:09)</a>:</h4>
<p><code>default</code> is just saying "this particular impl of this trait method is allowed to be specialized by a more specific impl of this trait method, but this is the default impl to fall back to"</p>



<a name="256178956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256178956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256178956">(Oct 05 2021 at 05:09)</a>:</h4>
<p>or something like that</p>



<a name="256179377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256179377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256179377">(Oct 05 2021 at 05:16)</a>:</h4>
<p>The important detail of doing it the way I've done it is that, due to the presence of <code>#[rustc_attr_specialization_trait]</code>, the <code>Traced</code> trait will be limited in the types it can be implemented on. This is in order to obey the rules of <code>min_specialization</code>. I guess because people like sound languages. Whatever <span aria-label="rolling eyes" class="emoji emoji-1f644" role="img" title="rolling eyes">:rolling_eyes:</span> </p>
<p>Anyway we'd have to decently document that. There are already some traits in core / std that use that attribute, so maybe we can graft some words from those docs to help explain the restrictions.</p>



<a name="256179594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256179594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256179594">(Oct 05 2021 at 05:20)</a>:</h4>
<p>The too-long;didn't-read-niko's-blog-posts-a-dozen-times version of it is that you can't have an <code>impl Traced</code> with additional trait bounds:</p>
<div class="codehilite"><pre><span></span><code>// Okay.
impl Traced for MyScalarType {...}

// Okay (I think?).
impl&lt;T&gt; Traced for MyGenericType&lt;T&gt; {...}

// Not okay.
impl&lt;T: Bound&gt; Traced for SomeOtherType&lt;T&gt; {...}
</code></pre></div>



<a name="256179719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256179719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256179719">(Oct 05 2021 at 05:21)</a>:</h4>
<p>And any <code>impl Traced</code> has to be completely generic WRT lifetimes, i.e., no <code>'static</code> anywhere.</p>



<a name="256180245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180245">(Oct 05 2021 at 05:29)</a>:</h4>
<p>Sounds about right</p>



<a name="256180297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180297">(Oct 05 2021 at 05:30)</a>:</h4>
<p>I just had no idea that they'd already added support for always applicable impls already via this attribute</p>



<a name="256180336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180336">(Oct 05 2021 at 05:30)</a>:</h4>
<p>i didn't either. when i figured that out i was like <span aria-label="bangbang" class="emoji emoji-203c" role="img" title="bangbang">:bangbang:</span>  <span aria-label="bulb" class="emoji emoji-1f4a1" role="img" title="bulb">:bulb:</span> <span aria-label="bulb" class="emoji emoji-1f4a1" role="img" title="bulb">:bulb:</span> <span aria-label="bulb" class="emoji emoji-1f4a1" role="img" title="bulb">:bulb:</span> <span aria-label="bangbang" class="emoji emoji-203c" role="img" title="bangbang">:bangbang:</span></p>



<a name="256180354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180354">(Oct 05 2021 at 05:31)</a>:</h4>
<p>And yea I understand what default means, just not when you're allowed to apply it. Like, I would have initially worried that the "can be specialized" status of a trait has to somehow tie all the way back to the definition</p>



<a name="256180371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180371">(Oct 05 2021 at 05:31)</a>:</h4>
<p>Like it has to be tied to the root of the definition tree essentially</p>



<a name="256180384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180384">(Oct 05 2021 at 05:31)</a>:</h4>
<p>That was my intuition initially too</p>



<a name="256180386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180386">(Oct 05 2021 at 05:31)</a>:</h4>
<p>But that clearly isn't the case</p>



<a name="256180389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180389">(Oct 05 2021 at 05:31)</a>:</h4>
<p>TIL</p>



<a name="256180395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180395">(Oct 05 2021 at 05:31)</a>:</h4>
<p>Very happy that's not a restriction</p>



<a name="256180436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180436">(Oct 05 2021 at 05:32)</a>:</h4>
<p>This knowledge will be very useful going forward <span aria-label="smiling devil" class="emoji emoji-1f608" role="img" title="smiling devil">:smiling_devil:</span></p>



<a name="256180471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180471">(Oct 05 2021 at 05:32)</a>:</h4>
<p>project-specialize-everything</p>



<a name="256180482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180482">(Oct 05 2021 at 05:32)</a>:</h4>
<p>Just unwrap and friends</p>



<a name="256180517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180517">(Oct 05 2021 at 05:33)</a>:</h4>
<p>Tho honestly the thing I want to specialize there would be sad face if that's how we have to fix it</p>



<a name="256180527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180527">(Oct 05 2021 at 05:33)</a>:</h4>
<p>Because then you have to opt into the good unwrap support</p>



<a name="256180538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180538">(Oct 05 2021 at 05:33)</a>:</h4>
<p>Because we can't apply that specialization to Error itself</p>



<a name="256180612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/256180612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#256180612">(Oct 05 2021 at 05:34)</a>:</h4>
<p>Either way, I'm sure it will be useful</p>



<a name="257103805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/257103805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Ellis O&#x27;Riley Jr. <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#257103805">(Oct 11 2021 at 18:56)</a>:</h4>
<p><span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="257795347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/257795347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#257795347">(Oct 16 2021 at 03:07)</a>:</h4>
<p>I'm super-late to this thread, but I thought this was a really interesting note: <a href="https://github.com/BGR360/propagate/blob/2300fab6bd8670019e8e6c2eabd26558f029a76b/src/result.rs#L108">https://github.com/BGR360/propagate/blob/2300fab6bd8670019e8e6c2eabd26558f029a76b/src/result.rs#L108</a></p>
<p>Makes me glad we finally agreed on wrapping the final value in <code>try</code> blocks <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="257797676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/257797676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#257797676">(Oct 16 2021 at 03:47)</a>:</h4>
<p><span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="259563942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259563942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259563942">(Oct 29 2021 at 18:17)</a>:</h4>
<p>It's been a while since I've updated. At work, I have applied the specializing <code>core::result::Result</code> patch to our Rust fork. All of our third- and first-party crates compile perfectly.</p>
<p>I am working on the design for a <code>TracedError</code> wrapper that we will use to wrap all of our existing error enums to make them <code>Traced</code>. Using <code>auto_traits</code> and <code>negative_impls</code>, I was able to create blanket <code>From</code> impls that cover all of the necessary <code>?</code>-conversion cases without colliding with the blanket impls in std. This approach could pretty easily turn into a "user-land" crate that folks can use on top of the standard library patch to get free tracing for their existing error types.</p>
<p>Long story short, the future for this approach is very bright, at least for us at Qumulo.</p>
<p>At the moment, my time is being eaten up as I try to get things in motion for our code base. There's a lot to do since I have to also interoperate with our C errors. Once that has reached a good place, though, I think I might want to rekindle the conversation about making a for realsies RFC.</p>



<a name="259564384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259564384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259564384">(Oct 29 2021 at 18:21)</a>:</h4>
<p>Oh be careful with negative impls</p>



<a name="259564409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259564409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259564409">(Oct 29 2021 at 18:21)</a>:</h4>
<p>Their interaction with specialization is currently broken I think</p>



<a name="259564478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259564478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259564478">(Oct 29 2021 at 18:22)</a>:</h4>
<p>Let me find the thread in wg-traits</p>



<a name="259564550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259564550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259564550">(Oct 29 2021 at 18:23)</a>:</h4>
<p><a href="#narrow/stream/144729-wg-traits/topic/negative.20impls.20in.20coherence">https://rust-lang.zulipchat.com/#narrow/stream/144729-wg-traits/topic/negative.20impls.20in.20coherence</a></p>



<a name="259564768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259564768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259564768">(Oct 29 2021 at 18:24)</a>:</h4>
<p>regardless though, I do think it would be a good idea to open a PR to add the Traced trait work you did from your Rust fork to the <code>rust-lang/rust</code> repo on nightly</p>



<a name="259564809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259564809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259564809">(Oct 29 2021 at 18:25)</a>:</h4>
<p>particularly since we can get the people working on negative-impls to review it and make sure it's all good</p>



<a name="259567775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259567775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259567775">(Oct 29 2021 at 18:49)</a>:</h4>
<p>Good looking out, I'll take a better look at that thread at some point.</p>
<p>Implementing the necessary Froms could be done using a proc macro instead, but using auto_traits and negative_impls was just easier. But yeah if there's an issue, then there's other ways to achieve the behavior.</p>
<p>Could it really just be as simple as a PR? I would have thought changes like this would have to go through some sort of RFC before being put into nightly</p>



<a name="259568856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259568856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259568856">(Oct 29 2021 at 18:59)</a>:</h4>
<p>Yea, for nightly features we only do an RFC if a team member feels it's necessary</p>



<a name="259568874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259568874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259568874">(Oct 29 2021 at 18:59)</a>:</h4>
<p>And even then having the pr open first doesn't hurt anything</p>



<a name="259568976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/259568976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#259568976">(Oct 29 2021 at 19:00)</a>:</h4>
<p><a href="https://github.com/rust-lang/governance/blob/master/teams/libs/subteam-api.md#making-changes-to-the-standard-libraries">https://github.com/rust-lang/governance/blob/master/teams/libs/subteam-api.md#making-changes-to-the-standard-libraries</a></p>



<a name="260623253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260623253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260623253">(Nov 08 2021 at 07:48)</a>:</h4>
<p>I got the <code>TracedError</code> wrapper working at work. Encountered no issue with <code>negative_impls</code> messing with specialization. I converted a small portion of our code to start using it, and the conversion was painless but monotonous. Most changes ended up being in test code (had to add a lot of <code>.unwrap_err().into_inner()</code>). </p>
<p>I've started replicating the design into a new crate. Taking inspiration from <code>eyre</code>, I've dubbed this crate <code>tres</code>: <a href="https://github.com/BGR360/tres">https://github.com/BGR360/tres</a>. The meat of it is all there, with pretty good documentation.</p>
<p>I think <code>tres</code> could become a generally useful crate. It would very easily pair with <code>thiserror</code>, and hopefully with <code>eyre</code> too, but I have yet to think that through.</p>
<p>For the time being, it comes with a companion crate, <code>tres-result</code>, which provides the specialized <code>Result</code> type that <code>core</code> currently lacks. At some point in the future, users of <code>tres</code> would probably be able to seamlessly switch from <code>tres_result::{Result, Traced}</code> to <code>core::result::{Result, Traced}</code>.</p>
<p>I also want to make it easy for library developers to add a feature flag to their libraries to let their users choose whether they want to work with traced or untraced errors.</p>
<p><code>tres</code> could also be used no-std, which is neat.</p>



<a name="260623304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260623304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260623304">(Nov 08 2021 at 07:49)</a>:</h4>
<p>Some remaining work to do for <code>tres</code>, in no particular order:</p>
<ul>
<li>make a companion crate <code>tres-lint</code> which provides a lint to detect missing <code>Ok(..?)</code></li>
<li>add an optional feature to get function names from <code>panic::Location</code>s using DWARF information (I think this should be possible, we want to do a similar thing at work)</li>
<li>examples, examples, examples</li>
<li>add a <code>ResultExt</code> extension trait to provide helpful methods like <code>map_inner_err()</code> and <code>unwrap_inner_err()</code> to <code>Result&lt;T, TracedError&lt;E&gt;&gt;</code></li>
<li>add no-std support</li>
<li>add a way for library developers to optionally provide traced errors from their libraries</li>
</ul>



<a name="260653880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260653880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260653880">(Nov 08 2021 at 13:06)</a>:</h4>
<p>That sounds amazing, can't wait to take a look at it</p>



<a name="260653893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260653893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260653893">(Nov 08 2021 at 13:07)</a>:</h4>
<p>(currently on vacation)</p>



<a name="260664838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260664838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean Chen (he/him) <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260664838">(Nov 08 2021 at 14:38)</a>:</h4>
<p><span class="user-mention" data-user-id="435059">@Ben Reeves</span> would you like help with any of these tasks? <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="260696821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260696821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260696821">(Nov 08 2021 at 18:13)</a>:</h4>
<p><span class="user-mention" data-user-id="300743">@Sean Chen (he/him)</span> I think I'll be good for now! But I will keep that offer in my back pocket :)</p>



<a name="260716516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260716516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260716516">(Nov 08 2021 at 20:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/260623253">said</a>:</p>
<blockquote>
<p>the conversion was painless</p>
</blockquote>
<p>Actually, something to note here. It's true that, <em>once I ironed out the kinks with the auto trait approach</em>, converting the code was pretty painless. However, I ran into a pretty mind-bending compiler error that took me an afternoon to figure out. Once I fixed the issue with my auto traits, converting the code was easy. HOWEVER, anybody writing NEW code can also run into this same unhelpful diagnostic if they accidentally forget a <code>From</code> impl somewhere, and that's pretty bad for usability.</p>
<p>I filed <a href="https://github.com/rust-lang/rust/issues/90665">this issue</a> and started <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection">this topic</a> after spending some time digging into the root cause of the unhelpful diagnostic. It hasn't gotten any attention so far (granted, it hasn't even existed for a full weekday yet). But if anybody here has some knowledge of trait selection and/or specialization, or knows how to get the attention of somebody who does, then that'd be super helpful.</p>



<a name="260717996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260717996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260717996">(Nov 08 2021 at 20:59)</a>:</h4>
<p>trait selection is IMO one of the most complicated parts of the compiler, and there's unfortunately not a ton of experts on it ... maybe <span class="user-mention silent" data-user-id="116118">Matthew Jasper</span> or <span class="user-mention silent" data-user-id="116009">nikomatsakis</span> would have suggestions</p>



<a name="260720556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260720556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260720556">(Nov 08 2021 at 21:20)</a>:</h4>
<p>To see more concretely how this affects <code>tres</code>, consider this code that compiles correctly if I uncomment the <code>From</code> impl:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">tres</span>::<span class="p">{</span><span class="nb">Err</span><span class="p">,</span><span class="w"> </span><span class="nb">Ok</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">,</span><span class="w"> </span><span class="n">TracedError</span><span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Error</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="nb">String</span><span class="p">);</span><span class="w"></span>

<span class="cm">/* OOPS I FORGOT TO WRITE THIS FROM IMPL</span>
<span class="cm">impl&lt;T: ToString&gt; From&lt;T&gt; for Error {</span>
<span class="cm">    fn from(error: T) -&gt; Self {</span>
<span class="cm">        Self(error.to_string())</span>
<span class="cm">    }</span>
<span class="cm">}</span>
<span class="cm">*/</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">TracedError</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">bar</span><span class="p">()</span><span class="o">?</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">bar</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">TracedError</span><span class="o">&lt;&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">TracedError</span>::<span class="n">new</span><span class="p">(</span><span class="s">"Oops!"</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>As is, the compiler produces the following diagnostic, which hopefully depicts just how "bad for usability" this is:</p>
<div class="codehilite"><pre><span></span><code>error[E0277]: the `?` operator can only be used in a function that returns `Result` or `Option` (or another type that implements `FromResidual`)
   --&gt; examples/bad_diagnostic.rs:14:13
    |
13  | / fn foo() -&gt; Result&lt;(), TracedError&lt;Error&gt;&gt; {
14  | |     Ok(bar()?)
    | |             ^ cannot use the `?` operator in a function that returns `tres::Result&lt;(), TracedError&lt;Error, Locations&gt;&gt;`
15  | | }
    | |_- this function should return `Result` or `Option` to accept `?`
    |
    = help: the trait `FromResidual&lt;tres::Result&lt;Infallible, TracedError&lt;&amp;str, Locations&gt;&gt;&gt;` is not implemented for `tres::Result&lt;(), TracedError&lt;Error, Locations&gt;&gt;`
note: required by `from_residual`
   --&gt; /Users/Ben/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/ops/try_trait.rs:339:5
    |
339 |     fn from_residual(residual: R) -&gt; Self;
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre></div>
<p>For reference, if I use <code>core::result::Result</code> instead, I get a more helpful message:</p>
<div class="codehilite"><pre><span></span><code>error[E0277]: `?` couldn&#39;t convert the error to `TracedError&lt;Error, Locations&gt;`
   --&gt; examples/bad_diagnostic.rs:14:13
    |
13  | fn foo() -&gt; Result&lt;(), TracedError&lt;Error&gt;&gt; {
    |             ------------------------------ expected `TracedError&lt;Error, Locations&gt;` because of this
14  |     Ok(bar()?)
    |             ^ the trait `From&lt;TracedError&lt;&amp;str, Locations&gt;&gt;` is not implemented for `TracedError&lt;Error, Locations&gt;`
    |
    = note: the question mark operation (`?`) implicitly performs a conversion on the error value using the `From` trait
    = help: the following implementations were found:
              &lt;TracedError&lt;F, T&gt; as From&lt;E&gt;&gt;
              &lt;TracedError&lt;F, T&gt; as From&lt;TracedError&lt;E, T&gt;&gt;&gt;
    = note: required because of the requirements on the impl of `FromResidual&lt;std::result::Result&lt;Infallible, TracedError&lt;&amp;str, Locations&gt;&gt;&gt;` for `std::result::Result&lt;(), TracedError&lt;Error, Locations&gt;&gt;`
note: required by `from_residual`
   --&gt; /Users/Ben/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/ops/try_trait.rs:339:5
    |
339 |     fn from_residual(residual: R) -&gt; Self;
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre></div>
<p>That message could also be improved, but seems workable, as it mentions the core issue (missing a <code>From</code> somewhere).</p>



<a name="260721240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260721240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260721240">(Nov 08 2021 at 21:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/260717996">said</a>:</p>
<blockquote>
<p>trait selection is IMO one of the most complicated parts of the compiler, and there's unfortunately not a ton of experts on it ... maybe <span class="user-mention silent" data-user-id="116118">Matthew Jasper</span> or <span class="user-mention silent" data-user-id="116009">nikomatsakis</span> would have suggestions</p>
</blockquote>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> thank you for the pointer. That at least validates why I felt so overwhelmed trying to understand it <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span>.</p>
<p>On a scale from "Please Do" to "Niko Hates His Life", how hesitant should I feel about pinging those parties regarding this issue?</p>



<a name="260721647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/track_caller%20error%20crate/near/260721647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/track_caller.20error.20crate.html#260721647">(Nov 08 2021 at 21:30)</a>:</h4>
<p>"probably fine to ping, but could be several days before you get a response"</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>