<html>
<head><meta charset="utf-8"><title>stack backtrace  formatting · project-error-handling · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/index.html">project-error-handling</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html">stack backtrace  formatting</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249301454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249301454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249301454">(Aug 12 2021 at 22:28)</a>:</h4>
<p>Some spitballing kind of ideas here. Starting with an example which is just <code>fn main() { Err(...).unwrap(); }</code></p>



<a name="249301477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249301477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249301477">(Aug 12 2021 at 22:29)</a>:</h4>
<p>Running this with RUST_BACKTRACE gives:</p>



<a name="249301516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249301516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249301516">(Aug 12 2021 at 22:29)</a>:</h4>
<div class="codehilite"><pre><span></span><code>stack backtrace:
   0: rust_begin_unwind
             at /rustc/ccffcafd55e58f769d4b0efc0064bf65e76998e4/library/std/src/panicking.rs:517:5
   1: core::panicking::panic_fmt
             at /rustc/ccffcafd55e58f769d4b0efc0064bf65e76998e4/library/core/src/panicking.rs:93:14
   2: core::result::unwrap_failed
             at /rustc/ccffcafd55e58f769d4b0efc0064bf65e76998e4/library/core/src/result.rs:1617:5
   3: core::result::Result&lt;T,E&gt;::unwrap
             at /rustc/ccffcafd55e58f769d4b0efc0064bf65e76998e4/library/core/src/result.rs:1299:23
   4: hello::main
             at ./src/main.rs:11:5
   5: core::ops::function::FnOnce::call_once
             at /rustc/ccffcafd55e58f769d4b0efc0064bf65e76998e4/library/core/src/ops/function.rs:227:5
</code></pre></div>
<p>I would like to see</p>
<div class="codehilite"><pre><span></span><code>stack backtrace:
   0: core::result::Result&lt;T,E&gt;::unwrap
             at &lt;core&gt;/result.rs:1299:23
   1: hello::main
             at ./src/main.rs:11:5
</code></pre></div>



<a name="249301862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249301862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249301862">(Aug 12 2021 at 22:34)</a>:</h4>
<p>We already do some trimming (c.f., RUST_BACKTRACE=full), but I think we should do more!</p>



<a name="249302064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302064">(Aug 12 2021 at 22:36)</a>:</h4>
<p>Could we do more? (Specifically here, I want to remove more stack frames which I don't think are generally useful, and remove parts of paths to some libs). Anyone have thoughts?</p>



<a name="249302158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302158">(Aug 12 2021 at 22:37)</a>:</h4>
<p>I like the idea</p>



<a name="249302234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302234">(Aug 12 2021 at 22:38)</a>:</h4>
<p>though I wonder if we should keep the frame numbers the same and add a message indicating that some frames were filtered out</p>



<a name="249302247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302247">(Aug 12 2021 at 22:38)</a>:</h4>
<p>so intead it would be something like</p>



<a name="249302251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302251">(Aug 12 2021 at 22:38)</a>:</h4>
<div class="codehilite"><pre><span></span><code>stack backtrace:
   3: core::result::Result&lt;T,E&gt;::unwrap
             at &lt;core&gt;/result.rs:1299:23
   4: hello::main
             at ./src/main.rs:11:5
   4 Frames omitted, use `RUST_BACKTRACE=full` to see a complete backtrace
</code></pre></div>



<a name="249302299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302299">(Aug 12 2021 at 22:39)</a>:</h4>
<p>alternatively</p>



<a name="249302310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302310">(Aug 12 2021 at 22:39)</a>:</h4>
<p>we might want to add support for this, but not make it the default</p>



<a name="249302338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302338">(Aug 12 2021 at 22:40)</a>:</h4>
<p>i imagine some people might be upset if they expect to some frames and they capture a backtrace on a hard to reproduce error but then they're missing some frames that were important</p>



<a name="249302377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302377">(Aug 12 2021 at 22:40)</a>:</h4>
<p>though I don't see how any of the frames we'd filter here would be important</p>



<a name="249302386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302386">(Aug 12 2021 at 22:40)</a>:</h4>
<p>so probably not a risk, but worth being careful about</p>



<a name="249302635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302635">(Aug 12 2021 at 22:43)</a>:</h4>
<p>"though I wonder if we should keep the frame numbers the same and add a message indicating that some frames were filtered out" - that would be inconsistent with the filtering we currently do</p>



<a name="249302672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302672">(Aug 12 2021 at 22:43)</a>:</h4>
<p>"we might want to add support for this, but not make it the default" - we already filter quite aggressively by default, so I don't think that is a risk</p>



<a name="249302735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302735">(Aug 12 2021 at 22:44)</a>:</h4>
<p>oh, maybe you are referring to the path shortening?</p>



<a name="249302770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302770">(Aug 12 2021 at 22:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting/near/249302635">said</a>:</p>
<blockquote>
<p>"though I wonder if we should keep the frame numbers the same and add a message indicating that some frames were filtered out" - that would be inconsistent with the filtering we currently do</p>
</blockquote>
<p>ah, fair</p>



<a name="249302791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302791">(Aug 12 2021 at 22:45)</a>:</h4>
<p>no, no, I just forgot that we already filter the frames quite a bit</p>



<a name="249302817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302817">(Aug 12 2021 at 22:45)</a>:</h4>
<p>I'm thinking about the filtering I have setup in color-eyre</p>



<a name="249302822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302822">(Aug 12 2021 at 22:45)</a>:</h4>
<p>Maybe even:</p>
<div class="codehilite"><pre><span></span><code>stack backtrace:
   0: core::result::Result&lt;T,E&gt;::unwrap at &lt;core&gt;/result.rs:1299:23
   1: hello::main at ./src/main.rs:11:5
</code></pre></div>
<p>I think we only used two lines because of historical reasons - i.e., with the 'full' backtrace there is more data more entry</p>



<a name="249302872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302872">(Aug 12 2021 at 22:46)</a>:</h4>
<p>although I guess the alignment makes things easier to read</p>



<a name="249302888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302888">(Aug 12 2021 at 22:46)</a>:</h4>
<p>yea I prefer the first version you showed</p>



<a name="249302895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302895">(Aug 12 2021 at 22:46)</a>:</h4>
<p><a href="/user_uploads/4715/M7q9OMw0nWJWkL5FIfjZzD1z/Screenshot-from-2021-08-12-15-46-13.png">Screenshot-from-2021-08-12-15-46-13.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/M7q9OMw0nWJWkL5FIfjZzD1z/Screenshot-from-2021-08-12-15-46-13.png" title="Screenshot-from-2021-08-12-15-46-13.png"><img src="/user_uploads/4715/M7q9OMw0nWJWkL5FIfjZzD1z/Screenshot-from-2021-08-12-15-46-13.png"></a></div>



<a name="249302929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302929">(Aug 12 2021 at 22:47)</a>:</h4>
<p>was where my suggestions were coming from</p>



<a name="249302986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249302986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249302986">(Aug 12 2021 at 22:48)</a>:</h4>
<p>I feel like it's pretty safe to filter out the panicking frames</p>



<a name="249303027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303027">(Aug 12 2021 at 22:48)</a>:</h4>
<p>not confident that <code>core::ops::function::FnOnce::call_once</code> is something we should filter out</p>



<a name="249303075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303075">(Aug 12 2021 at 22:49)</a>:</h4>
<p>tho that pretty much just indicates you're calling a closure, and the closure itself has its own stack frame I think</p>



<a name="249303084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303084">(Aug 12 2021 at 22:49)</a>:</h4>
<p>let me test rq</p>



<a name="249303256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303256">(Aug 12 2021 at 22:51)</a>:</h4>
<p>Yeah, the closure is an implementation detail of the __rust_begin_short_backtrace machinery I think, IMO, the stacktrace should start at main, and anything outside main is stuff the user doesn't care about</p>



<a name="249303271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303271">(Aug 12 2021 at 22:51)</a>:</h4>
<p>At least, doesn't <em>usually</em> care about</p>



<a name="249303277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303277">(Aug 12 2021 at 22:51)</a>:</h4>
<p>hmm</p>



<a name="249303345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303345">(Aug 12 2021 at 22:52)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">call_indirect</span><span class="p">(</span><span class="o">||</span><span class="w">  </span><span class="nb">Err</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">call_indirect</span><span class="o">&lt;</span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249303351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303351">(Aug 12 2021 at 22:52)</a>:</h4>
<p>would you expect this to have the <code>call_once</code> frame twice?</p>



<a name="249303359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303359">(Aug 12 2021 at 22:52)</a>:</h4>
<p>once for the unwrap machinery and once for the call inside of call_indirect?</p>



<a name="249303362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303362">(Aug 12 2021 at 22:52)</a>:</h4>
<p>I would have, but it doesn't</p>



<a name="249303657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303657">(Aug 12 2021 at 22:56)</a>:</h4>
<p>I'm not sure of the rules for when <code>call_once</code> is actually invoked</p>



<a name="249303667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303667">(Aug 12 2021 at 22:56)</a>:</h4>
<p>It doesn't seem to be for all closures</p>



<a name="249303681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303681">(Aug 12 2021 at 22:56)</a>:</h4>
<p>Or rather it doesn't seem to be for closures at all, as in your example</p>



<a name="249303721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303721">(Aug 12 2021 at 22:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>fn main() {
    call_indirect(foo);
}

fn foo() {
    Err::&lt;(), _&gt;(&quot;&quot;).unwrap()
}

fn call_indirect&lt;F: FnOnce()&gt;(f: F) {
    f();
}
</code></pre></div>
<p>Has two frames for call_once</p>



<a name="249303738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303738">(Aug 12 2021 at 22:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>20:     0x560e8220a97b - core::ops::function::FnOnce::call_once::hd68444e2cc8c724f
                               at /rustc/a178d0322ce20e33eac124758e837cbd80a6f633/library/core/src/ops/function.rs:227:5
  21:     0x560e8220a6ee - std::sys_common::backtrace::__rust_begin_short_backtrace::h4853b5a3266caa3c
                               at /rustc/a178d0322ce20e33eac124758e837cbd80a6f633/library/std/src/sys_common/backtrace.rs:125:18
  22:     0x560e8220a771 - std::rt::lang_start::{{closure}}::h497f58961ebf7e05
                               at /rustc/a178d0322ce20e33eac124758e837cbd80a6f633/library/std/src/rt.rs:49:18
  23:     0x560e8221b0f9 - core::ops::function::impls::&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;F&gt;::call_once::h2aabc384aab89b7b
                               at /rustc/a178d0322ce20e33eac124758e837cbd80a6f633/library/core/src/ops/function.rs:259:13
  24:     0x560e8221b0f9 - std::panicking::try::do_call::hc5fcacb7a85fc7b1
                               at /rustc/a178d0322ce20e33eac124758e837cbd80a6f633/library/std/src/panicking.rs:401:40
</code></pre></div>



<a name="249303810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303810">(Aug 12 2021 at 22:58)</a>:</h4>
<p>oooooo</p>



<a name="249303821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303821">(Aug 12 2021 at 22:58)</a>:</h4>
<p>So I think it must only be invoked for named functions (like <code>foo</code> in this example, or <code>main</code> in the case of the stack trace stuff)</p>



<a name="249303826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303826">(Aug 12 2021 at 22:58)</a>:</h4>
<p>yea</p>



<a name="249303833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303833">(Aug 12 2021 at 22:58)</a>:</h4>
<p>that makes sense</p>



<a name="249303834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303834">(Aug 12 2021 at 22:58)</a>:</h4>
<p>that's interesting!</p>



<a name="249303921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303921">(Aug 12 2021 at 23:00)</a>:</h4>
<p>and the foo frame is intact, so the call_once frame seems redundant</p>



<a name="249303963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303963">(Aug 12 2021 at 23:00)</a>:</h4>
<p>yea, i say do it</p>



<a name="249303979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249303979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249303979">(Aug 12 2021 at 23:00)</a>:</h4>
<p>filter the shit out of those frames!</p>



<a name="249304019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304019">(Aug 12 2021 at 23:00)</a>:</h4>
<p>:-)</p>



<a name="249304237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304237">(Aug 12 2021 at 23:03)</a>:</h4>
<p>Do we apply this same filtering to <code>std::backtrace::Backtrace</code>?</p>



<a name="249304409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304409">(Aug 12 2021 at 23:05)</a>:</h4>
<p>looks like we do</p>



<a name="249304634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304634">(Aug 12 2021 at 23:09)</a>:</h4>
<p>acutally maybe not</p>



<a name="249304780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304780">(Aug 12 2021 at 23:11)</a>:</h4>
<p>ah yea, capturing it manually will only see the <code>__rust_begin_short_backtrace</code> frame</p>



<a name="249304825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304825">(Aug 12 2021 at 23:12)</a>:</h4>
<p>but not the <code>__rust_end_short_backtrace</code> frame</p>



<a name="249304837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304837">(Aug 12 2021 at 23:12)</a>:</h4>
<p>and it completely ignores them / displays them normally regardless</p>



<a name="249304970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304970">(Aug 12 2021 at 23:14)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">__rust_begin_short_backtrace</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// prevent this frame from being tail-call optimised away</span>
<span class="w">    </span><span class="k">crate</span>::<span class="n">hint</span>::<span class="n">black_box</span><span class="p">(());</span><span class="w"></span>

<span class="w">    </span><span class="n">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249304981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249304981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249304981">(Aug 12 2021 at 23:14)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(not(test))]</span><span class="w"></span>
<span class="cp">#[lang = </span><span class="s">"start"</span><span class="cp">]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">lang_start</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">crate</span>::<span class="n">process</span>::<span class="n">Termination</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">main</span>: <span class="nc">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">argc</span>: <span class="kt">isize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">argv</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">isize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lang_start_internal</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">crate</span>::<span class="n">sys_common</span>::<span class="n">backtrace</span>::<span class="n">__rust_begin_short_backtrace</span><span class="p">(</span><span class="n">main</span><span class="p">).</span><span class="n">report</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">argc</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">argv</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">into_ok</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249305003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305003">(Aug 12 2021 at 23:14)</a>:</h4>
<p>so it's passing main in to a function expecting an <code>FnOnce</code></p>



<a name="249305025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305025">(Aug 12 2021 at 23:15)</a>:</h4>
<p>maybe we can get rid of the <code>call_once</code> by just changing <code>__rust_begin_short_backtrace</code> to take a function pointer</p>



<a name="249305242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305242">(Aug 12 2021 at 23:18)</a>:</h4>
<p>I expect this will have to work differently from the current backtrace filtering</p>



<a name="249305276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305276">(Aug 12 2021 at 23:19)</a>:</h4>
<p>right now its just filtering out the start and the stop of the backtrace, but never frames in the middle of the output</p>



<a name="249305314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305314">(Aug 12 2021 at 23:19)</a>:</h4>
<p>and we cant filter out stuff related to Result using these named frames because then it would show up a bunch from user code</p>



<a name="249305375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305375">(Aug 12 2021 at 23:20)</a>:</h4>
<p>what's unwrap_failed...</p>



<a name="249305423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305423">(Aug 12 2021 at 23:21)</a>:</h4>
<p>oh, that's just to deal with monomorphization code bloat</p>



<a name="249305467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305467">(Aug 12 2021 at 23:21)</a>:</h4>
<p>can that show up more than once in a stack frame?</p>



<a name="249305470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305470">(Aug 12 2021 at 23:21)</a>:</h4>
<p>no right?</p>



<a name="249305484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305484">(Aug 12 2021 at 23:21)</a>:</h4>
<p>like, you can only panic once</p>



<a name="249305522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305522">(Aug 12 2021 at 23:22)</a>:</h4>
<p>otherwise, boom</p>



<a name="249305594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305594">(Aug 12 2021 at 23:22)</a>:</h4>
<p>either way, that's gonna be somewhat error prone I expect, if we don't have the begin_short_backtrace function called in the centralized points where all panics flow through</p>



<a name="249305628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305628">(Aug 12 2021 at 23:23)</a>:</h4>
<p>and instead have to call it inside of the various functions that can panick</p>



<a name="249305636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305636">(Aug 12 2021 at 23:23)</a>:</h4>
<p>but it might not actually be an issue if <code>__rust_begin_short_backtrace</code> shows up more than once?</p>



<a name="249305702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305702">(Aug 12 2021 at 23:24)</a>:</h4>
<p>I think it boils down to do we want to minimize the number of comparisons we have to do to filter out frames?</p>



<a name="249305715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305715">(Aug 12 2021 at 23:24)</a>:</h4>
<p>alternatively, is there some magical compiler way we could mark a frame as unimportant</p>



<a name="249305723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305723">(Aug 12 2021 at 23:24)</a>:</h4>
<p>"maybe we can get rid of the call_once by just changing __rust_begin_short_backtrace to take a function pointer" I think that would just use <code>Fn::call</code> rather than <code>FnOnce::call_once</code></p>



<a name="249305763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305763">(Aug 12 2021 at 23:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting/near/249305723">said</a>:</p>
<blockquote>
<p>"maybe we can get rid of the call_once by just changing __rust_begin_short_backtrace to take a function pointer" I think that would just use <code>Fn::call</code> rather than <code>FnOnce::call_once</code></p>
</blockquote>
<p>just tested, seems to work</p>



<a name="249305765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305765">(Aug 12 2021 at 23:25)</a>:</h4>
<p>I think we would need a multi-pronged solution: I think we have an off by one error at the two short backtrace marker functions, which we can solve by effectively add ing +1/-1</p>



<a name="249305774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305774">(Aug 12 2021 at 23:25)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(backtrace)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// std::env::set_var("RUST_BACKTRACE", "full");</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">backtrace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">backtrace</span>::<span class="n">Backtrace</span>::<span class="n">capture</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Backtrace:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">,</span><span class="w"> </span><span class="n">backtrace</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">call_indirect</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">call_indirect</span><span class="p">(</span><span class="n">f</span>: <span class="nc">fn</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249305825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305825">(Aug 12 2021 at 23:25)</a>:</h4>
<p>what kind of type is <code>fn()</code>?!</p>



<a name="249305865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305865">(Aug 12 2021 at 23:26)</a>:</h4>
<p>that's a function pointer</p>



<a name="249305874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305874">(Aug 12 2021 at 23:26)</a>:</h4>
<p>not a trait object</p>



<a name="249305875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305875">(Aug 12 2021 at 23:26)</a>:</h4>
<p>I tried <code>f: &amp;impl Fn</code></p>



<a name="249305881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305881">(Aug 12 2021 at 23:26)</a>:</h4>
<p>yea, that's just a diff trait object</p>



<a name="249305888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305888">(Aug 12 2021 at 23:26)</a>:</h4>
<p>lol</p>



<a name="249305894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305894">(Aug 12 2021 at 23:26)</a>:</h4>
<p>the issue with function pointers is they can't be closures that capture anything</p>



<a name="249305899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305899">(Aug 12 2021 at 23:26)</a>:</h4>
<p>because you can't have associated state</p>



<a name="249305906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305906">(Aug 12 2021 at 23:26)</a>:</h4>
<p>I wonder if that would have back compat issues?</p>



<a name="249305915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305915">(Aug 12 2021 at 23:26)</a>:</h4>
<p>i don't think so, because main has never been a closure</p>



<a name="249305921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305921">(Aug 12 2021 at 23:27)</a>:</h4>
<p>and this is only ever called with main</p>



<a name="249305927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305927">(Aug 12 2021 at 23:27)</a>:</h4>
<p>and it's outside of user code</p>



<a name="249305945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305945">(Aug 12 2021 at 23:27)</a>:</h4>
<p>let me double check that second statement tho</p>



<a name="249305950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305950">(Aug 12 2021 at 23:27)</a>:</h4>
<p>i wouldn't be surprised if test code uses this</p>



<a name="249305953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249305953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249305953">(Aug 12 2021 at 23:27)</a>:</h4>
<p>but that shouldn't be an issue</p>



<a name="249306024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306024">(Aug 12 2021 at 23:28)</a>:</h4>
<p>ah shit</p>



<a name="249306028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306028">(Aug 12 2021 at 23:28)</a>:</h4>
<p>this is used by std::thread</p>



<a name="249306039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306039">(Aug 12 2021 at 23:28)</a>:</h4>
<p>so we'd have to make a second start marker</p>



<a name="249306054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306054">(Aug 12 2021 at 23:28)</a>:</h4>
<p>one for function pointers that gets used at main and the old one for function trait objects that gets used by thread</p>



<a name="249306070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306070">(Aug 12 2021 at 23:29)</a>:</h4>
<p>also used by the benchmark runner</p>



<a name="249306079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306079">(Aug 12 2021 at 23:29)</a>:</h4>
<p>and test runner</p>



<a name="249306090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306090">(Aug 12 2021 at 23:29)</a>:</h4>
<p>though those can probably switch to the function pointer version</p>



<a name="249306108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306108">(Aug 12 2021 at 23:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting/near/249305765">said</a>:</p>
<blockquote>
<p>I think we would need a multi-pronged solution: I think we have an off by one error at the two short backtrace marker functions, which we can solve by effectively add ing +1/-1</p>
</blockquote>
<p>thats an interesting approahc</p>



<a name="249306162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306162">(Aug 12 2021 at 23:30)</a>:</h4>
<p>I'm vaguely worried about having different call graphs that can happen off of either of these two marker functions</p>



<a name="249306176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306176">(Aug 12 2021 at 23:30)</a>:</h4>
<p>where in one situation it would have +1 extra frame and in the other it would have +2</p>



<a name="249306193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306193">(Aug 12 2021 at 23:30)</a>:</h4>
<p>would want to be exceedingly careful to make sure we don't end up filtering out their <code>main</code> function or something</p>



<a name="249306206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306206">(Aug 12 2021 at 23:31)</a>:</h4>
<p>or god forbid, the actual frame where the panic was created</p>



<a name="249306229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306229">(Aug 12 2021 at 23:31)</a>:</h4>
<p>so we would probably want to add a set of tests that check the backtrace contains the expected start and end frames when a panic is invoked inside of a main function, a test, a benchmark, or a thread</p>



<a name="249306291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306291">(Aug 12 2021 at 23:32)</a>:</h4>
<p>and I worry about a future path being added where the logic is wrong</p>



<a name="249306474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306474">(Aug 12 2021 at 23:36)</a>:</h4>
<p>Yeah, I think you would have to change the internals of __rust_begin_short_backtrace to make the logic wrong, so that doesn't seem too risky (just needs a comment). Not sure about __rust_end_short_backtrace though. And yeah, tests would be necessary</p>



<a name="249306533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306533">(Aug 12 2021 at 23:36)</a>:</h4>
<p>oh, i thought you meant something like change the backtrace print logic so it only starts printing the frame or two after it sees the __rust_begin frame</p>



<a name="249306538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306538">(Aug 12 2021 at 23:36)</a>:</h4>
<p>I thinkthe other prong we could use would be to add an attribute to skip a function in backtraces. I think that would be useful for futures stuff too</p>



<a name="249306545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306545">(Aug 12 2021 at 23:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting/near/249306538">said</a>:</p>
<blockquote>
<p>I thinkthe other prong we could use would be to add an attribute to skip a function in backtraces. I think that would be useful for futures stuff too</p>
</blockquote>
<p>that does sound like the ideal solution</p>



<a name="249306554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306554">(Aug 12 2021 at 23:37)</a>:</h4>
<p>especially if it lets users mark frames in their code as unimportant</p>



<a name="249306567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306567">(Aug 12 2021 at 23:37)</a>:</h4>
<p>though I have no idea how hard it would be to implement something like that</p>



<a name="249306620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306620">(Aug 12 2021 at 23:38)</a>:</h4>
<p>"oh, i thought you meant something like change the backtrace print logic so it only starts printing the frame or two after it sees the __rust_begin frame" - Yeah, that's what I meant, but I don't think it is easier to break the logic because the call_once comes from inside the _rust_begin_short_backtrace implementation</p>



<a name="249306624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306624">(Aug 12 2021 at 23:38)</a>:</h4>
<p>"though I have no idea how hard it would be to implement something like that" - yeah, I have no idea about the implementation :-)</p>



<a name="249306930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306930">(Aug 12 2021 at 23:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting/near/249306620">said</a>:</p>
<blockquote>
<p>"oh, i thought you meant something like change the backtrace print logic so it only starts printing the frame or two after it sees the __rust_begin frame" - Yeah, that's what I meant, but I don't think it is easier to break the logic because the call_once comes from inside the _rust_begin_short_backtrace implementation</p>
</blockquote>
<p>ah yea, the begin side seems easy to reason about</p>



<a name="249306937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306937">(Aug 12 2021 at 23:44)</a>:</h4>
<p>i guess we just need to double check the end side</p>



<a name="249306970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/stack%20backtrace%20%20formatting/near/249306970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/stack.20backtrace.20.20formatting.html#249306970">(Aug 12 2021 at 23:45)</a>:</h4>
<p>i would love to see the begin and end filtering also apply to <code>std::backtrace::Backtrace</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>