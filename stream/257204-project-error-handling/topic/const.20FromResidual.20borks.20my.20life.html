<html>
<head><meta charset="utf-8"><title>const FromResidual borks my life · project-error-handling · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/index.html">project-error-handling</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html">const FromResidual borks my life</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276265808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276265808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276265808">(Mar 22 2022 at 22:58)</a>:</h4>
<p>Howdy y'all. It's the error tracing guy again.</p>
<p>One of the 1.59 nightlies made <code>impl FromResidual for Result</code> into a <code>const</code> impl, and now that is throwing a wrench into our ability to specialize the <code>FromResidual</code> impl. As a bit of a refresher, we have patched our Rust stdlib to have a specialized implementation of <code>FromResidual for Result</code> that allows for capturing the code location of every <code>?</code> invocation.</p>
<p>I've filed two issues for this (<a href="https://github.com/rust-lang/rust/issues/95186">#95186</a> and <a href="https://github.com/rust-lang/rust/issues/95187">#95187</a>), but after looking at the min_specialization implementation, it seems very purposeful that const trait impls are disallowed from specialization. I think it makes sense as to why; the const-eval code would need to take the specialization graph into account in order to support specializing const trait impls.</p>
<p>This is a really big wrench for us. We've very recently finished converting all of our Rust code to using <code>TracedError</code>, and we definitely don't want to give up all that work by undoing the specialization and removing the error tracing functionality entirely. But there also doesn't appear to be any quick fix for us. We can't even do the dirty band-aid fix (un-const the <code>FromResidual</code> impl) because some things in stdlib are now dependent on the constness of <code>?</code>.</p>
<p>I don't really know what I'm asking of you folks by posting this. I think I mostly want advice. It would be ideal if I could get into a conversation with Niko or any contributor who knows (and cares) enough about specialization so we can talk through what the expected behavior should really be and try to form a plan of attack for fixing the interaction of <code>min_specialization</code> and <code>const_trait_impls</code>. I'm in a position at work where I can dedicate work hours to fixing this issue in rustc, but I don't have the means to make decisions or understand their implications without talking to somebody who knows this better than I do.</p>



<a name="276266426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266426">(Mar 22 2022 at 23:05)</a>:</h4>
<p>can you share your specialized version of FromResidual for Result?</p>



<a name="276266456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266456">(Mar 22 2022 at 23:05)</a>:</h4>
<p>Yeah, i think it's buried in an old draft PR of mine</p>



<a name="276266462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266462">(Mar 22 2022 at 23:05)</a>:</h4>
<p>tyty</p>



<a name="276266612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266612">(Mar 22 2022 at 23:07)</a>:</h4>
<p><a href="https://github.com/BGR360/rust/blob/return-tracing/library/core/src/result.rs#L1914-L1940">https://github.com/BGR360/rust/blob/return-tracing/library/core/src/result.rs#L1914-L1940</a></p>



<a name="276266829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266829">(Mar 22 2022 at 23:10)</a>:</h4>
<p>yea, the only thing I can think of to do is to use something other than std::result::Result :(</p>



<a name="276266868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266868">(Mar 22 2022 at 23:10)</a>:</h4>
<p>at least as a short term fix</p>



<a name="276266871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266871">(Mar 22 2022 at 23:10)</a>:</h4>
<p>not sure if viable</p>



<a name="276266882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266882">(Mar 22 2022 at 23:10)</a>:</h4>
<p>'tisn't :(</p>



<a name="276266883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266883">(Mar 22 2022 at 23:10)</a>:</h4>
<p>I'm guessing we already talked about that in the past and i don't remember why that wouldn't work for you</p>



<a name="276266945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276266945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276266945">(Mar 22 2022 at 23:11)</a>:</h4>
<p>might be good to copy this discussion over to <a class="stream" data-stream-id="146212" href="/#narrow/stream/146212-t-compiler.2Fconst-eval">#t-compiler/const-eval</a> and/or <a class="stream" data-stream-id="144729" href="/#narrow/stream/144729-wg-traits">#wg-traits</a></p>



<a name="276267080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276267080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276267080">(Mar 22 2022 at 23:13)</a>:</h4>
<p>We did indeed discuss it :)<br>
<a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/254122747">https://rust-lang.zulipchat.com/#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/254122747</a></p>



<a name="276268150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268150">(Mar 22 2022 at 23:24)</a>:</h4>
<p>oof, yea</p>



<a name="276268164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268164">(Mar 22 2022 at 23:24)</a>:</h4>
<p>Here are the only viable short-term actions that I see for us:</p>
<ul>
<li>Stay on 1.58 and indefinitely delay upgrading our rust toolchain</li>
<li>Disable the specialized behavior for <code>Result</code> and forfeit all of the benefits of error tracing in our Rust code (indefinitely)</li>
<li>Hack rustc to "just accept" const trait impls for specialization. This will leave us with a compiler that is <em>known incorrect</em> when evaluating traits at runtime. This may not be as bad as it sounds, considering we don't care about evaluating traits at compile time. But it's still scary since I don't know enough to say that it wouldn't cause other subtle issues.</li>
</ul>



<a name="276268172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268172">(Mar 22 2022 at 23:25)</a>:</h4>
<p>short term, I did manage to get #[track_caller] on result's from residual impl</p>



<a name="276268187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268187">(Mar 22 2022 at 23:25)</a>:</h4>
<p>so you should be able to at least capture locations on each error type interconversion</p>



<a name="276268190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268190">(Mar 22 2022 at 23:25)</a>:</h4>
<p>in your From impl</p>



<a name="276268195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268195">(Mar 22 2022 at 23:25)</a>:</h4>
<p>but you won't get a full trace of every <code>?</code></p>



<a name="276268294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276268294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276268294">(Mar 22 2022 at 23:26)</a>:</h4>
<p>Hm, I hadn't considered that. It's certainly better than nothing.</p>



<a name="276542603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276542603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276542603">(Mar 24 2022 at 21:35)</a>:</h4>
<p>I just discovered that the rustc_const_eval <em>does</em> appear to take specialization into account. I don't know why I assumed otherwise initially.</p>



<a name="276542677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276542677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276542677">(Mar 24 2022 at 21:36)</a>:</h4>
<p>So that "hack" to "just allow const specialized impls" might not be a hack at all and could just be a good PR to make</p>



<a name="276561409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/const%20FromResidual%20borks%20my%20life/near/276561409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/const.20FromResidual.20borks.20my.20life.html#276561409">(Mar 25 2022 at 01:30)</a>:</h4>
<p>Lol, nice!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>