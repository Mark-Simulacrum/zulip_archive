<html>
<head><meta charset="utf-8"><title>Question mark operator inversion · project-error-handling · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/index.html">project-error-handling</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html">Question mark operator inversion</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275667532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275667532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275667532">(Mar 17 2022 at 15:09)</a>:</h4>
<p>Hello, I'm working on an <code>Iterator</code> based lexical analyzer and I've noticed I could use a lot of early returns on the <code>Option::Some</code> side of things, in case I get a matching token. This cannot use <code>?</code> for early returns, since I require the exact opposite behavior. Was inversion of this, in the form of <code>!?</code> ever considered?<br>
On the <code>Option</code> example, <code>!?</code> would return on <code>Option::Some</code> values and continue execution on <code>Option::None</code> values. Same easily applies to 2 other types, which are <code>Result</code> and <code>ControlFlow</code>.</p>



<a name="275668402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275668402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275668402">(Mar 17 2022 at 15:14)</a>:</h4>
<p>I don't think so, I expect that would be a fairly niche usage and can already be made to work with the unstable Try trait with a conversion from Option to a custom Try type that uses None as its Continue type and Some as its Break type</p>



<a name="275669223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275669223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275669223">(Mar 17 2022 at 15:20)</a>:</h4>
<p>Yes, I've checked the <code>Try</code> trait for custom <code>?</code> handling as well as <code>From</code> trait, which is commonly used in transforming errors. The problem I'm having is that <code>Iterator::next</code> requires me to return <code>Option</code>, while <code>ControlFlow</code> has the <code>?</code> working the way I need. I cannot implement a <code>From</code> trait on those 2, so the only other option is to literally duplicate something that's in the standard library (and that's not good). Please lmk if I missed something.</p>



<a name="275669439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275669439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275669439">(Mar 17 2022 at 15:21)</a>:</h4>
<p>Yeah I expect the custom type is going to have to use standard option as its residual type in order to be compatible with the iterator trait</p>



<a name="275669452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275669452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275669452">(Mar 17 2022 at 15:21)</a>:</h4>
<p>But I'm pretty sure this should work</p>



<a name="275669465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275669465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275669465">(Mar 17 2022 at 15:21)</a>:</h4>
<p>Can you link the code where you're having trouble?</p>



<a name="275670283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275670283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275670283">(Mar 17 2022 at 15:25)</a>:</h4>
<p>Sure, here's the troublesome early return<br>
<a href="https://github.com/MiniaczQ/interpreter/blob/master/src/lexer.rs#L69">https://github.com/MiniaczQ/interpreter/blob/master/src/lexer.rs#L69</a><br>
excuse the code quality, I wasn't intending to publish it for a few more days <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275671355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671355">(Mar 17 2022 at 15:31)</a>:</h4>
<p>oh yea I think you're right, this doesn't work</p>



<a name="275671368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671368">(Mar 17 2022 at 15:31)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="125270">@scottmcm</span></p>



<a name="275671466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671466">(Mar 17 2022 at 15:32)</a>:</h4>
<p>because option's from residual impl expects an <code>Option&lt;!&gt;</code></p>



<a name="275671627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671627">(Mar 17 2022 at 15:33)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=a920dba0bb1fcc1cc35721cabb22249b">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=a920dba0bb1fcc1cc35721cabb22249b</a></p>



<a name="275671717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671717">(Mar 17 2022 at 15:33)</a>:</h4>
<p>hmmm</p>



<a name="275671720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671720">(Mar 17 2022 at 15:33)</a>:</h4>
<p>actually</p>



<a name="275671732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671732">(Mar 17 2022 at 15:33)</a>:</h4>
<p>i think this might be doable still</p>



<a name="275671754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671754">(Mar 17 2022 at 15:33)</a>:</h4>
<p>just need to not use the std::option::Option as the residual type</p>



<a name="275671798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671798">(Mar 17 2022 at 15:34)</a>:</h4>
<p>and then we can add the impl from the downstream crate to allow the interconversino</p>



<a name="275671825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275671825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275671825">(Mar 17 2022 at 15:34)</a>:</h4>
<p>lets seeee</p>



<a name="275672441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275672441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275672441">(Mar 17 2022 at 15:37)</a>:</h4>
<p>damnit, says it's still a conflicting impl</p>



<a name="275672867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275672867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275672867">(Mar 17 2022 at 15:40)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=859242c4bf70a8c960808c8a9bfcc01c">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=859242c4bf70a8c960808c8a9bfcc01c</a></p>



<a name="275673018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275673018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275673018">(Mar 17 2022 at 15:41)</a>:</h4>
<p>i don't get how this is overlapping</p>



<a name="275674295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275674295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275674295">(Mar 17 2022 at 15:48)</a>:</h4>
<p>I've had a similar desire at some point, but I came to the conclusion that it's better to use a custom macro for the early returns rather than try to use <code>?</code>. Primarily for others reading the code, <code>?</code> is really tied to error handling and if you're using it the opposite way it makes the code super confusing. A named macro can communicate the intent much better.</p>



<a name="275674503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275674503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275674503">(Mar 17 2022 at 15:49)</a>:</h4>
<p><code>Option&lt;u32&gt;</code> incompatible with <code>Option&lt;u32&gt;</code> is pretty concerning</p>



<a name="275674875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275674875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275674875">(Mar 17 2022 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion/near/275674295">said</a>:</p>
<blockquote>
<p>I've had a similar desire at some point, but I came to the conclusion that it's better to use a custom macro for the early returns rather than try to use <code>?</code>. Primarily for others reading the code, <code>?</code> is really tied to error handling and if you're using it the opposite way it makes the code super confusing. A named macro can communicate the intent much better.</p>
</blockquote>
<p>Another reason why I suggested inversion operator <code>!</code> instead of custom types for this.</p>



<a name="275675172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675172">(Mar 17 2022 at 15:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="486750">Jakub Motyka</span> <a href="#narrow/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion/near/275674503">said</a>:</p>
<blockquote>
<p><code>Option&lt;u32&gt;</code> incompatible with <code>Option&lt;u32&gt;</code> is pretty concerning</p>
</blockquote>
<p>you're referring to "help: the trait <code>FromResidual&lt;Option&lt;u32&gt;&gt;</code> is not implemented for <code>Option&lt;u32&gt;</code>"?</p>



<a name="275675252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675252">(Mar 17 2022 at 15:53)</a>:</h4>
<p>thats because option implements <code>FromResidual&lt;Option&lt;!&gt;&gt;</code></p>



<a name="275675322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675322">(Mar 17 2022 at 15:54)</a>:</h4>
<p>I'll need to read up on that then</p>



<a name="275675378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675378">(Mar 17 2022 at 15:54)</a>:</h4>
<p>though now that you mention it, this may be fixable by just adding the second Option impl, I'm not sure if the compiler can handle seeing those don't overlap though</p>



<a name="275675416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675416">(Mar 17 2022 at 15:54)</a>:</h4>
<p>also, im not sure we'd want to</p>



<a name="275675451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675451">(Mar 17 2022 at 15:54)</a>:</h4>
<p>given nick's comments above</p>



<a name="275675538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675538">(Mar 17 2022 at 15:55)</a>:</h4>
<p>it would probably also make it much easier to accidentally make mistakes when making Try impls with Options</p>



<a name="275675562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675562">(Mar 17 2022 at 15:55)</a>:</h4>
<p>where people misunderstand how it works and do it backwards because now that's a thing</p>



<a name="275675575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675575">(Mar 17 2022 at 15:55)</a>:</h4>
<p>tho that should be caught quickly i hope</p>



<a name="275675752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675752">(Mar 17 2022 at 15:56)</a>:</h4>
<p>regardless, I'm curious to see what scott says once he's around</p>



<a name="275675781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675781">(Mar 17 2022 at 15:56)</a>:</h4>
<p>he's the defacto expert on Try</p>



<a name="275675802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675802">(Mar 17 2022 at 15:56)</a>:</h4>
<p>normally this project group treats try as out of scope</p>



<a name="275675956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675956">(Mar 17 2022 at 15:57)</a>:</h4>
<p>tho I'm not sure I still completely agree with that decision, we made it originally because Try is a language feature more than a libs feature but really all the impls on the various try types is totally under the libs domain</p>



<a name="275675971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275675971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275675971">(Mar 17 2022 at 15:57)</a>:</h4>
<p>so its really both teams</p>



<a name="275676067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275676067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275676067">(Mar 17 2022 at 15:57)</a>:</h4>
<p>but in practice scott has done a majority of the work on it so it doesnt really matter whose team is technically responsible for it, just who is actually working on it</p>



<a name="275683454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275683454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275683454">(Mar 17 2022 at 16:24)</a>:</h4>
<p>You might be interested in this comment from <span class="user-mention silent" data-user-id="125254">kennytm</span> that implemented inversion for <code>Result</code>: <a href="https://github.com/rust-lang/rfcs/pull/3058#issuecomment-766365909">https://github.com/rust-lang/rfcs/pull/3058#issuecomment-766365909</a></p>



<a name="275685310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275685310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275685310">(Mar 17 2022 at 16:30)</a>:</h4>
<p>Alternatively, consider using a macro to represent the "use the first one that gives a value" rather than phrasing it as short-circuiting.  Something like this: &lt;<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=32b4b4628e37648c719917dd2e8e9db7">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=32b4b4628e37648c719917dd2e8e9db7</a>&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(try_trait_v2)]</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">coalesce</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="cp">$a</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">expr</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="cp">$($c</span>:<span class="nc">expr</span><span class="p">),</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">ControlFlow</span>::<span class="n">Continue</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Try</span>::<span class="n">branch</span><span class="p">(</span><span class="cp">$a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">v</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="w"> </span><span class="cp">$($c</span><span class="p">),</span><span class="o">+</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$($a</span>:<span class="nc">expr</span><span class="p">),</span><span class="o">+</span><span class="w"> </span><span class="p">,)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="cp">$($a</span><span class="p">),</span><span class="o">+</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">Err</span><span class="p">(()),</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w"> </span><span class="n">coalesce</span><span class="o">!</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">,),</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which is the v2-ized version of <a href="https://internals.rust-lang.org/t/something-for-coalescing-aka-generalized-improved-or-else/9295?u=scottmcm">https://internals.rust-lang.org/t/something-for-coalescing-aka-generalized-improved-or-else/9295?u=scottmcm</a></p>



<a name="275686468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275686468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Motyka <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275686468">(Mar 17 2022 at 16:34)</a>:</h4>
<p>I like the swap return idea, I'll definitely check that out<br>
I made a macro for a single early return, but I don't know if there is a point in grouping those, since I have a special case in the middle for ETX. Maybe if I rearrange it a little it could work.<br>
Thanks for the feedback <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="275686564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275686564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275686564">(Mar 17 2022 at 16:34)</a>:</h4>
<p>For the lang side, I suspect it's very unlikely that an operator for the other direction would be added.</p>
<p>But as that post on the RFC demonstrated, it's possible to spell it as <code>.bikeshed()?</code> instead of you want it.  I'm not convinced that I'd want to include that in core, but it's possible.</p>



<a name="275687171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275687171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275687171">(Mar 17 2022 at 16:37)</a>:</h4>
<p>The other thing that could help in future is <a href="#narrow/stream/213817-t-lang/topic/try.20blocks/near/275118445">better <code>try</code> blocks</a>.</p>
<p>You could write your "matching token" stuff as returning <code>ControlFlow&lt;Token&gt;</code> instead of <code>Option&lt;Token&gt;</code>, then the <code>Iterator::next</code> could be implemented as <code>try { foo()?; bar()?; }.break_value()</code>.  (That doesn't work nicely today because of type rules, though.)</p>
<p>Dunno if that'd be the best answer, but it'd be another thing to see how it feels.</p>



<a name="275690187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275690187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> MiniaczQ <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275690187">(Mar 17 2022 at 16:47)</a>:</h4>
<p>Yeah, I thought mid-talk of using <code>try</code> or just having another function that returns <code>ControlFlow</code> as a middle man<br>
I'll see what feels better to work with<br>
As for the lang, I didn't really expect it to be added (and this would also take ages, I'd be waay overdue on the assignment), hope there will be some more thoughts about this in the future, if/when more use cases show up</p>



<a name="275693899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275693899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275693899">(Mar 17 2022 at 17:04)</a>:</h4>
<p>One way I've been thinking of it is that <code>try { a?; b? }</code> is basically <code>Result::and_then</code>, but we don't really have anything for <code>Result::or_else</code> right now.</p>
<p>(A silly observation that I don't think is the right way is that of course there are demorgan's laws.  So <code>or_else</code> could hypothetically be <code>!try { (!a)?; (!b)? }</code>.  Amusingly that's basically what you mentioned originally, if <code>!</code> were postfix the way it should be.)</p>
<p>I don't think it's necessarily the case that that's best done with <code>?</code>, though.  If you look in other languages, it's more like <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/null-coalescing-operator">C#'s <code>??</code> operator</a>, rather than things that are done by early-returns.</p>



<a name="275697326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257204-project-error-handling/topic/Question%20mark%20operator%20inversion/near/275697326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pachi <a href="https://zulip-archive.rust-lang.org/stream/257204-project-error-handling/topic/Question.20mark.20operator.20inversion.html#275697326">(Mar 17 2022 at 17:24)</a>:</h4>
<p>If suffix macros are someday a thing, maybe this could be a good use case</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>