<html>
<head><meta charset="utf-8"><title>Make `-Z binary-dep-depinfo` the default … compiler-team#464 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html">Make `-Z binary-dep-depinfo` the default … compiler-team#464</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254744952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254744952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254744952">(Sep 24 2021 at 17:51)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/464">Make <code>-Z binary-dep-depinfo</code> the default behavior #464</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="254747786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254747786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> est31 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254747786">(Sep 24 2021 at 18:10)</a>:</h4>
<p>I just want to say I support this MCP because cargo-udeps supports using binary depinfo  as a backend, and right now all backends are nightly only. this MCP would thus allow cargo-udeps to support stable compilers as well. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="254747808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254747808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> est31 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254747808">(Sep 24 2021 at 18:10)</a>:</h4>
<p>For more, see: <a href="https://github.com/est31/cargo-udeps/issues/73">https://github.com/est31/cargo-udeps/issues/73</a></p>



<a name="254749670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254749670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254749670">(Sep 24 2021 at 18:23)</a>:</h4>
<p>why does this need to be the default? it sounds like just stabilizing the flag would be enough</p>



<a name="254749890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254749890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254749890">(Sep 24 2021 at 18:24)</a>:</h4>
<p>-Zbinary-dep-depinfo includes paths from the sysroot. This makes it dependent on the location of the rust installation. In addition the sysroot as a whole needs to be copied anyway if you want to run rustc.</p>



<a name="254750147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254750147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254750147">(Sep 24 2021 at 18:26)</a>:</h4>
<p>It also includes the codegen backend path, which would force everything to be rebuilt every time you make a change to it, even if it is irrelevant to all successfully built crates.</p>



<a name="254751340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254751340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254751340">(Sep 24 2021 at 18:34)</a>:</h4>
<p>Yea, I would expect an MCP to address the outstanding issues on the tracking issue. I think it also lacks a precise description of what it actually does.</p>



<a name="254751982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254751982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254751982">(Sep 24 2021 at 18:38)</a>:</h4>
<p>I'll note that the early impl was basically just intended to suite the use cases of rustc bootstrap, so any usage beyond that may work but is likely more accident than not.</p>



<a name="254758394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254758394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254758394">(Sep 24 2021 at 19:22)</a>:</h4>
<p>I think this use case really wants "all the non-sysroot files that rustc will open during compilation", which also includes rlibs that are opened but not used and source files from external crates that define macros, for instance</p>



<a name="254758862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254758862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254758862">(Sep 24 2021 at 19:26)</a>:</h4>
<p>someone I work with is making a change to include these</p>



<a name="254758952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254758952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254758952">(Sep 24 2021 at 19:27)</a>:</h4>
<p>that seems like the behavior we'd want to stabilize, potentially behind a new flag</p>



<a name="254759057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254759057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254759057">(Sep 24 2021 at 19:27)</a>:</h4>
<p>I originally suggested making this default behavior to the MCP author because I thought it was fixing a more general problem of link deps missing from depfiles</p>



<a name="254759117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254759117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254759117">(Sep 24 2021 at 19:28)</a>:</h4>
<p>(which it might be, these are overlapping use cases)</p>



<a name="254759486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254759486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254759486">(Sep 24 2021 at 19:30)</a>:</h4>
<p>but <em>transitive</em> rlibs don't necessarily have to be included to address that issue, since (as the MCP says) they're redundant</p>



<a name="254759972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254759972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254759972">(Sep 24 2021 at 19:34)</a>:</h4>
<p>There are three use cases I see for dep-info:</p>
<ol>
<li>Getting the set of source files in a crate for dev tools</li>
<li>Collecting dynamic dependencies so a build system knows to rebuild this crate when one of those deps changes</li>
<li>Collecting the set of files that rustc needs to run in a sandboxed environment (needs source files, link deps, transitive closure of rlibs, external source files that macro spans point to, etc.)</li>
</ol>



<a name="254760635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254760635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254760635">(Sep 24 2021 at 19:39)</a>:</h4>
<p>I'm trying to decide if (2) is really distinct from (1), since most build systems already know the set of link deps and rlibs, and only really need the set of source files</p>



<a name="254761662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254761662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254761662">(Sep 24 2021 at 19:46)</a>:</h4>
<p>I think they're the same</p>



<a name="254761798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254761798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254761798">(Sep 24 2021 at 19:47)</a>:</h4>
<p>So maybe we eventually want two output modes</p>



<a name="254761884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254761884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254761884">(Sep 24 2021 at 19:48)</a>:</h4>
<p>Or we decide there's no cost to including everything (3) needs by default</p>



<a name="254763338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254763338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254763338">(Sep 24 2021 at 19:58)</a>:</h4>
<p>You can compute (3) by taking the union of the depinfo for the current crate, all the depinfo files corresponding to direct dependencies in the depinfo transitively as provided by (2) and the compiler sysroot.</p>



<a name="254772431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Make%20%60-Z%20binary-dep-depinfo%60%20the%20default%20%E2%80%A6%20compiler-team%23464/near/254772431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Make.20.60-Z.20binary-dep-depinfo.60.20the.20default.20.E2.80.A6.20compiler-team.23464.html#254772431">(Sep 24 2021 at 21:05)</a>:</h4>
<p>The sysroot files are explicitly the reason rustbuild uses it, fwiw, though it generally is intended as a way to offload most of the "recompile if" management to Cargo. Previously there were a lot more bugs because that responsibility was more extensively shared.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>