<html>
<head><meta charset="utf-8"><title>prefer-dynamic=subset compiler-team#455 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html">prefer-dynamic=subset compiler-team#455</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249670355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249670355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249670355">(Aug 17 2021 at 02:01)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/455">prefer-dynamic=subset #455</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="249676809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249676809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249676809">(Aug 17 2021 at 04:09)</a>:</h4>
<p>it seems odd to me that we put link modifiers on <code>-l</code> flags corresponding to individual native libs, but for <code>prefer-dynamic</code> we have a <em>single</em> modifier and would list the set of lib names under it</p>



<a name="249676933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249676933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249676933">(Aug 17 2021 at 04:13)</a>:</h4>
<p>it does make sense to have a special flag for the std case; clang has analogous flags like <code>-static-libc++</code> or similar</p>



<a name="249676983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249676983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249676983">(Aug 17 2021 at 04:14)</a>:</h4>
<p>and we allow linking crates without specifying them directly on the command line, so for that you need something like this</p>



<a name="249677008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249677008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249677008">(Aug 17 2021 at 04:15)</a>:</h4>
<p>but for uses where you are listing deps explicitly (<code>-l</code> or <code>--extern</code>), it would be nice to have a modifier syntax for this</p>



<a name="249677069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249677069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249677069">(Aug 17 2021 at 04:17)</a>:</h4>
<p>that said, as long as <code>subset</code> is appended each successive flag, I think this proposal would still cover 99% of use cases</p>



<a name="249677076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249677076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249677076">(Aug 17 2021 at 04:17)</a>:</h4>
<p>the other 1% is when you need to <em>override</em> an earlier flag requesting dynamic linking for some reason.</p>



<a name="249677134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249677134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249677134">(Aug 17 2021 at 04:18)</a>:</h4>
<p>(this can come up in build systems that assemble flags from a lot of sources, some of which take priority over others)</p>



<a name="249677209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249677209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249677209">(Aug 17 2021 at 04:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/249677008">said</a>:</p>
<blockquote>
<p>but for uses where you are listing deps explicitly (<code>-l</code> or <code>--extern</code>), it would be nice to have a modifier syntax for this</p>
</blockquote>
<p>actually I guess for <code>--extern</code> you just point directly to the rlib or dylib you want, so it's unambiguous already</p>



<a name="249683090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249683090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249683090">(Aug 17 2021 at 06:30)</a>:</h4>
<p>Another option would be to ignore <code>crate-type</code> for dependencies and instead add a <code>dynamic</code> flag to <code>[profile]</code> allowing the user to make whatever crate(s) they want dynamic. This currently can't be done without without patching the source of dependencies.</p>



<a name="249721519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249721519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249721519">(Aug 17 2021 at 13:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/249676809">said</a>:</p>
<blockquote>
<p>it seems odd to me that we put link modifiers on <code>-l</code> flags corresponding to individual native libs, but for <code>prefer-dynamic</code> we have a <em>single</em> modifier and would list the set of lib names under it</p>
</blockquote>
<p>This is a good point. I think I could make <code>-Cprefer-dynamic=crate</code> additive: if the flag occurs multiple times, then we take the union of the sets. That way, <code>-Cprefer-dynamic=crate1 -Cprefer-dynamic=crate2</code> would be synonymous with <code>-Cprefer-dynamic=crate1,crate2</code>.</p>



<a name="249721842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249721842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249721842">(Aug 17 2021 at 13:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/249683090">said</a>:</p>
<blockquote>
<p>Another option would be to ignore <code>crate-type</code> for dependencies and instead add a <code>dynamic</code> flag to <code>[profile]</code> allowing the user to make whatever crate(s) they want dynamic. This currently can't be done without without patching the source of dependencies.</p>
</blockquote>
<p>There’s lots of ways that I would consider changing <code>cargo</code> in this space (e.g. I think it could do a better job of analyzing the crate graph and telling people about problematic combinations up front). But I will admit that I worry a little bit about trying to monkey-patch dynamic library support onto a crate that didn’t explicitly opt in to having a <code>dylib</code> output type.</p>



<a name="249731958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249731958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249731958">(Aug 17 2021 at 15:03)</a>:</h4>
<blockquote>
<p>But I will admit that I worry a little bit about trying to monkey-patch dynamic library support onto a crate that didn’t explicitly opt in to having a dylib output type.</p>
</blockquote>
<p>The only crates which wouldn't support it are those linking to non-rust libraries. Those crates would give problems anyway if you try to depend on them from dylibs. <code>[profile.'&lt;profile&gt;'.package.'&lt;package name&gt;'] dynamic = true</code> allows the user to decide exactly which crates they want to be dylibs and which not. Strategic dylib usage allows for great reductions in linking time. This can speedup compilation by more than 2x in certain cases: <a href="https://bevyengine.org/news/bevy-0-4/#dynamic-linking">https://bevyengine.org/news/bevy-0-4/#dynamic-linking</a></p>



<a name="249740871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249740871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249740871">(Aug 17 2021 at 16:07)</a>:</h4>
<p>In any case, I see no reason we wouldn’t do both things here? I.e., provide some change to <code>rustc</code>, so that people who aren’t using cargo can still benefit? And then independently look into the changes that you suggest, to make it easier for people who don’t want to mess around with RUSTFLAGS settings?</p>



<a name="249742995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249742995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249742995">(Aug 17 2021 at 16:23)</a>:</h4>
<p>Yeah, I guess doing both has benefits too. I think <code>-Cprefer-dynamic=subset</code> could be useful even for cargo with <code>[profile] dynamic = true</code>.</p>



<a name="249796517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249796517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249796517">(Aug 18 2021 at 00:50)</a>:</h4>
<p>As a non-cargo user, I'm pretty sure the only thing we want this feature for is <code>std</code>. If we want to build a crate as a dylib we will specify that on the crate target and <em>only</em> build it as a dylib. If we need to build it as both for some reason, we will create a new target with a different output name.</p>



<a name="249869107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249869107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249869107">(Aug 18 2021 at 15:42)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> (or anyone else): I’m trying to puzzle something out. Right now, we only compute dylib dependencies by scanning dylibs. My inference has been that an rlib, by design, cannot implicitly link to a .dylib</p>



<a name="249869391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249869391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249869391">(Aug 18 2021 at 15:44)</a>:</h4>
<p>actually, let me put some names in here. Consider e.g. the <a href="https://github.com/rust-lang/rust/issues/82151#issuecomment-779368017">minimized example</a> from <a href="https://github.com/rust-lang/rust/issues/82151">#82151</a>: we have:</p>
<div class="codehilite"><pre><span></span><code>app &lt;- shared (dylib) &lt;- foo (rlib) &lt;- bar ([&quot;lib&quot;, &quot;staticlib&quot;, &quot;cdylib&quot;])
</code></pre></div>



<a name="249869624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249869624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249869624">(Aug 18 2021 at 15:46)</a>:</h4>
<p>and that crate structure yields the error  "undefined reference to `bar::bar’” at link time.</p>



<a name="249869731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249869731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249869731">(Aug 18 2021 at 15:47)</a>:</h4>
<p>The question I have is: Should we extend the <code>rlib</code> format to carry its dylib dependencies, and change rustc_metadata::dependency_format to scan rlibs for those dependencies, the same way it scans dylibs?</p>



<a name="249869842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249869842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249869842">(Aug 18 2021 at 15:48)</a>:</h4>
<p>I was avoiding adopting such a solution because an explicit <code>-Cprefer-dynamic</code> flag seemed like a good thing to offer and it seemed sufficient to solve the problem, while extending the rlib format sounds scary</p>



<a name="249871041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249871041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249871041">(Aug 18 2021 at 15:56)</a>:</h4>
<p>I should go back and revise that example. It doesn’t illustrate the actual problem well at all, since its providing a <code>cdylib</code> that itself tries to export a Rust function.</p>



<a name="249874609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249874609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249874609">(Aug 18 2021 at 16:22)</a>:</h4>
<p>cdylibs should be completely ignored in the linkage code. you can't link against them as rust code, only as c code.</p>



<a name="249879931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/249879931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#249879931">(Aug 18 2021 at 17:01)</a>:</h4>
<p>Right, that’s why I was saying the example was bad</p>



<a name="250039274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250039274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250039274">(Aug 19 2021 at 19:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/249869107">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> (or anyone else): I’m trying to puzzle something out. Right now, we only compute dylib dependencies by scanning dylibs. My inference has been that an rlib, by design, cannot implicitly link to a .dylib</p>
</blockquote>
<p>Okay I explored a little further and determined that my above inference was incorrect. The run-make test I just added to PR <a href="https://github.com/rust-lang/rust/issues/88101">#88101</a> illustrates that the scenario is a little more subtle.</p>



<a name="250040416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250040416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250040416">(Aug 19 2021 at 19:54)</a>:</h4>
<p>Namely, I made a test that looks like this: </p>
<div class="codehilite"><pre><span></span><code>m6 (app) -&gt; m5 (rlib) -&gt; m4 (dylib) -&gt; m3 (rlib,dylib) -&gt; m2 (lib) -&gt; m1 (dylib,rlib)
</code></pre></div>
<p>Today, out of the box, the above doesn’t build by default. I.e leaving out <code>-C prefer-dynamic</code> entirely leads to a linker failure when building <code>m6</code>.</p>
<p>You can add <code>-C prefer-dynamic</code> at various points along the chain and get different linkage results. So far I’ve constructed, using vanilla <code>-C prefer-dynamic</code> alone:</p>
<div class="codehilite"><pre><span></span><code>(v2): m5:rlib m4:dylib m3:dylib m2:lib m1:rlib
(v6): m5:rlib m4:dylib m3:dylib m2:lib m1:dylib
</code></pre></div>
<p>But with the new <code>-C prefer-dynamic=subset</code>, I was also able to express:</p>
<div class="codehilite"><pre><span></span><code>(v5): m5:rlib m4:dylib m3:rlib m2:lib m1:rlib
</code></pre></div>



<a name="250067151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250067151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250067151">(Aug 20 2021 at 01:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/249677076">said</a>:</p>
<blockquote>
<p>the other 1% is when you need to <em>override</em> an earlier flag requesting dynamic linking for some reason.</p>
</blockquote>
<p>This actually came up literally today (there's a workaround but it's annoying), so I'm going to say we should have a way of expressing this :-)</p>



<a name="250067589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250067589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250067589">(Aug 20 2021 at 01:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/250040416">said</a>:</p>
<blockquote>
<p>Today, out of the box, the above doesn’t build by default. I.e leaving out <code>-C prefer-dynamic</code> entirely leads to a linker failure when building <code>m6</code>.</p>
</blockquote>
<p>This sounds like a bug?</p>



<a name="250068029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068029">(Aug 20 2021 at 01:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/250067589">said</a>:</p>
<blockquote>
<p>This sounds like a bug?</p>
</blockquote>
<p>This is the struggle I’m having. It <em>does</em> sound like a bug. But its not a bug I think I’m prepared to try to solve <del>today</del> in the short term.</p>



<a name="250068134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068134">(Aug 20 2021 at 01:30)</a>:</h4>
<p>The issue is that our tools (or at least rustc), as a whole, tend to pooh-pooh mixing of rlibs and dylibs in your project. The messaging seems to fall into: “you should just make sure you have the same library type available all the way up the chain.” (Note that in the example I’m describing, there is one path that is all just rlibs nor all just dylibs.)</p>



<a name="250068148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068148">(Aug 20 2021 at 01:31)</a>:</h4>
<p>So right now, I’d prefer to figure out what flag(s) to offer</p>



<a name="250068164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068164">(Aug 20 2021 at 01:31)</a>:</h4>
<blockquote>
<p>You can add <code>-C prefer-dynamic</code> at various points along the chain and get different linkage results. </p>
</blockquote>
<p>Looking at this makes me a little uneasy :) Your goal is to modify graph edges in the build, but this is doing it with global rustflags that specify crate names, which may not even be unique within the workspace. Technically this can work for just about any case, with crate renaming, but this isn't how I'd design it if I were working with any other build system. I think this flag is really working around a limitation in cargo; namely, that it doesn't let you control these aspects of the build at a fine grained level.</p>
<p>The fact that this flag turns on <a href="https://rust-lang.github.io/rfcs/0404-change-prefer-dynamic.html">heuristic behavior we've had to change in the past</a> tells me that it's working at the wrong level of abstraction for a compiler flag. Ideally I think <code>prefer-dynamic</code> would have been a cargo option which implemented those heuristics and then invoked rustc with flags telling it exactly which libraries to link, and how. Then this conversation would be about how to design more fine-grained control over the build graph in cargo.</p>
<p>I'm not entirely sure what this means for "where we should go from here," though. Some of this is my pent up frustration/confusion with trying to understand the interface in the past, and it's not fair for me to take that out on this MCP which is strictly an improvement :). But it definitely makes me think that we want to look for a lower level interface in the long term.</p>



<a name="250068217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068217">(Aug 20 2021 at 01:32)</a>:</h4>
<p>I think we need to do both. Of course we need to improve <code>cargo</code>.</p>



<a name="250068233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068233">(Aug 20 2021 at 01:32)</a>:</h4>
<p>And maybe I’m making a mistake in trying to paper over the <code>cargo</code> limitations rather than address them directly</p>



<a name="250068267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068267">(Aug 20 2021 at 01:33)</a>:</h4>
<blockquote>
<p>Some of this is my pent up frustration/confusion with trying to understand the interface in the past, and it's not fair for me to take that out on this MCP which is strictly an improvement</p>
</blockquote>
<p>I’m glad I’m not the only one who is confused by the interface.</p>



<a name="250068340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068340">(Aug 20 2021 at 01:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/250068233">said</a>:</p>
<blockquote>
<p>And maybe I’m making a mistake in trying to paper over the <code>cargo</code> limitations rather than address them directly</p>
</blockquote>
<p>I'm unsure about this too. I guess it partly depends on how urgently the feature is needed</p>



<a name="250068360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068360">(Aug 20 2021 at 01:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116883">@tmandry</span> nonetheless, it sounds like you’re saying you, as a non-<code>cargo</code> user, would benefit from <code>-C prefer-dynamic=std</code>, right?</p>



<a name="250068382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068382">(Aug 20 2021 at 01:36)</a>:</h4>
<p>Or do you all already get that effect, but you just have to do some grodier magic to compose the right <code>rustc</code> invocation to express it?</p>



<a name="250068426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068426">(Aug 20 2021 at 01:36)</a>:</h4>
<p>My basic point of view is that I’ve done about as much hacking on rustc’s <code>prefer-dynamic</code> as I want to do, besides fixing obvious bugs. All further work from here on out should be on <code>cargo</code>.</p>



<a name="250068427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068427">(Aug 20 2021 at 01:36)</a>:</h4>
<p>we do get that effect, because <code>std</code> is the only rust library that is built as both and rlib and a dylib under the same name in our build</p>



<a name="250068441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068441">(Aug 20 2021 at 01:37)</a>:</h4>
<p>but that might be a restriction we would want to lift in the future. I'm not sure</p>



<a name="250068545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250068545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250068545">(Aug 20 2021 at 01:39)</a>:</h4>
<p>hmm, the fact that I just said we might want to do something "in the past" instead of "in the future" tells me I need to stop working :-)</p>



<a name="250069015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250069015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250069015">(Aug 20 2021 at 01:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455/near/250068441">said</a>:</p>
<blockquote>
<p>but that might be a restriction we would want to lift in the future. I'm not sure</p>
</blockquote>
<p>this would be nice to have, I think, though not critical</p>



<a name="250071072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/250071072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#250071072">(Aug 20 2021 at 02:30)</a>:</h4>
<p>One thing I’d love to hear from other people: It wuold be great if someone who actually cares about the semantics of rlibs mixed with dylbis (both the heuristic selection of rlib/dylib and how things behave when you have rlibs depending on dylibs) could look over the results of the <a href="https://github.com/pnkfelix/rust/blob/issue-82151-parameterize-prefer-dynamic/src/test/run-make-fulldeps/dylib-subset/Makefile#L46">run-make test</a> I made, and tell me which cases you think represent outright bugs. (I.e. things like <span class="user-mention" data-user-id="116883">@tmandry</span> ’s reaction up above, which corresponds to <code>v1</code> in the run-make test.)</p>



<a name="251086654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251086654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251086654">(Aug 28 2021 at 22:24)</a>:</h4>
<p>I'm currently looking into this although I didn't yet read the PR's code in detail.</p>



<a name="251086991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251086991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251086991">(Aug 28 2021 at 22:31)</a>:</h4>
<p>I'm skeptical about pulling this logic into <code>rustc</code> in general.<br>
The preferred mode of operation for libraries since cargo introduction is feeding libraries to rustc precisely with <code>--extern name=EXACT_PATH</code>.<br>
So the build system (cargo or other, doesn't matter) is responsible for deciding what <code>EXACT_PATH</code> is, what crate type it has, and building prerequisites for it, so  rustc doesn't generally choose or prefer, that's basically a legacy pre-cargo logic, it just obeys the build system commands.<br>
The exception is crates linked by name like <code>--extern name</code>/<code>extern crate name;</code> and that's standard library in most cases.</p>



<a name="251087744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251087744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251087744">(Aug 28 2021 at 22:47)</a>:</h4>
<p>Also, cargo is better suited for addressing anything by name - you can specify the package name and version, and it can unify all the version constraints from your crate and dependencies (including indirect ones) and give you the right path to the crate.<br>
With disambiguation happening in rustc you have to address crates by their "internal" names written into metadata, I guess? (I'll look in more detail tomorrow.) Internal names can duplicate in the same build tree.<br>
In the PR comments bjorn3 suggests to also pass some hashes from the build system to uniquely identify the crate, but if that logic is already put into the build system, then why not pass the right set of <code>--extern name=EXACT_PATH</code>s instead so rustc doesn't have to disambiguate at all?</p>



<a name="251087847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251087847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251087847">(Aug 28 2021 at 22:49)</a>:</h4>
<p>I need to think about the case where the crate is looked up by name instead of precise path (aka "usually std").</p>



<a name="251088878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251088878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251088878">(Aug 28 2021 at 23:08)</a>:</h4>
<blockquote>
<p>the case where the crate is looked up by name</p>
</blockquote>
<p>Actually, it may be as simple as passing <code>--extern std=/path/to/libstd.so</code> or <code>--extern std=/path/to/libstd.rlib</code>?<br>
Explicit path dependencies are preferred to lookup by name.</p>



<a name="251107976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251107976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251107976">(Aug 29 2021 at 05:37)</a>:</h4>
<p>The exact location and name of libstd is an implementation detail. The name depends on the rustc version. You can't just use the only file in the sysroot that matches libstd-*.so as in cause of a globally installed rust installation, there may be other versions of the standard library installed in the same location.</p>



<a name="251703549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/251703549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#251703549">(Sep 02 2021 at 12:01)</a>:</h4>
<hr>
<p>The situation with indirect dependencies is worse than I thought.<br>
Even if we are using <code>--extern name=EXACT_PATH</code> when building a rlib <code>A</code>, the exact path and even its "crate flavor" (rmeta/rlib/dylib) are lost.<br>
So when we are building a crate <code>B</code> depending on <code>A</code>, <code>A</code>s dependencies will be looked up again (by hash) and we may find a different set of rmeta/rlib/dylib flavors than it was found originally.<br>
I implemented preserving the flavor in <a href="https://github.com/petrochenkov/rust/tree/cflavor">https://github.com/petrochenkov/rust/tree/cflavor</a> but there's a catch...</p>
<p>The catch is that cargo actively relies on the flavor being lost.<br>
The <code>EXACT_PATH</code> passed by cargo is usually <code>--extern name=path/to/mylib.rmeta</code>.<br>
However, the second lookup finds rlibs and dylibs with the same hash in addition to that rmeta, and uses them.</p>
<p>We can change cargo to pass <code>--extern name=path/to/mylib.(rlib or dylib)</code> as well to specify the preferred flavor, but it conflicts with pipelined compilation.<br>
<code>--extern name=EXACT_PATH</code> requires the <code>EXACT_PATH</code> to exist, but with pipelined compilation it does not yet exist, that's why cargo passes the rmeta only and relies on the second lookup to find corresponding rlibs/dylibs.</p>



<a name="252334949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/prefer-dynamic%3Dsubset%20compiler-team%23455/near/252334949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/prefer-dynamic.3Dsubset.20compiler-team.23455.html#252334949">(Sep 07 2021 at 16:46)</a>:</h4>
<blockquote>
<p>Even if we are using --extern name=EXACT_PATH when building a rlib A, the exact path and even its "crate flavor" (rmeta/rlib/dylib) are lost.<br>
So when we are building a crate B depending on A, As dependencies will be looked up again (by hash) and we may find a different set of rmeta/rlib/dylib flavors than it was found originally.</p>
</blockquote>
<p>Ah, this does indeed sound like it is at the heart of some of the oddness I was encountering.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>