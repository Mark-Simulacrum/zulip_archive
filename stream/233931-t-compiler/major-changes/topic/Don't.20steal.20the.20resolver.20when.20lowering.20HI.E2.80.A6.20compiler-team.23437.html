<html>
<head><meta charset="utf-8"><title>Don&#x27;t steal the resolver when lowering HI… compiler-team#437 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html">Don&#x27;t steal the resolver when lowering HI… compiler-team#437</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="241669736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241669736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241669736">(Jun 06 2021 at 03:36)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/437">Don't steal the resolver when lowering HIR; instead look resolution info up on-demand #437</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="241669799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241669799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241669799">(Jun 06 2021 at 03:39)</a>:</h4>
<p>I have some (very broken) WIP code, I will try to push it somewhere before I go to bed so you can get an idea of what the changes look like. I don't yet know how to access the Queries struct in TyCtxt, does anyone know how?</p>



<a name="241669874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241669874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241669874">(Jun 06 2021 at 03:41)</a>:</h4>
<p>(happy to move this to <a class="stream" data-stream-id="182449" href="/#narrow/stream/182449-t-compiler.2Fhelp">#t-compiler/help</a> if you want to keep this stream focused on whether this is a good idea or not)</p>



<a name="241671353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241671353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241671353">(Jun 06 2021 at 04:13)</a>:</h4>
<p>the other thing I just ran into is I don't know how to get a &amp;Resolver from a &amp;BoxedResolver (<code>.access()</code> requires <code>&amp;mut BoxedResolver</code>). This seems like it should be possible but <code>declare_box_region_type </code> in rustc_data_structures is a nightmare of keywords</p>



<a name="241671645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241671645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241671645">(Jun 06 2021 at 04:20)</a>:</h4>
<p>Have you seen <a href="https://github.com/rust-lang/rust/pull/85885">https://github.com/rust-lang/rust/pull/85885</a>?</p>



<a name="241671659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241671659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241671659">(Jun 06 2021 at 04:21)</a>:</h4>
<p>I have not! Thank you <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span></p>



<a name="241672008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672008">(Jun 06 2021 at 04:30)</a>:</h4>
<p>I would really like if <code>TyCtxt</code> keeps using <code>ResolverOutputs</code> as input instead of <code>Resolver</code>. It saves memory and provides a really nice abstraction point to decouple the frontend (everythjng before HIR) from the middle end (everything with HIR before codegen) and would theoretically allow for example plugging in a frontend for a rust like language or using completely different frontends for different editions.</p>



<a name="241672078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672078">(Jun 06 2021 at 04:33)</a>:</h4>
<p>What do you think about this setup?</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/compiler/rustc_middle/src/ty/context.rs b/compiler/rustc_middle/src/ty/context.rs</span>
<span class="gh">index 970e669c16f..cf3e9109910 100644</span>
<span class="gd">--- a/compiler/rustc_middle/src/ty/context.rs</span>
<span class="gi">+++ b/compiler/rustc_middle/src/ty/context.rs</span>
<span class="gu">@@ -932,6 +932,10 @@ fn deref(&amp;self) -&gt; &amp;Self::Target {</span>
     }
 }

<span class="gi">+pub trait Resolver {</span>
<span class="gi">+    fn resolver_outputs(&amp;self) -&gt; &amp;ty::ResolverOutputs;</span>
<span class="gi">+}</span>
<span class="gi">+</span>
 pub struct GlobalCtxt&lt;'tcx&gt; {
     pub arena: &amp;'tcx WorkerLocal&lt;Arena&lt;'tcx&gt;&gt;,

<span class="gu">@@ -1129,7 +1133,7 @@ pub fn create_global_ctxt(</span>
         s: &amp;'tcx Session,
         lint_store: Lrc&lt;dyn Any + sync::Send + sync::Sync&gt;,
         arena: &amp;'tcx WorkerLocal&lt;Arena&lt;'tcx&gt;&gt;,
<span class="gd">-        resolutions: ty::ResolverOutputs,</span>
<span class="gi">+        resolver: &amp;'tcx impl Resolver,</span>
         krate: &amp;'tcx hir::Crate&lt;'tcx&gt;,
         dep_graph: DepGraph,
         on_disk_cache: Option&lt;query::OnDiskCache&lt;'tcx&gt;&gt;,
</code></pre></div>
<p>that keeps the abstraction boundary while still not requiring the outputs to be cloned</p>



<a name="241672161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672161">(Jun 06 2021 at 04:34)</a>:</h4>
<blockquote>
<p>would theoretically allow for example plugging in a frontend for a rust like language or using completely different frontends for different editions.</p>
</blockquote>
<p>this isn't possible even today, rustdoc wouldn't work with the other frontend</p>



<a name="241672165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672165">(Jun 06 2021 at 04:34)</a>:</h4>
<p>exactly because it uses the Resolver directly</p>



<a name="241672180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672180">(Jun 06 2021 at 04:35)</a>:</h4>
<p><code>trait Resolver</code> could work, but I don't know if the overhead isn't too high.</p>



<a name="241672227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672227">(Jun 06 2021 at 04:36)</a>:</h4>
<p>While rustdoc wouldn't support it, rustc should support alternative frontends without too much changes to rustc_interface already I think.</p>



<a name="241672229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672229">(Jun 06 2021 at 04:36)</a>:</h4>
<p>I would expect the overhead to be less than cloning the CStore, but I don't have any data to back it up.</p>



<a name="241672246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672246">(Jun 06 2021 at 04:37)</a>:</h4>
<p>I was thinking about the overhead for regular compilation.</p>



<a name="241672249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672249">(Jun 06 2021 at 04:37)</a>:</h4>
<p>regular compilation also clones the CStore.</p>



<a name="241672254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672254">(Jun 06 2021 at 04:37)</a>:</h4>
<p>err hmm no I think you're right, Rc::try_unwrap will succeed when rustdoc isn't running</p>



<a name="241672303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672303">(Jun 06 2021 at 04:38)</a>:</h4>
<p>It currently doesn't go through an indirection when accessing resolver outputs from TyCtxt.</p>



<a name="241672309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672309">(Jun 06 2021 at 04:38)</a>:</h4>
<p>oh, you mean because with the new setup the TyCtxt would have to call <code>resolver_outputs()</code> each time</p>



<a name="241672318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672318">(Jun 06 2021 at 04:39)</a>:</h4>
<p>if that turns out to be an issue I can add a function for each individual output, that should reduce the boxing/cloning</p>



<a name="241672450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672450">(Jun 06 2021 at 04:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/241669799">said</a>:</p>
<blockquote>
<p>I have some (very broken) WIP code, I will try to push it somewhere before I go to bed so you can get an idea of what the changes look like.</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/compare/master...jyn514:no-steal?expand=1">https://github.com/rust-lang/rust/compare/master...jyn514:no-steal?expand=1</a></p>



<a name="241672793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241672793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241672793">(Jun 06 2021 at 04:53)</a>:</h4>
<p>I could also have it return borrows instead of owned values, that should make things a lot faster and only the boxing will be left</p>



<a name="241673096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241673096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241673096">(Jun 06 2021 at 05:00)</a>:</h4>
<p>Before I forget: the current setup will cause BorrowMut errors when rustdoc tries to access the resolver; instead I can implement ty::Resolver for Queries and pass that in.</p>
<p>To reduce the overhead further I could pass in ResolverOutputs directly when rustdoc isn't running, but that requires more <code>actually_rustdoc</code> special casing so I'd rather not unless the perf difference is really bad.</p>



<a name="241683009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241683009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241683009">(Jun 06 2021 at 09:35)</a>:</h4>
<p>I don't think this is a good idea, and I still think <a href="https://github.com/rust-lang/rust/issues/83761">https://github.com/rust-lang/rust/issues/83761</a> is preferable and also easier to implement.</p>



<a name="241683158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241683158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241683158">(Jun 06 2021 at 09:39)</a>:</h4>
<p>With frozen resolver you cannot do pretty much anything, and modifying resolver is dangerous because it's not covered by query system and its changes are not tracked.</p>



<a name="241683227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241683227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241683227">(Jun 06 2021 at 09:41)</a>:</h4>
<p>Integrating name resolution into incremental/queries is a large future task, and fixing <a href="https://github.com/rust-lang/rust/issues/83761">#83761</a> by collecting doc links in rustdoc earlier should be a much simpler task.</p>



<a name="241685502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241685502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241685502">(Jun 06 2021 at 10:44)</a>:</h4>
<p>This MCP could be a first step towards this integration, as a baby step, and would unlock querifying HIR lowering.</p>



<a name="241689963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241689963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241689963">(Jun 06 2021 at 12:41)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> fixing this in Rustdoc is <em>not</em> easier to implement, I made more progress in the three hours I played around last night than in the 2 weeks I spent on the rustdoc approach.</p>
<blockquote>
<p>modifying resolver is dangerous because it's not covered by query system and its changes are not tracked</p>
</blockquote>
<p>Hmm, you mean rustdoc modifying the resolver is dangerous? Rustdoc doesn't modify the incremental cache so I'm not <em>super</em> worried about that:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>rm -r target
<span class="gp">$ </span>cargo doc
<span class="go"> Documenting hello-world v0.1.0 (/home/joshua/src/rust/hello-world)</span>
<span class="go">    Finished dev [unoptimized + debuginfo] target(s) in 2.41s</span>
<span class="gp">$ </span>ls target/debug/incremental/
<span class="gp">$</span>
</code></pre></div>
<p>My proposed scheme with <code>trait Resolver</code> wouldn't allow modifying the resolver through the TyCtxt, so it shouldn't be an issue for rustc itself.</p>
<blockquote>
<p>With frozen resolver you cannot do pretty much anything</p>
</blockquote>
<p>This is the existing situation, not my proposed change, right?</p>



<a name="241690078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241690078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241690078">(Jun 06 2021 at 12:43)</a>:</h4>
<p>The associated GitHub issue has been renamed. Renaming this Zulip topic.</p>



<a name="241690226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241690226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241690226">(Jun 06 2021 at 12:46)</a>:</h4>
<p>I updated the MCP with the discussion in this thread to make it more clear the TyCtxt won't have mutable access.</p>



<a name="241690583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/241690583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#241690583">(Jun 06 2021 at 12:55)</a>:</h4>
<blockquote>
<p>Hmm, you mean rustdoc modifying the resolver is dangerous? Rustdoc doesn't modify the incremental cache so I'm not super worried about that:</p>
</blockquote>
<p>I guess the way this could go wrong is, within the same rustdoc invocation:</p>
<ol>
<li>TyCtxt is created</li>
<li>Rustdoc runs a query that depends on resolve info (maybe DefIds? I don't know what can actually change; my understanding is that the resolver doesn't update DefIds even when more crates are loaded)</li>
<li>Rustdoc loads a new crate</li>
<li>Rustdoc reruns the query, and the TyCtxt gives it the cached old value, but it may have changed based on the new crate</li>
</ol>
<p>I am ok with that risk, it only affects rustdoc and it seems like something we could work around.</p>



<a name="242421770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/242421770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#242421770">(Jun 12 2021 at 02:23)</a>:</h4>
<p>any further thoughts on this? having this be broken is causing lots of rustdoc regressions (in particular the mess in <a href="https://github.com/rust-lang/rust/pull/84867">https://github.com/rust-lang/rust/pull/84867</a>)</p>



<a name="242526588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/242526588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#242526588">(Jun 13 2021 at 19:26)</a>:</h4>
<p>What is the source of the regressions?<br>
If it's <a href="https://github.com/rust-lang/rust/pull/83738">https://github.com/rust-lang/rust/pull/83738</a> then feel free to land <a href="https://github.com/rust-lang/rust/pull/85749">https://github.com/rust-lang/rust/pull/85749</a> if it's needed for the upcoming release.<br>
I still plan to investigate the underlying issues behind it (<a href="https://github.com/rust-lang/rust/issues/84738">https://github.com/rust-lang/rust/issues/84738</a>), but I was busy during the last weeks and now I'm on vacation.</p>



<a name="242527385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/242527385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#242527385">(Jun 13 2021 at 19:48)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> the one I was thinking of was <a href="https://github.com/rust-lang/rust/issues/82465">https://github.com/rust-lang/rust/issues/82465</a>, which has a fix in <a href="https://github.com/rust-lang/rust/pull/82496">https://github.com/rust-lang/rust/pull/82496</a> but can't be merged because of the inconsistent crate loading. I guess "causing regressions" is incorrect, but it is true that the whole mess would be cleared up if this were fixed.</p>



<a name="242527397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/242527397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#242527397">(Jun 13 2021 at 19:49)</a>:</h4>
<p>(<a href="https://github.com/rust-lang/rust/pull/84867">https://github.com/rust-lang/rust/pull/84867</a> is a giant mess that has landed on some channels but not others; there's info in <a href="#narrow/stream/241545-t-release/topic/how.20to.20track.20ETA.20when.20nightly.20will.20be.20cut.20to.20beta/near/242135597">https://rust-lang.zulipchat.com/#narrow/stream/241545-t-release/topic/how.20to.20track.20ETA.20when.20nightly.20will.20be.20cut.20to.20beta/near/242135597</a> if you really want to know)</p>



<a name="242527449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/242527449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#242527449">(Jun 13 2021 at 19:50)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116083">@pnkfelix</span> I guess, but there's nothing actionable here for you</p>



<a name="243023608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243023608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243023608">(Jun 17 2021 at 14:15)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> I'm a bit confused by this -- we are storing a "read-only view" of the resolver in the tyctxt, is the idea, but mutation is still possible?</p>



<a name="243026686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243026686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243026686">(Jun 17 2021 at 14:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> mutation is possible, but only through Queries, not through TyCtxt</p>



<a name="243026763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243026763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243026763">(Jun 17 2021 at 14:35)</a>:</h4>
<p>That makes it effectively read-only for most of the compiler, but still lets rustdoc mutate it and have the compiler see the changes.</p>



<a name="243200991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243200991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243200991">(Jun 18 2021 at 19:42)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> This is definitely contra to the design of incremental; what kind of mutations do we expect?</p>



<a name="243201356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243201356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243201356">(Jun 18 2021 at 19:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I think the only mutations should be new crates loaded after HIR is built, and new DefIds registered within that crate.</p>
<p>Are you saying this is contrary to the design because resolutions aren't tracked by the query system? I wouldn't expect them to inherently not fit because the whole point of incremental is to delay things as long as possible.</p>



<a name="243201392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243201392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243201392">(Jun 18 2021 at 19:47)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> may have more insight into what can change after the TyCtxt is created.</p>



<a name="243789196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243789196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243789196">(Jun 24 2021 at 13:54)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> I'm reading more about this, playing catch up on the threads. What does "partial resolution" mean, as referenced in <a href="https://github.com/rust-lang/rust/issues/83761#issuecomment-812968168">your github comment</a>?</p>



<a name="243789357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243789357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243789357">(Jun 24 2021 at 13:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/243201356">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> I think the only mutations should be new crates loaded after HIR is built, and new DefIds registered within that crate.</p>
</blockquote>
<p>Does this imply that rustdoc has control-flow paths that loads new crates after HIR is built, and these control-flow paths do not exist in rustc itself?</p>



<a name="243789494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243789494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243789494">(Jun 24 2021 at 13:56)</a>:</h4>
<blockquote>
<p>Does this imply that rustdoc has control-flow paths that loads new crates after HIR is built, and these control-flow paths do not exist in rustc itself?</p>
</blockquote>
<p>Yes. Intra-doc links can link to items that are not used otherwise.</p>



<a name="243789710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243789710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243789710">(Jun 24 2021 at 13:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/243789196">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> I'm reading more about this, playing catch up on the threads. What does "partial resolution" mean, as referenced in <a href="https://github.com/rust-lang/rust/issues/83761#issuecomment-812968168">your github comment</a>?</p>
</blockquote>
<p>It's kind of a implementation detail of the strategy I was using there, which didn't work out. The idea was to do the path-based resolution before the TyCtxt was created and the type-based resolution after, which required splitting the whole intra-doc pass into two. I am no longer pursuing that approach.</p>



<a name="243790139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243790139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243790139">(Jun 24 2021 at 14:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/243789494">said</a>:</p>
<blockquote>
<blockquote>
<p>Does this imply that rustdoc has control-flow paths that loads new crates after HIR is built, and these control-flow paths do not exist in rustc itself?</p>
</blockquote>
<p>Yes. Intra-doc links can link to items that are not used otherwise.</p>
</blockquote>
<p>this is actually the whole reason for the ICEs, if we didn't support this it wouldn't be an issue. But that's already on stable so I don't think we can change it now :/ and it seems confusing to have to add imports for rustdoc when things would work fine in code.</p>



<a name="243791243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243791243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243791243">(Jun 24 2021 at 14:07)</a>:</h4>
<p>another possible alternative is to do this in the opposite order: store <em>only</em> a read-only resolver on TyCtxt, start tracking changes to it in the query system, and only then allow rustdoc to mutate it. That's a lot more time and effort, but it seems more correct and inline with the compiler's long-term goals</p>



<a name="243791319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243791319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243791319">(Jun 24 2021 at 14:08)</a>:</h4>
<p>I would need mentoring to work on that I think, but I can put in some time on weekends.</p>



<a name="243795936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243795936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243795936">(Jun 24 2021 at 14:40)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> </p>
<blockquote>
<p>It's kind of a implementation detail of the strategy I was using there, which didn't work out. The idea was to do the path-based resolution before the TyCtxt was created and the type-based resolution after, which required splitting the whole intra-doc pass into two.</p>
</blockquote>
<p>Why didn't it work out?<br>
This is the approach that rustc uses, quite successfully.<br>
I still think this is what rustdoc should do as well.</p>



<a name="243796058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243796058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243796058">(Jun 24 2021 at 14:41)</a>:</h4>
<p>it was several weeks of work, and each change I made made me realize how much more work it was going to be. I don't have to work on it now and I don't think anyone else does either.</p>



<a name="243796126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243796126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243796126">(Jun 24 2021 at 14:42)</a>:</h4>
<p>(full-time weeks, not "a weekend each week")</p>



<a name="243796303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243796303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243796303">(Jun 24 2021 at 14:43)</a>:</h4>
<p>I don't say that it will be easy, because rustdoc has been consistently painting itself into corners for years by inventing custom hygiene rules for intra-doc links, and doing other horrifying stuff, but it's still the easiest thing to do (and a proper one, I think).</p>



<a name="243796538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243796538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243796538">(Jun 24 2021 at 14:45)</a>:</h4>
<p><span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> I personally am not willing to work on it</p>



<a name="243797152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243797152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243797152">(Jun 24 2021 at 14:49)</a>:</h4>
<p>I will note that the hard part is the error reporting, not the hygiene rules. Splitting the pass means all <em>potential</em> failures have to be resolved up front too.</p>



<a name="243797234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243797234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243797234">(Jun 24 2021 at 14:49)</a>:</h4>
<p>and rustdoc has more constraints than resolve because it doesn't know what namespace the item belongs in.</p>



<a name="243797256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243797256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243797256">(Jun 24 2021 at 14:49)</a>:</h4>
<p>(At this point this issue annoys me enough to be willing to work on it, the problem is that I don't have time.)</p>



<a name="243798080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243798080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243798080">(Jun 24 2021 at 14:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/243797152">said</a>:</p>
<blockquote>
<p>I will note that the hard part is the error reporting, not the hygiene rules. Splitting the pass means all <em>potential</em> failures have to be resolved up front too.</p>
</blockquote>
<p>Could you elaborate, what is the problem exactly?<br>
If the exact namespace is not known, then the path can be resolved in all namespaces, all partial resolutions can be saved for later if necessary, all procuced errors can be saved for later if necessary as well.</p>



<a name="243798422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243798422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243798422">(Jun 24 2021 at 14:57)</a>:</h4>
<p>It's out of cache for me. I'd have to look at the errors on <a href="https://github.com/jyn514/rust/commit/8d3d43f3a1a97739505d03430972ff08e1667a23">https://github.com/jyn514/rust/commit/8d3d43f3a1a97739505d03430972ff08e1667a23</a>.</p>



<a name="243799328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/243799328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#243799328">(Jun 24 2021 at 15:02)</a>:</h4>
<p>I see, I guess I'll have to look at it myself anyway to really understand what's the problem.</p>



<a name="251059958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251059958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251059958">(Aug 28 2021 at 14:33)</a>:</h4>
<p>Ok, I took another look at the code and I'm remembering why this was hard. Essentially the problem is I have to go line-by-line through the 2k line file and decide whether it belongs in the early or late pass, then decide how to store the state at that exact point in the program so that it can be retrieved later.  (also rebasing the code is a pain because I made the mistake of trying to split things into different files before it was finished)</p>
<p>My concern essentially is that this is a <em>lot</em> of work that will be unnecessary once the resolver is involved in incremental <em>anyway</em>. So rather than spending two or three weeks on nothing but this, I would rather spend the time on making the resolver incremental, which helps both rustdoc and the compiler itself, and doesn't waste effort.</p>



<a name="251059982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251059982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251059982">(Aug 28 2021 at 14:33)</a>:</h4>
<p>there's progress being made on incremental already, <span class="user-mention" data-user-id="248906">@cjgillot</span> has been working on that pretty steadily <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> <a href="https://github.com/rust-lang/rust/pull/87234">https://github.com/rust-lang/rust/pull/87234</a></p>



<a name="251060693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251060693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251060693">(Aug 28 2021 at 14:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/241683227">said</a>:</p>
<blockquote>
<p>Integrating name resolution into incremental/queries is a large future task, and fixing <a href="https://github.com/rust-lang/rust/issues/83761">#83761</a> by collecting doc links in rustdoc earlier should be a much simpler task.</p>
</blockquote>
<p>^ essentially I disagree that collecting links earlier is simpler</p>



<a name="251135721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251135721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251135721">(Aug 29 2021 at 14:20)</a>:</h4>
<p>Ok, <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> and I talked this over and we have a plan for making this work without major changes to the resolver; he convinced me it will take a very long time for the resolver to be part of incremental, and I want to try and fix these issues without having to wait. I'll close the MCP.</p>



<a name="251136096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251136096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251136096">(Aug 29 2021 at 14:27)</a>:</h4>
<blockquote>
<p>he convinced me it will take a very long time for the resolver to be part of incremental</p>
</blockquote>
<p>(and also that it will be easier to make the resolver incremental if it doesn't have to deal with rustdoc being special)</p>



<a name="251136621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251136621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251136621">(Aug 29 2021 at 14:37)</a>:</h4>
<p>I'm also interested in the solution you found.</p>



<a name="251136904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251136904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251136904">(Aug 29 2021 at 14:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251136621">said</a>:</p>
<blockquote>
<p>I'm also interested in the solution you found.</p>
</blockquote>
<p>It's the same basic idea as <a href="https://github.com/rust-lang/rust/issues/83761#issuecomment-812347962">https://github.com/rust-lang/rust/issues/83761#issuecomment-812347962</a> (expand the dropdown), we just fleshed it out a bit more.</p>
<p>Actually <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> I don't think we'd need an index for the links, we could just store them directly using the <code>EarlyIntraDocLink</code> type I mention there. Rustdoc doesn't care what order the links are in, it already compares them using the link target: <a href="https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/html/markdown.rs#L371">https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/html/markdown.rs#L371</a></p>



<a name="251136924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251136924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251136924">(Aug 29 2021 at 14:43)</a>:</h4>
<p>i.e. the map would be <code>FxHashMap&lt;DefId, Vec&lt;Link&gt;&gt;</code>, we wouldn't need an index to go with the DefId</p>



<a name="251137026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251137026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251137026">(Aug 29 2021 at 14:44)</a>:</h4>
<p>also <span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> is working on moving <code>traits_in_scope</code> to the early pass, and at the same time storing the info in rustc's internal map instead of rustdoc replicating it</p>



<a name="251137063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251137063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251137063">(Aug 29 2021 at 14:45)</a>:</h4>
<p>we didn't discuss macro resolution in detail, but the only uses which aren't in intra-doc links are a pretty bad misuse of the API and I don't think they will be terribly hard to fix: <a href="https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/clean/inline.rs#L180">https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/clean/inline.rs#L180</a></p>



<a name="251137129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251137129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251137129">(Aug 29 2021 at 14:46)</a>:</h4>
<p>fyi <span class="user-mention" data-user-id="417924">@inquisitivecrystal</span> I think you forgot to update this line, it assumes all macro_rules macros have macro_export <a href="https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/clean/inline.rs#L189">https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/clean/inline.rs#L189</a></p>



<a name="251137152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251137152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251137152">(Aug 29 2021 at 14:47)</a>:</h4>
<p>(although maybe that's just how macro_rules works <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> )</p>



<a name="251137644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251137644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251137644">(Aug 29 2021 at 14:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251136904">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251136621">said</a>:</p>
<blockquote>
<p>I'm also interested in the solution you found.</p>
</blockquote>
<p>Actually <span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> I don't think we'd need an index for the links, we could just store them directly using the <code>EarlyIntraDocLink</code> type I mention there. Rustdoc doesn't care what order the links are in, it already compares them using the link target: <a href="https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/html/markdown.rs#L371">https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/html/markdown.rs#L371</a></p>
</blockquote>
<p>oh no I'm being silly - your idea was to have this replace the call in <code>resolve_path</code> altogether, which has only the path_str. So we do need to replace the path_str with an index.</p>



<a name="251139795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251139795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251139795">(Aug 29 2021 at 15:36)</a>:</h4>
<p>I don't think it needs the DefId of the item being documented though, only the DefId of the module. If multiple items in the same module have the same link they can cache the result between them.</p>



<a name="251143179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251143179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251143179">(Aug 29 2021 at 16:35)</a>:</h4>
<p>Hmm, so even resolving the early link properly is somewhat tricky - rustdoc chooses the parent module based on <em>lots</em> of things: <a href="https://github.com/rust-lang/rust/blob/ef524710669a003cf2b24361dc6b04b566e560fa/src/librustdoc/passes/collect_intra_doc_links.rs#L836-L916">https://github.com/rust-lang/rust/blob/ef524710669a003cf2b24361dc6b04b566e560fa/src/librustdoc/passes/collect_intra_doc_links.rs#L836-L916</a></p>



<a name="251143227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251143227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251143227">(Aug 29 2021 at 16:36)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> is there a way to get the DefKind of a DefId from the resolver? or do I need to already have a Res? DefIdTree only gives me DefIds</p>



<a name="251143253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251143253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251143253">(Aug 29 2021 at 16:37)</a>:</h4>
<p>ah, I want <code>resolver.cstore().def_kind()</code></p>



<a name="251144162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251144162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251144162">(Aug 29 2021 at 16:55)</a>:</h4>
<p>Hmm, I'm not sure how this could work for <code>Self::</code>. The way it works currently is by finding what item <code>Self</code> is and turning it into a string, but the way it does that depends heavily on the tcx: <a href="https://github.com/rust-lang/rust/blob/ef524710669a003cf2b24361dc6b04b566e560fa/src/librustdoc/passes/collect_intra_doc_links.rs#L881-L897">https://github.com/rust-lang/rust/blob/ef524710669a003cf2b24361dc6b04b566e560fa/src/librustdoc/passes/collect_intra_doc_links.rs#L881-L897</a><br>
and I'm not sure how to do it without stringifying. Hmm, maybe I can try tackling that alone first, not stringifiying.</p>



<a name="251144708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251144708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251144708">(Aug 29 2021 at 17:04)</a>:</h4>
<p>Is the <code>Self</code> logic used for paths literally starting with <code>Self</code> like <code>Self::foo</code>?<br>
If such a path is passed to <code>resolve_str_path_error</code> then it will always return an error, <code>Self::foo</code> is type-based resolution.</p>



<a name="251144836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251144836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251144836">(Aug 29 2021 at 17:06)</a>:</h4>
<p>Or is it used for something else, like determining the parent module for a link path based on what <code>Self</code> resolves to?<br>
E.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// `a::b` &lt;- resolves in the parent module of `Yyy`</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Zzz</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Yyy</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="251145050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251145050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251145050">(Aug 29 2021 at 17:10)</a>:</h4>
<p>Does <code>src\librustdoc\passes\collect_intra_doc_links\early.rs</code> work correctly by using parent modules returned by <code>attrs.collapsed_doc_value_by_module_level()</code>?<br>
If yes then we already have parent modules, if no then why we don't have ICEs from missing crates due to incorrect parent modules being used?</p>



<a name="251145802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251145802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251145802">(Aug 29 2021 at 17:23)</a>:</h4>
<hr>
<p>Regarding the traits in scope, looks like we cannot use the rustc's map, it only keeps traits in scope for local nodes, but rustdoc needs traits that are in scope for foreign modules, so we need a separate rustdoc-specific map after all.</p>



<a name="251154820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251154820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251154820">(Aug 29 2021 at 20:07)</a>:</h4>
<p>Ok, a question that I must ask - why we are getting this when documenting an almost empty crate (<code>pub fn foo() {}</code>):</p>
<div class="codehilite"><pre><span></span><code>// in `fn traits_implemented_by(cx: &amp;mut DocContext&lt;&#39;_&gt;, type_: DefId, module: DefId) -&gt; FxHashSet&lt;DefId&gt; {`

[src\librustdoc\passes\collect_intra_doc_links.rs:775] module = DefId(2:7461 ~ core[84a3]::iter::traits::iterator)
[src\librustdoc\passes\collect_intra_doc_links.rs:776] type_ = DefId(2:42307 ~ core[84a3]::iter::adapters::peekable::Peekable)
</code></pre></div>



<a name="251154862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251154862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251154862">(Aug 29 2021 at 20:08)</a>:</h4>
<p>There are no links at all, the function doesn't refer to anything in <code>core::iter</code>, but rustdoc still wants to know which traits are in scope in that module.</p>



<a name="251155789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251155789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251155789">(Aug 29 2021 at 20:25)</a>:</h4>
<p>Apparently rustdoc resolves links from the whole standard library when documenting any program.</p>



<a name="251155792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251155792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251155792">(Aug 29 2021 at 20:25)</a>:</h4>
<blockquote>
<p>Is the Self logic used for paths literally starting with Self like Self::foo?</p>
</blockquote>
<p>Yes, but the <code>Self</code> is replaced by the name of the item (see the link above). Parent modules have their own whole mess, but it's unrelated to Self.</p>
<blockquote>
<p>Does src\librustdoc\passes\collect_intra_doc_links\early.rs work correctly by using parent modules returned by attrs.collapsed_doc_value_by_module_level()?  If yes then we already have parent modules, if no then why we don't have ICEs from missing crates due to incorrect parent modules being used?</p>
</blockquote>
<p>Sort of - it uses the right function, but because it passes in <code>None</code> for the extra attributes it only has the attributes for the current item, not attributes that come from a re-export of the original definition. The difference comes when you add additional docs on a re-export:</p>
<div class="codehilite"><pre><span></span><code>/// Link to [foo]
pub use std::process::Command;
</code></pre></div>
<p>The reason it doesn't ICE is the same, because it completely ignores all new attributes.</p>
<blockquote>
<p>Ok, a question that I must ask - why we are getting this when documenting an almost empty crate (pub fn foo() {}):</p>
</blockquote>
<p>I'm not sure off the top of my head, but I suspect rustdoc is trying to look at the links written in other crates, not just the current. That seems like the wrong behavior, I'd have to look into it. I did a little looking just now and found that it's trying to document <code>impl&lt;T&gt; From&lt;!&gt; for T</code> - maybe one of <code>clean::blanket_impl</code> or <code>clean::auto_trait</code> are buggy?</p>



<a name="251156438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251156438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251156438">(Aug 29 2021 at 20:38)</a>:</h4>
<blockquote>
<p>Yes, but the Self is replaced by the name of the item (see the link above)</p>
</blockquote>
<p>Well, since it's a hack anyway, the impl type can be printed during early resolution as well, using <code>pprust</code>.<br>
(I doubt that the current behavior can be translated precisely if rustdoc uses some type information when preparing paths passed to <code>resolve_str_path_error</code> or determining their parent modules.)</p>



<a name="251156489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251156489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251156489">(Aug 29 2021 at 20:39)</a>:</h4>
<p>Ideally, <code>Self::foo</code> should be resolved using type checker, not resolver.</p>



<a name="251156590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251156590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251156590">(Aug 29 2021 at 20:40)</a>:</h4>
<p>In rustc it gets to type checker as a partially resolved path with the resolved part having resolution <code>Res::SelfTy</code>.</p>



<a name="251156602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251156602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251156602">(Aug 29 2021 at 20:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251156489">said</a>:</p>
<blockquote>
<p>Ideally, <code>Self::foo</code> should be resolved using type checker, not resolver.</p>
</blockquote>
<p>is this possible? I've found the type checker really confusing, how can I ask it to resolve a type?</p>



<a name="251158427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251158427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251158427">(Aug 29 2021 at 21:14)</a>:</h4>
<p>Type-based resolution for associated types is done by <code>fn associated_path_to_ty</code>, and for associated functions and constants by <code>fn resolve_fully_qualified_call</code>.<br>
I'm not sure what is necessary to use these methods from rustdoc, perhaps setting up some contexts will be required.</p>



<a name="251159566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251159566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251159566">(Aug 29 2021 at 21:35)</a>:</h4>
<blockquote>
<p>Type-based resolution for associated types is done by fn associated_path_to_ty, and for associated functions and constants by fn resolve_fully_qualified_call.</p>
</blockquote>
<p>hmm, these both give hard errors, so rustdoc can't use them</p>



<a name="251159573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251159573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251159573">(Aug 29 2021 at 21:35)</a>:</h4>
<p>it has to be a recoverable error</p>



<a name="251159581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251159581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251159581">(Aug 29 2021 at 21:35)</a>:</h4>
<p>actually I think <span class="user-mention" data-user-id="210316">@GuillaumeGomez</span> added some API to ignore errors when implementing go-to-definition</p>



<a name="251159646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251159646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251159646">(Aug 29 2021 at 21:36)</a>:</h4>
<p>I did :)</p>



<a name="251161045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251161045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251161045">(Aug 29 2021 at 22:02)</a>:</h4>
<blockquote>
<p>Apparently rustdoc resolves links from the whole standard library when documenting any program.</p>
</blockquote>
<p>All that stuff is added to rustdoc <code>Crate</code> by the <code>collect-trait-impls</code> pass.</p>



<a name="251161145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251161145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251161145">(Aug 29 2021 at 22:03)</a>:</h4>
<p>(I'll investigate further tomorrow.)</p>



<a name="251172258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251172258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251172258">(Aug 30 2021 at 01:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251137129">said</a>:</p>
<blockquote>
<p>fyi <span class="user-mention silent" data-user-id="417924">inquisitivecrystal</span> I think you forgot to update this line, it assumes all macro_rules macros have macro_export <a href="https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/clean/inline.rs#L189">https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/src/librustdoc/clean/inline.rs#L189</a></p>
</blockquote>
<p>After staring at that code for 5 minutes in an attempt to understand it, I think you're right.</p>



<a name="251172532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251172532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251172532">(Aug 30 2021 at 01:22)</a>:</h4>
<p>I don't have the least clue how to test it though (either locally or as a real test).</p>



<a name="251172587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251172587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251172587">(Aug 30 2021 at 01:23)</a>:</h4>
<p>Left to my own devices, I'd probably change it, and then if the tests still pass assume that the changed version is correct.</p>



<a name="251174419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251174419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251174419">(Aug 30 2021 at 01:59)</a>:</h4>
<p>Hmm, the code says something about source links - maybe see if the [src] link goes to the wrong place if the macro is defined in a file other than the root <a href="http://lib.rs">lib.rs</a>?</p>



<a name="251736113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251736113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251736113">(Sep 02 2021 at 15:43)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> <br>
Does extraction of intra doc links (i.e. paths to resolve) require nontrivial markdown parsing (like using <code>pulldown-cmark</code>)?</p>



<a name="251736291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251736291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251736291">(Sep 02 2021 at 15:44)</a>:</h4>
<p>I thought about resolving the intra doc links in rustc and writing them into metadata (under an option, or even by default if it's cheap).</p>



<a name="251736493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251736493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251736493">(Sep 02 2021 at 15:45)</a>:</h4>
<p>The main difference between rustc and rustdoc is that rustc doesn't have to "compile code from other crates", it just takes everything from the other crate's metadata in already prepared form, because all the relevant data was gathered in advance during that other crate's compilation.</p>



<a name="251737099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251737099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251737099">(Sep 02 2021 at 15:50)</a>:</h4>
<p>That's why rustc never needs things like "collect traits in scope at some point in other crate".</p>



<a name="251737517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251737517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251737517">(Sep 02 2021 at 15:52)</a>:</h4>
<blockquote>
<p>resolving the intra doc links</p>
</blockquote>
<p>(*) resolving in rustc sense, with all the extras like namespace disambiguators being left for rustdoc.</p>



<a name="251739416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251739416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251739416">(Sep 02 2021 at 16:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251736113">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <br>
Does extraction of intra doc links (i.e. paths to resolve) require nontrivial markdown parsing (like using <code>pulldown-cmark</code>)?</p>
</blockquote>
<p>yes, parsing markdown is non-trivial</p>



<a name="251739560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251739560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251739560">(Sep 02 2021 at 16:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251736291">said</a>:</p>
<blockquote>
<p>I thought about resolving the intra doc links in rustc and writing them into metadata (under an option, or even by default if it's cheap).</p>
</blockquote>
<p>Hmm, I think gating this under an option would break cargo; it assumes that if it runs <code>cargo check</code> on a dependency then that metadata can be reused for rustdoc</p>



<a name="251739720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251739720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251739720">(Sep 02 2021 at 16:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Don't.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437/near/251737099">said</a>:</p>
<blockquote>
<p>That's why rustc never needs things like "collect traits in scope at some point in other crate".</p>
</blockquote>
<p>hmm, did this turn out to be especially hard? I wouldn't expect it to be terrible to do ahead of time if you're keeping it in rustdoc. Trying to move it to rustc seems harder.</p>



<a name="251741202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251741202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251741202">(Sep 02 2021 at 16:13)</a>:</h4>
<p>It's shouldn't be that hard, it just requires some rustdoc knowledge.<br>
In particular, either the high-level rustdoc logic needs to be restructured to run the <code>collect_trait_impls</code> pass before the <code>src\librustdoc\passes\collect_intra_doc_links\early.rs</code> stuff, or <code>collect_trait_impls</code> needs to be duplicated in some simpler form.</p>



<a name="251741377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251741377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251741377">(Sep 02 2021 at 16:14)</a>:</h4>
<p>I was just thinking about possible alternatives, if intra doc link parsing requires pulling <code>pulldown-cmark</code> into rustc, then it's probably not the best idea.</p>



<a name="251741518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251741518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251741518">(Sep 02 2021 at 16:15)</a>:</h4>
<p>I'm going the "duplicated in some simpler form" route right now.</p>



<a name="251742419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251742419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251742419">(Sep 02 2021 at 16:20)</a>:</h4>
<p>wait, do you mean the pass that looks at auto and blanket impls? I wouldn't expect that to be related to intra-doc links - why does it need to come before?</p>



<a name="251742540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251742540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251742540">(Sep 02 2021 at 16:21)</a>:</h4>
<p>do you mean <code>traits_implemented_by</code>?</p>



<a name="251742672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251742672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251742672">(Sep 02 2021 at 16:22)</a>:</h4>
<p>I would expect the only thing that needs to be lifted into the early pass is this bit: <a href="https://github.com/rust-lang/rust/blob/fcce644119cf4e8e36001368e514bb5ed67cb855/src/librustdoc/passes/collect_intra_doc_links.rs#L773-L782">https://github.com/rust-lang/rust/blob/fcce644119cf4e8e36001368e514bb5ed67cb855/src/librustdoc/passes/collect_intra_doc_links.rs#L773-L782</a><br>
which doesn't depend on the tcx</p>



<a name="251744154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251744154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251744154">(Sep 02 2021 at 16:32)</a>:</h4>
<p><code>collect_trait_impls</code> collects impl items from other crates, those impl items have doc comments with links on them, those links are resolved at the impl's def site, including associated segments that require traits that are in scope at the impl's def site.</p>



<a name="251744314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251744314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251744314">(Sep 02 2021 at 16:33)</a>:</h4>
<p><code>traits_implemented_by</code> is modified to take traits from a map pre-populated in <code>early.rs</code> (instead of accessing resolver), so <code>early.rs</code> needs to know "locations" of all items collected by <code>collect_trait_impls</code>.</p>



<a name="251744864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251744864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251744864">(Sep 02 2021 at 16:37)</a>:</h4>
<p>oh I see, collect_trait_impls is adding items to <code>clean::Crate</code></p>



<a name="251745053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251745053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251745053">(Sep 02 2021 at 16:38)</a>:</h4>
<p>Hmm. I don't see how you can do that without access to a tyctxt, doesn't it need to see if trait bounds are met for types?</p>



<a name="251745083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251745083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251745083">(Sep 02 2021 at 16:38)</a>:</h4>
<p>since it's looking at blanket impls</p>



<a name="251747743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251747743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251747743">(Sep 02 2021 at 16:56)</a>:</h4>
<p>Yeah, that's a problem.<br>
In theory, <code>get_auto_trait_and_blanket_impls</code> for foreign crates can work with <code>CStore</code> alone, without <code>tcx</code>, but in practice that would mean duplicating a lot of code.</p>



<a name="251789967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251789967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251789967">(Sep 02 2021 at 21:32)</a>:</h4>
<p>Status update: pre-populating traits in scope for <em>all</em> foreign modules with impls works fine, now I only have one panicking test - <code>src\test\rustdoc\intra-doc\libstd-re-export.rs</code>, reexport modules are not yet processed.<br>
It shouldn't even be that slow, <code>collect_trait_impls</code> alone should be significantly more expensive.<br>
<a href="https://github.com/petrochenkov/rust/commits/doctrscope">https://github.com/petrochenkov/rust/commits/doctrscope</a></p>



<a name="251793563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/251793563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#251793563">(Sep 02 2021 at 22:04)</a>:</h4>
<blockquote>
<p>It shouldn't even be that slow, collect_trait_impls alone should be significantly more expensive.</p>
</blockquote>
<p>yeah collect_trait_impls is horrifically slow, anything that doesn't touch  the trait system should be much faster</p>



<a name="252109112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Don%27t%20steal%20the%20resolver%20when%20lowering%20HI%E2%80%A6%20compiler-team%23437/near/252109112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Don&#x27;t.20steal.20the.20resolver.20when.20lowering.20HI.E2.80.A6.20compiler-team.23437.html#252109112">(Sep 05 2021 at 23:26)</a>:</h4>
<p>Status update: PR is up <a href="https://github.com/rust-lang/rust/pull/88679">https://github.com/rust-lang/rust/pull/88679</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>