<html>
<head><meta charset="utf-8"><title>Add `TerminatorKind::Box` to MIR compiler-team#460 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html">Add `TerminatorKind::Box` to MIR compiler-team#460</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252033116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252033116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252033116">(Sep 04 2021 at 23:15)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/460">Add <code>TerminatorKind::Box</code> to MIR #460</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="252033655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252033655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252033655">(Sep 04 2021 at 23:24)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="492">@T-compiler</span>: Proposal <a href="https://github.com/rust-lang/compiler-team/issues/460#issuecomment-913053922">#460</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<a name="252060168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252060168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252060168">(Sep 05 2021 at 08:18)</a>:</h4>
<p>Would an alternative be to desugar box syntax to something that returns a <code>Box&lt;MaybeUninit&lt;T&gt;&gt;</code> instead of a <code>Box&lt;T&gt;</code> and once the value is initialized, transmute that to a <code>Box&lt;T&gt;</code>? That should alleviate the deep/shallow distinction. That distinction may be irrelevant anyway, but afaik <span class="user-group-mention" data-user-group-id="810">@WG-unsafe-code-guidelines</span> isn't decided on that yet.</p>



<a name="252084415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252084415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252084415">(Sep 05 2021 at 15:48)</a>:</h4>
<p>The godbolt snippet shows very poor codegen for that</p>



<a name="252084517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252084517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252084517">(Sep 05 2021 at 15:50)</a>:</h4>
<p>Essentially we lack a way of direct initialize a value in place</p>



<a name="252084533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252084533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252084533">(Sep 05 2021 at 15:50)</a>:</h4>
<p>I believe <code>move_val_init</code> once allowed that, but that's removed</p>



<a name="252084671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252084671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252084671">(Sep 05 2021 at 15:52)</a>:</h4>
<p>An alternative would be add a <code>Rvalue::InitBox</code> that casts a pointer (or <code>Box&lt;MaybeUninit&lt;T&gt;&gt;</code>) and converts it to a shallow-initialized <code>Box&lt;T&gt;</code>.</p>



<a name="252088655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252088655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252088655">(Sep 05 2021 at 17:04)</a>:</h4>
<p>I think <code>Box&lt;!&gt;</code> should be invalid, but for inhabited types indeed I am voting for making validity shallow</p>



<a name="252094324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252094324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252094324">(Sep 05 2021 at 18:49)</a>:</h4>
<p>Do we have any actual language invariants around box? If not my belief is that the correct approach is to have allocation and initialization separate. That is have a malloc call and make that raw ptr into a box part separate in the IR.</p>



<a name="252094349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252094349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252094349">(Sep 05 2021 at 18:49)</a>:</h4>
<p>This would in some ways interact with some conceptual &amp;own references better.</p>



<a name="252095202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252095202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252095202">(Sep 05 2021 at 19:03)</a>:</h4>
<p>Boxes can already be moved out anyway, so it isn't much of a stretch to say that <code>box expr</code> moves a value into the box after allocating it empty.</p>



<a name="252102056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252102056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252102056">(Sep 05 2021 at 21:08)</a>:</h4>
<p>Currently we already have a separate allocation and initialization. Box nullary op creates an uninitialized box, and then we construct the value directly into the uninitialized box.</p>



<a name="252102149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252102149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252102149">(Sep 05 2021 at 21:10)</a>:</h4>
<p>So the most straightforward way, as proposed in this MCP, is to make the former step a terminator so it can unwind.</p>



<a name="252102172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252102172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252102172">(Sep 05 2021 at 21:10)</a>:</h4>
<p>I am still experimenting to see if there are other ways that can avoid adding new terminator though</p>



<a name="252150881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252150881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252150881">(Sep 06 2021 at 09:37)</a>:</h4>
<p>just calling Alloc::alloc is equivalent to the terminator, right? Or in other words: what does llvm lower the terminator to?</p>



<a name="252150978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252150978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252150978">(Sep 06 2021 at 09:38)</a>:</h4>
<p>It is lowered to a lang item that is roughly calls <code>GlobalAlloc.alloc</code> I believe.</p>



<a name="252177427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252177427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252177427">(Sep 06 2021 at 13:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252150881">said</a>:</p>
<blockquote>
<p>just calling Alloc::alloc is equivalent to the terminator, right? Or in other words: what does llvm lower the terminator to?</p>
</blockquote>
<p>Right. I don't see a good reason to special case box specifically if <code>box</code> is just a special case of a <code>call</code>. Even if we wanted to we could check if we're calling some specific language item or a trait method or whatever and act accordingly later down the line (in e.g. optimisations) too.</p>



<a name="252177634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252177634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252177634">(Sep 06 2021 at 13:43)</a>:</h4>
<p>(it was a special case in the past too, I guess, but more so in that it had consequences on the graph shape, and it wouldn't with this proposal implemented)</p>



<a name="252203028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252203028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252203028">(Sep 06 2021 at 17:20)</a>:</h4>
<p>Their return place has different types. <code>Box</code> terminator would have a <code>Box&lt;T&gt;</code>, while alloc gives <code>*mut u8</code>. And we couldn't just call a function that returns <code>Box&lt;T&gt;</code> as well; for a <code>_1 = Box;</code> call, the data flow analysis knows that <code>_1</code> is initialized while <code>(*_1)</code> is not. This isn't true for function calls.</p>



<a name="252203103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252203103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252203103">(Sep 06 2021 at 17:20)</a>:</h4>
<p>Drop elaboration needs to know that as well.</p>



<a name="252203306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252203306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252203306">(Sep 06 2021 at 17:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252084671">said</a>:</p>
<blockquote>
<p>An alternative would be add a <code>Rvalue::InitBox</code> that casts a pointer and converts it to a shallow-initialized <code>Box&lt;T&gt;</code>.</p>
</blockquote>
<p>However I have a working prototype of this approach now, and I think it's not bad. <code>InitBox</code> takes a <code>*mut u8</code> operand and converts it into a <code>Box&lt;T&gt;</code>, shallowly initialized. It can mostly reuse the old <code>Rvalue::NullaryOp(NullOp::Box, _)</code> code.</p>



<a name="252204026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252204026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252204026">(Sep 06 2021 at 17:29)</a>:</h4>
<p>Take <code>box f()</code> as an example, previous MIR would be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_1</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="n">bb0</span>: <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="p">(</span><span class="n">ty</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">_1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="k">return</span><span class="w"> </span><span class="n">bb1</span><span class="p">;</span><span class="w"> </span><span class="n">unwind</span><span class="w"> </span><span class="n">bb2</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>now it'll be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_1</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_2</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="n">bb0</span>: <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box_new</span>::<span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="k">return</span><span class="w"> </span><span class="n">bb1</span><span class="p">;</span><span class="w"> </span><span class="n">unwind</span><span class="w"> </span><span class="n">bb2</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">bb1</span>: <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InitBox</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">_2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="k">return</span><span class="w"> </span><span class="n">bb3</span><span class="p">;</span><span class="w"> </span><span class="n">unwind</span><span class="w"> </span><span class="n">bb2</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(where <code>box_new</code> is <code>exchange_malloc</code>, but changed to accept a generic argument instead from taking size and align, which isn't easy to synthesize in MIR because we don't have <code>Rvalue::NullaryOp(NullOp::AlignOf)</code>)</p>



<a name="252204855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252204855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252204855">(Sep 06 2021 at 17:38)</a>:</h4>
<p>The prototype is in PR <a href="https://github.com/rust-lang/rust/issues/88700">#88700</a> now. Can some one gives it a try and perf run?</p>



<a name="252205189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252205189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252205189">(Sep 06 2021 at 17:42)</a>:</h4>
<p>Done</p>



<a name="252245162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252245162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252245162">(Sep 07 2021 at 03:12)</a>:</h4>
<p>Perf run has completed with quite large regression. It seems to me though the issue is largely with the additional monomorphizations of <code>box_new</code>.</p>



<a name="252245471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252245471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252245471">(Sep 07 2021 at 03:18)</a>:</h4>
<p>Here are a few options that I can think of:</p>
<ul>
<li>Go with the <code>TerminatorKind::Box</code> approach, so the backend can still "magically" turn it into an <code>exchange_malloc</code>.</li>
<li>Add a <code>Rvalue::NullaryOp(NullOp::AlignOf, _)</code> so we can generate a MIR call to <code>exchange_malloc</code> easily.</li>
<li>Make <code>box_new</code> an intrinsics, and lower it to <code>exchange_malloc</code> in the backend.</li>
</ul>



<a name="252261951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252261951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252261951">(Sep 07 2021 at 07:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252203028">said</a>:</p>
<blockquote>
<p>Their return place has different types. <code>Box</code> terminator would have a <code>Box&lt;T&gt;</code>, while alloc gives <code>*mut u8</code>. And we couldn't just call a function that returns <code>Box&lt;T&gt;</code> as well; for a <code>_1 = Box;</code> call, the data flow analysis knows that <code>_1</code> is initialized while <code>(*_1)</code> is not. This isn't true for function calls.</p>
</blockquote>
<p>if we desugar box syntax to a call to <code>Alloc::alloc</code> + write to that pointer + <code>Box(ptr, GlobalAlloc)</code> (which is just an <code>Rvalue::Aggregate</code>), then we do not have the initialization order problem, and the fallible part (<code>Alloc::alloc</code>) is now a terminator.</p>



<a name="252301859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252301859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252301859">(Sep 07 2021 at 13:08)</a>:</h4>
<p>Then we need to insert a free on the unwind bb, change Box to contain a raw pointer or make Unique a lang item, and make GlobalAlloc a lang item. It would be bad for codegen as well because it could no longer reuse the drop code.</p>



<a name="252302498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252302498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252302498">(Sep 07 2021 at 13:13)</a>:</h4>
<p>Since boxes can be moved away, drop elaboration needs to handle a shallow initialized box anyway, so I think it's better to keep the current approach in general (as in create a shallow initialized Box and then initialized it).</p>



<a name="252305743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252305743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252305743">(Sep 07 2021 at 13:35)</a>:</h4>
<p>Good point, thanks for elaborating.</p>



<a name="252306092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252306092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252306092">(Sep 07 2021 at 13:37)</a>:</h4>
<p>So... my favourite approach would be</p>



<a name="252306097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252306097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252306097">(Sep 07 2021 at 13:38)</a>:</h4>
<blockquote>
<p>Add a Rvalue::NullaryOp(NullOp::AlignOf, _) so we can generate a MIR call to exchange_malloc easily.</p>
</blockquote>



<a name="252331936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252331936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252331936">(Sep 07 2021 at 16:25)</a>:</h4>
<p>Can I request another perf run of <a href="https://github.com/rust-lang/rust/issues/88700">#88700</a> please?</p>



<a name="252332906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252332906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252332906">(Sep 07 2021 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> It appears to be failing CI at the moment?</p>



<a name="252333060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252333060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252333060">(Sep 07 2021 at 16:33)</a>:</h4>
<p>This is an experimental, so I haven't bothered to fix all the CI issues and bless the tests.</p>



<a name="252333236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252333236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252333236">(Sep 07 2021 at 16:34)</a>:</h4>
<p>launched perf#</p>



<a name="252334431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252334431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252334431">(Sep 07 2021 at 16:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252333060">said</a>:</p>
<blockquote>
<p>This is an experimental, so I haven't bothered to fix all the CI issues and bless the tests.</p>
</blockquote>
<p>Ah, I had assumed that <code>@bors try</code> would fail if CI failed.</p>



<a name="252367373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252367373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252367373">(Sep 07 2021 at 20:29)</a>:</h4>
<p>Perf run completed, mostly neutral in terms of performance, some regression on LLVM time.</p>



<a name="252367562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252367562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252367562">(Sep 07 2021 at 20:30)</a>:</h4>
<p>So I guess add <code>Rvalue::InitBox</code> and <code>Rvalue::NullaryOp(NullOp::AlignOf)</code> would work, there is no need for an extra terminator.</p>



<a name="252367572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252367572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252367572">(Sep 07 2021 at 20:30)</a>:</h4>
<p>Shall I close this MCP and open a new one?</p>



<a name="252368405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252368405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252368405">(Sep 07 2021 at 20:36)</a>:</h4>
<p>BTW, reason for LLVM time regression: with this change <code>invoke</code> is used for <code>exchange_malloc</code> instead of <code>call</code>, so it's now up to LLVM to determine that <code>exchange_malloc</code> won't unwind and optimize <code>invoke</code> back to <code>call</code>.</p>



<a name="252412780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252412780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252412780">(Sep 08 2021 at 06:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252367562">said</a>:</p>
<blockquote>
<p>So I guess add <code>Rvalue::InitBox</code> and <code>Rvalue::NullaryOp(NullOp::AlignOf)</code> would work, there is no need for an extra terminator.</p>
</blockquote>
<p>what do you think about just <code>Rvalue::InitPlace</code>? May be useful for moving deaggregation before elaborate drops</p>



<a name="252412827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252412827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252412827">(Sep 08 2021 at 06:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252367572">said</a>:</p>
<blockquote>
<p>Shall I close this MCP and open a new one?</p>
</blockquote>
<p>nah, just treat it as the new thing <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="252429860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252429860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252429860">(Sep 08 2021 at 09:20)</a>:</h4>
<p>What other type would InitPlace be useful?</p>



<a name="252438172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252438172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252438172">(Sep 08 2021 at 10:39)</a>:</h4>
<p>All Adts. Basically if we transform <code>let x = Struct { a: 42, b: 43};</code> into <code>let x; x.a = 42; x.b = 43;</code>, which is what deaggregation does, we'll need a marker for borrowck and drop elab</p>



<a name="252440836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252440836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252440836">(Sep 08 2021 at 11:05)</a>:</h4>
<p>hold up XD, I think I misunderstood InitBox</p>



<a name="252440884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252440884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252440884">(Sep 08 2021 at 11:05)</a>:</h4>
<p>it's essentially an <code>Rvalue::Use</code>, but allows uninit input?</p>



<a name="252441206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441206">(Sep 08 2021 at 11:08)</a>:</h4>
<p>We could have a sort of <code>StatementKind::MarkInit</code> that doesn't create a new place, but marks an existing one as fully init. Is that equivalent or am I still misunderstanding things?</p>



<a name="252441301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441301">(Sep 08 2021 at 11:09)</a>:</h4>
<p>I think I give it a bad name. InitBox currently converts a *mut u8 to a shallow-initialized Box&lt;T&gt;.</p>



<a name="252441443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441443">(Sep 08 2021 at 11:10)</a>:</h4>
<p>I actually want to just call it Box but due to usage of <code>use Rvalue::*</code> it will cause conflict</p>



<a name="252441457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441457">(Sep 08 2021 at 11:11)</a>:</h4>
<p>heh</p>



<a name="252441504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441504">(Sep 08 2021 at 11:11)</a>:</h4>
<p>so... it's still a Use, but also transmutes XD</p>



<a name="252441517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441517">(Sep 08 2021 at 11:11)</a>:</h4>
<p>Pretty much :)</p>



<a name="252441665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441665">(Sep 08 2021 at 11:12)</a>:</h4>
<p>Essentially I just split the current NullOp::Box into two operations</p>



<a name="252441770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441770">(Sep 08 2021 at 11:13)</a>:</h4>
<p>We've talked before about Use being allowed to transmute. Maybe just add <code>UnOp::Transmute</code>? Not sure if I'm serious, should run it past wg-mir-opt, but feels right to me</p>



<a name="252441873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252441873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252441873">(Sep 08 2021 at 11:14)</a>:</h4>
<p>oh tbh Use could be <code>UnOp::Identity</code></p>



<a name="252442011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442011">(Sep 08 2021 at 11:15)</a>:</h4>
<p>The op is special though because it gets <code>RvalueInitializationState::Shallow</code> rather than <code>Deep</code>.</p>



<a name="252442018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442018">(Sep 08 2021 at 11:15)</a>:</h4>
<p>anyway, just to be entirely clear: is there zero difference in your borrowck and other changes between Use and InitBox, other than the fact that the types don't need to match?</p>



<a name="252442041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442041">(Sep 08 2021 at 11:15)</a>:</h4>
<p>heh, there we go</p>



<a name="252442303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442303">(Sep 08 2021 at 11:17)</a>:</h4>
<p>There was some effort to make transmute a mir primitive IIRC, but don't remember what the outcomes of that were.</p>



<a name="252442318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442318">(Sep 08 2021 at 11:17)</a>:</h4>
<p>Then let's call it <code>ShallowInit</code>?</p>



<a name="252442387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442387">(Sep 08 2021 at 11:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252442303">said</a>:</p>
<blockquote>
<p>There was some effort to make transmute a mir primitive IIRC, but don't remember what the outcomes of that were.</p>
</blockquote>
<p>never implemented, but apparently also irrelevant here, I misunderstood things</p>



<a name="252442476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442476">(Sep 08 2021 at 11:19)</a>:</h4>
<p>Maybe <code>ShallowInitBox</code>? Still want <code>Box</code> to be part of its name.</p>



<a name="252442520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442520">(Sep 08 2021 at 11:19)</a>:</h4>
<p>fine by me, only used for box rn, we can always rename if we figure out a better way</p>



<a name="252442628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442628">(Sep 08 2021 at 11:20)</a>:</h4>
<p>still sad that the Box&lt;Maybeuninit&gt; and transmute thing doesn't optimize as well</p>



<a name="252442664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252442664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252442664">(Sep 08 2021 at 11:20)</a>:</h4>
<p>from the mir perspective that seems like the right thing</p>



<a name="252443158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252443158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252443158">(Sep 08 2021 at 11:25)</a>:</h4>
<p>Perf seems to be quite sensitive to Box, like even just adding a <code>box_new</code> blew the compilation time by extra monomorphizations.</p>



<a name="252443678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252443678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252443678">(Sep 08 2021 at 11:30)</a>:</h4>
<p>one thing you can try out in a separate PR is to add AlignOf and give it a match arm in <a href="https://github.com/rust-lang/rust/blob/434cb437b55d61bcb54a01921de7ac752e6dee13/compiler/rustc_mir/src/transform/lower_intrinsics.rs#L95">https://github.com/rust-lang/rust/blob/434cb437b55d61bcb54a01921de7ac752e6dee13/compiler/rustc_mir/src/transform/lower_intrinsics.rs#L95</a></p>



<a name="252443687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252443687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252443687">(Sep 08 2021 at 11:30)</a>:</h4>
<p>this by itself may affect perf</p>



<a name="252445209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252445209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252445209">(Sep 08 2021 at 11:43)</a>:</h4>
<p>I've included it in the experiment PR already</p>



<a name="252445263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252445263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252445263">(Sep 08 2021 at 11:43)</a>:</h4>
<p>Do you mean try a perf run with just AlignOf?</p>



<a name="252600718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252600718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252600718">(Sep 09 2021 at 10:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252445263">said</a>:</p>
<blockquote>
<p>Do you mean try a perf run with just AlignOf?</p>
</blockquote>
<p>yea, but it's not important, we can do the combined thing</p>



<a name="252600728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252600728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252600728">(Sep 09 2021 at 10:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460/near/252445209">said</a>:</p>
<blockquote>
<p>I've included it in the experiment PR already</p>
</blockquote>
<p>great!</p>



<a name="252866557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/252866557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#252866557">(Sep 10 2021 at 23:59)</a>:</h4>
<p>I filed AlignOf as a separate PR in <a href="https://github.com/rust-lang/rust/issues/88839">#88839</a>.</p>



<a name="253020293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253020293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253020293">(Sep 12 2021 at 23:44)</a>:</h4>
<p>I've written up the new approach in the MCP.</p>



<a name="253612975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253612975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253612975">(Sep 16 2021 at 16:51)</a>:</h4>
<p>So to make sure I understand correctly -- the operational behavior of <code>ShallowInitBox</code> is to simply transmute the ptr from <code>*mut u8</code>  to <code>Box&lt;T&gt;</code>; the only thing that is special is that the type checker treats the contents of the box as not initialized?</p>



<a name="253613518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253613518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253613518">(Sep 16 2021 at 16:54)</a>:</h4>
<p>Yes</p>



<a name="253613780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253613780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253613780">(Sep 16 2021 at 16:56)</a>:</h4>
<p>The current behaviour of <code>NullOp::Box</code> is call <code>exchange_malloc</code> and then transmute the ptr from <code>*mut u8</code> to a shallow-init <code>Box&lt;T&gt;</code>, and the proposal is to split it into an explicit <code>exchange_malloc</code> call and a <code>ShallowInitBox</code> that does the later part.</p>



<a name="253613845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253613845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253613845">(Sep 16 2021 at 16:56)</a>:</h4>
<p>okay. the MCP is not quite clear about what the operator actually <em>does</em> (what do Miri/codegen have to do with it) so I found it rather confusing.</p>



<a name="253615264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253615264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253615264">(Sep 16 2021 at 17:04)</a>:</h4>
<p>Added a line to the MCP to clarify the operational behaviour.</p>



<a name="253637104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20%60TerminatorKind%3A%3ABox%60%20to%20MIR%20compiler-team%23460/near/253637104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20.60TerminatorKind.3A.3ABox.60.20to.20MIR.20compiler-team.23460.html#253637104">(Sep 16 2021 at 19:28)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> thanks, that helps a lot!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>