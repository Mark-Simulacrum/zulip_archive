<html>
<head><meta charset="utf-8"><title>Overhaul interning compiler-team#481 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html">Overhaul interning compiler-team#481</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270787916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270787916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270787916">(Feb 04 2022 at 23:41)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/481">Overhaul interning #481</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="270792833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270792833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270792833">(Feb 05 2022 at 00:48)</a>:</h4>
<p>Some thoughts: "I also think this it's borderline whether this change needs an MCP."</p>
<p>This, nearly by definition, what MCPs are used for. Particularly, changes that "touch a lot of code." There are also MCPs that <em>don't</em> touch a lot of code, but a change that touches a lot of code is precisely one of the things MCPs are for.</p>



<a name="270792860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270792860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Drobnak <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270792860">(Feb 05 2022 at 00:49)</a>:</h4>
<blockquote>
<p>Have a zero-sized private type as a field so you can pattern match an Interned&lt;T&gt; but not construct an Interned&lt;T&gt;.</p>
</blockquote>
<p>This can be done with <code>non_exhaustive</code></p>



<a name="270793057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270793057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270793057">(Feb 05 2022 at 00:52)</a>:</h4>
<p>Second: I overall like this change. Interning is kind of a mess. But, I would push strongly to think carefully about the likely future type library (the one shared with Chalk and maybe others). Particularly, ensuring that changes here honor its goal to be interning-agnostic (so that other platforms e.g. rust-analyzer can utilize the type library without committing to interning)</p>



<a name="270811233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270811233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270811233">(Feb 05 2022 at 07:12)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="492">@T-compiler</span>: Proposal <a href="https://github.com/rust-lang/compiler-team/issues/481#issuecomment-1030567410">#481</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<a name="270811537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270811537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270811537">(Feb 05 2022 at 07:21)</a>:</h4>
<p>I think we're good on the chalk side, as a) it doesn't make anything worse and b) we need to do introduce the generic params at the level before the <code>Interned</code> anyway.</p>



<a name="270817222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270817222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270817222">(Feb 05 2022 at 09:46)</a>:</h4>
<p>The switch from typedefs to newtypes seems like an orthogonal change.</p>



<a name="270817243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270817243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270817243">(Feb 05 2022 at 09:47)</a>:</h4>
<p>I don't see why implementing methods for <code>TyS</code> is an issue.<br>
If we normalize then why not normalize to typedefs instead, seems like a simpler solution.<br>
<code>TyS</code> is the underlying data, <code>Interned&lt;TyS&gt;</code> is the reference to it, newtype around <code>Interned&lt;TyS&gt;</code> is ???</p>



<a name="270913516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270913516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270913516">(Feb 06 2022 at 21:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Overhaul.20interning.20compiler-team.23481/near/270792833">said</a>:</p>
<blockquote>
<p>Some thoughts: "I also think this it's borderline whether this change needs an MCP."</p>
</blockquote>
<p>The <a href="https://forge.rust-lang.org/compiler/mcp.html">MCP docs</a> say:</p>
<blockquote>
<p>What constitutes a major change?</p>
<p>The rough intuition is "something that would require updates to the rustc-dev-guide or the rustc book". In other words:</p>
<ul>
<li>Something that alters the architecture of some part(s) of the compiler, since this is what the rustc-dev-guide aims to document.</li>
<li>A simple change that affects a lot of people, such as altering the names of very common types or changing coding conventions.</li>
<li>Adding a compiler flag or other public facing changes, which should be documented (ultimately) in the rustc book. This is only appropriate for "minor" tweaks, however, and not major things that may impact a lot of users. (Also, public facing changes will require a full FCP before landing on stable, but an MCP can be a good way to propose the idea.)</li>
</ul>
<p>Note that, in some cases, the change may be deemed too big and a full FCP or RFC may be required to move forward. This could occur with significant public facing change or with sufficiently large changes to the architecture. The compiler team leads can make this call.</p>
</blockquote>
<p>This change doesn't alter the architecture of the compiler. It doesn't add any public facing changes. It's arguable whether it's a change that "affects a lot of people". If "it touches a lot of code" is a criterion for MCPs, then that should be added to the the docs.</p>



<a name="270913527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270913527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270913527">(Feb 06 2022 at 21:43)</a>:</h4>
<p>Anyway, it clearly doesn't rise to the level of needing a full RFC, for example.</p>



<a name="270914180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270914180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270914180">(Feb 06 2022 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> this change is all about how these interned types are represented, so the choice of newtype vs typedef is not orthogonal, it's utterly integral.</p>
<p>In the PR, <code>Ty</code> is</p>
<div class="codehilite"><pre><span></span><code>pub struct Ty&lt;&#39;tcx&gt;(Interned&lt;&#39;tcx, TyS&lt;&#39;tcx&gt;&gt;);
</code></pre></div>
<p>If it was instead:</p>
<div class="codehilite"><pre><span></span><code>pub type Ty&lt;&#39;tcx&gt; = Interned&lt;&#39;tcx, TyS&lt;&#39;tcx&gt;&gt;;
</code></pre></div>
<p>then we can't do an inherent <code>impl</code> on <code>Ty</code>, because <code>Interned</code> is from a different crate. You asked:</p>
<blockquote>
<p>I don't see why implementing methods for TyS is an issue.</p>
</blockquote>
<p>I view <code>TyS</code> as an implementation detail and something that should be used as little as possible. <code>Ty</code> is the widely-used type, it's the interned type,  and <code>TyS</code> is not used directly at all. So IMO defining methods on <code>TyS</code> is confusing and might cause people to use <code>TyS</code> values without interning them, which would be bad.</p>



<a name="270914439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270914439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270914439">(Feb 06 2022 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218805">Mark Drobnak</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Overhaul.20interning.20compiler-team.23481/near/270792860">said</a>:</p>
<blockquote>
<blockquote>
<p>Have a zero-sized private type as a field so you can pattern match an Interned&lt;T&gt; but not construct an Interned&lt;T&gt;.</p>
</blockquote>
<p>This can be done with <code>non_exhaustive</code></p>
</blockquote>
<p>Yes. With a private field patterns look like <code>Interned(v, _)</code>, with <code>non_exhaustive</code> they look like <code>Interned(v, ..)</code>. I prefer the former because (a) it's one char shorter, (b) it's clear that there is only one additional field, rather than an unspecified number of possible additional fields.</p>



<a name="270915884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270915884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270915884">(Feb 06 2022 at 22:36)</a>:</h4>
<p>non_exhaustive is also crate-visible essentially, whereas a private struct is truly private if you want it to be.</p>



<a name="270949232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949232">(Feb 07 2022 at 09:03)</a>:</h4>
<p>As stated elsewhere I am very much in favor of this change. The MCP lays out nicely that interning should be done in a unified fashion and that the current approach makes it easy to get things accidentally wrong. And working with the current infrastructure is just plain stressful and annoying because one always things that there's a reason why there are X special cases, when in fact there is no real reason.</p>
<blockquote>
<p>I also think this it's borderline whether this change needs an MCP.</p>
</blockquote>
<p>I think MCPs are a means of communications as much as they are for decision making. I think this is a change that almost anyone working on the compiler will want to have heard about beforehand. They are also good for PR authors because it should give them some piece of mind that the change will go through (as opposed to somebody bringing up a major objection after the fact).</p>
<blockquote>
<p>If "it touches a lot of code" is a criterion for MCPs, then that should be added to the the docs.</p>
</blockquote>
<p>That sounds like a good idea. Also, ideally we can make MCPs lightweight enough that filing one isn't a big deal.</p>



<a name="270949505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949505">(Feb 07 2022 at 09:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Overhaul.20interning.20compiler-team.23481/near/270914180">said</a>:</p>
<blockquote>
<p>I view <code>TyS</code> as an implementation detail and something that should be used as little as possible. <code>Ty</code> is the widely-used type, it's the interned type,  and <code>TyS</code> is not used directly at all. So IMO defining methods on <code>TyS</code> is confusing and might cause people to use <code>TyS</code> values without interning them, which would be bad.</p>
</blockquote>
<p>I agree with this reasoning.</p>



<a name="270949760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949760">(Feb 07 2022 at 09:08)</a>:</h4>
<p>By the way, <span class="user-group-mention" data-user-group-id="2943">@T-infra</span>, we should be able to lock the tree for a bit in order to make it simpler to merge this change (once all the basics are in place), right? No reason to make this unnecessarily hard for <span class="user-mention silent" data-user-id="120989">nnethercote</span>.</p>



<a name="270949892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949892">(Feb 07 2022 at 09:10)</a>:</h4>
<p>I'm not opposed, but how long are we talking about?</p>



<a name="270949971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949971">(Feb 07 2022 at 09:11)</a>:</h4>
<p>if it's just close the tree, spend a couple hours (dunno how long) fixing the latest conflicts and then land that PR it's great, we practically keep the tree closed just for those couple hours</p>



<a name="270949981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949981">(Feb 07 2022 at 09:11)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> would know best how much time he needs, but I suspect not more than a few hours.</p>



<a name="270949998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949998">(Feb 07 2022 at 09:11)</a>:</h4>
<p>yeah, that sounds about right</p>



<a name="270949999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270949999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270949999">(Feb 07 2022 at 09:11)</a>:</h4>
<p>if it's in the order of days or something the queue might not be happy <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="270950085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270950085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270950085">(Feb 07 2022 at 09:12)</a>:</h4>
<p>in the past when we did similar changes (like reformat the world or moving directories) we did it close to dec 25th to minimize the chance of disruption, but it's a bit far <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="270956654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/270956654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#270956654">(Feb 07 2022 at 10:13)</a>:</h4>
<p>Weekends are a little less busy than mo-fr</p>



<a name="271035420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/271035420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#271035420">(Feb 07 2022 at 20:11)</a>:</h4>
<p>I don't think the conflicts will be bad. Closing the tree seems unlikely to be necessary, just setting the priority to 1 would be fine, I think</p>



<a name="272226259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Overhaul%20interning%20compiler-team%23481/near/272226259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Overhaul.20interning.20compiler-team.23481.html#272226259">(Feb 17 2022 at 08:21)</a>:</h4>
<p>This proposal has been accepted: <a href="https://github.com/rust-lang/compiler-team/issues/481">#481</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>