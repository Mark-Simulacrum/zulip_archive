<html>
<head><meta charset="utf-8"><title>Add attribute to run specific tests in an… compiler-team#508 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html">Add attribute to run specific tests in an… compiler-team#508</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278646991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278646991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278646991">(Apr 12 2022 at 04:24)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/508">Add attribute to run specific tests in an isolated process #508</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="278648285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278648285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278648285">(Apr 12 2022 at 04:54)</a>:</h4>
<p>It's not really clear if this would be something that would be a compiler-team decision.  Generally the lang team weighs in on attributes, and the libs team is responsible for libtest. </p>
<p>One very minor side concern is adding many different attributes for <code>#[test]</code> could result in a large soup attributes that could be applied to a test.  One alternative is to attach options to the test attribute itself like <code>#[test(spawn_process)]</code>, and more options could be added in the future. I'm not sure if that's really better, but something to consider.</p>



<a name="278648461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278648461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278648461">(Apr 12 2022 at 04:58)</a>:</h4>
<p>i am 0 for 2 on picking the right place to file my MCPs <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="278648815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278648815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278648815">(Apr 12 2022 at 05:05)</a>:</h4>
<p>I believe there is an issue open where <code>-Zpanic-abort-tests</code> deadlocks in certain cases. Haven't personally seen this though.</p>



<a name="278649362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278649362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278649362">(Apr 12 2022 at 05:18)</a>:</h4>
<p>is this issue the one? <a href="https://github.com/rust-lang/rust/issues/68936">https://github.com/rust-lang/rust/issues/68936</a></p>



<a name="278650503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278650503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278650503">(Apr 12 2022 at 05:44)</a>:</h4>
<p>This feature could be helpful for my <code>dhat</code> crate. It has a feature called "heap usage testing" that lets you write tests that ensure that code snippets do the expected number of allocations. Because the heap is global, there's a whole bunch of caveats about how to write these tests so they don't interfere with each other or the test harness: <a href="https://docs.rs/dhat/latest/dhat/#heap-usage-testing">https://docs.rs/dhat/latest/dhat/#heap-usage-testing</a></p>



<a name="278673360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278673360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278673360">(Apr 12 2022 at 10:22)</a>:</h4>
<p>It would also be useful for various other std tests, e.g. testing fork, chdir and similar things. Currently some of those tests are implemented as UI tests instead which means one has to build a stage 1 compiler to run them.</p>



<a name="278695373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278695373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278695373">(Apr 12 2022 at 13:52)</a>:</h4>
<p>thanks! i'm adding the additional motivations to the MCP</p>



<a name="278700594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278700594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278700594">(Apr 12 2022 at 14:29)</a>:</h4>
<p>i like the idea of <code>#[test(spawn_process)]</code> instead of <code>#[spawn_process]</code>, but does anyone have thoughts on the name btw?</p>
<p>without framing things in terms of just <code>set_var</code>, the idea is to have a <code>#[test]</code> behave as a <code>fn main()</code> entry point in a pristine process</p>
<p><code>#[test(isolated)]</code>, <code>#[test(isolated_process)]</code>,  <code>#[test(main)]</code>, <code>#[test(main_in_process)]</code>... ?</p>



<a name="278702252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278702252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278702252">(Apr 12 2022 at 14:40)</a>:</h4>
<p>"spawn_process" seems most accurate to me, "isolated" implies it's sandboxed which isn't true, and <code>main</code> seems ambiguous</p>



<a name="278702353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278702353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278702353">(Apr 12 2022 at 14:41)</a>:</h4>
<p>One concern I have here is Miri compatibility. Miri probably won't be able to run these tests in a separate process. It also already makes the test runner single-threaded.</p>



<a name="278702532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278702532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278702532">(Apr 12 2022 at 14:42)</a>:</h4>
<p>I understand you are worried about background threads, but is that really something this API needs to defend against? also note that Rust stdlib still does locking, so only background threads that call C operations <em>after</em> the test they belong to is done are a problem. that seems like a bad idea anyway?</p>



<a name="278703275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278703275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278703275">(Apr 12 2022 at 14:47)</a>:</h4>
<p>it's possible that just running specific tests single threaded is good enough for my use case, i think that means i'd need to make a crate wide claim about every test in the crate in my <code>// SAFETY</code> comment before calling <code>set_var</code> though</p>



<a name="278703630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278703630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278703630">(Apr 12 2022 at 14:50)</a>:</h4>
<p>something like <code>// SAFETY: this test runs single threaded, and no other previously run test in this crate is misbehaved and still reading or writing the environment</code></p>



<a name="278703689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278703689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278703689">(Apr 12 2022 at 14:50)</a>:</h4>
<p>although now i wonder if my safety comments should call it the "OS" environment or something, since as you say rust still has all the locking</p>



<a name="278703927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278703927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278703927">(Apr 12 2022 at 14:52)</a>:</h4>
<p>FWIW I am not sure if Rust doing locking is guaranteed</p>



<a name="278703967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278703967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278703967">(Apr 12 2022 at 14:52)</a>:</h4>
<p>it <em>does</em> cause trouble around <code>fork</code>...</p>



<a name="278703985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278703985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278703985">(Apr 12 2022 at 14:52)</a>:</h4>
<p>not sure which plans the libs-api team has there</p>



<a name="278704169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704169">(Apr 12 2022 at 14:53)</a>:</h4>
<p>(also this is exactly why I think we should have a Rust-only 'shadow environment' that is safe to read and write. that would cover the needs of most test suites, I think. sure, you'd still want single-threaded tests for stuff like <code>chdir</code>, but it wouldnt be a soundness concern any more.)</p>



<a name="278704502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704502">(Apr 12 2022 at 14:55)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> that seems very confusing if you're doing ffi</p>



<a name="278704626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704626">(Apr 12 2022 at 14:56)</a>:</h4>
<p>libstd doesn't know when you call another language, so you'd see a different environment in rust than everywhere else</p>



<a name="278704669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704669">(Apr 12 2022 at 14:56)</a>:</h4>
<p>Ideally libc would make set_env thread safe but that's probably a lost cause :(</p>



<a name="278704799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704799">(Apr 12 2022 at 14:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278704502">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> that seems very confusing if you're doing ffi</p>
</blockquote>
<p>yeah. I view this as an API design issue -- <code>env::set_for_rust_only</code>, or so.</p>



<a name="278704870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704870">(Apr 12 2022 at 14:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278704669">said</a>:</p>
<blockquote>
<p>Ideally libc would make set_env thread safe but that's probably a lost cause :(</p>
</blockquote>
<p>That's not actually possible unfortunately. <code>putenv</code> exists</p>



<a name="278704983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278704983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278704983">(Apr 12 2022 at 14:58)</a>:</h4>
<p>Oh! Why don't we just use that in libstd?</p>



<a name="278705112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278705112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278705112">(Apr 12 2022 at 14:59)</a>:</h4>
<p>Wait no that's still thread unsafe, I don't understand why it's relevant</p>



<a name="278705192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278705192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278705192">(Apr 12 2022 at 15:00)</a>:</h4>
<p>Where do you mean? <code>putenv</code> isn't the solution here, it's the source of the problems. It meanst that even libc proper (ie glibc) couldn't synchronize its way out of thread unsafety</p>



<a name="278705197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278705197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278705197">(Apr 12 2022 at 15:00)</a>:</h4>
<p>new api, would <code>set_for_rust_only</code> have to be limited to strings? <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="278705920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278705920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278705920">(Apr 12 2022 at 15:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278705192">said</a>:</p>
<blockquote>
<p>Where do you mean? <code>putenv</code> isn't the solution here, it's the source of the problems. It meanst that even libc proper (ie glibc) couldn't synchronize its way out of thread unsafety</p>
</blockquote>
<p>I don't see how this follows, sorry. <code>putenv</code> is just an API glibc offers, it could also be synchronized internally if glibc wanted it to be.</p>



<a name="278706080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278706080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278706080">(Apr 12 2022 at 15:04)</a>:</h4>
<p>for miri, the idea behind the attribute is that the test always runs in a "pristine" fashion.... is there any global state in miri that could leak between tests even if these <code>spawn_process</code> tests weren't actually run in a new process there?</p>



<a name="278706201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278706201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278706201">(Apr 12 2022 at 15:05)</a>:</h4>
<p>like i don't know if miri actually changes its real process environment on these calls, or just "interprets" that</p>



<a name="278706330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278706330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278706330">(Apr 12 2022 at 15:06)</a>:</h4>
<p>(i gotta head out for a few hours, later)</p>



<a name="278706915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278706915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278706915">(Apr 12 2022 at 15:10)</a>:</h4>
<blockquote>
<p>i like the idea of #[test(spawn_process)] instead of #[spawn_process], but does anyone have thoughts on the name btw?</p>
</blockquote>
<p>FWIW, I wouldn't jump on my suggestion too fast, it was just a random idea.  Attributes are more flexible because you can do things like <code>cfg_attr</code>, and are more consistent with the existing should_panic and ignore attributes.  I think there are pros and cons either way, and I'm not sure how to balance them.</p>



<a name="278707181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278707181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278707181">(Apr 12 2022 at 15:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278706080">said</a>:</p>
<blockquote>
<p>for miri, the idea behind the attribute is that the test always runs in a "pristine" fashion.... is there any global state in miri that could leak between tests even if these <code>spawn_process</code> tests weren't actually run in a new process there?</p>
</blockquote>
<p>miri has the same global state that a regular program does (just some of it managed via its own copies, but that is not a difference the program can even tell)</p>



<a name="278707202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278707202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278707202">(Apr 12 2022 at 15:11)</a>:</h4>
<p>so, e.g. env vars and the working dir are all global</p>



<a name="278707225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278707225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278707225">(Apr 12 2022 at 15:12)</a>:</h4>
<p>if they werent, that would not faithfully implement the real APIs ;)</p>



<a name="278708385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278708385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278708385">(Apr 12 2022 at 15:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278705920">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278705192">said</a>:</p>
<blockquote>
<p>Where do you mean? <code>putenv</code> isn't the solution here, it's the source of the problems. It meanst that even libc proper (ie glibc) couldn't synchronize its way out of thread unsafety</p>
</blockquote>
<p>I don't see how this follows, sorry. <code>putenv</code> is just an API glibc offers, it could also be synchronized internally if glibc wanted it to be.</p>
</blockquote>
<p>Even if glibc puts a global lock around all calls to <code>putenv</code>, <code>setenv</code>, and <code>getenv</code> that's still not enough. The problem is that subsequent writes to the pointer passed into <code>putenv</code> need to be visible. Meaning that I can do:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="c1">// Thread 1</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_string</span><span class="p">(</span><span class="s">"a=b"</span><span class="p">);</span><span class="w"></span>
<span class="n">putenv</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'c'</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Thread 2</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getenv</span><span class="p">(</span><span class="s">"a"</span><span class="p">);</span><span class="w"></span>
<span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<p>There's no way for libc to prevent the last statements in each thread from racing</p>



<a name="278708593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278708593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278708593">(Apr 12 2022 at 15:21)</a>:</h4>
<p>why is the write to <code>buf[2]</code> visible ?? I would expect putenv to copy the buffer :(</p>



<a name="278708725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278708725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278708725">(Apr 12 2022 at 15:22)</a>:</h4>
<p>Unfortunately, the spec requires otherwise</p>
<blockquote>
<p>The string pointed to by string becomes part of the environment, so altering the string changes the environment.</p>
</blockquote>
<p><a href="https://www.man7.org/linux/man-pages/man3/putenv.3.html">https://www.man7.org/linux/man-pages/man3/putenv.3.html</a></p>



<a name="278715328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278715328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278715328">(Apr 12 2022 at 16:11)</a>:</h4>
<p>well if we break libc anyway we might also break that.^^</p>



<a name="278715357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278715357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278715357">(Apr 12 2022 at 16:11)</a>:</h4>
<p>but this is wearing wildly off-topic for this discussion on the test harness</p>



<a name="278734979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278734979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278734979">(Apr 12 2022 at 18:38)</a>:</h4>
<p>i did just confirm (for my own sanity), that this does pass in miri:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">,</span><span class="w"> </span><span class="s">"test"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">),</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="s">"test"</span><span class="p">.</span><span class="n">to_owned</span><span class="p">()));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">),</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="s">"test"</span><span class="p">.</span><span class="n">to_owned</span><span class="p">()));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>i was thinking there might be perfectly emulated global state, but that it might get thrown away between each test</p>
<p>so miri would have to support the new attribute (or ignore the test), were we to add it</p>
<p>i realize who i'm talking to, but i just had to try things out myself <span aria-label="nerd" class="emoji emoji-1f913" role="img" title="nerd">:nerd:</span></p>



<a name="278735232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278735232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278735232">(Apr 12 2022 at 18:40)</a>:</h4>
<p>(random aside, it'd be cool if rust playground had miri test)</p>



<a name="278737221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278737221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278737221">(Apr 12 2022 at 18:56)</a>:</h4>
<p>Miri doesn't even know what a "test" is</p>



<a name="278737256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278737256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278737256">(Apr 12 2022 at 18:56)</a>:</h4>
<p>it just creates a binary with the libtest harness the exact way rustc does</p>



<a name="278737296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278737296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278737296">(Apr 12 2022 at 18:57)</a>:</h4>
<p>except that it stops after having generated all the MIR, and then interprets that. but there's a single <code>main</code> function at this point that it interprets just like <code>cargo miri run</code>.</p>



<a name="278737329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278737329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278737329">(Apr 12 2022 at 18:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508/near/278735232">said</a>:</p>
<blockquote>
<p>(random aside, it'd be cool if rust playground had miri test)</p>
</blockquote>
<p>there's no <code>cargo test</code> on the playground either. <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="278737537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278737537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278737537">(Apr 12 2022 at 18:58)</a>:</h4>
<blockquote>
<p>so miri would have to support the new attribute (or ignore the test), were we to add it</p>
</blockquote>
<p>well, its implementation could use <code>cfg(miri)</code> to do <em>something</em> special. not sure what though... spawning a separate process seems like an unlikely solution for miri.</p>



<a name="278739242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278739242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278739242">(Apr 12 2022 at 19:10)</a>:</h4>
<p>i wonder if instead of spawning processes, we wrote out multiple binaries instead?</p>
<p>so we'd generate the test harness that runs most of the tests, and then a bunch of individual test harnesses, one each for each spawned test (or for each panic abort test)</p>
<p>that would essentially push the knowledge of tests into miri though, in that it'd have to know to run multiple binaries</p>
<p>plus there'd be a bunch of other complications with having multiple binaries to run...</p>
<p>just thinking out loud here</p>



<a name="278741945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278741945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278741945">(Apr 12 2022 at 19:28)</a>:</h4>
<p>another thought... could miri ever support a cheat where it launched an instance of itself? miri can already run the test harness anyway, and the spawned test process is just executing the exact same binary with a different set of command line arguments</p>
<p>since you wouldn't be launching some arbitrary process in this case, i don't know if that makes the idea remotely feasible... i'm way out of my depth here</p>



<a name="278742346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278742346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278742346">(Apr 12 2022 at 19:32)</a>:</h4>
<p>both of these ideas feel like they'd be <em>incredibly</em> complicated though</p>



<a name="278742769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278742769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278742769">(Apr 12 2022 at 19:35)</a>:</h4>
<p>/me is imagining miri trying to verify that fork / vfork are sound</p>



<a name="278742935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278742935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278742935">(Apr 12 2022 at 19:37)</a>:</h4>
<p>for just <code>set_var</code> specifically, you could <code>#[cfg_attr(not(miri), spawn_process]</code> too</p>
<p>as in, don't bother with spawn_process in miri where there's no soundness issue with <code>set_var</code> anyway</p>



<a name="278743108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278743108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278743108">(Apr 12 2022 at 19:38)</a>:</h4>
<p>i don't know if miri actually has a <code>cfg</code> flag or not :)</p>



<a name="278743436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278743436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278743436">(Apr 12 2022 at 19:41)</a>:</h4>
<p>and then i just copy+paste this a million times or so in the code <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// SAFETY: we're either single threaded in main() due to #[spawn_process],</span>
<span class="c1">//         or in cfg!(miri) where set_var is always sound</span>
</code></pre></div>



<a name="278743659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20attribute%20to%20run%20specific%20tests%20in%20an%E2%80%A6%20compiler-team%23508/near/278743659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20attribute.20to.20run.20specific.20tests.20in.20an.E2.80.A6.20compiler-team.23508.html#278743659">(Apr 12 2022 at 19:43)</a>:</h4>
<p>(if <code>#[deprecated_safe]</code> lands, i feel like future coders are gonna hate me when they deal with an unsafe env... <span aria-label="cold sweat" class="emoji emoji-1f630" role="img" title="cold sweat">:cold_sweat:</span>)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>