<html>
<head><meta charset="utf-8"><title>Introduce a new linter for diagnostic mee… compiler-team#478 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html">Introduce a new linter for diagnostic mee… compiler-team#478</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266659090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266659090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266659090">(Jan 03 2022 at 07:55)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/478">Introduce a new linter for diagnostic meesages #478</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="266659591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266659591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hirochika Matsumoto <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266659591">(Jan 03 2022 at 08:04)</a>:</h4>
<p>Hi, the author here. I'll answer a question I've got before writing this MCP here.</p>
<blockquote>
<p>Why not implement the proposed linter by adding rules to rustc internal lints?</p>
</blockquote>
<p>It is because the targets of the linter are not the Rust code that implements diagnostics, but the JSON output of the compiler in the middle of UI tests. Existing lints are for Rust files, so we need to create a new one for the JSON files.</p>



<a name="266673159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266673159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266673159">(Jan 03 2022 at 10:52)</a>:</h4>
<p>I wonder if we could do this checking in tidy that just scans all <code>.stderr</code> files.</p>



<a name="266673670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266673670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266673670">(Jan 03 2022 at 10:58)</a>:</h4>
<p>We could dump the diagnostics as json (but not commit them) and run a pass on them that checks for such inconsistencies. cc <span class="user-group-mention" data-user-group-id="1187">@WG-diagnostics</span></p>



<a name="266700975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266700975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hirochika Matsumoto <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266700975">(Jan 03 2022 at 15:49)</a>:</h4>
<p>It should feasible but we need to implement a parser that re-reads a diagnostic from <code>.stderr</code> files, and I think that hardly pays off ;)</p>



<a name="266701186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266701186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hirochika Matsumoto <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266701186">(Jan 03 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478/near/266673159">said</a>:</p>
<blockquote>
<p>I wonder if we could do this checking in tidy that just scans all <code>.stderr</code> files.</p>
</blockquote>
<p>It should feasible but we need to implement a parser that reconstructs a diagnostic from <code>.stderr</code> files, and I think that hardly pays off ;)</p>



<a name="266706048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266706048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266706048">(Jan 03 2022 at 16:33)</a>:</h4>
<p>If the goal is linting diagnostic messages specifically emitted in UI tests, then integrating that linter into compiletest should give you access to the JSON structures without needing to dump to disk -- dumping to disk would likely be somewhat painful to structure well.</p>



<a name="266706339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/266706339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#266706339">(Jan 03 2022 at 16:36)</a>:</h4>
<p>My recollection from <a href="https://github.com/rust-lang/rust/pull/89455">https://github.com/rust-lang/rust/pull/89455</a> is that one of the major points of concern was the out-of-tree lints in that proposal -- this MCP is rather bare on details, but is that still the expectation? I remain concerned about the maintenance overhead of such a solution.</p>



<a name="267071868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/267071868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hirochika Matsumoto <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#267071868">(Jan 06 2022 at 15:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478/near/266706339">said</a>:</p>
<blockquote>
<p>My recollection from <a href="https://github.com/rust-lang/rust/pull/89455">https://github.com/rust-lang/rust/pull/89455</a> is that one of the major points of concern was the out-of-tree lints in that proposal -- this MCP is rather bare on details, but is that still the expectation? I remain concerned about the maintenance overhead of such a solution.</p>
</blockquote>
<p>Yes, the idea of introducing an out-of-tree lint has not changed. But I don't think the maintenance burden is substantial as well as that of clippy or internal lints. For the two reasons below, I reckon I can maintain the lint by myself.</p>
<ul>
<li>The proposed lint is not dependent on the rustc code. This means that weekly or biweekly sync is not needed.</li>
<li>The lint is not going to have many rules implemented. I've added lints accordingly to <a href="https://rustc-dev-guide.rust-lang.org/diagnostics.html#diagnostic-output-style-guide">the diagnostic output style guide</a> which has 10 rules, so people barely send a patch to review.</li>
</ul>



<a name="267072692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/267072692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hirochika Matsumoto <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#267072692">(Jan 06 2022 at 15:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478/near/266706048">said</a>:</p>
<blockquote>
<p>If the goal is linting diagnostic messages specifically emitted in UI tests, then integrating that linter into compiletest should give you access to the JSON structures without needing to dump to disk -- dumping to disk would likely be somewhat painful to structure well.</p>
</blockquote>
<p>Yes, that is what I did in <a href="https://github.com/rust-lang/rust/issues/89455">#89455</a>! The changes of the PR are happening only to compiletest (do note that I removed diagnostic message fixes to make the PR easier to review), and I am very happy about that.</p>



<a name="267520220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/267520220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#267520220">(Jan 11 2022 at 00:08)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="492">@T-compiler</span>: Proposal <a href="https://github.com/rust-lang/compiler-team/issues/478#issuecomment-1009473133">#478</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<a name="268119903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/268119903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hirochika Matsumoto <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#268119903">(Jan 15 2022 at 11:01)</a>:</h4>
<p>How about we start by adding a script to CI that does the following, and then switch to the approach of adding <code>diaglint</code> to compiletest as a dependency once (after a certain time) the interested parties agree <code>diaglint</code> works well enough to do so? <span class="user-mention" data-user-id="119031">@Esteban Küber</span>  <span class="user-mention" data-user-id="116122">@simulacrum</span> </p>
<p>The script does:</p>
<ul>
<li>For each<code>.stderr</code> file in <code>src/test</code><ul>
<li>Extract diagnostic messages and lint them</li>
</ul>
</li>
</ul>
<p>I earlier said extracting messages is a hard job, but given most message has a prefix like <code>note: </code> it won't be that hard.</p>



<a name="268140991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/268140991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#268140991">(Jan 15 2022 at 19:00)</a>:</h4>
<p>Maybe this has already been mentioned, but isn't it an issue to use a third-party linter if we decide to change our diagnostic style guide?</p>



<a name="268193433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/268193433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#268193433">(Jan 16 2022 at 16:18)</a>:</h4>
<p>I remain relatively skeptical of the external crate as a linter, it doesn't feel like it adds much value and does add overhead.</p>
<p>Regardless, I don't think we should be <em>extracting</em> messages from stderr files -- we generate those from the JSON rustc emits, and we can lint on that, not re-parsing into a similar form.</p>



<a name="268890896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Introduce%20a%20new%20linter%20for%20diagnostic%20mee%E2%80%A6%20compiler-team%23478/near/268890896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478.html#268890896">(Jan 21 2022 at 19:23)</a>:</h4>
<p>This proposal has been accepted: <a href="https://github.com/rust-lang/compiler-team/issues/478">#478</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>