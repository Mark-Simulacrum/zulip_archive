<html>
<head><meta charset="utf-8"><title>Add the `-Z randomize-layout` flag compiler-team#457 · t-compiler/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/index.html">t-compiler/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html">Add the `-Z randomize-layout` flag compiler-team#457</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250825263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250825263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250825263">(Aug 26 2021 at 19:21)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/compiler-team/issues/457">Add the <code>-Z randomize-layout</code> flag #457</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="250826052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250826052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250826052">(Aug 26 2021 at 19:27)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="492">@T-compiler</span>: Proposal <a href="https://github.com/rust-lang/compiler-team/issues/457#issuecomment-906682593">#457</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<a name="250850793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250850793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250850793">(Aug 26 2021 at 22:29)</a>:</h4>
<p>Sounds great <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="250857262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250857262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250857262">(Aug 26 2021 at 23:35)</a>:</h4>
<p>Firefox has "chaos mode": <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=955888">https://bugzilla.mozilla.org/show_bug.cgi?id=955888</a></p>



<a name="250857299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250857299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250857299">(Aug 26 2021 at 23:35)</a>:</h4>
<p>The advantage of calling it <code>-Z chaos-mode</code></p>
<ul>
<li>Precedent</li>
<li>Sounds cool</li>
<li>Generic name makes it easy to add other things later, if you ant</li>
</ul>



<a name="250861173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250861173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250861173">(Aug 27 2021 at 00:29)</a>:</h4>
<p>If we are bikeshedding names, I actually had designs for a similar flag in the rust frontend for lccc, but named it <code>-Z repr-rust-layout=randomize</code>. I did this for a couple reasons, </p>
<ol>
<li>It makes it clear that the layout being randomized is repr(Rust) types</li>
<li>It allows for other possible values in the future. In my case, the flag also accepts c, to s/repr(Rust)/repr(C)/ internally, and abi, to use the ABI that the frontend defines (which is the default mode if the flag isn't specified). It is possible that rustc could also, eventually, add other version of <code>-Z repr-rust-layout</code> as well</li>
</ol>



<a name="250873784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/250873784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#250873784">(Aug 27 2021 at 02:31)</a>:</h4>
<p>I'm also a fan of the word <code>nondeterministic</code> if we're talking about naming</p>
<blockquote>
<p>... randomizes/shuffles/otherwise makes unpredictable the layout ...</p>
</blockquote>
<p>This exactly matches what I would expect when reading <code>nondeterministic</code> and I think makes it more clear that <em>any</em> layout could be chosen for any reason, especially if there is an attempt to make this mode maximally unintuitive/maximally inconvenient to further expand the reach of the flag.  On the other hand <code>random</code> makes me think simply shuffling and no more, but has merit to being simpler.</p>



<a name="251524318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/251524318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#251524318">(Sep 01 2021 at 08:49)</a>:</h4>
<p>I would actually love for it to be random but deterministic. For instance, determined by the hash of source code files, or similar. That would make it effectively random and unpredictable, but yet always the same for a given build, preserving reproducibility.</p>



<a name="251524630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/251524630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#251524630">(Sep 01 2021 at 08:51)</a>:</h4>
<p>that sounds like it will blame the poor PR author who adds a doc comment and breaks the build</p>



<a name="251524845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/251524845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#251524845">(Sep 01 2021 at 08:53)</a>:</h4>
<p>and you will be able to confirm that removing the doc comment will fix the build again, so clearly the doc comment is to blame</p>



<a name="251525338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/251525338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#251525338">(Sep 01 2021 at 08:57)</a>:</h4>
<p>I still think it would be nice to have randomization and reproducibility be compatible.</p>



<a name="251525861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/251525861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#251525861">(Sep 01 2021 at 09:01)</a>:</h4>
<p>If something like that is run in CI, the random seed should be provided by the CI runner or printed out in some way that makes it clear that the culprit is a particular random seed and not whatever the last commit did</p>



<a name="252600603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/252600603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#252600603">(Sep 09 2021 at 10:05)</a>:</h4>
<p>This proposal has been accepted: <a href="https://github.com/rust-lang/compiler-team/issues/457">#457</a>.</p>



<a name="255636494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/233931-t-compiler/major%20changes/topic/Add%20the%20%60-Z%20randomize-layout%60%20flag%20compiler-team%23457/near/255636494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/233931-t-compiler/major-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457.html#255636494">(Sep 30 2021 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Add.20the.20.60-Z.20randomize-layout.60.20flag.20compiler-team.23457/near/251524318">said</a>:</p>
<blockquote>
<p>I would actually love for it to be random but deterministic. For instance, determined by the hash of source code files, or similar. That would make it effectively random and unpredictable, but yet always the same for a given build, preserving reproducibility.</p>
</blockquote>
<p>the current implementation (<a href="https://github.com/rust-lang/rust/issues/87868">#87868</a>) keys it on the same thing that incremental, symbol names, and <code>TypeId</code>, all use for a "stable identity" (specifically, for the definition of the type. if it's generic, all instances use the same order. also, the defining crate's <code>-Z</code> flag is used, not the current one, to allow mixed builds)</p>
<p>so the main thing it will detect is a copy-paste of the same type <em>definition</em> - it's not guaranteed to have the same field order (but could ofc still do by mere chance, especially with very few fields)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>