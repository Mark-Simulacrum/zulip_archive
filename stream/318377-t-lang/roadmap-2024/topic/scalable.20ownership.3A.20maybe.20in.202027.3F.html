<html>
<head><meta charset="utf-8"><title>scalable ownership: maybe in 2027? · t-lang/roadmap-2024 · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/index.html">t-lang/roadmap-2024</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/scalable.20ownership.3A.20maybe.20in.202027.3F.html">scalable ownership: maybe in 2027?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277835009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/scalable%20ownership%3A%20maybe%20in%202027%3F/near/277835009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/scalable.20ownership.3A.20maybe.20in.202027.3F.html#277835009">(Apr 05 2022 at 06:57)</a>:</h4>
<p>I'd like to talk about the scalability of the ownership system inside larger application systems again. The current system works well to some degree, but i think it's useful to cover more common patterns better.<br>
So, let's start by defining four kinds of storages. <strong>"Global"</strong> which means it's a process-level singleton. <strong>"ThreadLocal"</strong> which means it's a thread-level singleton. <strong>"Dynamic"</strong> which means it lives to the extent as long as it is necessary, using mechanisms such as ref-counting. <strong>"Scoped"</strong> which means it lives as a variable, which is scoped by function boundaries. Rust currently works best with the "Scoped" ones.</p>
<p>And let define three kinds of dependencies. <strong>"Root"</strong> means it is without any dependency. <strong>"Outside"</strong> means it contains all the data of itself, but also has dependency on another value. <strong>"Within"</strong> means the actual data of itself is contained within its dependency (either allocating or interning), and it only has an index to access the data when necessary.  Rust currently works best with "Root" ones, and works ok with "Outside" ones with lifetime system, the "Within" ones works but syntax sugars are severely lacking.</p>
<p>Putting all this together, we have 25 combinations if we want to cover level &lt;=2 cases:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">StorageKind</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">GlobalRoot</span><span class="p">,</span><span class="w">    </span><span class="c1">// &amp;'static T</span>
<span class="w">    </span><span class="n">ThreadLocalRoot</span><span class="p">,</span><span class="w">   </span><span class="c1">// &amp;'static LocalKey&lt;T&gt;</span>
<span class="w">    </span><span class="n">DynamicRoot</span><span class="p">,</span><span class="w">   </span><span class="c1">// Rc&lt;T&gt;</span>
<span class="w">    </span><span class="n">ScopedRoot</span><span class="p">,</span><span class="w">   </span><span class="c1">// T or Box&lt;T&gt;</span>
<span class="w">    </span><span class="n">GlobalOutsideGlobal</span><span class="p">,</span><span class="w">  </span><span class="c1">// (&amp;'static Parent, &amp;'static T)</span>
<span class="w">    </span><span class="n">ThreadLocalOutsideGlobal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DynamicOutsideGlobal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ScopedOutsideGlobal</span><span class="p">,</span><span class="w">  </span><span class="c1">// (&amp;'static Parent, T)</span>
<span class="w">    </span><span class="n">ThreadLocalOutsideThreadLocal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DynamicOutsideThreadLocal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ScopedOutsideThreadLocal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DynamicOutsideDynamic</span><span class="p">,</span><span class="w"> </span><span class="c1">// (Rc&lt;Parent&gt;, Rc&lt;T&gt;)</span>
<span class="w">    </span><span class="n">ScopedOutsideDynamic</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ScopedOutsideScoped</span><span class="p">,</span><span class="w">  </span><span class="c1">//  (&amp;'a Parent, T)</span>
<span class="w">    </span><span class="n">DynamicIndexedWithinGlobal</span><span class="p">,</span><span class="w">  </span><span class="c1">// (&amp;'static Parent, usize, Rc&lt;DropGuard&gt;)</span>
<span class="w">    </span><span class="n">ScopedIndexedWithinGlobal</span><span class="p">,</span><span class="w">  </span><span class="c1">// (&amp;'static Parent, usize, DropGuard)</span>
<span class="w">    </span><span class="n">WeakIndexedWithinGlobal</span><span class="p">,</span><span class="w">  </span><span class="c1">// (&amp;'static Parent, usize)</span>
<span class="w">    </span><span class="n">DynamicIndexedWithinThreadLocal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ScopedIndexedWithinThreadLocal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">WeakIndexedWithinThreadLocal</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DynamicIndexedWithinDynamic</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ScopedIndexedWithinDynamic</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">WeakIndexedWithinDynamic</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ScopedIndexedWithinScoped</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">WeakIndexedWithinScoped</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In reality, all these 25 combinations are actually used, in different situations. But there're a few major issues. I wonder if there's any directional vision for easing some of these issues, that will improve the overall ergonomics.</p>
<ol>
<li>It's currently still very very hard to allow library users to pick between these. Current generics features are a little too limiting to allow this design choice, and the library authors (usually) cannot afford maintaining multiple flavors of a single library.</li>
<li>It's very expensive to refactor code when the author decided that different mode usages has to be allowed (Scoped -&gt; Dynamic, Outside -&gt; IndexedWithin, etc).</li>
<li>Method call/Field access operators etc doesn't work well for wrapper types. Input can use <code>Deref</code> and other things, output un-projecting support is rather limited.   Also thread_local's <code>LocalKey</code> cannot be used as receiver. And <code>LocalKey</code> has to use closures for many cases. </li>
<li>Unique access(&amp;mut) support only works well for <code>Scoped</code> cases. On the other hand, interior mutability still has no good builtin support for composite types(Vec, Map, etc)</li>
<li>Few kinds support the back-referencing from parent to child. Notability, the <code>Scoped</code> ones doesn't.</li>
<li><code>DropGuard</code>s' existence often forbid <code>Copy</code>-ing.</li>
</ol>



<a name="277850727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/scalable%20ownership%3A%20maybe%20in%202027%3F/near/277850727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/scalable.20ownership.3A.20maybe.20in.202027.3F.html#277850727">(Apr 05 2022 at 09:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209638">Paa Kojo Samanpa</span> has marked this topic as resolved.</p>



<a name="277850910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/scalable%20ownership%3A%20maybe%20in%202027%3F/near/277850910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/scalable.20ownership.3A.20maybe.20in.202027.3F.html#277850910">(Apr 05 2022 at 09:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209638">Paa Kojo Samanpa</span> has marked this topic as unresolved.</p>



<a name="278336854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/scalable%20ownership%3A%20maybe%20in%202027%3F/near/278336854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/scalable.20ownership.3A.20maybe.20in.202027.3F.html#278336854">(Apr 08 2022 at 17:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> I'm intrigued by this analysis but it's going to take me some time to truly understand what it is saying :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>