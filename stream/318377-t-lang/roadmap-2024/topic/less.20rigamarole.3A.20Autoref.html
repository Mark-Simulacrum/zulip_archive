<html>
<head><meta charset="utf-8"><title>less rigamarole: Autoref · t-lang/roadmap-2024 · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/index.html">t-lang/roadmap-2024</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html">less rigamarole: Autoref</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276229735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276229735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276229735">(Mar 22 2022 at 17:58)</a>:</h4>
<blockquote>
<p>Autoref, operators, and clones: Generic methods that operate on references sometimes necessitate types like <code>&amp;u32</code>; since <code>u32</code> is <code>Copy</code>, we could automatically make it a reference. We’ve historically had some hesitance to add more reference-producing operations, because it can lead to types the user doesn’t expect (e.g. <code>&amp;&amp;&amp;str</code>). We have some ideas to simplify those cases and avoid unnecessary double-references.</p>
</blockquote>
<p>This explanation doesn't make much sense to me. It should probably be re-worded. Josh said that an example is something like <code>foo(arg: &amp;u32)</code> and then calling <code>foo(4)</code>. In this case, the compiler would just act like you'd written <code>foo(&amp;4)</code> instead. However, that doesn't explain what <code>Copy</code> has to do with anything here. If the explanation is something like "Because the value is Copy then you don't drop it accidentally", I guess that's fine, but with all the <code>AsRef&lt;str&gt;</code> and <code>AsRef&lt;Path&gt;</code> stuff in the standard library you can already accidentally drop an allocated thing (by passing in a String or PathBuf directly), and the "fix" is that you get an error if you try to use the thing you dropped on accident, and then you go back and put in the <code>&amp;</code> that you meant to put.</p>



<a name="276230537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276230537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276230537">(Mar 22 2022 at 18:03)</a>:</h4>
<p>I think that's a fair concern; it's not that we <em>couldn't</em> make a reference out of a non-Copy type, it's more that with Copy types this is more likely to arise, and that it feels safer to do with Copy types.</p>



<a name="276230580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276230580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276230580">(Mar 22 2022 at 18:03)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> who is particularly interested in autoref, and who may have thoughts on better wording there.</p>



<a name="276230902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276230902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276230902">(Mar 22 2022 at 18:05)</a>:</h4>
<p>Certainly the time I've wanted this the most is with a <code>HashMap&lt;K:Copy, V&gt;</code></p>



<a name="276237444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276237444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276237444">(Mar 22 2022 at 18:49)</a>:</h4>
<p>Personally, I'm a big fan of the general "discarding ownership" idea, even for non-copy things.  Assuming some basic things like<br>
1) It actually "moves" so long as it's written like a move (so <code>let x: String = ...; foo(x);</code> would invalidate <code>x</code> from further use even if <code>foo</code> only took <code>&amp;str</code>)<br>
2) There are good lints for basic things like "you can just pass <code>foo(&amp;x)</code>; no need for <code>foo(x.clone())</code>".</p>



<a name="276277761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276277761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276277761">(Mar 23 2022 at 01:10)</a>:</h4>
<p>for me the most common annoyance is getting an <code>&amp;usize</code> out of a match</p>



<a name="276277818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276277818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276277818">(Mar 23 2022 at 01:11)</a>:</h4>
<p>e.g. <code>match &amp;some_struct { Foo { x } }</code></p>



<a name="276277858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/276277858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#276277858">(Mar 23 2022 at 01:12)</a>:</h4>
<p>but another common thing is the <code>x.iter().filter(|x| **x &gt; 3)</code> or stuff like that</p>



<a name="277434188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/277434188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#277434188">(Apr 01 2022 at 15:20)</a>:</h4>
<p>if we <em>do</em> generalize this to cover things with destructors, then I'd want to make sure that we drop things at "roughly" the spot you expect. I.e. for <code>let b = Box::new(...); fn foo(&amp;Box&lt;T&gt;) { ... } foo(b);</code>, I'd expect there to be a destruction scope immediately following the call to <code>foo</code> that handles dropping <code>b</code> (instead of having it be dropped at the end of the scope of the <code>let b</code>).</p>



<a name="277434251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/277434251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#277434251">(Apr 01 2022 at 15:21)</a>:</h4>
<p><del>wait, my example was not helpful as written. Let me fix.</del> done</p>



<a name="277434619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/277434619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#277434619">(Apr 01 2022 at 15:23)</a>:</h4>
<p>and in any case, I think we can+should focus on delivering the <em>easy</em> case first: Handle <code>Copy</code> types (or at least types w/o a destructor), and work out the details of what I'm saying above later, after people have already demonstrated that they like the more restricted form of the feature.</p>



<a name="277508363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/277508363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#277508363">(Apr 02 2022 at 05:39)</a>:</h4>
<p>Yeah, the "de-sugar" for a missing <code>&amp;</code> would just be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">--</span>-&gt; <span class="p">{</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="nb">drop</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And this pattern works regardless of Copy or not. The fact that doing a <code>drop</code> on a Copy value is pointless doesn't make the pattern not work. That way people don't have to learn two separate situations for "what this means".</p>



<a name="277508620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/less%20rigamarole%3A%20Autoref/near/277508620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/less.20rigamarole.3A.20Autoref.html#277508620">(Apr 02 2022 at 05:46)</a>:</h4>
<p>Might even be able to just phrase it as <code>foo(x) ---&gt; foo(&amp;{x})</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>