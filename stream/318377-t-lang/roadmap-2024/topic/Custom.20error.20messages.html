<html>
<head><meta charset="utf-8"><title>Custom error messages · t-lang/roadmap-2024 · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/index.html">t-lang/roadmap-2024</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html">Custom error messages</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277913403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/277913403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Cecile <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#277913403">(Apr 05 2022 at 17:18)</a>:</h4>
<p>And, on the same note: Bevy is interested in helping to drive forward a design on library-provided custom error messages.</p>
<p>I'm likely to step up for this myself; I do much of the project management and documentation for the team, so I think I'm a solid fit.</p>



<a name="278174516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278174516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ted Driggs <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278174516">(Apr 07 2022 at 14:45)</a>:</h4>
<p>This is something I'd also be interested in. I'm the author and maintainer of <a href="https://crates.io/crates/darling"><code>darling</code></a>, which tries to be <code>serde</code>, but for proc-macros.</p>



<a name="278181711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278181711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278181711">(Apr 07 2022 at 15:31)</a>:</h4>
<p>It may be relevant to look at what GHC does: <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/proposal/custom-type-errors">https://gitlab.haskell.org/ghc/ghc/-/wikis/proposal/custom-type-errors</a> Basically you write the non-existent impl, but add a where clause requiring that a "const generic" representing the error message implements the TypeError trait (type family in haskell). You can also use the actual inferred generics and implementing type as part of the error message. I'm not sure if rust's type system is flexible enough for this approach though.</p>



<a name="278199107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278199107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ted Driggs <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278199107">(Apr 07 2022 at 17:30)</a>:</h4>
<p>I think there are two aspects/buckets to this:</p>
<ol>
<li>Allowing macros to explicitly emit fancier diagnostics: Warnings, diagnostic chains, et cetera.</li>
<li>Allowing macros to add context to errors emitted by the compiler.</li>
</ol>
<p>As a concrete example, <code>derive_builder</code> allows the user to specify the error type returned by the build function, like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Builder)]</span><span class="w"></span>
<span class="cp">#[builder(build_fn(error = </span><span class="s">"MyCustomError"</span><span class="cp">))]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Thing</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">age</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>There are a few ways this could go wrong:</p>
<ol>
<li>The user passes something that isn't a string to <code>error =</code>. The macro can detect this, so it falls into bucket 1.</li>
<li>The string the user passes to <code>error = </code> isn't a valid path. The macro can detect this too, so it also falls into bucket 1.</li>
<li>The user passes a valid path, but it's not in scope. The macro can't detect this, so it falls into bucket 2.</li>
<li>The user passes a valid path to an in-scope type, but it doesn't impl <code>From&lt;derive_builder::UninitializedFieldError&gt;</code>. This also falls into bucket 2.</li>
<li>The user passes a valid path to an in-scope type with the required impls, but the type's visibility is less than that of the generated build method; maybe the build method is <code>pub</code> and the error type is <code>pub(crate)</code>. This is also bucket 2.</li>
</ol>
<p>My crate <code>darling</code> does everything it can to handle bucket 1 failures well (but is limited in what it can do, and I'm therefore eager for improvements to the diagnostics APIs). For bucket 2, the only option is to try and set the spans of the generated conversion code to point at the path. For this particular use-case that's probably good enough, but for more complex macros it would be difficult or impossible to do that; imagine if the macro has the user specify two paths, and the problem is that there's no <code>From</code> conversion between them.</p>
<p>If I understand the Haskell article properly, it seems to help with these bucket 2 failures: The macro creates something that doesn't compile/type check, and the macro gets the opportunity to improve the error message on its way to the user. Is that a correct (albeit simplistic) understanding of it?</p>



<a name="278260707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278260707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278260707">(Apr 08 2022 at 06:09)</a>:</h4>
<p>The only concern I have with the GHC style is that I think it would require reliance on specialization to work, right?</p>



<a name="278364850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278364850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278364850">(Apr 08 2022 at 21:30)</a>:</h4>
<p><span class="user-mention" data-user-id="406353">@Alice Cecile</span> <span class="user-mention" data-user-id="488050">@Ted Driggs</span> I think a good first step would be to outline the kinds of errors that you would be giving in a perfect world</p>



<a name="278364867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278364867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278364867">(Apr 08 2022 at 21:31)</a>:</h4>
<p>I'd rather we not start with mechanism</p>



<a name="278364899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278364899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278364899">(Apr 08 2022 at 21:31)</a>:</h4>
<p>if you like, I'd be game to schedule some time to chat about this and brainstorm a bit!</p>



<a name="278371620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278371620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Cecile <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278371620">(Apr 08 2022 at 22:52)</a>:</h4>
<p>Yep, I can absolutely provide that for Bevy's use cases at least.</p>



<a name="278371662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278371662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Cecile <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278371662">(Apr 08 2022 at 22:53)</a>:</h4>
<p>Our problematic error messages are fundamentally centered around variadics, so there are quite a few possible fixes</p>



<a name="278373588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278373588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ted Driggs <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278373588">(Apr 08 2022 at 23:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> +1 to starting with the goal in mind. I'll grab some examples from<code>derive_builder</code> early next week and share them here.</p>



<a name="278400348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278400348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278400348">(Apr 09 2022 at 09:55)</a>:</h4>
<p>I would also be interested. We (pyo3) have some examples at <a href="https://github.com/PyO3/pyo3/tree/main/tests/ui">https://github.com/PyO3/pyo3/tree/main/tests/ui</a> Some of these can have decent error messages created by a proc macro, but some are really bad</p>



<a name="278434560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278434560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278434560">(Apr 09 2022 at 22:35)</a>:</h4>
<p>I collected some at <a href="https://gist.github.com/mejrs/4199fefcf72e56567ecdd3c89b407ae2">https://gist.github.com/mejrs/4199fefcf72e56567ecdd3c89b407ae2</a></p>



<a name="278434632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278434632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278434632">(Apr 09 2022 at 22:36)</a>:</h4>
<p><span class="user-mention" data-user-id="249430">@David Hewitt</span> can you think of any other really bad pyo3 errors?</p>



<a name="278721408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318377-t-lang/roadmap-2024/topic/Custom%20error%20messages/near/278721408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/318377-t-lang/roadmap-2024/topic/Custom.20error.20messages.html#278721408">(Apr 12 2022 at 16:59)</a>:</h4>
<p>great!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>