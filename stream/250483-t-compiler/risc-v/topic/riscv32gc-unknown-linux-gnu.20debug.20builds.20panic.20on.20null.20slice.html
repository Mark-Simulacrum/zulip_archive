<html>
<head><meta charset="utf-8"><title>riscv32gc-unknown-linux-gnu debug builds panic on null slice · t-compiler/risc-v · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/index.html">t-compiler/risc-v</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html">riscv32gc-unknown-linux-gnu debug builds panic on null slice</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258583498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258583498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared S <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258583498">(Oct 21 2021 at 17:14)</a>:</h4>
<p>Hi folks!</p>
<p>I'm experimenting with riscv32gc-unknown-linux-gnu target using qemu-system-riscv32 and a buildroot environment. When compiled for <code>release</code>, a simple hello world runs successfully. When compiled dev, It panics with <code>attempt to create unaligned or null slice</code>. </p>
<p>Full stack trace is in this gist: <a href="https://gist.github.com/jared-s/641fa6108c23fd5b6f08a37b441b3e01">https://gist.github.com/jared-s/641fa6108c23fd5b6f08a37b441b3e01</a></p>



<a name="258584637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258584637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared S <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258584637">(Oct 21 2021 at 17:21)</a>:</h4>
<p>The buildroot emulated environment created by buildroot <code>make qemu_riscv32_virt_defconfig</code> reproduces the issue. I'm using the latest riscv-gnu-toolchain for linking, built for ilp32d abi</p>



<a name="258624774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258624774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258624774">(Oct 21 2021 at 22:06)</a>:</h4>
<p>Where's the code?</p>



<a name="258654456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258654456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258654456">(Oct 22 2021 at 02:45)</a>:</h4>
<p>I think it was just the <code>cargo new</code> output (<span class="user-mention" data-user-id="451520">@Jared S</span> is my coworker, I suggested they ask here), but they can confirm.</p>



<a name="258654563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258654563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258654563">(Oct 22 2021 at 02:47)</a>:</h4>
<p>or an equivalent, anyway</p>



<a name="258738909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258738909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared S <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258738909">(Oct 22 2021 at 16:47)</a>:</h4>
<p>I uploaded an example project and buildroot environment here <a href="https://github.com/jared-s/rv32_debug_panic">https://github.com/jared-s/rv32_debug_panic</a> <span class="user-mention" data-user-id="303710">@Gary Guo</span></p>



<a name="258770674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258770674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258770674">(Oct 22 2021 at 20:35)</a>:</h4>
<p>Oh so it's really just a hello world. That's weird.</p>



<a name="258770903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258770903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258770903">(Oct 22 2021 at 20:37)</a>:</h4>
<p>Yeah, the slice comes from a <code>&lt;Vec&lt;u8&gt; as Deref&gt;::deref</code> call, and the pointer is null, which doesn't make a lot of sense, since that should never be possible.</p>



<a name="258770955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258770955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258770955">(Oct 22 2021 at 20:38)</a>:</h4>
<p>I'm wondering if somehow align_of::&lt;u8&gt;() happens to be 0 on that platform</p>



<a name="258771023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771023">(Oct 22 2021 at 20:38)</a>:</h4>
<p>(due to an incorrect <code>data-layout</code> or something, idk)</p>



<a name="258771037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771037">(Oct 22 2021 at 20:38)</a>:</h4>
<p><code>BufWriter</code> also creates and uses <code>Vec</code> internally</p>



<a name="258771064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771064">(Oct 22 2021 at 20:38)</a>:</h4>
<p>right</p>



<a name="258771151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771151">(Oct 22 2021 at 20:39)</a>:</h4>
<p>that much makes sense, the part where the pointer is null doesnt — either rawvec should catch the allocator returning null, or its the pointer from <code>NonNull::dangling()</code> (or, whatever the equivalent <code>Unique</code> function is, if it uses that, IDR)</p>



<a name="258771405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771405">(Oct 22 2021 at 20:41)</a>:</h4>
<p>It's <code>Unique::dangling()</code></p>



<a name="258771455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771455">(Oct 22 2021 at 20:42)</a>:</h4>
<p>So baiscally from aling_of</p>



<a name="258771509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771509">(Oct 22 2021 at 20:42)</a>:</h4>
<p><a href="https://godbolt.org/z/6nz6daMva">https://godbolt.org/z/6nz6daMva</a> The alignment is correct</p>



<a name="258771900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771900">(Oct 22 2021 at 20:45)</a>:</h4>
<p>I wonder if it could be miscompilation..</p>



<a name="258771997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258771997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258771997">(Oct 22 2021 at 20:46)</a>:</h4>
<p>I'd suggest try older versions of Rust and see if issue persists</p>



<a name="258772043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/258772043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#258772043">(Oct 22 2021 at 20:46)</a>:</h4>
<p>LLVM 13 update breaks a few targets like PowerPC, so RV32 could be broken as well</p>



<a name="259793045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu%20debug%20builds%20panic%20on%20null%20slice/near/259793045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/250483-t-compiler/risc-v/topic/riscv32gc-unknown-linux-gnu.20debug.20builds.20panic.20on.20null.20slice.html#259793045">(Oct 31 2021 at 15:32)</a>:</h4>
<p>I don't think riscv32 is actually that important to us (it would have been neat, but IIUC riscv64 works for us to), so I'll file an issue for it (unless you want to <span class="user-mention" data-user-id="451520">@Jared S</span>).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>