<html>
<head><meta charset="utf-8"><title>Add #[rustc_deprecated_safe] attribute to all… lang-team#147 · t-lang/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/index.html">t-lang/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html">Add #[rustc_deprecated_safe] attribute to all… lang-team#147</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274779941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274779941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274779941">(Mar 10 2022 at 01:51)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/lang-team/issues/147">Add #[rustc_deprecated_safe] attribute to allow functions be be marked unsafe in a backwards compatible fashion #147</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="274850647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274850647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274850647">(Mar 10 2022 at 15:30)</a>:</h4>
<p>I think this is a great idea, <span class="user-mention" data-user-id="127967">@skippy</span> (I presume...?), but the <code>rustc_</code> prefix is usually reserved for internal implementation details of rustc. This seems like a more user-visible feature, no?</p>



<a name="274850771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274850771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274850771">(Mar 10 2022 at 15:31)</a>:</h4>
<p>I guess it might be a "special power" reserved for libstd, or at least prototyped that way, but I feel like we would want it to be something libraries can make use of as well.</p>



<a name="274851004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274851004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274851004">(Mar 10 2022 at 15:32)</a>:</h4>
<p>I think just dropping the rustc_ prefix is likely fine: the feature likely wants to be <em>unstable</em> (as all features), but I see no particular reason it couldn't eventually stabilize in some form. It seems like a natural API evolution step to me for libraries.</p>



<a name="274852373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274852373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274852373">(Mar 10 2022 at 15:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I assume it would start as unstable, indeed, but just because everything does. The point is that I think this has a "route to stability"</p>



<a name="274852405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274852405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274852405">(Mar 10 2022 at 15:41)</a>:</h4>
<p>Yeah, for sure.</p>



<a name="274859771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274859771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274859771">(Mar 10 2022 at 16:30)</a>:</h4>
<p>I wondered about making this available to libraries as well, but was trying to limit the scope for the MCP. I didn't think about stability letting this get in sooner just for the purposes of set_var/remove_var, while sidestepping any questions that would be raised before making it available to everyone. That sounds like a great idea to me!</p>



<a name="274860601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274860601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274860601">(Mar 10 2022 at 16:35)</a>:</h4>
<p>I renamed the issue (didn't realize that'd create yet another zulip stream, oops...) and updated the text throughout. I also added this blurb:</p>
<blockquote>
<p>This attribute could be made available for use for by all libraries as well, however the MCP only focuses on what's needed for set_var/remove_var. Because the attribute would initially be unstable, it could be used internally by libstd to fix set_var/remove_var before addressing any broader questions that would need to be answered before making this a publicly available stable attribute.</p>
</blockquote>



<a name="274861289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274861289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274861289">(Mar 10 2022 at 16:40)</a>:</h4>
<p>Off-topic: the message "The associated GitHub issue has been renamed. Renaming this Zulip topic." seems inaccurate since a new stream is being created instead of actually doing a rename</p>



<a name="274918342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274918342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274918342">(Mar 11 2022 at 00:54)</a>:</h4>
<p>If this does have a "route to stability" would it make sense to proactively expand the attribute to also work with traits (and any other place unsafe can be added)? I was imagining that as a future possibility if libstd ever ended up needing it.</p>



<a name="274928992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274928992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274928992">(Mar 11 2022 at 03:53)</a>:</h4>
<p>allowing the attribute on trait methods as well as on non-trait functions/methods doesn't change the way the attribute would operate in any obvious way, so it wouldn't really slow the RFC/design process to add that in now, so just add it in now.</p>



<a name="274930462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274930462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274930462">(Mar 11 2022 at 04:22)</a>:</h4>
<p>It's unsafe traits themselves I meant, i.e. "unsafe trait Bla { }".</p>



<a name="274974838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/274974838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#274974838">(Mar 11 2022 at 13:34)</a>:</h4>
<p>Another place I can think of is a "top level" function pointer:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">fn_ptr</span>: <span class="nc">fn</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_fn</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>going to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">fn_ptr</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_fn</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="275013730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275013730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275013730">(Mar 11 2022 at 18:26)</a>:</h4>
<p>Hmm, it seems like this would always be temporary, outside of <code>std</code>?  To me, I'd think that every library that uses it should release a major version bump to make it <em>properly</em> <code>unsafe</code>.</p>
<p>How sad would we be if a library just only ever wrote <code>#[deprecated_safe] fn</code>s instead of <code>unsafe fn</code>s?  And then consumed it in a project that allowed the lint...</p>



<a name="275014803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275014803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275014803">(Mar 11 2022 at 18:35)</a>:</h4>
<p>well even if a project does an actual breaking version bump, the old version needs a patch with this attribute added to it as well.</p>
<p>like, the only reason to use this attribute ever is because of a soundness hole. And those need to be dealt with properly. So libs still need to use this attribute at a particular version patch. (the alternative is to do a massive pile of yanks, which I'm thinking we generally don't want.)</p>



<a name="275026190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275026190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275026190">(Mar 11 2022 at 20:00)</a>:</h4>
<p>but also, how many soundness holes are actually fixed by replacing a safe fn with an unsafe one? we have exactly 2 examples so far I think.</p>



<a name="275028673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275028673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275028673">(Mar 11 2022 at 20:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275014803">said</a>:</p>
<blockquote>
<p>like, the only reason to use this attribute ever is because of a soundness hole. And those need to be dealt with properly. So libs still need to use this attribute at a particular version patch. (the alternative is to do a massive pile of yanks, which I'm thinking we generally don't want.)</p>
</blockquote>
<p>The problem I see here is that the new patch version doesn't actually fix anything.  The caller still needs a code update if its usage was unsound.  And the build often won't even break, because of cap-lints.</p>
<p>Why <em>wouldn't</em> the library want to yank the unsound versions?</p>



<a name="275031556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275031556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275031556">(Mar 11 2022 at 20:45)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span>, is that an argument against using this within libstd or just the idea of making this available to libraries? I've left the proposal geared solely towards libstd for now, with notes about making it available to libraries as just a "potentially maybe" future possibility that would have a lot of questions to be answered.</p>



<a name="275032383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275032383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275032383">(Mar 11 2022 at 20:52)</a>:</h4>
<blockquote>
<p>Why <em>wouldn't</em> the library want to yank the unsound versions?</p>
</blockquote>
<p>for all the reasons that std is doing this attribute thing instead ;3</p>



<a name="275033282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275033282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275033282">(Mar 11 2022 at 21:01)</a>:</h4>
<p>would this be helpful in scenarios where e.g. "0.1.0" had an unsoundness issue that could be "fixed" by this, but the next major breaking version "0.2.0" is already published with a non-trivial upgrade path?</p>



<a name="275033911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275033911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275033911">(Mar 11 2022 at 21:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275031556">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span>, is that an argument against using this within libstd or just the idea of making this available to libraries? I've left the proposal geared solely towards libstd for now, with notes about making it available to libraries as just a "potentially maybe" future possibility that would have a lot of questions to be answered.</p>
</blockquote>
<p>big <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> for using this in std, which can never have breaking changes.</p>
<p>but I guess I am skeptical about its usefulness beyond, given other crates can have breaking changes (though it can be painful) and the situations where you need this attribute seem rare.</p>



<a name="275033999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275033999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275033999">(Mar 11 2022 at 21:09)</a>:</h4>
<p>I wish we had done this for <code>before_exec</code>. I hope we can combine it with "in a future edition, this is rejected entirely" (basically, "in a future edition, we actually fix the soundness problem"). for that reason I think it might make sense to also apply this to <code>before_exec</code>.</p>



<a name="275034875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275034875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275034875">(Mar 11 2022 at 21:17)</a>:</h4>
<p>i agree that rejecting in the next edition is something that should be done</p>
<p>the proof of concept i did worked fine with before_exec as well, although i do wonder what should be done with the 99.99% identical methods at that point if we retroactively apply the attribute there</p>
<p>like should pre_exec still be preferred? can one just be hidden? just copy+paste the pre_exec docs (with safety section) onto before_exec?</p>



<a name="275034897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275034897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275034897">(Mar 11 2022 at 21:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275033999">said</a>:</p>
<blockquote>
<p>I wish we had done this for <code>before_exec</code>. I hope we can combine it with "in a future edition, this is rejected entirely" (basically, "in a future edition, we actually fix the soundness problem"). for that reason I think it might make sense to also apply this to <code>before_exec</code>.</p>
</blockquote>
<p>I actually wrote a mechanism for this into lccc's <a href="https://lightningcreations.github.io/lccc/lcrust/formats/rlib#item-stability">rmanifest format</a> (<code>Stability::RemovedInEdition</code> and more recently<code>Stability::UnsafeInEdition</code>). It might be interesting to explore that applied to rustc, as a separate question. I'm not going to volunteer to implement that there, though.</p>



<a name="275040226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275040226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275040226">(Mar 11 2022 at 22:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275034897">said</a>:</p>
<blockquote>
<p>I actually wrote a mechanism for this into lccc's <a href="https://lightningcreations.github.io/lccc/lcrust/formats/rlib#item-stability">rmanifest format</a> (<code>Stability::RemovedInEdition</code> and more recently<code>Stability::UnsafeInEdition</code>). It might be interesting to explore that applied to rustc, as a separate question. I'm not going to volunteer to implement that there, though.</p>
</blockquote>
<p>I didn't bother adding an edition check in my proof of concept implementation, but I assume it should be trivial. I already have the span to emit the lint against.</p>



<a name="275062667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275062667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275062667">(Mar 11 2022 at 23:38)</a>:</h4>
<blockquote>
<p>like should pre_exec still be preferred? can one just be hidden? just copy+paste the pre_exec docs (with safety section) onto before_exec?</p>
</blockquote>
<p>Yeah that will be somewhat annoying. I think I would like to keep before_exec deprecated (since it would be bad style to ask people to move back and forth), but <em>additionally</em> make it a hard error to call it outside <code>unsafe</code> in a future edition</p>



<a name="275063213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275063213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275063213">(Mar 11 2022 at 23:46)</a>:</h4>
<p>that matches what i tried locally (modulo the edition check which i haven't implemented yet), i just made a slight tweak to the deprecation message:</p>
<blockquote>
<p>should be unsafe, use <code>pre_exec</code> instead</p>
</blockquote>
<p>to:</p>
<blockquote>
<p>should have originally been unsafe, use <code>pre_exec</code> instead</p>
</blockquote>



<a name="275063300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275063300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275063300">(Mar 11 2022 at 23:47)</a>:</h4>
<p>(not that sorting of the exact new message is super important right now <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span>)</p>



<a name="275063655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275063655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275063655">(Mar 11 2022 at 23:51)</a>:</h4>
<p>this is what the output of my proof of concept looks like btw:<br>
<a href="/user_uploads/4715/5CSuCqVXuaUaHTgVowVKCJep/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/5CSuCqVXuaUaHTgVowVKCJep/image.png" title="image.png"><img src="/user_uploads/4715/5CSuCqVXuaUaHTgVowVKCJep/image.png"></a></div><p>this was just the bare minimum to test things out, as you can see by my awful error messages <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="275063866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275063866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275063866">(Mar 11 2022 at 23:54)</a>:</h4>
<p>for the <code>Box&lt;dyn Fn()&gt;</code> stuff there's no unsafe that can be added afaik, you just can't do it and will need an alternative (unlike a <code>fn</code> pointer where you can make it <code>unsafe fn</code>)</p>



<a name="275064126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275064126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275064126">(Mar 11 2022 at 23:58)</a>:</h4>
<p>i'm also not sure if there are other places that would need to be handled, i did:</p>
<ol>
<li>call sites</li>
<li><code>fn</code> pointer coercions</li>
<li><code>Fn()</code> trait family coercions</li>
</ol>
<p>the proposal has a note that these are the ones i'm aware of, but that there may be others</p>



<a name="275101088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275101088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275101088">(Mar 12 2022 at 15:00)</a>:</h4>
<p>yeah not sure either. is there some field you can grep for to check where in the codebase we "look at" unsafety?</p>



<a name="275101113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275101113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275101113">(Mar 12 2022 at 15:01)</a>:</h4>
<p>if possible it'd be good to make the field/method that all code currently uses to check whether this function is unsafe, as just saying "unsafe" -- which will mean all code that is <em>not</em> adjusted errs on the side of treating this as fully unsafe</p>



<a name="275101134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275101134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275101134">(Mar 12 2022 at 15:01)</a>:</h4>
<p>(or change the return type of that field/method in a way that all call sites are forced to adjust)</p>



<a name="275101663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275101663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275101663">(Mar 12 2022 at 15:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275101113">said</a>:</p>
<blockquote>
<p>if possible it'd be good to make the field/method that all code currently uses to check whether this function is unsafe, as just saying "unsafe" -- which will mean all code that is <em>not</em> adjusted errs on the side of treating this as fully unsafe</p>
</blockquote>
<p>I'm not 100% sure what you mean by this. My plan was to make <code>set_var</code> fully unsafe, is that what you meant? I'd like to make it an error to apply <code>#[deprecated_safe]</code> to a function that isn't marked unsafe. That way we don't have to update things like "unused unsafe" lints to become aware of this new attribute. The function would become fully unsafe and behave like any other, with the attribute only acting as an escape hatch in the handful of places that would now break.</p>



<a name="275101905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275101905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275101905">(Mar 12 2022 at 15:17)</a>:</h4>
<p>so the <code>set_var</code> signature would change like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[stable(feature = </span><span class="s">"env"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[stable(feature = </span><span class="s">"env"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[deprecated_safe(since = </span><span class="s">"1.99.0"</span><span class="cp">, reason = </span><span class="s">"bla"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="275102549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275102549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275102549">(Mar 12 2022 at 15:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275101088">said</a>:</p>
<blockquote>
<p>yeah not sure either. is there some field you can grep for to check where in the codebase we "look at" unsafety?</p>
</blockquote>
<p>There is <code>hir::Unsafety::Unsafe</code>, which my proof of concept uses, but I've never looked at rustc before and definitely don't trust myself to find all relevant cases by grepping. <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span> I just made the function unsafe, and then wrote code triggering the 3 places I currently know it would break. (akin to failing ui tests) Then I went spelunking based off the error messages.</p>



<a name="275102711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275102711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275102711">(Mar 12 2022 at 15:35)</a>:</h4>
<p>This is what my so-called "ui test" looks like btw, for testing things out:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![allow(dead_code, unused_imports, unused_mut, unused_variables)]</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">process</span>::<span class="n">CommandExt</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">process</span>::<span class="n">Command</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// usage without unsafe should lint</span>
<span class="w">    </span><span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">,</span><span class="w"> </span><span class="s">"set_var_safe"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">,</span><span class="w"> </span><span class="s">"set_var_safe"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// all of these coercions should lint</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">set_var_fn_ptr</span>: <span class="nc">fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">set_var</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">set_var_fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">set_var_fnmut_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">set_var_fnonce_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ensure lint still fires if coerced again</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">set_var_fn_ptr</span>: <span class="nc">fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">set_var</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">set_var_fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">set_var_fnmut_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">set_var_fnonce_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">set_var_fn_ptr</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">"set_var_fn_ptr"</span><span class="p">.</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">set_var_fn_impl</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">"set_var_fn_impl"</span><span class="p">.</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">set_var_fnmut_impl</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">"set_var_fnmut_impl"</span><span class="p">.</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">set_var_fnonce_impl</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span><span class="w"> </span><span class="s">"set_var_fnonce_impl"</span><span class="p">.</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// these shouldn't lint, appropriate unsafe usage</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_unsafe_set_var_fn_ptr</span>: <span class="nc">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">set_var</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">,</span><span class="w"> </span><span class="s">"set_var_unsafe"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">print_env</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// all of these coercions should lint</span>
<span class="w">    </span><span class="n">fn_taking_fn_ptr</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_taking_fn_impl</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_taking_fnmut_impl</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_taking_fnonce_impl</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="c1">// ensure lint still fires if coerced again</span>
<span class="w">    </span><span class="n">fn_taking_fn_ptr</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_taking_fn_impl</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_taking_fnmut_impl</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">fn_taking_fnonce_impl</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">env</span>::<span class="n">set_var</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">Command</span>::<span class="n">new</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">before_exec</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">unimplemented!</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">print_env</span><span class="p">(</span><span class="n">i</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">"TEST"</span><span class="p">).</span><span class="n">unwrap_or</span><span class="p">(</span><span class="s">"missing"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">fn_taking_fn_ptr</span><span class="p">(</span><span class="n">_x</span>: <span class="nc">fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">))</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">fn_taking_fn_impl</span><span class="p">(</span><span class="n">_x</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">fn_taking_fnmut_impl</span><span class="p">(</span><span class="n">_x</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">fn_taking_fnonce_impl</span><span class="p">(</span><span class="n">_x</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="275186214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275186214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275186214">(Mar 14 2022 at 01:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275101663">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275101113">said</a>:</p>
<blockquote>
<p>if possible it'd be good to make the field/method that all code currently uses to check whether this function is unsafe, as just saying "unsafe" -- which will mean all code that is <em>not</em> adjusted errs on the side of treating this as fully unsafe</p>
</blockquote>
<p>I'm not 100% sure what you mean by this. My plan was to make <code>set_var</code> fully unsafe, is that what you meant? I'd like to make it an error to apply <code>#[deprecated_safe]</code> to a function that isn't marked unsafe. That way we don't have to update things like "unused unsafe" lints to become aware of this new attribute. The function would become fully unsafe and behave like any other, with the attribute only acting as an escape hatch in the handful of places that would now break.</p>
</blockquote>
<p>I was talking about things inside rustc :)</p>



<a name="275186673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275186673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275186673">(Mar 14 2022 at 01:50)</a>:</h4>
<p>kk, i think that's the <code>hir::Unsafety</code> that i mentioned, but i'm waiting until i have a mentor (assuming this is approved) until i touch any more code not knowing what i'm doing <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="275288509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275288509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275288509">(Mar 14 2022 at 19:45)</a>:</h4>
<p>well, I am fine to start for libstd</p>



<a name="275288553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275288553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275288553">(Mar 14 2022 at 19:45)</a>:</h4>
<p>it's just that one of the likely themes we've been looking at is how to "export tools that are specific to rustc for the ecosystem writ large", and this seemed like a potential example!</p>



<a name="275290101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275290101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275290101">(Mar 14 2022 at 19:59)</a>:</h4>
<p>i'm suuuuuper excited that things are looking positive towards this being approved <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span> i'm planning on joining the lang team triage meeting tomorrow so i can listen in</p>
<p>i do have full time availability to work on this as well, so i'll be keen to get started if it's accepted!</p>



<a name="275301606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275301606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275301606">(Mar 14 2022 at 21:36)</a>:</h4>
<p>I'm happy to see it start in nightly and use it for std, but yeah, let's plan on stabilizing it.</p>



<a name="275415782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275415782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275415782">(Mar 15 2022 at 18:25)</a>:</h4>
<p>since the proposal was seconded, is there someone i can talk to about the implementation? i'm not sure if i have a liaison now</p>



<a name="275415824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275415824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275415824">(Mar 15 2022 at 18:25)</a>:</h4>
<p>i'd like to validate the basic approach taken in my proof of concept, before i start looking at doing the code up "proper"</p>



<a name="275415965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275415965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275415965">(Mar 15 2022 at 18:26)</a>:</h4>
<p>the process is all still new to me :)</p>



<a name="275424355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275424355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275424355">(Mar 15 2022 at 19:33)</a>:</h4>
<p>i'm also wondering if i should be the one to file the tracking issue? since i'll prolly wanna make edits to that as i go, i think that was going to be done by <span class="user-mention" data-user-id="116083">@pnkfelix</span>?</p>



<a name="275439169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275439169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275439169">(Mar 15 2022 at 21:38)</a>:</h4>
<p>i went ahead and created a tracking issue (<a href="https://github.com/rust-lang/rust/issues/94978">https://github.com/rust-lang/rust/issues/94978</a>), i hope that's ok... it needs the T-lang label applied as I don't have access to do that</p>
<p>i couldn't add a new feature gate without having a tracking issue to reference</p>



<a name="275538034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275538034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275538034">(Mar 16 2022 at 16:28)</a>:</h4>
<p>thanks for taking care of that <span class="user-mention" data-user-id="127967">@skippy</span></p>



<a name="275554758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275554758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275554758">(Mar 16 2022 at 18:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/275415782">said</a>:</p>
<blockquote>
<p>since the proposal was seconded, is there someone i can talk to about the implementation? i'm not sure if i have a liaison now</p>
</blockquote>
<p>the person who seconds would ordinarily be your liaison</p>



<a name="275554774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275554774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275554774">(Mar 16 2022 at 18:10)</a>:</h4>
<p>are you all set, <span class="user-mention" data-user-id="127967">@skippy</span> ?</p>



<a name="275556518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275556518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275556518">(Mar 16 2022 at 18:22)</a>:</h4>
<p>awesome, thanks! i'm all set</p>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>  let me know if there's a good time for you to chat, i mostly have questions about the proof of concept i worked on, in the meantime i've been looking at how to add the attribute "properly" with stability, etc. based on other existing attributes</p>



<a name="275591094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275591094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275591094">(Mar 16 2022 at 23:40)</a>:</h4>
<p>actually, i just verified the one change i was super suspicious about is in fact wrong :) so i'll be heads down for a bit while i revisit that</p>



<a name="275716284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275716284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275716284">(Mar 17 2022 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>, i'm having an awful time trying to track down the issue i'm having, i think i need some help :)</p>
<p>i'm in <code>candidate_assembly.rs</code> and i've found that if i try do a coercion like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>then i'll get an obligation coming in to <code>assemble_fn_pointer_candidates</code> that has a <code>cause</code> field with an appropriately set <code>span</code> field for where that's coming from, e.g.:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Obligation</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">set_var</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="o">&lt;</span><span class="p">(</span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">skippy</span><span class="o">/</span><span class="n">rust_deprecated_safe</span><span class="o">/</span><span class="n">rust_deprecated_safe</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">21</span>:<span class="mi">53</span>: <span class="mi">21</span>:<span class="mi">70</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>the span will correctly point to <code>Box::new(std::env::set_var)</code></p>
<p>however, if I try a simpler function like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe(since = </span><span class="s">"TBD"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>then the incoming obligation's cause's span will just be the dummy span:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Obligation</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="n">foo</span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">no</span><span class="o">-</span><span class="n">location</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>and now i have no span to emit the lint against for where this obligation is coming from</p>
<p>(i'm also not actually sure if trying to lint from <code>assemble_fn_pointer_candidates</code> in the first place is correct)</p>
<p>i've been trying to track down where/why the obligation comes in with a dummy span in the simpler case of my <code>foo</code> fn, but i've been having no luck... this is my first time looking at rustc at all</p>



<a name="275737014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275737014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275737014">(Mar 17 2022 at 22:32)</a>:</h4>
<p>possible thought as i stare into the abyss... if the arguments match exactly (like in my simple case with no args), is the obligation's cause just the <code>call</code> fn in the <code>Fn</code> trait?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="nb">Fn</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span>: <span class="nb">FnMut</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Performs the call operation.</span>
<span class="w">    </span><span class="cp">#[unstable(feature = </span><span class="s">"fn_traits"</span><span class="cp">, issue = </span><span class="s">"29625"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"rust-call"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="nc">Args</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>that might explain why there's no span, since it's inside libstd itself</p>
<p>i do get an obligation cause span again if i make the args mismatch like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe(since = </span><span class="s">"TBD"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo2</span><span class="p">(</span><span class="n">_</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="kt">u64</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">foo2</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="275738443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275738443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275738443">(Mar 17 2022 at 22:48)</a>:</h4>
<p>oh, i just completely broke all my previous assumptions... i sometimes emit a lint that highlights the correct code, but i'm still passing a dummy span into <code>struct_span_lint_hir</code>! i just hard coded always passing a dummy span to that and i still get the correct lint output sometimes... hmmm.....</p>



<a name="275881477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275881477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275881477">(Mar 19 2022 at 01:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>, i was able to make a little more headway, i stuck an ID value on every <code>ObligationCause</code> and was able to use that to track down the creation of the specific obligation coming in with no cause span</p>
<p>the original obligation comes in here with the span information i need:<br>
<code>compiler/rustc_trait_selection/src/traits/query/evaluate_obligation.rs</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">evaluate_obligation</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">obligation</span>: <span class="kp">&amp;</span><span class="nc">PredicateObligation</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">EvaluationResult</span><span class="p">,</span><span class="w"> </span><span class="n">OverflowError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>the obligation looks like so, and the cause span correctly points to my <code>Box::new(foo)</code> call:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Obligation</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">Binder</span><span class="p">(</span><span class="n">TraitPredicate</span><span class="p">(</span><span class="o">&lt;</span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="n">foo</span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">polarity</span>:<span class="nc">Positive</span><span class="p">),</span><span class="w"> </span><span class="p">[]),</span><span class="w"> </span><span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="n">ObligationCause</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">span</span>: <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">skippy</span><span class="o">/</span><span class="n">rust_deprecated_safe</span><span class="o">/</span><span class="n">rust_deprecated_safe</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">27</span>:<span class="mi">34</span>: <span class="mi">27</span>:<span class="mi">47</span><span class="w"> </span><span class="p">(</span>#<span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">body_id</span>: <span class="nc">HirId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">owner</span>: <span class="nc">DefId</span><span class="p">(</span><span class="mi">0</span>:<span class="mi">25</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rust_deprecated_safe</span><span class="p">[</span><span class="mi">497</span><span class="n">c</span><span class="p">]</span>::<span class="n">main</span><span class="p">),</span><span class="w"> </span><span class="n">local_id</span>: <span class="mi">23</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">code</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">ObjectCastObligation</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="nb">Fn</span><span class="p">())),</span><span class="w"> </span><span class="n">id</span>: <span class="mi">363</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this <code>PredicateObligation</code> then gets turned into a <code>Canonical&lt;ParamEnvAnd&lt;Predicate&gt;&gt;</code> here in that function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">c_pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">canonicalize_query_keep_static</span><span class="p">(</span><span class="n">param_env</span><span class="p">.</span><span class="n">and</span><span class="p">(</span><span class="n">obligation</span><span class="p">.</span><span class="n">predicate</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">_orig_values</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>the canonical predicate no longer has the cause span information at this point</p>
<p>it's then passed to another <code>evaluate_obligation</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">obligation</span><span class="p">.</span><span class="n">cause</span><span class="p">.</span><span class="n">span</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">)).</span><span class="n">evaluate_obligation</span><span class="p">(</span><span class="n">c_pred</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>which is the following function:<br>
<code>compiler/rustc_traits/src/evaluate_obligation.rs</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">evaluate_obligation</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">canonical_goal</span>: <span class="nc">CanonicalPredicateGoal</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">EvaluationResult</span><span class="p">,</span><span class="w"> </span><span class="n">OverflowError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>inside of this <code>evaluate_obligation</code> is where the actual obligation that i'm receiving in <code>assemble_fn_pointer_candidates</code> is being created</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">obligation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Obligation</span>::<span class="n">new</span><span class="p">(</span><span class="n">ObligationCause</span>::<span class="n">dummy</span><span class="p">(),</span><span class="w"> </span><span class="n">param_env</span><span class="p">,</span><span class="w"> </span><span class="n">predicate</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>the <code>dummy</code> function creates the cause with the dummy span, and while there is a <code>dummy_with_span</code> function, there's no span information available at this point for me to use</p>
<p>also, this code feels WAY above my pay grade to be trying to modify as a noob :)</p>
<p>is there anyone i can talk to about this to try and sort things out?</p>



<a name="275882092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275882092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275882092">(Mar 19 2022 at 01:46)</a>:</h4>
<p>Hi skippy, sorry I missed all this</p>



<a name="275882106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275882106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275882106">(Mar 19 2022 at 01:46)</a>:</h4>
<p>I’ve been pretty distracted but I hope I can look at this on Monday</p>



<a name="275882113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275882113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275882113">(Mar 19 2022 at 01:47)</a>:</h4>
<p>haha, no worries, i'm having fun bashing my brain into the unfamiliar code regardless <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="275882134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275882134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275882134">(Mar 19 2022 at 01:48)</a>:</h4>
<p>just ping me whenever, i'll hop right on, i'll still post any progress if i make any here too if that's ok?</p>



<a name="275934595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275934595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275934595">(Mar 19 2022 at 22:58)</a>:</h4>
<p>progress! this is a <em>hilariously incorrect</em> change, but i was finally able to follow the flow of things enough to try making the following change to <code>trait TypeFoldable&lt;'tcx&gt;</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// Indicates whether this value references only 'global'</span>
<span class="sd">/// generic parameters that are the same regardless of what fn we are</span>
<span class="sd">/// in. This is used for caching.</span>
<span class="k">fn</span> <span class="nf">is_global</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="c1">// !self.has_type_flags(TypeFlags::HAS_FREE_LOCAL_NAMES)</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>hard coding that to false changes the behavior of <code>process_trait_obligation</code> so that my simple case:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe(since = </span><span class="s">"TBD"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>ends up receiving an obligation in <code>assemble_fn_pointer_candidates</code> with a proper cause span for me to lint against</p>
<p>this obviously isn't a real solution, but it's something <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="275934989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275934989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275934989">(Mar 19 2022 at 23:08)</a>:</h4>
<p>words cannot describe how much this screenshot fills me with joy <span aria-label="nerd" class="emoji emoji-1f913" role="img" title="nerd">:nerd:</span><br>
<a href="/user_uploads/4715/4s8efhp0_tdXQnskn5FRk-0q/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/4s8efhp0_tdXQnskn5FRk-0q/image.png" title="image.png"><img src="/user_uploads/4715/4s8efhp0_tdXQnskn5FRk-0q/image.png"></a></div>



<a name="275940016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275940016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275940016">(Mar 20 2022 at 01:17)</a>:</h4>
<p>That looks <em>great</em>.</p>



<a name="275940134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275940134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275940134">(Mar 20 2022 at 01:20)</a>:</h4>
<p>well the implementation for the Fn() family traits is definitely still not correct, but after bashing my face into all the trait code for dozens of hours having literally no idea what i'm doing, i'll take it! <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="275940153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275940153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275940153">(Mar 20 2022 at 01:21)</a>:</h4>
<p>just calling the deprecated safe function or casting it to a safe fn pointer is mostly correct though i think</p>



<a name="275940212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275940212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275940212">(Mar 20 2022 at 01:22)</a>:</h4>
<p>for the Fn() trait family stuff, i think i'm just breaking a lot of assumptions around cachability with the fact that every time you use that now it needs to lint</p>



<a name="275940306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275940306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275940306">(Mar 20 2022 at 01:26)</a>:</h4>
<p>here's the next broken thing i found that i'm trying to work through now:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe(since = </span><span class="s">"TBD"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo0</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[deprecated_safe(since = </span><span class="s">"TBD"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// in the simple case, only the first Box::new() will end up hitting</span>
<span class="c1">// assemble_fn_pointer_candidates, and thus only the first one will lint</span>
<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">foo0</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">foo0</span><span class="p">);</span><span class="w"></span>

<span class="c1">// in the less simple case, every one of these Box:new()'s will end up hitting</span>
<span class="c1">// assemble_fn_pointer_candidates, and thus linting</span>
<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">set_var</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">fn_impl</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">set_var</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="275985142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/275985142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#275985142">(Mar 20 2022 at 20:05)</a>:</h4>
<p>yessssssss!! i finally got the Fn() trait family stuff to lint on every usage <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> it's still a blunt hammer (really, who needs caching anyway?), but it's the first time it's worked for all cases!!</p>
<p><a href="/user_uploads/4715/_tigNj5718nOCeTnzJiz8kqv/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/_tigNj5718nOCeTnzJiz8kqv/image.png" title="image.png"><img src="/user_uploads/4715/_tigNj5718nOCeTnzJiz8kqv/image.png"></a></div><p>time to start rolling back the... <em>unspeakable things</em> i've done to the compiler and then work on a proper solution</p>



<a name="276109658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276109658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276109658">(Mar 21 2022 at 20:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>, i was able to unblock myself and am starting to get things into a somewhat good state now, you can ignore the stream of consciousness above <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="276116725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276116725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276116725">(Mar 21 2022 at 21:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>, i would still love to bounce my current progress off you (or anyone) if you do have a chance at some point though... things seem to be working properly now, and i can mostly justify the changes i've made now, but the trait code is scary and i haven't been able to verify with anyone in the know that i'm even on the right path <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="276125544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276125544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276125544">(Mar 21 2022 at 23:10)</a>:</h4>
<p>i have a (super ugly) <a href="https://github.com/rust-lang/rust/blob/862a10960403fd414b3631c1c8ee8a8246838076/src/test/ui/deprecated-safe/deprecated-safe.rs">ui test</a> that actually passes for the first time! 🥳 basically just a copy of a local file i use for finding new ways to break things</p>



<a name="276215833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276215833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276215833">(Mar 22 2022 at 16:26)</a>:</h4>
<p>I'm looking over my lang team actions items and am circling back around to this now</p>



<a name="276215921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276215921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276215921">(Mar 22 2022 at 16:27)</a>:</h4>
<p>kk, i'm online if you wanna chat about anything</p>



<a name="276405731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276405731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276405731">(Mar 23 2022 at 21:52)</a>:</h4>
<p>i have a functioning <code>since</code> key for <code>#[deprecated_safe]</code> now, the semantics i chose are:</p>
<ul>
<li>outside of libstd <code>since</code> has no semantic meaning, just like <code>#[deprecated]</code> (applies immediately)</li>
<li>within libstd, when called by 3rd party code, <code>since</code> will have meaning (doesn't apply until the since version)</li>
<li>within libstd, when called by libstd itself, <code>since</code> will not have meaning (applies immediately)</li>
</ul>
<p>so libstd can apply the attribute with e.g. a version of "TBD" without affecting 3rd party code, but it will need to update itself immediately</p>
<p>i felt like adding DEPRECATED_SAFE_IN_FUTURE for use within libstd was overkill, but i could do that if it's warranted</p>



<a name="276428261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276428261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276428261">(Mar 24 2022 at 03:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>, i have a couple of forward looking process questions (assuming that <code>#[deprecated_safe]</code> lands)</p>
<ul>
<li>would marking <code>env::set_var</code>/<code>env::remove_var</code> as <code>#[deprecated_safe]</code> needs its own dedicated MCP?</li>
<li>with an unsafe env, unit tests that modify the env will have their unsoundness exposed... a facility to run <em>individual</em> tests in single threaded mode is one possible solution, should that also be an MCP?</li>
<li>how should the new attribute be coordinated with rust-analyzer? i haven't looked at/thought about an implementation there at all yet</li>
</ul>



<a name="276432625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276432625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276432625">(Mar 24 2022 at 04:58)</a>:</h4>
<p><span class="user-mention" data-user-id="127967">@skippy</span> Marking those functions deprecated_safe would take a PR and a libs-api FCP.</p>



<a name="276432633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276432633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276432633">(Mar 24 2022 at 04:59)</a>:</h4>
<p>You would just need to write the PR.</p>



<a name="276433158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276433158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276433158">(Mar 24 2022 at 05:09)</a>:</h4>
<p>thanks! do you think that'd be blocked on having a working rust analyzer implementation as well?</p>



<a name="276433233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276433233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276433233">(Mar 24 2022 at 05:11)</a>:</h4>
<p>(without support  rust analyzer would think the functions became fully unsafe immediately)</p>



<a name="276435859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/276435859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#276435859">(Mar 24 2022 at 06:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/276433158">said</a>:</p>
<blockquote>
<p>thanks! do you think that'd be blocked on having a working rust analyzer implementation as well?</p>
</blockquote>
<p>No, I don't think so.</p>



<a name="277489774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277489774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277489774">(Apr 01 2022 at 23:18)</a>:</h4>
<p>i have a question around ui tests, i want to test that 3rd party code respects the <code>since</code> version when it calls a <code>libstd</code> function marked with <code>#[deprecated_safe]</code></p>
<p>i'm trying to figure out how to write a ui test with code that acts as if it's within <code>libstd</code> (i.e . <code>#![feature(staged_api)]
</code>), and with code that acts as if it's 3rd party... and afaik this can only be done with multiple crates</p>
<p>so i'd like to test that e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(staged_api)]</span><span class="w"></span>
<span class="cp">#![stable(feature = </span><span class="s">"deprecated-safe-test"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>

<span class="cp">#[deprecated_safe(since = </span><span class="s">"99.99.99"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var_2021</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>acts as an entirely safe function to 3rd party code, as the <code>since</code> version hasn't kicked in yet, and <code>since</code> only has semantic effect when used within <code>libstd</code> (this is modelled after <code>#[deprecated]</code>)</p>
<p>i want to be really sure i don't break 3rd party code (aka the world), so i'd really like to test this specific scenario somehow (i've manually verified this just by marking the real <code>set_var</code> temporarily)</p>
<p>are there existing tests that deal with this somehow? this may just be the X+Y problem too and there's a better way to do what i want entirely</p>



<a name="277491673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277491673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277491673">(Apr 01 2022 at 23:50)</a>:</h4>
<p>You're looking for <code>auxiliary</code> crates, search for <code>aux-build</code>.</p>



<a name="277491716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277491716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277491716">(Apr 01 2022 at 23:50)</a>:</h4>
<p>nice, looking <a href="https://rustc-dev-guide.rust-lang.org/tests/compiletest.html#building-auxiliary-crates">here</a> now, thanks!!</p>



<a name="277493524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277493524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277493524">(Apr 02 2022 at 00:19)</a>:</h4>
<p>i've got the ui tests i wanted done up now, thanks again!</p>



<a name="277549031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277549031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277549031">(Apr 02 2022 at 20:08)</a>:</h4>
<p>my diagnostics look more real now <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>
<p>function call:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `set_var` without an unsafe function or block has been deprecated as it is now an unsafe function
   --&gt; /home/skippy/rust/src/test/ui/deprecated-safe/deprecated-safe-third-party.rs:111:5
    |
111 |     set_var("TEST_DEPRECATED_SAFE", "set_var_safe");
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ call to unsafe function
    |
    = note: this function was previously not marked unsafe, but has been marked unsafe since 1.61.0
    = note: consult the function's documentation for information on how to avoid undefined behavior
    = note: reason
</code></pre></div>
<p>normal fn pointer coercion:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `set_var_tbd` as a normal fn pointer has been deprecated as it is now an unsafe function
   --&gt; /home/skippy/rust/src/test/ui/deprecated-safe/deprecated-safe-third-party.rs:159:22
    |
159 |     fn_taking_fn_ptr(set_var_tbd);
    |                      ^^^^^^^^^^^ expected normal fn pointer, found unsafe fn pointer
    |
    = note: this function was previously not marked unsafe, but has been marked unsafe since TBD
    = note: consult the function's documentation for information on how to avoid undefined behavior
    = note: reason
</code></pre></div>
<p>fn trait coercion:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `set_var` as a closure has been deprecated as it is now an unsafe function
   --&gt; /home/skippy/rust/src/test/ui/deprecated-safe/deprecated-safe-third-party.rs:140:30
    |
140 |     fn_taking_dyn_fnmut_impl(Box::new(set_var));
    |                              ^^^^^^^^^^^^^^^^^
    |
    = note: this function was previously not marked unsafe, but has been marked unsafe since 1.61.0
    = note: consult the function's documentation for information on how to avoid undefined behavior
    = note: reason
</code></pre></div>
<p>trait impl:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of trait `PreviouslySafeTraitFuture` without an `unsafe impl` declaration has been deprecated as it is now an unsafe trait
  --&gt; /home/skippy/rust/src/test/ui/deprecated-safe/deprecated-safe-third-party.rs:74:1
   |
74 | impl PreviouslySafeTraitFuture for PreviouslySafeTraitImpl {}
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: this trait was previously not marked unsafe, but has been marked unsafe since 99.99.99
   = note: consult the trait's documentation for information on how to avoid undefined behavior
   = note: reason
</code></pre></div>



<a name="277643606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277643606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277643606">(Apr 03 2022 at 15:42)</a>:</h4>
<p>i could use some advice on how the <code>since</code> version should act with the <code>unsafe</code> signature change of the function/trait</p>
<p>(aside, i'm operating under the assumption that we do in fact want to support unstable/nightly <code>#[deprecated_safe]</code> application within <code>libstd</code>)</p>
<p>i had originally planed to have marking an item as <code>#[deprecated_safe]</code> require also adding <code>unsafe</code> immediately, but now i think this should be tied to the <code>since</code> version (which only has affect within <code>libstd</code>)</p>
<p>i was thinking about things like docs, etc. and that made me think the function signature shouldn't change to <code>unsafe</code> until the <code>#[deprecated_safe]</code> is actually stable</p>
<p>it'd be weird to have the function look <code>unsafe</code> in docs before anything changed about it on stable, and i don't want to play hacky whack-a-mole by tweaking docs, tweaking src browser generation, etc. etc.</p>
<p>the problem is that i now check that <code>unsafe</code> is applied correctly based on the <code>since</code> version, which means that as soon as <code>rustc</code> has its version bumped the <code>unsafe</code> needs to be added, otherwise an error/lint will be emitted saying there's a mismatch and the build breaks (even if just a warning is used)</p>
<p>i'm assuming having builds break just based on a version bump is a Bad Thing and that's a no go? <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>
<p>i could just ignore the incorrect <code>unsafe</code> combination within <code>libstd</code> itself, but then it becomes easy to miss adding <code>unsafe</code> once the <code>#[deprecated_safe]</code> becomes stable...</p>
<p>have there been other lints/things that have had to deal with something like before? where the version bump alone triggers changes that could cause build failures</p>



<a name="277648483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648483">(Apr 03 2022 at 16:37)</a>:</h4>
<p>You want cfg(bootstrap)</p>



<a name="277648486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648486">(Apr 03 2022 at 16:37)</a>:</h4>
<p>Warnings are not breaking changes.</p>



<a name="277648723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648723">(Apr 03 2022 at 16:41)</a>:</h4>
<p>if i run <code>x build</code> then <code>rustc</code> will fail to build if any warnings are emitted, i don't mean breaking changes in the library sense</p>
<p>is that kind of build breakage allowed due to a new warning?</p>



<a name="277648786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648786">(Apr 03 2022 at 16:43)</a>:</h4>
<p>ideally i'd like to have an incorrectly applied <code>unsafe</code> annotation be an outright error too... otherwise it's another weird combination to support/test</p>



<a name="277648808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648808">(Apr 03 2022 at 16:43)</a>:</h4>
<p>but correct/incorrect depends on the actual rustc version</p>



<a name="277648876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648876">(Apr 03 2022 at 16:44)</a>:</h4>
<p>Right, you can use conditional compilation depending on the version using <code>cfg(bootstrap)</code></p>



<a name="277648977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648977">(Apr 03 2022 at 16:47)</a>:</h4>
<p>wouldn't i just break a later stage by doing that?</p>
<p>if i want <code>unsafe</code> to be added once the version ticks over so that <code>since</code> now applies, then disabling the error/lint about missing <code>unsafe</code> during bootstrap would just get me to the next stage where i'd hit that same check and then fail again</p>



<a name="277648985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277648985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277648985">(Apr 03 2022 at 16:47)</a>:</h4>
<p>No, I mean in the standard library itself, not in the compiler</p>



<a name="277649036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649036">(Apr 03 2022 at 16:48)</a>:</h4>
<p>Sorry on mobile or I'd give example code</p>



<a name="277649042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649042">(Apr 03 2022 at 16:48)</a>:</h4>
<p>Sorry on mobile or I'd give example code</p>



<a name="277649054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649054">(Apr 03 2022 at 16:48)</a>:</h4>
<p>But you should emit the lint unconditionally and have the code in libstd switch on the version</p>



<a name="277649071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649071">(Apr 03 2022 at 16:49)</a>:</h4>
<p>ahh, can i <code>#[cfg]</code> on the actual <code>rustc</code> version itself?</p>



<a name="277649073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649073">(Apr 03 2022 at 16:49)</a>:</h4>
<p>that'd definitely sort me out</p>



<a name="277649077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649077">(Apr 03 2022 at 16:49)</a>:</h4>
<p>Yes, you can config on whether it's the bootstrap compiler or not</p>



<a name="277649083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649083">(Apr 03 2022 at 16:49)</a>:</h4>
<p>(you can't cfg on the exact version but you shouldn't need to)</p>



<a name="277649666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649666">(Apr 03 2022 at 17:00)</a>:</h4>
<p>hmmm, i'm still missing something, here's my code</p>
<p>before rustc version reports 1.61.0, the <code>unsafe</code> annotation can't be applied as the attribute is not yet in effect</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[stable(feature = </span><span class="s">"env"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[deprecated_safe(since = </span><span class="s">"1.61.0"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_set_var</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">as_ref</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>as soon as rustc version reports 1.61.0, the <code>unsafe</code> annotation needs to be applied as the attribute is now in effect</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[stable(feature = </span><span class="s">"env"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[deprecated_safe(since = </span><span class="s">"1.61.0"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_set_var</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">as_ref</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>with bootstrap i think you're suggesting this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// unsafe not added yet during bootstrap</span>
<span class="cp">#[cfg(bootstrap)]</span><span class="w"></span>
<span class="cp">#[stable(feature = </span><span class="s">"env"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[deprecated_safe(since = </span><span class="s">"1.61.0"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_set_var</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">as_ref</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// unsafe added after bootstrap</span>
<span class="cp">#[cfg(not(bootstrap))]</span><span class="w"></span>
<span class="cp">#[stable(feature = </span><span class="s">"env"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[deprecated_safe(since = </span><span class="s">"1.61.0"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">_set_var</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">as_ref</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>one of those is guaranteed to fail (either the one with <code>unsafe</code> or the one without), unless the version itself has changed across bootstrapping</p>



<a name="277649717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649717">(Apr 03 2022 at 17:01)</a>:</h4>
<p>does bootstrapping only happen when the version number bumps?</p>



<a name="277649740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277649740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277649740">(Apr 03 2022 at 17:01)</a>:</h4>
<p>(i've only experienced bootstrapping as part of my local dev env)</p>



<a name="277650084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650084">(Apr 03 2022 at 17:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127967">skippy</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/277649717">said</a>:</p>
<blockquote>
<p>does bootstrapping only happen when the version number bumps?</p>
</blockquote>
<p>Rustc first gets compiled using the beta compiler (the bootstrap compiler) and then again using the resulting rustc.</p>



<a name="277650451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650451">(Apr 03 2022 at 17:16)</a>:</h4>
<p>ok, right, i think this is starting to make sense to me... i'm just trying to think through the whole process of how you'd stabilize the attribute</p>



<a name="277650522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650522">(Apr 03 2022 at 17:17)</a>:</h4>
<p>Using <code>#[cfg(bootstrap)]</code> is probably the right approach.</p>



<a name="277650537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650537">(Apr 03 2022 at 17:17)</a>:</h4>
<p>what about removing the <code>#[cfg]</code> after bootstrapping is done? is there a phase where that happens?</p>



<a name="277650602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650602">(Apr 03 2022 at 17:18)</a>:</h4>
<p>The next time the bootstrap compiler is bumped all <code>#[cfg(bootstrap)]</code> things are removed as part of the same PR.</p>



<a name="277650620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650620">(Apr 03 2022 at 17:18)</a>:</h4>
<p>ahh, ok cool</p>



<a name="277650626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650626">(Apr 03 2022 at 17:18)</a>:</h4>
<p>thanks for walking me through this :)</p>



<a name="277650706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277650706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277650706">(Apr 03 2022 at 17:20)</a>:</h4>
<p>this is perfect then, i can just outright error on bad <code>unsafe</code>/<code>since</code> combinations like i wanted</p>



<a name="277663663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277663663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277663663">(Apr 03 2022 at 22:05)</a>:</h4>
<p>things are starting to look fairly good <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span>, i've been writing a ton of ui tests and fixing up some bugs i found</p>



<a name="277664123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277664123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277664123">(Apr 03 2022 at 22:14)</a>:</h4>
<p>is it possible to request a performance run btw? (<a href="https://github.com/rust-lang/rust/pull/95025">PR</a>) i still have a lot of FIXMEs to address, but i'm curious to see what the damage is</p>



<a name="277673593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277673593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277673593">(Apr 04 2022 at 01:58)</a>:</h4>
<p><span class="user-mention" data-user-id="127967">@skippy</span> Done.</p>



<a name="277673605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277673605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277673605">(Apr 04 2022 at 01:59)</a>:</h4>
<p>thanks!</p>



<a name="277753525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277753525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277753525">(Apr 04 2022 at 16:02)</a>:</h4>
<p>it failed because i didn't escape <code>[</code> in one my of <code>///</code> docs:</p>
<p><code>/// This is unsound, but used for backwards compatibility by #[deprecated_safe].</code><br>
to:<br>
<code>/// This is unsound, but used for backwards compatibility by #\[deprecated_safe\].</code></p>
<p>should have been picked up as part of CI?</p>



<a name="277754232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277754232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277754232">(Apr 04 2022 at 16:06)</a>:</h4>
<p>hmm, not a terrible idea to generate compiler docs in PR CI, but it will add more time. in general try builds and PR CI will never be identical because they serve different purposes (try builds generate all dist artifacts). If you want to pursue this ask in <a class="stream" data-stream-id="242791" href="/#narrow/stream/242791-t-infra">#t-infra</a> .</p>



<a name="277754954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277754954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277754954">(Apr 04 2022 at 16:11)</a>:</h4>
<p>thanks, i've made a note to follow up on that after i'm done with the PR</p>
<p>is there a way to replicate a try build locally? i've tried <code>x doc --stage 2</code> with the bad escaping, but i'm not able to reproduce the build error using that</p>



<a name="277755117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755117">(Apr 04 2022 at 16:13)</a>:</h4>
<p>the failure is occurring during whatever step kicks this off, based on the build logs:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">/</span><span class="n">checkout</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">bootstrap</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">rustdoc</span><span class="w"> </span><span class="o">--</span><span class="n">edition</span><span class="o">=</span><span class="mi">2021</span><span class="w"> </span><span class="o">--</span><span class="k">crate</span><span class="o">-</span><span class="k">type</span> <span class="nc">lib</span><span class="w"> </span><span class="o">--</span><span class="k">crate</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="n">rustc_middle</span><span class="w"></span>
</code></pre></div>



<a name="277755150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755150">(Apr 04 2022 at 16:13)</a>:</h4>
<p><span class="user-mention" data-user-id="127967">@skippy</span> you probably need <code>compiler-docs = true</code> in config.toml</p>



<a name="277755173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755173">(Apr 04 2022 at 16:13)</a>:</h4>
<p>and then <code>x doc --stage 2 compiler</code></p>



<a name="277755255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755255">(Apr 04 2022 at 16:14)</a>:</h4>
<p>if you cherry-pick <a href="https://github.com/rust-lang/rust/pull/95449">https://github.com/rust-lang/rust/pull/95449</a> you can change to <code>--stage 0</code></p>



<a name="277755323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755323">(Apr 04 2022 at 16:14)</a>:</h4>
<p><span class="user-mention" data-user-id="127967">@skippy</span> This is a nit, but rather than escaping the square brackets, couldn't you put the whole thing into backquotes, which would also have the advantage of rendering as code?</p>



<a name="277755418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755418">(Apr 04 2022 at 16:15)</a>:</h4>
<p><code>/// This is unsound, but used for backwards compatibility by `#[deprecated_safe]`.</code></p>



<a name="277755529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755529">(Apr 04 2022 at 16:16)</a>:</h4>
<p>ohhhh, that's why it didn't error earlier in some of the other places i didn't escape <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span>, i already had those other places in backquotes</p>



<a name="277755683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277755683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277755683">(Apr 04 2022 at 16:17)</a>:</h4>
<p>and it looks like <code>x doc --stage 2 compiler</code> without any config.toml change lets me reproduce the failure too, thanks <span class="user-mention" data-user-id="232545">@Joshua Nelson</span></p>



<a name="277756479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277756479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277756479">(Apr 04 2022 at 16:23)</a>:</h4>
<p>btw, i thought of a place that i missed last night, so i might as well get that implemented before i request a perf run again</p>
<p>when you apply <code>#[deprecated_safe]</code> to a function in a trait, the actual impl of that function (not callers) needs the same treatment to allow a safe impl of that function</p>



<a name="277759080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277759080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277759080">(Apr 04 2022 at 16:40)</a>:</h4>
<p>i've fixed the docs as suggested too, thanks for the tip!</p>



<a name="277793777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277793777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277793777">(Apr 04 2022 at 21:07)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> , could i try for a perf run again? the docs are fixed, and i implemented that piece of functionality i realized i was missing</p>



<a name="277806004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277806004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277806004">(Apr 04 2022 at 23:06)</a>:</h4>
<p><span class="user-mention" data-user-id="127967">@skippy</span> i queued a perf run for you</p>



<a name="277806040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277806040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277806040">(Apr 04 2022 at 23:06)</a>:</h4>
<p>(well, assuming you meant <a href="https://github.com/rust-lang/rust/issues/95025">#95025</a>, if not then let me know for which PR you need it)</p>



<a name="277806232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277806232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277806232">(Apr 04 2022 at 23:08)</a>:</h4>
<p>that's the one <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span> thanks!</p>



<a name="277818338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277818338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277818338">(Apr 05 2022 at 01:54)</a>:</h4>
<p>looks like there is a perf hit, i'm guessing from having to check for the attribute's presence so much?</p>



<a name="277818434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/277818434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#277818434">(Apr 05 2022 at 01:55)</a>:</h4>
<p><a href="https://perf.rust-lang.org/compare.html?start=60e50fc1cfe0bb693a5f4f93eb83ef70854531e3&amp;end=a2d8496043f5102c3d2993c795f0c30bfe3708a2">perf data</a></p>



<a name="278052794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278052794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278052794">(Apr 06 2022 at 16:47)</a>:</h4>
<p>i'm having some diagnostic issues, due to my arch nemesis the trait obligation code <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span> (for going from e.g. an <code>fn</code> pointer to <code>impl FnOnce()</code>)</p>
<p>i emit the <code>deprecated_safe</code> lint for "bad" obligations when they come in with a cause span to lint against (there are superfluous ones that come in with no span)</p>
<p>however, i found a case in my testing where the only bad obligation i receive has no cause span, and so no lint gets emitted</p>
<p>i have a sort of fix for that now, so the relevant obligation gets a cause span now, but now that's caused me to emit too many diagnostics due to some obligations getting cause spans now that i don't want to lint against (they aren't strictly wrong, just duplicate and unnecessary)</p>
<p>so for this function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe(since = </span><span class="s">"1.61.0"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">depr_safe</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo2</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">depr_safe</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>i get the following diagnostic, which i want:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `deprecated_safe::depr_safe` as a closure has been deprecated as it is now an unsafe function
  --&gt; $DIR/deprecated-safe-bug.rs:48:5
   |
LL |     depr_safe
   |     ^^^^^^^^^
   |
   = note: this function was previously not marked unsafe, but has been marked unsafe since 1.61.0
   = note: consult the function's documentation for information on how to avoid undefined behavior
   = note: reason
</code></pre></div>
<p>but now i'm also getting these diagnostics, which i don't want:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `deprecated_safe::depr_safe` as a closure has been deprecated as it is now an unsafe function
  --&gt; $DIR/deprecated-safe-bug.rs:44:14
   |
LL | fn foo2() -&gt; impl FnOnce() {
   |              ^^^^^^^^^^^^^
   |
   = note: this function was previously not marked unsafe, but has been marked unsafe since 1.61.0
   = note: consult the function's documentation for information on how to avoid undefined behavior
   = note: reason

warning: use of function `deprecated_safe::depr_safe` as a closure has been deprecated as it is now an unsafe function
  --&gt; $DIR/deprecated-safe-bug.rs:44:28
   |
LL |   fn foo2() -&gt; impl FnOnce() {
   |  ____________________________^
LL | |
LL | |
LL | |
LL | |     depr_safe
LL | | }
   | |_^
   |
   = note: this function was previously not marked unsafe, but has been marked unsafe since 1.61.0
   = note: consult the function's documentation for information on how to avoid undefined behavior
   = note: reason
</code></pre></div>
<p>i'm wondering if it's possible to filter my diagnostics to not emit based on what the cause span points to, so i can just filter out the scenarios where it never makes sense to emit the lint for some particular obligation (e.g. when the cause span is an entire body function)</p>
<p>i couldn't find any way to go from a Span to something like a "this is what the span points at" though... is there something like that? i understand that's kind of a weird operation though and probably raises flags... i'd love if there's a Better Way for all this <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="278053527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278053527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278053527">(Apr 06 2022 at 16:52)</a>:</h4>
<p>there's nothing about the obligation themselves i could find to filter out the extra lints either</p>
<p>the obligation for "go from fn() to impl FnOnce()" is the same whether that comes from the actual <code>depr_safe</code> expression or the <code>impl FnOnce()</code> return type</p>
<p>my reasoning with trying to filter out the non-sensical ones based on the span they come from is just that i know i've definitely already emitted the lint elsewhere if i'm trying to emit the lint at e.g. a function return type</p>
<p>but it does feel hokey to me lint or not based on a span like that</p>



<a name="278055308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278055308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278055308">(Apr 06 2022 at 17:04)</a>:</h4>
<p>i'm wondering if it's possible to filter my diagnostics to not emit based on what the cause span points to, so i can just filter out the scenarios where it never makes sense to emit the lint for some particular obligation (e.g. when the cause span is an entire body function)</p>
<p>i couldn't find any way to go from a Span to something like a "this is what the span points at" though... is there something like that? i understand that's kind of a weird operation though and probably raises flags... i'd love if there's a Better Way for all this <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="278055329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278055329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278055329">(Apr 06 2022 at 17:05)</a>:</h4>
<p>there's nothing about the obligation themselves i could find to filter out the extra lints either</p>
<p>the obligation for "go from fn() to impl FnOnce()" is the same whether that comes from the actual <code>depr_safe</code> expression or the <code>impl FnOnce()</code> return type</p>
<p>my reasoning with trying to filter out the non-sensical ones based on the span they come from is just that i know i've definitely already emitted the lint elsewhere if i'm trying to emit the lint at e.g. a function return type</p>
<p>but it does feel hokey to me lint or not based on a span like that</p>



<a name="278058848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278058848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278058848">(Apr 06 2022 at 17:32)</a>:</h4>
<p>(note that if that can work, i'd make the filtering a deny list too as i'd rather receive an "extra placed linted" bug report than a "not linted at all" bug report)</p>



<a name="278069816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278069816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278069816">(Apr 06 2022 at 18:55)</a>:</h4>
<p>fixing these extra diagnostics is the last thing holding me back from being feature complete too (afaik), so close <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="278070682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278070682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278070682">(Apr 06 2022 at 19:01)</a>:</h4>
<p>In general I would not suggest doing anything based on spans, proc macros are free to generate invalid spans</p>



<a name="278073415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278073415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278073415">(Apr 06 2022 at 19:23)</a>:</h4>
<p>oh, that makes me wonder.. all the lint apis seem to be span based, what happens if i emit a lint against an invalid span that a proc macro generated?</p>



<a name="278073700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278073700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278073700">(Apr 06 2022 at 19:26)</a>:</h4>
<p>You end up with <code># note:</code> at the bottom unattached to any source code I think</p>



<a name="278073919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278073919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278073919">(Apr 06 2022 at 19:28)</a>:</h4>
<p>ok cool, it doesn't just disappear into the void then :)</p>



<a name="278074079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278074079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278074079">(Apr 06 2022 at 19:29)</a>:</h4>
<p>you can test by calling <code>span_note(DUMMY_SP, "whatever")</code></p>



<a name="278074758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278074758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278074758">(Apr 06 2022 at 19:34)</a>:</h4>
<p>yeah, i already had  a sketchy <code>.is_dummy()</code> check to know when to lint, so that's definitely not gonna fly</p>



<a name="278074878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278074878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278074878">(Apr 06 2022 at 19:35)</a>:</h4>
<p>i'm trying to lint in a place that makes me 100% sure i've linted whenever the magic backwards compat hack is kicking in</p>



<a name="278075017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278075017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278075017">(Apr 06 2022 at 19:36)</a>:</h4>
<p>but there a lot of <code>fn()</code> to <code>impl FnOnce</code> obligations that get created</p>



<a name="278075457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278075457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278075457">(Apr 06 2022 at 19:39)</a>:</h4>
<p>(all those obligations do in fact need the hack too, it's just they don't necessarily come with lint worthy spans)</p>



<a name="278076328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278076328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278076328">(Apr 06 2022 at 19:47)</a>:</h4>
<p>is_dummy is probably ok for a first draft. As long as it all compiles and mostly works, I would say it's more important to get a initial review than make it perfect - the reviewer may have a suggestion that changes your whole approach.</p>



<a name="278117164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278117164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278117164">(Apr 07 2022 at 04:49)</a>:</h4>
<p>i got it working by making sure the obligations always come in with a cause span when i need them to, and now it doesn't feel like i have a brittle filtering step any more, hooray <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="278117181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278117181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278117181">(Apr 07 2022 at 04:49)</a>:</h4>
<p>the one diagnostic i really didn't like was this one:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `deprecated_safe::depr_safe_future` as a closure has been deprecated as it is now an unsafe function
  --&gt; $DIR/deprecated-safe-future-staged.rs:31:28
   |
LL |   fn foo4() -&gt; impl FnOnce() {
   |  ____________________________^
LL | |
LL | |
LL | |
LL | |     depr_safe_future
LL | | }
   | |_^
   |
   = note: this function was previously not marked unsafe, but has been marked unsafe since 99.99.99
   = note: consult the function's documentation for information on how to avoid undefined behavior
   = note: reason
</code></pre></div>



<a name="278117233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278117233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278117233">(Apr 07 2022 at 04:50)</a>:</h4>
<p>but then i guess that matches the pre-existing:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error[E0277]: `u32` is not a future
  --&gt; $DIR/issues-71798.rs:1:69
   |
LL |   fn test_ref(x: &amp;u32) -&gt; impl std::future::Future&lt;Output = u32&gt; + '_ {
   |  _____________________________________________________________________^
LL | |
LL | |
LL | |     *x
LL | | }
   | |_^ `u32` is not a future
   |
   = help: the trait `Future` is not implemented for `u32`
   = note: u32 must be a future or must implement `IntoFuture` to be awaited
</code></pre></div>



<a name="278117350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278117350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278117350">(Apr 07 2022 at 04:53)</a>:</h4>
<p>it feels weird to me to lint against the function body instead of the return type (and i did find a way to change that), but i guess that may just be fine as is?</p>



<a name="278117422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278117422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278117422">(Apr 07 2022 at 04:54)</a>:</h4>
<p>that's not a big deal either way anyway, the main thing is i have the lint always being emitted now in a way that doesn't feel hokey :)</p>



<a name="278118106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278118106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278118106">(Apr 07 2022 at 05:07)</a>:</h4>
<p>the other slightly odd diagnostic is this one for trait alias impl trait:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>warning: use of function `deprecated_safe::depr_safe` as a closure has been deprecated as it is now an unsafe function
  --&gt; $DIR/deprecated-safe.rs:25:14
   |
LL | type Tait1 = impl FnOnce();
   |              ^^^^^^^^^^^^^
   |
   = note: this function was previously not marked unsafe, but has been marked unsafe since 1.61.0
   = note: consult the function's documentation for information on how to avoid undefined behavior
   = note: reason
</code></pre></div>



<a name="278118170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278118170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278118170">(Apr 07 2022 at 05:08)</a>:</h4>
<p>but again, it seems like i'm just matching how impl trait already works by having the lint show up in multiple places</p>



<a name="278163466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278163466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278163466">(Apr 07 2022 at 13:28)</a>:</h4>
<p>again, I think you've gotten far enough you can open a PR :)</p>



<a name="278164981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278164981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278164981">(Apr 07 2022 at 13:39)</a>:</h4>
<p>yeah, i'm happy enough with what i have now for review, the only reason i went down this whole rabbit hole again was the case i found in my testing where no lint was happening at all (which is bad, but fixed now)</p>
<p>i just need to finish organizing my tests (which is how i found the recent bug), and clean up a few FIXMEs mostly around docs/comments and then i'll take my PR out of the draft state and ping my reviewer</p>



<a name="278166898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278166898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278166898">(Apr 07 2022 at 13:52)</a>:</h4>
<p>Ah, didn't realize you had a draft already open :)</p>



<a name="278372694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278372694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278372694">(Apr 08 2022 at 23:06)</a>:</h4>
<p>i still want to futz around with my tests some more, but i think i have this in a state where review can at least start <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="278372707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278372707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278372707">(Apr 08 2022 at 23:07)</a>:</h4>
<p>just need to rewrite my horrifying commit history first <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="278372820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278372820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278372820">(Apr 08 2022 at 23:08)</a>:</h4>
<p>i won't hold anything up on it, but i didn't notice another place where obligations can come in with dummy cause spans, during codegen</p>



<a name="278372860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278372860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278372860">(Apr 08 2022 at 23:09)</a>:</h4>
<p>i need something like "check if i'm not in codegen" maybe, as i would have long since already linted about it by that point</p>



<a name="278372943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278372943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278372943">(Apr 08 2022 at 23:10)</a>:</h4>
<p>(oddly, the ui tests don't trigger this... maybe optimization level?)</p>



<a name="278374819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278374819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278374819">(Apr 08 2022 at 23:42)</a>:</h4>
<p>edit: messaged the wrong thread! (messages deleted, sorry!)</p>



<a name="278377867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278377867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278377867">(Apr 09 2022 at 00:41)</a>:</h4>
<p>i asked for my review to start <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> thanks for the help &amp; advice along the way!</p>



<a name="278378318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278378318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278378318">(Apr 09 2022 at 00:51)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116083">@pnkfelix</span>, just a heads up that i asked for review to start</p>



<a name="278382202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278382202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278382202">(Apr 09 2022 at 02:18)</a>:</h4>
<p>i did just make a small change that i'm hoping will help with the perf impact</p>
<p>originally i was only checking for #[deprecated_safe] when there was an "unsafe"/"safe" mismatch in syntax, so it would only have to check for the attribute when there would have been a compiler error otherwise</p>
<p>with libstd supporting #[deprecated_safe] at some future date, i had to also start checking safe functions/traits for the attribute so i could pretend the item is unsafe since it would be in the future... so i was always looking up the attribute</p>
<p>the change was just to recognize when i'm not within libstd (the normal case), and just do a purely syntax "unsafe"/"safe" mismatch check again before bothering to lookup the attribute, like i was before</p>
<p>fingers crossed that takes it to basically doing no work unless there would have been a compiler error otherwise</p>



<a name="278384045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384045">(Apr 09 2022 at 03:03)</a>:</h4>
<p>would one ever optimize a function like so, to make the sure a cheap check is nice and cheap?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_deprecation_as_safe</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">DeprecationAsSafeState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// cheap check here</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">unsafety</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hir</span>::<span class="n">Unsafety</span>::<span class="n">Normal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">tcx</span><span class="p">.</span><span class="n">features</span><span class="p">().</span><span class="n">staged_api</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DeprecationAsSafeState</span>::<span class="nb">None</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// rest of function</span>
</code></pre></div>
<p>to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_deprecation_as_safe</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">DeprecationAsSafeState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// cheap check here</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">unsafety</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hir</span>::<span class="n">Unsafety</span>::<span class="n">Normal</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">tcx</span><span class="p">.</span><span class="n">features</span><span class="p">().</span><span class="n">staged_api</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">DeprecationAsSafeState</span>::<span class="nb">None</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">inner</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"> </span>-&gt; <span class="nc">DeprecationAsSafeState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// rest of function</span>
</code></pre></div>



<a name="278384088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384088">(Apr 09 2022 at 03:04)</a>:</h4>
<p>(i know it doesn't make sense to do that without perf results, i'm just thinking out loud)</p>



<a name="278384119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384119">(Apr 09 2022 at 03:05)</a>:</h4>
<p>This is so cheap compared to the rest of the compiler it's not worth micro optimizing</p>



<a name="278384184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384184">(Apr 09 2022 at 03:07)</a>:</h4>
<p>it did seem to have a large-ish impact <a href="https://github.com/rust-lang/rust/pull/95025#issuecomment-1088184699">here</a>, although i could be misreading those results</p>



<a name="278384239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384239">(Apr 09 2022 at 03:09)</a>:</h4>
<p>i'm hoping my latest commit will address that though (it doesn't have silly micro optimizations <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span>, i was just curious about that one)</p>



<a name="278384308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384308">(Apr 09 2022 at 03:10)</a>:</h4>
<p>I mean the <code>if unsafety == ...</code> check, not the whole lint</p>



<a name="278384441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384441">(Apr 09 2022 at 03:14)</a>:</h4>
<p>ahh, i was wondering about trying to make sure that early check was inlined, since 99.99% of the time it will make sure the rest of the function is never called</p>



<a name="278384581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278384581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278384581">(Apr 09 2022 at 03:18)</a>:</h4>
<p>could i request another perf run? (<a href="https://github.com/rust-lang/rust/pull/95025">PR</a>) i'm hoping the impact will be pretty minimal now (without doing any silliness)</p>



<a name="278389512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278389512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278389512">(Apr 09 2022 at 05:36)</a>:</h4>
<p>something i just thought of, should nightly users see unstable <code>#[deprecated_safe]</code> take effect? fixing the warning would mean their code stops compiling on stable, but getting nightly feedback could also be useful</p>



<a name="278395875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278395875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278395875">(Apr 09 2022 at 08:13)</a>:</h4>
<p>I would expect it to take effect the moment it's added, yeah.</p>



<a name="278395898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278395898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278395898">(Apr 09 2022 at 08:13)</a>:</h4>
<p>I don't think deprecations need an unstable period.</p>



<a name="278397145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278397145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278397145">(Apr 09 2022 at 08:34)</a>:</h4>
<p>People will get the <code>unused_unsafe</code> lint if they use an older toolchain, though.  So depending how many people this is expected to affect, it might be nice to have the function suppress that lint for a release first, so that it can compile clean on both.</p>



<a name="278410582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278410582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278410582">(Apr 09 2022 at 13:36)</a>:</h4>
<p>for the calling <code>set_var</code> case you would get <code>unused_unsafe</code> on stable after wrapping in an <code>unsafe</code> block, so no compile errors</p>
<p>but if you applied <code>#[deprecated_safe]</code> to a trait then changing <code>impl Bla for ...</code> to <code>unsafe impl Bla for ...</code> would cause a compile error on stable vs nightly</p>



<a name="278410923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278410923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278410923">(Apr 09 2022 at 13:45)</a>:</h4>
<p>i was modelling the <code>since</code> behavior after <code>#[rustc_deprecated]</code>, which you can apply "unstably" to get <code>deprecated_in_future</code> within libstd itself, but this is easy enough to remove if we don't want it</p>



<a name="278411110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278411110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278411110">(Apr 09 2022 at 13:48)</a>:</h4>
<p>you wouldn't get <code>deprecated_in_future</code> just by using nightly however, it's only for within libstd</p>



<a name="278411890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278411890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278411890">(Apr 09 2022 at 14:07)</a>:</h4>
<p>an example where unstable feedback might be helpful, based on trying to apply this to <code>set_var</code>/<code>remove_var</code></p>
<p>i got a <code>deprecated_safe_in_future</code> warning in a <code>#[test]</code> item, but there's nothing i can do to make that sound, we don't have any way to make individual tests run in single threads (currently...)</p>
<p>so i end up just "fixing" it like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// FIXME(skippy) there's no fix for deprecated_safe until tests can be run single threaded</span>
<span class="cp">#[allow(deprecated_safe_in_future)]</span><span class="w"></span>
<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">"RUN_TEST_NEW_ENV2"</span><span class="p">,</span><span class="w"> </span><span class="s">"456"</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>which is no worse than the status quo unsoundness today, and at least <code>allow(deprecated_safe)</code> can be grepped for</p>
<p>but running into that issue and getting a proper solution in place first, like running specific tests single threaded, means we don't encourage users to just <code>#[allow(deprecated_safe)]</code> with a FIXME comment that there's nothing they can do</p>
<p>another example was some code that i think will always get run in a single thread (<code>test_main_static_abort</code>), so if i had a way to just <code>assert!(number_of_threads() == 1)</code> before the <code>remove_var</code> call, i could make it sound as well... but there's no <code>number_of_threads</code> function currently</p>



<a name="278413275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278413275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278413275">(Apr 09 2022 at 14:42)</a>:</h4>
<p>insta-stable does make things simpler though if stability support is overkill, then there's nothing to figure out about how it should behave</p>



<a name="278415450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278415450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278415450">(Apr 09 2022 at 15:32)</a>:</h4>
<p>it just occurred to me that updating your code to fix the <code>deprecated_safe</code> warning is essentially updating your MSRV to whenever the relevant <code>#[deprecated_safe]</code> was added</p>
<p>i think this is ok though? if you run with an older toolchain, you'll either get a superfluous <code>unused_unsafe</code> or just error out completely... you couldn't miscompile</p>



<a name="278415805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278415805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278415805">(Apr 09 2022 at 15:41)</a>:</h4>
<p>(the compiler errors would only occur when the def/impl unsafety of a trait/trait function mismatch, so not actually relevant to <code>set_var</code>)</p>



<a name="278416042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278416042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278416042">(Apr 09 2022 at 15:46)</a>:</h4>
<p>oh, actually, i guess that means MSRV only bumps in the trait def/impl case specifically... there's no bump for free functions</p>



<a name="278416450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278416450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278416450">(Apr 09 2022 at 15:55)</a>:</h4>
<p>just to spell out what happens for older toolchains if you fix the <code>deprecated_safe</code> warning on a free function:</p>
<p>you wrap the the function call in an <code>unsafe</code> block:</p>
<ul>
<li>older toolchain sees: unnecessary unsafe</li>
<li>older toolchain result: emits <code>unused_unsafe</code>, not a breaking change</li>
</ul>
<p>you change a <code>fn()</code> pointer to be an <code>unsafe fn()</code> pointer:</p>
<ul>
<li>older toolchain sees: <code>fn()</code> to <code>unsafe fn()</code> pointer coercion</li>
<li>older toolchain result: you were always allowed to do this, no <code>unused_unsafe</code></li>
</ul>
<p>you stop coercing the function to a closure (since closures can't be made unsafe at all):</p>
<ul>
<li>older toolchain sees: whatever non-closure alternative you came up with</li>
<li>older toolchain result: no change, unless the alternative itself bumped MSRV</li>
</ul>



<a name="278471314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278471314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278471314">(Apr 10 2022 at 14:34)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>, do you think i should just rip the <code>since</code> based stability checking out? it's minor and easy enough to add back if we ever wanted it (plus i could delete all the "in future" copies of my tests)</p>



<a name="278471535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278471535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278471535">(Apr 10 2022 at 14:37)</a>:</h4>
<p>i also took another look at my perf results, apparently there's detailed results when you click the percentages <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
<p>it looks like all my perf hit is just in encoding the <code>DepreactionAsSafeEntry</code> entry (akin to <code>DeprecationEntry</code>), penalizing <code>generate_crate_metadata</code></p>
<p>i'm wondering if maybe i don't need <code>DepreactionAsSafeEntry</code> at all and i'm copying unneeded complexity using <code>#[rustc_deprecated/deprecated]</code> as an example... i'm gonna look at how some other attributes are handled</p>



<a name="278479547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278479547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278479547">(Apr 10 2022 at 17:22)</a>:</h4>
<p>Don't go on my suggestion alone here. I personally don't think it's needed, but others on the team may disagree, and I don't object to having it. <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> Thoughts on having a "since" version in deprecated_safe?</p>



<a name="278479994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278479994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278479994">(Apr 10 2022 at 17:31)</a>:</h4>
<p>if we do keep it, there's also the question of whether we want nightly users to see the attribute take effect while it's unstably applied</p>
<p><code>#[rustc_deprecated]</code> only uses <code>deprecated_in_future</code> for internal libstd use, for example, nightly users wouldn't see anything</p>



<a name="278487281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278487281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278487281">(Apr 10 2022 at 20:08)</a>:</h4>
<p>(btw, i have some changes locally now that don't change the crate metadata encoding to add a <code>DeprecationAsSafeEntry</code>, i'm hoping that'll finally drop the perf impact to zero)</p>



<a name="278490523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278490523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278490523">(Apr 10 2022 at 21:23)</a>:</h4>
<p>could i have another perf run (<a href="https://github.com/rust-lang/rust/pull/95025">PR</a>)? i hope i'm not asking for too many <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="278490536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278490536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278490536">(Apr 10 2022 at 21:23)</a>:</h4>
<p><a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/perf.20run">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/perf.20run</a></p>



<a name="278490581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278490581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278490581">(Apr 10 2022 at 21:24)</a>:</h4>
<p>thanks! didn't know that existed</p>



<a name="278499999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278499999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278499999">(Apr 11 2022 at 01:23)</a>:</h4>
<p>i think the <a href="https://github.com/rust-lang/rust/pull/95025#issuecomment-1094444873">perf results</a> are acceptable now</p>



<a name="278600868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278600868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278600868">(Apr 11 2022 at 18:55)</a>:</h4>
<p>here's an <a href="https://github.com/rust-lang/rust/pull/95942/commits/ec958a9641f3a8247360221a9647b6805c64aa21">example</a> of what dealing with unsafe <code>set_var</code>/<code>remove_var</code> looks like within libstd</p>
<p>some places i could fix, some i had to <code>#[allow]</code> with a FIXME comment</p>



<a name="278623064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278623064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278623064">(Apr 11 2022 at 22:02)</a>:</h4>
<p>i'm looking a bit at what we'd need to make <code>#[test]</code> code sound, and i think we need a single process per affected test, not just a single thread (as a previously run test in the same process could have spun up environment reading/writing threads in the background)</p>
<p>it looks like there's existing infrastructure for running tests in an isolated process thanks to <a href="https://github.com/rust-lang/rust/issues/67650">-Zpanic-abort-tests</a> that could be piggy backed off of</p>
<p>would adding that isolation ability for <code>#[test]</code> code be a compiler MCP? and am i getting ahead of myself if i start looking at that while i wait for review on my main PR?</p>



<a name="278637686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278637686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278637686">(Apr 12 2022 at 01:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147/near/278479547">said</a>:</p>
<blockquote>
<p><span class="user-group-mention silent" data-user-group-id="1977">T-lang</span> Thoughts on having a "since" version in deprecated_safe?</p>
</blockquote>
<p>Could there maybe be a thread separation for the lang question?  There's alot in here about things like improving the PR perf that make it harder to find the context to reply to the question.</p>



<a name="278696455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Add%20%23%5Brustc_deprecated_safe%5D%20attribute%20to%20all%E2%80%A6%20lang-team%23147/near/278696455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147.html#278696455">(Apr 12 2022 at 13:59)</a>:</h4>
<p>sorry, i've been messaging a lot <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>
<p>i can create a new topic for just this question, should that go under the <code>t-lang/major changes</code> stream before i put something in the wrong place again? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> or just <code>t-lang</code>?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>