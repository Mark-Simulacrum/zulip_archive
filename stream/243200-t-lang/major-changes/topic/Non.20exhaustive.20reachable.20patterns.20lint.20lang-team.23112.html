<html>
<head><meta charset="utf-8"><title>Non exhaustive reachable patterns lint lang-team#112 · t-lang/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/index.html">t-lang/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html">Non exhaustive reachable patterns lint lang-team#112</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="246709756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/246709756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#246709756">(Jul 21 2021 at 12:06)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/lang-team/issues/112">Non exhaustive reachable patterns lint #112</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="246751026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/246751026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#246751026">(Jul 21 2021 at 17:23)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="1977">@T-lang</span>: Proposal <a href="https://github.com/rust-lang/lang-team/issues/112#issuecomment-884359258">#112</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<a name="247068177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/247068177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#247068177">(Jul 24 2021 at 10:40)</a>:</h4>
<p>I've been working on two options, there is now a WIP lint inside <a href="http://usefulness.rs">usefulness.rs</a> and a normal lint (using the LateLintPass mechanics). There is a rather large problem in the normal lint, it cannot detect guards or or-patterns, basically it would have to use/reimplement parts of the mechanics of <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/check_match.rs">check_match</a>. It seems to me that adding the lint to the usefulness and check_match files makes sense.</p>
<p>I was able to make the lint work for <a href="https://github.com/DevinR528/rust/commit/df377ca309fd5acf1a3dcdcb90ecdfef9578eafb">enums</a> but am having trouble with structs and variants with fields <a href="https://github.com/DevinR528/rust/commits/useful-reachable">WIP commits</a> (first commit is the normal lint, the second two are an enum impl in usefulness and the start of me exploring for structs). For struct/variant fields I'm not really sure how to go about checking for the attribute (either place, see bellow) or the best way to skip the <code>..</code> rest/wildcard-ish and check for missing fields.</p>
<p>The other issue is where the attribute should be placed? In the <a href="https://github.com/rust-lang/rust/issues/84332">issue</a> as well as the <code>non_exhaustive</code> PR <a href="https://github.com/rust-lang/rust/issues/44109#issuecomment-521781237">comments</a> it was mentioned adding the attribute to the wildcard in a match</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">Bar</span>::<span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Bar</span>::<span class="n">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">    </span><span class="n">Bar</span>::<span class="n">B</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[deny(reachable)]</span><span class="w"> </span><span class="c1">// attribute goes here or on the expression</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// triggers lint "missing Bar::C..."</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The problem with this is that it's struct counterpart  isn't exactly valid <a href="https://github.com/rust-lang/rust/issues/81282">issue</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[warn(reachable)]</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="w"> </span><span class="c1">// triggers lint "missing field `c`..."</span>
<span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">structure</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>So the options, at least what I can come up with, are to make this valid or put the attribute on the expr/stmt instead of the wild patterns.</p>
<p>I also opened a compiler-team MCP <a href="https://github.com/rust-lang/compiler-team/issues/445">https://github.com/rust-lang/compiler-team/issues/445</a> should I close this or is this needed also?</p>



<a name="247094954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/247094954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#247094954">(Jul 24 2021 at 21:34)</a>:</h4>
<p>I don't know if you need a compiler MCP too, but I think the questions about <code>LateLintPass</code> vs something else are better in a compiler stream of some sort, since I at least have no idea how to answer those :P</p>
<p>As for the location (which I think <em>is</em> a lang question, though doesn't need to be resolved in the MCP), my question would be whether it could ever make sense on things like other arms than the last one.</p>
<p>For example, it could be phrased</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[warn(unmentioned_field)]</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">structure</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>since it's not like you'd want the "reachable" on other parts of the pattern, as far as I understand.  (And I think I prefer that form to the one that expands out all the fields to different lines.)</p>



<a name="247187674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/247187674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#247187674">(Jul 26 2021 at 10:55)</a>:</h4>
<blockquote>
<p>whether it could ever make sense on things like other arms than the last one.</p>
</blockquote>
<p>This is a good point, I agree that it probably won't ever be used on anything other than the last (wildcard). I wonder if it makes the intent more clear on the wildcard/rest pattern (like the examples in my above message)? Since it would be a whole thing to add the ability to put the attribute on struct rest patterns (<code>..</code>) I'm leaning towards putting the attribute on the expr/stmt as you showed in your example for structs and enums but this isn't a strong preference.</p>
<p>Is the next step waiting for the MCP to finish it's 10 days before discussing specifics or are we waiting on me to come up with a full implementation so it's easier to see pros/cons?</p>



<a name="247272882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/247272882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#247272882">(Jul 26 2021 at 22:37)</a>:</h4>
<p>Lints aren't a forever promise, so I think you should consider the MCP as "you're good to go on implementing it".  If some of the details change over the course of implementing that's fine.</p>
<p>Personally I see it more as a "make sure you don't waste time doing something that people will want to not happen at all" than something you strictly need to wait for.</p>



<a name="247273155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/247273155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#247273155">(Jul 26 2021 at 22:40)</a>:</h4>
<p>(Especially for something that's allow-by-default, right?  If you wanted to turn on something heuristic that would start warning on "did you maybe intend to add a case for qqqqqq?" then people would probably want another check-in before it turns on, but for an opt-in lint I suspect that the compiler folks will give plenty of review in PR if there's better ways of doing something.)</p>



<a name="247317718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/247317718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#247317718">(Jul 27 2021 at 10:51)</a>:</h4>
<p>Cool sounds good thanks!! Back to learning all the ins and outs of usefulness checking <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> hehe</p>



<a name="249513812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/249513812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#249513812">(Aug 15 2021 at 13:52)</a>:</h4>
<p>For anyone interested there is now a working PR for this lint! It does only work with enums and only top-level <code>non_exhaustive</code> enums at that.  <a href="https://github.com/rust-lang/rust/pull/86809">https://github.com/rust-lang/rust/pull/86809</a></p>



<a name="249799346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/249799346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#249799346">(Aug 18 2021 at 01:53)</a>:</h4>
<p>How would this work in the case of <code>#[doc(hidden)]</code> or <code>#[unstable]</code> enum variants? Those should probably be ignored as they aren't part of the public api, but it does make the <code>_</code> reachable,  making <code>deny(reachable)</code> very confusing.</p>



<a name="249897118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/249897118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#249897118">(Aug 18 2021 at 19:02)</a>:</h4>
<p>I think the lint should only trigger when the user could write new arms just before the <code>_</code> and have them be reachable. This would be the case for  new stable variants, but not unstable variants (unless maybe the corresponding feature gate is enabled)</p>



<a name="250067353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250067353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250067353">(Aug 20 2021 at 01:14)</a>:</h4>
<p>Is there anyone who is familiar with the <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1205">compute_match_usefulness</a> workings to point me where to look to ignore the "wildcard" when constructing a <code>witness</code>. I wonder if ignoring each wildcard for any type marked <code>non_exhaustive</code> with a <code>#[deny(non_exhaustive_reachable_pattern)]</code> attribute wold work. My problem is that I can check in <code>compute_match_usefulness</code> or <code>is_useful</code> but I need to check deeper than "top-level". I was able to make it work for enums but only flat top-level variants where the enum is marked <code>non_exhaustive</code> but nothing else (could be marked and the check work).</p>
<p><a href="https://github.com/rust-lang/rust/pull/86809">PR</a></p>



<a name="250069829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250069829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250069829">(Aug 20 2021 at 02:04)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> would be a good person to ask</p>



<a name="250087457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250087457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250087457">(Aug 20 2021 at 07:41)</a>:</h4>
<p>I would indeed, I know the code very well</p>



<a name="250087513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250087513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250087513">(Aug 20 2021 at 07:41)</a>:</h4>
<p>Lemme try to understand what's happening</p>



<a name="250087879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250087879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250087879">(Aug 20 2021 at 07:47)</a>:</h4>
<p>I haven't yet understood what you've done, but a general warning about this code is: to make something work nested is much harder than making it work top-level</p>



<a name="250087930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250087930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250087930">(Aug 20 2021 at 07:48)</a>:</h4>
<p>It really is a tricky piece of code</p>



<a name="250088250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250088250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250088250">(Aug 20 2021 at 07:53)</a>:</h4>
<p>So what do you want to do? Filtering out some wildcards when constructing witnesses sounds doable: in one of the functions that call apply_constructor, whenever one of the fields is a wildcard you want to skip then you skip the whole witness</p>



<a name="250088348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250088348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250088348">(Aug 20 2021 at 07:54)</a>:</h4>
<p>I'd be surprised if that's what you wanted to do though: the feature shouldn't be changing any of the usefulness reports, it should only emit a lint sometimes</p>



<a name="250088427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250088427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250088427">(Aug 20 2021 at 07:55)</a>:</h4>
<p>Also I expect that non_exhaustive enums and structs need to be treated very differently. It's actually quite a different feature. You don't need other match arms to know if a struct wildcard is reachable so that one should be easy. The enum case is the tricky one</p>



<a name="250088849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250088849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250088849">(Aug 20 2021 at 08:01)</a>:</h4>
<p>(Plz mention my name when you reply, because I will only be checking my notifications)</p>



<a name="250089135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250089135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250089135">(Aug 20 2021 at 08:04)</a>:</h4>
<p>If I understand correctly, currently you're removing the NonExhaustive constructor when the lint should be triggered, so that the relevant wildcard would be considered unreachable. Then I imagine you want to detect this and emit the new lint instead?</p>



<a name="250089520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250089520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250089520">(Aug 20 2021 at 08:10)</a>:</h4>
<p>As you've probably noticed, your wild_reachable check can only be done at the top-level. To go deeper you'd need much more complex logic that would duplicate usefulness code. Indeed, detecting when a pattern is reachable is already what usefulness does! Somehow you'll need to reuse that but I don't see how just yet</p>



<a name="250109585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250109585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250109585">(Aug 20 2021 at 12:12)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>So what I have (that probably won't work) is:</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/blob/5d354fb75e39b30c9952124937490a9aed64697c/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1286-L1299">check if it's non_exhaustive and has a wildcard</a></li>
<li><a href="https://github.com/rust-lang/rust/blob/5d354fb75e39b30c9952124937490a9aed64697c/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1313-L1318">if it is and were at the <code>_</code> don't push to the matrix</a></li>
<li><a href="https://github.com/rust-lang/rust/blob/5d354fb75e39b30c9952124937490a9aed64697c/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L929">have <code>SplitWildcards</code> return the variant list if reachable_non_exhaustive (variants minus wildcard)</a></li>
<li><a href="https://github.com/rust-lang/rust/blob/5d354fb75e39b30c9952124937490a9aed64697c/compiler/rustc_mir_build/src/thir/pattern/check_match.rs#L258">emit the lint</a></li>
</ul>
<p>I'm finding that this is too destructive to anything else that uses this (see <a href="https://github.com/rust-lang/rust/blob/5d354fb75e39b30c9952124937490a9aed64697c/compiler/rustc_mir_build/src/thir/pattern/check_match.rs#L232-L240">this</a> as an example of messing up other lints/errors). What I'm wonder about now is if I should just implement the lint using the <code>LateLintPass</code> trait. I can make the <code>compute_match_usefulness</code> pub and change the arms or fields before I call <code>compute_match_usfulness</code> <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
<p>I'm gonna check out if this is even possible I'll keep you up to date on my progress.</p>



<a name="250112388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250112388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250112388">(Aug 20 2021 at 12:44)</a>:</h4>
<p>Hm you should be able to do it without changing the matrix or the witnesses. Lemme try to explain.<br>
What usefulness does is kind of trying all possible values and seeing if there's any value that isn't caught by a match arm. What your lint needs is to detect when an enum variant is caught by a wildcard. Sounds doable with the current code.<br>
Let's be more precise. To make non_exhaustive work, we add a fake NonExhaustive variant to the enum, but then treat it like a normal enum. I think you understand so far. Whenever there's a wildcard for our enum type, the code will try to specialize in turn with each variant, to see if it's useful. That's where we can lint! If a variant (that is not NonExhaustive) from a non_exhaustive enum is found useful for a wildcard, that's when we should lint. You should be able to observe that in is_useful somewhere.<br>
There's just one problem with that: <a href="https://github.com/rust-lang/rust/blob/9ccf661694423895b02e513c69e6ad263b2f3d8e/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L923">this line</a> is a cheat that says "let's pretend the enum only has the fake variant" to go faster. As you correctly noticed for your case we need the real variants too; that cheat won't work anymore. So we have to add back the real variants before we can do what I described above.<br>
Am I making sense?</p>



<a name="250112631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250112631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250112631">(Aug 20 2021 at 12:46)</a>:</h4>
<p>I expect removing the cheat will change the text of error messages sadly. That's harder to fix, but if we can get everything else to work that'd be great already</p>



<a name="250250642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250250642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250250642">(Aug 22 2021 at 02:50)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> <br>
I think I have a general understanding, my specifics are a the problem. So if we change <code>SplitwildCard::new</code> to return the full set of variants when appropriate we end up triggering <code>unreachable_pattern</code> for the <code>_ =&gt; {}</code> arm. I am not quite sure of the next steps after getting the list of variants. Is <code>Matrix::specialize_constructor</code> the only method that does any filtering of variants that aren't covered? How do I collect the variants that are matched by the wildcard and are __not__ part of the pattern stack (arms of the match)?</p>



<a name="250251111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250251111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250251111">(Aug 22 2021 at 03:02)</a>:</h4>
<p>Isn't this <a href="https://github.com/rust-lang/rust/blob/9ccf661694423895b02e513c69e6ad263b2f3d8e/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1236">https://github.com/rust-lang/rust/blob/9ccf661694423895b02e513c69e6ad263b2f3d8e/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1236</a> the only check for patterns that are missing in the arms (match is not exhaustive) although this is only for regular enums and structs (not non_exhaustive)</p>



<a name="250262179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250262179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250262179">(Aug 22 2021 at 08:11)</a>:</h4>
<p>We need to make Splitwildcard::new return the full set of variants _plus_ the NonExhaustive variant, indeed otherwise we'll get the wrong result</p>



<a name="250262307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250262307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250262307">(Aug 22 2021 at 08:15)</a>:</h4>
<p>The line you show is indeed where match exhaustiveness is computed; arm_usefulness is about arm reachability. This is not only for regular enums and structs, this applies to any patterns</p>



<a name="250262901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250262901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250262901">(Aug 22 2021 at 08:32)</a>:</h4>
<blockquote>
<p>Is <code>Matrix::specialize_constructor</code> the only method that does any filtering of variants that aren't covered?</p>
</blockquote>
<p>Yep</p>
<blockquote>
<p>How do I collect the variants that are matched by the wildcard and are __not__ part of the pattern stack (arms of the match)?</p>
</blockquote>
<p>You should be able to do that <a href="https://github.com/rust-lang/rust/blob/9ccf661694423895b02e513c69e6ad263b2f3d8e/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1161">here</a>: if <code>v_ctor</code> is a wildcard, for an enum you care about, and <code>ctor</code> is a variant, then <code>usefulness</code> will tell you whether <code>ctor</code> is matched by the wildcard or by a previous arm. I thought there was a <code>Usefulness::is_useful</code> method but apparently I deleted it; you'll have to figure it out from what compute_match_usefulness does.<br>
Btw in is_useful the pattern stack is the current arm and the matrix is the previous arms.</p>



<a name="250267697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250267697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250267697">(Aug 22 2021 at 10:40)</a>:</h4>
<p>Another potential footgun: <a href="https://github.com/rust-lang/rust/blob/9ccf661694423895b02e513c69e6ad263b2f3d8e/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L913">this line</a> stops trying new constructors when we know they won't change anything. This might interfere with what you're trying to do. You can comment that line while you're testing</p>



<a name="250284135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250284135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250284135">(Aug 22 2021 at 17:17)</a>:</h4>
<p>Not gonna ping you since I'm sure I'll have more questions and you'll see this:</p>
<p>THANK YOU for the help! Also much respect for writing this section of the compiler wow! well done.</p>



<a name="250708697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250708697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250708697">(Aug 26 2021 at 01:50)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>Well I'm still pretty stumped I came up with this <a href="https://github.com/rust-lang/rust/compare/master...DevinR528:comp-use">https://github.com/rust-lang/rust/compare/master...DevinR528:comp-use</a></p>
<ul>
<li>return all variants when needed (non_exhausted enum with lint attr) in <code>Splitwildcard::new</code></li>
<li>in <code>compute_match_usefulness</code> we check for missing variants <a href="https://github.com/DevinR528/rust/blob/4b5d4f4f7f0044b4ddfffe4754bf4b124d7592b9/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1251-L1260">here</a></li>
</ul>
<p>I realize I'm just doing a variation on what I had before but I for the life of me cannot figure out how to get/compare a list of patterns (the seen arms of a match) against a wildcard except from a high at the end of <code>compute_match_usefulness</code> that's the only place I see where you have all the info you need to make the comparison. this at least accomplishes the task without being destructive of the other checks the <code>thir::pattern</code> mod does.</p>



<a name="250740220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/250740220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#250740220">(Aug 26 2021 at 08:34)</a>:</h4>
<p>You should have all the info you need from within <code>is_useful</code>; the only problem is figuring out what form it takes. In particular you won't exactly get a list of seen patterns, it'll be things about constructors.<br>
First you care about a wildcard pattern for some particular enum type. For that you can test that <code>v_ctor.is_wildcard()</code> and that <code>pcx.ty</code> is a non_exhaustive enum. Then you want to see if the wildcard is reachable with a constructor other than <code>NonExhaustive</code>. Here <code>v_ctor.split(..)</code> will return a list of possible constructors, so you only have to see if one of them is reachable and isn't <code>NonExhaustive</code>.  You can check that by looking if <code>ctor</code> is <code>NonExhaustive</code> and checking if <code>usefulness</code> says that <code>ctor</code> was useful. Then you can emit your lint (<code>pcx.span</code> will be the span of the wildcard).</p>



<a name="251096986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251096986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251096986">(Aug 29 2021 at 01:53)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> <br>
Ok, I think I'm getting closer to what you want! This is now all done in <code>is_useful</code> and the methods called within. <a href="https://github.com/rust-lang/rust/compare/master...DevinR528:comp-use">new diff</a></p>
<ul>
<li><code>Splitwildcard::new</code> still returns the variants + <code>NonExhaustive</code> when enum + <code>non_exhaustive</code></li>
<li><code>Usefulness::WithWitness { exhaustive: Vec&lt;Witness&gt;, non_exhaustive: Vec&lt;Witness&gt; }</code> so non_exhaustive collects the patterns that are useful aganist the wildcard (whats missing in the match if you ignore the <code>_</code>) this is only toplevel</li>
<li>we add missed patterns to Usefulness via <a href="https://github.com/rust-lang/rust/compare/master...DevinR528:comp-use#diff-1812b3836d7a3c164bf3a9f917fc16487795aaaffeecb836f6d9f0096aec9ae5R974-R983"><code>Usefulness::apply_constructor</code></a> which we do only if enum + non_exhaustive</li>
</ul>
<p>I'm now trying to get struct <code>let Foo { a, b, .. } = Foo::default()</code> to work, it seems maybe a similar thing would work...</p>



<a name="251115938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251115938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251115938">(Aug 29 2021 at 08:15)</a>:</h4>
<p>that looks a bit better :) That won't work though, because you're storing the results in the WithWitnesses case. But when checking a given arm we're always in the NoWitnesses case. WithWitnesses is only for the fake extra arm we add to check exhaustiveness</p>



<a name="251116554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251116554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251116554">(Aug 29 2021 at 08:25)</a>:</h4>
<p>you could add some tests where the pattern isn't at the toplevel</p>



<a name="251117587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251117587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251117587">(Aug 29 2021 at 08:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/251096986">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="245339">Nadrieril</span> <br>
I think I'm getting closer to what you want!</p>
</blockquote>
<p>Were my pointers above not explicit enough to get you there? If you tried them, did they work?</p>



<a name="251148989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251148989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251148989">(Aug 29 2021 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span>  <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/250740220">said</a>:</p>
<blockquote>
<p>so you only have to see if one of them is reachable and isn't <code>NonExhaustive</code>.  You can check that by looking if <code>ctor</code> is <code>NonExhaustive</code> and checking if <code>usefulness</code> says that <code>ctor</code> was useful. Then you can emit your lint (<code>pcx.span</code> will be the span of the wildcard).</p>
</blockquote>
<p><code>ctor</code> never stays <code>NonExhaustive</code> it's converted to <code>Missing</code> is this what I should be looking for or change <code>Splitwildcard::into_ctors</code> to preserve the <code>NonExhaustive</code>?  <code>is_useful</code> gives the variants that are caught by the pattern right, so we still need to compute <code>enum_variants - known_patterns</code>to give us the patterns that we need to show?</p>
<p>I'm not sure how or where to find these missing patterns? Do I need to alter <code>Usefulness::NoWitnesses(SubPatSet)</code> or could I just emit the lint in <code>Usefulness::apply_constructor</code> using the  same thing as the 3rd bullet point point in my msg above (moving the check for <code>Missing</code> and <code>new_patterns</code> building outside of the match, this still doesn't get nested enums but I'm not sure we want to, this way it is consistent with the <code>non_exhaustive</code> patterns lint <a href="https://doc.rust-lang.org/stable/error-index.html#E0004">https://doc.rust-lang.org/stable/error-index.html#E0004</a> ? </p>
<p>I think the biggest problem is you are super familiar with the code and I'm taking everything you say very literally because I'm not as familiar <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> so without a bit more specific do this here or change this method to do this kinda thing I might not comfortable enough with the code to get what your thinking. Thanks for the patients!</p>



<a name="251149103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251149103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251149103">(Aug 29 2021 at 18:23)</a>:</h4>
<p>For context the new <code>Usefulness::apply_constructor</code> would look like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">apply_constructor</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">pcx</span>: <span class="nc">PatCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">p</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">matrix</span>: <span class="kp">&amp;</span><span class="nc">Matrix</span><span class="o">&lt;'</span><span class="na">p</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// used to compute missing ctors</span>
<span class="w">    </span><span class="n">ctor</span>: <span class="kp">&amp;</span><span class="nc">Constructor</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ctor_wild_subpatterns</span>: <span class="kp">&amp;</span><span class="nc">Fields</span><span class="o">&lt;'</span><span class="na">p</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">is_wildcard</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">new_pats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="fm">matches!</span><span class="p">(</span><span class="n">ctor</span><span class="p">,</span><span class="w"> </span><span class="n">Constructor</span>::<span class="n">Missing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">split_wildcard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SplitWildcard</span>::<span class="n">new</span><span class="p">(</span><span class="n">pcx</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">split_wildcard</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="n">matrix</span><span class="p">.</span><span class="n">head_ctors</span><span class="p">(</span><span class="n">pcx</span><span class="p">.</span><span class="n">cx</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">missing_pats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_wildcard</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">iter_missing</span><span class="p">(</span><span class="n">pcx</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">missing_ctor</span><span class="o">|</span><span class="w"> </span><span class="n">Fields</span>::<span class="n">wildcards</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="n">missing_ctor</span><span class="p">).</span><span class="n">apply</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="n">missing_ctor</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">pcx</span><span class="p">.</span><span class="n">cx</span><span class="p">.</span><span class="n">is_foreign_non_exhaustive_enum</span><span class="p">(</span><span class="n">pcx</span><span class="p">.</span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">is_wildcard</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">witnesses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">missing_pats</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Must remove the wildcard for `non_exhaustive` enums</span>
<span class="w">                </span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="fm">matches!</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">PatKind</span>::<span class="n">Wild</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">cloned</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">witnesses</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">non_exhaustive_reachable_match</span><span class="p">(</span><span class="n">pcx</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">pcx</span><span class="p">.</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">pcx</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="n">pcx</span><span class="p">.</span><span class="n">hir_id</span><span class="p">,</span><span class="w"> </span><span class="n">witnesses</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">missing_pats</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// same as before }</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="251150009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150009">(Aug 29 2021 at 18:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/251148989">said</a>:</p>
<blockquote>
<p><code>ctor</code> never stays <code>NonExhaustive</code> it's converted to <code>Missing</code></p>
</blockquote>
<p>Ohhh oops you're right. That must have made it more confusing sorry &gt;&lt;. This is getting harder than I thought.<br>
Your <code>apply_constructor</code> looks good, but you'll have the same problem as before: it's only called in the <code>WithWitnesses</code> case. I guess we could indeed only catch it at toplevel for now, and think of a cleverer solution later.</p>



<a name="251150500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150500">(Aug 29 2021 at 18:47)</a>:</h4>
<p>Doesn't it catch it for both? Or is there something else that stops it. Actually now that I'm thinking about it I'm not sure why it doesn't work nested I'm ignoring the different Usefulness variants <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span>‍♂️</p>



<a name="251150514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150514">(Aug 29 2021 at 18:47)</a>:</h4>
<p>Here's an idea. We replace <code>Missing</code> with <code>Missing(Vec&lt;Constructor&gt;)</code> that stores the list of missing constructors. (We used to do that a while ago). That way we can know if a <code>Missing</code> stands for only <code>NonExhaustive</code> or also for some real variants.<br>
So in <code>is_useful</code>, if <code>pcx.ty</code> is an enum we care about, and <code>ctor</code> is <code>Missing(missings)</code>, and <code>missings</code> contains a real variant, and <code>ctor</code> is useful, then that means a real variant was caught by the wildcard.</p>



<a name="251150597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150597">(Aug 29 2021 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/251150500">said</a>:</p>
<blockquote>
<p>Doesn't it catch it for both? Or is there something else that stops it. Actually now that I'm thinking about it I'm not sure why it doesn't work nested I'm ignoring the different Usefulness variants <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span>‍♂️</p>
</blockquote>
<p>Nah the two sentences were unrelated. Usefulness variants don't have to do with nesting, they have to do with whether we're analyzing an actual pattern from a match arm or the fake final wildcard used to check exhaustiveness.</p>



<a name="251150632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150632">(Aug 29 2021 at 18:49)</a>:</h4>
<p>In our case we only care about patterns written by the user in a match arm, so we'll only see <code>NoWitnesses</code></p>



<a name="251150728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150728">(Aug 29 2021 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/251148989">said</a>:</p>
<blockquote>
<p>I think the biggest problem is you are super familiar with the code</p>
</blockquote>
<p>Yeah, that and the algorithm is a specific kind of convoluted that takes a while to grasp :/</p>



<a name="251150841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251150841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251150841">(Aug 29 2021 at 18:53)</a>:</h4>
<p>Would you prefer it if I gave you more explicit instructions? I can do that too</p>



<a name="251151508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251151508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251151508">(Aug 29 2021 at 19:04)</a>:</h4>
<p>I think the instructions for our new Missing(missed) should be good to get me going then I should have more detail/specific questions. Should be able to give it another go in a few hours.</p>
<p>Any ideas for structs I feel like that's going to require a larger change of the  Fields struct maybe?</p>



<a name="251153320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251153320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251153320">(Aug 29 2021 at 19:39)</a>:</h4>
<p>Hm, for structs I was thinking it should be a ton easier. It's just syntactic, right? If we see <code>Foo { a, b, .. }</code> and <code>Foo</code> has a <code>c</code> field then we lint. This doesn't depend on other patterns or anything like it</p>



<a name="251153804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251153804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251153804">(Aug 29 2021 at 19:49)</a>:</h4>
<p>For <code>Missing(missed)</code> here's the idea. We change <code>Missing</code> to <code>Missing(Vec&lt;Constructor&gt;)</code>, and at first the only things that need to change is where we return <code>Missing</code>, in <code>SplitWildcard::into_ctors</code>. There we'll return <code>Missing(self.iter_missing().collect())</code>. So far tests should pass the same.<br>
Then after <a href="https://github.com/rust-lang/rust/blob/daa4dc997c777676b0f0e48d0311cc5e7bde5f87/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1161">this line</a> we'll want to check if 1/ <code>pcx.ty</code> is a non_exhaustive enum; 2/ <code>ctor</code> is <code>Missing(missed)</code>; 3/ <code>missed</code> contains more than just <code>NonExhaustive</code>; 4/ <code>usefulness</code> is <code>NoWitnesses(set)</code> with <code>!set.is_empty()</code>. If all those conditions hold then we lint.</p>



<a name="251153900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251153900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251153900">(Aug 29 2021 at 19:51)</a>:</h4>
<p>I expect this will have a negative perf impact because we construct that new <code>Vec</code> all the time. If it does we can be more clever but let's get everything working first</p>



<a name="251170106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251170106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251170106">(Aug 30 2021 at 00:36)</a>:</h4>
<p>Would this be a place to add the struct check then <a href="https://github.com/rust-lang/rust/blob/daa4dc997c777676b0f0e48d0311cc5e7bde5f87/compiler/rustc_typeck/src/check/pat.rs#L1185">https://github.com/rust-lang/rust/blob/daa4dc997c777676b0f0e48d0311cc5e7bde5f87/compiler/rustc_typeck/src/check/pat.rs#L1185</a></p>



<a name="251171841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251171841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251171841">(Aug 30 2021 at 01:08)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> <br>
YAY!!! Nesting works! I reset my old branch to the new one and pushed to the PR <a href="https://github.com/rust-lang/rust/pull/86809">https://github.com/rust-lang/rust/pull/86809</a></p>
<p>I'm gonna keep looking into structs I think you may be right, it would of been a pain to do it in usefulness but I think just checking syntactically should be enough.</p>



<a name="251191873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251191873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251191873">(Aug 30 2021 at 07:15)</a>:</h4>
<p>Yay!! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="251192174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251192174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251192174">(Aug 30 2021 at 07:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/251170106">said</a>:</p>
<blockquote>
<p>Would this be a place to add the struct check then <a href="https://github.com/rust-lang/rust/blob/daa4dc997c777676b0f0e48d0311cc5e7bde5f87/compiler/rustc_typeck/src/check/pat.rs#L1185">https://github.com/rust-lang/rust/blob/daa4dc997c777676b0f0e48d0311cc5e7bde5f87/compiler/rustc_typeck/src/check/pat.rs#L1185</a></p>
</blockquote>
<p>Definitely looks like it</p>



<a name="251193271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251193271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251193271">(Aug 30 2021 at 07:31)</a>:</h4>
<p>There's also an error we created by listing all variants. We should be able to fix that in <code>apply_constructor</code> as follows: if <code>iter_missing</code> contains a <code>NonExhaustive</code>, then we set <code>new_patterns</code> to be a single wildcard, otherwise we continue as before.</p>



<a name="251217155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251217155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251217155">(Aug 30 2021 at 11:48)</a>:</h4>
<p>oops, the perf impact is really bad <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="251219612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251219612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251219612">(Aug 30 2021 at 12:07)</a>:</h4>
<p>We could maybe construct the <code>missed</code> vec only when the lint is active? Is that easy to check?</p>



<a name="251220243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251220243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251220243">(Aug 30 2021 at 12:13)</a>:</h4>
<p>Yeah it shouldn't be too bad, I was actually doing that now, sort of. We can check <code>cx.tcx.lint_level()</code> with the <code>HirId</code> which I added to <code>PatCtxt</code> so yea we can even check it inside <code>into_ctors</code>.</p>



<a name="251220350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251220350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251220350">(Aug 30 2021 at 12:14)</a>:</h4>
<p>Can I run the perf thing? Is there a way to run benchmarks locally for just this section of the compiler?</p>



<a name="251224243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251224243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251224243">(Aug 30 2021 at 12:52)</a>:</h4>
<p><span class="user-mention" data-user-id="243877">@DevinR528</span> yes, there are instructions on <a href="https://github.com/rust-lang/rustc-perf/tree/master/collector">https://github.com/rust-lang/rustc-perf/tree/master/collector</a></p>



<a name="251224282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251224282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251224282">(Aug 30 2021 at 12:52)</a>:</h4>
<p>You can run just the "match-stress" benchmark by itself</p>



<a name="251225024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251225024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251225024">(Aug 30 2021 at 12:59)</a>:</h4>
<p>That <code>Missing(vec![])</code> is going to cause errors. Plz remember to change it to <code>Missing(Option&lt;Vec&lt;Constructor&gt;&gt;)</code> when you're done testing</p>



<a name="251279945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/251279945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#251279945">(Aug 30 2021 at 19:17)</a>:</h4>
<p>Any idea which <code>apply_constructors</code> this refers to "trying to apply the <code>Missing</code> constructor; this should have been done in <code>apply_constructors</code>" <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L1269">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L1269</a></p>
<p>We have somewhat of a chicken and egg problem, when we have <code>Missing(None)</code> we need to reconstruct the missing fields using <code>SplitWildcard::new/split</code> in <code>Usefulness::apply_constructor</code> but that just gives us another <code>Missing(None)</code> so we end up with panicking <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L1268">here</a>. This worked when we always constructed the missing variants (<code>Missing(Vec&lt;..&gt;)</code>) but now that we only do it for the lint when we actually need missing variants for <code>non_exhaustive</code> types we have none. Would it be best to add another <code>SplitWildcard::split</code> that constructs the missing variants without using the <code>Constructor::Missing(..)</code> so for the times we actually need the missing variants in the old way we can build them? Or you got a better way of getting around this?</p>
<p>The problem is that this ends up changing the error message of <code>match non_exhaustive_enum {}</code> from listing the fields to just saying missing <code>_</code> because the way I temporarily fixed the panic is returning <code>Pat::wildcard_from_ty</code> which is where the wrong error message comes from.</p>
<p>Setting up the rustc-perf thing so I can make informed choices about how to proceed.</p>



<a name="252017002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252017002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252017002">(Sep 04 2021 at 18:14)</a>:</h4>
<p>Oops didn't see this</p>



<a name="252017022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252017022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252017022">(Sep 04 2021 at 18:14)</a>:</h4>
<p>It refers to Usefulness::apply_constructor I think, is there another one?</p>



<a name="252017131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252017131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252017131">(Sep 04 2021 at 18:16)</a>:</h4>
<p>We should not have a chicken-and-egg problem because Missing used to carry no information and that worked fine. You removed the relevant code when we switched to Missing(Vec&lt;&gt;) but you can just add it back</p>



<a name="252017166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252017166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252017166">(Sep 04 2021 at 18:17)</a>:</h4>
<p>The difference with what you're saying is that we use SplitWildcard::iter_missing in apply_constructors, which never generates a Missing</p>



<a name="252025222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252025222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252025222">(Sep 04 2021 at 20:47)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>Isn't the relevant code that I removed <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L943-L964">this</a> in which case I can't just add it back because the combo of <code>SplitWildcard::new / split</code> is what creates the <code>Constructor::Missing(..)</code> variant so when I do it like <a href="https://github.com/rust-lang/rust/blob/c242ef0e9b9156345a467f19fdc79c988478859a/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L949-L978">this</a> I get the same problem so I end up just always using <code>missing</code> like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">new_patterns</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">missed</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Constructor</span>::<span class="n">NonExhaustive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="n">Fields</span>::<span class="n">wildcards</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Constructor</span>::<span class="n">NonExhaustive</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Constructor</span>::<span class="n">NonExhaustive</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">missed</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">missing_ctor</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Fields</span>::<span class="n">wildcards</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="n">missing_ctor</span><span class="p">).</span><span class="n">apply</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="n">missing_ctor</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>I was able to get the enum stress bench down to like 30% and most everything else about even with the above in <code>Usefulness::apply_constructor</code> but having to collect all the missing variants if there is any missing kills us, I think, from adding more profiling calls in this section of code the worst part seems to be </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">into_ctors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pcx</span>: <span class="nc">PatCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">SmallVec</span><span class="o">&lt;</span><span class="p">[</span><span class="n">Constructor</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_guard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcx</span><span class="p">.</span><span class="n">cx</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">timer</span><span class="p">(</span><span class="s">"into_ctors"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">any_missing</span><span class="p">(</span><span class="n">pcx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">report_when_all_missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcx</span><span class="p">.</span><span class="n">is_top_level</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">IntRange</span>::<span class="n">is_integral</span><span class="p">(</span><span class="n">pcx</span><span class="p">.</span><span class="n">ty</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ctor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">matrix_ctors</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">report_when_all_missing</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">matrix_ctors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">matrix_ctors</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Missing</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">all_ctors</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="n">ctor</span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="n">ctor</span><span class="p">.</span><span class="n">is_covered_by_any</span><span class="p">(</span><span class="n">pcx</span><span class="p">,</span><span class="w"> </span><span class="n">matrix_ctors</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">collect</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Wildcard</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">smallvec</span><span class="o">!</span><span class="p">[</span><span class="n">ctor</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">all_ctors</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p>I think, is there another one?</p>
</blockquote>
<p>There is also <code>Witness::apply_constructor</code> but I doubt that would make sense so your right.</p>



<a name="252034964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252034964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252034964">(Sep 04 2021 at 23:51)</a>:</h4>
<blockquote>
<p>Isn't the relevant code that I removed <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L943-L964">this</a> in which case I can't just add it back.</p>
</blockquote>
<p>The bit that adds Missing is SpltiWildcard::into_ctors, but the code you point to uses SplitWildcard::iter_missing. They do quite different things. So you can add back that code no problem</p>



<a name="252035125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252035125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252035125">(Sep 04 2021 at 23:54)</a>:</h4>
<p>Ok collecting all the variants is what's slow, I'm not surprised. So we should only do it when we need to, i.e. when pcx.ty is a non_exhaustive enum and the lint is active</p>



<a name="252230295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252230295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252230295">(Sep 06 2021 at 22:54)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>Ok so I was able to get perf back to a reasonable range (under +5% instructions and I went green on some of the timing measurements) I didn't have to change it much since I think I was looking in the wrong place. Anyway if CI goes green another perf run would be great, thanks! I'll attach screen shots of my run now.</p>



<a name="252230305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252230305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252230305">(Sep 06 2021 at 22:54)</a>:</h4>
<p><a href="/user_uploads/4715/MyQIKvjXVA3u3QHUAAj0diDU/rustc-perf-inst.png">rustc-perf-inst.png</a> <a href="/user_uploads/4715/laMweEWLREPgDh-GaotObNfQ/rustc-perf.png">rustc-perf.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/MyQIKvjXVA3u3QHUAAj0diDU/rustc-perf-inst.png" title="rustc-perf-inst.png"><img src="/user_uploads/4715/MyQIKvjXVA3u3QHUAAj0diDU/rustc-perf-inst.png"></a></div><div class="message_inline_image"><a href="/user_uploads/4715/laMweEWLREPgDh-GaotObNfQ/rustc-perf.png" title="rustc-perf.png"><img src="/user_uploads/4715/laMweEWLREPgDh-GaotObNfQ/rustc-perf.png"></a></div>



<a name="252230359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252230359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252230359">(Sep 06 2021 at 22:56)</a>:</h4>
<p>The second picture is "Comparing cpu-clock"</p>



<a name="252236035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252236035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252236035">(Sep 07 2021 at 00:29)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/86809">https://github.com/rust-lang/rust/pull/86809</a> so you don't have to search for the PR link</p>



<a name="252331539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331539">(Sep 07 2021 at 16:23)</a>:</h4>
<p>Hm, 6% on unicode_normalization is still too much for such a niche feature :/</p>



<a name="252331707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331707">(Sep 07 2021 at 16:24)</a>:</h4>
<p>(deleted: misunderstood)</p>



<a name="252331769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331769">(Sep 07 2021 at 16:24)</a>:</h4>
<p>Nah that'd be cheating, the perf impact is real</p>



<a name="252331835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331835">(Sep 07 2021 at 16:25)</a>:</h4>
<p>But it's ok because we still have the option I suggested the other day: only build the list of constructors when we'll need it</p>



<a name="252331900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331900">(Sep 07 2021 at 16:25)</a>:</h4>
<p>(Sorry, I misunderstood your comment; you meant "on the <code>unicode_normalization</code> benchmark component", not "on unicode normalization within the compiler".)</p>



<a name="252331929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331929">(Sep 07 2021 at 16:25)</a>:</h4>
<p>Oh right ^^</p>



<a name="252331945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252331945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252331945">(Sep 07 2021 at 16:25)</a>:</h4>
<p>Makes more sense</p>



<a name="252332683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252332683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252332683">(Sep 07 2021 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span>  do you know if only non_exhaustive lints need the missing ctors in the warnings/error messages. The problem I was trying to avoid is that Split wildcard::split calls into_ctors which is what gives Missing when we have a wildcard ctor</p>



<a name="252332755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252332755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252332755">(Sep 07 2021 at 16:31)</a>:</h4>
<p>I can try to give links when I'm back to my desk in 20 min or so</p>



<a name="252333325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252333325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252333325">(Sep 07 2021 at 16:35)</a>:</h4>
<p>the normal "this match is not exhaustive" also needs the list of missing constructors, but since it's rarely triggered we rebuild the SplitWildcards for that purpose</p>



<a name="252333408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252333408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252333408">(Sep 07 2021 at 16:35)</a>:</h4>
<p>your new lint is the only one that needs the missing ctors as part of the logic and not just the messages</p>



<a name="252333872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252333872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252333872">(Sep 07 2021 at 16:38)</a>:</h4>
<p>one thing we could easily do: instead of <code>Missing(Vec&lt;&gt;)</code>, we do <code>Missing { more_than_one: bool }</code> that stores whether there's exactly one constructor missing or more than one. That's enough info to decide whether to lint, and then we can rebuild the list of missing constructors in the rare case that we need it</p>



<a name="252334072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252334072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252334072">(Sep 07 2021 at 16:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/252332683">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="245339">Nadrieril</span>  do you know if only non_exhaustive lints need the missing ctors in the warnings/error messages. The problem I was trying to avoid is that Split wildcard::split calls into_ctors which is what gives Missing when we have a wildcard ctor</p>
</blockquote>
<p>I don't understand this. <code>SplitWildcard::split</code> doesn't call <code>into_ctors</code>. And we really can't avoid <code>Missing</code> in the general case, it's used absolutely all the time (hence the perf impact)</p>



<a name="252334489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252334489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252334489">(Sep 07 2021 at 16:43)</a>:</h4>
<p>So it might not matter but here goes <a href="https://github.com/rust-lang/rust/blob/7265e2c697c8acee89d10561a6ba24138df2dd98/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L1015">SplitWildcard::split</a> calls <a href="https://github.com/rust-lang/rust/blob/7265e2c697c8acee89d10561a6ba24138df2dd98/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L731">Constructor::split</a> which when it's a wildcard calls <a href="https://github.com/rust-lang/rust/blob/7265e2c697c8acee89d10561a6ba24138df2dd98/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L743">SplitWildcard::into_ctor</a></p>



<a name="252334778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252334778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252334778">(Sep 07 2021 at 16:45)</a>:</h4>
<p>ah I see. The comment in <code>SplitWildcard::split</code> explains it: <code>all_ctors</code> never contains a wildcard, so this never actually happens</p>



<a name="252339642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252339642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252339642">(Sep 07 2021 at 17:17)</a>:</h4>
<p>If I try to reconstruct the <code>SplitWildcard</code> in <code>apply_constructor</code> (so only constructing all the missing for foreign non_exhaustive) I run into this <a href="https://github.com/rust-lang/rust/blob/7265e2c697c8acee89d10561a6ba24138df2dd98/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L1302">https://github.com/rust-lang/rust/blob/7265e2c697c8acee89d10561a6ba24138df2dd98/compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs#L1302</a></p>



<a name="252340056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252340056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252340056">(Sep 07 2021 at 17:20)</a>:</h4>
<p>Maybe here <a href="https://github.com/rust-lang/rust/blob/master/library/core/src/num/dec2flt/mod.rs#L238">https://github.com/rust-lang/rust/blob/master/library/core/src/num/dec2flt/mod.rs#L238</a> the ICE says <code>num::dec2flt::dec2flt</code>?</p>



<a name="252340469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252340469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252340469">(Sep 07 2021 at 17:23)</a>:</h4>
<p>The above happens when <code>apply_constructor</code> looks like <a href="https://github.com/rust-lang/rust/blob/c242ef0e9b9156345a467f19fdc79c988478859a/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L939">this</a></p>



<a name="252343211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252343211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252343211">(Sep 07 2021 at 17:42)</a>:</h4>
<p>huh that's really weird</p>



<a name="252343271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252343271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252343271">(Sep 07 2021 at 17:42)</a>:</h4>
<p>particularly since that apply_constructor is essentially the same as the current one, which obviously doesn't trigger this error</p>



<a name="252343550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252343550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252343550">(Sep 07 2021 at 17:44)</a>:</h4>
<p>This is why I was confused about SplitWildcard</p>



<a name="252343694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252343694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252343694">(Sep 07 2021 at 17:45)</a>:</h4>
<p>Since that's the only difference between the apply_constructors</p>



<a name="252343840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252343840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252343840">(Sep 07 2021 at 17:46)</a>:</h4>
<p>yeah that's very confusing</p>



<a name="252344618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252344618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252344618">(Sep 07 2021 at 17:52)</a>:</h4>
<p>The other thing that's odd is that it now should only ever be <code>Missing(Some())</code> when there is a <code>Constructor::NonExhaustive</code> present so why it every hits the else is beyond me...</p>



<a name="252344625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252344625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252344625">(Sep 07 2021 at 17:52)</a>:</h4>
<p>just checking, it's commit <a href="https://github.com/rust-lang/rust/commit/c242ef0e9b9156345a467f19fdc79c988478859a">c242ef0e9b9156345a467f19fdc79c988478859a</a>, with a diff that looks like <a href="https://github.com/rust-lang/rust/compare/59ce76548484806ac4970c57c0bb6ad9e53b80f6..c242ef0e9b9156345a467f19fdc79c988478859a">this</a>?</p>



<a name="252344679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252344679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252344679">(Sep 07 2021 at 17:52)</a>:</h4>
<p>correct</p>



<a name="252344840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252344840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252344840">(Sep 07 2021 at 17:53)</a>:</h4>
<p>sure there's not a lingering change where you typoed <code>missing_ctor</code> into <code>ctor</code> by any chance?</p>



<a name="252344965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252344965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252344965">(Sep 07 2021 at 17:54)</a>:</h4>
<p>because I really don't understand how that can happen</p>



<a name="252345613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252345613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252345613">(Sep 07 2021 at 17:58)</a>:</h4>
<p>did you look at the stack trace? which call of <code>Fields::apply</code> triggers the error?</p>



<a name="252349052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252349052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252349052">(Sep 07 2021 at 18:21)</a>:</h4>
<blockquote>
<p>sure there's not a lingering change where you typoed <code>missing_ctor</code> into <code>ctor</code> by any chance?</p>
</blockquote>
<p>I'm pretty sure this didn't happen</p>
<p>It's the <code>Fields::apply</code> call inside of <code>Usefulness::apply_constructors</code> <a href="https://github.com/rust-lang/rust/compare/59ce76548484806ac4970c57c0bb6ad9e53b80f6..c242ef0e9b9156345a467f19fdc79c988478859a#diff-1812b3836d7a3c164bf3a9f917fc16487795aaaffeecb836f6d9f0096aec9ae5R965">here</a></p>



<a name="252350043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252350043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252350043">(Sep 07 2021 at 18:28)</a>:</h4>
<p>Wait that's not true ughhh, it's <code>Witness::apply_construcor</code> <a href="https://github.com/rust-lang/rust/blob/7265e2c697c8acee89d10561a6ba24138df2dd98/compiler/rustc_mir_build/src/thir/pattern/usefulness.rs#L1058">here</a></p>



<a name="252352075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252352075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252352075">(Sep 07 2021 at 18:42)</a>:</h4>
<p>YAY I fixed that problem now on to </p>
<div class="codehilite"><pre><span></span><code>-       error[E0004]: non-exhaustive patterns: `_` not covered
+       error[E0004]: non-exhaustive patterns: `Unit`, `Tuple(_)`, `Struct { .. }` and 1 more not covered
20        --&gt; $DIR/enum.rs:23:11
21         |
22      LL |     match enum_unit {};

-          |           ^^^^^^^^^ pattern `_` not covered
+          |           ^^^^^^^^^ patterns `Unit`, `Tuple(_)`, `Struct { .. }` and 1 more not covered
24         |
25         = help: ensure that all possible cases are being handled, possibly by adding wildcards or more match arms
26         = note: the matched value is of type `NonExhaustiveEnum`, which is marked as non-exhaustive
</code></pre></div>



<a name="252355763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252355763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252355763">(Sep 07 2021 at 19:03)</a>:</h4>
<p>Fixed that too but now I think it's worse instruction count wise? I'll do some more checking and push a commit if I think I've made progress</p>



<a name="252376969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252376969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252376969">(Sep 07 2021 at 21:52)</a>:</h4>
<p>Oh wow how did you fix it?</p>



<a name="252377177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252377177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252377177">(Sep 07 2021 at 21:54)</a>:</h4>
<p>I suggest you don't try to use whatever is carried by <code>Missing</code> in apply_constructor. This is cold code, we can afford to rebuild every time for simplicity's sake</p>



<a name="252377415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252377415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252377415">(Sep 07 2021 at 21:57)</a>:</h4>
<p>let me know if you want a perf run</p>



<a name="252377987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252377987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252377987">(Sep 07 2021 at 22:02)</a>:</h4>
<p>I don't think <code>into_ctors</code> is hot enough to be sensitive to an extra branch there. However I remember that the stress tests are sentitive to the size of <code>pcx</code> so that might be the cause ^^'. You don't need pcx.hir_id, try to remove it to see if that makes a difference</p>



<a name="252378170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252378170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252378170">(Sep 07 2021 at 22:04)</a>:</h4>
<p>another possible explanation is that <code>is_foreign_non_exhaustive_enum</code> could be slow, I don't know what kind of queries it involves</p>



<a name="252383887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252383887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252383887">(Sep 07 2021 at 23:07)</a>:</h4>
<blockquote>
<p>Oh wow how did you fix it?</p>
</blockquote>
<p>I was calling <code>Fields::wildcards / apply</code> when I shouldn't have in <code>Usefulness::apply_constructor</code> now revert to the old behavior when <code>Missing(None)</code> which works</p>
<p>Ok according to my perf I'm at exactly 0.00% for a few of the enum stress tests</p>



<a name="252444551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252444551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252444551">(Sep 08 2021 at 11:38)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> <br>
Should be ready for a perf run, it should pass this time according to my local perf run. Any idea why they would be different, one of the runs was like &gt;5% less instructions locally than in the CI run?</p>



<a name="252445135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252445135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252445135">(Sep 08 2021 at 11:42)</a>:</h4>
<p>Hm, one of the things I think are different between local and CI are compilation options. Incremental and other details like compilation units might differ and change what optimizations LLVM can do</p>



<a name="252445287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252445287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252445287">(Sep 08 2021 at 11:43)</a>:</h4>
<p>Makes sense, I figured out just enough to make the rustc-perf work but didn't go further than that.</p>



<a name="252445365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252445365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252445365">(Sep 08 2021 at 11:44)</a>:</h4>
<p>is the link <a href="https://github.com/rust-lang/rust/pull/86809">https://github.com/rust-lang/rust/pull/86809</a> helpful</p>



<a name="252445512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252445512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252445512">(Sep 08 2021 at 11:45)</a>:</h4>
<p>I was just reading your last commit</p>



<a name="252445639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252445639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252445639">(Sep 08 2021 at 11:46)</a>:</h4>
<p>Ahh sorry I know it always takes me a while to find my PR if I close the tab <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="252445722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252445722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252445722">(Sep 08 2021 at 11:46)</a>:</h4>
<p>Haha it would have but you had given me the link a few messages back so I used that ^^</p>



<a name="252446045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252446045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252446045">(Sep 08 2021 at 11:49)</a>:</h4>
<p>I'm excited to merge this soon I'm planning on giving myself a Ferris (the rust crab) tattoo once its done <span aria-label="crab" class="emoji emoji-1f980" role="img" title="crab">:crab:</span>.</p>



<a name="252446108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252446108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252446108">(Sep 08 2021 at 11:50)</a>:</h4>
<p>Woah that's dedication ^^</p>



<a name="252446117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252446117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252446117">(Sep 08 2021 at 11:50)</a>:</h4>
<p>I only have a Ferris plushie</p>



<a name="252446168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252446168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252446168">(Sep 08 2021 at 11:50)</a>:</h4>
<p>Haha yeah!!</p>



<a name="252446221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252446221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252446221">(Sep 08 2021 at 11:51)</a>:</h4>
<p>I will have a few more comments once we're sure the perf is ok</p>



<a name="252446646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252446646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252446646">(Sep 08 2021 at 11:54)</a>:</h4>
<p>Yeah I figured there were a few rough spots still, and the warning message could probably be imporoved/bikeshedded.</p>



<a name="252447457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252447457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252447457">(Sep 08 2021 at 12:01)</a>:</h4>
<p>Lemme check the logic of <code>missing_non_exhaustive</code>. It says "the enum is marked non_exhaustive and also there's some real variant that's missing", right? The logic looks sound but the naming is unclear. Maybe <code>nonexhaustive_enum_missing_real_variants</code>?</p>



<a name="252447544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252447544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252447544">(Sep 08 2021 at 12:01)</a>:</h4>
<p>Yeah, that's the logic and I would agree on the name</p>



<a name="252447594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252447594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252447594">(Sep 08 2021 at 12:02)</a>:</h4>
<p>Or you could compute something that's less specific to non_exhaustive, I don't mind either way</p>



<a name="252610953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252610953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252610953">(Sep 09 2021 at 11:44)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>I renamed it to your suggested name and fixed a few other things but it seems there was a download failure when trying to run rustc-perf <a href="https://github.com/rust-lang-ci/rust/runs/3544186219#step:26:20848">https://github.com/rust-lang-ci/rust/runs/3544186219#step:26:20848</a></p>



<a name="252611296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252611296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252611296">(Sep 09 2021 at 11:47)</a>:</h4>
<p>ok, I'll retry</p>



<a name="252656815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252656815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252656815">(Sep 09 2021 at 16:42)</a>:</h4>
<p>We did it!! perf regressions are gone.</p>



<a name="252814737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252814737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252814737">(Sep 10 2021 at 16:41)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>Should I squash all the commits for easier reviewing, or maybe separate them into enum/struct lint <br>
and a third for the UI testing stuff and other misc changes?</p>



<a name="252821187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252821187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252821187">(Sep 10 2021 at 17:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/252656815">said</a>:</p>
<blockquote>
<p>We did it!! perf regressions are gone.</p>
</blockquote>
<p>Yay! Well done</p>



<a name="252821376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252821376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252821376">(Sep 10 2021 at 17:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/252814737">said</a>:</p>
<blockquote>
<p>maybe separate them into enum/struct lint and a third for the UI testing stuff and other misc changes?</p>
</blockquote>
<p>Oh yeah that'd be convenient, thanks. That's not required though, you can also just squash</p>



<a name="252822287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252822287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252822287">(Sep 10 2021 at 17:37)</a>:</h4>
<p>ping me when you're done and I'll have a look</p>



<a name="252824927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252824927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252824927">(Sep 10 2021 at 17:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/252656815">said</a>:</p>
<blockquote>
<p>We did it!! perf regressions are gone.</p>
</blockquote>
<p>congrats! That's awesome :D</p>



<a name="252851590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252851590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252851590">(Sep 10 2021 at 21:15)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="232545">@Joshua Nelson</span>  I'm glad I got this far <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span>  squashed into 3 commits </p>
<ul>
<li>enums + the lint declaration</li>
<li>structs</li>
<li>ui test stuff</li>
</ul>



<a name="252856301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252856301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252856301">(Sep 10 2021 at 21:59)</a>:</h4>
<p>Lovely, that does make it a lot easier to review :)</p>



<a name="252863618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252863618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252863618">(Sep 10 2021 at 23:20)</a>:</h4>
<p>Review done. I hope I'm not overwhelming you with nitpicks. The only real thing we need to fix is error messages</p>



<a name="252863794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252863794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252863794">(Sep 10 2021 at 23:22)</a>:</h4>
<p>I'm starting to like the idea of "matched explicitly". Like "this lint detects when some fields/variants are not matched explicitly" etc</p>



<a name="252863851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252863851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252863851">(Sep 10 2021 at 23:23)</a>:</h4>
<p>We could rename it to something like <code>non_exhaustive_implicit_pattern</code></p>



<a name="252863952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252863952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252863952">(Sep 10 2021 at 23:24)</a>:</h4>
<p>Now that I think about it, the current lint name isn't very clear</p>



<a name="252864430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252864430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252864430">(Sep 10 2021 at 23:31)</a>:</h4>
<p>Hm actually, "explicit" isn't what it does. The lint would trigger for</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Foo</span>::<span class="n">A</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>even if Foo has only one variant, right?</p>



<a name="252864642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252864642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252864642">(Sep 10 2021 at 23:33)</a>:</h4>
<p>Wait no it doesn't, because Missing would only contain NonExhaustive here. I think. Cool, that would mean we really are talking about implicit variants</p>



<a name="252864759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252864759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252864759">(Sep 10 2021 at 23:34)</a>:</h4>
<p>Could you add the test above? It's an interesting one, because that differs from the original idea in <a href="https://github.com/rust-lang/rust/issues/84332">#84332</a> of a "reachable" lint</p>



<a name="252905373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252905373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252905373">(Sep 11 2021 at 12:13)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span></p>
<p>Yeah you are right about the single variant enum, it does not trigger the lint. I added it as a test also.</p>
<p>I like <code>non_exhaustive_implicit_pattern</code> but what if we used simpler language, how about <code>non_exhaustive_hidden_pattern</code>.  I'm totally on board with "matched explicitly" I think that is a much better way of explaining the lint in a few words.</p>



<a name="252907909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252907909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252907909">(Sep 11 2021 at 12:58)</a>:</h4>
<p>Err hmm, no hidden doesn't work, not really a synonym, hmm I'm not opposed to <code>non_exhaustive_implicit_pattern</code> it does capture the meaning pretty good.</p>



<a name="252909954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252909954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252909954">(Sep 11 2021 at 13:35)</a>:</h4>
<p>I'm working on fixing the <code>if let NonExhaustiveEnum::A = non_enum {}</code> problem (see github PR). All the review issues I resolved are actually resovled their just sitting locally until I fix this problem that makes the tests fail.</p>



<a name="252910567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252910567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252910567">(Sep 11 2021 at 13:45)</a>:</h4>
<p>Ok ignore my previous message I fixed the <code>if let ..</code> thing so all resolved issues should be addressed.</p>



<a name="252990664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252990664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252990664">(Sep 12 2021 at 14:32)</a>:</h4>
<p>I've added comments about your recent changes. We're almost there</p>



<a name="252991075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/252991075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#252991075">(Sep 12 2021 at 14:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/252905373">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="245339">Nadrieril</span><br>
I like <code>non_exhaustive_implicit_pattern</code> but what if we used simpler language, how about <code>non_exhaustive_hidden_pattern</code>.  I'm totally on board with "matched explicitly" I think that is a much better way of explaining the lint in a few words.</p>
</blockquote>
<p><code>non_exhaustive_omitted_patterns</code>? I would prefer <code>non_exhaustive_omitted_fields</code> and <code>non_exhaustive_omitted_variants</code> actually but we don't want to split the lint in two</p>



<a name="253026492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253026492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253026492">(Sep 13 2021 at 01:44)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>I think the only thing left is the <code>if let ..</code> stuff which I left a few comments about <span aria-label="sweat" class="emoji emoji-1f613" role="img" title="sweat">:sweat:</span> and then once were all set I'll change the name to <code>non_exhaustive_omitted_patterns</code>. Unless anyone has any other ideas...</p>



<a name="253088651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253088651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253088651">(Sep 13 2021 at 13:26)</a>:</h4>
<p>yeah, I don't know if there's a procedure for choosing lint names. They're not too hard to rename so let's just go with that and we'll get feedback about it I guess</p>



<a name="253097531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253097531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253097531">(Sep 13 2021 at 14:20)</a>:</h4>
<p>ohh ok right your comment clarifies a lot of things, I was quite confused</p>



<a name="253097548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253097548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253097548">(Sep 13 2021 at 14:20)</a>:</h4>
<p>I replied, your suggestion is good</p>



<a name="253154298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253154298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253154298">(Sep 13 2021 at 20:23)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>Made all the changes from your last few comments on the PR and renamed the lint.</p>



<a name="253170326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253170326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253170326">(Sep 13 2021 at 22:27)</a>:</h4>
<p>woo this looks excellent!</p>



<a name="253170413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253170413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253170413">(Sep 13 2021 at 22:28)</a>:</h4>
<p>logic is clear, comments are detailed, and we nailed the user-facing explanations</p>



<a name="253170677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253170677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253170677">(Sep 13 2021 at 22:31)</a>:</h4>
<p>Thanks you again for the help!! I'm excited about this lint being activated, I think it turned out pretty good too! Also nice if you ever need help onboarding someone to this section of code I could at least take a "first pass" at showing/explaining stuff <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="253170695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253170695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253170695">(Sep 13 2021 at 22:31)</a>:</h4>
<p>thanks for being patient with my comments!</p>



<a name="253170918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253170918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253170918">(Sep 13 2021 at 22:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243877">DevinR528</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/253170677">said</a>:</p>
<blockquote>
<p>Also nice if you ever need help onboarding someone to this section of code I could at least take a "first pass" at showing/explaining stuff <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>
</blockquote>
<p>oh yeah that'd be lovely! This is a rarely touched section of the compiler though ^^</p>



<a name="253184049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253184049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253184049">(Sep 14 2021 at 01:11)</a>:</h4>
<p>Yeah I noticed I could see the end of the commit history in the userfulness file with little to no scrolling <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="253186034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253186034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253186034">(Sep 14 2021 at 01:43)</a>:</h4>
<p>ah that's because this and deconstruct_pat used to be a single file and I split them recently. If you go back in time you can find a <code>_match.rs</code> file that has a lot more history behind it</p>



<a name="253186052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253186052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253186052">(Sep 14 2021 at 01:43)</a>:</h4>
<p>Ahh gotcha that makes more sense.</p>



<a name="253186156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253186156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253186156">(Sep 14 2021 at 01:45)</a>:</h4>
<p>and then there's the move of a ton of files to <code>compiler/</code> that also broke the history</p>



<a name="253288815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253288815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253288815">(Sep 14 2021 at 17:21)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> </p>
<p>Do we have to wait for more approvals? Oh should I squash to 1 commit for getting it ready to merge?</p>



<a name="253290135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253290135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253290135">(Sep 14 2021 at 17:29)</a>:</h4>
<p>nope we were just waiting for me to get back from work ^^</p>



<a name="253290316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253290316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253290316">(Sep 14 2021 at 17:30)</a>:</h4>
<p>you don't even need to squash since your commits are readable. Do you want to anyway?</p>



<a name="253290417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253290417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253290417">(Sep 14 2021 at 17:31)</a>:</h4>
<p><span class="user-mention" data-user-id="243877">@DevinR528</span> lemme know which you prefer, I'm ready to merge either way</p>



<a name="253292690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253292690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253292690">(Sep 14 2021 at 17:45)</a>:</h4>
<p>I'm fine with not squashing I think all the messages were decent and bors kinda squashes anyways right?</p>



<a name="253292801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253292801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253292801">(Sep 14 2021 at 17:46)</a>:</h4>
<p>bors does not squash</p>



<a name="253292876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253292876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253292876">(Sep 14 2021 at 17:46)</a>:</h4>
<p>Oh just a merge commit?</p>



<a name="253292877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253292877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253292877">(Sep 14 2021 at 17:46)</a>:</h4>
<p>Generally we don't want "address review" or similar commits in history, if I'm looking at the right PR</p>



<a name="253292992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253292992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253292992">(Sep 14 2021 at 17:47)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/86809">#86809</a> looks like it has quite a few "fixup" commits basically, which is great for PR review but less great for long-term git blame and such</p>



<a name="253293079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253293079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253293079">(Sep 14 2021 at 17:48)</a>:</h4>
<p>Yeah I do think there were a few of those. I'll be back to my computer in an hour or so and I'll squash the review commits <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="253293204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253293204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253293204">(Sep 14 2021 at 17:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112/near/253292877">said</a>:</p>
<blockquote>
<p>Generally we don't want "address review" or similar commits in history, if I'm looking at the right PR</p>
</blockquote>
<p>ok, good to know</p>



<a name="253312330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253312330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253312330">(Sep 14 2021 at 19:47)</a>:</h4>
<p>Pushed squashed commit. Would it be a good idea to rewrite the first comment of the PR so it describes what the state is now (like "This PR adds ...")</p>



<a name="253312542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253312542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253312542">(Sep 14 2021 at 19:48)</a>:</h4>
<p>Yes, that would be great -- the PR description gets put into commit history by bors, so keeping it updated is a great thing. Also helps reviewers and others looking at the PR later down the line (e.g., release note writers :)</p>



<a name="253314181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253314181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253314181">(Sep 14 2021 at 19:59)</a>:</h4>
<p>Since the initial comment goes into the commit msg is it bad form to add an example?</p>



<a name="253314240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253314240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253314240">(Sep 14 2021 at 19:59)</a>:</h4>
<p>Or is this enough <a href="https://github.com/rust-lang/rust/pull/86809#issue-682590854">https://github.com/rust-lang/rust/pull/86809#issue-682590854</a></p>



<a name="253314368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253314368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253314368">(Sep 14 2021 at 20:00)</a>:</h4>
<p>Examples etc are totally fine, the actual content can be long/short whatever</p>



<a name="253314419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253314419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253314419">(Sep 14 2021 at 20:00)</a>:</h4>
<p>just outdated is unfortunate :)</p>



<a name="253330503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253330503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253330503">(Sep 14 2021 at 22:00)</a>:</h4>
<p>oops I started the merge before seeing this</p>



<a name="253330682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253330682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253330682">(Sep 14 2021 at 22:00)</a>:</h4>
<p>ah good, you updated the comment</p>



<a name="253330791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253330791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253330791">(Sep 14 2021 at 22:01)</a>:</h4>
<p>yeee done, this is a cool new lint I'm excited to see ppl using it</p>



<a name="253333695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253333695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253333695">(Sep 14 2021 at 22:28)</a>:</h4>
<p>Yeah I agree!! I might open a WIP, until this hits stable, PR for syn adding this (I think syn was one of the original examples). I'd also be interested in working on private enum variants.</p>



<a name="253342919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253342919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253342919">(Sep 15 2021 at 00:05)</a>:</h4>
<p>ooh I want private enum variants, is there an RFC for that?</p>



<a name="253343212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253343212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253343212">(Sep 15 2021 at 00:08)</a>:</h4>
<p>as far as I can see they were all closed. It keeps popping up though</p>



<a name="253347456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253347456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253347456">(Sep 15 2021 at 01:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/rfcs/pull/2028">This</a> seems to be closed because of non_exhaustive but I agree with <a href="https://github.com/rust-lang/rfcs/pull/2028#issuecomment-422547712">this comment</a> that it is not the same thing.</p>



<a name="253388036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253388036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253388036">(Sep 15 2021 at 09:52)</a>:</h4>
<p>I agree too</p>



<a name="253388072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253388072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253388072">(Sep 15 2021 at 09:53)</a>:</h4>
<p>still, doesn't look like we'll be implementing it anytime soon</p>



<a name="253404130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253404130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253404130">(Sep 15 2021 at 12:23)</a>:</h4>
<blockquote>
<p>still, doesn't look like we'll be implementing it anytime soon</p>
</blockquote>
<p>Yeah, the fact that there is disagreement means it will be awhile <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span> </p>
<p>It looks like <a href="https://github.com/rust-lang/rust/issues/88924">this issue</a> was closed based on <a href="https://github.com/actions/virtual-environments/issues/4086">this issue</a> (sorry to bug you <span class="user-mention" data-user-id="245339">@Nadrieril</span> )</p>



<a name="253404449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253404449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253404449">(Sep 15 2021 at 12:26)</a>:</h4>
<p>Oh cool</p>



<a name="253404524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253404524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253404524">(Sep 15 2021 at 12:26)</a>:</h4>
<p>And @ehuss was super fast ^^</p>



<a name="253593762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/253593762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#253593762">(Sep 16 2021 at 14:46)</a>:</h4>
<p>We did it!!! Tomorrow the <code>#[warn(non_exhaustive_omitted_patterns)]</code> lint should work <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="255251701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/255251701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#255251701">(Sep 28 2021 at 17:01)</a>:</h4>
<p><span class="user-mention" data-user-id="243877">@DevinR528</span> I'm catching up here -- that's awesome! Was there a PR?</p>



<a name="255252831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/255252831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#255252831">(Sep 28 2021 at 17:08)</a>:</h4>
<p>Thanks! I couldn't have done without <span class="user-mention" data-user-id="245339">@Nadrieril</span> he was awesomely helpful.</p>
<p>The PR <a href="https://github.com/rust-lang/rust/pull/86809">https://github.com/rust-lang/rust/pull/86809</a> was merged but this issue was filed <a href="https://github.com/rust-lang/rust/issues/89042">https://github.com/rust-lang/rust/issues/89042</a> and this PR against that issue <a href="https://github.com/rust-lang/rust/pull/89105">https://github.com/rust-lang/rust/pull/89105</a></p>



<a name="255268507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/255268507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#255268507">(Sep 28 2021 at 17:59)</a>:</h4>
<p>Awesome</p>



<a name="257297069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/257297069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#257297069">(Oct 13 2021 at 01:35)</a>:</h4>
<p>Wow exhaustive checking in skip lang looks familiar <a href="https://github.com/skiplang/skip/blob/master/src/frontend/skipExhaustivePatterns.sk">https://github.com/skiplang/skip/blob/master/src/frontend/skipExhaustivePatterns.sk</a> <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="262076253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Non%20exhaustive%20reachable%20patterns%20lint%20lang-team%23112/near/262076253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DevinR528 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Non.20exhaustive.20reachable.20patterns.20lint.20lang-team.23112.html#262076253">(Nov 19 2021 at 14:56)</a>:</h4>
<p>Just wondering if anyone has opinions about <a href="https://github.com/rust-lang/rust/issues/89042">https://github.com/rust-lang/rust/issues/89042</a> and <a href="https://github.com/rust-lang/rust/pull/90358#discussion_r747763197">https://github.com/rust-lang/rust/pull/90358#discussion_r747763197</a></p>
<p>TL;DR:<br>
Now that <code>non_exhaustive</code> struct and enum patterns can show all fields/variants we ran into problems with stdlib internal <code>stable/unstable</code> fields and variants, so they had to be filtered out of the pattern set when preparing for the error message. The decision that needs to be made is about <code>doc(hidden)</code> fields and variants, should they be filtered out and replaced with a wildcard suggestion?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>