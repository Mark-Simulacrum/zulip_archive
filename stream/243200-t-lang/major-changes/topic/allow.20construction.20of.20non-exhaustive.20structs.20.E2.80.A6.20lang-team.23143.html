<html>
<head><meta charset="utf-8"><title>allow construction of non-exhaustive structs … lang-team#143 · t-lang/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/index.html">t-lang/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html">allow construction of non-exhaustive structs … lang-team#143</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270606821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270606821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270606821">(Feb 03 2022 at 19:47)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/lang-team/issues/143">allow construction of non-exhaustive structs when using functional update syntax #143</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="270607329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607329">(Feb 03 2022 at 19:50)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> for allowing this, as long as all the fields are public. There's an ongoing discussion about whether this kind of thing should be allowed with fields that <em>aren't</em> public, and I personally think it should not be.</p>



<a name="270607373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607373">(Feb 03 2022 at 19:50)</a>:</h4>
<p>Also, this would naturally fit into the proposals to allow <code>..</code> instead of <code>..Default::default()</code>.</p>



<a name="270607511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607511">(Feb 03 2022 at 19:51)</a>:</h4>
<p>This breaks if you add a private field, which is one of the things that is currently allowed with <code>non_exhaustive</code>, so I don't think this is an obvious yes.</p>



<a name="270607644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607644">(Feb 03 2022 at 19:52)</a>:</h4>
<p>Maybe it'd make sense to have some kind of "constrained non exhaustive"?  Like FRU would work with <code>#[non_exhaustive(pub)]</code> or something.</p>



<a name="270607826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607826">(Feb 03 2022 at 19:53)</a>:</h4>
<p>Good point.</p>



<a name="270607934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607934">(Feb 03 2022 at 19:54)</a>:</h4>
<p>Basically, it'd be a shame if accepting this meant that everyone has to go back to adding private unit fields to their structs to allow more private fields in future, since that's what <code>non_exhaustive</code> meant people could stop doing.</p>



<a name="270607968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270607968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270607968">(Feb 03 2022 at 19:54)</a>:</h4>
<p>Yeah, I withdraw my initial <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>, this needs more thought.</p>



<a name="270608197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608197">(Feb 03 2022 at 19:56)</a>:</h4>
<p>The "construct with <code>..</code>" thread mentioned a bunch of other kinds of constrained non-exhaustive too.  Like maybe <code>#[non_exhaustive(defaults)]</code> would be the "I promise to only add new fields with defaults" marker, so you can construct such a thing with <code>..</code>.</p>



<a name="270608273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608273">(Feb 03 2022 at 19:56)</a>:</h4>
<p>non_exhaustive + a Default impl already basically promises to only add fields with a "sort of default" later, right?</p>



<a name="270608424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608424">(Feb 03 2022 at 19:57)</a>:</h4>
<p>/me really wants Esteban's default fields RFC from &lt;<a href="https://internals.rust-lang.org/t/pre-pre-rfc-syntactic-sugar-for-default-default/13234/75?u=scottmcm">https://internals.rust-lang.org/t/pre-pre-rfc-syntactic-sugar-for-default-default/13234/75?u=scottmcm</a>&gt;</p>



<a name="270608509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608509">(Feb 03 2022 at 19:58)</a>:</h4>
<p>Yeah, I want that RFC too.</p>



<a name="270608518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608518">(Feb 03 2022 at 19:58)</a>:</h4>
<blockquote>
<p>This would allow construction outside the defining<br>
crate and require no code changes when common modifications are made such as<br>
adding a new field with a default value.</p>
</blockquote>
<p>FWIW, it seems like this particular motivation is supported relatively OK by 'just' not using the struct declaration syntax, instead updating the fields after calling Default::default() -- is there a big downside to that I'm not spotting immediately?</p>



<a name="270608576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608576">(Feb 03 2022 at 19:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270608273">said</a>:</p>
<blockquote>
<p>non_exhaustive + a Default impl already basically promises to only add fields with a "sort of default" later, right?</p>
</blockquote>
<p>If you actually impl <code>Default</code>, yes; if you have individual field defaults, no.</p>



<a name="270608635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608635">(Feb 03 2022 at 19:59)</a>:</h4>
<p>One aspect of the above-linked proposal from internals is to allow having defaults for some but not all fields, and then allow construction with <code>..</code> as long as all the fields <em>without</em> defaults have initializers.</p>



<a name="270608658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608658">(Feb 03 2022 at 19:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270608518">said</a>:</p>
<blockquote>
<p>FWIW, it seems like this particular motivation is supported relatively OK by 'just' not using the struct declaration syntax, instead updating the fields after calling Default::default() -- is there a big downside to that I'm not spotting immediately?</p>
</blockquote>
<p>It actually works quite well.  Here's a macro for it that makes it really convenient, too: &lt;<a href="https://internals.rust-lang.org/t/short-enum-variant-syntax-in-some-cases/13113/9?u=scottmcm">https://internals.rust-lang.org/t/short-enum-variant-syntax-in-some-cases/13113/9?u=scottmcm</a>&gt;</p>



<a name="270608660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608660">(Feb 03 2022 at 19:59)</a>:</h4>
<p>Which then raises the question of how that interacts with <code>non_exhaustive</code>.</p>



<a name="270608669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608669">(Feb 03 2022 at 19:59)</a>:</h4>
<p>Sure, that's no longer syntactic sugar then.</p>



<a name="270608712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608712">(Feb 03 2022 at 19:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I mean, it's syntactic sugar, it's just syntactic sugar for something different.</p>



<a name="270608738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608738">(Feb 03 2022 at 19:59)</a>:</h4>
<p>TBH, I think <code>#[non_exhaustive]</code> for structs as it is is useless as-is, just because you can't construct it at all from a foreign crate. I don't think I've ever meant "I might add private fields to this struct" when I've wanted <code>#[non_exhaustive]</code>. Having this proposal would make that easier.</p>



<a name="270608921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608921">(Feb 03 2022 at 20:00)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> You can construct it if you have a constructor. You just can't construct it from fields.</p>



<a name="270608944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608944">(Feb 03 2022 at 20:00)</a>:</h4>
<p>Which makes it feel more like an "object" and less like "plain old data".</p>



<a name="270608949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608949">(Feb 03 2022 at 20:00)</a>:</h4>
<p>And that seems fine.</p>



<a name="270608954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608954">(Feb 03 2022 at 20:00)</a>:</h4>
<p>Yeah, that's what I meant.</p>



<a name="270608989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270608989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270608989">(Feb 03 2022 at 20:01)</a>:</h4>
<p>And once you <em>have</em> one, you can modify it. You just can't build one from scratch without a constructor.</p>



<a name="270609077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609077">(Feb 03 2022 at 20:01)</a>:</h4>
<p>It seems like <code>non_exhaustive</code> is ambiguous, because it doesn't nail down what potential added fields might satisfy.</p>



<a name="270609182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609182">(Feb 03 2022 at 20:02)</a>:</h4>
<p>I <em>do</em> really want a way to make things like options structs without needing to go to all the effort of a builder API, but I think something with <code>..</code> as in esteban's pre-RFC is the way forward there.</p>
<p>Unfortunately what FRU does is not what most people expect it to do.</p>



<a name="270609186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609186">(Feb 03 2022 at 20:02)</a>:</h4>
<p>Right now, that ambiguity isn't an issue. Adding <code>..</code> and field defaults makes it an issue, because then it matters whether 1) newly added fields have a default, and 2) newly added fields are public or private.</p>



<a name="270609234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609234">(Feb 03 2022 at 20:02)</a>:</h4>
<p>I've had types like <a href="https://docs.rs/install-dirs/latest/install_dirs/dirs/struct.InstallDirs.html">https://docs.rs/install-dirs/latest/install_dirs/dirs/struct.InstallDirs.html</a>, where it would be nice sugar to have <code>let dirs = InstallDirs{ /*override some directories*/, ..InstallDirs::defaults()};</code>.</p>



<a name="270609336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609336">(Feb 03 2022 at 20:03)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> I think <em>that</em> could be fine with private fields, as long as <code>defaults()</code> initializes all of them, because then you can only change the public fields with that syntax.</p>



<a name="270609395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609395">(Feb 03 2022 at 20:04)</a>:</h4>
<p>It's the <code>{ field: initexpr, .. }</code> syntax for constructing "from scratch" that needs to worry about private fields.</p>



<a name="270609512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609512">(Feb 03 2022 at 20:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270609234">said</a>:</p>
<blockquote>
<p>types like <a href="https://docs.rs/install-dirs/latest/install_dirs/dirs/struct.InstallDirs.html">https://docs.rs/install-dirs/latest/install_dirs/dirs/struct.InstallDirs.html</a></p>
</blockquote>
<p>If that were to implement <code>Default</code> (weird that it has a <code>defaults</code> constructor but not the trait) then that could be just</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">libdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>with no new language features.</p>



<a name="270609551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609551">(Feb 03 2022 at 20:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270609336">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> I think <em>that</em> could be fine with private fields, as long as <code>defaults()</code> initializes all of them, because then you can only change the public fields with that syntax.</p>
</blockquote>
<p>Perhaps, though currently that is <em>not</em> the case.</p>



<a name="270609653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609653">(Feb 03 2022 at 20:06)</a>:</h4>
<p>I think this is coming back to the whole "maybe we should just change FRU to work how people expect", thing.</p>



<a name="270609707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609707">(Feb 03 2022 at 20:06)</a>:</h4>
<p>Now that we have editions to make that possible.</p>



<a name="270609755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270609755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270609755">(Feb 03 2022 at 20:06)</a>:</h4>
<p>Because if we make it work like that <code>s!</code> macro I linked, then it'd work fine with private fields and thus with <code>non_exhaustive</code> just fine.</p>



<a name="270610027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270610027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270610027">(Feb 03 2022 at 20:08)</a>:</h4>
<p>(It has a <code>defaults</code> method, rather than <code>Default::default()</code> because I wouldn't necessarily call <code>defaults()</code> the "one true, sane, default", and the really isn't another one. It's just "initialize everything to the default prefix, with all directories where they normally are, according to the GNU standards")</p>



<a name="270610257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270610257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270610257">(Feb 03 2022 at 20:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270609653">said</a>:</p>
<blockquote>
<p>I think this is coming back to the whole "maybe we should just change FRU to work how people expect", thing.</p>
</blockquote>
<p>Actually, that seems like a really good starting point, and I wonder if part of the issue is "how I expect FRU to work".</p>



<a name="270610517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270610517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270610517">(Feb 03 2022 at 20:12)</a>:</h4>
<p>So, I expect (though I know it may not currently work this way) our current FRU like <code>S { field: value, ..base }</code> to mostly desugar to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_struct</span><span class="p">.</span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_struct</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>except that I don't expect it to actually copy across <code>field</code> and then drop the old value, so it's closer to only assigning the subset of fields that aren't overridden:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span>: <span class="nc">value</span><span class="p">,</span><span class="w"> </span><span class="n">otherfield</span>: <span class="nc">base</span><span class="p">.</span><span class="n">otherfield</span><span class="p">,</span><span class="w"> </span><span class="n">anotherfield</span>: <span class="nc">base</span><span class="p">.</span><span class="n">anotherfield</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but despite the second desugaring from a "don't copy then drop <code>field</code>" point of view, I don't actually expect that to fail if <code>otherfield</code> or <code>anotherfield</code> is private because <em>logically</em> it <em>could</em> behave like the previous version and we just don't want the extra <code>Drop</code> on <code>field</code> (which is public).</p>



<a name="270610639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270610639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270610639">(Feb 03 2022 at 20:13)</a>:</h4>
<p>But for the proposed <em>new</em> FRU, like <code>S { field: value, .. }</code>, I expect it to desugar to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span>: <span class="nc">value</span><span class="p">,</span><span class="w"> </span><span class="n">otherfield</span>: <span class="nc">default_from_definition</span><span class="p">,</span><span class="w"> </span><span class="n">anotherfield</span>: <span class="nc">default_from_definition</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270610658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270610658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270610658">(Feb 03 2022 at 20:13)</a>:</h4>
<p><em>including</em> the implication that if <code>otherfield</code> and <code>anotherfield</code> are private, that should fail to compile.</p>



<a name="270611013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611013">(Feb 03 2022 at 20:16)</a>:</h4>
<p>I'm not arguing that that should be the universal interpretation, but that's how I expect FRU to work, and that's roughly the expectation I have in mind when I argue that <code>..</code> shouldn't cover private fields.</p>



<a name="270611018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611018">(Feb 03 2022 at 20:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270610639">said</a>:</p>
<blockquote>
<p>But for the proposed <em>new</em> FRU, like <code>S { field: value, .. }</code>, I expect it to desugar to:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span>: <span class="nc">value</span><span class="p">,</span><span class="w"> </span><span class="n">otherfield</span>: <span class="nc">default_from_definition</span><span class="p">,</span><span class="w"> </span><span class="n">anotherfield</span>: <span class="nc">default_from_definition</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>So basically I wouldn't even call that FRU.</p>
<p>And the "though I know it may not currently work this way" is exactly what I mean by "we should just change FRU".  Because it's not at all the desugar you wrote.</p>



<a name="270611057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611057">(Feb 03 2022 at 20:16)</a>:</h4>
<p>Yeah, fair, that's not so much FRU as initialization-with-defaults.</p>



<a name="270611184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611184">(Feb 03 2022 at 20:17)</a>:</h4>
<p>Summary: if you're modifying an existing base structure I think it's fine to semantically just copy across private fields <em>because</em> you could just as easily copy the whole struct and then overwrite public fields, and you had to have <em>gotten</em> the base struct from something that properly initialized those private fields. If you're creating a new structure without a base, I don't think that should work with private fields, because the struct might <em>want</em> you to only be able to use a constructor function and not make a struct as raw data without running a constructor.</p>



<a name="270611266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611266">(Feb 03 2022 at 20:18)</a>:</h4>
<p>Does that distinction make sense (leaving aside the question of whether people agree with it)?</p>



<a name="270611354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611354">(Feb 03 2022 at 20:19)</a>:</h4>
<p>Well, the problem with private fields is <code>Vec { ..otherVec }</code>, which if allowed in the current desugar would blow up horribly.</p>



<a name="270611423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611423">(Feb 03 2022 at 20:19)</a>:</h4>
<p>Because the current one doesn't move the original thing, even when it's non-Copy.</p>



<a name="270611810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270611810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270611810">(Feb 03 2022 at 20:22)</a>:</h4>
<p><code>Foo { a: b, ..other }</code> is <code>Foo { a: b, every: other.every, field: other.field }</code>, though I think that usually doesn't make sense.</p>



<a name="270613430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270613430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270613430">(Feb 03 2022 at 20:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270611354">said</a>:</p>
<blockquote>
<p>Well, the problem with private fields is <code>Vec { ..otherVec }</code>, which if allowed in the current desugar would blow up horribly.</p>
</blockquote>
<p>...right, raw pointers are a thing, and so are references with internal mutability.</p>



<a name="270613450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270613450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270613450">(Feb 03 2022 at 20:33)</a>:</h4>
<p>Yeah, that's a <em>very</em> good argument for caution about private fields.</p>



<a name="270613560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270613560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270613560">(Feb 03 2022 at 20:34)</a>:</h4>
<p>I was thinking primarily about "what if the private fields are in an inconsistent state", rather than "what if the private fields can't simply be copied across", and the latter would be a critical failure too.</p>



<a name="270613693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270613693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270613693">(Feb 03 2022 at 20:35)</a>:</h4>
<p>So, another option would be to just have all forms of either FRU or init-with-<code>..</code> desugar to field-by-field initialization, and have that fail with private fields exactly as it would if you named the private field.</p>



<a name="270613715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270613715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270613715">(Feb 03 2022 at 20:35)</a>:</h4>
<p>And <em>if</em> we want to allow <code>..</code> with private fields it could be opt-in.</p>



<a name="270613738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270613738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270613738">(Feb 03 2022 at 20:35)</a>:</h4>
<p>If we allow it at all.</p>



<a name="270614761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270614761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Moffitt <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270614761">(Feb 03 2022 at 20:43)</a>:</h4>
<p>My intention was to make it nicer to do things you are already able to do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">foo</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Default</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">foo</span><span class="p">.</span><span class="n">opt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">foo</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>Already works to construct a non-exhaustive type. This would just allow you to do it with struct syntax directly. I am not proposing that we allow any new behavior, but maybe that wasn't clear.</p>



<a name="270615021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270615021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270615021">(Feb 03 2022 at 20:45)</a>:</h4>
<p>I think this circles back to <code>#[non_exhaustive]</code> again, that there should be an opt-in mechanism for <code>#[non_exhausitve]</code> specifically. TBH, I think mixed field visibility is kinda weird and has limited use cases (part of the reason I've never wanted that use of <code>#[non_exhaustive]</code>). <br>
I've never used it myself (except when what I've really wanted is privacy hygine), and I don't think I've seen it used, either in Rust, or even in C++. The only cases I've used it were in Java, where there is specific benefit to making some fields <code>protected</code> for superclasses. We should definately get <code>#[non_exhaustive(pub)]</code> and perhaps that becoming default in an edition may be something to consider.</p>



<a name="270615675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270615675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Moffitt <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270615675">(Feb 03 2022 at 20:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270607934">said</a>:</p>
<blockquote>
<p>Basically, it'd be a shame if accepting this meant that everyone has to go back to adding private unit fields to their structs to allow more private fields in future, since that's what <code>non_exhaustive</code> meant people could stop doing.</p>
</blockquote>
<p>I'm not quite following what would break here. Presumably you're adding new private fields with defaults or the other methods of construction set those fields. This breaks only in the case that doing things like <code>let mut foo = Foo::default(); foo.pub_field = something;</code> would also break.</p>



<a name="270620965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270620965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270620965">(Feb 03 2022 at 21:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270607934">said</a>:</p>
<blockquote>
<p>Basically, it'd be a shame if accepting this meant that everyone has to go back to adding private unit fields to their structs to allow more private fields in future, since that's what <code>non_exhaustive</code> meant people could stop doing.</p>
</blockquote>
<p>I think people <em>still</em> do this. I almost always do struct <code>#[non_exhaustive]</code> manually, to be explicit about whether I mean "I can add other <code>pub</code> fields later" or "I can add other fields, at any visibility, later". The <code>clippy::manual_nonexhaustive</code> lint only applies for enums for what I can presume to be this reason.</p>



<a name="270621304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270621304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270621304">(Feb 03 2022 at 21:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="235180">Jack Moffitt</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270615675">said</a>:</p>
<blockquote>
<p>This breaks only in the case that doing things like <code>let mut foo = Foo::default(); foo.pub_field = something;</code> would also break.</p>
</blockquote>
<p>That's not what FRU <em>does</em>, though.  (That's what ≈everyone <em>thinks</em> it does, but not the actual desugaring.)</p>
<p>If that <em>were</em> how FRU actually desugared, then I'd have no problem with allowing this change.  Indeed, I wish that were how it worked and thus that this were allowed.</p>



<a name="270631868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270631868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270631868">(Feb 03 2022 at 23:02)</a>:</h4>
<p>maybe we should change how FRU is desugared then...</p>



<a name="270634066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270634066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270634066">(Feb 03 2022 at 23:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270631868">said</a>:</p>
<blockquote>
<p>maybe we should change how FRU is desugared then...</p>
</blockquote>
<p><a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270609653">I agree</a> <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>
<p><a href="https://internals.rust-lang.org/t/allow-fru-syntax-on-non-exhaustive-structs/12800/4?u=scottmcm">https://internals.rust-lang.org/t/allow-fru-syntax-on-non-exhaustive-structs/12800/4?u=scottmcm</a><br>
<a href="https://internals.rust-lang.org/t/pre-rfc-relaxed-non-exhaustive-structs/11977/15?u=scottmcm">https://internals.rust-lang.org/t/pre-rfc-relaxed-non-exhaustive-structs/11977/15?u=scottmcm</a><br>
<a href="https://internals.rust-lang.org/t/proto-rfc-expanded-functional-record-update/3077/2?u=scottmcm">https://internals.rust-lang.org/t/proto-rfc-expanded-functional-record-update/3077/2?u=scottmcm</a></p>



<a name="270665770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270665770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270665770">(Feb 04 2022 at 04:12)</a>:</h4>
<p>yeah, this is a real problem for -sys crates sometimes — i'd love to mark structs as non-exhaustive, because there are some patterns C libraries use which allow abi-compatibly adding new fields to the end of structs (keeping a field for either the size or version or something). it feels like if it has a default impl, and is non_exhaustive, that'd work great for a lot of cases, but it doesnt</p>



<a name="270669197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270669197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270669197">(Feb 04 2022 at 05:13)</a>:</h4>
<p>(To Niko's request, I've made a summary post of my thoughts on the github item: <a href="https://github.com/rust-lang/lang-team/issues/143#issuecomment-1029638652">https://github.com/rust-lang/lang-team/issues/143#issuecomment-1029638652</a> )</p>



<a name="270671064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270671064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270671064">(Feb 04 2022 at 05:48)</a>:</h4>
<blockquote>
<p>Note that just using the different desugar for <code>non_exhaustive</code> types would make <em>removing</em> the attribute a breaking change, which I don't think it currently is, so I think I'm negative on that.</p>
</blockquote>
<p>Is that breakage only in the case of <code>Drop</code> impls?</p>
<p>i.e. in <code>Struct { f: f, ..rest }</code> with <code>Struct</code> being <code>non_exhaustive</code>, desugaring to <code>{let mut tmp=rest; tmp.f=f; tmp}</code> would drop <code>rest.f</code> but not drop any instance of type <code>Struct</code>, whereas then the <code>non_exhaustive</code> might be removed causing it to revert to the current desugaring, which <strong>moves</strong> some fields of <code>rest</code>, which breaks if <code>Struct</code> has a <code>Drop</code> impl because we can't destructure / partial move such a struct.</p>
<p>If so, is it fine if we allow FRU on <code>non_exhaustive</code> <strong>only with no Drop impl</strong>, via the <code>let mut tmp</code> desugaring? The concern about removing <code>non_exhaustive</code> being a breaking change wouldn't apply then right? Of course adding a <code>Drop</code> impl would then be a breaking change, but adding a <code>Drop</code> impl is always a breaking change already anyway.</p>



<a name="270672383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270672383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270672383">(Feb 04 2022 at 06:12)</a>:</h4>
<p>Ooh, keying on <code>Drop</code> is interesting!  Doing the "move out of the fields" is particularly-sketchy for things with <code>Drop</code> (both because partial moves aren't allowed for Drop types at all, and because copying Copy fields is that much more error-prone, like that <code>Vec</code> example), so something related to that sounds like it could work.</p>



<a name="270672608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270672608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270672608">(Feb 04 2022 at 06:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119235">David Tolnay</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143/near/270671064">said</a>:</p>
<blockquote>
<p>which breaks if <code>Struct</code> has a <code>Drop</code> impl because we can't destructure / partial move such a struct.</p>
</blockquote>
<p>Oh, wait, I think this argument doesn't quite work.</p>
<p>You <em>can</em> still FRU something with <code>Drop</code> so long as its fields are copy:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">MyVec</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">len</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">cap</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyVec</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Look at me I have a Drop impl"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyVec</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">len</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cap</span>: <span class="mi">10</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyVec</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">len</span>: <span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="n">a</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">((</span><span class="s">"still alive:"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=6fb4a5e45650390a8839abcf5b3f6862">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=6fb4a5e45650390a8839abcf5b3f6862</a></p>



<a name="270672638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270672638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270672638">(Feb 04 2022 at 06:17)</a>:</h4>
<p>(Things like this that keep using the base value after FRUing from it are a big part of why changing the desugaring is a breaking change, IIRC.)</p>



<a name="270672785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270672785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270672785">(Feb 04 2022 at 06:20)</a>:</h4>
<p>Isn't that fine? The counterproposal was keying on Drop <em>and</em> non_exhaustive, not only Drop. If exhaustive then current desugaring. If non_exhaustive and no Drop, then <code>let mut tmp</code> desugaring. If non_exhaustive and Drop then fail.</p>



<a name="270672993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270672993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270672993">(Feb 04 2022 at 06:24)</a>:</h4>
<p>with the salient concern being what happens when a non_exhaustive attribute is removed, which we want not to be a breaking change.</p>
<p>In that situation something with no Drop impl will revert from <code>let mut tmp</code> desugaring to current desugaring.</p>



<a name="270673120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270673120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270673120">(Feb 04 2022 at 06:26)</a>:</h4>
<p>for example a <code>{let mut tmp = rest; tmp.f=f; tmp}</code> would turn into <code>Struct { f: f, other: rest.other }</code>, in which we know <code>Struct</code> has no <code>Drop</code> impl</p>



<a name="270673202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270673202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270673202">(Feb 04 2022 at 06:28)</a>:</h4>
<p>an observation: that change causes <code>rest.f</code> to live longer than it did before, which might mean it holds on to some borrows longer than before, which might cause borrow errors. Thus we might need an additional restriction that the fields which are <strong>named</strong> in the FRU are all 'static when the type is non_exhaustive.</p>



<a name="270673530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270673530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Tolnay <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270673530">(Feb 04 2022 at 06:34)</a>:</h4>
<p>Alternatively, we can restrict that <code>rest</code> must be a temporary when your type is non_exhaustive. Thus <code>rest.f</code> would drop at the same place in both desugarings.</p>
<p>This is great for <code>Struct { f: f, ..Default::default() }</code></p>



<a name="270677858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270677858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270677858">(Feb 04 2022 at 07:50)</a>:</h4>
<p>Hmm, does that mean that FRU with <code>..{ EXPR }</code> always works with either desugar?  That might also be an interesting way to do an edition change...</p>



<a name="270739140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270739140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270739140">(Feb 04 2022 at 16:33)</a>:</h4>
<p>Another interesting thing, imho, is the <code>.also</code> pattern from Kotlin, featured in <a href="https://docs.rs/tap">https://docs.rs/tap</a> (I'd personally switch the short/long naming <em>w.r.t.</em> the ref/mut adaptors, since I've found the mut case to be way more frequent than the non-mut case):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Struct</span>::<span class="n">default</span><span class="p">().</span><span class="n">tap</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bar</span>::<span class="n">special</span><span class="p">();</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=3b72e9acbda22f32ee84344021d55fcf">Demo</a></li>
</ul>
<p>And from there postfix macros <em>could</em> alleviate the syntax even more.</p>



<a name="270781222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270781222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270781222">(Feb 04 2022 at 22:22)</a>:</h4>
<p>Wait, if we're using macros we don't even need postfix macros.</p>
<p>We can just use exactly the same structure as "real" FRU, like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">yay</span><span class="p">(</span><span class="n">f</span>: <span class="nc">Foo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fru</span><span class="o">!</span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="n">f</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"hello"</span><span class="p">.</span><span class="n">to_owned</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fru</span><span class="o">!</span><span class="p">{</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="n">Foo</span>::<span class="n">default</span><span class="p">()</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Here's the macro:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">__expand_field</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="cp">$b</span>: <span class="nc">ident</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="cp">$f</span>:<span class="nc">ident</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">        </span><span class="cp">$b</span><span class="p">.</span><span class="cp">$f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="cp">$b</span>: <span class="nc">ident</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="cp">$f</span>:<span class="nc">ident</span><span class="w"> </span>: <span class="cp">$e</span>:<span class="nc">expr</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">        </span><span class="cp">$b</span><span class="p">.</span><span class="cp">$f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$e</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">fru</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="cp">$(</span><span class="w"> </span><span class="cp">$f</span>:<span class="nc">ident</span><span class="w"> </span><span class="cp">$(</span><span class="w"> </span>: <span class="cp">$e</span>:<span class="nc">expr</span><span class="w">  </span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="o">*</span><span class="w"></span>
<span class="w">        </span><span class="o">..</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">expr</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$b</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="cp">$(</span><span class="w"></span>
<span class="w">            </span><span class="n">__expand_field</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="cp">$f</span><span class="w"> </span><span class="cp">$(</span><span class="w"> </span>: <span class="cp">$e</span><span class="w"> </span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="o">*</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"></span>
<span class="w">    </span><span class="p">}}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>&lt;<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=9da163d96521efea3b1e8a7eb9e188c4">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=9da163d96521efea3b1e8a7eb9e188c4</a>&gt;</p>



<a name="270789578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270789578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270789578">(Feb 05 2022 at 00:00)</a>:</h4>
<p>Yeah that's a very nifty macro; I was mainly thinking about the possibility to nudge the type inference when inlined into some generic function, the advantage of <code>.tap()</code> is that it's receiver would be a good old <code>Struct::default()</code>; although for your macro type ascription would help quite a bit in that regard:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">fru</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="n">f</span><span class="w"> </span><span class="p">}</span>: <span class="nc">Foo</span><span class="w"></span>
</code></pre></div>
<p>I suspect that with a nicer name it can indeed be quite catchy <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="270795558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/270795558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#270795558">(Feb 05 2022 at 01:29)</a>:</h4>
<p>Note the examples, though -- the macro didn't really need any type ascription because it gets it from the base object.</p>



<a name="271285415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/allow%20construction%20of%20non-exhaustive%20structs%20%E2%80%A6%20lang-team%23143/near/271285415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jplatte <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/allow.20construction.20of.20non-exhaustive.20structs.20.E2.80.A6.20lang-team.23143.html#271285415">(Feb 09 2022 at 14:27)</a>:</h4>
<p>There's already a macro for the assignment-based FRU, though it doesn't use FRU syntax: <a href="https://docs.rs/assign/latest/assign/">https://docs.rs/assign/latest/assign/</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">field_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">todo!</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">my_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="o">!</span><span class="p">(</span><span class="n">Struct</span>::<span class="n">default</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">field_a</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">field_b</span>: <span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>