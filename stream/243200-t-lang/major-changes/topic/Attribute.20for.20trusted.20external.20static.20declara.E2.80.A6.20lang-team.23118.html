<html>
<head><meta charset="utf-8"><title>Attribute for trusted external static declara… lang-team#118 · t-lang/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/index.html">t-lang/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html">Attribute for trusted external static declara… lang-team#118</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255993093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/255993093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#255993093">(Oct 04 2021 at 01:03)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/lang-team/issues/118">Attribute for trusted external static declarations #118</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="256070500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256070500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256070500">(Oct 04 2021 at 14:44)</a>:</h4>
<p>FWIW I feel like an attribute here feels pretty "unfortunate"</p>



<a name="256070605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256070605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256070605">(Oct 04 2021 at 14:45)</a>:</h4>
<p>otoh, the default being unsafe feels not entirely wrong (and not having the default be unsafe feels easy to cause accidents with)</p>



<a name="256071813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256071813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256071813">(Oct 04 2021 at 14:53)</a>:</h4>
<p>I think it would be relatively reasonable to change the default in the future on the basis of whether the type of the external static is <code>Send</code> and <code>Sync</code>.</p>



<a name="256071966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256071966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256071966">(Oct 04 2021 at 14:54)</a>:</h4>
<p>But that might be disruptive without an edition boundary. So we could also add an attribute to enable that behavior, and then make that attribute unnecessary in a future edition.</p>



<a name="256072342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256072342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256072342">(Oct 04 2021 at 14:56)</a>:</h4>
<p>Yeah, that seems potentially reasonable. Ideally, I think, we'd have a better listing of the requirements for adding such a tag -- in principle, <em>non-mut</em> extern statics feel pretty likely to either be sound to access always or never sound to access. For <code>static mut</code> that feels less true, but then it would likely still be unsafe.</p>



<a name="256079393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256079393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256079393">(Oct 04 2021 at 15:38)</a>:</h4>
<p>A non-mut static could easily be sound but unsafe, if it has external synchronization separately.</p>



<a name="256079850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256079850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256079850">(Oct 04 2021 at 15:41)</a>:</h4>
<p>That seems to be false, or the reference is wrong:</p>
<blockquote>
<p>Extern statics can be either immutable or mutable just like statics outside of external blocks. An immutable static must be initialized before any Rust code is executed. It is not enough for the static to be initialized before Rust code reads from it.</p>
</blockquote>



<a name="256079916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256079916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256079916">(Oct 04 2021 at 15:41)</a>:</h4>
<p>I would expect the type to need to be UnsafeCell-like if it has external synchronization</p>



<a name="256080167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256080167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256080167">(Oct 04 2021 at 15:42)</a>:</h4>
<p>That seems questionable to me. I'm wondering where that requirement arose from? It seems perfectly reasonable to initialize it before Rust reads it. Or, for that matter, for Rust code to initialize it by writing before reading.</p>



<a name="256080281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256080281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256080281">(Oct 04 2021 at 15:43)</a>:</h4>
<p>I'm confused why you would expect a non-mut static to permit writing to it -- I don't think we do it today, but I would expect us to treat it as readonly data (e.g., arbitrarily caching it's value)</p>



<a name="256080412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256080412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256080412">(Oct 04 2021 at 15:44)</a>:</h4>
<p>IOW, I expect an extern static and a regular static to be equivalent here</p>



<a name="256080592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256080592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256080592">(Oct 04 2021 at 15:45)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/67630#issuecomment-569154116">https://github.com/rust-lang/rust/pull/67630#issuecomment-569154116</a></p>



<a name="256081005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256081005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256081005">(Oct 04 2021 at 15:48)</a>:</h4>
<p>the non-mut static can permit reads if it uses UnsafeCell internally (atomic values are the common case here).</p>



<a name="256081230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256081230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256081230">(Oct 04 2021 at 15:49)</a>:</h4>
<p>sure, yeah, that's basically "mut internally", I don't think there's dispute there -- it sounds like Josh is saying that should be permitted <em>without</em> an UnsafeCell though.</p>



<a name="256081507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256081507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256081507">(Oct 04 2021 at 15:51)</a>:</h4>
<p><strong>without</strong> UnsafeCell would break Rust's rules, and particularly it would make extern static able to do something that not-extern static can't, which I don't think is a good idea.</p>



<a name="256082830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256082830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256082830">(Oct 04 2021 at 15:59)</a>:</h4>
<p>I'm not suggesting writing without an UnsafeCell, no.</p>



<a name="256083011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256083011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256083011">(Oct 04 2021 at 16:00)</a>:</h4>
<p>(Well, an UnsafeCell or an equivalent by calling an extern C function.)</p>



<a name="256083101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256083101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256083101">(Oct 04 2021 at 16:01)</a>:</h4>
<p>I don't understand what you mean by "an equivalent"</p>



<a name="256083144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256083144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256083144">(Oct 04 2021 at 16:01)</a>:</h4>
<p>the static literally needs to be declared on the Rust side with UnsafeCell in the type, right? There's no workaround for that</p>



<a name="256083209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256083209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256083209">(Oct 04 2021 at 16:01)</a>:</h4>
<p>same as how you can't do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="n">some_c_func</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// c magically changed it</span>
</code></pre></div>



<a name="256084321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256084321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256084321">(Oct 04 2021 at 16:08)</a>:</h4>
<p>Yeah, all externals (code or variables) must <em>behave</em> as if they're following Rust's rules for Rust to safely interact with them. Even if technically they have powers beyond that.</p>



<a name="256140532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256140532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256140532">(Oct 04 2021 at 22:03)</a>:</h4>
<p>To be clear, this is only about extern <code>static</code>, not <code>static mut</code>? And part of the things one is certifying by adding that attribute is "this static is truly immutable (or there is an UnsafeCell)"?</p>



<a name="256140955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256140955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256140955">(Oct 04 2021 at 22:06)</a>:</h4>
<p>This is not directly related to this attribute, but to <code>extern static</code> so it might be worth bringing up -- is it a common issue that people think <code>extern "C" { pub static FOO: T }</code> (assume no UnsafeCell) is immutable from Rust but okay to mutate from other languages? I am a big fan of immutable-by-default for things entirely under Rust control, but in the case of <code>extern</code> this means <em>assuming</em> that the outside world is immutable which does not seem like a safe default.</p>



<a name="256141259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256141259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256141259">(Oct 04 2021 at 22:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/256070500">said</a>:</p>
<blockquote>
<p>FWIW I feel like an attribute here feels pretty "unfortunate"</p>
</blockquote>
<p>yeah... the existing "unsafe attributes" are basically accidents I would say; not sure how I feel about extending that set -- with an attribute that doesnt even have "unsafe" in its name, even. Would <code>unsafe extern "C" { static FOO: T }</code> make sense, or <code>extern "C" { unsafe static FOO: T }</code>?</p>



<a name="256142179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256142179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256142179">(Oct 04 2021 at 22:17)</a>:</h4>
<p>I feel like unsafe extern feels similar to unsafe impl trait which seems good, but unsafe static is unfortunate - too similar to unsafe fn, which has opposite effect</p>



<a name="256142304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256142304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256142304">(Oct 04 2021 at 22:18)</a>:</h4>
<p>My impression is that we currently already assume these statics are "truly immutable" regardless of this attribute, but there seems to be some disagreement on this point with Josh</p>



<a name="256148744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256148744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256148744">(Oct 04 2021 at 23:16)</a>:</h4>
<p>I think if you have a Sync opaque type on the Rust side, it's not unreasonable for it to have interior mutability on the C side.</p>



<a name="256148766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256148766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256148766">(Oct 04 2021 at 23:17)</a>:</h4>
<p>I'm not sure where the concept of non-mut (either by <code>mut</code> or <code>UnsafeCell</code>) statics that point to mutable memory comes from. It is not all that uncommon for a target to have distinct memories/address spaces/etc for static (ROM!) and mutable (RAM!) memory. And there's no reason whatsoever why the linker/backend/etc couldn't derive the necessary location to use based on how mutable extern static declaration is.</p>



<a name="256149026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256149026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256149026">(Oct 04 2021 at 23:20)</a>:</h4>
<p>that said its 2am here and I still am super confused about what's been said in this thread despite having read through it like 3 times over, so I'll just try to not forget to look at this with a fresh head tomorrow.</p>



<a name="256149472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256149472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256149472">(Oct 04 2021 at 23:25)</a>:</h4>
<p>What do you mean by a "Sync opaque type", Josh?</p>



<a name="256149904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256149904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256149904">(Oct 04 2021 at 23:29)</a>:</h4>
<p><code>unsafe extern "C" { /* stuff */ }</code> seems like a good way to improve the situation without a new attribute and maintain clarity.</p>



<a name="256174406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256174406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256174406">(Oct 05 2021 at 04:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/256149472">said</a>:</p>
<blockquote>
<p>What do you mean by a "Sync opaque type", Josh?</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">THE_THING</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="nc">TheType</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>where <code>TheType</code> is an <code>extern type</code> or similar, and is <code>Sync</code>.</p>



<a name="256174426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256174426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256174426">(Oct 05 2021 at 04:11)</a>:</h4>
<p>Something roughly along those lines.</p>



<a name="256174515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256174515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256174515">(Oct 05 2021 at 04:12)</a>:</h4>
<p>(Or, in theory, just <code>static THE_THING: TheType;</code>, if we have some way of doing that without TheType being sized, or if TheType is sized but contains a pointer for interior mutability.)</p>



<a name="256187665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256187665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256187665">(Oct 05 2021 at 07:04)</a>:</h4>
<p>If i understand you, i think the correct way to model that would still be to do it with UnsafeCell&lt;TheType&gt;, or &amp;'static UnsafeCell or whatever other variant.</p>
<p>Basically "if it's going to interior mutate it has to have UnsafeCell" is the rule in rust.</p>
<p>so it's easiest to understand for everyone if we just say that declarations of foreign things should also include an UnsafeCell layer if they're going to be doing interior mutation. and you can put a transparent wrapper over the UnsafeCell if that is appropriate, but there's still the UnsafeCell in there.</p>



<a name="256314474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256314474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256314474">(Oct 05 2021 at 20:32)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I dont see how that could possibly work if Rust is allowed to assume that data behind shared refs is immutable (except for UnsafeCell)</p>



<a name="256314918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256314918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256314918">(Oct 05 2021 at 20:36)</a>:</h4>
<p>If the type is a fully opaque handle, what would that assumption mean?</p>



<a name="256480289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256480289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256480289">(Oct 06 2021 at 20:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/256070605">said</a>:</p>
<blockquote>
<p>otoh, the default being unsafe feels not entirely wrong (and not having the default be unsafe feels easy to cause accidents with)</p>
</blockquote>
<p>Do you mean the default being that <em>referencing the static is unsafe</em> feels "not entirely wrong"?</p>



<a name="256480309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256480309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256480309">(Oct 06 2021 at 20:38)</a>:</h4>
<p>It seems to me like the default ought to be that declaring is unsafe but referencing is safe</p>



<a name="256480337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256480337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256480337">(Oct 06 2021 at 20:39)</a>:</h4>
<p>Because if the type is wrong, then all uses are definitely wrong</p>



<a name="256480391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256480391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256480391">(Oct 06 2021 at 20:39)</a>:</h4>
<p>And if the declaration is <em>correct</em> (ie., this fits the semantics of a Rust <code>static</code>), then uses are <em>safe</em></p>



<a name="256480421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256480421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256480421">(Oct 06 2021 at 20:39)</a>:</h4>
<p>in other words, if you have a <code>static</code> and you mutate it from multiple threads or something</p>



<a name="256480435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256480435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256480435">(Oct 06 2021 at 20:40)</a>:</h4>
<p>the problem was declaring it a <code>static</code> (and not a <code>static mut</code>) in the first place, no?</p>



<a name="256483378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256483378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256483378">(Oct 06 2021 at 20:57)</a>:</h4>
<p>I think the ability to have unsafe-only immutable statics is useful. Particularily for MMIO. For some reason, rust assumes it can read an &amp;T, even if that <code>T</code> is <code>UnsafeCell&lt;U&gt;</code>. If someone could safely take a reference to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="s">"C"</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">_FaultCode</span>: <span class="nc">UnsafeCell</span><span class="o">&lt;</span><span class="kt">u16</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That seems potentially problematic.</p>



<a name="256483693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256483693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256483693">(Oct 06 2021 at 20:59)</a>:</h4>
<p>(I have something similar to this in my SNES-Dev rust support library, which will hopefully become relevant at some point in the not-hugely-far future)</p>



<a name="256508032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256508032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256508032">(Oct 07 2021 at 01:01)</a>:</h4>
<p>You should not use references or statics with MMIO in the first place.</p>



<a name="256559700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256559700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256559700">(Oct 07 2021 at 11:11)</a>:</h4>
<p>I believe the problem there lies around our semantics with <code>UnsafeCell</code> -- either we should not expect to be able to dereference such a thing, or we should have a new type.</p>



<a name="256561893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256561893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256561893">(Oct 07 2021 at 11:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/256508032">said</a>:</p>
<blockquote>
<p>You should not use references or statics with MMIO in the first place.</p>
</blockquote>
<p>I want to use statics as I refuse to ever hardcode an address, and cast that to a raw pointer. Magic Addresses are, imo, stupid.</p>



<a name="256562184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256562184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256562184">(Oct 07 2021 at 11:34)</a>:</h4>
<p>(I also have some symbols that can float in the address space, so hardcoding addresses is entirely impossible)</p>



<a name="256583322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256583322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256583322">(Oct 07 2021 at 14:08)</a>:</h4>
<p>Uhh... Interesting.</p>
<p>I guess what I'll say is that I'm a GBA programmer in Rust, which lead me to make the <code>voladdress</code> crate, which the <code>volatile</code> crate is updating to be more like. So I've got some experience with MMIO, but not on all possible devices. I totally might be missing some context that applies to your situation with the SNES. That said, my experience has been that Rust already allows for the creation of safe and easy to use abstractions over MMIO operations. Those abstractions simply do not involve direct references to MMIO locations.</p>
<p>You say that you don't want to hardcode an address, that you want to use a static instead. Except that a static <em>has</em> a hardcoded address, just one given by the linker instead of by a line in source code. So using a static already seems to go against what you want to do. If you use a static UnsafeCell you still end up with a raw pointer that you have to use, and the pointer's address value is magical value that was assigned by the linker.</p>



<a name="256593389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256593389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256593389">(Oct 07 2021 at 15:06)</a>:</h4>
<blockquote>
<p>You say that you don't want to hardcode an address, that you want to use a static instead. Except that a static has a hardcoded address, just one given by the linker instead of by a line in source code. So using a static already seems to go against what you want to do. If you use a static UnsafeCell you still end up with a raw pointer that you have to use, and the pointer's address value is magical value that was assigned by the linker.</p>
</blockquote>
<p>In the linker, I sort of have to, but I have more flexibility. That being said, my general issue is specifically hardcoding addresses that are then used to invent pointers. It also gives me flexibility. With certain extended mapping techniques, as I said, some of the symbols I can reference don't have a fixed address, and this allows the linker to pick the best location for those symbols, based on where it needs to layout out other sections and, (with more advanced optimization techniques) based on accesses (So common uses of the symbols can be put in the same bank as the symbol). The <code>_FaultCode</code> symbol is actually one of these addresses - it's controlled by the cartridge, but has special handling.</p>



<a name="256601054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256601054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256601054">(Oct 07 2021 at 15:49)</a>:</h4>
<p>FWIW, with <code>#[feature(linkage)]</code>, one can already write the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[apply(my_extern!)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"volatile"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">X</span>: <span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">X</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">X</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">X</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">X</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2018&amp;gist=fdd8782fb96cd8f0b1413ecd24806828">Playground</a> (I've inlined a very basic (not even no-null!) polyfill of a <code>VolAddress</code> there; assume it's rather something like <span class="user-mention" data-user-id="224471">@Lokathor</span>'s in there)</li>
</ul>
<p>which yields:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">main:</span> <span class="c1"># @playground::main</span>
    <span class="nf">movq</span>    <span class="no">X@GOTPCREL</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="nf">movb</span>    <span class="p">(</span><span class="nv">%rax</span><span class="p">),</span> <span class="nv">%cl</span>
    <span class="nf">movb</span>    <span class="no">$42</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="nf">movb</span>    <span class="p">(</span><span class="nv">%rax</span><span class="p">),</span> <span class="nv">%cl</span>
    <span class="nf">movb</span>    <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="nf">retq</span>
</code></pre></div>



<a name="256674933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256674933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256674933">(Oct 08 2021 at 01:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/256314918">said</a>:</p>
<blockquote>
<p>If the type is a fully opaque handle, what would that assumption mean?</p>
</blockquote>
<p>not sure what a 'fully opaque handle' is in technical terms, but it would still mean all the memory the reference points to (as determined by the size of the pointee) must not be mutated between any two accesses of a shared reference.</p>



<a name="256677955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256677955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256677955">(Oct 08 2021 at 02:05)</a>:</h4>
<p>What would go wrong, in practice, if there were interior mutability that Rust didn't know about?</p>
<p>Also, does that apply if the object itself is just a pointer, and what gets mutated is what it points to?</p>



<a name="256678044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256678044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256678044">(Oct 08 2021 at 02:06)</a>:</h4>
<p>(or, for that matter, if it isn't sized and the layout of the object it references isn't known to Rust)</p>



<a name="256678437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/256678437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#256678437">(Oct 08 2021 at 02:12)</a>:</h4>
<p>Cross language LTO, for example, could mean that Rust's application of attributes indicating immutability, for example, could carry into C/C++ and cause UB there, I suppose. I think we've seen this with function arguments in ffi.</p>
<p>I wouldn't expect this to carry through a raw pointer</p>



<a name="257301662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/257301662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#257301662">(Oct 13 2021 at 02:40)</a>:</h4>
<blockquote>
<p>What would go wrong, in practice, if there were interior mutability that Rust didn't know about?</p>
</blockquote>
<p>Rust is allowed to optimize code like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="n">foo</span><span class="p">()</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>to make the last line <code>let val2 = val1</code>. Not sure if such code can arise here though.</p>
<blockquote>
<p>does that apply if the object itself is just a pointer, and what gets mutated is what it points to?</p>
</blockquote>
<p>in my current proposals, aliasing guarantees are 'shallow', so an <code>&amp;T</code> just means the <code>T</code> cannot be mutated, but it doesnt matter what <code>T</code> points to. One can imagine other proposals, but if <code>T</code> is a raw ptr type then aliasing guarantees definitely stop.<br>
but that just means that <code>extern static FOO: *mut T</code> is okay to be a ptr to mutable memory, but <code>FOO</code> itself remains readonly.</p>
<blockquote>
<p>(or, for that matter, if it isn't sized and the layout of the object it references isn't known to Rust)</p>
</blockquote>
<p>that makes it hard to come up with concrete counterexamples, but I also dont think we should say in the spec that the Rust aliasing guarantees have some weird interaction with whether a type is sized or not. That would be a very surprising interactions of language features that have no right of interacting in any way, IMO.</p>



<a name="257301754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/257301754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#257301754">(Oct 13 2021 at 02:41)</a>:</h4>
<p>and on that last point, I also dont think <code>static FOO: T</code> and <code>extern static FOO: T</code> should behave any different in terms of aliasing guarantees -- again, that would be an interaction of language features that ought to be orthogonal. And I assume there is widespread consensus that the former is read-only except for interior mutability.</p>



<a name="260852870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260852870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260852870">(Nov 09 2021 at 20:03)</a>:</h4>
<p>RFC Draft, I'll make the full PR for it some time later if there's no major problems: <a href="https://hackmd.io/@Lokathor/Sk-RXL_PK">https://hackmd.io/@Lokathor/Sk-RXL_PK</a></p>



<a name="260853679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260853679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260853679">(Nov 09 2021 at 20:10)</a>:</h4>
<p>I think it would be useful to include at least some discussion of the guarantees needed for unsafe access</p>



<a name="260853808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260853808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260853808">(Nov 09 2021 at 20:11)</a>:</h4>
<p>In particular, I'm not clear if:</p>
<blockquote>
<p>If the linked data does not match the type you declared then there’s no possible safe way to use that declaration, and the entire program needs to be recompiled with a correct definition.</p>
</blockquote>
<p>is actually true (in the sense of being sufficient). The current reference at least gestures in the direction that your program is simply UB if this occurs (in-program access or not).</p>
<blockquote>
<p>An immutable static must be initialized before any Rust code is executed. It is not enough for the static to be initialized before Rust code reads from it.</p>
</blockquote>
<p>I don't think it would be a breaking change -- if this is true -- to just treat extern statics as safe, right? (Just new unsafe code unused lints).</p>



<a name="260853905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260853905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260853905">(Nov 09 2021 at 20:12)</a>:</h4>
<p>I think this was the major question raised in the discussion so far as part of the MCP.</p>



<a name="260854313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854313">(Nov 09 2021 at 20:15)</a>:</h4>
<p>To your second question:</p>
<ul>
<li>If you access an extern using the wrong definition then the program is UB (excepting some edge cases where you access say a u16 instead of the full u32 or something, which we probably don't need to worry about).</li>
<li>If you declare an extern wrong and then <em>don't use it at all</em>, the program is likely not actually UB.</li>
</ul>



<a name="260854480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854480">(Nov 09 2021 at 20:17)</a>:</h4>
<p>Actually, I suppose we might say that the access is UB, which if the access is only conditional in some way makes the program only conditionally UB.</p>



<a name="260854529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854529">(Nov 09 2021 at 20:17)</a>:</h4>
<p>IMO the reference today implies otherwise -- right? That is, "An immutable static must be initialized before any Rust code is executed. It is not enough for the static to be initialized before Rust code reads from it." implies to me that <em>just declaring</em> an immutable static which is modified by C (with no uses in Rust) is UB.</p>



<a name="260854558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854558">(Nov 09 2021 at 20:17)</a>:</h4>
<p>Which might be observable through - for example - cross-lang LTO or some such.</p>



<a name="260854766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854766">(Nov 09 2021 at 20:19)</a>:</h4>
<p>e.g., Box has this language:</p>
<blockquote>
<p>Important. At least at present, you should avoid using <code>Box&lt;T&gt;</code> types for functions that are defined in C but invoked from Rust. In those cases, you should directly mirror the C types as closely as possible. Using types like <code>Box&lt;T&gt;</code> where the C definition is just using <code>T*</code> can lead to undefined behavior, as described in <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/198">rust-lang/unsafe-code-guidelines#198</a>.</p>
</blockquote>



<a name="260854787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854787">(Nov 09 2021 at 20:19)</a>:</h4>
<p>which is sort of similar in spirit</p>



<a name="260854799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854799">(Nov 09 2021 at 20:19)</a>:</h4>
<p>Sure, but that's if you access it.</p>
<p>If you declare the invalid extern and <em>never</em> access it then I can't imagine how the declaration alone could possibly affect the program's validity. The same as you can declare an extern fn to something that doesn't exist, and there's no link error if you end up not using that function call.</p>



<a name="260854853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854853">(Nov 09 2021 at 20:20)</a>:</h4>
<p>Because the mere declaration (with e.g. cross-lang LTO) can cause C code to now have UB, if you get the declaration wrong</p>



<a name="260854946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260854946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260854946">(Nov 09 2021 at 20:20)</a>:</h4>
<p>So I'm not actually sure access on the Rust side is presently required.</p>



<a name="260855177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855177">(Nov 09 2021 at 20:22)</a>:</h4>
<p>I don't think I know how cross-lang LTO could have an effect.</p>
<p>Are you saying the compiler would see the C code accessing its FOO and then see the Rust definition of FOO and replace the C definition with the rust definition?</p>



<a name="260855230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855230">(Nov 09 2021 at 20:22)</a>:</h4>
<p>Well, more like, add the attributes</p>



<a name="260855270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855270">(Nov 09 2021 at 20:22)</a>:</h4>
<p>but sure, yeah</p>



<a name="260855293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855293">(Nov 09 2021 at 20:22)</a>:</h4>
<p>If the mere declaration of an inaccurate static can cause UB, then we can just stop requiring the unsafe blocks right now.</p>



<a name="260855324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855324">(Nov 09 2021 at 20:23)</a>:</h4>
<p>And that might be the case, for all I know, i'm no compiler expert here</p>



<a name="260855374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855374">(Nov 09 2021 at 20:23)</a>:</h4>
<p><a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/198">https://github.com/rust-lang/unsafe-code-guidelines/issues/198</a> is basically the non-static version of this that doesn't even require FFI or LTO</p>



<a name="260855520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855520">(Nov 09 2021 at 20:24)</a>:</h4>
<p>(but I think it applies equally here)</p>



<a name="260855657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855657">(Nov 09 2021 at 20:25)</a>:</h4>
<p>basically, I think we probably can make a reasonable argument for just dropping unsafe blocks, and it seems the <em>better</em> argument to make, IMO</p>



<a name="260855658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855658">(Nov 09 2021 at 20:25)</a>:</h4>
<p>Well, if gnzlbg is correct (and they usually are), then extern blocks themselves are <em>already</em> unsafe, we just didn't understand/document that to be the case.</p>



<a name="260855797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855797">(Nov 09 2021 at 20:26)</a>:</h4>
<p>so i would agree with you, just drop the unsafe block requirement for extern statics</p>



<a name="260855831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855831">(Nov 09 2021 at 20:27)</a>:</h4>
<p>and further, we'd probably want some stronger language in the reference about how closely extern blocks need to match the literal C definition</p>



<a name="260855928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855928">(Nov 09 2021 at 20:28)</a>:</h4>
<p>(because I myself also use 'richer types' in my extern C declarations, and if that's bad, then big whoops)</p>



<a name="260855998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260855998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260855998">(Nov 09 2021 at 20:28)</a>:</h4>
<p>Right.</p>



<a name="260886637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260886637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260886637">(Nov 10 2021 at 01:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/260854799">said</a>:</p>
<blockquote>
<p>Sure, but that's if you access it.</p>
<p>If you declare the invalid extern and <em>never</em> access it then I can't imagine how the declaration alone could possibly affect the program's validity. The same as you can declare an extern fn to something that doesn't exist, and there's no link error if you end up not using that function call.</p>
</blockquote>
<p>the compiler is allowed to insert loads from unused shared references in the program. it is not a stretch to say that it can also insert loads from other unused shared places, such as statics.</p>



<a name="260886734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260886734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260886734">(Nov 10 2021 at 01:07)</a>:</h4>
<p>so for example, the compiler might be allowed to hoist the access out of the loop:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="n">something</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXTERN_STATIC</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>now if <code>something()</code> happens to return <code>false</code>, loop hoisting introduces a read where there was none.<br>
therefore even unused statics must follow Rust's aliasing discipline.</p>



<a name="260886896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260886896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260886896">(Nov 10 2021 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/260855657">said</a>:</p>
<blockquote>
<p>basically, I think we probably can make a reasonable argument for just dropping unsafe blocks, and it seems the <em>better</em> argument to make, IMO</p>
</blockquote>
<p>uh... that doesn't seem like a good idea to me, it makes the unsafe way too implicit.<br>
I would support something like <code>unsafe extern "C"</code> blocks. but the functions imported there should IMO still be unsafe to call, making a promise at the <em>declaration site</em> about <em>all use sites</em> seems way too non-local. during code review a new use of such a function could easily be introduced and there is no local indication that careful checking is required.<br>
the same argument also applies to statics, of course, which is why I am somewhat wary of this entire proposal.</p>



<a name="260888183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260888183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260888183">(Nov 10 2021 at 01:28)</a>:</h4>
<p>I think it's the case for functions because C functions at least typically <em>are</em> unsafe to call</p>



<a name="260888205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260888205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260888205">(Nov 10 2021 at 01:29)</a>:</h4>
<p>But immutable statics presumably are not really unsafe to access</p>



<a name="260888241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260888241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260888241">(Nov 10 2021 at 01:29)</a>:</h4>
<p>Since, like, they have to be immutable anyway, and then they're either ok or not is basically how my thinking goes - there's nothing extra at each use site</p>



<a name="260888323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260888323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260888323">(Nov 10 2021 at 01:30)</a>:</h4>
<p>(I would be happy to be shown to be wrong, but this is my current understanding)</p>



<a name="260998878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/260998878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#260998878">(Nov 10 2021 at 14:41)</a>:</h4>
<p>If, as a separate extension of this idea, an FFI function were to be unsafely declared then the function would still itself have to be marked unsafe or not based on what it does. winapi::GetProcAddress handles pointers and is unsafe, but libm::sqrt just uses an f32 and so is safe. This is actually already in the rfc draft as a future extension.</p>
<p>however i do not want to discuss the FFI calls part that much until <strong>after</strong> the statics part is resolved.</p>



<a name="261001124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261001124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261001124">(Nov 10 2021 at 14:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/260998878">said</a>:</p>
<blockquote>
<p>If, as a separate extension of this idea, an FFI function were to be unsafely declared then the function would still itself have to be marked unsafe or not based on what it does. winapi::GetProcAddress handles pointers and is unsafe, but libm::sqrt just uses an f32 and so is safe. This is actually already in the rfc draft as a future extension.</p>
<p>however i do not want to discuss the FFI calls part that much until <strong>after</strong> the statics part is resolved.</p>
</blockquote>
<p>Indeed. I've written so many safety comments like</p>
<div class="codehilite"><pre><span></span><code>// SAFETY: *relevant standard here* does not prescribe any undefined behaviour for *function*
</code></pre></div>
<p>I'd ideally to not have to copy that text to a bunch of ffi calls, ideally</p>



<a name="261004635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261004635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261004635">(Nov 10 2021 at 15:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/260998878">said</a>:</p>
<blockquote>
<p>If, as a separate extension of this idea, an FFI function were to be unsafely declared then the function would still itself have to be marked unsafe or not based on what it does. winapi::GetProcAddress handles pointers and is unsafe, but libm::sqrt just uses an f32 and so is safe. This is actually already in the rfc draft as a future extension.</p>
<p>however i do not want to discuss the FFI calls part that much until <strong>after</strong> the statics part is resolved.</p>
</blockquote>
<p>What would be the right place to discuss this? I have some thoughts on it</p>



<a name="261005513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261005513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261005513">(Nov 10 2021 at 15:26)</a>:</h4>
<p>uh, a new thread in the general t-lang stream, i guess?</p>



<a name="261016143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261016143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261016143">(Nov 10 2021 at 16:37)</a>:</h4>
<p>To be honest, the current situation feels very weird to me. I strongly agree with Ralf and whoever said that it seems that either all accesses to a static are correct or none of them are (sidenote: what does this mean if there are no accesses, even in dead code?). Is this the problem that this RFC is looking to solve? If so, I'd definitely like to see some alternatives, and will start by suggesting this:</p>
<ol>
<li>Make accesses to immutable extern statics (by that I mean extern statics that are neither <code>static mut</code> nor <code>UnsafeCell</code>) safe</li>
<li>Make the declaration of such statics <code>unsafe_code</code></li>
<li>Adjust whatever documentation is needed to make the last part clear to everyone.</li>
</ol>
<p>Of course, the second item would be a breaking change; there's a number of mediating factors for that though: a) I don't expect there to be many crates that deny <code>unsafe_code</code> but also declare an extern static (maybe I'm wrong about this, please let me know) b) this could be justified as a soundness fix, and c) its probably possible to do 2 across an edition boundary (with an appropriate warning now) if we want to avoid breaking code that might be technically unsound but is probably not actually causing UB</p>



<a name="261017032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261017032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261017032">(Nov 10 2021 at 16:43)</a>:</h4>
<p>Another way of looking at this is that it seems that if we do add the attribute, the guarantees around it are basically "you're not required to add this attribute, but it is actually correct to add it in all code that is not already UB" which I'm not a huge fan of</p>



<a name="261021611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261021611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261021611">(Nov 10 2021 at 17:13)</a>:</h4>
<p>Even if we end up deciding to not do anything like this because the guarantees that this implies are not the ones we want (this seems to be what Josh was saying) then I still think we should avoid making a change like the one proposed here until we've actually decided what the desired guarantees are</p>



<a name="261029516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261029516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261029516">(Nov 10 2021 at 18:05)</a>:</h4>
<blockquote>
<p>is this the problem that the RFC is looking to solve?</p>
</blockquote>
<p>yes.</p>



<a name="261029611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261029611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261029611">(Nov 10 2021 at 18:05)</a>:</h4>
<p>and the new attribute is a way to slowly move the world into what you list as option 2.</p>



<a name="261029925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261029925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261029925">(Nov 10 2021 at 18:07)</a>:</h4>
<p>I would prefer to not have an attribute and move to having it be the assumed default in a future edition, which is covered in the Future Possibilities portion of the draft.</p>



<a name="261030080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261030080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261030080">(Nov 10 2021 at 18:08)</a>:</h4>
<p>if you haven't read all the way through the draft rfc, please do so.</p>



<a name="261032266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261032266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261032266">(Nov 10 2021 at 18:20)</a>:</h4>
<p>I realize I was unclear. The list I gave was supposed to be a "do all of" type thing, not "do some of." I'll edit to clarify in just a second.</p>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261029611">said</a>:</p>
<blockquote>
<p>and the new attribute is a way to slowly move the world into what you list as option 2.</p>
</blockquote>
<p>The discussion above (at least the version of things that Ralf proposed) seems to indicate that we are in that world already though. In particular, the second point is supposed to be a change for the <code>unsafe_code</code> lints to match the existing semantics of the language, not an actual change to the language. In other words, I am interpreting things as: The current situation is that declaring the type of an extern static to be non-mutable when it actually is is <em>already UB in Rust today</em>, and my suggestion is to fix a number of things to align more closely with that reality. If this is not the case (as it indeed may not be), then I don't think it makes much sense to have such an attribute if the actual semantics of extern statics (as related to mutability) are not yet clear.</p>



<a name="261032933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261032933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261032933">(Nov 10 2021 at 18:25)</a>:</h4>
<p>It is most likely already the case that an incorrect declaration can cause UB, and thus it should be <code>unsafe</code> to even make the declaration, yes.</p>
<p>If so, we could accept the situation and update the docs and lang.</p>
<p>Alternately we could try to make sure that LLVM and all other backends will never miscompile from simply an mismatch in declaration. That seems like a taller order though, honestly.</p>



<a name="261033555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261033555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261033555">(Nov 10 2021 at 18:29)</a>:</h4>
<blockquote>
<p>if so, we could accept the situation and update the docs and lang.</p>
</blockquote>
<p>I believe this is what I am proposing</p>



<a name="261034169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261034169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261034169">(Nov 10 2021 at 18:33)</a>:</h4>
<p>If we do not go this route, then I would like to see an example of a case where it is not correct for rustc to simply assume the suggested new attribute. If such a case does not exist, then I do not see what value the additional attribute provides</p>



<a name="261034422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261034422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261034422">(Nov 10 2021 at 18:34)</a>:</h4>
<p>won't that cause huge breakage? A less aggressive form of 2 is to make the declarations "unsafe" without adding any required text to the declaration itself, only making them illegal when <code>deny(unsafe_code)</code> is in effect</p>



<a name="261034563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261034563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261034563">(Nov 10 2021 at 18:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261034422">said</a>:</p>
<blockquote>
<p>won't that cause huge breakage? A less aggressive form of 2 is to make the declarations "unsafe" without adding any required text to the declaration itself, only making them illegal when <code>deny(unsafe_code)</code> is in effect</p>
</blockquote>
<p>Oh yeah, that is what I am suggesting. I'll go edit to clarify some more</p>



<a name="261034807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261034807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261034807">(Nov 10 2021 at 18:37)</a>:</h4>
<p>although, that change on its own is not great since it means that lots of extern statics are getting grandfathered in to an invisible unsafe block without review</p>



<a name="261035019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261035019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261035019">(Nov 10 2021 at 18:38)</a>:</h4>
<p>the attribute, at least, provides a time for the review to take place</p>



<a name="261035271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261035271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261035271">(Nov 10 2021 at 18:40)</a>:</h4>
<p>The discussion above indicates that this is what they already are and always were. In other words, the breakage here  is not that stuff which didn't used to be unsafe is now unsafe, but rather that stuff which used to be unsafe but didn't lint as such now also lints as such. There may be alternatives, but there does not seem to be any agreement on what the semantics of such alternatives would actually be</p>



<a name="261035793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261035793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261035793">(Nov 10 2021 at 18:44)</a>:</h4>
<p>sure, but this was not effectively communicated when the various extern statics in the world were written. They probably need more review now that their status is changing</p>



<a name="261036463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261036463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261036463">(Nov 10 2021 at 18:49)</a>:</h4>
<p>Their status is not really changing, is ultimately the thing.</p>
<p>if they were broken before they stay broken, if they were actually fine before they're still actually fine. We didn't communicate the requirements properly in the past, but that doesn't mean the actual requirements are changing in any way.</p>



<a name="261036674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261036674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261036674">(Nov 10 2021 at 18:50)</a>:</h4>
<p>I agree with Jake that not having the attribute is really the better long term solution. However, as a fix for current-edition, i think an attribute could be an appropriate transitional solution</p>



<a name="261037340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261037340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261037340">(Nov 10 2021 at 18:55)</a>:</h4>
<p>I do see an argument here in favor of the existence of such an attribute, but I think its role should be clarified in that case. If we interpret the attribute to mean "this code has been written after the clarification of immutable statics and was reviewed to ensure it meets the requirements," then this seems reasonable. In that case though immutable extern static declarations, with or without the attribute, should still lint as <code>unsafe_code</code>, since that is still what they are.</p>



<a name="261037774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261037774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261037774">(Nov 10 2021 at 18:58)</a>:</h4>
<p>Also, this is probably a bad idea, but at least worth considering: Not including this attribute issues a warning. This has the downside of suddenly issuing a lot of warnings (almost certainly way disproportionately to the rate at which there's actual UB), but it is in principle "correct" in that new code should never declare an extern static without including the attribute.</p>



<a name="261206568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206568">(Nov 12 2021 at 02:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/260888241">said</a>:</p>
<blockquote>
<p>Since, like, they have to be immutable anyway, and then they're either ok or not is basically how my thinking goes - there's nothing extra at each use site</p>
</blockquote>
<p>they could be interior mutable</p>



<a name="261206663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206663">(Nov 12 2021 at 02:49)</a>:</h4>
<p>I think any interior mutability would still have clear safety conditions (i.e., the same ones as on a regular Rust static with the same interior mutability).</p>



<a name="261206675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206675">(Nov 12 2021 at 02:49)</a>:</h4>
<p>but there is something extra at each use site -- the value must actually be of the given type</p>



<a name="261206683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206683">(Nov 12 2021 at 02:49)</a>:</h4>
<p>so I dont see how statics are fundamentally less problematic than function calls</p>



<a name="261206732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206732">(Nov 12 2021 at 02:50)</a>:</h4>
<p>you mean since the compiler can't otherwise manufacture reads into UnsafeCell?</p>



<a name="261206744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206744">(Nov 12 2021 at 02:50)</a>:</h4>
<p>that was meant just each time the value is read</p>



<a name="261206747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206747">(Nov 12 2021 at 02:50)</a>:</h4>
<p>since it can change</p>



<a name="261206750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206750">(Nov 12 2021 at 02:50)</a>:</h4>
<p>so it's kind of like calling a function <code>fn() -&gt; T</code></p>



<a name="261206771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206771">(Nov 12 2021 at 02:51)</a>:</h4>
<p>sure we avoid all the UB that running the function may cause on the C side, but we still have all the UB that might arise from the value not actually being a <code>T</code></p>



<a name="261206823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206823">(Nov 12 2021 at 02:52)</a>:</h4>
<p>(plus potential UB due to data races)</p>



<a name="261206911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206911">(Nov 12 2021 at 02:54)</a>:</h4>
<p>I guess it's true that the static may not have type T, and we could say that it's OK to have <code>extern { static FOO: UnsafeCell&lt;NonZeroU64&gt;; }</code> that sometimes is zero but is externally known to be non-zero when actually read by Rust -- but it also seems like the same can maybe be said of a regular rust static with the same type?</p>



<a name="261206940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261206940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261206940">(Nov 12 2021 at 02:55)</a>:</h4>
<p>IOW, the interior mutability does not actually add anything special because it's in an extern static -- it's always not valid to "speculate" it as being of type T (e.g., niches etc should not in theory pass through unsafecell)</p>



<a name="261207146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207146">(Nov 12 2021 at 02:59)</a>:</h4>
<blockquote>
<p>IOW, the interior mutability does not actually add anything special because it's in an extern static</p>
</blockquote>
<p>the special thing is that it is accessible to C code <span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span></p>



<a name="261207238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207238">(Nov 12 2021 at 03:00)</a>:</h4>
<p>whereas with a regular rust static the compiler will do whatever it can to ensure no wrong value is ever written there</p>



<a name="261207268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207268">(Nov 12 2021 at 03:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261206940">said</a>:</p>
<blockquote>
<p>IOW, the interior mutability does not actually add anything special because it's in an extern static -- it's always not valid to "speculate" it as being of type T (e.g., niches etc should not in theory pass through unsafecell)</p>
</blockquote>
<p>for immutable statics that should be totally valid IMO</p>



<a name="261207280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207280">(Nov 12 2021 at 03:01)</a>:</h4>
<p>er, maybe my parens are off or something</p>



<a name="261207286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207286">(Nov 12 2021 at 03:01)</a>:</h4>
<p>I meant that it's never valid to speculate as type T for interior mutability</p>



<a name="261207298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207298">(Nov 12 2021 at 03:01)</a>:</h4>
<p>(and niches passing through Cell is fine in principle I think, at least I dont know a counterexample -- though we probably still want to block them, that was certainly the intent when the change for unsafecell niches landed)</p>



<a name="261207425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207425">(Nov 12 2021 at 03:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261207286">said</a>:</p>
<blockquote>
<p>I meant that it's never valid to speculate as type T for interior mutability</p>
</blockquote>
<p>ah I see. for data shared across threads this is definitely true because a speculative read might race.</p>
<p>but I also think that for interior mutability we dont even need to invoke speculation to show that only marking the declaration site as unsafe is insufficient -- every actual read site asserts that at the time of the read, whatever the current value is, it is a valid T.</p>



<a name="261207429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207429">(Nov 12 2021 at 03:03)</a>:</h4>
<p><code>static FOO: UnsafeCell&lt;NonZeroU64&gt;;</code> in regular Rust code I'd expect to be able to temporarily initialize to zero, if you write to it through <code>*mut u64</code> for example -- so long as you never read that value at type NonZeroU64. but maybe this conflicts with something...</p>
<p>it seems like if the model is that internally mutable statics are <code>fn() -&gt; T</code> for extern statics the same should be true of Rust statics, too, in some sense.</p>



<a name="261207492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207492">(Nov 12 2021 at 03:04)</a>:</h4>
<blockquote>
<p>but I also think that for interior mutability we dont even need to invoke speculation to show that only marking the declaration site as unsafe is insufficient -- every actual read site asserts that at the time of the read, whatever the current value is, it is a valid T.</p>
</blockquote>
<p>Right, but that's specific to the interior mutability -- if I choose <code>Cell&lt;u64&gt;</code>, then reading/writing is safe (and presumably that can just be a <code>u64</code> in C-land)</p>



<a name="261207508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207508">(Nov 12 2021 at 03:05)</a>:</h4>
<p>and I'd expect that to be OK</p>



<a name="261207514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207514">(Nov 12 2021 at 03:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261207429">said</a>:</p>
<blockquote>
<p><code>static FOO: UnsafeCell&lt;NonZeroU64&gt;;</code> in regular Rust code I'd expect to be able to temporarily initialize to zero, if you write to it through <code>*mut u64</code> for example -- so long as you never read that value at type NonZeroU64. but maybe this conflicts with something...</p>
<p>it seems like if the model is that internally mutable statics are <code>fn() -&gt; T</code> for extern statics the same should be true of Rust statics, too, in some sense.</p>
</blockquote>
<p>That looks a lot what's being talked about in <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/niches-and-interior-mutability">this unsafe-code-guidelines</a> thread.</p>



<a name="261207516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207516">(Nov 12 2021 at 03:05)</a>:</h4>
<p>hm I see where you are coming from. I am trying to see why this feels very different for me and I think the reason is that with a <code>static</code> I think of that other code being Rust code, so if it temporarily puts a 0 somewhere it is already <code>unsafe</code>. whereas with <code>extern static</code> it is C code that might not even know that putting a 0 there is in any way risky.</p>



<a name="261207523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207523">(Nov 12 2021 at 03:05)</a>:</h4>
<p>for sure</p>



<a name="261207531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207531">(Nov 12 2021 at 03:05)</a>:</h4>
<p>but that's sort of "the price of C"</p>



<a name="261207572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207572">(Nov 12 2021 at 03:06)</a>:</h4>
<p>I'm not sure we gain anything by asserting at each use site, personally.</p>



<a name="261207581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207581">(Nov 12 2021 at 03:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261207516">said</a>:</p>
<blockquote>
<p>hm I see where you are coming from. I am trying to see why this feels very different for me and I think the reason is that with a <code>static</code> I think of that other code being Rust code, so if it temporarily puts a 0 somewhere it is already <code>unsafe</code>. whereas with <code>extern static</code> it is C code that might not even know that putting a 0 there is in any way risky.</p>
</blockquote>
<p>To be fair, this is true of a lot of FFI things.</p>



<a name="261207596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207596">(Nov 12 2021 at 03:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118/near/261207492">said</a>:</p>
<blockquote>
<blockquote>
<p>but I also think that for interior mutability we dont even need to invoke speculation to show that only marking the declaration site as unsafe is insufficient -- every actual read site asserts that at the time of the read, whatever the current value is, it is a valid T.</p>
</blockquote>
<p>Right, but that's specific to the interior mutability -- if I choose <code>Cell&lt;u64&gt;</code>, then reading/writing is safe (and presumably that can just be a <code>u64</code> in C-land)</p>
</blockquote>
<p>reading/writing might still cause a data race. (does <code>extern static</code> have the usual check that the type must be <code>Sync</code>?)</p>



<a name="261207622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207622">(Nov 12 2021 at 03:08)</a>:</h4>
<p>also, if the C code leaves the static uninit, even a <code>u64</code> static might not be valid at its type</p>



<a name="261207667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207667">(Nov 12 2021 at 03:08)</a>:</h4>
<p>uninit static is zero-init (in C)</p>



<a name="261207678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207678">(Nov 12 2021 at 03:08)</a>:</h4>
<p>So it would be valid for anything that doesn't have zero as a niche.</p>



<a name="261207688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207688">(Nov 12 2021 at 03:08)</a>:</h4>
<p>(I guess normal C statics are 0-inited but presumably uninit'ed statics could be created somehow? also they could be de-inited, in principle. and there are other invalid values for u64, potentially, such as ptrs with provenance. so I wouldnt want to get hung up on the idea that some types might have "no invalid values" here.)</p>



<a name="261207712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207712">(Nov 12 2021 at 03:10)</a>:</h4>
<p>anyway I got to go eat something... ttyl</p>



<a name="261207759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207759">(Nov 12 2021 at 03:10)</a>:</h4>
<p>deiniting isn't possible in C without UB, except for character types.</p>



<a name="261207858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/261207858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#261207858">(Nov 12 2021 at 03:12)</a>:</h4>
<p>yeah, even if it was, I don't think that would be a deal breaker here -- you're just saying "this static is going to be valid <code>Cell&lt;u64&gt;</code> by declaring it in Rust.</p>
<p>Technically I guess that invalidates some patterns (e.g., you could imagine the C code is actually a union between different types but the Rust code only ever reads it when it's in the u64 state), but that doesn't seem particularly common (and potentially the answer there is that you just use some additional combinators like MaybeUninit).</p>



<a name="273857985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/Attribute%20for%20trusted%20external%20static%20declara%E2%80%A6%20lang-team%23118/near/273857985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/Attribute.20for.20trusted.20external.20static.20declara.E2.80.A6.20lang-team.23118.html#273857985">(Mar 02 2022 at 18:52)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="1977">@T-lang</span>: Proposal <a href="https://github.com/rust-lang/lang-team/issues/118#issuecomment-1057269205">#118</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>