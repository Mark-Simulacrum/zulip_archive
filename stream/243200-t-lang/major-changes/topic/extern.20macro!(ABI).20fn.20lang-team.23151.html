<html>
<head><meta charset="utf-8"><title>extern macro!(ABI) fn lang-team#151 · t-lang/major changes · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/index.html">t-lang/major changes</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html">extern macro!(ABI) fn lang-team#151</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275846685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275846685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275846685">(Mar 18 2022 at 18:49)</a>:</h4>
<p>A new proposal has been announced: <a href="https://github.com/rust-lang/lang-team/issues/151">extern macro!(ABI) fn #151</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>



<a name="275850360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275850360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275850360">(Mar 18 2022 at 19:18)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="1977">@T-lang</span>: Proposal <a href="https://github.com/rust-lang/lang-team/issues/151#issuecomment-1072730880">#151</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>



<a name="275858556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275858556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275858556">(Mar 18 2022 at 20:26)</a>:</h4>
<p>Would using a lot of little macros noticeably affect compile times? Say, hypothetically, the <a href="https://crates.io/crates/windows">windows</a> crate had to use <code>abi!(system)</code> for each <code>extern</code>? It can have a lot of them in COM vtables (e.g. <a href="https://github.com/microsoft/windows-rs/blob/a8c1a5a14f567551331ad74ba296edbbc1f89897/crates/libs/windows/src/Windows/Media/SpeechRecognition/mod.rs#L37-L81">one example</a> of many).</p>



<a name="275860846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275860846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275860846">(Mar 18 2022 at 20:50)</a>:</h4>
<p>In zig you can evaluate an ABI to a const and then put that const as the ABI of however many functions you want. That might be a little out of scope for what this MCP was about though.</p>



<a name="275865466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275865466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275865466">(Mar 18 2022 at 21:32)</a>:</h4>
<p>The motivation here comes mainly from <a href="https://github.com/rust-lang/rust/issues/42202">https://github.com/rust-lang/rust/issues/42202</a>, and that issue is better solved by making <code>thiscall</code> a "generic" ABI like <code>system</code>  (or by splitting <code>thiscall</code> into two ABIs, one generic and one concrete working only on i686, like <code>system</code> and <code>stdcall</code> pair), so that tools like bindgen can generate target-independent Rust signatures for C++ methods.</p>



<a name="275865783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275865783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275865783">(Mar 18 2022 at 21:35)</a>:</h4>
<p>I'm not aware of other ABIs, besides <code>stdcall</code> (due to WinAPI) and <code>thiscall</code> (due to C++) that need this kind of cross-platform treatment in practice.</p>



<a name="275867998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275867998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275867998">(Mar 18 2022 at 22:00)</a>:</h4>
<p>Related <a href="https://stackoverflow.com/q/49479854/155423">https://stackoverflow.com/q/49479854/155423</a></p>



<a name="275869021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275869021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275869021">(Mar 18 2022 at 22:13)</a>:</h4>
<p>If it's to solve a specific ABI concern, we can probably just add one extra ABI instead of opening up the macro worms</p>



<a name="275869809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275869809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275869809">(Mar 18 2022 at 22:22)</a>:</h4>
<p>I'd like this for lccc (host). I have a very annoying rustcall macro, that emulates the behaviour of lccc's extern "Rust" by expanding to either extern "C" or extern "fastcall" depending on the target. I'd love if I can just put the macro into the abi position instead of wrapping fn definitions, extern blocks, or types in this macro.</p>



<a name="275870009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275870009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275870009">(Mar 18 2022 at 22:25)</a>:</h4>
<p>I do this for several reasons, the main one being so that (when lccc self-hosts) I can exploit the known abi details to avoid stupidly slow emulation paths.</p>



<a name="275912772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275912772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275912772">(Mar 19 2022 at 14:21)</a>:</h4>
<p>I don't understand what the "macro worms" are that <span class="user-mention" data-user-id="224471">@Lokathor</span> is referencing. </p>
<p>To me, the ability to put a macro in that position is a way to <em>sidestep entirely</em> the debate that I see emerging on <a href="https://github.com/rust-lang/rust/issues/42202#issuecomment-1006213947">issue 42202</a>, where one group sees the current "hard error outside i686" behavior as desirable, while another group sees the "fallback to something reasonable outside i686" as desirable.</p>



<a name="275912851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275912851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275912851">(Mar 19 2022 at 14:23)</a>:</h4>
<p>Is the concern denoted by "macro worms", is it that it will complicate tools outside the compiler that want to be able to analyze Rust code, because a fixed (if ever growing) set of ABI strings is fundamentally easier to deal with an arbitrary macro expressions?</p>



<a name="275913062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275913062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275913062">(Mar 19 2022 at 14:28)</a>:</h4>
<p>Yeah, I'm unsure what the issue is within rust. It seems easy enough to change from parsing only a string literal into parsing string literal|macro invocation, speaking as someone who at this moment is writing a rust parser.</p>



<a name="275913072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275913072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275913072">(Mar 19 2022 at 14:28)</a>:</h4>
<p>Yeah I'm saying that macros are a "can of worms", as in "they're a whole lot of trouble". They're generally poorly documented, give poor errors, and work poorly with RA.</p>



<a name="275913164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275913164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275913164">(Mar 19 2022 at 14:30)</a>:</h4>
<p>IME, at least declarative macros are fine with RA. Only proc-macros have issues.</p>



<a name="275913181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275913181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275913181">(Mar 19 2022 at 14:31)</a>:</h4>
<p>declarative macros tend to give the worst errors when things go wrong</p>



<a name="275913253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275913253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275913253">(Mar 19 2022 at 14:33)</a>:</h4>
<p>If the point of expanding where macros can happen is to sidestep a single particular debate about if an ABI string has a fallback on inappropriate platforms then really we should just have that one debate and not spread where macros are used.</p>



<a name="275913708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/275913708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#275913708">(Mar 19 2022 at 14:44)</a>:</h4>
<p>It can also be used, as I mentioned above, as a more general selector based on cfg variables.<br>
<code>rustcall!("rustcall-v0")</code> isn't a case of "Pick fastcall where available, and fallback to C otherwise", its "the ABI of this function depends on the target".</p>



<a name="276580905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276580905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276580905">(Mar 25 2022 at 06:28)</a>:</h4>
<p>I don't think expanding to fastcall on x64 should be encouraged because essentially all ABI arguments on x64 are ignored. While I may have mentioned that the x64 Windows calling convention is like fastcall, it has quite a few changes.</p>



<a name="276581796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276581796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276581796">(Mar 25 2022 at 06:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276580905">said</a>:</p>
<blockquote>
<p>I don't think expanding to fastcall on x64 should be encouraged because essentially all ABI arguments on x64 are ignored. While I may have mentioned that the x64 Windows calling convention is like fastcall, it has quite a few changes.</p>
</blockquote>
<p>I do hope we eventually support both the Windows and SYSV calling conventions on x86-64 targets. It's useful to be able to cross-call, in some contexts (e.g. firmware)..</p>



<a name="276582613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276582613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276582613">(Mar 25 2022 at 07:05)</a>:</h4>
<p>There is the uefi calling convention. This matches the unix call conv on platforms that don't have windows support and the windows call conv on those that do I believe.</p>



<a name="276582673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276582673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276582673">(Mar 25 2022 at 07:06)</a>:</h4>
<p>There is the uefi calling convention. This matches the unix call conv on platforms that don't have windows support and the windows call conv on those that do I believe.</p>



<a name="276583407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276583407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276583407">(Mar 25 2022 at 07:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276581796">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276580905">said</a>:</p>
<blockquote>
<p>I don't think expanding to fastcall on x64 should be encouraged because essentially all ABI arguments on x64 are ignored. While I may have mentioned that the x64 Windows calling convention is like fastcall, it has quite a few changes.</p>
</blockquote>
<p>I do hope we eventually support both the Windows and SYSV calling conventions on x86-64 targets. It's useful to be able to cross-call, in some contexts (e.g. firmware)..</p>
</blockquote>
<p>We already support the Windows calling convention on x64. We call it <code>"C"</code>.</p>



<a name="276583478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276583478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276583478">(Mar 25 2022 at 07:18)</a>:</h4>
<p>We have actually made the worst possible choice arguably for being able to emit correct code when asked: we implemented the MSVC pattern of accepting arguments but ignoring them sometimes.</p>



<a name="276583766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276583766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276583766">(Mar 25 2022 at 07:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276583407">said</a>:</p>
<blockquote>
<p>We already support the Windows calling convention on x64. We call it <code>"C"</code>.</p>
</blockquote>
<p>( or win64, or sysv64 )</p>



<a name="276584624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276584624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276584624">(Mar 25 2022 at 07:40)</a>:</h4>
<p>Ah damn, I've definitely wanted this before, and recently, to switch between <code>extern "C"</code> and <code>extern "system"</code>. Bummer.</p>



<a name="276584795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276584795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276584795">(Mar 25 2022 at 07:43)</a>:</h4>
<p>Proc macros wouldn't really be great here because it would break compilation on musl, which the code currently otherwise supports.</p>



<a name="276584893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276584893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276584893">(Mar 25 2022 at 07:44)</a>:</h4>
<p>I was just going to pregenerate the bindgen output twice, once for windows (well, specifically, once for the windows version of this library which is different than the code it uses elsewhere) and once for everything else.</p>



<a name="276584897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276584897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276584897">(Mar 25 2022 at 07:44)</a>:</h4>
<p>But it would be nice to not need to do this</p>



<a name="276585050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585050">(Mar 25 2022 at 07:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276584795">said</a>:</p>
<blockquote>
<p>Proc macros wouldn't really be great here because it would break compilation on musl, which the code currently otherwise supports.</p>
</blockquote>
<p>musl being static-linked by default and screwing up the sysroot is just a bug tho'.</p>



<a name="276585193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585193">(Mar 25 2022 at 07:49)</a>:</h4>
<p>Even if musl became dynamically linked it would still be broken on targets with static CRT no?</p>



<a name="276585219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585219">(Mar 25 2022 at 07:49)</a>:</h4>
<p>A proc macro would also slow down builds of what would otherwise leaf of the crate graph a good amount.</p>



<a name="276585323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585323">(Mar 25 2022 at 07:51)</a>:</h4>
<p>What if we just make macros faster.</p>



<a name="276585693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585693">(Mar 25 2022 at 07:55)</a>:</h4>
<p>Proc macros? It seems impossible?</p>



<a name="276585739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585739">(Mar 25 2022 at 07:56)</a>:</h4>
<p>To make them as fast as declarative macros</p>



<a name="276585780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585780">(Mar 25 2022 at 07:56)</a>:</h4>
<p>None of these are options I'd take above pregenerating a separate file.</p>



<a name="276585836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585836">(Mar 25 2022 at 07:57)</a>:</h4>
<p>Except for the <code>extern abi!() { ... }</code>, at least. Which doesn't hold to the objection given.</p>



<a name="276585918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276585918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276585918">(Mar 25 2022 at 07:58)</a>:</h4>
<p><del>what if we JIT the proc macro</del> I mean uh</p>



<a name="276586539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276586539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276586539">(Mar 25 2022 at 08:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276585193">said</a>:</p>
<blockquote>
<p>Even if musl became dynamically linked it would still be broken on targets with static CRT no?</p>
</blockquote>
<p>Rustc doesn't support any targets with static CRT. rustc_driver is only built as dynamic library.</p>



<a name="276586595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276586595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276586595">(Mar 25 2022 at 08:07)</a>:</h4>
<p>Hmm, I see.</p>



<a name="276586612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276586612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276586612">(Mar 25 2022 at 08:07)</a>:</h4>
<p>Perhaps I'm mistaken at that point. I remember a reason that proc macros don't work on static targets, which has been that way for quite a while.</p>



<a name="276586908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276586908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276586908">(Mar 25 2022 at 08:11)</a>:</h4>
<p>They should work if you force dynamic linking of libc for the proc macro I think.</p>



<a name="276802491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276802491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276802491">(Mar 27 2022 at 19:01)</a>:</h4>
<p>All of the discussion so far seems to be about ABIs - I think the macro aspect needs further discussion</p>



<a name="276802553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276802553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276802553">(Mar 27 2022 at 19:02)</a>:</h4>
<p>As far as I know, this would be one of the few (if any) places where we support macro calls in some kind of 'header'</p>



<a name="276802576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276802576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276802576">(Mar 27 2022 at 19:03)</a>:</h4>
<p>e.g you can't write <code>fn bar(arg: mac!())</code> or <code>impl MyTrait for mac!()</code></p>



<a name="276802641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276802641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276802641">(Mar 27 2022 at 19:05)</a>:</h4>
<p>I don't have anything against allowing <code>extern macro!()</code>, but we might want to think about if there are any places where we definitely <em>don't</em> want to allow <code>mac!()</code></p>



<a name="276802704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276802704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276802704">(Mar 27 2022 at 19:06)</a>:</h4>
<p>For example, allowing macro calls at the <em>beginning</em> of some header seems like a nonstarter (e.g. <code>expand_to_extern!() "C" fn bar() { }</code>, since we would be unable to continue parsing until the macro is expanded</p>



<a name="276802713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276802713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276802713">(Mar 27 2022 at 19:06)</a>:</h4>
<p>but I don't know how many other cases will have similar issues</p>



<a name="276804805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276804805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276804805">(Mar 27 2022 at 19:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276802576">said</a>:</p>
<blockquote>
<p>e.g you can't write <code>fn bar(arg: mac!())</code> or <code>impl MyTrait for mac!()</code></p>
</blockquote>
<p>You can write those, since they're both type-position macros; I guess <code>impl mac!() for MyType {}</code> would be an example of something we can't yet do; or the infamous <code>fn concat_idents!(...) () {}</code></p>



<a name="276804906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/243200-t-lang/major%20changes/topic/extern%20macro%21%28ABI%29%20fn%20lang-team%23151/near/276804906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/243200-t-lang/major-changes/topic/extern.20macro!(ABI).20fn.20lang-team.23151.html#276804906">(Mar 27 2022 at 20:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/extern.20macro!.28ABI.29.20fn.20lang-team.23151/near/276802713">said</a>:</p>
<blockquote>
<p>but I don't know how many other cases will have similar issues</p>
</blockquote>
<p>I think that macro arms and where clauses are both common requirements, at least as witnessed from the amount of times people ask about it in the <code>#macros</code> channel of the Community Discord</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>