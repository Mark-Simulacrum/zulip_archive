<html>
<head><meta charset="utf-8"><title>Java dev struggles · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html">Java dev struggles</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258806593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Java%20dev%20struggles/near/258806593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brutus5000 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html#258806593">(Oct 23 2021 at 06:21)</a>:</h4>
<p>Hi there! I'm a Java dev trying to learn Rust and I need some help.</p>
<p>Obviously I'm trying to apply my Java/Spring/Dependency Injection patterns to Rust which causes me some problems.<br>
I wrote a tiny <a href="https://github.com/Brutus5000/contractmanager">command line app</a>. <br>
Apart from the main method I basically have 2 relevant services (in Java terms):<br>
ContractManager manages a Vec of contracts (struct with no impl) and the next index. You can create, remove and list items. <br>
EventRouter manages a Vec of events (just an enum) and reads/writes events from/to disk and processes them by matching the event type and delegating them to the ContractManager (looks stupid but I plan on more events and more services)</p>
<p>If the app starts it tries to load all historic events and replay them.<br>
This is where my problem started. After I load all historic events from disc I try to reprocess them (<a href="https://github.com/Brutus5000/contractmanager/blob/master/src/events/router.rs#L82">code</a>.</p>
<p>In my first iteration the contract manager required for create and remove a mutable reference to self (as it was changing the contract vec). This caused the calling method in EventRouter to also have a mutable reference to self.</p>
<p>But when processing an event required a mutable self reference, it did not work together with iter as it required a mutable borrow, where it already borrowed.</p>
<p>The solution was to put everything in ContractManager into RefCells so that the methods create and remove didn't need a mutable self reference. But for me this feels massively wrong. Just because an external caller has double borrow issues, I needed to modify the ContractManager.</p>
<p>So obviously I am  not doing it "the Rust way". Because if I continued working like that basically everything would end up in RefCell which can't be right. But iterating a vec and doing something mutable with it is like the most simple pattern that I can think of in Java. What is the alternative here? Where is my conceptual burden from Java causing issues?</p>



<a name="258807467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Java%20dev%20struggles/near/258807467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html#258807467">(Oct 23 2021 at 06:47)</a>:</h4>
<p>There are more ways to go about this, but one would be to think about:</p>
<ul>
<li>does it make sense for multiple <code>EventRouter</code>s to write into the same <code>ContractStore</code>?</li>
<li>should you be able to access the contracts while an <code>EventRouter</code> is replaying the log or doing work?</li>
</ul>



<a name="258807820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Java%20dev%20struggles/near/258807820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html#258807820">(Oct 23 2021 at 06:57)</a>:</h4>
<p>I think it makes sense for the <code>EventRouter</code> to own the <code>ContractStore</code>. It can provide a getter for anyone who wants to read it, but reading shouldn't happen while the store is being modified.</p>



<a name="258807896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Java%20dev%20struggles/near/258807896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html#258807896">(Oct 23 2021 at 07:00)</a>:</h4>
<p>This doesn't fix directly the <code>replay</code>/<code>process</code> interaction, but a common approach is to:</p>
<ul>
<li>remove the <code>self</code> parameter from <code>process</code> (instead it take a reference to what it needs to modify, <code>ContactStore</code>)</li>
<li>you'll still run into a capture error on <code>self</code> in the closure; there's another way around it, but the simplest solution is to change the project to the <code>2021</code> edition (just replace that in <code>Cargo.toml</code>)</li>
</ul>



<a name="258808007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Java%20dev%20struggles/near/258808007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html#258808007">(Oct 23 2021 at 07:01)</a>:</h4>
<p>This (<code>fn process(contract_store: &amp;mut ContractStore, event: &amp;Event)</code>) is the first solution from <a href="https://stackoverflow.com/a/38944523">https://stackoverflow.com/a/38944523</a></p>



<a name="258820566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Java%20dev%20struggles/near/258820566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brutus5000 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Java.20dev.20struggles.html#258820566">(Oct 23 2021 at 12:25)</a>:</h4>
<blockquote>
<p>does it make sense for multiple EventRouters to write into the same ContractStore</p>
</blockquote>
<p>No I would say both EventRouter and ContractStore would be singletons.</p>
<blockquote>
<p>should you be able to access the contracts while an EventRouter is replaying the log or doing work?</p>
</blockquote>
<p>There is no requirement for any concurrent access.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>