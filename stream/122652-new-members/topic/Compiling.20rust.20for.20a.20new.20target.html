<html>
<head><meta charset="utf-8"><title>Compiling rust for a new target · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Compiling.20rust.20for.20a.20new.20target.html">Compiling rust for a new target</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268072658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Compiling%20rust%20for%20a%20new%20target/near/268072658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> czapek <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Compiling.20rust.20for.20a.20new.20target.html#268072658">(Jan 14 2022 at 21:05)</a>:</h4>
<p>Hello, I'm trying to compile the rust compiler for a new target, I patched LLVM, rustc, std and all the necessary crates with support for my target and managed to build the compiler using this command: <code>./x.py build -i --stage 2 --host x86_64-unknown-aero-system --target x86_64-unknown-aero-system -j 4</code> but it fails to link with the following error: <a href="https://gist.github.com/czapek1337/597b229ecebeaabcb13058cc70962c82">https://gist.github.com/czapek1337/597b229ecebeaabcb13058cc70962c82</a><br>
Already having compiled a host cargo that can compile using a host compiler with support for that target I know I need to pass <code>-C link-args=-no-pie</code> to the rust compiler, but I'm unsure how because setting the <code>RUSTFLAGS</code> env will affect all invocations of rustc, which is not something I want to happen, and I can't find anything in config.toml that would let me do that.</p>



<a name="268082680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Compiling%20rust%20for%20a%20new%20target/near/268082680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Compiling.20rust.20for.20a.20new.20target.html#268082680">(Jan 14 2022 at 22:34)</a>:</h4>
<p>You can set <code>postion_independent_executables</code> to false in the target spec for the new target.</p>



<a name="268082735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Compiling%20rust%20for%20a%20new%20target/near/268082735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Compiling.20rust.20for.20a.20new.20target.html#268082735">(Jan 14 2022 at 22:35)</a>:</h4>
<p>Also you probably want to add the host triple to <code>--target</code>. Otherwise build scripts and proc macros can't be compiled by the resulting rustc.</p>



<a name="268083389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Compiling%20rust%20for%20a%20new%20target/near/268083389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> czapek <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Compiling.20rust.20for.20a.20new.20target.html#268083389">(Jan 14 2022 at 22:42)</a>:</h4>
<p>So I would set that field in the spec in the <code>rustc_target</code> crate instead of passing the option through the command line? Also I am only interested in building a compiler that can be ran on the target architecture, should I still add the host triple I am building on to the <code>--target</code>s?</p>



<a name="268085481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Compiling%20rust%20for%20a%20new%20target/near/268085481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> czapek <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Compiling.20rust.20for.20a.20new.20target.html#268085481">(Jan 14 2022 at 23:03)</a>:</h4>
<p>Okay that seems to have solved the issue, now I'm just getting some linker errors but I'll try to figure that out myself, thanks! :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>