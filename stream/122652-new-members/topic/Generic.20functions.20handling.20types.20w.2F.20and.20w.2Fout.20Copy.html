<html>
<head><meta charset="utf-8"><title>Generic functions handling types w/ and w/out Copy · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Generic.20functions.20handling.20types.20w.2F.20and.20w.2Fout.20Copy.html">Generic functions handling types w/ and w/out Copy</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269346542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Generic%20functions%20handling%20types%20w/%20and%20w/out%20Copy/near/269346542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> chriselrod <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Generic.20functions.20handling.20types.20w.2F.20and.20w.2Fout.20Copy.html#269346542">(Jan 26 2022 at 00:27)</a>:</h4>
<p>I would like to write generic code supporting <code>Copy</code> and non-<code>Copy</code> types.<br>
My current approach is a bit heavy on the boiler plate.</p>
<p>Here is a minimal example:<br>
Say I have a struct <code>Things</code> that holds some object(s) <code>T</code> and wants to do things with them that may be implemented without references on <code>Copy</code> objects but using pass-by-reference with non-<code>Copy</code> objects to avoid moving (which is likely to be illegal).</p>
<p>I'm using <code>/</code> as an example operation that's cheap and implemented on <code>isize</code> but not <code>&amp;isize</code>.<br>
I may also have <code>/</code> implemented on objects requiring allocation that are preferably passed by reference and not moved.</p>
<p>So my current approach is to add some boiler plate like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">DivReference</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// trait for the function I want to have in both reference and value forms</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">div</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">DivReference</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">isize</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// copy for `Copy` objects</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">div</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">other</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">impl DivReference for ... {</span>
<span class="cm">    implement some other specializations for the more expensive types</span>
<span class="cm">    requiring allocation (e.g. things like matrices or polynomials)</span>
<span class="cm">}</span>
<span class="cm">*/</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Things</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// some form of generic on `T`</span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Things</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nc">DivReference</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">my_div</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">DivReference</span>::<span class="n">div</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Is there any good pattern to follow for this sort of generic code?</p>
<p>Perhaps there is some different approach that accomplishes this aim much more effectively.<br>
Or perhaps, failing that, there's a way to improve this same basic approach, e.g. implementing a generic that does this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">DivReference</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">isize</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">div</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">other</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but for anything with traits <code>std::ops::Div + Copy</code> instead of specifically specifying each particular type I want to support, such as <code>isize</code> above.</p>
<p>(If you'd like some motivation, elements of matrices or coefficients of polynomials may trivially copy-able numbers, or could themselves be structures like matrices or polynomials. Hence, it's natural for algorithms working on these types to support efficiently handling many different element types.)</p>



<a name="269347863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Generic%20functions%20handling%20types%20w/%20and%20w/out%20Copy/near/269347863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Generic.20functions.20handling.20types.20w.2F.20and.20w.2Fout.20Copy.html#269347863">(Jan 26 2022 at 00:44)</a>:</h4>
<p>Uhh, <code>impl&lt;'_&gt; Div&lt;&amp;'_ isize&gt; for isize</code> is there, at least.</p>
<p>From what I've seen it's pretty normal to just add a bunch of those extra impls with macros to make it a bit less annoying.</p>
<p>(One day we'll hopefully have a bunch of <code>default impl</code>s for <code>Copy</code> stuff so that the impls for references will be there without you needing to write them out explicitly.)</p>



<a name="269348199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Generic%20functions%20handling%20types%20w/%20and%20w/out%20Copy/near/269348199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> chriselrod <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Generic.20functions.20handling.20types.20w.2F.20and.20w.2Fout.20Copy.html#269348199">(Jan 26 2022 at 00:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/122652-new-members/topic/Generic.20functions.20handling.20types.20w.2F.20and.20w.2Fout.20Copy/near/269347863">said</a>:</p>
<blockquote>
<p>Uhh, <code>impl&lt;'_&gt; Div&lt;&amp;'_ isize&gt; for isize</code> is there, at least.</p>
</blockquote>
<p>Ah, great -- so I should use that for my where clause instead of <code>Div</code> for this particular example, and then there'd be no need for <code>DivReference</code>.</p>
<p>But more generally, sounds like implementing macros to reduce boiler plate would be a good idea. Thanks!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>