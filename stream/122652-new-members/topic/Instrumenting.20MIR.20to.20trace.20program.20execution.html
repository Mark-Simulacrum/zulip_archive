<html>
<head><meta charset="utf-8"><title>Instrumenting MIR to trace program execution · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Instrumenting.20MIR.20to.20trace.20program.20execution.html">Instrumenting MIR to trace program execution</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259428124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Instrumenting%20MIR%20to%20trace%20program%20execution/near/259428124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vsevolod Tymofyeyev <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Instrumenting.20MIR.20to.20trace.20program.20execution.html#259428124">(Oct 28 2021 at 17:59)</a>:</h4>
<p>Hello everyone,</p>
<p>I'm a master's student and I'm quite new to Rust, especially as far as the compiler itself is concerned. Currently, I'm writing my thesis on testing with Rust and I'd like to instrument Rust programs and insert additional function calls in certain branches (e.g., after if's) that trace the execution of a branch along with additional information. For this, I need the condition expressions to be atomic, which is why MIR seems to me to be most suitable.</p>
<p>From this <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Modifying.20the.20MIR.20of.20a.20function.20from.20rustc_driver.html">archive post</a>, I learned that I can modify MIR and pass the modified version back to the compiler. So what I do is run the compiler and register my own function where I modify the MIR of a function body:</p>
<div class="codehilite"><pre><span></span><code>const CUSTOM_OPT_MIR: for&lt;&#39;tcx&gt; fn(_: TyCtxt&lt;&#39;tcx&gt;, _: DefId) -&gt; &amp;&#39;tcx Body&lt;&#39;tcx&gt; = |tcx, def| {
    let opt_mir = rustc_interface::DEFAULT_QUERY_PROVIDERS
        .borrow()
        .optimized_mir;
    let mut body = opt_mir(tcx, def).clone();

    let mut mir_visitor = MirVisitor { tcx };

    mir_visitor.visit_body(&amp;mut body);
    tcx.arena.alloc(body)
};

struct CompilerCallbacks;

impl rustc_driver::Callbacks for CompilerCallbacks {
    fn config(&amp;mut self, _config: &amp;mut Config) {
        _config.override_queries = Some(|session, local, external| {
            local.optimized_mir = CUSTOM_OPT_MIR;
        });
    }
}

fn main() {
    // define args and stuff

    let mut callbacks = CompilerCallbacks {};
    rustc_driver::RunCompiler::new(&amp;args, &amp;mut callbacks)
        .run()
        .unwrap();
}
</code></pre></div>
<p>Now, this seems to work. In my MirVisitor, I want to insert a function call at some point. Let's assume I have the following program I try to instrument and a dummy tracing function:</p>
<div class="codehilite"><pre><span></span><code>use
mod monitor {
    pub fn trace() {
        // do something
    }
}

fn main() {
    let inputs: Vec&lt;u64&gt; = std::env::args()
        .map(|a| a.parse::&lt;u64&gt;().unwrap())
        .take(2)
        .collect();
    let x = *inputs.get(0).unwrap();
    let y = *inputs.get(1).unwrap();

    if x &lt; y {
        println!(&quot;x &lt; y&quot;);
    } else {
        println!(&quot;x &gt;= y&quot;);
    }
}
</code></pre></div>
<p>The relevant basic block in the MIR of the main function looks like this: </p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>bb10: {
        _12 = (*_13);
        _19 = _6;
        _20 = _12;
        _18 = Lt(move _19, move _20);
        switchInt(move _18) -&gt; [false: bb13, otherwise: bb11];
    }
</code></pre></div>
<p>Now I want to call the monitor::trace function directly after that, on both control paths. A function call is a terminator, so I could insert a whole new basic block for each branch and let it point to the original descendent blocks, i.e.,</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>bb10: {
        _12 = (*_13);
        _19 = _6;
        _20 = _12;
        _18 = Lt(move _19, move _20);
        switchInt(move _18) -&gt; [false: bb14, otherwise: bb15];
    }


bb14: {
        _22 = monitor::trace() -&gt; [return: bb13, unwind: ...];
    }


bb15: {
        _23 = monitor::trace() -&gt; [return: bb11, unwind: ...];
    }
</code></pre></div>
<p>I understand that I will also need to add the locals, however, I don't even know how to create such an artificial function call programmatically in the first place. A part of the <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_middle/mir/terminator/struct.Terminator.html">Terminator</a> struct is a reference (ConstantKind::Ty). Hence, the basic block I initialize does not live long enough to be passed back to the compiler :( </p>
<p>Is there a way to implement this idea anyway? Maybe in a different way? Note that I don't just want to trace coverage, but also make computations based on the runtime values used in condition expressions and so on.</p>



<a name="259432201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Instrumenting%20MIR%20to%20trace%20program%20execution/near/259432201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Instrumenting.20MIR.20to.20trace.20program.20execution.html#259432201">(Oct 28 2021 at 18:30)</a>:</h4>
<p>Consider asking in #t-compiler/wg-mir-opt, this is kind of a specialized question haha</p>



<a name="259432862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Instrumenting%20MIR%20to%20trace%20program%20execution/near/259432862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vsevolod Tymofyeyev <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Instrumenting.20MIR.20to.20trace.20program.20execution.html#259432862">(Oct 28 2021 at 18:35)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> thanks, gonna do this :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>