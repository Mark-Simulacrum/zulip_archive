<html>
<head><meta charset="utf-8"><title>disable inline if lto=fat enabled · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html">disable inline if lto=fat enabled</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275379230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275379230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275379230">(Mar 15 2022 at 14:22)</a>:</h4>
<p>Hi all, nice to meet you~ <br>
After some search, I got the idea that "if I enable lto=fat, then I can disable inline from rustc side". Any catch?</p>



<a name="275379414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275379414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275379414">(Mar 15 2022 at 14:24)</a>:</h4>
<p>The reason why I do this is, I found some case that even for functions with large body, as long as they are marked #[inline] then it will be instantiated in client crate, which actually makes the final output bloated.</p>



<a name="275381580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275381580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275381580">(Mar 15 2022 at 14:40)</a>:</h4>
<p>There are functions in the standard library marked as inline that must only be codegened when actually used. For example the simd functions on wasm. Codegenning those when not used would force the wasm runtime to support simd even if no simd is used at all.</p>



<a name="275381697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275381697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275381697">(Mar 15 2022 at 14:41)</a>:</h4>
<p>Also how would it handle mixing a libstd not compiled with -Clto=fat with a user crate compiled with -Clto=fat?</p>



<a name="275382302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275382302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275382302">(Mar 15 2022 at 14:44)</a>:</h4>
<p>lto happened at link time, and the libstd actually more like a static lib/object files, so whether libstd compiled with or without lto=fat actually doesn't matter?</p>



<a name="275382835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275382835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275382835">(Mar 15 2022 at 14:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275381580">said</a>:</p>
<blockquote>
<p>There are functions in the standard library marked as inline that must only be codegened when actually used. For example the simd functions on wasm. Codegenning those when not used would force the wasm runtime to support simd even if no simd is used at all.</p>
</blockquote>
<p>So they are marked as inline(always)?</p>



<a name="275390597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275390597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275390597">(Mar 15 2022 at 15:42)</a>:</h4>
<p>Libstd is compiled once with both object files and with bitcode. The object files are used when lto is disabled and the bitcode when lto is enabled. The same llvm ir is used for both.</p>



<a name="275390726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275390726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275390726">(Mar 15 2022 at 15:43)</a>:</h4>
<p>I don't think those functions are marked as inline(always). I think they are simply marked as inline. This is enough for current rustc as only used inline functions are actually codegened right now.</p>



<a name="275391172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275391172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275391172">(Mar 15 2022 at 15:46)</a>:</h4>
<p>reading this dialogue, I'm wondering if we should have an attribute to actually say "only codegen this if it is actually used." I don't think <code>inline</code> <em>or</em> <code>inline(always)</code> really convey that at all.</p>



<a name="275395959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275395959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275395959">(Mar 15 2022 at 16:16)</a>:</h4>
<p>that would either still depend on the mono item collector implementation or force all callers to behave as if they have the attribute too.</p>



<a name="275402114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275402114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275402114">(Mar 15 2022 at 16:56)</a>:</h4>
<p>I was thinking of an MIR pass which disables inline if opt-level is "MinSize" and lto=fat. But now it seems being blocked by the simd like functions. Despite simd like functions, any other catches? e.g: In performance wise</p>



<a name="275403579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275403579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275403579">(Mar 15 2022 at 17:05)</a>:</h4>
<p>How about remove the #[inline] from Clone and Default deriving macro if opt-level is "MinSize", is it a good idea?</p>



<a name="275404826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275404826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275404826">(Mar 15 2022 at 17:12)</a>:</h4>
<p>I think the inline attribute also adds a generic LLVM inline hint. Personally, I _really_ want this gone because <code>#[inline]</code> does two things and the codegen delay is far more influential and the fact that it does two things makes the attribute hard to explain. I would be very happy if we separated the codegen ordering property into a new attribute.</p>



<a name="275404908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275404908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275404908">(Mar 15 2022 at 17:13)</a>:</h4>
<p>So my concern with only doing what you're suggesting is that it will cause less inlining, because the hint will be missing.</p>



<a name="275405497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275405497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275405497">(Mar 15 2022 at 17:17)</a>:</h4>
<p>yea, inline hint is missing, but lto=fat kinda equals tell llvm to set inline for all functions(not sure about this, pls correct me if wrong). So the final binary should be kinda similar.</p>



<a name="275405883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275405883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275405883">(Mar 15 2022 at 17:19)</a>:</h4>
<p>Also if enable size min opt level, llvm will kick in a function outline optimize pass, which may revert what inline just did?</p>



<a name="275406473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275406473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275406473">(Mar 15 2022 at 17:24)</a>:</h4>
<p>btw, time is late in my timezone, will come back later~ thanks for your help~</p>



<a name="275408638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275408638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275408638">(Mar 15 2022 at 17:41)</a>:</h4>
<p>No, lto makes it possible for every function to be inlined. The inlinehint attribute tells llvm to be a bit more eager to inline functions even if it otherwise thinks doing so would not be profitable.</p>



<a name="275408744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275408744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275408744">(Mar 15 2022 at 17:42)</a>:</h4>
<p>There is also the alwaysinline attribute which makes llvm disregard inlining cost completely afaik.</p>



<a name="275451066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275451066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275451066">(Mar 15 2022 at 23:42)</a>:</h4>
<p>I think that is expected when optimize for size.<br>
So I think there are two possible follow ups:</p>
<ol>
<li>Add a new attribute for "gen_at_call_site"</li>
<li>Remove inline attribute where applicable if opt level is SizeMin</li>
</ol>
<p>Is it right? I can fire a pr for 2. <br>
For 1, though I'd like to, but  I don't have enough knowledge to do it.</p>
<p>EDIT: format</p>



<a name="275458890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275458890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275458890">(Mar 16 2022 at 01:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275408638">said</a>:</p>
<blockquote>
<p>No, lto makes it possible for every function to be inlined. The inlinehint attribute tells llvm to be a bit more eager to inline functions even if it otherwise thinks doing so would not be profitable.</p>
</blockquote>
<p>Is it possible to disable inline in rustc side, and still keep the llvm inline hint? I think it is doable, but is it a good idea?</p>



<a name="275784496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275784496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275784496">(Mar 18 2022 at 10:32)</a>:</h4>
<p>We could definitely add an experimental -Z flag that disables just the delayed codegen but otherwise does not affect inline attributes, but wouldn't that still break the SIMD case?</p>



<a name="275784620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275784620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275784620">(Mar 18 2022 at 10:33)</a>:</h4>
<p>Maybe mark simd cases as inline(always) first?</p>



<a name="275784791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275784791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275784791">(Mar 18 2022 at 10:35)</a>:</h4>
<p>I don't see anything wrong with that, but better ask the SIMD people first. cc <span class="user-mention" data-user-id="281757">@Jubilee</span></p>



<a name="275893672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275893672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275893672">(Mar 19 2022 at 06:37)</a>:</h4>
<p>No, this would brutally pessimize cases where it would actually need correctly outlining.</p>



<a name="275893806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275893806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275893806">(Mar 19 2022 at 06:40)</a>:</h4>
<p>The way inlining hints to LLVM work, if a function <strong>usually</strong> benefits from being inlined, and it is not <strong>obvious</strong> it should be inlined, <code>#[inline]</code> is the correct annotation, but <code>#[inline(always)]</code> never is, because in spite of being a "hint" that LLVM can technically ignore, it usually hits the threshold numbers in such a way that it overrides good sense and cases where LLVM would otherwise back out. And SIMD is actually not a case where it benefits from overriding inlining logic always, it just needs to be more aggressive than the default inlining heuristic LLVM uses.</p>



<a name="275894073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275894073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275894073">(Mar 19 2022 at 06:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="484782">Shuo Li</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275451066">said</a>:</p>
<blockquote>
<ol>
<li>Add a new attribute for "gen_at_call_site"</li>
<li>Remove inline attribute where applicable if opt level is SizeMin</li>
</ol>
</blockquote>
<p>You are missing a 3rd option:<br>
Increase the <strong>default</strong> LLVM inlining hints generated by rustc so we can back out adding <code>#[inline]</code> everywhere.</p>



<a name="275894499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275894499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275894499">(Mar 19 2022 at 06:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275893672">said</a>:</p>
<blockquote>
<p>No, this would brutally pessimize cases where it would actually need correctly outlining.</p>
</blockquote>
<p>The current case essentially means every SIMD function has a prologue and epilogue about the size of a moderately complex SIMD function itself... load from memory once per operand into SIMD registers, and then store SIMD register to mem once per return value, and then zero the tops of the registers. In the case of a simple <code>add2vecs</code> function, that's adding about four instructions, and storing/loading to the top of the stack is not an overwhelming penalty, but neither is it completely free.</p>
<p>However, creating a massively over-heavy function via <code>#{inline(always)]</code> can result in much more punitive codegen consequences than hitting the prologue/epilogue, and <code>#[inline(always)]</code> has consistently proven to be the Wrong Choice Most Of The Time.</p>



<a name="275900806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275900806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275900806">(Mar 19 2022 at 09:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275381580">said</a>:</p>
<blockquote>
<p>There are functions in the standard library marked as inline that must only be codegened when actually used. For example the simd functions on wasm. Codegenning those when not used would force the wasm runtime to support simd even if no simd is used at all.</p>
</blockquote>
<p>From <span class="user-mention" data-user-id="133247">@bjorn3</span> 's comment, I thought inline for simd is not an optimization but a requirement. That's why I think <code>inline(always)</code> or create a new <code>codegen_at_callsite</code> is a good idea. Correct me if i'm wrong.</p>



<a name="275900904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275900904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275900904">(Mar 19 2022 at 09:43)</a>:</h4>
<p>The inlining itself is not a requirement. The delayed codegen that is currently associated with <code>#[inline]</code> is required.</p>



<a name="275901404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275901404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275901404">(Mar 19 2022 at 09:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275900904">said</a>:</p>
<blockquote>
<p>The inlining itself is not a requirement. The delayed codegen that is currently associated with <code>#[inline]</code> is required.</p>
</blockquote>
<p>Yes, that's what I mean. <br>
Here is my understanding:</p>
<ol>
<li>For simd, we should create a new attribute for delayed codegen, which doesn't interfere with inline behavior. </li>
<li>For MinSize opt level, we should omit <code>#[inline]</code> and pass through <code>#[inline(always)]</code> to reduce duplicate code in final output.</li>
<li>If we increase LLVM inline threshold, maybe we can skip MIR inline pass and let llvm to do all inline business, so we don't need to do late codegen for <code>#[inline]</code>, still inline hint is passed to llvm.</li>
</ol>



<a name="275901656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275901656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275901656">(Mar 19 2022 at 10:00)</a>:</h4>
<p>If you use <code>-Copt-level=z</code> you probably want to use LTO too which allows LLVM to deduplicate functions across the whole program so <code>#[inline]</code> probably won't have any effect on the output size.</p>



<a name="275901772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275901772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275901772">(Mar 19 2022 at 10:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275901656">said</a>:</p>
<blockquote>
<p>If you use <code>-Copt-level=z</code> you probably want to use LTO too which allows LLVM to deduplicate functions across the whole program so <code>#[inline]</code> probably won't have any effect on the output size.</p>
</blockquote>
<p>I tried, it didn't. Actually that is the reason why I opened the issue(<a href="https://github.com/rust-lang/rust/issues/94795">https://github.com/rust-lang/rust/issues/94795</a>).</p>



<a name="275901829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275901829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275901829">(Mar 19 2022 at 10:02)</a>:</h4>
<p>I guess maybe some MIR pass modified the body so they are not same in LLVM eyes.</p>



<a name="275913411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275913411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275913411">(Mar 19 2022 at 14:36)</a>:</h4>
<p>I just read code in <a href="http://mono.rs">mono.rs</a>, there is a function called instantiation_mode, which seems decides whether to create a local copy or use the global copy, is it a good idea we just modify this function, add a small branch that "In MinSize mode, prefer global copy, but if the codegen required, then do LocalCopy?"</p>



<a name="275915100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275915100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275915100">(Mar 19 2022 at 15:18)</a>:</h4>
<p>FYI related info: <a href="https://users.rust-lang.org/t/enable-cross-crate-inlining-without-suggesting-inlining/55004/9">https://users.rust-lang.org/t/enable-cross-crate-inlining-without-suggesting-inlining/55004/9</a>.</p>



<a name="275919026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275919026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275919026">(Mar 19 2022 at 16:58)</a>:</h4>
<p><a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Adjusting.20inline.20logic.20to.20minimize.20code.20size">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Adjusting.20inline.20logic.20to.20minimize.20code.20size</a></p>



<a name="275943913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275943913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275943913">(Mar 20 2022 at 03:06)</a>:</h4>
<p>I did an experiment:</p>
<ol>
<li>modify <a href="http://mono.rs">mono.rs</a> as</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">instantiation_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">InstantiationMode</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">generate_cgu_internal_copies</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">opts</span><span class="p">.</span><span class="n">debugging_opts</span><span class="p">.</span><span class="n">inline_in_all_cgus</span><span class="p">.</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">opts</span><span class="p">.</span><span class="n">optimize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OptLevel</span>::<span class="n">No</span><span class="w"></span>
<span class="w">                   </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">opts</span><span class="p">.</span><span class="n">optimize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OptLevel</span>::<span class="n">SizeMin</span><span class="w">  </span><span class="c1">// also prevent local codegen for size min</span>
<span class="w">            </span><span class="p">})</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">link_dead_code</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>And build the toolchain, then link it as <code>dev</code>.</p>
<ol start="2">
<li>then build the whole project with SizeMin optlevel with <code>nightly</code> and <code>dev</code>. <br>
The result looks promising, with <code>lto=thin</code>, the nightly build is smaller, with <code>lto=fat</code>, the <code>dev</code> is smaller.<br>
Another observation is compile time, <code>dev</code> compile time is around 2800s, and <code>nightly</code> around 3200s. <br>
It is not a proper benchmark, the building process is time consuming, so I just try once per build profile.</li>
</ol>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>lib_dev_lto_thin.dylib            <span class="m">75298888</span>
lib_dev_lto_fat.dylib               <span class="m">64617632</span>
lib_nightly_lto_thin.dylib     <span class="m">73419952</span>
lib_nightly_lto_fat.dylib        <span class="m">66606364</span>
</code></pre></div>
<p>EDIT: The compile time is from my blur memory, could be wrong.</p>



<a name="275985205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/275985205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#275985205">(Mar 20 2022 at 20:06)</a>:</h4>
<p>That seems interesting. <span class="user-mention" data-user-id="484782">@Shuo Li</span> If you have a patch that you would like to try, feel free to open a PR. An important check will be a perf run as whatever happens can't degrade the compiler speed on normal execution significantly, and anything size-changing can do that.</p>



<a name="276000280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/276000280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#276000280">(Mar 21 2022 at 02:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled/near/275985205">said</a>:</p>
<blockquote>
<p>That seems interesting. <span class="user-mention silent" data-user-id="484782">Shuo Li</span> If you have a patch that you would like to try, feel free to open a PR. An important check will be a perf run as whatever happens can't degrade the compiler speed on normal execution significantly, and anything size-changing can do that.</p>
</blockquote>
<p>sure, I plan to do more test today, create a small &amp; fast demo project to see whether this is consistent. Will fire a pr later.</p>



<a name="276154885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/disable%20inline%20if%20lto%3Dfat%20enabled/near/276154885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/disable.20inline.20if.20lto.3Dfat.20enabled.html#276154885">(Mar 22 2022 at 08:18)</a>:</h4>
<p>I can not reproduce the result for smaller projects, and I do think the whole <code>inline</code> + optimization is so COMPLEX that I not able to reason it.. In cases opt-level <code>s</code> is the smallest, even smaller than <code>z</code>.<br>
I am trying to attack this in another angle, create a test suite that easily build existing open source project with different profile.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>