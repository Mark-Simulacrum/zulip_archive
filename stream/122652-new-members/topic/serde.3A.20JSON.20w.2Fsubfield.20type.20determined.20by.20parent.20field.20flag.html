<html>
<head><meta charset="utf-8"><title>serde: JSON w/subfield type determined by parent field flag · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html">serde: JSON w/subfield type determined by parent field flag</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264263535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/serde%3A%20JSON%20w/subfield%20type%20determined%20by%20parent%20field%20flag/near/264263535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Clark <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html#264263535">(Dec 09 2021 at 07:00)</a>:</h4>
<p>Trying to deserialize the "details" subfield of the Item API at <a href="https://wiki.guildwars2.com/wiki/API:2/items">https://wiki.guildwars2.com/wiki/API:2/items</a> - the type of the detail field varies based on the type field of the Item. I specifically only want the details if the parent type is "Consumable" (this is being reserialized to cache it, and I don't want code and data bloat).</p>
<p>I don't believe a custom deserialize_with for the details field can check the flag on the parent, and I'm leery of trying to write an entire custom deserializer. I've tried a wrapper enum with a generic Item&lt;T&gt; specified by Type - I got stuck when trying to convert <code>&amp;Item&lt;ConsumableDetails&gt;</code> to <code>&amp;Item&lt;Ignore&gt;</code>. Using (Item) and (Item, ConsumableDetails) in the Enum wasn't picked up on by serde.</p>
<p>Serde appears to switch enum types on <code>type</code> in the JSON - but I only need the child details field to change types, in practice.</p>
<p>The below code works, though it ignores the details field. How would you add it?</p>
<div class="codehilite"><pre><span></span><code>#[derive(Debug, Serialize, Deserialize)]
pub struct Item {
    pub id: u32,
    pub name: String,
    #[serde(rename = &quot;type&quot;)]
    item_type: ItemType,
    rarity: ItemRarity,
    level: i32,
    vendor_value: i32,
    flags: Vec&lt;ItemFlag&gt;,
    restrictions: Vec&lt;String&gt;,
    upgrades_into: Option&lt;Vec&lt;ItemUpgrade&gt;&gt;,
    upgrades_from: Option&lt;Vec&lt;ItemUpgrade&gt;&gt;,
}
</code></pre></div>
<ul>
<li>The entire code can be found at <a href="https://github.com/t-mw/gw2-arbitrage/blob/master/src/api.rs#L66">https://github.com/t-mw/gw2-arbitrage/blob/master/src/api.rs#L66</a></li>
</ul>



<a name="264268391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/serde%3A%20JSON%20w/subfield%20type%20determined%20by%20parent%20field%20flag/near/264268391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Saparelli <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html#264268391">(Dec 09 2021 at 08:18)</a>:</h4>
<p>I would write a deserialize_with for the <em>Item</em> instead. With a little code duplication (though might be dedupeable, not sure), you can write a <code>#[derive(Deserialize)] struct ItemDeser { /* all fields except details */ }</code> and use that within the deserializer (so you don't have to write the whole thing), then convert it into an proper <code>Item</code>.</p>



<a name="264271228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/serde%3A%20JSON%20w/subfield%20type%20determined%20by%20parent%20field%20flag/near/264271228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Félix Saparelli <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html#264271228">(Dec 09 2021 at 08:50)</a>:</h4>
<p>Like this: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=eed35aa937bf9c5dc50bb0eba0322819">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=eed35aa937bf9c5dc50bb0eba0322819</a></p>



<a name="264743470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/serde%3A%20JSON%20w/subfield%20type%20determined%20by%20parent%20field%20flag/near/264743470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Clark <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html#264743470">(Dec 13 2021 at 17:44)</a>:</h4>
<p>Thank you.</p>
<p>The concept seems to work, but  won't deserialize from the bincode cache now, probably due to relying on serde_json::Value and the related warnings. As I'm a bit shaky on how the deserializer works already, I'm not sure how to fix it (and I suspect it'll be harder too).</p>
<p>I'll keep reading the Rust book and serde docs to see if I can understand this system well enough.</p>



<a name="264749935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/serde%3A%20JSON%20w/subfield%20type%20determined%20by%20parent%20field%20flag/near/264749935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Clark <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html#264749935">(Dec 13 2021 at 18:28)</a>:</h4>
<p>Is there a way to have different deserialize code run based on different input formats? The default deserializer does work fine for the bincode.</p>



<a name="264765508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/serde%3A%20JSON%20w/subfield%20type%20determined%20by%20parent%20field%20flag/near/264765508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Clark <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/serde.3A.20JSON.20w.2Fsubfield.20type.20determined.20by.20parent.20field.20flag.html#264765508">(Dec 13 2021 at 20:28)</a>:</h4>
<p>I'll open this as a new question.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>