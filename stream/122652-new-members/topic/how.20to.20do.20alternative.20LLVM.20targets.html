<html>
<head><meta charset="utf-8"><title>how to do alternative LLVM targets · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html">how to do alternative LLVM targets</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274703496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/274703496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#274703496">(Mar 09 2022 at 15:26)</a>:</h4>
<p>(I'll move the message to a new topics with a more specific subject line.)</p>



<a name="274843927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/274843927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#274843927">(Mar 10 2022 at 14:44)</a>:</h4>
<p>Thanks, for creating a new topic. I am looking forward to hearing more about Rust on custom LLVM targets :)</p>



<a name="274844595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/274844595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#274844595">(Mar 10 2022 at 14:49)</a>:</h4>
<p>(its possible that I should have outright moved it to <a class="stream" data-stream-id="187780" href="/#narrow/stream/187780-t-compiler.2Fwg-llvm">#t-compiler/wg-llvm</a> , but I figured I'd keep it underneath <a class="stream" data-stream-id="122652" href="/#narrow/stream/122652-new-members">#new members</a>  for the short term...)</p>



<a name="276162296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/276162296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#276162296">(Mar 22 2022 at 09:38)</a>:</h4>
<p>I supported the architecture, but I have some concerns about the testing. Is there any test suite to check the functionality of the toolchain?</p>



<a name="276164732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/276164732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#276164732">(Mar 22 2022 at 10:02)</a>:</h4>
<p>./x.py test</p>



<a name="276174419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/276174419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#276174419">(Mar 22 2022 at 11:33)</a>:</h4>
<p><span class="user-mention" data-user-id="482770">@Rithik Sharma</span> see also <a href="https://rustc-dev-guide.rust-lang.org/tests/intro.html">https://rustc-dev-guide.rust-lang.org/tests/intro.html</a> , which will cover <code>x.py test</code> (and is just one chapter in a broader book about rustc development).</p>



<a name="276174743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/276174743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#276174743">(Mar 22 2022 at 11:36)</a>:</h4>
<p>Thanks for the information :)</p>



<a name="277850914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277850914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277850914">(Apr 05 2022 at 09:40)</a>:</h4>
<p>I have a question about generating target specific code from a newly added architecture.</p>
<p>I am trying to generate code for my newly added architecture. and the issue is that it doesn't follow up the data layout specified for the architecture, instead it points out to some other target with other pointer sizes and generate error with wrong specification of target pointer sizes, the other target seems to be my machine on which I am running my Rust toolchain.</p>
<p>How I should generate code specifically for a target?</p>



<a name="277851136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277851136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277851136">(Apr 05 2022 at 09:42)</a>:</h4>
<p>Did you set the <code>data-layout</code> field of the target spec correctly?</p>



<a name="277851285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277851285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277851285">(Apr 05 2022 at 09:43)</a>:</h4>
<p>I already have a working LLVM toolchain of the specific arch, and I used the same data layout for the Rust toolchain.</p>



<a name="277851411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277851411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277851411">(Apr 05 2022 at 09:44)</a>:</h4>
<p>Is there code you could share? It's a bit too vague for me to help I think.</p>



<a name="277853839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277853839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277853839">(Apr 05 2022 at 10:05)</a>:</h4>
<p>Umm sorry, I am afraid that I don't have permissions to share code about my bachelor's thesis until it is approved by the University. I can try telling you what I did in the past, and what I am hoping to do.</p>
<p>I had an LLVM C/C++ tool-chain with our target X, I am calling it X for now. X is a fully functional tool-chain, and works perfectly with C/C++ use cases. X is not a up-streamed Target, and is not available in the Master or experimental version of LLVM. I want X target to be added to the Rust frontend, and to do so I statically linked the LLVM C/C++ toolchain via LLVM-Config option in Config.toml, after which I added X as an expermental target, and manually patched on the Rust toolchain. I used the same data layout which we had in the functional LLVM C/C++ toolchain, which resulted in:</p>
<p><em>rustc src/main.rs --target=X</em></p>
<p><em>error: inconsistent target specification: "data-layout" claims pointers are 32-bit, while "target-pointer-width" is <code>64</code></em></p>
<p>Firstly, is this the correct way of adding new architecture to Rust? <br>
Secondly, I want to generate target X specific code, and is this information enough?</p>



<a name="277856231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277856231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277856231">(Apr 05 2022 at 10:28)</a>:</h4>
<blockquote>
<p>Umm sorry, I am afraid that I don't have permissions to share code about my bachelor's thesis until it is approved by the University.</p>
</blockquote>
<p>No problem.</p>
<blockquote>
<p>error: inconsistent target specification: "data-layout" claims pointers are 32-bit, while "target-pointer-width" is 64</p>
</blockquote>
<p>Is the data-layout you used something you can share?</p>
<blockquote>
<p>Firstly, is this the correct way of adding new architecture to Rust? </p>
</blockquote>
<p>There are two ways to define a new target spec. In compiler/rustc_target/src/spec in the rust source code and using a json file passed in through <code>--target</code>. As you need a custom LLVM toolchain anyway modifying compiler/rustc_target/src/spec makes sense.</p>



<a name="277857148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277857148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277857148">(Apr 05 2022 at 10:38)</a>:</h4>
<p>e-m:e-i64:32-p:32:32-f64:32-n32-a:0:32-S64, this is the data layout.</p>
<p>I read some text about data layout from here <a href="https://llvm.org/doxygen/ARMTargetMachine_8cpp_source.html#l00139">https://llvm.org/doxygen/ARMTargetMachine_8cpp_source.html#l00139</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>
</code></pre></div>



<a name="277857172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277857172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277857172">(Apr 05 2022 at 10:38)</a>:</h4>
<p>x86_64-unknown-linux-gnu has <code>e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128</code> as data layout which roughly parses as</p>
<ul>
<li><code>e</code>: little endian</li>
<li><code>m:e</code>: ELF symbol mangling</li>
<li><code>p270:32:32</code>: pointers in the "270" address space (ptr32_sptr according to <a href="https://github.com/llvm/llvm-project/blob/dc152659b4527cc2e5f75cc33f36df67c7d5db26/clang/lib/Basic/Targets/X86.h#L43-L45">https://github.com/llvm/llvm-project/blob/dc152659b4527cc2e5f75cc33f36df67c7d5db26/clang/lib/Basic/Targets/X86.h#L43-L45</a>) are 32bit and with a 32bit alignment</li>
<li><code>p271:32:32</code>: pointers in the "271" address space (ptr32_uptr)are 32bit and with a 32bit alignment</li>
<li><code>p272:64:64</code>: pointers in the "272" address space (ptr64) are 64bit and with a 64bit alignment</li>
<li><code>i64:64</code>: 64bit ints are 64bit aligned</li>
<li><code>f80:128</code>: 80bit floats are 128bit aligned</li>
<li><code>n8:16:32:64</code>: native integer widths are 8bit, 16bit, 32bit, 64bit. According to the LLVM docs "Elements of this set are considered to support most general arithmetic operations efficiently."</li>
<li><code>S128</code>: natural stack alignment is 128bit</li>
</ul>



<a name="277857256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277857256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277857256">(Apr 05 2022 at 10:39)</a>:</h4>
<p>Right, you need to set <code>target_pointer_width</code> in the target spec to 32.</p>



<a name="277857378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277857378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277857378">(Apr 05 2022 at 10:40)</a>:</h4>
<p>I already passed 32 as pointer width, but still faces the error shared above.</p>



<a name="277862013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277862013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277862013">(Apr 05 2022 at 11:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="482770">Rithik Sharma</span> <a href="#narrow/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets/near/277853839">said</a>:</p>
<blockquote>
<p>Umm sorry, I am afraid that I don't have permissions to share code about my bachelor's thesis until it is approved by the University.</p>
</blockquote>
<p>You should check with your thesis advisor about the school policy here, if you haven't already. There's a lot of people here who can probably help you at lot, but it will help <em>us</em> a lot if you can be more open about what you are doing, the same way we are open about what we are doing.</p>
<p>Even if the school policy does indeed bar you from sharing the code underlying your work, I'm sure your advisor would have advice for you on how to reduce the problems you are facing in the near term into smaller bits of code you <em>could</em> share with us that would help us understand what you are doing.</p>



<a name="277862467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277862467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277862467">(Apr 05 2022 at 11:30)</a>:</h4>
<p>(to be clear: you have no <em>obligation</em> to share it. I'm just saying I don't want you to have artificial barriers to getting external help, especially when it comes to academic work on an open source project.)</p>



<a name="277867325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/how%20to%20do%20alternative%20LLVM%20targets/near/277867325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rithik Sharma <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets.html#277867325">(Apr 05 2022 at 12:10)</a>:</h4>
<p>I completely agree with you that the community would be beneficial in solving these challenges. I will have a conversation with the advisor about this. My advisor has an excellent compiler background but is very new to Rust and wanted me to explore this part and support our target on the Rust frontend.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>