<html>
<head><meta charset="utf-8"><title>Building/testing rust itself for the first time · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html">Building/testing rust itself for the first time</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266144043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266144043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nazar Mokrynskyi <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266144043">(Dec 27 2021 at 03:56)</a>:</h4>
<p>I decided to try and contribute some minor fixes for the first time and have a few issues/questions.</p>
<p>First of all, this happened during initial setup:</p>
<div class="codehilite"><pre><span></span><code>Welcome to the Rust project! What do you want to do with x.py?
a) library: Contribute to the standard library
b) compiler: Contribute to the compiler itself
c) codegen: Contribute to the compiler, and also modify LLVM or codegen
d) tools: Contribute to tools which depend on the compiler, but do not modify it directly (e.g. rustdoc, clippy, miri)
e) user: Install Rust from source
Please choose one (a/b/c/d/e): b
`x.py` will now use the configuration at .../rust/src/bootstrap/defaults/config.compiler.toml

`rustup` failed to link stage 1 build to `stage1` toolchain
To manually link stage 1 build to `stage1` toolchain, run:

            `rustup toolchain link stage1 build/x86_64-unknown-linux-gnu/stage1`
</code></pre></div>
<p>Not sure what happened and why, but it is not clear whether this is an issue and what to do, I tried to run that command in <code>rust</code> directory before moving forward, but it failed on me. It is a bit unexpected to see such errors during the initial setup.</p>
<p>Then I tried to test things with <code>python3 x.py</code> test to see if everything works before making changes and it failed like this:</p>
<div class="codehilite"><pre><span></span><code>Building stage0 tool error_index_generator (x86_64-unknown-linux-gnu)
   Compiling same-file v1.0.6
   Compiling walkdir v2.3.1
   Compiling error_index_generator v0.0.0 (.../rust/src/tools/error_index_generator)
    Finished release [optimized] target(s) in 1.59s
.../rust/build/x86_64-unknown-linux-gnu/stage0-tools-bin/error_index_generator: error while loading shared libraries: libLLVM-13-rust-1.59.0-nightly.so: cannot open shared object file: No such file or directory


command did not execute successfully: &quot;.../rust/build/x86_64-unknown-linux-gnu/stage0-tools-bin/error_index_generator&quot; &quot;html&quot; &quot;.../rust/build/x86_64-unknown-linux-gnu/doc/error-index.html&quot; &quot;1.59.0&quot;
expected success, got: exit status: 127


Build completed unsuccessfully in 0:14:09
</code></pre></div>
<p>No idea what this is either, there is <a href="https://github.com/rust-lang/rust/issues/80096">https://github.com/rust-lang/rust/issues/80096</a> that is opened for a year, but no workaround mentioned there <span aria-label="disappointed" class="emoji emoji-1f61e" role="img" title="disappointed">:disappointed:</span> </p>
<p>At this point I tried <code>rustup toolchain link stage1 build/x86_64-unknown-linux-gnu/stage1</code> again and it worked for some reason, but tests still fail the same way.</p>



<a name="266172526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266172526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266172526">(Dec 27 2021 at 13:27)</a>:</h4>
<blockquote>
<p>Not sure what happened and why, but it is not clear whether this is an issue and what to do, I tried to run that command in rust directory before moving forward, but it failed on me. It is a bit unexpected to see such errors during the initial setup.</p>
</blockquote>
<p>can you post the error you got? I know rustup expects a directory to already exist there but I thought we'd hacked around it when adding this feature :( the reason it succeeded the next time is probably that x.py actually built the toolchain instead of using empty directories.</p>
<blockquote>
<p>Then I tried to test things with python3 x.py test to see if everything works before making changes and it failed like this:</p>
</blockquote>
<p>hmm, my advice to you personally is to use <code>x.py test --exclude src/tools/linkchecker</code>, because it's not prone to breaking in CI but it requires you to have <code>--stage 2</code> to pass locally. I don't have ideas for how to avoid this in the future other than just removing the dependency on rustdoc altogether (which shouldn't be <em>that</em> hard, I just haven't had time).</p>



<a name="266172826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266172826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266172826">(Dec 27 2021 at 13:32)</a>:</h4>
<p>opened an issue for the <code>x.py setup</code> failure: <a href="https://github.com/rust-lang/rust/issues/92319">https://github.com/rust-lang/rust/issues/92319</a></p>



<a name="266232582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266232582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nazar Mokrynskyi <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266232582">(Dec 28 2021 at 05:28)</a>:</h4>
<p>The error was missing directory indeed:</p>
<blockquote>
<p>error: not a directory: 'build/x86_64-unknown-linux-gnu/stage1/lib'</p>
</blockquote>
<p>I'm <code>nazar-pc</code> on GitHub</p>



<a name="266233578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266233578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nazar Mokrynskyi <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266233578">(Dec 28 2021 at 05:54)</a>:</h4>
<p>With <code>x.py test --exclude src/tools/error_index_generator --exclude src/tools/linkchecker</code> the rest of the tests have passed, thanks!</p>



<a name="266243793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266243793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lev Khoroshansky <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266243793">(Dec 28 2021 at 09:16)</a>:</h4>
<p>Hello everyone!</p>
<p>I was trying to setup compiler build and got almost exactly <a href="#narrow/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time/near/266172526">the same error as Joshua Nelson above</a>:</p>
<div class="codehilite"><pre><span></span><code>`rustup` failed to link stage 1 build to `stage1` toolchain
To manually link stage 1 build to `stage1` toolchain, run:

            `rustup toolchain link stage1 build/x86_64-apple-darwin/stage1`
</code></pre></div>
<p>However, running suggested command failed:</p>
<div class="codehilite"><pre><span></span><code>λ rustup toolchain link stage1 build/x86_64-apple-darwin/stage1
error: not a directory: &#39;build/x86_64-apple-darwin/stage1/lib&#39;
</code></pre></div>
<p>OS: Mac OS 11.4<br>
Python: 3.10.0</p>
<p>Full logs:<br>
<a href="https://gist.github.com/TmLev/5577611af124299f2c61b6dc2ac2eca8#file-x-logs-L205">https://gist.github.com/TmLev/5577611af124299f2c61b6dc2ac2eca8#file-x-logs-L205</a></p>
<p>I've just finished waiting for <code>./x.py check</code> and everything seems fine.</p>



<a name="266263399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266263399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266263399">(Dec 28 2021 at 14:25)</a>:</h4>
<p>ah, I think <a href="https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/src/bootstrap/setup.rs#L112">https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/src/bootstrap/setup.rs#L112</a> is missing <code>lib/</code> at the end</p>



<a name="266263421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266263421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266263421">(Dec 28 2021 at 14:25)</a>:</h4>
<p>also that code probably needs to be using whatever the rust equivalent of <code>mkdir -p</code> is: <a href="https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/src/bootstrap/setup.rs#L163">https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/src/bootstrap/setup.rs#L163</a></p>



<a name="266276139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266276139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266276139">(Dec 28 2021 at 17:20)</a>:</h4>
<p>Given that <code>mkdir -p</code> creates a directory with <code>rwx</code> permissions for users, groups, and others; should we worry about these permissions at all?</p>
<p>Also wouldn't adding <code>lib/</code> at the end only link the stage1 compiler's library and not the whole stage1 build? Sorry if these questions are confusing/don't make sense.</p>



<a name="266276377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266276377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266276377">(Dec 28 2021 at 17:24)</a>:</h4>
<blockquote>
<p>Given that mkdir -p creates a directory with rwx permissions for users, groups, and others; should we worry about these permissions at all?</p>
</blockquote>
<p>This should depend on the umask like any file/directory creation. For me it creates it with rwx permission for users and r-x for groups and others.</p>



<a name="266276436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266276436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266276436">(Dec 28 2021 at 17:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time/near/266263399">said</a>:</p>
<blockquote>
<p>ah, I think <a href="https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/src/bootstrap/setup.rs#L112">https://github.com/rust-lang/rust/blob/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4/src/bootstrap/setup.rs#L112</a> is missing <code>lib/</code> at the end</p>
</blockquote>
<p>The <code>stage1</code> directory itself is the full sysroot, right? <code>bin</code> and <code>lib</code> are subdirectories of the sysroot.</p>



<a name="266277506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266277506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266277506">(Dec 28 2021 at 17:42)</a>:</h4>
<p>Sorry, the terms I am using aren't very clear; yes, <code>stage1</code> is the full sysroot.</p>
<p>AFAIK the problem is that the <code>lib</code> subdirectory doesn't exist when running <code>x.py setup library</code> so we just need to create that directory first.</p>



<a name="266306703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266306703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266306703">(Dec 29 2021 at 01:14)</a>:</h4>
<p>So this error still occurs <em>even if</em> both the <code>lib</code> and <code>bin</code> subfolders are created beforehand.</p>



<a name="266432886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/266432886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#266432886">(Dec 30 2021 at 14:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="402099">Timothy Maloney</span> <a href="#narrow/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time/near/266306703">said</a>:</p>
<blockquote>
<p>So this error still occurs <em>even if</em> both the <code>lib</code> and <code>bin</code> subfolders are created beforehand.</p>
</blockquote>
<p>that can't be true; at least the error should say something different. <span class="user-mention" data-user-id="402099">@Timothy Maloney</span> can you post the error you're now seeing?</p>



<a name="267300732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/267300732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#267300732">(Jan 08 2022 at 15:20)</a>:</h4>
<p><a href="/user_uploads/4715/yKqaRC-dVrEHMtp0yBLeWv0H/Screen-Shot-2022-01-08-at-7.16.34-AM.png">Screen-Shot-2022-01-08-at-7.16.34-AM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/yKqaRC-dVrEHMtp0yBLeWv0H/Screen-Shot-2022-01-08-at-7.16.34-AM.png" title="Screen-Shot-2022-01-08-at-7.16.34-AM.png"><img src="/user_uploads/4715/yKqaRC-dVrEHMtp0yBLeWv0H/Screen-Shot-2022-01-08-at-7.16.34-AM.png"></a></div>



<a name="269952431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/Building/testing%20rust%20itself%20for%20the%20first%20time/near/269952431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yerkebulan Tulibergenov <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/Building.2Ftesting.20rust.20itself.20for.20the.20first.20time.html#269952431">(Jan 30 2022 at 19:52)</a>:</h4>
<p>I create PR to fix this if someone wants to take a look: <a href="https://github.com/rust-lang/rust/pull/93487">https://github.com/rust-lang/rust/pull/93487</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>