<html>
<head><meta charset="utf-8"><title>x.py test fails due to rustfmt crash · new members · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html">x.py test fails due to rustfmt crash</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278157132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/x.py%20test%20fails%20due%20to%20rustfmt%20crash/near/278157132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Hahn <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html#278157132">(Apr 07 2022 at 12:37)</a>:</h4>
<p>Hi, I'm trying to build rustc on an M1 Macbook Pro. when running <code>./x.py test</code>, I get an abort during "fmt check" like so:</p>
<p>$ ./x.py test<br>
Updating only changed submodules<br>
  Submodules updated in 0.01 seconds<br>
Building rustbuild<br>
    Finished dev [unoptimized] target(s) in 0.10s<br>
Building stage0 tool tidy (x86_64-apple-darwin)<br>
    Finished release [optimized] target(s) in 0.11s<br>
tidy check<br>
Checking which error codes lack tests...</p>
<ul>
<li>629 error codes</li>
<li>
<p>highest error code: E0787<br>
Found 504 error codes<br>
Found 0 error(s) in error codes<br>
Done!</p>
</li>
<li>
<p>372 features<br>
fmt check<br>
rustfmt(7389,0x20133a600) malloc: *** error for object 0x6000036d4600: pointer being freed was not allocated<br>
rustfmt(7389,0x20133a600) malloc: *** set a breakpoint in malloc_error_break to debug<br>
Running <code>"/Users/code/git/rust/build/x86_64-apple-darwin/stage0/bin/rustfmt" "--config-path" "/Users/code/git/rust" "--edition" "2021" "--unstable-features" "--skip-children" "--check" "/Users/code/git/rust/library/std/src/collections/hash/set.rs" "/Users/code/git/rust/library/std/src/collections/hash/set/tests.rs" "/Users/code/git/rust/library/std/src/collections/hash/map/tests.rs" "/Users/code/git/rust/library/std/src/sync/condvar.rs" "/Users/code/git/rust/library/std/src/sync/poison.rs" "/Users/code/git/rust/library/std/src/sync/barrier/tests.rs" "/Users/code/git/rust/library/std/src/sync/mutex/tests.rs" "/Users/code/git/rust/library/std/src/prelude/v1.rs"</code> failed.</p>
</li>
</ul>
<p>Any pointers on how to resolve this would be appreciated</p>



<a name="278161086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/x.py%20test%20fails%20due%20to%20rustfmt%20crash/near/278161086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html#278161086">(Apr 07 2022 at 13:07)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/issues/92173">https://github.com/rust-lang/rust/issues/92173</a></p>



<a name="278177670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/x.py%20test%20fails%20due%20to%20rustfmt%20crash/near/278177670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Hahn <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html#278177670">(Apr 07 2022 at 15:04)</a>:</h4>
<p>Thank you for the suggestion, I guess I didn't see it because for me it was rustfmt which isn't yet mentioned in that issue. Unfortunately no workaround yet I guess, but thanks a lot!</p>



<a name="278391433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/x.py%20test%20fails%20due%20to%20rustfmt%20crash/near/278391433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Hahn <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html#278391433">(Apr 09 2022 at 06:28)</a>:</h4>
<p>The way I have pieced this together for me is that it is the pre-built stage0 rustfmt that crashes, so I cannot really work around it locally by changing any options for the rust compilation. I was able to work around the issue by exporting MallocStackLogging=1 before the ./x.py test, but this of course makes everything a bit slower and creates lots of debug output. I guess the question becomes, when would a new stage0 be created and would it have a fix for this issue.</p>



<a name="278413677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/x.py%20test%20fails%20due%20to%20rustfmt%20crash/near/278413677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html#278413677">(Apr 09 2022 at 14:50)</a>:</h4>
<p>stage0 was bumped a few days ago, can you check that you are on the latest master?</p>
<p>I also have a few questions:</p>
<ul>
<li>It looks like you are running x86_64 binaries. Is there a reason for that?  I would expect the build host to be <code>aarch64</code>.  Do you maybe have <code>x86_64</code> rustc or rustup installed, or have it overridden in config.toml?</li>
<li>Which version of macOS are you using?</li>
<li>Which version of xcode do you have installed?</li>
</ul>



<a name="278428090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122652-new%20members/topic/x.py%20test%20fails%20due%20to%20rustfmt%20crash/near/278428090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Hahn <a href="https://zulip-archive.rust-lang.org/stream/122652-new-members/topic/x.2Epy.20test.20fails.20due.20to.20rustfmt.20crash.html#278428090">(Apr 09 2022 at 20:07)</a>:</h4>
<p>Latest master works (even with x86_64), awesome! Thank you so much. I also changed my rustup default host triple to <code>aarch64-apple-darwin</code> and magically I am now building using that for my build as well.<br>
As to your questions:</p>
<ul>
<li>I am not running x86_64 on purpose. I migrated the machine from an older Mac, I assume my rustup continued using x86_64. I figured this was the only thing available and therefore didn't look further.</li>
<li>Version 12.3.1</li>
<li>13.3</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>