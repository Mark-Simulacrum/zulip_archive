<html>
<head><meta charset="utf-8"><title>#93678 unused_unsafe changes · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html">#93678 unused_unsafe changes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272328041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272328041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272328041">(Feb 17 2022 at 21:43)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/93678">https://github.com/rust-lang/rust/pull/93678</a> changes the behaviour of the lint to suggest removing the outer-most <code>unsafe {}</code> block over the inner ones. There seems to be some motivation to do so that relates to implementation approach, but also in some way there's also some preference in play.</p>
<p>My memory was that style guides generally suggested larger <code>unsafe {}</code> blocks that included the invariant checks, which would suggest that we ought to suggest removing inner <code>unsafe</code>s instead. However either way this seems like a decision that's out of scope for me as a reviewer to make. Does anybody from T-lang have any input on this?</p>



<a name="272329097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272329097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272329097">(Feb 17 2022 at 21:48)</a>:</h4>
<p>The current trajectory for unsafe nesting / unsafe blocks is roughly split between 'as small as possible' and large ones, in some sense based on <a href="https://github.com/rust-lang/rust/pull/79208">https://github.com/rust-lang/rust/pull/79208</a> -- in general, I don't think <em>either</em> answer is right personally -- though I tend to lean towards smaller-ish blocks.</p>



<a name="272329174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272329174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272329174">(Feb 17 2022 at 21:49)</a>:</h4>
<p>/me tends to lean towards smaller blocks as well, but understands the tradeoff between convenience and precision here.</p>



<a name="272329361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272329361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272329361">(Feb 17 2022 at 21:51)</a>:</h4>
<p>One thing we haven't tried yet -- and maybe is worth exploring -- is diving into some kind of effect-like and/or trivial precondition/postcondition assertions system. I suspect that it might be the way to go if we really want to ergonomically and in a maintainable way evolve unsafe code over time</p>



<a name="272329403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272329403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272329403">(Feb 17 2022 at 21:52)</a>:</h4>
<p>Depending on a whole bunch of things I suspect it's either impossibly verbose or perhaps reasonably ok</p>



<a name="272329458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272329458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272329458">(Feb 17 2022 at 21:52)</a>:</h4>
<p>in any case, it's a vague rumbling of an idea at best :)</p>



<a name="272333580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272333580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272333580">(Feb 17 2022 at 22:27)</a>:</h4>
<p>I would appreciate any ideas on how to reach a conclusion on the PR itself in a well defined process. RFC sounds excessive. Does this warrant a FCP? What team would make a call?</p>



<a name="272333846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272333846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272333846">(Feb 17 2022 at 22:29)</a>:</h4>
<p>So, the exact behavior of a lint isn't a stable guarantee, which means this is a reversible decision. And the nature of it shouldn't create "flapping" behavior where we lint against something that we previously linted <em>towards</em>.</p>



<a name="272333908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272333908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272333908">(Feb 17 2022 at 22:30)</a>:</h4>
<p>Which means I think the process we'd want is "some folks are favorable and nobody objects".</p>



<a name="272333996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272333996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272333996">(Feb 17 2022 at 22:31)</a>:</h4>
<p>Lints are usually T-lang. I'm not entirely confident this is entirely a T-lang matter, but again, it seems reversible in a way that makes it not too much of a problem to just proceed.</p>



<a name="272334013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272334013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272334013">(Feb 17 2022 at 22:31)</a>:</h4>
<p>So I would suggest, informally, that it should suffice if more than one T-lang member thinks this is OK and nobody has a concern.</p>



<a name="272334109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272334109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272334109">(Feb 17 2022 at 22:32)</a>:</h4>
<p>Based on the summary you gave above, <span class="user-mention" data-user-id="123586">@nagisa</span>, on the question of removing outer rather than inner, I'm in favor. (I'm basing this on your summary, not the implementation details of this specific change.)</p>



<a name="272334184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272334184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272334184">(Feb 17 2022 at 22:33)</a>:</h4>
<p>I believe my summary to be broadly accurate. There are more extensive summaries on the PR itself written by the author, which I consider to be accurate as well.</p>



<a name="272335018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272335018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272335018">(Feb 17 2022 at 22:41)</a>:</h4>
<p>I am in favor of removing the outer block. I believe that the right place to put an unsafe is exactly where you can clearly document the conditions that are being asserted.</p>



<a name="272335067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272335067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272335067">(Feb 17 2022 at 22:42)</a>:</h4>
<p>Narrower blocks tend to allow you to be more specific about what is being asserted at each spot.</p>



<a name="272335088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272335088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272335088">(Feb 17 2022 at 22:42)</a>:</h4>
<p>Broader blocks seem to be more like "this code in here is reasonable" and don't encourage the same precision.</p>



<a name="272335098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272335098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272335098">(Feb 17 2022 at 22:42)</a>:</h4>
<p>(That, at least, is my experience.)</p>



<a name="272336025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272336025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272336025">(Feb 17 2022 at 22:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272328041">said</a>:</p>
<blockquote>
<p>There seems to be some motivation to do so that relates to implementation approach, <em>[...]</em></p>
</blockquote>
<p>For anyone who didn't look into the PR: The change in behavior simplifies solving the problem that cases like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">_foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">futures</span>::<span class="n">pin_mut</span><span class="o">!</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>currently don't produce any warning at all. (The macro expands to code containing an <code>unsafe</code> block; the compiler wants to warn that the inner (macro-generated) unsafe block is redundant, however <code>unused_unsafe</code> lint doesn't show up for code from external macros.)</p>
<p>Also note that if an outer <code>unsafe</code> block does also directly contain at least one unsafe operations, of course the lint will still warn the inner block as being redundant.</p>



<a name="272337879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272337879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272337879">(Feb 17 2022 at 23:12)</a>:</h4>
<p>I agree that suggesting the removal of the outer one is reasonable.  The code's author can always make the decision to remove the inner one if they'd rather.</p>



<a name="272382378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272382378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272382378">(Feb 18 2022 at 10:07)</a>:</h4>
<p>Given that there is still a lot of discussion ongoing on the topic, maybe there just shouldn't be a suggestion here?</p>



<a name="272382532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272382532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272382532">(Feb 18 2022 at 10:08)</a>:</h4>
<p>I feel that even if removing the outer unsafe is the right thing to do, then just doing so mechanically is sill going to be wrong - the programmer should probably replace it with a comment detailing the scope of invariants and how they are re-established, etc.</p>



<a name="272383341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272383341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272383341">(Feb 18 2022 at 10:17)</a>:</h4>
<p>I don't know where the line is, or really what separates a suggestion from a hint.  Maybe we make the suggestion but don't mark it <code>MachineApplicable</code>, or something.  I'm probably happy with whatever the diagnostics experts think is most consistent.</p>



<a name="272383671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272383671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272383671">(Feb 18 2022 at 10:20)</a>:</h4>
<p>I think a lint can tell the user what is wrong without any suggestion for how to fix it, and that seems appropriate in this case</p>



<a name="272389896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272389896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272389896">(Feb 18 2022 at 11:25)</a>:</h4>
<p>My two cents about the outer <em>vs.</em> inner question:</p>
<ul>
<li>
<p>From a practical/factual point of view, smaller <code>unsafe</code> blocks are better since less dangerous: less likely that an unrelated unknowingly <code>unsafe</code> function would be called as well. For reference, this point of view has been the main rationale for <code>unsafe_op_in_unsafe_fn</code>: in that case, the fact the caller had to uphold preconditions / narrow contract was kind of a blanket license to, ourselves (the callee), not care about our own <code>unsafe</code> calls.</p>
</li>
<li>
<p>From a conceptual point of view, an <code>unsafe</code> that is too narrow can just be used to pin-point what the dangerous operation is, but will be lacking the necessary context that justifies the soundness of it all.</p>
</li>
</ul>
<p>Regarding the latter point, however, even outer <code>unsafe</code> is insufficient: the safety boundaries are often at the privacy/module level, and you can't put such a gigantic <code>unsafe</code> block in there (<code>mod unsafe {</code>?), and, incidentally, even if that were possible, I think we can agree it would be an undesirable feature, thus serving as a strawman to reinforce the former point: the value of an <code>unsafe</code> block is inversely proportional to its size.</p>
<h3>My rule of thumb solution</h3>
<ol>
<li>
<p>Start with a <code>#![deny(unsafe_code)]</code> codebase;</p>
</li>
<li>
<p>Use <code>#[allow(unsafe_code)]</code> at a safety boundary: to the whole enscoping module acting as a privacy boundary (<em>e.g.</em>, <code>vec</code>), or inside a function body, when applicable, like this:</p>
</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unsafe_code)]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (Aside: I wish rustfmt allowed this style)</span>
<span class="w">    </span><span class="err">…</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ol start="3">
<li>So that maximally finer-grained <code>unsafe</code> scopes (or even, the theorized unary <code>unsafe</code> op modifiers) can be used.</li>
</ol>
<p>The "held invariants" would be listed at the <code>allow(unsafe_code)</code> level, and then the <code>// safety</code> of each <code>unsafe</code>, if non-trivial could actually refer to the invariants.</p>



<a name="272394441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272394441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272394441">(Feb 18 2022 at 12:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272382378">said</a>:</p>
<blockquote>
<p>Given that there is still a lot of discussion ongoing on the topic, maybe there just shouldn't be a suggestion here?</p>
</blockquote>
<p>Note that <strong><em>technically</em></strong> we aren’t even discussing any actual suggestions here. Rather the question is which <code>unsafe</code> blocks are reported as unnecessary and which aren’t. The basic principle I’m trying to follow in the PR is that the lint should always be of the form that</p>
<ul>
<li>removing all reported-unnecessary <code>unsafe</code> blocks <strong><em>at once</em></strong> results in working code without any new/remaining <code>unused_unsafe</code> warnings (“removing” means “turning into an ordinary block”)</li>
<li>the resulting <code>unused_unsafe</code>-warning-free code doesn’t contain any additional <code>unsafe</code> blocks that <em>can</em> be removed without the code failing to compile (except for unsafe blocks that appeared in a place where <code>allow(unused_unsafe)</code> was active).</li>
</ul>
<p>this leaves multiple possibilities in certain scenarios, the one being discussed here is something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsf</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsf</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsf</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">unsf</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>On nightly, this produces</p>
<div class="codehilite"><pre><span></span><code>warning: unnecessary `unsafe` block
 --&gt; src/lib.rs:3:9
  |
2 |     unsafe {
  |     ------ because it&#39;s nested under this `unsafe` block
3 |         unsafe { unsf() }
  |         ^^^^^^ unnecessary `unsafe` block
  |
  = note: `#[warn(unused_unsafe)]` on by default

warning: unnecessary `unsafe` block
 --&gt; src/lib.rs:4:9
  |
2 |     unsafe {
  |     ------ because it&#39;s nested under this `unsafe` block
3 |         unsafe { unsf() }
4 |         unsafe { unsf() }
  |         ^^^^^^ unnecessary `unsafe` block

warning: unnecessary `unsafe` block
 --&gt; src/lib.rs:5:9
  |
2 |     unsafe {
  |     ------ because it&#39;s nested under this `unsafe` block
...
5 |         unsafe { unsf() }
  |         ^^^^^^ unnecessary `unsafe` block
</code></pre></div>
<p>whereas with <a href="https://github.com/rust-lang/rust/issues/93678">#93678</a>, this would instead produce</p>
<div class="codehilite"><pre><span></span><code>warning: unnecessary `unsafe` block
 --&gt; src/lib.rs:2:5
  |
2 |     unsafe {
  |     ^^^^^^ unnecessary `unsafe` block
  |
  = note: `#[warn(unused_unsafe)]` on by default
</code></pre></div>



<a name="272408748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272408748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272408748">(Feb 18 2022 at 14:35)</a>:</h4>
<p>I also like unsafe blocks to be small and targeted. Obviously there's lots of room for reasonable interpretation and nuance based on context, but at the end of the day any time you touch any code in a <strong>module</strong> that contains an <code>unsafe</code> you have to be wary. In that sense I agree with <span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> : have a crate level #<code>![deny(unsafe_code)]</code> and selectively allow it at the module-level when needed. The granularity of unsafe blocks should be whichever makes it easiest for authors to document the invariants and for readers to pinpoint which operations are unsafe.</p>



<a name="272434272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272434272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272434272">(Feb 18 2022 at 17:54)</a>:</h4>
<p>One case where there's a need for a big unsafe block is if there's data behind a raw pointer you can't make a reference. Then it's just unsafe practically every line of the function, and having one little unsafe block per field access is just nothing but line noise.</p>
<p>However, rust lacks the ability to specify the right kinds of data types here for this and so it must be kept in raw pointer form. This is one area that ergonomics could be improved greatly.</p>



<a name="272447698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272447698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272447698">(Feb 18 2022 at 19:42)</a>:</h4>
<p>Or several lines of unsafe pointer arithmetic + final access to the pointer. They are best annotated with SAFETY comment as a block.</p>



<a name="272447719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272447719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272447719">(Feb 18 2022 at 19:42)</a>:</h4>
<p>I.e. the smallest unit of unsafe is not always a single call</p>



<a name="272448851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272448851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272448851">(Feb 18 2022 at 19:53)</a>:</h4>
<p>Heh, I find unchecked arithmetic to be, on the contrary, a good argument for smaller <code>unsafe</code> scopes, since it's easy to miss that some of the calls may carry extra invariants, <em>e.g.</em>, <code>pointer::offset_from</code> (not all <code>unsafe fn</code> have <code>unchecked</code> in their name, and even if they did, then <code>_unchecked</code> would just end up being <code>unsafe</code> in disguise). In other words, if the caller intends to perform unchecked pointer arithmetic on purpose, they better express so with <em>dedicated</em> <code>unsafe</code> blocks for them.</p>
<p>The global SAFETY section could still be written atop it all, on the <code>#[allow(unsafe_code)] { … }</code> broader scope.</p>



<a name="272450043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272450043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272450043">(Feb 18 2022 at 20:00)</a>:</h4>
<p>Then make pointer access a unique kind of unsafe or something ;P</p>



<a name="272451124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272451124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272451124">(Feb 18 2022 at 20:07)</a>:</h4>
<p>Something I'm unclear on from reading as a bystander: we aren't advocating for removing non-<code>unsafe</code>-requiring functions from an <code>unsafe</code> block, are we?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[warn(unsafe_op_in_unsafe_fn)]</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;*</span><span class="n">ptr</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I am a fan of both putting as many preconditions as I can into the <code>unsafe</code> block <strong>and</strong> having narrowly-scoped <code>unsafe</code> blocks.</p>



<a name="272451778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272451778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272451778">(Feb 18 2022 at 20:14)</a>:</h4>
<p>I would indeed write that with just the unsafe-requiring part inside the block, and the <code>is_null</code> outside the block.</p>



<a name="272451842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272451842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272451842">(Feb 18 2022 at 20:15)</a>:</h4>
<p>I don't feel a conceptual attachment to having the verification of preconditions happen inside the unsafe block, as though the unsafe block was some mutex being held where those preconditions could change if not checked inside.</p>



<a name="272451968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272451968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272451968">(Feb 18 2022 at 20:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272451842">said</a>:</p>
<blockquote>
<p>as though the unsafe block was some mutex being held where those preconditions could change if not checked inside.</p>
</blockquote>
<p>Especially so when we don't have unsafe fields and such yet, and thus there's always plenty of important code outside that "mutex".</p>



<a name="272452102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452102">(Feb 18 2022 at 20:18)</a>:</h4>
<p>Though, on that note, I do want unsafe fields. The more I think about that, the more I think it would be a great idea.</p>



<a name="272452356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452356">(Feb 18 2022 at 20:20)</a>:</h4>
<p>Yeah, given that we even have gotten academic papers that talk about "unneeded" <code>unsafe fn</code> because they don't do anything unsafe in the body.</p>



<a name="272452588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452588">(Feb 18 2022 at 20:22)</a>:</h4>
<p>Another case I see often:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">safe_function</span><span class="p">(</span><span class="n">unsafe_argument</span><span class="p">,</span><span class="w"> </span><span class="n">safe_argument</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which I would rewrite as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">safe_function</span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsafe_argument</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">safe_argument</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="272452665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452665">(Feb 18 2022 at 20:23)</a>:</h4>
<p>In part because I find it comforting to know that I can't accidentally do anything unsafe in <code>safe_argument</code> or <code>safe_function</code>.</p>



<a name="272452729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452729">(Feb 18 2022 at 20:23)</a>:</h4>
<p>I'd love to have an allow-by-default lint for "safe operation in unsafe block"; bonus if it could actually rustfix from the former of those to the latter.</p>



<a name="272452784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452784">(Feb 18 2022 at 20:24)</a>:</h4>
<p>I agree with that example (it fits into my "narrowly-scoped <code>unsafe</code> blocks") , but point out that it makes it hard to cleanly follow the usual suggestion of documenting your unsafe blocks.</p>



<a name="272452819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452819">(Feb 18 2022 at 20:24)</a>:</h4>
<p>FWIW, this is why I personally want to at least experiment with some kind of effects system -- it's often the case that I can't feasibly get the unsafe block 'small enough', or that e.g. it's around a function, and then tracking that function's requirements over time is ~impossible in practice. (Obviously, for a pub function, you can't evolve, but internal refactors are common IME).</p>



<a name="272452849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452849">(Feb 18 2022 at 20:24)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">safe_function</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="c1">// SAFETY: ...</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsafe_argument</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">safe_argument</span><span class="p">,</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="272452925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452925">(Feb 18 2022 at 20:25)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I agree, there are cases where you <em>can't</em> narrow unsafe far enough, in part because we don't have a way of separating an unsafe operation from a safe one syntactically.</p>



<a name="272452946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272452946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272452946">(Feb 18 2022 at 20:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272452729">said</a>:</p>
<blockquote>
<p>I'd love to have an allow-by-default lint for "safe operation in unsafe block"</p>
</blockquote>
<p>So the moral opposite of <code>unsafe_op_in_unsafe_fn</code>?</p>



<a name="272453043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453043">(Feb 18 2022 at 20:26)</a>:</h4>
<p>Then we should have a lint for <code>safe_op_in_safe_fn</code> <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="272453059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453059">(Feb 18 2022 at 20:26)</a>:</h4>
<p>Kinda, yeah. "unsafe is not at the most precise position it could be in the AST".</p>



<a name="272453136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453136">(Feb 18 2022 at 20:27)</a>:</h4>
<p>I feel like that lint would have some annoying edge cases, but would have to see it in practice.</p>



<a name="272453190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453190">(Feb 18 2022 at 20:27)</a>:</h4>
<p>Regarding documentation, I also think this is perfectly fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// SAFETY: ...</span>
<span class="n">safe_function</span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsafe_arg</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">safe_arg</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>As long as you only have the one unsafe in the statement.</p>



<a name="272453276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453276">(Feb 18 2022 at 20:28)</a>:</h4>
<p>And if you have more than one unsafe in the statement, I <em>do</em> think the style of writing it multi-line and putting the comment directly on the argument seems right.</p>



<a name="272453288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453288">(Feb 18 2022 at 20:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272452819">said</a>:</p>
<blockquote>
<p>experiment with some kind of effects system</p>
</blockquote>
<p>I wonder if we could tally up all the times people have said "if we had effects, this would be easier/better/more accurate, but lets do <em>X</em> instead " and which places in the language would be improved by them <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="272453297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453297">(Feb 18 2022 at 20:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272453059">said</a>:</p>
<blockquote>
<p>Kinda, yeah. "unsafe is not at the most precise position it could be in the AST".</p>
</blockquote>
<p>That feels painful.  I think that's more a request for "I want to be able to <code>foo().trusted#unwrap_unchecked()</code>" or something, and just disallow the block form.</p>



<a name="272453381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453381">(Feb 18 2022 at 20:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272453190">said</a>:</p>
<blockquote>
<p>Regarding documentation, I also think this is perfectly fine:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// SAFETY: ...</span>
<span class="n">safe_function</span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unsafe_arg</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">safe_arg</span><span class="p">);</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>I wonder how well <a href="https://rust-lang.github.io/rust-clippy/master/index.html#undocumented_unsafe_blocks">https://rust-lang.github.io/rust-clippy/master/index.html#undocumented_unsafe_blocks</a> handles that.</p>



<a name="272453649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453649">(Feb 18 2022 at 20:31)</a>:</h4>
<blockquote>
<p>"unsafe is not at the most precise position it could be in the AST"</p>
</blockquote>
<p>Regarding maximally precise <code>unsafe</code>, IMO new syntax is needed, because otherwise it’s hard/impossible to exclude the arguments, as in something like: <code>unsafe { unsafe_function(safe_arg) }</code> but disallowing any additional unsafety in the <code>safe_arg</code> expression. I’ve written up some idea in this thread on IRLO: <a href="https://internals.rust-lang.org/t/unsafe-categories/15334/2">https://internals.rust-lang.org/t/unsafe-categories/15334/2</a></p>



<a name="272453681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453681">(Feb 18 2022 at 20:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272453297">said</a>:</p>
<blockquote>
<p><code>foo().trusted#unwrap_unchecked()</code></p>
</blockquote>
<p>Too bad we already used <code>!</code> for macros — would be appropriately alarming.</p>



<a name="272453777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453777">(Feb 18 2022 at 20:32)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> <code>safething().unsafething()</code> is very much the case I'm thinking of for not being able to syntactically separate the two. That seems like "another level" of the warning, where you wouldn't want to get a warning if you have to pull out a let binding just to shrink the scope of <code>unsafe</code>.</p>



<a name="272453859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453859">(Feb 18 2022 at 20:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> Heh. The use of <code>!</code> for that purpose would remind me of the conventional meaning of <code>!</code> in fanfiction and similar. "aspect!character".</p>



<a name="272453893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453893">(Feb 18 2022 at 20:33)</a>:</h4>
<p>e.g. <code>evil!canonchar</code> or <code>machiavellian!canonchar</code>.</p>



<a name="272453909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272453909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272453909">(Feb 18 2022 at 20:33)</a>:</h4>
<p><code>unsafe!function</code></p>



<a name="272454047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454047">(Feb 18 2022 at 20:34)</a>:</h4>
<p>Overall, I think that "smallest <code>unsafe{}</code> scope" is really an "all I have is a hammer" problem.</p>
<p>The <em>real</em> goal is "did I check all the preconditions", which is only indirectly demonstrated by having small-scoped <code>unsafe{}</code>.  (Or <code>trustme!whatever()</code>.)</p>
<p>Which gets into what <span class="user-mention silent" data-user-id="116155">Jake Goulding</span> was saying.  If we formalized the system of "here are the preconditions" from the <code>## Safety</code> section convention, and added some way to write out which ones you checked (like the <code>// SAFETY</code> comment convention) then having larger <code>trusted{}</code> blocks would be completely fine.</p>



<a name="272454097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454097">(Feb 18 2022 at 20:35)</a>:</h4>
<p>From a perspective of preconditions, yes. But I'm not sure that's my "real goal" when shrinking unsafe blocks.</p>



<a name="272454357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454357">(Feb 18 2022 at 20:38)</a>:</h4>
<p>Well, to me a huge part of the purpose is that if you add another unsafe call inside the existing one, you might forget to check something.  But that's only a problem if the preconditions are different.</p>
<p>Spitball: <code>unsafe(4) { ... there must be exactly 4 unsafe things in here ... }</code>.</p>



<a name="272454387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454387">(Feb 18 2022 at 20:38)</a>:</h4>
<p>The preconditions <em>changing</em> is my largest worry, personally, in practice</p>



<a name="272454419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454419">(Feb 18 2022 at 20:38)</a>:</h4>
<p>(for an internal unsafe fn)</p>



<a name="272454423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454423">(Feb 18 2022 at 20:38)</a>:</h4>
<p>I think I do get the idea of "if you had to demonstrate knowledge of all the preconditions, then you can't accidentally do something unsafe that you didn't mean to".</p>



<a name="272454456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454456">(Feb 18 2022 at 20:39)</a>:</h4>
<p>But at the same time, I feel like "do I have all the preconditions met" is a necessary but not sufficient condition for me to <em>want</em> to call an unsafe function.</p>



<a name="272454458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454458">(Feb 18 2022 at 20:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272454357">said</a>:</p>
<blockquote>
<p>Spitball: <code>unsafe(4) { ... there must be exactly 4 unsafe things in here ... }</code>.</p>
</blockquote>
<p>I think this would be unweildy in the face of <code>#[cfg(...)]</code>ed away code</p>



<a name="272454494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454494">(Feb 18 2022 at 20:39)</a>:</h4>
<p><span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span> That'd be a pretty complex unsafe block, to have cfg <em>inside</em> it, as opposed t pulling the cfg <em>outside</em> and having multiple unsafe blocks.</p>



<a name="272454604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454604">(Feb 18 2022 at 20:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272454387">said</a>:</p>
<blockquote>
<p>The preconditions <em>changing</em> is my largest worry, personally, in practice</p>
</blockquote>
<p>Yeah, since anything about scoping doesn't fix that.</p>
<p>But I could imagine a like <code>unsafe(even(x)) { foo(x) }</code> that would make more specific promises to guard against that.</p>



<a name="272454620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454620">(Feb 18 2022 at 20:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272454456">said</a>:</p>
<blockquote>
<p>But at the same time, I feel like "do I have all the preconditions met" is a necessary but not sufficient condition for me to <em>want</em> to call an unsafe function.</p>
</blockquote>
<p>I think this is good to call out -- but it seems like there is a separate thing at play here: there is the ub-free correctness (code is sound, i.e., preconditions met) and <em>separately</em> correctness/maintenance/etc of 'am I calling the right things' or something like that.</p>



<a name="272454638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454638">(Feb 18 2022 at 20:41)</a>:</h4>
<p>There's also "is there a safe way to do this".</p>



<a name="272454644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454644">(Feb 18 2022 at 20:41)</a>:</h4>
<p>I'm not sure I've dialed in on the second part</p>



<a name="272454688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454688">(Feb 18 2022 at 20:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272454047">said</a>:</p>
<blockquote>
<p>If we formalized the system of "here are the preconditions" from the <code>## Safety</code> section convention, and added some way to write out which ones you checked (like the <code>// SAFETY</code> comment convention)</p>
</blockquote>
<p>Makes me think of something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[warn(unsafe_op_in_unsafe_fn)]</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// [^s1]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// SAFETY:</span>
<span class="w">    </span><span class="c1">// - not null: [^s1]</span>
<span class="w">    </span><span class="c1">// - aligned: because I said so</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">ptr</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272454787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454787">(Feb 18 2022 at 20:42)</a>:</h4>
<p>And even if it's not exactly "changing", it'd be handy to have a way to catch the "I checked the ones I remember but forgot something else more subtle" problem too.  Like <code>slice::from_raw_parts</code> people easily remember the non-nullness, but can easily forget to check the "and at most isize::MAX bytes" part.</p>



<a name="272454822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454822">(Feb 18 2022 at 20:43)</a>:</h4>
<p>For instance, hypothetically, suppose I have <code>safe_func(unsafe { unsafe_arg }, safe_arg)</code>. If I instead wrap the unsafe around the whole thing, I could accidentally call an unsafe function in <code>safe_arg</code> and not have that flagged. Hypothetically, the compiler could somehow know that the unsafe unction I'm calling in what I thought was <code>safe_arg</code> is something for which I have the prerequisites, and thus can actually call, but I still don't <em>want</em> that argument depending on those prerequisites, and I would rather express it in a way that doesn't depend on those prerequisites. (All that assuming it's even <em>possible</em> for the compiler to prove the prerequisites, which, insert skepticism here.)</p>



<a name="272454894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454894">(Feb 18 2022 at 20:43)</a>:</h4>
<p>I'm definitely not looking for compiler-assisted proofs (yet, at least) -- I just can't as a reviewer reliably track the 3-4 preconditions even something as 'simple' as ptr::read has</p>



<a name="272454945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454945">(Feb 18 2022 at 20:44)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="272454995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272454995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272454995">(Feb 18 2022 at 20:44)</a>:</h4>
<p>I think part of my trepidation is that even with compiler assistance, I'm not looking to write programs right up at the boundary of my complexity-limit to be able to write.</p>



<a name="272455009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455009">(Feb 18 2022 at 20:44)</a>:</h4>
<p>just force all unsafe functions to be imported with <code>unsafe use</code>, so you can't call them by accident in an existing unsafe block :)</p>



<a name="272455023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455023">(Feb 18 2022 at 20:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272454822">said</a>:</p>
<blockquote>
<p>(All that assuming it's even <em>possible</em> for the compiler to prove the prerequisites, which, insert skepticism here.)</p>
</blockquote>
<p>I agree on "prove".  I was thinking more "well there were N precondition labels on the <code>unsafe fn</code>  you're calling, so unless you also put those labels, with justification, on the <code>trusted{}</code> block, then you get at least a warning".</p>



<a name="272455044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455044">(Feb 18 2022 at 20:45)</a>:</h4>
<p>I'd like to stay far, far away from that complexity limit, and I appreciate the compiler helping me on that front by rejecting various things that might actually be valid programs. :)</p>



<a name="272455055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455055">(Feb 18 2022 at 20:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272455023">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272454822">said</a>:</p>
<blockquote>
<p>(All that assuming it's even <em>possible</em> for the compiler to prove the prerequisites, which, insert skepticism here.)</p>
</blockquote>
<p>I agree on "prove".  I was thinking more "well there were N precondition labels on the <code>unsafe fn</code>  you're calling, so unless you also put those labels, with justification, on the <code>trusted{}</code> block, then you get at least a warning".</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="272455093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455093">(Feb 18 2022 at 20:45)</a>:</h4>
<p>I'm a big fan of the idea of "please copy the terms-and-conditions for calling this unsafe function so that you have more chance of being aware of them and thinking about them".</p>



<a name="272455095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455095">(Feb 18 2022 at 20:45)</a>:</h4>
<p>Absolutely, I think the reality is that at least IMO even pretty simple unsafe code quickly generates a lot of preconditions that are hard to keep track of manually, especially as you refactor code around -- this is basically the 'why it is hard to write C code' problem :)</p>



<a name="272455160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455160">(Feb 18 2022 at 20:46)</a>:</h4>
<p>and copying doesn't help if I don't have someone saying "yes you copied right" after someone changes that function :)</p>



<a name="272455174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455174">(Feb 18 2022 at 20:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272455023">said</a>:</p>
<blockquote>
<p>well there were N precondition labels on the <code>unsafe fn</code>  you're calling, so unless you also put those labels, with justification, on the <code>trusted{}</code> block, then you get at least a warning</p>
</blockquote>
<p>@bors r+</p>



<a name="272455248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455248">(Feb 18 2022 at 20:47)</a>:</h4>
<p>I think if I had something like <code>unsafe { (func1(), func2()) }</code>, and func1 and func2 had preconditions, and some of those preconditions are in common, I'd still want to actually have to say <code>SAFETY(func1, func2): common_precondition</code>.</p>



<a name="272455259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455259">(Feb 18 2022 at 20:47)</a>:</h4>
<p>Not just <code>SAFETY: common_precondition</code>.</p>



<a name="272455269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455269">(Feb 18 2022 at 20:47)</a>:</h4>
<p>"Yes, I know this applies to both func1 and func2".</p>



<a name="272455282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455282">(Feb 18 2022 at 20:47)</a>:</h4>
<p>Yes, absolutely</p>



<a name="272455358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455358">(Feb 18 2022 at 20:48)</a>:</h4>
<p>If we had <em>that</em>, and it was somehow <em>required</em> for all unsafe functions, then yeah, I'd be a little less concerned about the size of unsafe blocks.</p>



<a name="272455388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455388">(Feb 18 2022 at 20:48)</a>:</h4>
<p>If it was recommended but not required, then I'd continue to be concerned about the size of unsafe blocks.</p>



<a name="272455403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455403">(Feb 18 2022 at 20:49)</a>:</h4>
<p>(Note that the reference there <code>func1</code> is a 'really hard' question, and I think the primary driver in my mind for minimally sized unsafe blocks)</p>



<a name="272455435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272455435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272455435">(Feb 18 2022 at 20:49)</a>:</h4>
<p>spitball:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="p">(</span><span class="n">valid_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">aligned_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">initialized_target</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="k">fn</span> <span class="nf">read</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"></span>

<span class="n">trusted</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">valid_ptr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"... stuff here"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">aligned_ptr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"... stuff here"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">initialized_target</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"... stuff here"</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ptr</span>::<span class="n">read</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272456066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272456066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272456066">(Feb 18 2022 at 20:55)</a>:</h4>
<p>Earlier someone proposed <code>mod unsafe</code>. I think this might have helped with spotting the issue in <a href="https://github.com/rust-lang/rust/issues/94115">#94115</a> due to the contagiousness of the unsafe requirements. Narrow unsafe blocks can be fiction.</p>



<a name="272456793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272456793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272456793">(Feb 18 2022 at 21:00)</a>:</h4>
<p>Or <code>unsafe struct</code> perhaps.</p>



<a name="272457137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272457137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272457137">(Feb 18 2022 at 21:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272456793">said</a>:</p>
<blockquote>
<p>Or <code>unsafe struct</code> perhaps.</p>
</blockquote>
<p>Any thoughts on how this would differ from unsafe fields?</p>
<p>I guess I haven't thought through whether it would ever make sense to have a struct where only <em>some</em> of the fields are unsafe.  If realistically one would just make all the fields unsafe, then it might as well be at the struct level</p>



<a name="272457516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272457516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272457516">(Feb 18 2022 at 21:07)</a>:</h4>
<p>I meant this more as a marker that a struct has <code>unsafe impl Trait for MyStruct</code> somewhere else so you need to think about invariants when touching anything related to that struct, its fields and even safe impls.</p>



<a name="272457770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272457770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272457770">(Feb 18 2022 at 21:09)</a>:</h4>
<p>But yeah, ok, I guess in this case having it on the field might have worked too. But there are others where it wouldn't. <code>adapters::Zip</code> for example is just all-unsafe.</p>



<a name="272458070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272458070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272458070">(Feb 18 2022 at 21:12)</a>:</h4>
<p>The real annoying part in that case is specialization. The default impl is harmless. Only when specialized everything becomes radioactive. This is hard to express with markers. Maybe if we had views then the view could be used to introduce conditional unsafety.</p>



<a name="272458131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272458131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272458131">(Feb 18 2022 at 21:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272457516">said</a>:</p>
<blockquote>
<p>I meant this more as a marker that a struct has <code>unsafe impl Trait for MyStruct</code> somewhere else</p>
</blockquote>
<p>Hmm, I don't know that that necessarily means there are invariants, though.  Like <code>unsafe impl TrustedOrd for PairOfUsize{}</code> could be fine even if there's no invariants on the fields at all.</p>



<a name="272458454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272458454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272458454">(Feb 18 2022 at 21:15)</a>:</h4>
<p>Using <code>derive(Ord)</code> would be part of it though. If someone comes in and adds a custom Ord impl and doesn't see the TrustedOrd they could break it.</p>



<a name="272458787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272458787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272458787">(Feb 18 2022 at 21:18)</a>:</h4>
<p>Perhaps in the same realm as <strong>simulacrum</strong>'s effect system , perhaps completely disjoint, I'd love for a way to avoid this comment:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// SAFETY: This is **not** actually safe. The user of `RawStr` must ensure that the safety contract</span>
<span class="sd">/// of [`Self::as_str`] is upheld to use this trait.</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RawStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>



<a name="272458857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272458857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272458857">(Feb 18 2022 at 21:19)</a>:</h4>
<p>(that <code>RawStr</code> type is not public, thankfully, so it's just on me to deal with that)</p>



<a name="272461394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272461394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272461394">(Feb 18 2022 at 21:42)</a>:</h4>
<p>That's why I like <code>impl const Default</code> instead of <code>const impl Default</code>, actually.</p>
<p>Because I could imagine <code>impl unsafe Hash for RawStr</code> that makes all the methods unsafe to call, as something different from the <code>unsafe impl Hash for RawStr</code> that has a meaning today.</p>



<a name="272463822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272463822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272463822">(Feb 18 2022 at 22:02)</a>:</h4>
<p>I'm not saying the semantic distinction might not be useful there, but I'll never remember which of those is which :P</p>



<a name="272484456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272484456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272484456">(Feb 19 2022 at 02:09)</a>:</h4>
<p>(While I don't disagree, at least <code>unsafe impl Hash</code> would be an error because <code>Hash</code> isn't an <code>unsafe Trait</code>, and <code>impl unsafe TrustedLen</code> would be an error because <code>TrustedLen</code> <em>is</em> an <code>unsafe Trait</code>.)</p>



<a name="272506476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272506476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272506476">(Feb 19 2022 at 09:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes/near/272458787">said</a>:</p>
<blockquote>
<p>Perhaps in the same realm as <strong>simulacrum</strong>'s effect system , perhaps completely disjoint, I'd love for a way to avoid this comment:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// SAFETY: This is **not** actually safe. The user of `RawStr` must ensure that the safety contract</span>
<span class="sd">/// of [`Self::as_str`] is upheld to use this trait.</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RawStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Heh, this makes me wonder about a safety comment I just wrote today:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Safety: This is actually unsafe, `foo()` requires that we don't call `bar()` on the result but we do anyway.</span>
<span class="c1">// This leads to a potential data race, but it's unlikely to occur in practice because &lt;reasons&gt;. FIXME</span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">}.</span><span class="n">bar</span><span class="p">()</span><span class="w"></span>
</code></pre></div>



<a name="272506640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272506640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272506640">(Feb 19 2022 at 09:34)</a>:</h4>
<p>I wonder where in the ecosystem of safety contracts we put "things that are actually bugs and consciously written that way but are low priority for whatever reason"</p>



<a name="272519144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272519144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272519144">(Feb 19 2022 at 13:41)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> Is that comment meant to say “This is actually unsound” instead of “This is actually unsafe”?</p>



<a name="272519365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%2393678%20unused_unsafe%20changes/near/272519365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.2393678.20unused_unsafe.20changes.html#272519365">(Feb 19 2022 at 13:44)</a>:</h4>
<p>Yes, although I usually only use that terminology for libraries and this is application code (although that might just be irrational naming sense on my part)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>