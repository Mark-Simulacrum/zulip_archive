<html>
<head><meta charset="utf-8"><title>Type ascription coercion regression? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html">Type ascription coercion regression?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271811023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271811023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271811023">(Feb 14 2022 at 10:58)</a>:</h4>
<p>I have the following expression: <code>&amp;[85, 87, 90, 91]: &amp;[_]</code> I expect this to compile since <code>let g1: &amp;[_] = &amp;[86, 88, 89, 92];</code> also compiles, and type ascription should be a possible coercion site. Was this changed accidentally or deliberately? Or did it never work? (Note that as opposed to coercing trait objects, using <code>as</code> doesn't work here).</p>



<a name="271811272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271811272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271811272">(Feb 14 2022 at 11:00)</a>:</h4>
<p>And follow-up, is there anyone to force the coercion without declaring a local variable?</p>



<a name="271815724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271815724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271815724">(Feb 14 2022 at 11:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F/near/271811272">said</a>:</p>
<blockquote>
<p>And follow-up, is there anyone to force the coercion without declaring a local variable?</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">core</span>::<span class="n">convert</span>::<span class="n">identity</span>::<span class="o">&lt;&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=d6770c2e773a3ed008d9e21f8b7ff9ad">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=d6770c2e773a3ed008d9e21f8b7ff9ad</a></p>



<a name="271826138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271826138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271826138">(Feb 14 2022 at 13:34)</a>:</h4>
<p>So, as of <code>1.33</code>,</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(type_ascription)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">coerced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>already failed <a href="https://rust.godbolt.org/z/sr8G6v6M8">https://rust.godbolt.org/z/sr8G6v6M8</a>.</p>
<p>So I guess that when you talk of regression is not <em>w.r.t.</em> a past implementation of the feature, but <em>w.r.t.</em> the semantics laid out in the RFC. As in, you'd expect <code>&lt;expr&gt; : &lt;ty&gt;</code> to behave kind of like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span>: <span class="o">&lt;</span><span class="n">ty</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">e</span><span class="w"></span>
<span class="p">}}</span><span class="w"></span>
</code></pre></div>
<p>right? (or <code>identity::&lt;ty&gt;(&lt;expr&gt;)</code> (or <code>match &lt;expr&gt; { e: &lt;ty&gt; =&gt; e }</code> if ascriptions on patterns were a thing)). From looking at <a href="https://rust-lang.github.io/rfcs/0803-type-ascription.html">the <code>ascription</code> RFC (<code>#803</code>)</a>, it does seem like <em>implicit</em> coercion is expected to be part of the features of type ascription, so you are right that the full RFC hasn't been implemented yet.</p>
<p>Moreover, the last comment in that RFC's tracking issue is from Niko, who <a href="https://github.com/rust-lang/rust/pull/21836#issuecomment-172988891">states</a>:</p>
<blockquote>
<p>(Note that this has now been implemented in <a href="https://github.com/rust-lang/rust/pull/30184">#30184</a>, but without the coercion aspect.)</p>
</blockquote>
<p>And indeed <a href="https://github.com/rust-lang/rust/pull/30184">#30814</a> states:</p>
<blockquote>
<p>So, you can't write things with coercions like <code>let slice = &amp;[1, 2, 3]: &amp;[u8];</code>. It obviously makes type ascription less useful than it should be, but it's still much more useful than not having type ascription at all.<br>
In particular, things like <code>let v = something.iter().collect(): Vec&lt;_&gt;;</code> and <code>let u = t.into(): U;</code> work as expected and I'm pretty happy with these improvements alone.</p>
</blockquote>



<a name="271826658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271826658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271826658">(Feb 14 2022 at 13:39)</a>:</h4>
<p>Note that some of these unsugarings would thus be allowed to <em>move</em> from a place:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(());</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>

<span class="c1">// vs.</span>

<span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(());</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">b</span>: <span class="nc">_</span><span class="p">);</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="c1">// Error, use of moved value?</span>

<span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(());</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">b</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"> </span><span class="c1">// Error, use of moved value for sure.</span>
</code></pre></div>
<p>Is that desired?</p>



<a name="271826855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271826855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271826855">(Feb 14 2022 at 13:41)</a>:</h4>
<p>(For reference, <code>as</code> casts do move / perform a place-to-value conversion even in the identity case; and the current implementation of <code>:</code> casts does not).</p>



<a name="271905094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271905094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271905094">(Feb 14 2022 at 23:34)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> IMO only the last of your examples should cause a coercion, i.e. <code>e: _</code> should always be equivalent to <code>e</code> even if <code>e</code> is a place expression. Coercions should always be derivable from a top down reading of the code. If you tried to use <code>x</code> later in the second example as <code>&amp;Box&lt;dyn Send&gt;</code> you would get an error</p>



<a name="271905299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Type%20ascription%20coercion%20regression%3F/near/271905299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Type.20ascription.20coercion.20regression.3F.html#271905299">(Feb 14 2022 at 23:36)</a>:</h4>
<p>the RFC doesn't give an example with <code>: _</code> but it probably should</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>