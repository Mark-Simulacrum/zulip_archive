<html>
<head><meta charset="utf-8"><title>is inline(never) guaranteed? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html">is inline(never) guaranteed?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270032604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270032604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270032604">(Jan 31 2022 at 13:44)</a>:</h4>
<p>I'm preparing a documentation PR for the stabilization of the naked attribute. The naked attribute RFC requires that a naked function must never be inlined; it characterizes this as an implicit <code>#[inline(never)]</code>. And yet the reference has this note regarding the inline attribute:</p>
<blockquote>
<p>Note: #[inline] in every form is a hint, with no requirements on the language to place a copy of the attributed function in the caller.</p>
</blockquote>
<p>I think the "in every form" bit might be an error, and was probably intended only to apply to every form <em>except</em> <code>#[inline(never)]</code>, but I wanted to make sure. Is <code>#[inline(never)]</code> guaranteed to never inline the function? If so, I'll make a PR fixing this in the reference.</p>



<a name="270034432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270034432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270034432">(Jan 31 2022 at 13:56)</a>:</h4>
<p>I would think that <code>#[inline(never)]</code> is the exception to the rule. However, it may be possible that operations outside of the control of rustc or llvm may perform the inlining.</p>



<a name="270034446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270034446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270034446">(Jan 31 2022 at 13:56)</a>:</h4>
<p>I don't think inline(never) should guarantee it absolutely never will get inlined.</p>
<p>Maybe it's worth instead saying what is actually necessary for a naked function, which presumably is that the asm is entered into as-if (roughly) a call instruction had just occurred? It feels weird to define it as "some optimization did not occur" to me, rather than positively in terms of what must happen.</p>



<a name="270034558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270034558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270034558">(Jan 31 2022 at 13:57)</a>:</h4>
<p>Although that raises the question of what "a call instruction" means.</p>



<a name="270034787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270034787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270034787">(Jan 31 2022 at 13:58)</a>:</h4>
<p>Sure, but the same "what is inlining" question arises, if you want to guarantee it doesn't happen -- say, if my optimizer knows that the assembly in that naked function has no side effects, can I delete the call? (It could be viewed as a form of inlining)</p>



<a name="270035115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270035115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270035115">(Jan 31 2022 at 14:00)</a>:</h4>
<p>Possibly. The asm would need the "pure" attribute, because implementations aren't allowed to make assumptions about the content of the asm declaration, beyond the declarations.</p>



<a name="270036273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270036273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270036273">(Jan 31 2022 at 14:08)</a>:</h4>
<p>As specified, the assembly within a naked function disallows the <code>pure</code> option</p>



<a name="270036393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270036393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270036393">(Jan 31 2022 at 14:09)</a>:</h4>
<p>Ok, so then the compiler can't remove it because the compiler isn't allowed to be smart about the actual contents of the assembly declaration.</p>



<a name="270036447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270036447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270036447">(Jan 31 2022 at 14:09)</a>:</h4>
<p>Whatever the output of this discussion may be, it ought to be relevant w.r.t. stuff such as <a href="https://github.com/rustwasm/wasm-bindgen/blob/232d94e6b50975e342f9308684effa99591da845/src/closure.rs#L346-L349">https://github.com/rustwasm/wasm-bindgen/blob/232d94e6b50975e342f9308684effa99591da845/src/closure.rs#L346-L349</a></p>



<a name="270036851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270036851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270036851">(Jan 31 2022 at 14:12)</a>:</h4>
<p>(cc <span class="user-mention" data-user-id="116015">@Alex Crichton</span>)<br>
I wonder if that snippet ought to have been using an <code>extern</code> declaration, if its purpose is to be hijacked <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I guess the lack of generic <code>extern</code> is the problem, here, but I could envision that being easier to overcome in some specific scenarios than guaranteeing <em>all</em> the <code>inline(never)</code>s to be enforced;</p>



<a name="270038738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270038738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270038738">(Jan 31 2022 at 14:25)</a>:</h4>
<p>Just wanted to note that this is not possible to guarantee for <code>nvptx64-nvidia-cuda</code> for the rust-cuda project because OptiX (hardware raytracing) requires that all functions be inlined no matter what</p>



<a name="270038878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270038878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270038878">(Jan 31 2022 at 14:26)</a>:</h4>
<p>not that its actually observable because reg vs spilled is not observable in PTX because ptx uses virtual registers and you cannot query the local memory stack pointer</p>



<a name="270038912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270038912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270038912">(Jan 31 2022 at 14:26)</a>:</h4>
<p>But making such a guarantee would be weird when optix is like "hey, function calls, yeah we don't do that here thanks"</p>



<a name="270038983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270038983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270038983">(Jan 31 2022 at 14:27)</a>:</h4>
<p><code>#[inline(never)]</code> can't be guaranteed. LLVM propagates information both into (if an argument is always the same LLVM removes the argument and puts the fixed value in the function body) and out of (for example if it is pure, reads memory, writes memory, ...) such functions. This means that LLVM will for example optimize away a call to an <code>#[inline(never)]</code> function if it sees that it is pure and the return value is unused.</p>



<a name="270039261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039261">(Jan 31 2022 at 14:28)</a>:</h4>
<p>Ah yeah, constant propagation duplicates. Though it still does perform a function call.</p>



<a name="270039508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039508">(Jan 31 2022 at 14:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/270039261">said</a>:</p>
<blockquote>
<p>Ah yeah, constant propagation duplicates. Though it still does perform a function call.</p>
</blockquote>
<p>This is not guaranteed. For example see <a href="https://rust.godbolt.org/z/PPb1P9vjj">https://rust.godbolt.org/z/PPb1P9vjj</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline(never)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_1_2</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">example:</span><span class="err">:</span><span class="nl">add_1_2:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">al</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</code></pre></div>



<a name="270039588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039588">(Jan 31 2022 at 14:30)</a>:</h4>
<p>LLVM propagated the arguments into the <code>add</code> and then propagated the return value out of the <code>add</code>.</p>



<a name="270039698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039698">(Jan 31 2022 at 14:31)</a>:</h4>
<p>Hmm... Yay.</p>



<a name="270039742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039742">(Jan 31 2022 at 14:31)</a>:</h4>
<p>Calling <code>add</code> with two different sets of arguments will cause calls though. <a href="https://rust.godbolt.org/z/T5r3KPq5d">https://rust.godbolt.org/z/T5r3KPq5d</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline(never)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_1_2</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_2_2</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">example:</span><span class="err">:</span><span class="nl">add:</span><span class="w"></span>
<span class="w">        </span><span class="nf">lea</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>

<span class="nl">example:</span><span class="err">:</span><span class="nl">add_1_2:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="nf">jmp</span><span class="w">     </span><span class="no">example</span><span class="p">::</span><span class="no">add</span><span class="w"></span>

<span class="nl">example:</span><span class="err">:</span><span class="nl">add_2_2:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">        </span><span class="nf">jmp</span><span class="w">     </span><span class="no">example</span><span class="p">::</span><span class="no">add</span><span class="w"></span>
</code></pre></div>



<a name="270039800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039800">(Jan 31 2022 at 14:32)</a>:</h4>
<p>(I swear, if clang breaks any kind of libc the same way...)</p>



<a name="270039889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270039889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270039889">(Jan 31 2022 at 14:32)</a>:</h4>
<p>This seems to only affect pure functions, though, which was established to not apply to <code>#[naked]</code> functions.</p>



<a name="270040128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270040128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270040128">(Jan 31 2022 at 14:34)</a>:</h4>
<p>I think it would be fine to say that naked functions will have their callstack setup as if there was a regular call to them according to the specified abi, but not guarantee that the code is physically not part of the caller.</p>



<a name="270040883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270040883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270040883">(Jan 31 2022 at 14:38)</a>:</h4>
<p>Gcc duplicates <code>add</code> if it is called multiple times. It const propagates the arguments into add, but the result not out of add. <a href="https://gcc.godbolt.org/z/G4cx7xnf6">https://gcc.godbolt.org/z/G4cx7xnf6</a></p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"stdint.h"</span><span class="cp"></span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="n">add_1_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="n">add_2_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">add.constprop.0:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
<span class="nl">add.constprop.1:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
<span class="nl">add_1_2:</span><span class="w"></span>
<span class="w">        </span><span class="nf">jmp</span><span class="w">     </span><span class="no">add.constprop.1</span><span class="w"></span>
<span class="nl">add_2_2:</span><span class="w"></span>
<span class="w">        </span><span class="nf">jmp</span><span class="w">     </span><span class="no">add.constprop.0</span><span class="w"></span>
</code></pre></div>



<a name="270048146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270048146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270048146">(Jan 31 2022 at 15:22)</a>:</h4>
<p>Regarding to the naked function though, I think in this case <code>#[inline(never)]</code> (or LLVM noinline) should actually be guaranteed noinline, since optimizer can't see through naked function.</p>



<a name="270091819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270091819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270091819">(Jan 31 2022 at 19:37)</a>:</h4>
<p><code>inline(never)</code> isn't always respected by LLVM, IIRC.  I recall seeing something get inlined despite it when the function is simple enough.</p>



<a name="270091941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270091941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270091941">(Jan 31 2022 at 19:38)</a>:</h4>
<p>But yeah, the question has the core problem that what it doesn't isn't "observable" in the abstract machine, so defining what it should guarantee is hard.</p>



<a name="270097526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270097526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270097526">(Jan 31 2022 at 20:14)</a>:</h4>
<p>There is one situation where inlining has observable side effects: when capturing a backtrace. The <code>backtrace</code> crate  actually relies on this to strip a fixed number of "internal" frames from backtraces: <a href="https://github.com/rust-lang/backtrace-rs/blob/6b13969dae31b45dd6dd45515f0c326f2bab2de0/src/capture.rs#L138">https://github.com/rust-lang/backtrace-rs/blob/6b13969dae31b45dd6dd45515f0c326f2bab2de0/src/capture.rs#L138</a></p>



<a name="270098043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270098043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270098043">(Jan 31 2022 at 20:17)</a>:</h4>
<p>Regarding naked functions, I would argue that these exist outside of the normal inlining rules anyways. It's impossible for LLVM to inline them anyways since the inline assembly contains a return instruction.</p>



<a name="270098337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270098337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270098337">(Jan 31 2022 at 20:18)</a>:</h4>
<p>It could still get tail-call-inlined, right? (instead of a jmp, just append the assembly blob), presuming the caller sets up an as-if fresh stack frame, essentially?</p>



<a name="270098423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270098423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270098423">(Jan 31 2022 at 20:19)</a>:</h4>
<p>iow the assembly may not be after the (potentially mangled) symbol name for the function, so to speak</p>



<a name="270100025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270100025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270100025">(Jan 31 2022 at 20:30)</a>:</h4>
<p>I suppose that would work if the naked function was only ever called from a single place and its address is never taken. But in that case you probably didn't need a naked function in the first place and could've done the same thing using plain inline asm.</p>



<a name="270103876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270103876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270103876">(Jan 31 2022 at 21:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/270097526">said</a>:</p>
<blockquote>
<p>There is one situation where inlining has observable side effects: when capturing a backtrace.</p>
</blockquote>
<p>I'm using <em>Observable</em> in the spec sense, here -- backtraces are not considered observable in the language definition, because otherwise inlining in general wouldn't be a legal optimization.</p>



<a name="270106422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270106422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270106422">(Jan 31 2022 at 21:18)</a>:</h4>
<p>I don't think we should disallow duplicating naked <code>#[inline(never)]</code> functions given that gcc can duplicate <code>#[inline(never)]</code> in certain cases as shown in one of my previous messages.</p>



<a name="270107306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270107306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270107306">(Jan 31 2022 at 21:24)</a>:</h4>
<p>That is likely to break some code which exports symbols from a naked function. I'd rather just disallow all optimizations on naked functions: if it turns out to be a problem with LLVM then we can switch to lowering naked functions to <code>global_asm!</code> instead.</p>



<a name="270107659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270107659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270107659">(Jan 31 2022 at 21:26)</a>:</h4>
<p>We definitely do duplicate naked functions under some circumstances.</p>



<a name="270107768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270107768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270107768">(Jan 31 2022 at 21:27)</a>:</h4>
<p>For example when they are generic, but that seems to hard to avoid regardless.</p>



<a name="270108606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270108606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270108606">(Jan 31 2022 at 21:33)</a>:</h4>
<p>Sure, but in that case we would just lower to a separate <code>global_asm!</code> per instantiation.</p>



<a name="270565108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270565108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270565108">(Feb 03 2022 at 15:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/270107306">said</a>:</p>
<blockquote>
<p>That is likely to break some code which exports symbols from a naked function. I'd rather just disallow all optimizations on naked functions: if it turns out to be a problem with LLVM then we can switch to lowering naked functions to <code>global_asm!</code> instead.</p>
</blockquote>
<p>does the global_asm route also address the case where the same crate gets linked in twice under different versions?</p>



<a name="270566443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270566443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270566443">(Feb 03 2022 at 15:27)</a>:</h4>
<p>We can include the mangled name of the naked function as part of the global asm if the naked function had a mangled name. If not, <code>#[no_mangle]</code> on a regular function would already give problems when trying to link multiple versions.</p>



<a name="270581567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270581567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270581567">(Feb 03 2022 at 17:00)</a>:</h4>
<p>would this also suffice to allow named asm labels in naked functions without the risk of collisions?</p>



<a name="270582623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270582623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270582623">(Feb 03 2022 at 17:05)</a>:</h4>
<p>currently the state of named asm labels in naked functions is a bit confused... a comment in the test at <a href="https://github.com/rust-lang/rust/blob/8b7853fe1f87a40ceaddf63aa404817bbfa69676/src/test/ui/asm/named-asm-labels.rs">https://github.com/rust-lang/rust/blob/8b7853fe1f87a40ceaddf63aa404817bbfa69676/src/test/ui/asm/named-asm-labels.rs</a> suggests that named labels are <em>supposed</em> to work in naked functions, but also in the file there's a test case that ensures that named labels <em>don't</em> work in naked functions</p>



<a name="270596695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270596695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270596695">(Feb 03 2022 at 18:36)</a>:</h4>
<p>Named labels can break with LTO due to conflicts between crates. For this reason I think they should be allowed for neither naked functions nor regular functions.</p>



<a name="270648292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270648292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270648292">(Feb 04 2022 at 00:18)</a>:</h4>
<p>It seems plausble that you could make it work for #[no_mangle] naked functions. But I also don't think it sounds that useful honestly</p>



<a name="270650749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270650749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270650749">(Feb 04 2022 at 00:43)</a>:</h4>
<p>one case where duplication could be problematic is SYS_rseq, which requires you provide the kernel with some addresses and offsets of labels inside some your function (this function basically must be written in assembly in practice). Then, if/when the kernel suspends a thread while its executing, it calls the code located at those labels in certain ways.</p>
<p>It would be very broken if this was duplicated. I don't really think this would be convenient (an perhaps not even possible) to write as a naked function though, -- I think it would be very hard to get the offsets of the labels inside your function and such to stick in the little descriptor object you need to give to the kernel. so honestly i would do this using global_asm, or an external assembler.</p>



<a name="270651126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270651126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270651126">(Feb 04 2022 at 00:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/270098337">said</a>:</p>
<blockquote>
<p>It could still get tail-call-inlined, right? (instead of a jmp, just append the assembly blob), presuming the caller sets up an as-if fresh stack frame, essentially?</p>
</blockquote>
<p>would this be okay? asm! explicitly allows code patching and forbids the compiler from assuming these instructions will be executed, so i'm not sure.</p>



<a name="270651324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270651324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270651324">(Feb 04 2022 at 00:50)</a>:</h4>
<p>i guess it might still be okay technically. but it's not that clear to me. i would be too scared to do this if i were a compiler.</p>



<a name="270704110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270704110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270704110">(Feb 04 2022 at 11:55)</a>:</h4>
<p>You can still use numbered labels, just not named ones. Numbered labels should be enough for SYS_rseq, right?</p>



<a name="270744002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270744002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270744002">(Feb 04 2022 at 17:10)</a>:</h4>
<p>As the person that wrote that comment it isn't entirely accurate, I was missing some info then. I don't believe the bit about naked functions is entirely true and the comment should mention the other reasons.</p>



<a name="270751937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270751937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270751937">(Feb 04 2022 at 18:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/270704110">said</a>:</p>
<blockquote>
<p>You can still use numbered labels, just not named ones. Numbered labels should be enough for SYS_rseq, right?</p>
</blockquote>
<p>oh, sure. the thing you'd want a named label for is the descriptor object, i think?</p>



<a name="270752372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270752372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270752372">(Feb 04 2022 at 18:17)</a>:</h4>
<p>I wouldn't expect that to be necessary.</p>



<a name="270752861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/270752861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#270752861">(Feb 04 2022 at 18:21)</a>:</h4>
<p>you're probably right, although i don't quite follow. after work i can come up with a snippet that shows what i think is needed, so you can correct me. regardless, i dont really think its a dealbreaker if you cant use really use naked with sys_rseq in practice, since its pretty obscure, and should work fine with global_asm anyway.</p>



<a name="272154675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272154675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272154675">(Feb 16 2022 at 18:05)</a>:</h4>
<p>Continuing the discussion as suggested in <a href="https://github.com/rust-lang/rust/issues/90957#issuecomment-1041578558">https://github.com/rust-lang/rust/issues/90957#issuecomment-1041578558</a>...</p>



<a name="272156990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272156990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272156990">(Feb 16 2022 at 18:20)</a>:</h4>
<p>I'm concerned about allowing naked functions to be inlined. I don't think it is functionality that users want, and believe that it may silently break seemingly valid code. At the very least, it would be good to provide more precise semantics for what is being guaranteed. Since naked functions can observe their own program counter (PC) value, that seems like a good way to define inlining semantics.</p>
<p>One possible set of guarantees:</p>
<ol>
<li>All invocations of a single naked function should start at the same PC.</li>
<li>That PC should be located within the section specified by `#[link_section].</li>
<li>And the PC should match the address of the naked function itself, if it is ever taken.</li>
</ol>



<a name="272157458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272157458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272157458">(Feb 16 2022 at 18:24)</a>:</h4>
<blockquote>
<p>and believe that it may silently break seemingly valid code.</p>
</blockquote>
<p>Like what kind of code? If <code>#[link_section]</code> is used inlining requires both caller and callee to be in the same section anyway afaik. For naked functions without <code>#[link_section]</code> inlining into functions without <code>#[link_section]</code> should be fine. It just has to ensure that the stack and registers are setup as if a call for the specified ABI happens.</p>



<a name="272157777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272157777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272157777">(Feb 16 2022 at 18:26)</a>:</h4>
<p>I don't think we can ever guarantee naked functions not being duplicated. If a function is used by an <code>#[inline]</code> function, the function currently gets exported from the crate. It may in some cases be beneficial to instead codegen the function multiple times to not export it. For example not exporting may allow omitting usage of the GOT when calling into the function. Or it may allow the function to not be codegened at all if the <code>#[inline]</code> function is never used.</p>



<a name="272158418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272158418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272158418">(Feb 16 2022 at 18:31)</a>:</h4>
<p>Also it seems generic naked functions are accepted. For generic functions it is impossible to prevent duplication. <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=d61607ee17a484bb8f52bf15e9e4259c">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=d61607ee17a484bb8f52bf15e9e4259c</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(naked_functions)]</span><span class="w"></span>

<span class="cp">#[naked]</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">arch</span>::<span class="fm">asm!</span><span class="p">(</span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">(</span><span class="n">noreturn</span><span class="p">));</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>::<span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="c">; [...]</span>
<span class="c">; playground::foo</span>
<span class="c">; Function Attrs: naked noinline nonlazybind uwtable</span>
<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_ZN10playground3foo17h2eb24d36e2583c01E</span><span class="p">()</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!6</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">start:</span><span class="w"></span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="k">sideeffect</span><span class="w"> </span><span class="k">alignstack</span><span class="w"> </span><span class="k">inteldialect</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="s">"~{dirflag},~{fpsr},~{flags},~{memory}"</span><span class="p">(),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!14</span><span class="p">,</span><span class="w"> </span><span class="nv">!srcloc</span><span class="w"> </span><span class="nv nv-Anonymous">!15</span><span class="w"></span>
<span class="w">  </span><span class="k">unreachable</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!14</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c">; playground::foo</span>
<span class="c">; Function Attrs: naked noinline nonlazybind uwtable</span>
<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_ZN10playground3foo17h62d0bb9f942b39abE</span><span class="p">()</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">start:</span><span class="w"></span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="k">asm</span><span class="w"> </span><span class="k">sideeffect</span><span class="w"> </span><span class="k">alignstack</span><span class="w"> </span><span class="k">inteldialect</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="s">"~{dirflag},~{fpsr},~{flags},~{memory}"</span><span class="p">(),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!20</span><span class="p">,</span><span class="w"> </span><span class="nv">!srcloc</span><span class="w"> </span><span class="nv nv-Anonymous">!15</span><span class="w"></span>
<span class="w">  </span><span class="k">unreachable</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!20</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c">; [...]</span>
</code></pre></div>



<a name="272159161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272159161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272159161">(Feb 16 2022 at 18:37)</a>:</h4>
<p>Also, preventing inlining is still impossible on some targets, as noted above.</p>



<a name="272177023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272177023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272177023">(Feb 16 2022 at 20:55)</a>:</h4>
<p>Good point about the generic naked functions, that's an important intended use case</p>



<a name="272177160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272177160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272177160">(Feb 16 2022 at 20:56)</a>:</h4>
<p>It does suggest that the language in the reference should focus less on "inlining" and more on "duplication"</p>



<a name="272177295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272177295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272177295">(Feb 16 2022 at 20:57)</a>:</h4>
<p>since obviously the setting-up-the-callstack concern should go without saying as it's required for correctness and completely out of the user's control</p>



<a name="272177464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272177464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272177464">(Feb 16 2022 at 20:58)</a>:</h4>
<p>and that the duplication concern applies to all asm in every context, either via asm in any function or asm in generic naked functions or global_asm in LTO'd multi-version-of-the-same-crate projects</p>



<a name="272178900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272178900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272178900">(Feb 16 2022 at 21:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/272157458">said</a>:</p>
<blockquote>
<blockquote>
<p>and believe that it may silently break seemingly valid code.</p>
</blockquote>
<p>Like what kind of code? If <code>#[link_section]</code> is used inlining requires both caller and callee to be in the same section anyway afaik. For naked functions without <code>#[link_section]</code> inlining into functions without <code>#[link_section]</code> should be fine. It just has to ensure that the stack and registers are setup as if a call for the specified ABI happens.</p>
</blockquote>
<p>Any kind of self modifying code is going to behave very strangely when duplicated. On many architectures reading the program counter is just a matter of <code>lea  rax, [rip]</code>, <code>auipc x1, 0</code> or similar. And once the PC is stored in a general purpose register, there's many ways to have code break if a register's value isn't what the programmer assumed. Another example I can imagine is to perform some potentially trapping instruction in a naked function and assume that the resulting fault will have the address of the function.</p>
<p>All of these can probably be avoided or worked around. However, having them compile without errors or warnings, while leaving open the possibility of a later compiler version breaking them<br>
 feels like a foot-gun.</p>



<a name="272179374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272179374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272179374">(Feb 16 2022 at 21:14)</a>:</h4>
<p>I didn't realize that generic naked functions were allowed, but given that Rust in general monomorphizes them, that feels like much like opting-in to duplicate versions of your function</p>



<a name="272179693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272179693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272179693">(Feb 16 2022 at 21:17)</a>:</h4>
<p>Comparing function pointers doesn't really work even without inline asm ir inlining. We mark all functions as their address not being relevant in he LLVM ir. This means LLVM is allowed to deduplicate functions. (see for example <a href="https://github.com/rust-lang/rust/issues/54685">#54685</a>)</p>



<a name="272180042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272180042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272180042">(Feb 16 2022 at 21:20)</a>:</h4>
<p>As for using a trapping function and then assuming anything about the address of the function 1. how do you know it is in the naked function and not in the function after it? 2. there is an optimization that outlines part of a function (for example cold code), so assuming a function is always contiguous is wrong.</p>



<a name="272180147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272180147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272180147">(Feb 16 2022 at 21:21)</a>:</h4>
<p>Surely we can assume that a single asm! block is always contiguous (like would be present in a naked function)?</p>



<a name="272180253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272180253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272180253">(Feb 16 2022 at 21:22)</a>:</h4>
<p>Maybe.</p>



<a name="272180705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272180705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272180705">(Feb 16 2022 at 21:24)</a>:</h4>
<p>Self modifying code should probably not be done anyway. The text section is likely readonly, antivirus may trigger on it and it is in general hard to understand. One if the few valid use cases of self modifying code I think is the tracing/live patching infrastructure of the linux kernel, but that works by having all code that can be modified registered in a single section I believe. That works fine even when duplicating functions I assume.</p>



<a name="272181257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181257">(Feb 16 2022 at 21:26)</a>:</h4>
<p>smc is <em>fun</em>.</p>



<a name="272181449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181449">(Feb 16 2022 at 21:27)</a>:</h4>
<p>Another thing against self modifying code. It is relatively slow as it requires flushing the instruction cache.</p>



<a name="272181601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181601">(Feb 16 2022 at 21:28)</a>:</h4>
<p>There are read-many, write-rarely tradeoffs that can make it valuable. I think the linux kernel has some strategically placed NOPs that can be patched.</p>



<a name="272181626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181626">(Feb 16 2022 at 21:29)</a>:</h4>
<p>Oh, you mentioned that.</p>



<a name="272181644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181644">(Feb 16 2022 at 21:29)</a>:</h4>
<p>I've been imagining that "do weird stuff in OS kernels" being one of the main target uses for naked functions</p>



<a name="272181686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181686">(Feb 16 2022 at 21:29)</a>:</h4>
<p>JITs too. Java does something similar for polymorphic callsites.</p>



<a name="272181822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181822">(Feb 16 2022 at 21:30)</a>:</h4>
<p>Javascript jits moved away from it for perf reasons I believe.</p>



<a name="272181938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272181938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272181938">(Feb 16 2022 at 21:31)</a>:</h4>
<p>Wasn't that more about W^X restrictions?</p>



<a name="272182180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272182180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272182180">(Feb 16 2022 at 21:33)</a>:</h4>
<p>Yeah, switching away from inline caches had a small but measurable impact on spidermonkey. <a href="https://jandemooij.nl/blog/wx-jit-code-enabled-in-firefox/#performance">https://jandemooij.nl/blog/wx-jit-code-enabled-in-firefox/#performance</a></p>



<a name="272182264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272182264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272182264">(Feb 16 2022 at 21:34)</a>:</h4>
<p>Anyway, point is that people do these kinds of things in real applications.</p>



<a name="272183907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272183907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272183907">(Feb 16 2022 at 21:49)</a>:</h4>
<p>Yeah. And I don't know specifically about those cases, but I'd expect many implementations using of self modifying code that wouldn't work so well if a function was modified but later calls to that function invoked a duplicate (unmodified) version instead</p>



<a name="272184134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272184134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272184134">(Feb 16 2022 at 21:51)</a>:</h4>
<p>Maybe naked or inline(never) don't have to guarantee that and another annotation would be needed to tell LLVM that the address of that function matters.</p>



<a name="272185154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272185154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272185154">(Feb 16 2022 at 22:00)</a>:</h4>
<p>The converse would be making <code>#[naked]</code>default to telling LLVM that the address matters, and if desired, adding a new annotation for naked functions to say that the address doesn't matter</p>



<a name="272187370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272187370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272187370">(Feb 16 2022 at 22:18)</a>:</h4>
<p>that'd be less orthogonal because that annotation then wouldn't be useful on other functions because those already default to that.</p>



<a name="272262504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272262504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272262504">(Feb 17 2022 at 13:58)</a>:</h4>
<p>agreed that I can imagine use cases for the ability to say "never duplicate this function, and produce an error if we can't guarantee that will happen for whatever reason", but also agreed that this feature seems like it could exist as a separate attribute apart from naked functions</p>



<a name="272264192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272264192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272264192">(Feb 17 2022 at 14:10)</a>:</h4>
<p>I think that would just be ill-formed everywhere.<br>
I don't believe there's a way to tell either llvm or gcc not to duplicate function callsites.</p>



<a name="272328850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272328850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272328850">(Feb 17 2022 at 21:47)</a>:</h4>
<p>Not sure if it was mentioned before but one of the reasons we have this note in the reference IIRC is because LLVM can look at the body of the function without inlining it and e.g. replace the call with the result of comptime computation anyway (this is an optimization distinct from inlining). Strictly speaking there was no inlining but in practice it is indistinguishable from inlining.</p>



<a name="272329620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272329620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272329620">(Feb 17 2022 at 21:53)</a>:</h4>
<p>It's one of the reasons I'm pretty against trying to guarantee lack of inlining -- it feels like we're not actually going to succeed at knowing what that means. The 'must have the right call ABI' rule, for example, is something that you can pretty well understand, and seems unlikely to be broken by LLVM.</p>
<p>It doesn't get into non-duplication though, which I'm not sure we can readily guarantee with LLVM or other backends, personally.</p>



<a name="272548824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272548824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272548824">(Feb 19 2022 at 23:02)</a>:</h4>
<p>For NVPTX/CUDA/whatever, the "all functions are <code>#[inline(always)]</code>" just means it's de facto incorrect to ever use a <code>#[naked]</code> function on NVPTX that depends on it not being inlined, as <code>#[naked]</code> depends on you writing an <code>unsafe</code> function and calling it correctly to begin with. If you don't know the call ABI of the system you are writing for, you can only write a naked function correctly by blind luck, and if that call ABI says "lol inline is always", then that's a rule you get to abide by. It's not Rust's job then, it's yours, we can only try to be friendly about mentioning your name is Sisyphus.</p>
<p>But if the entire purpose of the RFC is to prevent functions from being inlined or otherwise duplicated, so they definitely are called once and only once every time they are called, and LLVM never promises that it won't const-fold either the naked function or the call to the function, and generic monomorphization is viewed as defeating the "once and only once" call rule, and the RFC itself seems to say one of the points is to enable generic monomorphization (or macro expansion), then it seems we are at a loss, honestly. We might want to go back to the drawing board and say "what are the actual desirables obtained by that promise?"</p>



<a name="272605619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272605619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272605619">(Feb 20 2022 at 17:34)</a>:</h4>
<p>I personally don't think that guaranteeing a lack of duplication is a primary use case for naked functions. Rather, I think it was just something that several people though would be nice to have, if we could have it, but it increasingly seems like we can't. I don't see it as being a blocker for naked functions, especially since this introduces no new problems that don't already exist (either in any other asm contexts in Rust, or in naked functions in other languages)</p>



<a name="272605717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272605717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272605717">(Feb 20 2022 at 17:36)</a>:</h4>
<p>Also it seems like the only downsides to the lack of this guarantee is that users of certain crates that contain asm with certain properties might get unexpected linker errors in certain contexts/configurations, which may be frustrating but as a failure mode seems neither catastrophic nor especially common</p>



<a name="272609985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272609985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272609985">(Feb 20 2022 at 19:01)</a>:</h4>
<p><em>nods</em></p>



<a name="272610427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272610427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272610427">(Feb 20 2022 at 19:10)</a>:</h4>
<p>Don't know that it's generally possible to have it, though.</p>



<a name="272619423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272619423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272619423">(Feb 20 2022 at 21:59)</a>:</h4>
<p>To me, the biggest concern is that there's no checks to see if a naked function is safe to duplicate. This seemingly goes against Rust's stability guarantees: normally you can be reasonably confident that if your code compiles and runs properly, that it will continue to do so in future rustc versions. A naked function that won't link when duplicated (or worse behaves differently at runtime when duplicated!) could work fine with one rustc version but break in the next due to differences in optimization</p>



<a name="272619611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272619611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272619611">(Feb 20 2022 at 22:01)</a>:</h4>
<p>Thus even if only 1% of naked functions would actually rely on the "no duplication" feature, all uses benefit because the programmer doesn't have to manually verify whether or not the asm block is impacted</p>



<a name="272620458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272620458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272620458">(Feb 20 2022 at 22:17)</a>:</h4>
<p>I think we should have an option to codegen all <code>asm!</code> and <code>global_asm!</code> blocks in ways that may break them if they don't follow the rules. That could be by duplicating them, outlining each asm! block outside naked functions, splitting or merging global_asm! blocks across codegen units or other ways.</p>



<a name="272620473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272620473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272620473">(Feb 20 2022 at 22:17)</a>:</h4>
<p>A bit like the layout randomization option.</p>



<a name="272718020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272718020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272718020">(Feb 21 2022 at 17:45)</a>:</h4>
<blockquote>
<p>normally you can be reasonably confident that if your code compiles and runs properly, that it will continue to do so in future rustc versions</p>
</blockquote>
<p>Sadly when it comes to supporting arbitrary asm, the guarantees start to largely be out of Rust's hands; instead Rust should look to introduce standard APIs that prevent people from needing to resort to asm in common cases (e.g. <code>std::hint::black_box</code>)</p>
<blockquote>
<p>or worse behaves differently at runtime when duplicated!</p>
</blockquote>
<p>Can you come up with any scenario that exhibits this? Global symbols should just lead to linker errors.</p>
<blockquote>
<p>Thus even if only 1% of naked functions would actually rely on the "no duplication" feature</p>
</blockquote>
<p>Do any other languages with naked functions provide a guarantee that naked functions are not duplicated? I'm curious what kind of experience are causing people to hold this assumption. Currently no asm in Rust makes any no-duplication guarantees.</p>



<a name="272718035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272718035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272718035">(Feb 21 2022 at 17:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/272620473">said</a>:</p>
<blockquote>
<p>A bit like the layout randomization option.</p>
</blockquote>
<p>Yes, this sounds like a fun idea</p>



<a name="272719652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/272719652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#272719652">(Feb 21 2022 at 18:02)</a>:</h4>
<blockquote>
<p>Sadly when it comes to supporting arbitrary asm, the guarantees start to largely be out of Rust's hands; instead Rust should look to introduce standard APIs that prevent people from needing to resort to asm in common cases (e.g. std:<span aria-label="hint" class="emoji emoji-1f5dd" role="img" title="hint">:hint:</span>:black_box)</p>
</blockquote>
<p>Indeed. This is part of what <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/asm!.20and.20backends</a> was about: asm support can vary wildly.</p>
<blockquote>
<p>Do any other languages with naked functions provide a guarantee that naked functions are not duplicated? I'm curious what kind of experience are causing people to hold this assumption. Currently no asm in Rust makes any no-duplication guarantees.</p>
</blockquote>
<p>I could not find the documentation from clang or gcc on naked but I remember seeing it previously and IIRC, it didn't make any guarantees about not inlining anything. However, msvc, where the attribute originated actually, has this in it's documentation</p>
<blockquote>
<p>The compiler cannot generate an inline function for a function marked with the naked attribute, even if the function is also marked with the __forceinline keyword.</p>
</blockquote>
<p><a href="https://docs.microsoft.com/en-us/cpp/cpp/naked-cpp?view=msvc-170">https://docs.microsoft.com/en-us/cpp/cpp/naked-cpp?view=msvc-170</a><br>
So there is precedent for naked implying strict noinline.</p>



<a name="273692277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/is%20inline%28never%29%20guaranteed%3F/near/273692277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan Behrens <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/is.20inline(never).20guaranteed.3F.html#273692277">(Mar 01 2022 at 18:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/213817-t-lang/topic/is.20inline.28never.29.20guaranteed.3F/near/272718020">said</a>:</p>
<blockquote>
<blockquote>
<p>or worse behaves differently at runtime when duplicated!</p>
</blockquote>
<p>Can you come up with any scenario that exhibits this? Global symbols should just lead to linker errors.</p>
</blockquote>
<p>A trivial example is a self modifying function that overwrites its own code the first time it is called. Normally, you'd expect the first call to that function to behave one way, and then all subsequent calls to behave differently. But if there are N copies of the function included in the binary, then you can observe up to N calls that behave the original way</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>