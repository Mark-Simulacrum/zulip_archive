<html>
<head><meta charset="utf-8"><title>DST as non-last field of a struct · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html">DST as non-last field of a struct</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277976823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/277976823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#277976823">(Apr 06 2022 at 05:20)</a>:</h4>
<p>This came up with this StackOverflow question: <a href="https://stackoverflow.com/q/71761281/7884305">https://stackoverflow.com/q/71761281/7884305</a></p>
<p>Is there any reason we don't allow DSTs as the non-last field of a struct and just reorder the fields, or there as just no need for it?</p>



<a name="278021016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278021016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278021016">(Apr 06 2022 at 13:12)</a>:</h4>
<p>there may be no need for it nowadays. IIRC rust didn't actually have the capability to reorder struct fields until 2017 or so, so as of 1.0 this restriction would have been necessary</p>



<a name="278035407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278035407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278035407">(Apr 06 2022 at 14:53)</a>:</h4>
<p>I guess this would let you drop the DST before other fields. Any other benefit?</p>



<a name="278088101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278088101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278088101">(Apr 06 2022 at 21:23)</a>:</h4>
<blockquote>
<p>I guess this would let you drop the DST before other fields. Any other benefit?</p>
</blockquote>
<p>I sometimes order fields or group them to improve readability.</p>



<a name="278099406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278099406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278099406">(Apr 06 2022 at 23:21)</a>:</h4>
<p>I'd like to keep this restriction.<br>
A restriction of "must not be reordered relative to any other field" is either to spec, indicate, and to implement then a restriction of "shall be at the greatest offset of all fields".</p>



<a name="278105771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278105771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278105771">(Apr 07 2022 at 00:55)</a>:</h4>
<p>AFAICT this is just about the source order, on disk the DST would still have to be the last field</p>



<a name="278106293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278106293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278106293">(Apr 07 2022 at 01:03)</a>:</h4>
<p>Yeah, that's the part that I would get to spec, indicate, and implement.</p>



<a name="278106363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278106363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278106363">(Apr 07 2022 at 01:04)</a>:</h4>
<p>It's easier to just have a <code>#fixed_relative_order</code> attribute, then a bunch of special case <code>#place_at_end</code> attributes.</p>



<a name="278108579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278108579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278108579">(Apr 07 2022 at 01:46)</a>:</h4>
<p>well presumably you already have to deal with this, since a struct with a DST field can still have its other fields reordered</p>



<a name="278111032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278111032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278111032">(Apr 07 2022 at 02:37)</a>:</h4>
<p>That's what <code>#fixed_relative_order</code> is for.</p>



<a name="278119429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278119429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278119429">(Apr 07 2022 at 05:35)</a>:</h4>
<p>Having the unsized part always be the last field makes it easier to figure out the underlying unsized type as well as preventing multiple unsized fields. Changing this may complicate the compiler, as we now have to use layout information to figure out whether a struct is unsized, we can't just recurse on the last field</p>



<a name="278119477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278119477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278119477">(Apr 07 2022 at 05:36)</a>:</h4>
<p>If we only allow this by having users add an attribute, that maybe less of a problem</p>



<a name="278178641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278178641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278178641">(Apr 07 2022 at 15:10)</a>:</h4>
<p>So I think an interesting example to look at is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="o">?</span><span class="nb">Sized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span>: <span class="nc">T</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">type</span> <span class="nc">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Baz</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>We already have that the layout of <code>Bar</code> and <code>Baz</code> are likely to be distinct, since <code>Bar</code> will probably be laid out as <code>u16 - u8 - [u8; 1]</code> whereas <code>Baz</code> would be free to be laid out as <code>u8 - [u8; 1] - u16</code>.</p>
<p>This can be kind of surprising, I guess.</p>
<p>I don't know if being able to have that <code>c</code> field of <code>Foo</code> not be the last, <em>syntactically</em>, would be helpful or not, but I kind of think that the argument of making "layout rearrangements be visually <em>less</em> surprising" is kind of moot when the compiler is still free, in many other places, to rearrange stuff however it sees fit <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="278200817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278200817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278200817">(Apr 07 2022 at 17:43)</a>:</h4>
<p>Indeed. This is true under lccc's ABI. That example is fine, but if you replaced <code>c</code> with something with higher alignment, for example, <code>[u16;1]</code>, then in the first example, the layout would be <code>b - a - c</code>, whereas the second example, <code>c</code> would be moved to before <code>a</code> since it has a higher alignment requirement, thus <code>b - c - a</code></p>



<a name="278200973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/DST%20as%20non-last%20field%20of%20a%20struct/near/278200973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/DST.20as.20non-last.20field.20of.20a.20struct.html#278200973">(Apr 07 2022 at 17:44)</a>:</h4>
<p>(or if <code>T</code> was made to be <code>T: Sized</code>, rather than <code>T: ?Sized</code>)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>