<html>
<head><meta charset="utf-8"><title>Idea: more features with `#[inline]` · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html">Idea: more features with `#[inline]`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264185158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264185158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264185158">(Dec 08 2021 at 16:57)</a>:</h4>
<p>I recently went into a problem where I wanted to inline a function, but only at a callsite. The <code>#[inline]</code> attribute is currently somewhat limited.</p>
<p>Is it possible to allow <code>#[inline]</code> on call expressions to hint that the function call should be inlined? Another idea: can we add <code>#[inline(recursive)]</code> which hints the body of the function including transitive calls should be inlined?</p>



<a name="264186046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264186046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264186046">(Dec 08 2021 at 17:02)</a>:</h4>
<p><code>#[inline]</code> does more than just hint that the function should be inlined. That hint doesn't really do anything anyways.<br>
It also causes ir for the function to be generated, rather than machine code, which allows the function to be inlined across codegen units w/o LTO. However, this impacts link time, so it shouldn't be the default without the attribute or LTO enabled. <br>
Absent this IR, you can't ask to inline a particular call site if it's in a different codegen unit because there's simply no information with which to perform the inlining.</p>



<a name="264191346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264191346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264191346">(Dec 08 2021 at 17:38)</a>:</h4>
<p>So maybe an <code>#[inlineable]</code> could make sense, to <em>also</em> generate the ir (but have no effect on inline hints on its own), and then have some annotation on call-sites which wish to hint at desiring an inlined call rather than the default linker behavior? (I'm not fond of it also being called <code>#[inline]</code>, it could generate some confusion; maybe something like <code>#[inlined]</code>)</p>



<a name="264206097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264206097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264206097">(Dec 08 2021 at 19:19)</a>:</h4>
<p>Actually, does <code>#[inline]</code> even do anything other than generate the IR?</p>



<a name="264206175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264206175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264206175">(Dec 08 2021 at 19:19)</a>:</h4>
<p>I'm pretty sure llvm at least says "Thank you for the suggestion, I will now proceed to ignore it".</p>



<a name="264206291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264206291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264206291">(Dec 08 2021 at 19:20)</a>:</h4>
<p>It just makes sure it has the info it needs to inline it in downstream crates if it so chooses.</p>



<a name="264206452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264206452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264206452">(Dec 08 2021 at 19:21)</a>:</h4>
<p>If that's the case, then the attribute is already just <code>#[inline]</code>.</p>



<a name="264206585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264206585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264206585">(Dec 08 2021 at 19:22)</a>:</h4>
<p>It does make a difference. The IR is already generated for generic methods (so downstream crates can instantiate them) and yet there are perf differences in such methods being annotated inline or not.</p>



<a name="264211099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264211099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264211099">(Dec 08 2021 at 19:55)</a>:</h4>
<p><code>#[inline]</code> also makes inline threshold bigger. For example here: <a href="https://github.com/rust-lang/rust/blob/4459e720bee5a741b962cfcd6f0593b32dc19009/compiler/rustc_mir_transform/src/inline.rs#L337-L341">https://github.com/rust-lang/rust/blob/4459e720bee5a741b962cfcd6f0593b32dc19009/compiler/rustc_mir_transform/src/inline.rs#L337-L341</a></p>



<a name="264212400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264212400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264212400">(Dec 08 2021 at 20:04)</a>:</h4>
<p>Note that the mir inliner is <a href="https://github.com/rust-lang/rust/blob/4459e720bee5a741b962cfcd6f0593b32dc19009/compiler/rustc_mir_transform/src/inline.rs#L41-L47">currently off</a>, IIUC, so that code isn't actually impacting anything right now.</p>



<a name="264224557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264224557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264224557">(Dec 08 2021 at 21:38)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> (aside: is there any sort of issue to subscribe to for when mir inline will be turned on?)</p>



<a name="264269659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264269659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264269659">(Dec 09 2021 at 08:34)</a>:</h4>
<p>I don't know of any particular issue, <span class="user-mention" data-user-id="224471">@Lokathor</span>.  Could always follow <a class="stream" data-stream-id="189540" href="/#narrow/stream/189540-t-compiler.2Fwg-mir-opt">#t-compiler/wg-mir-opt</a></p>



<a name="264365008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Idea%3A%20more%20features%20with%20%60%23%5Binline%5D%60/near/264365008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Idea.3A.20more.20features.20with.20.60.23.5Binline.5D.60.html#264365008">(Dec 09 2021 at 20:56)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/81567">https://github.com/rust-lang/rust/issues/81567</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>