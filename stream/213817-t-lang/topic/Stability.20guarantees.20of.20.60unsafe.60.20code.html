<html>
<head><meta charset="utf-8"><title>Stability guarantees of `unsafe` code · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html">Stability guarantees of `unsafe` code</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277220411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277220411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277220411">(Mar 31 2022 at 00:42)</a>:</h4>
<p>If ever some variant of SB, strict provenance, etc. is stabilized, it is inevitable that some code will "break" - there are multiple possible levels to this though:</p>
<ul>
<li>Code for which there was non-normative agreement that it is unsound already becomes normatively unsound</li>
<li>Code for which it was unclear whether it would be sound becomes normatively unsound</li>
<li>Code for which there was non-normative agreement that it would be sound becomes normatively unsound</li>
<li>Code for which there was normative agreement (for each of the various definitions of normative that you like) that it would be sound becoming normatively unsound</li>
</ul>
<p>Additionally, some code will stop compiling - this is likely inevitable, as at the very least CTFE will be allowed to report more UB. It might also be the case that some APIs or language features have to be deprecated. I don't want to go into the details of <em>which</em> right now, that can be discussed elsewhere.</p>
<p>My question is this: Currently, it's vaguely permitted for us to do such a thing under the "soundness fixes" exception to the stability guarantees. Is it worth it to try and clarify what exactly that covers, even if the answer is "potentially quite a lot"? To take some extreme example, (lets please not argue whether they are realistic or a good idea here) would eventually removing <code>usize as ptr</code> be an option? What if we eventually find some horrible bug in SB that means we have to break half the unsafe code out there in order to get any stronger aliasing model than C has? Would we be <em>allowed</em> to make that change? What are the guarantees we make to users here?</p>



<a name="277220673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277220673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277220673">(Mar 31 2022 at 00:48)</a>:</h4>
<p>To clarify: those examples might seem like straw-mans, but to some extent I think that that is actually sort of the point. When we make guarantees to users, I personally feel that they should cover even the edge cases. If this is not something we want to commit to right now (which I imagine is the case), then it seems like the strongest guarantee we can make for unsafe code is that "the lang team will balance the level of breakage against the benefits of the model and make a decision based on that." I would be perfectly content if this is the case; however, I worry that if people are not aware of this, we might get angry tweets from users complaining about Rust's stability guarantees being fake</p>



<a name="277221121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277221121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277221121">(Mar 31 2022 at 00:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277220411">said</a>:</p>
<blockquote>
<ul>
<li>Code for which there was normative agreement (for each of the various definitions of normative that you like) that it would be sound becoming normatively unsound</li>
</ul>
</blockquote>
<p>An example of this would be deciding that <code>usize</code> is really index-sized rather than pointer sized, as we have an RFC and documentation that says it's pointer-sized. This decision seems to be inconvenient now, though.</p>



<a name="277221530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277221530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277221530">(Mar 31 2022 at 01:03)</a>:</h4>
<p>The whole "what do we do about <code>mem::uninitialized</code>?" conversation probably shows it a bunch.  Be increasingly aggressive about "no, you can't use that any more" over time, while still trying to keep it from breaking too much in old editions.</p>
<p>And of course there are a bunch of things where we'd just say "too bad, you weren't supposed to do that" -- like when struct field reordering happened.</p>
<p>I'm sure it's possible there are some things that would be too far, and we'd just shrug and leave it for whatever the next great language will be.</p>



<a name="277221972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277221972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277221972">(Mar 31 2022 at 01:11)</a>:</h4>
<p>Yeah, the other thing that I'm realizing right now is that if we stabilize the memory model, it may be possible to do so as part of an edition, and declare all code before that edition "potentially unsound, but we'll do our best." Optimizations can probably be edition gated pretty cleanly</p>



<a name="277222042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277222042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277222042">(Mar 31 2022 at 01:12)</a>:</h4>
<p>So the consequences could be reduced to "potentially unsound and slow, but at least it'll probably work most of the time"</p>



<a name="277222105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277222105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277222105">(Mar 31 2022 at 01:13)</a>:</h4>
<p>I think if we could gate optimizations across editions, we could also stop worrying about aliasing at FFI boundaries.</p>



<a name="277222169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277222169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277222169">(Mar 31 2022 at 01:14)</a>:</h4>
<p>We may be able to mitigate the damage, but I'm worried about a partial measure that's good</p>



<a name="277222279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277222279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277222279">(Mar 31 2022 at 01:17)</a>:</h4>
<p>Yes, absolutely, this would be by definition a partial solution. But if the vibe is indeed "balance breakage against benefits" then partial solutions might be exactly what we need</p>



<a name="277224517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277224517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277224517">(Mar 31 2022 at 02:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277221972">said</a>:</p>
<blockquote>
<p>Optimizations can probably be edition gated pretty cleanly</p>
</blockquote>
<p>This gets messy depending where you want to pull the edition info.  Because does a lower-edition binary mean the higher-edition library doesn't get the strict behaviour?  What if there are macros putting code from multiple editions into the same function?</p>
<p>I think this could get messy for the same reason that per-edition type inference can get messy.</p>



<a name="277224971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277224971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277224971">(Mar 31 2022 at 02:11)</a>:</h4>
<p>So I think there are two things that save us here: 1) as I said before, this doesn't have to be perfect. If this is really just in the pursuit of reducing breakage, we can just ignore weird edge cases in a way that would be problematic for type inference</p>



<a name="277225153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277225153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277225153">(Mar 31 2022 at 02:15)</a>:</h4>
<p>2) we can always fix this by turning off more rustc opts. I don't expect LLVM to be affected by this, because I don't expect LLVM to ever adopt a model that we cannot compile the code that we care about to (if they do, we have bigger issues anyway). This means that only rustc opts are affected. Given the nature of mir opts right now, clearly the performance of code optimized only by LLVM is competitive too. Maybe we get a bunch of perf benefits in the future from fancier opts. But if someone comes along and complains that their code is 10% slower and now only as fast as the equivalent C because they linked in some edition 2015 code, i won't be heartbroken</p>



<a name="277226294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277226294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277226294">(Mar 31 2022 at 02:38)</a>:</h4>
<blockquote>
<p>This gets messy depending where you want to pull the edition info. Because does a lower-edition binary mean the higher-edition library doesn't get the strict behaviour? What if there are macros putting code from multiple editions into the same function?</p>
</blockquote>
<p>This gets even messier with inlining and the like. Basically, it is impossible to track the source of some code with optimizations. If it woul be, we could get perfect debuginfo in release builds, and everyone that tried debugging them know we don't.</p>



<a name="277230535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277230535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277230535">(Mar 31 2022 at 03:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="340138">Chayim Refael Friedman</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277226294">said</a>:</p>
<blockquote>
<blockquote>
<p>This gets messy depending where you want to pull the edition info. Because does a lower-edition binary mean the higher-edition library doesn't get the strict behaviour? What if there are macros putting code from multiple editions into the same function?</p>
</blockquote>
<p>This gets even messier with inlining and the like. Basically, it is impossible to track the source of some code with optimizations. If it woul be, we could get perfect debuginfo in release builds, and everyone that tried debugging them know we don't.</p>
</blockquote>
<p>Well, we can just not inline edition bad into edition good code, or at least not inline edition bad code that uses <code>unsafe</code> into edition good code</p>



<a name="277232829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277232829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277232829">(Mar 31 2022 at 04:44)</a>:</h4>
<blockquote>
<p>Well, we can just not inline edition bad into edition good code in rustc</p>
</blockquote>
<p><em>That</em> is going to be a major perf bottleneck.</p>



<a name="277234110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277234110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277234110">(Mar 31 2022 at 05:11)</a>:</h4>
<p>No it's not. The rust inliner is off right now, it'll be no worse</p>



<a name="277234331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277234331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277234331">(Mar 31 2022 at 05:17)</a>:</h4>
<p>No, we would have to outline macro invocations if the macros have another edition. This would be worse than the current no outlining necessary.</p>



<a name="277234384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277234384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277234384">(Mar 31 2022 at 05:18)</a>:</h4>
<p>In addition we may implement stacked borrow enabled optimizations by adding attributes to the llvm ir which means those optimizations are not limited to mir.</p>



<a name="277234403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277234403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277234403">(Mar 31 2022 at 05:19)</a>:</h4>
<p>Yeah, if a poison pill means you get no <code>mutable-noalias</code> anymore, for example, that can have a big impact.</p>



<a name="277234998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277234998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277234998">(Mar 31 2022 at 05:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277234331">said</a>:</p>
<blockquote>
<p>No, we would have to outline macro invocations if the macros have another edition. This would be worse than the current no outlining necessary.</p>
</blockquote>
<p>Or we can just also not do non-llvm opts on those functions</p>



<a name="277235011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235011">(Mar 31 2022 at 05:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277234110">said</a>:</p>
<blockquote>
<p>No it's not. The rust inliner is off right now, it'll be no worse</p>
</blockquote>
<p>And what with the LLVM inliner? As soon as we apply optimizations based on Stacked Borrows (currently only <code>noalias</code>, and even that can break old code).</p>



<a name="277235094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235094">(Mar 31 2022 at 05:34)</a>:</h4>
<p>Hm, ok, I feel like the point here is getting sort of lost. The goal is not to have two internally consistent sound versions of the Rust memory model, one "old" one and one "new" one. The goal is to avoid breakage of old code that was written before the existence of the new memory model. There's no reason to believe that we can't continue to do all the things we do today - if LLVM <code>noalias</code> is something we're ok with emitting today (and doesn't break huge amounts of code) I don't see why that shouldn't continue to be true</p>



<a name="277235271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235271">(Mar 31 2022 at 05:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277235094">said</a>:</p>
<blockquote>
<p>Hm, ok, I feel like the point here is getting sort of lost. The goal is not to have two internally consistent sound versions of the Rust memory model, one "old" one and one "new" one. The goal is to avoid breakage of old code that was written before the existence of the new memory model. There's no reason to believe that we can't continue to do all the things we do today - if LLVM <code>noalias</code> is something we're ok with emitting today (and doesn't break huge amounts of code) I don't see why that shouldn't continue to be true</p>
</blockquote>
<p>LLVM's <code>noalias</code> is indeed not something I'd expect to break most Rust code out there, even code written without Stacked Borrows in mind. However, we may want to apply future LLVM annotations that will be stricter. This is the most effective way to get the most out of SB, and allowing doing something like you propose will disallow it. That means we'll never be able to optimize Rust code for the best performance if it's using crates from older editions.</p>
<p>There's no need to disable inlining: we can just disable the optimizations. But then if you'll have in your crate graph <em>one</em> crate that uses an older edition <em>the whole app</em> will not be best optimizable.</p>



<a name="277235544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235544">(Mar 31 2022 at 05:44)</a>:</h4>
<p>Yeah, I'm entirely unconvinced that it's not possible to do something smarter that avoids breakage. This seems like exactly the kind of problem that has some partial solution which covers 80% of cases</p>



<a name="277235692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235692">(Mar 31 2022 at 05:46)</a>:</h4>
<p>The problem is that when talking about Undefined Behavior, even 1% of the cases might be a nightmare <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="277235732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235732">(Mar 31 2022 at 05:47)</a>:</h4>
<p>Of course it is, but if we're going to take this to the extreme the only solution is to stop writing unsafe Rust immediately</p>



<a name="277235795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235795">(Mar 31 2022 at 05:48)</a>:</h4>
<p>Or to promise now that we'll never adopt an aliasing model stronger than C's</p>



<a name="277235937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235937">(Mar 31 2022 at 05:50)</a>:</h4>
<p>Or maybe disable all strict optimizations for the whole app when using older editions?</p>
<p>This will cause people to update their code, I think <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>



<a name="277235968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235968">(Mar 31 2022 at 05:51)</a>:</h4>
<p>If we decide that introducing an aliasing model which potentially makes existing code UB is not an option, then we can throw SB and friends out now. Now of course that's a reasonable opinion to hold, but if this is not the plan, then "how do we introduce a formal memory model without introducing UB" is not a realistic goal as far as I can see</p>



<a name="277235974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> riking <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235974">(Mar 31 2022 at 05:51)</a>:</h4>
<p>That's significantly more draconian than anyone is going to accept, I think.</p>



<a name="277235985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277235985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277235985">(Mar 31 2022 at 05:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="340138">Chayim Refael Friedman</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277235937">said</a>:</p>
<blockquote>
<p>Or maybe disable all strict optimizations for the whole app when using older editions?</p>
<p>This will cause people to update their code, I think <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>
</blockquote>
<p>Hold on, now I'm confused. Weren't you arguing against this a second ago?</p>



<a name="277236176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277236176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277236176">(Mar 31 2022 at 05:54)</a>:</h4>
<blockquote>
<p>Hold on, now I'm confused. Weren't you arguing against this a second ago?</p>
</blockquote>
<p>I said it will be slow (not "terrible slow", but "as slow as C"), and that trying to scope the hurt is problematic. But if you don't try to scope it and rather apply it to the whole program I think it's fine.</p>



<a name="277236238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277236238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277236238">(Mar 31 2022 at 05:55)</a>:</h4>
<p>oh I see</p>



<a name="277238088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277238088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277238088">(Mar 31 2022 at 06:25)</a>:</h4>
<p>Isn't the promise of the edition system that all editions compile to the same MIR, keeping them compatible? I think that unless there's pre-MIR optimizations going on (which, there could be i guess?) then edition-specific optimization is very limited.</p>



<a name="277238403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277238403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277238403">(Mar 31 2022 at 06:30)</a>:</h4>
<p>I think you could encode this by desugaring old code to different MIR operations than new code, i.e. <code>Write2015(Place, Rvalue)</code> or something</p>



<a name="277238435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277238435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277238435">(Mar 31 2022 at 06:31)</a>:</h4>
<p>they don't have to be date-named like this, they can just be native MIR ops with different specified semantics</p>



<a name="277238636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277238636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277238636">(Mar 31 2022 at 06:34)</a>:</h4>
<p>This can also extend to types, although I think it is harder in this case since you can get implicit transmutes or get confused about which type you are talking about if the types are written the same except for edition info and are interconvertible with no syntax (to avoid breakage)</p>



<a name="277353298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277353298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277353298">(Mar 31 2022 at 23:26)</a>:</h4>
<p>yeah, Stacked Borrows will definitely make some code UB that people wrote thinking it is not UB. OTOH making an aliasing model normative doesn't immediately break anything, it just gives 'license to break' by adding new optimizations. I expect if it turns out that one of those optimizations has surprisingly bad impact, we'll back it out and reassess. ideally the aliasing model is extensively evaluated and validated <em>before</em> it becomes normative, to reduce the chance of such surprises.</p>



<a name="277353764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277353764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277353764">(Mar 31 2022 at 23:32)</a>:</h4>
<p>there is the hypothetical worst-case situation of "this optimization breaks that huge codebase and it's impossible to fix the codebase and also impossible to adjust the model to encompass the codebase" -- not sure if we want to decide what we would do in that case before the situaton arises.<br>
anything else, we have 2 degrees of freedom:</p>
<ul>
<li>we can decide not to use our 'right to optimize' when the optimization benefit turns out to be tiny and the breakage of code that has UB too big. this is not satisfying and we should certainly work on ways to make sure more code is moved into UB-free land and no new code is written that has such UB, but that takes time. the <code>extern "C" fn</code> unwinding story might be an example of this.</li>
<li>if we don't expect code to be able to avoid the UB, we can try to adjust the model so that the code actually becomes 'right'. we'll have to trade-off a clean and concise spec against a spec that models real-world code at that point... such is the life of a non-academic language designer, I guess. ;)</li>
</ul>



<a name="277354174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277354174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277354174">(Mar 31 2022 at 23:39)</a>:</h4>
<p>I'd caution about the first one.</p>



<a name="277370013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370013">(Apr 01 2022 at 04:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="340138">Chayim Refael Friedman</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277235271">said</a>:</p>
<blockquote>
<p>There's no need to disable inlining: we can just disable the optimizations. But then if you'll have in your crate graph <em>one</em> crate that uses an older edition <em>the whole app</em> will not be best optimizable.</p>
</blockquote>
<p>I'm not sure why this is true? Can't we treat non-compliant code as a kind of "FFI" boundary? Surely whatever model we come up with has to expose some semantics when calling code written in arbitrary languages (C, assembly) that doesn't adhere to our model. It seems that we could always treat permissive-Rust as just another foreign language in that case.</p>



<a name="277370090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370090">(Apr 01 2022 at 04:39)</a>:</h4>
<p>After all, in the limit, you could literally expose an <code>extern "C"</code> stable-ABI interface to your old Rust code, compile it using an older version of rustc, and then link it into your final binary. Then all the Rust code that new-rustc sees will be model-compliant.</p>



<a name="277370156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370156">(Apr 01 2022 at 04:41)</a>:</h4>
<p>(If it weren't for the bothersome requirement of creating a stable ABI, this might actually be a reasonable solution for many folks, like us, with lots of old Rust!)</p>



<a name="277370224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370224">(Apr 01 2022 at 04:43)</a>:</h4>
<p>I wouldn't write off specifying an ABI as implausible as a solution.</p>



<a name="277370246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370246">(Apr 01 2022 at 04:43)</a>:</h4>
<p>I mean having to manually write C bindings. If we actually specified an ABI for a sizable subset of Rust code, that could be a pretty reasonable solution too.</p>



<a name="277370292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370292">(Apr 01 2022 at 04:44)</a>:</h4>
<p>Oh yeah I meant more like</p>
<p>effectively defining an implicit<br>
<code>extern "rust-stable"</code></p>



<a name="277370312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370312">(Apr 01 2022 at 04:45)</a>:</h4>
<p>Yeah. Freeze the ABI for old Rust as "what rustc does today"</p>



<a name="277370315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370315">(Apr 01 2022 at 04:45)</a>:</h4>
<p>not to put too fine a point on it, but a lot of people have been wanting "an ABI that is actually more stable than the C one"</p>



<a name="277370319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370319">(Apr 01 2022 at 04:45)</a>:</h4>
<p>Well we'd probably want to wiggle it a bit.</p>



<a name="277370320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370320">(Apr 01 2022 at 04:45)</a>:</h4>
<p>Maybe clean it up a bit before freezing it :)</p>



<a name="277370321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Walton <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370321">(Apr 01 2022 at 04:45)</a>:</h4>
<p>Yeah</p>



<a name="277370327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370327">(Apr 01 2022 at 04:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277370315">said</a>:</p>
<blockquote>
<p>not to put too fine a point on it, but a lot of people have been wanting "an ABI that is actually more stable than the C one"</p>
</blockquote>
<p>because uhhh I don't know if you have seen C ABIs but uhhhh</p>



<a name="277370328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370328">(Apr 01 2022 at 04:45)</a>:</h4>
<p>......................</p>



<a name="277370486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370486">(Apr 01 2022 at 04:48)</a>:</h4>
<p>It is hard to express how bad and how underdefined the System V ABI is, the "standard" ABI everyone except MSVC/Windows uses, and how many times it is actually subtly different in all sorts of ways that break code that seems okay on one arch and one OS but even just moving between OS, even if they "both" "use" "System V", can break it.</p>



<a name="277370597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277370597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277370597">(Apr 01 2022 at 04:51)</a>:</h4>
<p>Some of that is because they didn't really expect what happened next, but it turns out<br>
the years start coming<br>
and they don't stop coming<br>
( fed to the bools and I hit the ground running )</p>



<a name="277371157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277371157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277371157">(Apr 01 2022 at 05:03)</a>:</h4>
<p>and Windows, uh... has... interesting solutions for people messing up the ABIs. like... fixing the stack at runtime. <a href="https://devblogs.microsoft.com/oldnewthing/20040115-00/?p=41043">https://devblogs.microsoft.com/oldnewthing/20040115-00/?p=41043</a></p>



<a name="277371201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277371201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277371201">(Apr 01 2022 at 05:04)</a>:</h4>
<p>Which, I must admit, that one doesn't cause any problems, as it were.</p>



<a name="277371594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277371594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277371594">(Apr 01 2022 at 05:12)</a>:</h4>
<p>but so, one that lets people actually do Rust&lt;-&gt;Rust "FFI" would be actually pretty useful <strong>per se</strong>, as a result. It would allow exposing stable interfaces soundly without requiring those interfaces to be perfectly in accord with the rules of C, which fails to define a lot of things that people would otherwise want to use in FFI, or defines them but not all compilers actually agree on what the definition should be, nor even is there an obvious one we should "favor" in some cases, making it equally challenging.</p>



<a name="277384261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277384261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> riking <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277384261">(Apr 01 2022 at 08:27)</a>:</h4>
<p>C ABIs almost universally fail to define things like a register calling convention for functions that return two machine words.</p>



<a name="277432676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277432676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277432676">(Apr 01 2022 at 15:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277353764">said</a>:</p>
<blockquote>
<p>there is the hypothetical worst-case situation of "this optimization breaks that huge codebase and it's impossible to fix the codebase and also impossible to adjust the model to encompass the codebase" -- not sure if we want to decide what we would do in that case before the situaton arises.<br>
anything else, we have 2 degrees of freedom:</p>
<ul>
<li>we can decide not to use our 'right to optimize' when the optimization benefit turns out to be tiny and the breakage of code that has UB too big. this is not satisfying and we should certainly work on ways to make sure more code is moved into UB-free land and no new code is written that has such UB, but that takes time. the <code>extern "C" fn</code> unwinding story might be an example of this.</li>
<li>if we don't expect code to be able to avoid the UB, we can try to adjust the model so that the code actually becomes 'right'. we'll have to trade-off a clean and concise spec against a spec that models real-world code at that point... such is the life of a non-academic language designer, I guess. ;)</li>
</ul>
</blockquote>
<p>We could also declare the code UB, turn on the optimizations by default and provide a way for them to turn off optimizations (which we already do to some extent).  Like the linux kernel disables some optimizations that break their idioms. For some projects that have tight control over their build process that can be acceptable.</p>



<a name="277433944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277433944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277433944">(Apr 01 2022 at 15:19)</a>:</h4>
<p>I think it would be better to minimize linguistic forks of the <code>-fno-strict-aliasing</code> kind, if we can.</p>



<a name="277438586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277438586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277438586">(Apr 01 2022 at 15:52)</a>:</h4>
<p>If possible, yes. But imo it's still an option.</p>



<a name="277440368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277440368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277440368">(Apr 01 2022 at 16:03)</a>:</h4>
<p>We can't rule it out completely until everything is explored.</p>
<p>But unnecessary linguistic forks are continually making discussions on Zulip heated (esp. in <a class="stream-topic" data-stream-id="136281" href="/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance">#t-lang/wg-unsafe-code-guidelines &gt; Strict provenance</a> ) so <strong>I would really really like to avoid</strong> the topic of unnecessary forks <strong>until someone sees some limitation with backwards compatibility.</strong> </p>
<p>Here I summarize why (I think) we can get all desirable things without breaking compatibility: <a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277358112">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Strict.20provenance/near/277358112</a></p>



<a name="277440580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277440580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bram Geron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277440580">(Apr 01 2022 at 16:04)</a>:</h4>
<p>Again, if there's a reason to break backwards compatibility / create a fork, I'm very interested and let's talk. But until we have any reason to fork, let's not talk about forking and get people worried, because it gets people very very worried</p>



<a name="277440698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277440698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277440698">(Apr 01 2022 at 16:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="264702">riking</span> <a href="#narrow/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code/near/277384261">said</a>:</p>
<blockquote>
<p>C ABIs almost universally fail to define things like a register calling convention for functions that return two machine words.</p>
</blockquote>
<p>That's true, but it's not clear if we'd want to include that in a hypothetical <code>extern "safe"</code> for instance, because it'd be harder to support from other languages that already know the C ABI.</p>



<a name="277440722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277440722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277440722">(Apr 01 2022 at 16:05)</a>:</h4>
<p>That said, it's worth considering.</p>



<a name="277446703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277446703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277446703">(Apr 01 2022 at 16:48)</a>:</h4>
<p>I am not so sure the advantages wouldn't outweigh that for, for example, Rust&lt;-&gt;Swift calls</p>



<a name="277448946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277448946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277448946">(Apr 01 2022 at 17:04)</a>:</h4>
<p>They very well might; the question is how that might impact our adoption rate for this ABI.</p>



<a name="277449005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277449005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277449005">(Apr 01 2022 at 17:05)</a>:</h4>
<p>If we do something that says "use the C ABI, and here are the data structures used to pass various safe things like counted strings", that's easy to interoperate with from many things, including C. In particular, anything that can do C FFI could add support for this with no help from their runtime or compiler, just by having a wrapper library.</p>



<a name="277449078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277449078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277449078">(Apr 01 2022 at 17:05)</a>:</h4>
<p>If we start diverging, such as "use the C ABI, except that you can return up to four values in registers A, B, C, and D", that needs special support from every language/runtime/etc, and that support can't just be a library.</p>



<a name="277458706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277458706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277458706">(Apr 01 2022 at 18:14)</a>:</h4>
<p>You're correct, but if you can't agree on how to return a two-register-big struct from a function then you can't return (for example) a slice from a function. So that seems like a baseline we need to get people to agree on</p>



<a name="277467595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277467595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277467595">(Apr 01 2022 at 19:28)</a>:</h4>
<p>that's true, it seems silly to have to have a pointer to what should be a two-reg struct</p>



<a name="277468417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277468417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277468417">(Apr 01 2022 at 19:37)</a>:</h4>
<p>(honestly, 3 would be <em>way better</em> if we can manage it because in practice a lot of rust stuff is 3-reg)</p>



<a name="277468496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277468496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277468496">(Apr 01 2022 at 19:38)</a>:</h4>
<p>(but just 2-reg would be fine if this was a rarely used ABI just for the occasional foreign call)</p>



<a name="277468561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277468561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277468561">(Apr 01 2022 at 19:39)</a>:</h4>
<p>Strange concept: you could provide ~arbitrary ABI support as a library, if you're willing to take a small performance hit, by just providing a shim to the C ABI</p>



<a name="277468712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277468712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277468712">(Apr 01 2022 at 19:40)</a>:</h4>
<p>Effectively, <code>extern "C" fn call(f: extern "NotC" fn())</code> and a bunch of other versions for whatever function/return combinations are used</p>



<a name="277468861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277468861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277468861">(Apr 01 2022 at 19:42)</a>:</h4>
<p>And if <code>extern "NotC"</code> only differs from <code>extern "C"</code>-compatible ABIs for "small" amounts registers in/out, the space of shims isn't <em>too</em> too large</p>



<a name="277470216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Stability%20guarantees%20of%20%60unsafe%60%20code/near/277470216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Stability.20guarantees.20of.20.60unsafe.60.20code.html#277470216">(Apr 01 2022 at 19:56)</a>:</h4>
<p>right.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>