<html>
<head><meta charset="utf-8"><title>return position impl Trait in dyn Trait · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html">return position impl Trait in dyn Trait</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276539609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276539609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276539609">(Mar 24 2022 at 21:07)</a>:</h4>
<p>just, I don't want to be rude, but on the subject of "making Rust easier to use"<br>
not gonna get there without considering that.<br>
yes I realize I am the point of contact for the project that is literally a module that is an acronym. "vec" was taken. <span aria-label="pensive" class="emoji emoji-1f614" role="img" title="pensive">:pensive:</span></p>



<a name="276539976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276539976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276539976">(Mar 24 2022 at 21:10)</a>:</h4>
<p>"return position <code>impl Trait</code> in <code>dyn Trait</code>" :)</p>



<a name="276541549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276541549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276541549">(Mar 24 2022 at 21:25)</a>:</h4>
<p>... so can we edit the name? I too have just learned what this entire thing is about</p>



<a name="276541552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276541552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276541552">(Mar 24 2022 at 21:25)</a>:</h4>
<p>"in" what exactly</p>



<a name="276541697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276541697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276541697">(Mar 24 2022 at 21:26)</a>:</h4>
<p>ugh I can't move the entire thread history.</p>



<a name="276541769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276541769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276541769">(Mar 24 2022 at 21:27)</a>:</h4>
<p>There, left a pointer. also see:<br>
<a href="#narrow/stream/213817-t-lang/topic/RPITIDT">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/RPITIDT</a></p>



<a name="276545112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276545112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276545112">(Mar 24 2022 at 22:01)</a>:</h4>
<p>I think I managed to move the full history.</p>



<a name="276545312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276545312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jules Bertholet <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276545312">(Mar 24 2022 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait/near/276545112">said</a>:</p>
<blockquote>
<p>I think I managed to move the full history.</p>
</blockquote>
<p>Not quite, no <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379870">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379870</a></p>



<a name="276545536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276545536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276545536">(Mar 24 2022 at 22:05)</a>:</h4>
<p><span class="user-mention" data-user-id="421518">@Jules Bertholet</span> How about now?</p>



<a name="276557301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276557301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276557301">(Mar 25 2022 at 00:27)</a>:</h4>
<p>nice.</p>



<a name="276667776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276667776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276667776">(Mar 25 2022 at 19:28)</a>:</h4>
<p>By the way, another alternative but which would be orthogonal to the <code>async fn</code> specific case (you'll see why), would be to fully embrace the Continuation-Passing-Style / callback-style / <code>with</code>-scopes styles that <a href="https://docs.rs/with_locals">https://docs.rs/with_locals</a> is a prototype of.</p>
<p>Basically the gist would be that, when you have:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Display</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>you could also or instead define:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// dyn-safe!</span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="k">fn</span> <span class="nf">method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">fn</span> <span class="nc">dyn</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">method</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this would basically stand for:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// dyn-safe!</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">with_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">return_</span>: <span class="kp">&amp;</span><span class="nc">own</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">scope</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;'</span><span class="na">scope</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Display</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">return_</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">method</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>
<p>where <code>&amp;own</code> is the syntax for "owning references", whereby borrowing the backing storage for the value (since it will often be borrowing local/stack storage), and yet offering owned access to the pointee, thence acting as an owning pointer much like <code>Box</code>, with move semantics (it's just that the whole pointer would be lifetime-bounded by the lifetime of that borrow(-of-backing-storage), much like <code>Box&lt;dyn Something + 'lt&gt;</code> is an owned and yet non-<code>'static</code> pointer).<br>
It's basically the unsugared and with explicit semantics (with all the advantages that come from that) version of the <code>unsized_fn_params</code> feature.</p>
</li>
<li>
<p>the callback isn't generic in the return type to be <code>dyn</code>-friendly, but this could be an implementation detail. It's easy to see how one could use the state capture by the closure to smuggle any kind of return value out of it, and thus nonetheless offer a <code>&lt;R&gt; … -&gt; R</code> generic continuation.</p>
</li>
</ul>
<p>At that point the required language feature would be to make calls of such APIs more ergonomic. That is, rather than having to write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">xs</span>: <span class="p">[</span><span class="o">&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">with_method</span><span class="p">(</span><span class="o">&amp;</span><span class="n">own</span><span class="w"> </span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">with_method</span><span class="p">(</span><span class="o">&amp;</span><span class="n">own</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">with_method</span><span class="p">(</span><span class="o">&amp;</span><span class="n">own</span><span class="w"> </span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="err">…</span><span class="w"></span>
<span class="w">            </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="p">})</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>we'd be able to instead write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">xs</span>: <span class="p">[</span><span class="o">&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">method</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">method</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">method</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>with the restriction that <code>with</code> binding would be lifetime-bound (the <code>'fn</code> lifetime above) to the very scope where they occur, similar to the output of the <code>::core::pin::pin!</code> macro. For those needing longer-lived values, that's when they'd be able to opt-into boxing.</p>
<p>The other restriction, the one that is saddening but I don't really see a way around it, is that since, AFAIK, there is no way to feature non-generic <code>async</code> continuations (that borrow their inputs) without <code>Box</code>ing, is that we'd still be back to boxing should we need to <code>.await</code> within a <code>with</code> scope.</p>
<p>That's why I think <code>async fn</code> would still be better served using the <code>VirtualPtr</code> —this is what you people have been confusingly naming <code>dynx</code>, even though it features indirection <em>w.r.t.</em> <code>dyn</code>— approach with <code>Box</code>es; but at least for simple cases such as a <code>trait</code> with an arbitrary <code>-&gt; impl Trait</code> return type, my suggestion offers a nice way to be:</p>
<ul>
<li><code>dyn</code>-friendly</li>
<li>without heap / <code>Box</code> allocations</li>
<li>without low-level <code>alloca</code> shenanigans.</li>
</ul>



<a name="276695054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/return%20position%20impl%20Trait%20in%20dyn%20Trait/near/276695054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jules Bertholet <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait.html#276695054">(Mar 26 2022 at 00:30)</a>:</h4>
<p>On the subject of <code>dyn</code> adapters:  could the <a href="https://internals.rust-lang.org/t/is-custom-allocators-the-right-abstraction/13460"><code>Storage</code> trait proposal</a> be relevant? Maybe you could have just one adapter type, parameterized by storage?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>