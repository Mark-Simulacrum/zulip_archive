<html>
<head><meta charset="utf-8"><title>`#[non_exhaustive] struct Foo;`? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html">`#[non_exhaustive] struct Foo;`?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258418167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258418167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258418167">(Oct 20 2021 at 18:23)</a>:</h4>
<p>I noticed today that there's <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=dc00152baa4fa43c530bcf625ed3897c">no warning</a> for </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Should there be?  It feels weird to use unit struct syntax but say "but there might be more later".  And I'm not actually sure what that implies for the visibility of the <code>const</code> that syntax generates.  Can people still use it?</p>



<a name="258435080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258435080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258435080">(Oct 20 2021 at 20:05)</a>:</h4>
<p>The <code>const</code> it generates becomes private.</p>



<a name="258437049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258437049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258437049">(Oct 20 2021 at 20:18)</a>:</h4>
<p>Filed <a href="https://github.com/rust-lang/reference/issues/1097">https://github.com/rust-lang/reference/issues/1097</a> to clarify the documentation around that.</p>



<a name="258441033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258441033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258441033">(Oct 20 2021 at 20:44)</a>:</h4>
<p>Interesting! So that makes the type public but the value of that type private?</p>



<a name="258441794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258441794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258441794">(Oct 20 2021 at 20:49)</a>:</h4>
<p>Yea, lowered to <code>pub(crate)</code>.  It's the same with tuple constructors.</p>



<a name="258461103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258461103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258461103">(Oct 20 2021 at 23:33)</a>:</h4>
<p>i've definitely used <code>#[non_exhaustive] pub struct Foo;</code> as a better version of <code>pub struct Foo { _priv: () }</code></p>



<a name="258461154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258461154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258461154">(Oct 20 2021 at 23:33)</a>:</h4>
<p>Why not <code>#[non_exhaustive] pub struct Foo {}</code>?</p>



<a name="258462115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258462115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258462115">(Oct 20 2021 at 23:44)</a>:</h4>
<p>just because i don't need the <code>{}</code></p>



<a name="258462136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258462136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258462136">(Oct 20 2021 at 23:45)</a>:</h4>
<p>e.g. it still works as <code>pub struct Foo;</code></p>



<a name="258463300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258463300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258463300">(Oct 20 2021 at 23:56)</a>:</h4>
<p>Oh so you are using <code>#[non_exhaustive]</code> to mean the type shouldn't be constructed by the user, but you actually don't intend to add any field in the future?</p>



<a name="258463330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258463330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258463330">(Oct 20 2021 at 23:57)</a>:</h4>
<p>That sounds like abusing <code>#[non_exhaustive]</code> ;)</p>



<a name="258836442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258836442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258836442">(Oct 23 2021 at 18:25)</a>:</h4>
<p><strong><code>pub struct Foo(());</code> crying in a corner</strong></p>



<a name="258841831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258841831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258841831">(Oct 23 2021 at 20:45)</a>:</h4>
<p>Often they're error types for TryFrom/FromStr/etc cases. In principal I could add more stuff to them, but for the most part it's unlikely.</p>



<a name="258841875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/258841875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#258841875">(Oct 23 2021 at 20:46)</a>:</h4>
<p>I don't think its really abusing non_exhaustive though.</p>



<a name="260394793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260394793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260394793">(Nov 05 2021 at 11:46)</a>:</h4>
<p>Btw this is even used by the stdlib: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// An error returned when parsing a `bool` using [`from_str`] fails</span>
<span class="sd">///</span>
<span class="sd">/// [`from_str`]: super::FromStr::from_str</span>
<span class="cp">#[derive(Debug, Clone, PartialEq, Eq)]</span><span class="w"></span>
<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="cp">#[stable(feature = </span><span class="s">"rust1"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParseBoolError</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p><a href="https://doc.rust-lang.org/std/str/struct.ParseBoolError.html">https://doc.rust-lang.org/std/str/struct.ParseBoolError.html</a></p>



<a name="260467365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260467365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260467365">(Nov 05 2021 at 21:32)</a>:</h4>
<p>Yeah, I consider this usage to be idiomatic, and have filed a previous PR to that effect.</p>



<a name="260474180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260474180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260474180">(Nov 05 2021 at 22:53)</a>:</h4>
<p>I guess I would have written that as <code>#[non_exhaustive] pub struct ParseBoolError {}</code>, but I suppose it's reasonable with the <code>;</code> too.</p>



<a name="260482328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260482328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260482328">(Nov 06 2021 at 01:05)</a>:</h4>
<p>My assumption is that it doesn't make a difference? I've never actually checked</p>



<a name="260485843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260485843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260485843">(Nov 06 2021 at 02:11)</a>:</h4>
<p>makes a difference in how you construct it. the construction has to include the braces (or not) depending on if the declaration does.</p>



<a name="260518489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260518489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260518489">(Nov 06 2021 at 15:03)</a>:</h4>
<p>Sure, I meant externally though</p>



<a name="260659179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60%23%5Bnon_exhaustive%5D%20struct%20Foo%3B%60%3F/near/260659179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60.23.5Bnon_exhaustive.5D.20struct.20Foo.3B.60.3F.html#260659179">(Nov 08 2021 at 13:54)</a>:</h4>
<p>To me the semantics of <code>#[non_exhaustive] struct Foo;</code> are quite ambiguous; it could mean:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Foo</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
</code></pre></div>
<ul>
<li>as the RFC author seemed to interpret it;</li>
</ul>
<p>but it would also be perfectly valid for it to mean:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Foo</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
</code></pre></div>
<p>And the latter is actually, if not more, at least as consistent as the RFC's author choice, since the original rationale behind <code>#[non_exhaustive]</code>'s design —as the name indicates—, is <strong>to consider a lack of non-<code>pub</code> fields to be <code>pub(crate)</code></strong>.</p>
<p>And <strong>having an eponymous <code>const</code> is an orthogonal question to that of field visibility!</strong></p>
<ul>
<li>So <code>Foo {}</code> or any kind of <code>Foo {}</code>-based mechanic would be forbidden, but the <code>Foo</code> const would still be available.</li>
</ul>
<p>That is, it would allow for the following kind of non-semver-breaking addition:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="o">?</span><span class="w"> </span><span class="n">a_field</span>: <span class="err">…</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Foo</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a_field</span>: <span class="o">&lt;</span><span class="n">have</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="k">const</span><span class="err">`</span><span class="o">-</span><span class="n">compatible</span><span class="w"> </span><span class="n">initializer</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>Granted, having to future-anticipate that we'd remain <code>const</code>-constructible can be quite challenging, which I guess is the main reason to end up entangling the eponymous const question with that of field visibility, but I find it to be a code smell in either case. I'll definitely make these be linted with my own custom pass, to be sure.</p>
<p>Another way of seeing the <code>non_exhaustive</code> unit case as alien, is with an imaginary <code>pub(crate) ∅</code> syntax that would represent the desired / intuitive semantics of <code>#[non_exhaustive]</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// means</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="err">∅</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="c1">// &lt;- usable with braced syntax</span>

<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="n">A</span><span class="p">);</span><span class="w"></span>
<span class="c1">// means</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="err">∅</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;- Usable with parens</span>

<span class="cp">#[non_exhaustive]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
<span class="c1">// where to put the `pub(crate) ∅` ??</span>
</code></pre></div>
<p>That is, how can we say that some enumeration/sequence of elements is non-exhaustive when there is no enumeration to begin with?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>