<html>
<head><meta charset="utf-8"><title>size_of never type? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html">size_of never type?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="245624420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245624420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245624420">(Jul 11 2021 at 20:14)</a>:</h4>
<p>Is it weird that <code>size_of::&lt;!&gt;()</code> is 0? It just occurs to me that size_of normally can't be called on types that aren't Sized, and I think(?) that <code>!</code> isn't Sized, and yet as the bottom type I'm not sure if it makes sense to exclude it from anything? I can't think of any concrete risk, I'm just being wary.</p>



<a name="245624566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245624566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245624566">(Jul 11 2021 at 20:18)</a>:</h4>
<p><code>!: Sized</code> is satisfied.</p>



<a name="245624581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245624581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245624581">(Jul 11 2021 at 20:19)</a>:</h4>
<p>An empty type can even have a non-zero size I think. Eg <code>struct Foo([u8; 16], !)</code> is 16 bytes I think.</p>



<a name="245624859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245624859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245624859">(Jul 11 2021 at 20:26)</a>:</h4>
<p>Ah, good point. Is <code>!: Sized</code> because it actually implements Sized, or is it because as the bottom type it implicitly satisfies everything? I don't see the usual blanket impls that I would expect on Sized types, e.g. the docs don't show the <code>impl&lt;T: ?Sized&gt; Borrow&lt;T&gt; for T</code>. But I guess I also don't understand why <code>!</code> has to have explicit implementations for <code>Clone</code>, <code>Display</code>, etc</p>



<a name="245625441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625441">(Jul 11 2021 at 20:40)</a>:</h4>
<p>Sized is an auto trait, so <code>!</code> doesn't need to explicitly implement it.</p>



<a name="245625448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625448">(Jul 11 2021 at 20:41)</a>:</h4>
<p>There were proposals to make size_of::&lt;!&gt; a negative infinity, represented in whatever way, at some point.</p>



<a name="245625504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625504">(Jul 11 2021 at 20:42)</a>:</h4>
<p>that'd be a good april fools day RFC, change size_of to return a float :)</p>



<a name="245625569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625569">(Jul 11 2021 at 20:44)</a>:</h4>
<p>the thing is, whether ! is Sized or not doesn't really matter all that much</p>



<a name="245625595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625595">(Jul 11 2021 at 20:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/245625441">said</a>:</p>
<blockquote>
<p>Sized is an auto trait, so <code>!</code> doesn't need to explicitly implement it.</p>
</blockquote>
<p>I think it's something even more magical than an auto trait, Unpin is defined as <code>pub auto trait Unpin</code> but Sized is just <code>pub trait Sized</code></p>



<a name="245625619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625619">(Jul 11 2021 at 20:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/245625569">said</a>:</p>
<blockquote>
<p>the thing is, whether ! is Sized or not doesn't really matter all that much</p>
</blockquote>
<p>Wouldn't it matter for things like <code>Result&lt;u32, !&gt;</code>? If it wasn't sized the enum here wouldn't be sized either which means you couldn't pass it by value right?</p>



<a name="245625670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625670">(Jul 11 2021 at 20:46)</a>:</h4>
<p><code>!</code> works on a different layer than sizes: an uninhabited type can have a size but all bit patterns of that size are invalid for that type.</p>



<a name="245625677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625677">(Jul 11 2021 at 20:46)</a>:</h4>
<p>On one hand yeah, on the other you could argue that since the variants with <code>!</code> aren't constructible, they shouldn't be considered for the purposes of determining the containers' sizedness.</p>



<a name="245625692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625692">(Jul 11 2021 at 20:47)</a>:</h4>
<p><span class="user-mention" data-user-id="300586">@Lukas Wirth</span> Enums with unsized fields aren't even allowed at all.</p>



<a name="245625693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625693">(Jul 11 2021 at 20:47)</a>:</h4>
<p>but all things considered <code>!: Sized</code> makes things overall significantly less hacky, probably?</p>



<a name="245625742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625742">(Jul 11 2021 at 20:48)</a>:</h4>
<p><code>!</code>  should be as unsurprising as possible: it should be identical to <code>()</code> in every way except that it has no valid values instead of just one.</p>



<a name="245625751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245625751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245625751">(Jul 11 2021 at 20:48)</a>:</h4>
<p>So <code>!</code> would be <code>Sized</code> and <code>Copy</code>, and it wouldn't matter since you'd never get around to creating a value to copy.</p>



<a name="245629847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245629847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245629847">(Jul 11 2021 at 22:12)</a>:</h4>
<p><code>MaybeUninit&lt;!&gt;</code> exists and has size 0 (It can store a single value, <code>MaybeUninit::uninit()</code>, though you could argue that <code>MaybeUnini::zeroed()</code> is distinct). Because <code>MaybeUninit&lt;T&gt;</code> has the same size and alignment as <code>T</code>, then <code>!</code> must also have size 0.</p>



<a name="245646157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245646157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245646157">(Jul 12 2021 at 05:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/245624581">said</a>:</p>
<blockquote>
<p>An empty type can even have a non-zero size I think. Eg <code>struct Foo([u8; 16], !)</code> is 16 bytes I think.</p>
</blockquote>
<p>See also <a href="https://github.com/rust-lang/rust/issues/54987">https://github.com/rust-lang/rust/issues/54987</a> for why it really needs to be nonzero size. The <code>!</code> type really needs to be a regular ZST, not a magic negative infinity size type that ZSTs anything it is tupled with, because of partial initialization. It's not a slam dunk argument because this is not allowed today and I don't know whether it will become safe in the future:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="o">!</span><span class="p">);</span><span class="w"></span>
<span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">];</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>But especially for generic code, one really would like this to work:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(never_type)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">addr_of_mut</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">x</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">()).</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="n">write</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">])</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;!&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="245720271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/245720271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremiah Senkpiel <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#245720271">(Jul 12 2021 at 17:37)</a>:</h4>
<p>It seems reasonable enough to me (a bystander) that something which can't be represented in actuality has a size of 0.</p>



<a name="264104953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264104953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264104953">(Dec 08 2021 at 02:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/245646157">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/245624581">said</a>:</p>
<blockquote>
<p>An empty type can even have a non-zero size I think. Eg <code>struct Foo([u8; 16], !)</code> is 16 bytes I think.</p>
</blockquote>
<p>See also <a href="https://github.com/rust-lang/rust/issues/54987">https://github.com/rust-lang/rust/issues/54987</a> for why it really needs to be nonzero size. The <code>!</code> type really needs to be a regular ZST, not a magic negative infinity size type that ZSTs anything it is tupled with, because of partial initialization. It's not a slam dunk argument because this is not allowed today and I don't know whether it will become safe in the future:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="o">!</span><span class="p">);</span><span class="w"></span>
<span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">];</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>But especially for generic code, one really would like this to work:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(never_type)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>::<span class="n">uninit</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">addr_of_mut</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">x</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">()).</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="n">write</span><span class="p">([</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">])</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;!&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Allowing these kinds of shenanigans seems incredibly dangerous. For example, I might be tempted to then add this snipped to the end of your function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// cool, `x` is completely initalized</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="264104965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264104965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264104965">(Dec 08 2021 at 02:51)</a>:</h4>
<p>(is necro-posting frowned upon? Apologies if so)</p>



<a name="264105130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264105130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264105130">(Dec 08 2021 at 02:54)</a>:</h4>
<p>Although this isn't really restricted to that example, <code>size_of::&lt;!&gt;()</code> returning <code>0</code> means that</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">().</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>might be UB, which is sort of an issue on its own</p>



<a name="264105205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264105205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264105205">(Dec 08 2021 at 02:55)</a>:</h4>
<p>Right, and that's been the case on stable for a long time.</p>
<p>And even for inhabited ZSTs where it's <em>valid</em> to summon them from nothing, it can still be a violation of a <em>safety</em> invariant.</p>



<a name="264105218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264105218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264105218">(Dec 08 2021 at 02:55)</a>:</h4>
<p>Fair</p>



<a name="264105393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264105393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264105393">(Dec 08 2021 at 02:58)</a>:</h4>
<p>That being said, I would like to argue that <code>Foo</code> in the example should actually be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">MayebUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>in which case we wouldnt have an issue here</p>



<a name="264105422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264105422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264105422">(Dec 08 2021 at 02:59)</a>:</h4>
<p>There's even some monomorphization-time checks to help catch the uninhabited-ZST mistake: <a href="https://rust.godbolt.org/z/zxqPczb7r">https://rust.godbolt.org/z/zxqPczb7r</a></p>



<a name="264105568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264105568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264105568">(Dec 08 2021 at 03:00)</a>:</h4>
<p>If the safe version of things is desirable then I suppose this might be necessary, although partially initalizing a completely uninhabited value sounds like a very weird semantic to me</p>



<a name="264107515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264107515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264107515">(Dec 08 2021 at 03:31)</a>:</h4>
<p>Yeah, this is probably already stable through <code>MaybeUninit</code></p>



<a name="264107655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264107655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264107655">(Dec 08 2021 at 03:33)</a>:</h4>
<div class="codehilite"><pre><span></span><code>type DefinitelyUninit = MaybeUninit&lt;!&gt;;
</code></pre></div>



<a name="264142357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264142357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264142357">(Dec 08 2021 at 11:29)</a>:</h4>
<p>Could there be a new <code>size_of</code> function, say, <code>size_of_inhabited</code> which would return an <code>Option&lt;usize&gt;</code> (or <code>enum Size { Inhabited(usize), Uninhabited }</code> or w/e). Since obviously we can't change <code>size_of</code>, but having a way to know if a type is inhabited or not could be desirable (<em>e.g.</em>, a way to stabilize <code>intrinsics::assert_inhabited</code> of sorts):</p>
<p>right now in non-<code>const</code> context one could do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">size_of_inhabited</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">  </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">size</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">forget</span><span class="p">(</span><span class="n">panic</span>::<span class="n">catch_unwind</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>::<span class="n">uninit</span><span class="p">().</span><span class="n">assume_init</span><span class="p">()).</span><span class="n">ok</span><span class="p">()</span><span class="o">?</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="264142359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264142359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264142359">(Dec 08 2021 at 11:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264105393">said</a>:</p>
<blockquote>
<p>That being said, I would like to argue that <code>Foo</code> in the example should actually be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">MayebUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>in which case we wouldnt have an issue here</p>
</blockquote>
<p>I believe that <code>MaybeUninit</code> not being structural (transitive with field {un,}projection) is deemed too big of a footgun to ever feature it, no matter how much it would simplify things elsewhere (IIRC, for instance, it's also the reason <code>&amp;!</code> can't/shouldn't be uninhabited).</p>



<a name="264163432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264163432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264163432">(Dec 08 2021 at 14:37)</a>:</h4>
<p>Interesting discussion.. I never knew that e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Void</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>produces a size of <code>8</code> (so two times size of <code>u32</code>)! (I would’ve liked/expected to get <code>0</code> size instead, like for <code>Result&lt;(), Void&gt;</code>) <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> would your opinion be that it <em>has</em> to stay this way? Or are you only concerned with structs, not with enums?</p>



<a name="264163627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264163627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264163627">(Dec 08 2021 at 14:38)</a>:</h4>
<p>In addition/instead of <code>size_of_inhabited</code> we could expose a function that would say if the type is inhabited or not:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"rust-intrinsic"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_inhabited</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>With this <code>assert_inhabited</code> and <code>size_of_inhabited</code> could be implemented in libs without hacks</p>



<a name="264164152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264164152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264164152">(Dec 08 2021 at 14:42)</a>:</h4>
<p>I'm actually regurgitating some opinions of <span class="user-mention" data-user-id="120791">@RalfJ</span> here, so they might have more to say on the matter, but I can definitely see that it's difficult to argue for the soundness of a partially initialized value which has non-ZST data in it even though it somehow takes up zero space on stack. In the case of an enum, I think it is conceivable to insist that the <code>Err</code> variant in that example is not constructible, although it has some unusual consequences: If <code>Result&lt;(), (u32, Void)&gt;</code> has zero size but <code>(u32, Void)</code> has size 4, then what is the relative address of the pointer into the <code>Err</code> variant?</p>



<a name="264164648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264164648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264164648">(Dec 08 2021 at 14:46)</a>:</h4>
<p>I agree with <span class="user-mention" data-user-id="273349">@Waffle Lapkin</span> that it would make more sense to have a separate <code>is_inhabited</code> function here, rather than mixing it with <code>size_of</code>, because (especially with that <code>Result&lt;(), (u32, Void)&gt;</code> layout optimization) we want to be able to say that <code>(u32, Void)</code> is an uninhabited type with size 4</p>



<a name="264164763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264164763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264164763">(Dec 08 2021 at 14:47)</a>:</h4>
<blockquote>
<p>If <code>Result&lt;(), (u32, Void)&gt;</code> has zero size but <code>(u32, Void)</code> has size 4, then what is the relative address of the pointer into the <code>Err</code> variant?</p>
</blockquote>
<p>Is there a sound way to obtain this relative address of the <code>Err</code>’s field (for an enum, not a struct)? If not, maybe this question doesn’t even need an answer?</p>



<a name="264164943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264164943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264164943">(Dec 08 2021 at 14:48)</a>:</h4>
<p>At the very least, I think the UCG layout document needs some rewriting, since I recall there being some picture where an enum's variant fields were contained in the enum's data layout</p>



<a name="264165041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264165041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264165041">(Dec 08 2021 at 14:49)</a>:</h4>
<p>But I don't see any immediate problems with such a design</p>



<a name="264165343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264165343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264165343">(Dec 08 2021 at 14:51)</a>:</h4>
<p>it potentially conflicts with a layout API that allows you to ask questions like "what is the offset of this field on this enum" directly</p>



<a name="264168311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264168311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264168311">(Dec 08 2021 at 15:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264164648">said</a>:</p>
<blockquote>
<p>I agree with <span class="user-mention silent" data-user-id="273349">Waffle Lapkin</span> that it would make more sense to have a separate <code>is_inhabited</code> function here, rather than mixing it with <code>size_of</code>, because (especially with that <code>Result&lt;(), (u32, Void)&gt;</code> layout optimization) we want to be able to say that <code>(u32, Void)</code> is an uninhabited type with size 4</p>
</blockquote>
<p>Yep, my bad there, I totally fell into the trap of thinking uninhabited =&gt; ZST <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span> A separate <code>bool</code> makes most sense</p>



<a name="264170637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264170637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264170637">(Dec 08 2021 at 15:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jake</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264105130">said</a>:</p>
<blockquote>
<p>Although this isn't really restricted to that example, <code>size_of::&lt;!&gt;()</code> returning <code>0</code> means that</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">().</span><span class="n">assume_init</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>might be UB, which is sort of an issue on its own</p>
</blockquote>
<p>its not an issue, it is perfectly expected IMO. why would all ZST be inhabited?</p>



<a name="264170774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264170774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264170774">(Dec 08 2021 at 15:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264105422">said</a>:</p>
<blockquote>
<p>There's even some monomorphization-time checks to help catch the uninhabited-ZST mistake: <a href="https://rust.godbolt.org/z/zxqPczb7r">https://rust.godbolt.org/z/zxqPczb7r</a></p>
</blockquote>
<p>btw I recently wondered if we should do something similar for <code>transmute</code>? we could adjust its codegen so that if the target type is uninhabited, it panics instead of causing UB</p>



<a name="264171234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264171234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264171234">(Dec 08 2021 at 15:28)</a>:</h4>
<blockquote>
<p>right now in non-const context one could do:</p>
</blockquote>
<p>oh god please don't do that.^^ there is no <em>guarantee</em> that <code>assume_init</code> will ever panic. this code is causing library UB and if someone seriously proposes this I will regret ever having added those panics.</p>



<a name="264171388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264171388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264171388">(Dec 08 2021 at 15:29)</a>:</h4>
<p>there is extremely little one can do with a type just because it is inhabited (as was noted above, it can still have arbitrary <em>safety</em> invariants), so I dont think I understand the motivation for having such a test on a type.</p>



<a name="264171695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264171695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264171695">(Dec 08 2021 at 15:30)</a>:</h4>
<p>while knowing that a type is inhabited doesn't say much, being <em>un</em>inhabited is useful information, especially if it comes up in layout calculations. User code might want to interact with that</p>



<a name="264171966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264171966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264171966">(Dec 08 2021 at 15:32)</a>:</h4>
<blockquote>
<p>I believe that MaybeUninit not being structural (transitive with field {un,}projection) is deemed too big of a footgun to ever feature it, no matter how much it would simplify things elsewhere (IIRC, for instance, it's also the reason &amp;! can't/shouldn't be uninhabited).</p>
</blockquote>
<p>I don't quite follow; actually my current working draft of reference validity does make <code>&amp;!</code> uninhabited. (I think of this as <code>!</code> having an impossible-to-satisfy alignment requirement, so <code>&amp;!</code> can never be properly aligned, and so it is uninhabited. the key point is that validity of <code>&amp;T</code> never depends on the bytes stored in memory, it only depends on the pointer value and on <code>T</code>'s alignment.)</p>



<a name="264172006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264172006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264172006">(Dec 08 2021 at 15:32)</a>:</h4>
<p>I was actually thinking that "inhabited" isn't a great word for this concept since it doesn't match the meaning of "inhabited" from type theory. It's closer to "possibly not uninhabited"</p>



<a name="264172075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264172075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264172075">(Dec 08 2021 at 15:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264171695">said</a>:</p>
<blockquote>
<p>while knowing that a type is inhabited doesn't say much, being <em>un</em>inhabited is useful information, especially if it comes up in layout calculations. User code might want to interact with that</p>
</blockquote>
<p>it would probably be wrong most of the time though, since people would just repeat the mistake of making <code>(i32, !)</code> a ZST since it has an uninhabited field...</p>



<a name="264172119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264172119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264172119">(Dec 08 2021 at 15:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264172006">said</a>:</p>
<blockquote>
<p>I was actually thinking that "inhabited" isn't a great word for this concept since it doesn't match the meaning of "inhabited" from type theory. It's closer to "possibly not uninhabited"</p>
</blockquote>
<p>well, we have two invariants and thus two notions of inhabited: 'validly inhabited' and 'safely inhabited'</p>



<a name="264172382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264172382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264172382">(Dec 08 2021 at 15:34)</a>:</h4>
<p>I suppose that we could conceivably define "validly inhabited" such that it is a decidable property, but really only one direction is relevant: if it is not inhabited according to rust then it definitely can't be instantiated, but the converse may not hold</p>



<a name="264173262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264173262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264173262">(Dec 08 2021 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/213817-t-lang/topic/size_of.20never.20type.3F/near/264172075">said</a>:</p>
<blockquote>
<p>it would probably be wrong most of the time though, since people would just repeat the mistake of making <code>(i32, !)</code> a ZST since it has an uninhabited field...</p>
</blockquote>
<p>Why is this a mistake? I think I've missed something <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="264174465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264174465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264174465">(Dec 08 2021 at 15:47)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/49298">#49298</a> I guess</p>



<a name="264176279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/size_of%20never%20type%3F/near/264176279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/size_of.20never.20type.3F.html#264176279">(Dec 08 2021 at 15:58)</a>:</h4>
<p>Oh</p>
<p>Thanks!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>