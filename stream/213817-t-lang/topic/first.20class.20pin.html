<html>
<head><meta charset="utf-8"><title>first class pin · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html">first class pin</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257592980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257592980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257592980">(Oct 14 2021 at 19:38)</a>:</h4>
<p>I have mostly just been lurking here since the yield closures MCP, but I had an idea for pin-stuff that wold be interesting to run by people.</p>



<a name="257593089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593089">(Oct 14 2021 at 19:39)</a>:</h4>
<p>I was mostly just wondering how FnPin could be used by ordinary closures in addition to yield closures and fell down a pin-projection rabbithole</p>



<a name="257593237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593237">(Oct 14 2021 at 19:40)</a>:</h4>
<p>I'm not sure what proposals have been made in this direction, but it seems like it should be possible to have first-class pin projection and self-referential structs in the language with sorta minor additions</p>



<a name="257593256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593256">(Oct 14 2021 at 19:40)</a>:</h4>
<p>Random info-dump here: <a href="https://gist.github.com/samsartor/cc848e4d10a2dfb2228236a7f1654d4c">https://gist.github.com/samsartor/cc848e4d10a2dfb2228236a7f1654d4c</a></p>



<a name="257593598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593598">(Oct 14 2021 at 19:43)</a>:</h4>
<p>Rust-for-linux project would really appreciate first class pinning</p>



<a name="257593608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593608">(Oct 14 2021 at 19:43)</a>:</h4>
<p>TL;DR you could have a perma/long-term-unstable &amp;pin reference type similar to Pin&lt;&amp;mut T&gt; which would handle projection, and then use traits/auto-ref to allow users to interact with it</p>



<a name="257593747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593747">(Oct 14 2021 at 19:44)</a>:</h4>
<p>We especially need ways to create pinned struct from the beginning, rather than creating it first and then pin it.</p>



<a name="257593835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593835">(Oct 14 2021 at 19:45)</a>:</h4>
<p>I have an experiment with macros here <a href="http://docs.rs/pin-init/">docs.rs/pin-init/</a>, but needing macros for each construction isn't very ergonomic</p>



<a name="257593868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257593868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257593868">(Oct 14 2021 at 19:45)</a>:</h4>
<p>Hmmm, I haven't been thinking in that direction yet. Actually I was trying to make it so the struct could exist as long as needed with placeholder values before being pinned and initialized fully.</p>



<a name="257596337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257596337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257596337">(Oct 14 2021 at 20:02)</a>:</h4>
<p>Looking at <code>pin-init</code>, I think we'd need something more than just this proposal to make it ergonomic. The problem is all the <code>MaybeUinit</code> types everywhere which should be guaranteed to get initialized after pinning, right? With how I am picturing things now, you'd still have to juggle them manually.</p>



<a name="257606135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257606135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257606135">(Oct 14 2021 at 21:08)</a>:</h4>
<p>I'm really struggling with any sort of idea which ties pinned-ness to initialized-ness. Such a requirement can't be imposed on <code>Pin</code> in retrospect, because functions like <code>Box::pin</code> can never be required to call initialization traits. And if &amp;pin adds that requirement alone, it breaks compatibility with <code>Pin</code> Then instead of &amp;pin being "taking the sharp corners off of Pin transparently",  it would become "the alternate version of Pin we should have made in the first place". Which I think is kinda unacceptable.</p>



<a name="257606326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257606326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257606326">(Oct 14 2021 at 21:09)</a>:</h4>
<p>I think that means any feature for guaranteeing deep initialization must be orthogonal to guaranteeing fixed allocation.</p>



<a name="257606671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257606671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257606671">(Oct 14 2021 at 21:11)</a>:</h4>
<p>&amp;out?</p>



<a name="257623224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257623224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257623224">(Oct 14 2021 at 23:36)</a>:</h4>
<p>Just realized the pin-init on <a href="http://docs.rs">docs.rs</a> is still 0.1 since I forgot to publish 0.2 <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="257735952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257735952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257735952">(Oct 15 2021 at 17:37)</a>:</h4>
<p>Thinking about this some more, I could be ok to require an explicit conversion from <code>Pin&lt;&amp;mut T&gt;</code> to <code>&amp;pin T</code>, which would perform initialization. And I like the nice symmetry of pinned types knowing both when they enter and leave their fixed allocation. We'd just have to consider the tradeoffs of migrating from <code>Pin</code> to <code>&amp;pin</code> vs trying to make them fully interchangeable.</p>



<a name="257736246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/257736246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#257736246">(Oct 15 2021 at 17:39)</a>:</h4>
<p>Really I am fishing for someone to mentor an initiative of some kind lol</p>



<a name="258230856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258230856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258230856">(Oct 19 2021 at 16:52)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> it'd be helpful to see the code you are writing now (and perhaps a sketch of what code you would want to write)</p>



<a name="258230926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258230926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258230926">(Oct 19 2021 at 16:52)</a>:</h4>
<p>I'm a bit '50/50' on integrating pin more deeply; I do see the appeal, but I'd like to understand the uses better, especially as I hope that we can move it further and further under the covers for async I/O</p>



<a name="258248985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258248985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258248985">(Oct 19 2021 at 18:32)</a>:</h4>
<p>IMO, we want to put the Pin API under the covers only because it is so challenging to use. Lots more could be done with it if we made it friendly.</p>



<a name="258249405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258249405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258249405">(Oct 19 2021 at 18:34)</a>:</h4>
<p>I agree that it could be made more friendly with some relatively limited improvements; however, I also think that a new <code>&amp;pin</code> reference type is a large "surface area change" to the language in some sense.</p>



<a name="258249414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258249414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258249414">(Oct 19 2021 at 18:34)</a>:</h4>
<p>First example off the top of my head: type alias impl trait should allow users to put futures inside pinned structs. But that is a pain in practice because of pin projection. Most of the time people will probably continue to use <code>Box&lt;dyn Future&gt;</code> for futures inside structs.</p>



<a name="258249512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258249512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258249512">(Oct 19 2021 at 18:35)</a>:</h4>
<p>Absolutely no doubt it would be a huge surface area change if stabilized.</p>



<a name="258249596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258249596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258249596">(Oct 19 2021 at 18:35)</a>:</h4>
<p>That is why I wanted to emphasize you could get pin projection with perma-unstable <code>&amp;pin</code> just banking off auto-ref.</p>



<a name="258249731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258249731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258249731">(Oct 19 2021 at 18:36)</a>:</h4>
<p>But guaranteed initialization does throw a wrench in that, lots of tradeoffs.</p>



<a name="258264735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258264735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258264735">(Oct 19 2021 at 20:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/first.20class.20pin/near/258230856">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> it'd be helpful to see the code you are writing now (and perhaps a sketch of what code you would want to write)</p>
</blockquote>
<p>In Linux kernel a lot of stuff are chained together by intrusive linked lists, and this includes <code>Mutex</code>es.  They have to pinned to be initialized. Currently we have to use a lot of unsafe code to achieve that, creating an uninitialized <code>Mutex</code>, pin it and then initialize it.</p>
<p>This is how rust-for-linux could use pin-init: <a href="https://github.com/nbdd0121/linux/commit/549b8e36166d61a54c990a87cccc93021d968ac2">https://github.com/nbdd0121/linux/commit/549b8e36166d61a54c990a87cccc93021d968ac2</a>.</p>
<p>Given that pinned structs are everywhere in Linux kernel we feel that proc macro isn't the ideal solution and hopefully can have a first class support.</p>



<a name="258368318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258368318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258368318">(Oct 20 2021 at 13:37)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> Thinking a bunch more about guaranteed pin init, I can see what is so nice about it:</p>
<ul>
<li>We want a wrapper type state to track initialization, <code>&amp;pin TypeToInit</code> wold do the trick.</li>
<li>We want initialization state to "project", that is if you init a pinned <code>struct Foo { data: Mutex }</code>, you should init <code>data</code> as well.</li>
</ul>
<p>The problem is, so long as it is only safe to init once, there would be no way to convert to <code>&amp;pin</code> inside <code>Future::poll</code>: the existing Pin API can't ever guarantee init, and init can't happen inside poll because poll is called more than once. Even if we migrated to a new pin type over an edition using a new defaulted <code>poll_init</code> function or something, it wouldn't really be compatible with tokio, futures, etc.</p>
<p>That being said, I think there is a nice way to make it work with a small additional library, and a fairly simple derive macro.</p>



<a name="258370873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258370873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Sartor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258370873">(Oct 20 2021 at 13:52)</a>:</h4>
<p>It could look something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(PinDefault)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Process</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">inner</span>: <span class="nc">Mutex</span><span class="o">&lt;</span><span class="n">ProcessInner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">refs</span>: <span class="nc">Mutex</span><span class="o">&lt;</span><span class="n">ProcessNodeRefs</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">some_counter</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="n">Construct</span>::<span class="o">&lt;</span><span class="n">Process</span><span class="o">&gt;</span>::<span class="n">new</span><span class="p">()).</span><span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="n">process</span><span class="p">.</span><span class="n">some_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="n">process</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">do_stuff</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="258422941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/first%20class%20pin/near/258422941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/first.20class.20pin.html#258422941">(Oct 20 2021 at 18:53)</a>:</h4>
<p>Many structs couldn't be default-initialized though (or would need unnecessary <code>Option</code> wrapping and <code>unwrap</code> everywhere).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>