<html>
<head><meta charset="utf-8"><title>Closure with return-position impl trait · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html">Closure with return-position impl trait</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267250413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267250413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267250413">(Jan 07 2022 at 22:20)</a>:</h4>
<p>Trying to write <code>|| -&gt; impl Trait { ... }</code> currently errors with:</p>
<div class="codehilite"><pre><span></span><code>error[E0562]: `impl Trait` not allowed outside of function and method return types
 --&gt; src/main.rs:2:21
  |
2 |     let val = || -&gt; impl Sized {
  |                     ^^^^^^^^^^
</code></pre></div>
<p>Is there anything preventing us from lifting this restriction? Being able to write <code>impl Future + 'a</code> would allow users to fix some lifetime issues around <code>|| async move { .. }</code> closures, especially when combined with <code>for&lt;&gt;</code> closures.</p>
<p>cc <span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="267250800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267250800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267250800">(Jan 07 2022 at 22:24)</a>:</h4>
<p>The one ambiguity I can think of would be whether or not the enclosing function can see through the return-position opaque type - I think the answer should be 'no', since RPITs are always opaque to all callers</p>



<a name="267251464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267251464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267251464">(Jan 07 2022 at 22:31)</a>:</h4>
<p>I think we should at least add a feature gate for it to be able to work on it, since there may be some oddities that I can't think of rn</p>



<a name="267251695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267251695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267251695">(Jan 07 2022 at 22:33)</a>:</h4>
<p>Supporting argument-position impl trait might be a little odd, since you can't explicitly declare generic parameters on closures</p>



<a name="267251969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267251969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267251969">(Jan 07 2022 at 22:36)</a>:</h4>
<p>While working on AST-based lifetime resolution, I came under the impression that we may.  In HIR, we can keep a list of generic parameters for the closure, including lifetimes or APIT.  This would not exist in the AST, but may help bridge a gap between functions and closures.</p>



<a name="267252041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267252041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267252041">(Jan 07 2022 at 22:36)</a>:</h4>
<p>This may even create a stepping stone to <code>for&lt;.&gt;</code> bounds on closures.</p>



<a name="267628612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Closure%20with%20return-position%20impl%20trait/near/267628612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Closure.20with.20return-position.20impl.20trait.html#267628612">(Jan 11 2022 at 18:55)</a>:</h4>
<p>+1 to making it work under a feature gate and seeing what comes up.  Seems quite natural to me.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>