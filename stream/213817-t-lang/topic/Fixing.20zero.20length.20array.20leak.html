<html>
<head><meta charset="utf-8"><title>Fixing zero length array leak · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html">Fixing zero length array leak</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278541130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278541130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278541130">(Apr 11 2022 at 11:45)</a>:</h4>
<p>In <a href="https://github.com/rust-lang/rust/issues/74836">#74836</a> , <span class="user-mention" data-user-id="352985">@tm</span> :</p>
<blockquote>
<p>I wondered about that too. So far I noticed that it would require additional changes to take into account lifetime extension / promotion, as direct implementation would allow:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="nb">String</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Why do we not want to allow this? The const promotion rules in the reference state that we promote consts if the value could be written in a const, and that seems to be the case here (<code>[String; 0]</code> being a ZST and all...)</p>



<a name="278544572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278544572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278544572">(Apr 11 2022 at 12:19)</a>:</h4>
<p>Is the proposal to desugar to <code>&amp;{ let _ = String::new(); [] }</code>? Because in that case you have to run <code>String</code>'s non-const Drop impl, which would make it ineligible for const promotion</p>



<a name="278545175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278545175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278545175">(Apr 11 2022 at 12:24)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="p">[</span><span class="nb">String</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">[]</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>compiles today</p>



<a name="278547810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278547810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278547810">(Apr 11 2022 at 12:46)</a>:</h4>
<p>yes, because it const promotes the <code>[]</code> only and not the <code>let _ = String::new()</code> which happens at runtime</p>



<a name="278548074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278548074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278548074">(Apr 11 2022 at 12:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95935">#95935</a> is up with what I am proposing for the fix. The code given above compiles under this PR</p>



<a name="278548126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278548126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278548126">(Apr 11 2022 at 12:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak/near/278547810">said</a>:</p>
<blockquote>
<p>yes, because it const promotes the <code>[]</code> only and not the <code>let _ = String::new()</code> which happens at runtime</p>
</blockquote>
<p>I'm not sure I really understand. The const is a <em>value</em>. <code>[String::new(); 0]</code> is not a different value from <code>[]</code>; why should they be treated differently for const promotion?</p>



<a name="278549209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278549209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278549209">(Apr 11 2022 at 12:58)</a>:</h4>
<p><code>[String::new(); 0]</code> is an <em>expression</em>, which drops a string</p>



<a name="278549291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278549291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278549291">(Apr 11 2022 at 12:58)</a>:</h4>
<p>Yes, but when we promote consts we don't promote expressions, we promote values - that's what consts are</p>



<a name="278549306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278549306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278549306">(Apr 11 2022 at 12:59)</a>:</h4>
<p>we don't want that to be legal in <code>const</code>, but arguably it would be okay to const promote the <code>[]</code> part after desugaring as above</p>



<a name="278549675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278549675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278549675">(Apr 11 2022 at 13:01)</a>:</h4>
<p>Oh interesting, extracting this into a function doesn't work; then const promotion is not what I thought it was</p>



<a name="278550190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278550190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278550190">(Apr 11 2022 at 13:05)</a>:</h4>
<p>Ah, I misread the reference documentation on this. Yeah, this indeed doesn't work then...</p>



<a name="278557373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278557373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278557373">(Apr 11 2022 at 13:59)</a>:</h4>
<p>Unfortunately, this compiles today:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="p">[</span><span class="nb">String</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
</code></pre></div>



<a name="278557707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278557707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278557707">(Apr 11 2022 at 14:01)</a>:</h4>
<p>Which... complicates things. This means that fixing this might even be a breaking change</p>



<a name="278591496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278591496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278591496">(Apr 11 2022 at 17:49)</a>:</h4>
<p>Note that the current plan is <em>not</em> to extend const promotion, but to require <code>const { ... }</code> around the things that aren't "trivially obviously const" (like <code>const</code>s or literals).</p>



<a name="278592636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278592636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278592636">(Apr 11 2022 at 17:57)</a>:</h4>
<blockquote>
<p>Which... complicates things. This means that fixing this might even be a breaking change</p>
</blockquote>
<p>As a hack you could only fix this in non-const code and we can figure out a future incompat lint.</p>
<p>Or we just try it out on crater and <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="278595910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278595910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278595910">(Apr 11 2022 at 18:21)</a>:</h4>
<p>My preferred solution would be to require Copy for repeat operand unless length operand is known to be 1, mostly to avoid answering question what happens with [const item that needs to be dropped; 0], which feels surprising either way.</p>



<a name="278597643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278597643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278597643">(Apr 11 2022 at 18:31)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95819/files">https://github.com/rust-lang/rust/pull/95819/files</a> moves the logic from a mir based one to a hir based one, which is closer to what the user wrote and thus mdore explicit about what we allow and why</p>



<a name="278598357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278598357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278598357">(Apr 11 2022 at 18:36)</a>:</h4>
<p>I think it is simultaneously a breaking change and allows more code. Gotta document more and write more tests, but we can easily add more checks for zero sized arrays here</p>



<a name="278598677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278598677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278598677">(Apr 11 2022 at 18:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak/near/278592636">said</a>:</p>
<blockquote>
<blockquote>
<p>Which... complicates things. This means that fixing this might even be a breaking change</p>
</blockquote>
<p>As a hack you could only fix this in non-const code and we can figure out a future incompat lint.</p>
<p>Or we just try it out on crater and <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>
</blockquote>
<p>If I'm understanding correctly, this would at least allow the above code, but not the same thing if it's the result of const promotion, yes?</p>



<a name="278600056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278600056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278600056">(Apr 11 2022 at 18:49)</a>:</h4>
<p>Const promotion is its very own analysis. We'll need to carefully build the MIR, but I think it should be possible</p>



<a name="278600269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278600269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278600269">(Apr 11 2022 at 18:50)</a>:</h4>
<p>Const promotion is its very own analysis. We'll need to carefully build the MIR, but I think it should be possible</p>



<a name="278601116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278601116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278601116">(Apr 11 2022 at 18:57)</a>:</h4>
<p>We'd essentially need to know what is promoted to a const at MIR build time, right?</p>



<a name="278602943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278602943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278602943">(Apr 11 2022 at 19:13)</a>:</h4>
<p>I think we just need to make sure that the transformation we do will be handled correctly by promotion</p>



<a name="278603082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603082">(Apr 11 2022 at 19:14)</a>:</h4>
<p>Basically there needs to be some path from the repeat element to the reference. I mean, we could "simply" emit both the drop and the repeat rvalue</p>



<a name="278603176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603176">(Apr 11 2022 at 19:15)</a>:</h4>
<p>That way promotion picks it up from the data flow and we get the early drop</p>



<a name="278603237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603237">(Apr 11 2022 at 19:16)</a>:</h4>
<p>Tho I wonder if we shouldn't rather fix drop elab to handle this correctly</p>



<a name="278603388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603388">(Apr 11 2022 at 19:17)</a>:</h4>
<p>Sorry, I'm sort of lost here. What's the intended outcome of your proposal?</p>



<a name="278603653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603653">(Apr 11 2022 at 19:19)</a>:</h4>
<p>Promotion does dataflow to see if any nonconst values or operations flow into a rvalue::ref's argument. If there is no dataflow from the repeat element to the repeat expression being borrowed, promotion will rightfully promote the repeat expression.<br>
If we do your PR, but instead of early returning a zst constant we just fall through to the repeat rvalue, then we get both: the drop and the correct dataflow for promotion</p>



<a name="278603779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603779">(Apr 11 2022 at 19:20)</a>:</h4>
<p>This way <code>&amp;[String::new(); 0]</code> does not get promoted and <code>[String::new(); 0]</code> drops the single String element</p>



<a name="278603826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603826">(Apr 11 2022 at 19:21)</a>:</h4>
<p>I see. That does not fix the breaking change though, right?</p>



<a name="278603945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278603945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278603945">(Apr 11 2022 at 19:22)</a>:</h4>
<p>Ah, for that you check whether the thing currently being mir build is a const context</p>



<a name="278604081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278604081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278604081">(Apr 11 2022 at 19:23)</a>:</h4>
<p>Right, ok, you're suggesting doing both. This makes sense now</p>



<a name="278604418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278604418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278604418">(Apr 11 2022 at 19:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak/near/278603653">said</a>:</p>
<blockquote>
<p>Promotion does dataflow to see if any nonconst values or operations flow into a rvalue::ref's argument. If there is no dataflow from the repeat element to the repeat expression being borrowed, promotion will rightfully promote the repeat expression.<br>
If we do your PR, but instead of early returning a zst constant we just fall through to the repeat rvalue, then we get both: the drop and the correct dataflow for promotion</p>
</blockquote>
<p>Would this effectively requiring special casing the analysis in one of borrowck/const promotion? It seems like the same dataflow that prevents the const from being promoted would cause a use after move error in borrowck</p>



<a name="278605026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278605026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278605026">(Apr 11 2022 at 19:31)</a>:</h4>
<p>Oh... hmpf</p>



<a name="278605264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278605264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278605264">(Apr 11 2022 at 19:33)</a>:</h4>
<p>OK, maybe we just add a mir opt after borrowck that does your transform before drop elab?</p>



<a name="278605525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278605525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278605525">(Apr 11 2022 at 19:35)</a>:</h4>
<p>Oh hmm, that sounds like it could totally work. This seems like it would still be recognizable then and everything. We could do this after const promotion as well, right? Thereby bypassing that whole issue too</p>



<a name="278605770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278605770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278605770">(Apr 11 2022 at 19:37)</a>:</h4>
<p>The earlier in the pipeline, the better</p>



<a name="278611198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278611198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278611198">(Apr 11 2022 at 20:21)</a>:</h4>
<p>So I'm trying this right now, and I think it almost works out, except for the unwind path. It poses a problem because 1) we don't really have the information on how to build it after MIR building, and 2) borrowck not knowing about it sounds like it would cause bugs</p>



<a name="278613480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278613480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278613480">(Apr 11 2022 at 20:39)</a>:</h4>
<p>Hmm, can we insert a <code>FakeUnwind</code> here?</p>



<a name="278625101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Fixing%20zero%20length%20array%20leak/near/278625101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Fixing.20zero.20length.20array.20leak.html#278625101">(Apr 11 2022 at 22:24)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95953">#95953</a> contains the new candidate implementation</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>