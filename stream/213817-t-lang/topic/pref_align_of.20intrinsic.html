<html>
<head><meta charset="utf-8"><title>pref_align_of intrinsic · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html">pref_align_of intrinsic</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253662741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253662741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253662741">(Sep 16 2021 at 22:49)</a>:</h4>
<p>Is there any reason that the pref_align_of intrinsic still exists? It has never been stably exposed and I am not aware of any road to stabilization. It also <a href="https://github.com/rust-lang/rust/pull/88839#discussion_r706793496">occasionally causes confusion</a>.<br>
Cc <span class="user-mention" data-user-id="133247">@bjorn3</span> <span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="253668139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253668139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253668139">(Sep 16 2021 at 23:48)</a>:</h4>
<p>we should be using preferred alignment for stuff like globals and whatnot, AFAIK.</p>



<a name="253668156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253668156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253668156">(Sep 16 2021 at 23:48)</a>:</h4>
<p>though that's an entirely a codegen concern.</p>



<a name="253671295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253671295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253671295">(Sep 17 2021 at 00:27)</a>:</h4>
<p>yeah I have not checked about the use of <code>align.pref</code> inside rustc itself. this is solely about whether it is worth exposing it to the Rust application.</p>



<a name="253671318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253671318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253671318">(Sep 17 2021 at 00:27)</a>:</h4>
<p>or whether it is time to deprecate and remove this ancient intrinsic with no clear path or proposal for stabilization</p>



<a name="253671525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253671525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253671525">(Sep 17 2021 at 00:30)</a>:</h4>
<p>I can't really think of much code that would need it beyond code doing platform specific optimizations (in which case, you probably know and or could figure out the abi-preffered alignment).</p>



<a name="253673225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253673225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253673225">(Sep 17 2021 at 00:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/213817-t-lang/topic/pref_align_of.20intrinsic/near/253671295">said</a>:</p>
<blockquote>
<p>yeah I have not checked about the use of <code>align.pref</code> inside rustc itself. this is solely about whether it is worth exposing it to the Rust application.</p>
</blockquote>
<p>Currently it's only used by cg_clif for globals (explicitly).</p>



<a name="253673567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253673567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253673567">(Sep 17 2021 at 00:57)</a>:</h4>
<p>I suppose we could use it to guide field placement, e.g. place fields with larger preferred alignment first (if the abi alignment is the same)</p>



<a name="253827961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253827961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253827961">(Sep 18 2021 at 01:27)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> I've always assumed <em>memory allocators</em> would use that, but in practice it doesn't seem to be the case (maybe it would be wasteful?)</p>



<a name="253838714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253838714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253838714">(Sep 18 2021 at 04:45)</a>:</h4>
<p>Allocators only get the abi alignment though, unless we want to augment <code>Layout</code> to add that (which I don't think we want).</p>



<a name="253838896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253838896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253838896">(Sep 18 2021 at 04:49)</a>:</h4>
<p>For reference, gcc/clang has a non-standard <code>__alignof__/__alignof</code> that returns the preferred alignment and the standard <code>alignof</code> that returns the ABI alignment, and the <code>operator new</code> only receive size and the ABI alignment.</p>



<a name="253839423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253839423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253839423">(Sep 18 2021 at 04:58)</a>:</h4>
<p>Ah, one more thing worth mentioning. Since memory returned by <code>malloc</code> has an alignment that suits all primitives, and user couldn't specify preferred alignment separately from the ABI alignment, these means that memory returned by the system allocator would actually be aligned to the preferred alignment as well.</p>



<a name="253839442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253839442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253839442">(Sep 18 2021 at 04:59)</a>:</h4>
<p>So pretty much this is only useful for globals or stack variables.</p>



<a name="253839861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253839861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253839861">(Sep 18 2021 at 05:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/213817-t-lang/topic/pref_align_of.20intrinsic/near/253838714">said</a>:</p>
<blockquote>
<p>Allocators only get the abi alignment though, unless we want to augment <code>Layout</code> to add that (which I don't think we want).</p>
</blockquote>
<p>Wouldn't that merely be a <code>Layout::preferred::&lt;T&gt;()</code> constructor?</p>



<a name="253840174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253840174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253840174">(Sep 18 2021 at 05:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/pref_align_of.20intrinsic/near/253839861">said</a>:</p>
<blockquote>
<p>Wouldn't that merely be a <code>Layout::preferred::&lt;T&gt;()</code> constructor?</p>
</blockquote>
<p>Could be, but then you will have to use the same layout for deallocation as well, so it wouldn't fit existing pointers like <code>Box</code> or dynamically sized types (well, unless we add preferred alignment to vtable).</p>



<a name="253840285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253840285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253840285">(Sep 18 2021 at 05:13)</a>:</h4>
<p>But then as I pointed out doing this for system allocator is not very useful. Could be useful for other Rust-specific allocators that don't want to provide <code>malloc</code>, but I suppose those allocators could simply max the alignment with the max preferred alignment of primitives.</p>



<a name="253840447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253840447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253840447">(Sep 18 2021 at 05:16)</a>:</h4>
<p>So I'd support removing the intrinsic (but keep it in the compiler for codegen)</p>



<a name="253849577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253849577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253849577">(Sep 18 2021 at 08:01)</a>:</h4>
<p>alright, that sounds good to me</p>



<a name="253849661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253849661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253849661">(Sep 18 2021 at 08:02)</a>:</h4>
<p>unless there's maybe some tricky FFI situation that would be hard/impossible to solve in the general case, without that information (cc <span class="user-mention" data-user-id="239881">@Josh Triplett</span>)</p>



<a name="253875016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253875016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253875016">(Sep 18 2021 at 15:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/213817-t-lang/topic/pref_align_of.20intrinsic/near/253840447">said</a>:</p>
<blockquote>
<p>So I'd support removing the intrinsic (but keep it in the compiler for codegen)</p>
</blockquote>
<p>"it" here being the align.pref information, not the codegen part of the intrinsic, correct?</p>



<a name="253888295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253888295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253888295">(Sep 18 2021 at 19:22)</a>:</h4>
<p>yep</p>



<a name="253929739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/253929739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#253929739">(Sep 19 2021 at 08:48)</a>:</h4>
<p>FYI: c2rust transpiler uses pref_align_of intrinsic</p>



<a name="261381027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/pref_align_of%20intrinsic/near/261381027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/pref_align_of.20intrinsic.html#261381027">(Nov 13 2021 at 21:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="352985">tm</span> <a href="#narrow/stream/213817-t-lang/topic/pref_align_of.20intrinsic/near/253929739">said</a>:</p>
<blockquote>
<p>FYI: c2rust transpiler uses pref_align_of intrinsic</p>
</blockquote>
<p>Not sure what your GH handle is, so let me point you to <a href="https://github.com/rust-lang/rust/pull/90877">https://github.com/rust-lang/rust/pull/90877</a> this way -- I am proposing to remove that intrinsic, since it does not seem to have any path to stabilization.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>