<html>
<head><meta charset="utf-8"><title>rfc 2229 capture and Drop · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html">rfc 2229 capture and Drop</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251628184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251628184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251628184">(Sep 01 2021 at 20:57)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="1977">@T-lang</span>, to follow up on our discussion from yesterday: I prepared a <a href="https://hackmd.io/AC5EJng9SDStdsjG2M9cUQ">hackmd</a> that explains the situation around structs that implement <code>Drop</code> and outlines the options that I see and their implications.</p>
<p>I realized one thing in writing this, which is that we actually <em>don't</em> have total freedom to decide this later. The current rules still allow capturing fields of <code>Copy</code> type from structs that implement <code>Drop</code>, which limits our options somewhat.</p>



<a name="251628624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251628624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251628624">(Sep 01 2021 at 21:00)</a>:</h4>
<p>I don't see a <em>perfect</em> option right now. The optimal thing depends on a number of factors, so making the rules do the "best thing" results in fairly complex rules, and the other rules tend to rule out one scenario or another. I'm not sure which is the most common. I think I lean mildly towards tweaking the rules myself, since I think erring towards capturing <em>more</em> is <em>probably</em> better, but it's not obvious to me.</p>



<a name="251628711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251628711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251628711">(Sep 01 2021 at 21:00)</a>:</h4>
<p>Whichever way we go, of course, we can have the compiler supply helpful tips.</p>



<a name="251634140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251634140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251634140">(Sep 01 2021 at 21:44)</a>:</h4>
<p>You should make it clear when you introduce your summary table that it is forward-referencing options that have not yet been defined in the doc. That was confusing to me when I first read it (and I skimmed backward to see what I missed, rather than forward)</p>



<a name="251642412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642412">(Sep 01 2021 at 23:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> How difficult would it be, for today, to continue to treat partial moves of Drop types as an error, and make people either drop <code>move</code> or use <code>let top_level_thing = top_level_thing;</code> to capture the whole thing?</p>



<a name="251642427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642427">(Sep 01 2021 at 23:07)</a>:</h4>
<p><em>That</em> seems like it'd be forward-compatible, insofar as we can always make it better in the future.</p>



<a name="251642456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642456">(Sep 01 2021 at 23:08)</a>:</h4>
<p>Separate from that, I think it's fine to allow copying <code>Copy</code> fields; if something is only <code>Copy</code> then that can affect captures.</p>



<a name="251642511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642511">(Sep 01 2021 at 23:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop/near/251642412">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> How difficult would it be, for today, to continue to treat partial moves of Drop types as an error, and make people either drop <code>move</code> or use <code>let top_level_thing = top_level_thing;</code> to capture the whole thing?</p>
</blockquote>
<p>that is the current behavior, if I understand</p>



<a name="251642535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642535">(Sep 01 2021 at 23:08)</a>:</h4>
<p>so not difficult at all :)</p>



<a name="251642573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642573">(Sep 01 2021 at 23:09)</a>:</h4>
<p>I'm potentially leaning that way-- I don't love the rules around moves out of <code>Drop</code> types and given that I don't think we can cover all the bases, maybe the best thing is to just add some form of capture clause (which I want to do anyway)</p>



<a name="251642826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642826">(Sep 01 2021 at 23:11)</a>:</h4>
<p>We can always add a capture clause in the future, but for now, I think having something like <code>let x = x;</code> to capture x seems fine.</p>



<a name="251642871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251642871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251642871">(Sep 01 2021 at 23:12)</a>:</h4>
<p>(Or <code>drop(x)</code> at the end of the function, or something.)</p>



<a name="251652741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251652741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251652741">(Sep 02 2021 at 01:18)</a>:</h4>
<p>I would personally be rather annoyed by needing to write <code>let x = x;</code> in closures -- my expectation was that would not need to happen in ~any Rust code, basically, beyond our migrations that try to make sure destructors are in the same place (and in many of those cases such an addition can likely just be dropped). If we <em>had</em> capture clauses of some kind, I think it would be different, but given that all the capturing patterns look pretty "ugly" to my eyes I'd personally want to do everything to avoid it.</p>
<p>I think the main downside to capturing <em>more</em> by default is that some code continues to not work (e.g., if a separate field is mutated outside the closure). Our statistics seem to show that closure sizes don't really change in ~any crates in a significant way, so the "runtime" cost seems not terribly important. The more complicated rules I don't think practically matter; like we saw with NLL, people in general don't really seem to care about the rules so long as their code works "as they expect", and in practice I am doubtful anyone is relying on particular destructor orders with closure captures (and if they are, I'd argue they should be adding explicit drops...).</p>
<p>So in general I think at least for me the potential downside of  user frustration with something that used to work no longer working (i.e., a 2229 migration they can't just delete, like most other such migrations) outweighs the possible downsides along the other axes.</p>
<p>I think the hackmd doesn't really lay out the axes of consideration for the decision -- that might be helpful. Obviously we'll all have different weights, but I think it'd be good to add a list of "things considered". I've tried to add a section at the bottom with the ones from this comment -- happy to have others added.</p>



<a name="251656206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251656206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251656206">(Sep 02 2021 at 02:11)</a>:</h4>
<p>I would expect it to be <em>rare</em> to need to write <code>let x = x;</code>, since it's rare to want to move out of a field from a Drop struct.</p>



<a name="251656217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251656217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251656217">(Sep 02 2021 at 02:12)</a>:</h4>
<p>And the code in question wouldn't compile at all before.</p>



<a name="251656269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251656269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251656269">(Sep 02 2021 at 02:12)</a>:</h4>
<p>I agree that it <em>may</em> be possible to make it work automatically in the future.</p>



<a name="251656295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251656295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251656295">(Sep 02 2021 at 02:12)</a>:</h4>
<p>But given that this is a flagship feature of the edition, and the edition is branching approximately <em>now</em>, I'd rather go with something that's already working and tested that we can always expand later, rather than committing in a hurry to something we want but haven't fully designed or explored.</p>



<a name="251656523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251656523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251656523">(Sep 02 2021 at 02:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop/near/251656217">said</a>:</p>
<blockquote>
<p>And the code in question wouldn't compile at all before.</p>
</blockquote>
<p>I'm not sure we're on the same page here -- the code being described here <em>works</em> on 2018, and under the current implementation, stops working in 2021. (Obviously, our migrations can prevent that. But not in a nice way, and new code will need to use the weird pattern(s)).</p>
<p>I'm not convinced the working and tested is <em>really</em> that true -- we're going to get roughly the same amount of testing I think whichever rule set we choose (I'd expect at least one more, likely more, crater runs for example). The rule change is targeted and seems likely to be pretty minimal in terms of effects, as far as I can tell. I'd personally rather say that this is showcasing we may not be ready, and should "just" delay the edition by a cycle. We are pushing pretty close to the deadline regardless with design discussions like this late in the cycle.</p>



<a name="251659889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251659889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251659889">(Sep 02 2021 at 03:10)</a>:</h4>
<blockquote>
<p>the code being described here works on 2018, and under the current implementation, stops working in 2021</p>
</blockquote>
<p>That's not my understanding. In the conversations in the meeting, it sounded like the code in question just didn't compile, and will continue to not compile.</p>



<a name="251659894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251659894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251659894">(Sep 02 2021 at 03:11)</a>:</h4>
<p>/me tests in the playground.</p>



<a name="251660041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660041">(Sep 02 2021 at 03:13)</a>:</h4>
<p>Well, now I'm very confused.</p>



<a name="251660046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660046">(Sep 02 2021 at 03:13)</a>:</h4>
<p>I just tried <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=252fce51b2630084b2ef4b6da78fe57e">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=252fce51b2630084b2ef4b6da78fe57e</a> , which compiles and runs.</p>



<a name="251660081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660081">(Sep 02 2021 at 03:14)</a>:</h4>
<p>For one thing I'm confused about <em>why</em> that compiles and runs today.</p>



<a name="251660097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660097">(Sep 02 2021 at 03:14)</a>:</h4>
<p>And for another, if it <em>does</em> compile, I'm confused about why it would <em>stop</em> with RFC 2229.</p>



<a name="251660147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660147">(Sep 02 2021 at 03:15)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c6a98aa76ae001aaf346af87b6b88ce4">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c6a98aa76ae001aaf346af87b6b88ce4</a> doesn't work, which makes more sense.</p>



<a name="251660168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660168">(Sep 02 2021 at 03:15)</a>:</h4>
<p>So it seems like <code>println!("{}", foo.0)</code> does the right thing, and translates into a borrow which doesn't require moving out of the struct that implements <code>Drop</code>.</p>



<a name="251660347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251660347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251660347">(Sep 02 2021 at 03:18)</a>:</h4>
<p>Given all that, it's not obvious to me why we'd need to make this <em>stop</em> working.</p>



<a name="251722011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251722011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251722011">(Sep 02 2021 at 14:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop/near/251660081">said</a>:</p>
<blockquote>
<p>For one thing I'm confused about <em>why</em> that compiles and runs today.</p>
</blockquote>
<p>because today we always capture entire variables (in this case, <code>w</code>)</p>



<a name="251722039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251722039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251722039">(Sep 02 2021 at 14:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop/near/251660347">said</a>:</p>
<blockquote>
<p>Given all that, it's not obvious to me why we'd need to make this <em>stop</em> working.</p>
</blockquote>
<p>that's the whole topic of the doc :)</p>



<a name="251722073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251722073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251722073">(Sep 02 2021 at 14:15)</a>:</h4>
<p>I agree that I didn't get around to "areas of consideration", let me try to add some.</p>



<a name="251722178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251722178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251722178">(Sep 02 2021 at 14:16)</a>:</h4>
<p>I started where Mark is, moved a bit, but I might be circling back around. I'm trying to think about this a bit from the perspective, though, of a Rust 2021 user, who doesn't know/care what "used to work" in Rust 2018, and wants consistent rules.</p>



<a name="251724359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251724359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251724359">(Sep 02 2021 at 14:29)</a>:</h4>
<p>I think my intuition is that no one will actually try to learn the rules, and truncating at a drop-implementing struct is not that <em>hard</em> a rule, really.</p>



<a name="251724906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251724906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251724906">(Sep 02 2021 at 14:32)</a>:</h4>
<p>I wrote out my consideratons</p>



<a name="251724921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251724921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251724921">(Sep 02 2021 at 14:32)</a>:</h4>
<p>There is probably one more</p>



<a name="251725344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725344">(Sep 02 2021 at 14:35)</a>:</h4>
<p>just added</p>



<a name="251725369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725369">(Sep 02 2021 at 14:35)</a>:</h4>
<p>that was a helpful exercise, <span class="user-mention" data-user-id="116122">@simulacrum</span>, thanks, I think it changed my position yet again ;)</p>



<a name="251725415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725415">(Sep 02 2021 at 14:35)</a>:</h4>
<p>I think I favor the "truncate by-value captures at Drop if the type is not copy"</p>



<a name="251725653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725653">(Sep 02 2021 at 14:37)</a>:</h4>
<p>one thing I realized is that adding <code>Copy</code> can <em>already</em> change when code runs today, in Rust 2018</p>



<a name="251725675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725675">(Sep 02 2021 at 14:37)</a>:</h4>
<p>as it can cause local variables to change from "by ref" access to "by move"</p>



<a name="251725763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725763">(Sep 02 2021 at 14:37)</a>:</h4>
<p>this can also inluence what kind of borrow check errors you get</p>



<a name="251725765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725765">(Sep 02 2021 at 14:37)</a>:</h4>
<p>same as <code>Drop</code></p>



<a name="251725849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725849">(Sep 02 2021 at 14:38)</a>:</h4>
<p>all of these things exist today and I don't think they've <em>ever</em> come on my radar as a source of concern</p>



<a name="251725895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251725895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251725895">(Sep 02 2021 at 14:38)</a>:</h4>
<p>in contrast to "closures that aren't capturing the right things" :P</p>



<a name="251726408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251726408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251726408">(Sep 02 2021 at 14:41)</a>:</h4>
<p><a href="https://hackmd.io/AC5EJng9SDStdsjG2M9cUQ?view#Niko%E2%80%99s-conclusion">Niko's conclusion</a></p>



<a name="251726449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251726449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251726449">(Sep 02 2021 at 14:42)</a>:</h4>
<p>people should feel free to add other lines of reasoning if they disagree</p>



<a name="251767689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251767689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251767689">(Sep 02 2021 at 18:56)</a>:</h4>
<p>Reposting here for visibility: <a href="/user_uploads/4715/pZGD5WvTyqgNxaiKA_e31l-d/Screen-Shot-2021-09-02-at-20.56.22.png">Screen-Shot-2021-09-02-at-20.56.22.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/pZGD5WvTyqgNxaiKA_e31l-d/Screen-Shot-2021-09-02-at-20.56.22.png" title="Screen-Shot-2021-09-02-at-20.56.22.png"><img src="/user_uploads/4715/pZGD5WvTyqgNxaiKA_e31l-d/Screen-Shot-2021-09-02-at-20.56.22.png"></a></div>



<a name="251768152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251768152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251768152">(Sep 02 2021 at 18:59)</a>:</h4>
<p>So the fix to remain <code>Fn</code> or <code>FnMut()</code> is to <code>drop(&amp;w);</code> or <code>let _ = &amp;w;</code> as written in the hachmd: anything that has to do with <code>w</code>, but <em>which does not move it</em></p>



<a name="251770469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251770469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251770469">(Sep 02 2021 at 19:14)</a>:</h4>
<p>Yes the migration lint we suggest is <code>let _ = &amp;w</code></p>



<a name="251776978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251776978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251776978">(Sep 02 2021 at 19:58)</a>:</h4>
<p>thanks <span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span>, you are correct</p>



<a name="251876851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251876851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251876851">(Sep 03 2021 at 13:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop/near/251726449">said</a>:</p>
<blockquote>
<p>people should feel free to add other lines of reasoning if they disagree</p>
</blockquote>
<p>Hey <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> -- I'd appreciate a <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> or something to indicate "I read this and it made some sense to me" and perhaps a <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> if you're not sure :) I'd be happy to talk it over with people</p>



<a name="251876870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251876870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251876870">(Sep 03 2021 at 13:07)</a>:</h4>
<p>(others too :)</p>



<a name="251878848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251878848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251878848">(Sep 03 2021 at 13:22)</a>:</h4>
<p><span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> from me</p>



<a name="251885013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251885013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251885013">(Sep 03 2021 at 14:02)</a>:</h4>
<p>I am thinking I could start an FCP on the PR <a href="https://github.com/rust-lang/rust/pull/88477">https://github.com/rust-lang/rust/pull/88477</a> along with the write-up</p>



<a name="251887321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251887321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251887321">(Sep 03 2021 at 14:16)</a>:</h4>
<p>(Though we probably don't want to wait 10 days).</p>



<a name="251887899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/251887899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#251887899">(Sep 03 2021 at 14:20)</a>:</h4>
<p>no, but it's a way to have folks check</p>



<a name="252027964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/rfc%202229%20capture%20and%20Drop/near/252027964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop.html#252027964">(Sep 04 2021 at 21:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/213817-t-lang/topic/rfc.202229.20capture.20and.20Drop/near/251768152">said</a>:</p>
<blockquote>
<p>So the fix to remain <code>Fn</code> or <code>FnMut()</code> is to <code>drop(&amp;w);</code> or <code>let _ = &amp;w;</code> as written in the hachmd: anything that has to do with <code>w</code>, but <em>which does not move it</em></p>
</blockquote>
<p>Something like using <code>&amp;(&amp;w).0</code> in place of the <code>&amp;w.0</code> works as well as a workaround. It avoids having to type out the variable name <code>w</code> a second time.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>