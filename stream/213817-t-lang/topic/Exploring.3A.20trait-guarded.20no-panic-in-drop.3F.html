<html>
<head><meta charset="utf-8"><title>Exploring: trait-guarded no-panic-in-drop? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html">Exploring: trait-guarded no-panic-in-drop?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262630566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exploring%3A%20trait-guarded%20no-panic-in-drop%3F/near/262630566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html#262630566">(Nov 24 2021 at 19:20)</a>:</h4>
<p>I don't know whether this would be a good idea -- it might be another <code>?Trait</code>, which we've said we don't want -- but I wanted to explore it anyway to see where it goes.</p>
<p>What might it look like to have it so that</p>
<ul>
<li><code>Drop</code> impls get the "panic becomes abort" behaviour by default, but they can opt out of it.  (<code>Drop</code> is already quite magic, so an attribute or something could feasibly do this, I think.)</li>
<li>There's some sort of marker trait so that <code>dyn SomeTrait + DropCannotPanic</code> or <code>trait MyTrait : DropCannotPanic {}</code> could work.</li>
<li>Containers and such that don't want to support panic-in-drop can state that explicitly, such that there's no toolchain/strategy-flag hazard</li>
</ul>
<p>I could argue either way for the default -- since <em>safe</em> code can always handle this fine (assuming any unsafe they use is correct), in some sense it would be fine for <code>&lt;T&gt;</code> to include can-panic types.  But in order to not break existing generic code using <code>Vec&lt;T&gt;</code> the opposite would be better, where <code>T</code> defaults to no-panic-on-drop and you'd have to opt-in to code which <em>can</em> panic.  But that's a <code>?DropCannotPanic</code>, which is bad too...</p>



<a name="262631609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exploring%3A%20trait-guarded%20no-panic-in-drop%3F/near/262631609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html#262631609">(Nov 24 2021 at 19:32)</a>:</h4>
<p>I stand by my point that most people won't even notice the change in panic-in-drop. I don't think this justifies adding an auto-trait and all the baggage that comes with it.</p>



<a name="262633506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exploring%3A%20trait-guarded%20no-panic-in-drop%3F/near/262633506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html#262633506">(Nov 24 2021 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> I agree. We have declined to add <code>?Trait</code>s for much more important things people <em>actually</em> want to do.</p>



<a name="262633592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exploring%3A%20trait-guarded%20no-panic-in-drop%3F/near/262633592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html#262633592">(Nov 24 2021 at 19:52)</a>:</h4>
<p>I do think that's one potential shape for a completely non-breaking change. But I think we don't have to make this change completely non-breaking if nobody will actually be broken.</p>



<a name="262636271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exploring%3A%20trait-guarded%20no-panic-in-drop%3F/near/262636271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html#262636271">(Nov 24 2021 at 20:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F/near/262631609">said</a>:</p>
<blockquote>
<p>I don't think this justifies adding [...]</p>
</blockquote>
<p>TBH, I probably agree.  I still want to explore what those various possible solutions might look like, though, to be better able to weigh the different points on the spectrum.</p>



<a name="262637051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exploring%3A%20trait-guarded%20no-panic-in-drop%3F/near/262637051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exploring.3A.20trait-guarded.20no-panic-in-drop.3F.html#262637051">(Nov 24 2021 at 20:28)</a>:</h4>
<p>And while I acknowledge these aren't all that comparable, it does feel a bit odd to be moving away from abort for memory allocation failures yet towards abort for panics in drop.  I could easily imagine that unsafe code that's not handling panicking drop correctly is also not prepared to handle panicking allocations.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>