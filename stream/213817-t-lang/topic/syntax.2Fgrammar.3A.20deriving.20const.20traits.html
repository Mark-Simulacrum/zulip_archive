<html>
<head><meta charset="utf-8"><title>syntax/grammar: deriving const traits · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html">syntax/grammar: deriving const traits</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266466258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266466258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266466258">(Dec 30 2021 at 23:19)</a>:</h4>
<p>I think that the ability to derive a const trait is useful, and I am certain others agree on this point. <code>#[derive(const Default)]</code> is syntactically invalid at the moment. After digging in the parser a bit, it looks like the only way to permit it here is to permit it in <em>any</em> attribute macro, which I don't see as desirable. The alternative would be to special-case the <code>derive</code> macro similar to how <code>cfg</code> is, but I don't believe that would be possible (at least without significant effort or an edition boundary) because you can <code>use derive as foo</code> and then <code>#[foo(Default)]</code>. As odd as that may seem I do recall seeing a UI test for this, so it's intended behavior.</p>
<p>I'm trying to implement this speculatively before an RFC is written to take note of any major issues. I'd like to permit <code>#[derive(const Foo)]</code> both for standard library traits and third-party derives (by having <code>#[proc_macro_derive(const Foo)]</code> permitted. And if we're going down that road, may as well permit <code>#[derive(unsafe Send, unsafe Sync)]</code> as well I would think.</p>
<p>What would be the best way to attempt an implementation here?</p>



<a name="266476727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266476727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266476727">(Dec 31 2021 at 02:52)</a>:</h4>
<p>I actually see an alternative from <a href="https://rust-lang.github.io/rfcs/1559-attributes-with-literals.html#token-trees">RFC 1559</a> showing an alternative being raw token trees inside the attribute. I think this is backwards compatible if we wanted to go that route?</p>



<a name="266476762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266476762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266476762">(Dec 31 2021 at 02:54)</a>:</h4>
<p>Even permitting arbitrary tokens inside the parenthesized part of an attribute would be extremely flexible.</p>



<a name="266479359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479359">(Dec 31 2021 at 03:59)</a>:</h4>
<p><span class="user-mention" data-user-id="245610">@Jacob Pratt</span> Permitting the tokens syntactically and then rejecting them later semantically seems reasonable.</p>



<a name="266479452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479452">(Dec 31 2021 at 04:00)</a>:</h4>
<p>If someone writes <code>#[derive(let Default)]</code>, it seems fine if the compiler waits until later to go "what?".</p>



<a name="266479463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479463">(Dec 31 2021 at 04:00)</a>:</h4>
<p>(Assuming that change suffices.)</p>



<a name="266479650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479650">(Dec 31 2021 at 04:05)</a>:</h4>
<p>I think this would be another case where derive arguments would be useful</p>



<a name="266479652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479652">(Dec 31 2021 at 04:05)</a>:</h4>
<p>I'm in the process of writing up an RFC for that</p>



<a name="266479705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479705">(Dec 31 2021 at 04:06)</a>:</h4>
<p>Alternatively, you could add a derive helper attribute, and do something like <code>#[const_derive(Default, Debug, MyCustomDerive)]</code></p>



<a name="266479707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479707">(Dec 31 2021 at 04:06)</a>:</h4>
<p>and have the individual derive macros search for their own name in the list</p>



<a name="266479708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479708">(Dec 31 2021 at 04:06)</a>:</h4>
<p>The code I have locally currently parses <code>const</code> specifically, so any other keyword would be rejected. It creates a new <code>ConstWord</code> meta item, but realistically that was just a temporary thing for playing around.</p>



<a name="266479728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479728">(Dec 31 2021 at 04:07)</a>:</h4>
<p>I thought of splitting the derive into a const derive attribute, but having <code>#[derive(const Default)]</code> just feels right</p>



<a name="266479800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479800">(Dec 31 2021 at 04:09)</a>:</h4>
<p>with derive arguments, that could be <code>#[derive(Debug(const), Default, OtherTrait(const))]</code></p>



<a name="266479823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479823">(Dec 31 2021 at 04:10)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> I believe in general that if something uses a particular syntax in one context it should use the same syntax in other contexts if at all possible. We write <code>impl const Default</code>, so we should be able to write <code>derive(const Default)</code>.</p>



<a name="266479881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479881">(Dec 31 2021 at 04:10)</a>:</h4>
<p>how would that get interpreted by the derive macro?</p>



<a name="266479887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479887">(Dec 31 2021 at 04:11)</a>:</h4>
<p>Would it receive a list of keywords used?</p>



<a name="266479890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479890">(Dec 31 2021 at 04:11)</a>:</h4>
<p>Basically, yes.</p>



<a name="266479936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479936">(Dec 31 2021 at 04:12)</a>:</h4>
<p>On the code I have locally it currently adds a new meta item, but ultimately it would make sense to add information directly to the existing ones.</p>



<a name="266479942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479942">(Dec 31 2021 at 04:12)</a>:</h4>
<p>I think the derive argument syntax would be more flexible, and could accept the same syntax that attribute macros do</p>



<a name="266479948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479948">(Dec 31 2021 at 04:12)</a>:</h4>
<p>Also, the connection between a derive macro and a particular trait is "just" a strong convention</p>



<a name="266479960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479960">(Dec 31 2021 at 04:13)</a>:</h4>
<p>As far as the macro system is concerned, a derive macro can expand to any list of items</p>



<a name="266479970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479970">(Dec 31 2021 at 04:13)</a>:</h4>
<p>Yes, but the expectation is generally that they expand to the thing named.</p>



<a name="266479971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479971">(Dec 31 2021 at 04:13)</a>:</h4>
<p>I'm not saying that we should encourage other non-trait uses of derive</p>



<a name="266479985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266479985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266479985">(Dec 31 2021 at 04:14)</a>:</h4>
<p>but this seems to be making derive more 'opinionated' than it currently is</p>



<a name="266480043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480043">(Dec 31 2021 at 04:15)</a>:</h4>
<p>Not really. The built-in macros would handle it the clear way, while proc macros could <code>#[proc_macro_derive(const Foo)]</code> and do whatever they want still.</p>



<a name="266480052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480052">(Dec 31 2021 at 04:15)</a>:</h4>
<p>Mainly, I think that if we're going to allow additional tokens to be 'directed' at a particular derive macro invocation, we should do it in a flexible way</p>



<a name="266480058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480058">(Dec 31 2021 at 04:15)</a>:</h4>
<p>and we already have a mechanism for (AFAIK) arbitrary tokens as arguments to an attribute macro</p>



<a name="266480103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480103">(Dec 31 2021 at 04:16)</a>:</h4>
<p>I think it would be better to re-use that instead of introducing a new, more restricted form of arguments for just derive</p>



<a name="266480105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480105">(Dec 31 2021 at 04:16)</a>:</h4>
<p>I don't believe that is the case.</p>



<a name="266480116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480116">(Dec 31 2021 at 04:16)</a>:</h4>
<p>Which part?</p>



<a name="266480188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480188">(Dec 31 2021 at 04:18)</a>:</h4>
<p>The arbitrary tokens as arguments</p>



<a name="266480244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480244">(Dec 31 2021 at 04:20)</a>:</h4>
<p>I just tested, and it appears to allow any tokens</p>



<a name="266480263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480263">(Dec 31 2021 at 04:20)</a>:</h4>
<p>Though I think I've only ever seen comma-separated tokens and nested parents in practice</p>



<a name="266480340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480340">(Dec 31 2021 at 04:22)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I think I see <code>#[derive(Trait)] struct Foo {}</code> as being closer to <code>#[attribute_macro] struct Foo {}</code> than <code>impl Trait for Foo {}</code></p>



<a name="266480367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480367">(Dec 31 2021 at 04:24)</a>:</h4>
<p>That is, while it should expand to a normal trait impl (and maybe an inherent impl) to match user expectations, it's still first and foremost a macro call</p>



<a name="266480479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480479">(Dec 31 2021 at 04:26)</a>:</h4>
<p>I also have a separate use-case for derive macro arguments in mind (using them to explicitly opt-in to newly added libstd derive helpers), so I'm definitely biased towards a more general way of passing arguments :)</p>



<a name="266480550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480550">(Dec 31 2021 at 04:28)</a>:</h4>
<p>What did you try out of curiosity? I was digging through the code earlier and didn't think that was the case (there are RFCs that clearly indicate it shouldn't be).</p>
<p>While of course it is a macro call, I'd be surprised if most people viewed it that way. I've always viewed it as "generate this named trait for me"</p>



<a name="266480569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480569">(Dec 31 2021 at 04:29)</a>:</h4>
<p>I tried <code>#[my_macro(a =&gt; b . + - ())]</code></p>



<a name="266480626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480626">(Dec 31 2021 at 04:30)</a>:</h4>
<p>I wonder if there could be a generalization of this.<br>
Something like<br>
<code>#[proc_macro_extended_derive(Name)]</code>, which accepts one preceeding keyword, then the derive Name, followed by full meta syntax in paramethesis (each part of this is optional), and passes the entire thing in a second TokenStream to the function?</p>



<a name="266480766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480766">(Dec 31 2021 at 04:34)</a>:</h4>
<p>I think passing the arguments inline <code>#[derive(Foo(some args))]</code> would be much easier to read</p>



<a name="266480777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480777">(Dec 31 2021 at 04:34)</a>:</h4>
<p>since there's only one use of the derive macro name</p>



<a name="266480780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480780">(Dec 31 2021 at 04:34)</a>:</h4>
<p>Yeah, that would also be reasonable (that's covered by the "full meta syntax in parenthesis")</p>



<a name="266480857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480857">(Dec 31 2021 at 04:36)</a>:</h4>
<p>Basically, my idea for <code>#[proc_macro_extended_derive]</code> would work like a combination of <code>#[proc_macro_derive]</code> (in that it interfaces with the <code>#[derive]</code> attribute), and <code>#[proc_macro_attribute]</code> (in that it accepts the attribute, or in this case, the relevant portion of the <code>#[derive]</code> input, as a second TokenStream)</p>



<a name="266480860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480860">(Dec 31 2021 at 04:36)</a>:</h4>
<p>What about something that isn't optional though? Of course <code>const Default</code> can go either way, but <code>#[derive(unsafe Send)]</code> wouldn't have <code>unsafe</code> be optional. Sure, the macro could enforce it itself, but it seems cleaner to do it the way written here.</p>



<a name="266480878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480878">(Dec 31 2021 at 04:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits/near/266480860">said</a>:</p>
<blockquote>
<p>What about something that isn't optional though? Of course <code>const Default</code> can go either way, but #[derive(unsafe Send)]<code> wouldn't have </code>unsafe` be optional. Sure, the macro could enforce it itself, but it seems cleaner to do it the way written here.</p>
</blockquote>
<p>The macro itself would need to communicate what is and is not accepted (and optional/mandatory) in the keyword slot, so it seems better in that version to just let the macro handle it.</p>



<a name="266480924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480924">(Dec 31 2021 at 04:38)</a>:</h4>
<p>Oh, I think I misread your comment - you were proposing an attribute on the proc macro definition</p>



<a name="266480931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480931">(Dec 31 2021 at 04:38)</a>:</h4>
<p>Not an additional attribute that you would apply to the invocation site</p>



<a name="266480948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480948">(Dec 31 2021 at 04:38)</a>:</h4>
<p>I think we're actually in complete agreement</p>



<a name="266480954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480954">(Dec 31 2021 at 04:39)</a>:</h4>
<p>Yeah.</p>



<a name="266480961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266480961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266480961">(Dec 31 2021 at 04:39)</a>:</h4>
<p>Yes, but my intent for showing what's optional is to have <code>#[proc_macro_derive(const Foo)]</code> be its own thing, separate from the non-const version. The implementation <em>should</em> be nearly identical but this wouldn't be enforced.</p>



<a name="266481018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481018">(Dec 31 2021 at 04:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits/near/266480961">said</a>:</p>
<blockquote>
<p>Yes, but my intent for showing what's optional is to have <code>#[proc_macro_derive(const Foo)]</code> be its own thing, separate from the non-const version. The implementation <em>should</em> be nearly identical but this wouldn't be enforced.</p>
</blockquote>
<p>Hmm...</p>



<a name="266481032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481032">(Dec 31 2021 at 04:41)</a>:</h4>
<p>I think there are a lot of other useful options that we might want to pass to derive macros</p>



<a name="266481034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481034">(Dec 31 2021 at 04:41)</a>:</h4>
<p>I'm not disputing that</p>



<a name="266481037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481037">(Dec 31 2021 at 04:41)</a>:</h4>
<p>e.g. skipping fields for <code>Debug</code> or adjusting <code>where</code> clauses</p>



<a name="266481040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481040">(Dec 31 2021 at 04:41)</a>:</h4>
<p>I just don't think it's the appropriate mechanism to mark something const</p>



<a name="266481079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481079">(Dec 31 2021 at 04:42)</a>:</h4>
<p>and in general, they can't have an equivalent syntax to what it would look like on an impl</p>



<a name="266481080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481080">(Dec 31 2021 at 04:42)</a>:</h4>
<p>The proposed enhanced derive macro, though, would be useful for other things. For example, specifying options of something like <code>#[derive(serde::Deserialize/Serialize)]</code></p>



<a name="266481089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481089">(Dec 31 2021 at 04:42)</a>:</h4>
<p>So, this seems like special-casing <code>const</code> over other impl customizations</p>



<a name="266481090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481090">(Dec 31 2021 at 04:42)</a>:</h4>
<p>That is:</p>



<a name="266481094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481094">(Dec 31 2021 at 04:43)</a>:</h4>
<p><code>impl const Foo</code> will match up nicely with <code>#[derive(const Foo)]</code></p>



<a name="266481110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481110">(Dec 31 2021 at 04:43)</a>:</h4>
<p>But <code>impl MyTrait for Bar where MyWhereClause</code> can't really match up directly with a derive</p>



<a name="266481116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481116">(Dec 31 2021 at 04:44)</a>:</h4>
<p>Correct. Matching the derive syntax with the impl</p>



<a name="266481157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481157">(Dec 31 2021 at 04:44)</a>:</h4>
<p>Unless we wanted to allow <code>#[derive(Foo where MyWhereClause)]</code></p>



<a name="266481167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481167">(Dec 31 2021 at 04:44)</a>:</h4>
<p>Keep in mind that my original question was solely how I should go about doing this grammatically and semantically in the compiler, by the way. I actually wasn't coming here for a debate — that was for the RFC that hasn't even been started</p>



<a name="266481179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481179">(Dec 31 2021 at 04:45)</a>:</h4>
<p>I definitely think an RFC is a good idea</p>



<a name="266481185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481185">(Dec 31 2021 at 04:45)</a>:</h4>
<p>I can save this discussion for that PR, if you'd like</p>



<a name="266481231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481231">(Dec 31 2021 at 04:46)</a>:</h4>
<p>In terms of the implementation:</p>



<a name="266481235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481235">(Dec 31 2021 at 04:46)</a>:</h4>
<p>Up to you. That was just my nice way of saying that I don't particularly feel like debating the specifics right now — I just wasn't sure the best way to implement the parser when playing around locally.</p>



<a name="266481241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481241">(Dec 31 2021 at 04:47)</a>:</h4>
<p>The RFC, like I said, hasn't even been started. I'll definitely post it on IRLO first if you track that.</p>



<a name="266481243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481243">(Dec 31 2021 at 04:47)</a>:</h4>
<p>Are you looking to modify your current implementation to make it easier to experiment with locally?</p>



<a name="266481246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481246">(Dec 31 2021 at 04:47)</a>:</h4>
<p>Or are you trying to make a more robust implementation?</p>



<a name="266481298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481298">(Dec 31 2021 at 04:48)</a>:</h4>
<p>Uhh not sure? First thing I was trying to do was to get it working. Which I'm nearly there I think</p>



<a name="266481314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481314">(Dec 31 2021 at 04:49)</a>:</h4>
<p>The 'final' implementation would probably have the proc macro definition taking in two TokenStream arguments, but that could be kind of a pain to implement</p>



<a name="266481363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481363">(Dec 31 2021 at 04:50)</a>:</h4>
<p>as you would need to handle the function having either one or two arguments</p>



<a name="266481372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481372">(Dec 31 2021 at 04:50)</a>:</h4>
<p>If you're just working with built-in attributes, you could probably stash the extra data in the ExtCtxt</p>



<a name="266481388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481388">(Dec 31 2021 at 04:51)</a>:</h4>
<p>Like I have a vision of what I want and am trying to implement it (largely) before writing an RFC. Primary purpose, at least initially, is to have the built in derived support const traits. Later goal is proc macro derives.</p>



<a name="266481435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481435">(Dec 31 2021 at 04:52)</a>:</h4>
<p>Built-in will probably be much simpler, since you won't have to deal with any of the bridge/dylib/harness code</p>



<a name="266481440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481440">(Dec 31 2021 at 04:52)</a>:</h4>
<p>which has several different pieces spread out across the compiler</p>



<a name="266481451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266481451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266481451">(Dec 31 2021 at 04:53)</a>:</h4>
<p>Actually making the trait const is laughably easy. The only issue is parsing the syntax.</p>



<a name="266513900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266513900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266513900">(Dec 31 2021 at 17:02)</a>:</h4>
<p>having more parens all over is a bad time. That's what makes cfg stuff terrible. So if at all possible, <code>const Default</code> is better than <code>Default(const)</code>.</p>



<a name="266516061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266516061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266516061">(Dec 31 2021 at 17:55)</a>:</h4>
<p>All these suggest using <code>#[derive_const(Default)]</code>: no extra params, and no need to tackle derive args as well. For those mentioning a _single_ keyword syntax, what of <code>#[derive(unsafe Send)]</code>, <code>#[derive(unsafe const Foo)]</code>, and so on?</p>
<p>I personally believe that having derives behave like attribute macros, and take args will end up being necessary. And for that, I'm afraid, we'll end up needing another layer of parens. But only one: inside them, the derive can feature whatever parsing they want:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(</span>
<span class="cp">    Debug, // sugar for `Debug()`</span>
<span class="cp">    Default(const),</span>
<span class="cp">    // in the future, to opt out of bounds:</span>
<span class="cp">    Default(const, bounds = impl&lt;T&gt;),</span>
<span class="cp">    // or directly:</span>
<span class="cp">    Default(impl&lt;T&gt; const),</span>
<span class="cp">]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>and, back to the "derive helpers" discussion:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(</span>
<span class="cp">    MyDerive(rename_helpers = my_derive, crate = some::path),</span>
<span class="cp">)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[my_derive = </span><span class="s">"…"</span><span class="cp">]</span><span class="w"></span>
<span class="w">    </span><span class="c1">// …</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="266518973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/266518973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#266518973">(Dec 31 2021 at 19:05)</a>:</h4>
<p>Hmm…I'm not necessarily opposed to permitting arbitrary tokens given the obvious future possibilities (both for stdlib and third-party crates). It's definitely something I'll have to think more about.</p>



<a name="267623437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/267623437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#267623437">(Jan 11 2022 at 18:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits/near/266479705">said</a>:</p>
<blockquote>
<p>Alternatively, you could add a derive helper attribute, and do something like <code>#[const_derive(Default, Debug, MyCustomDerive)]</code></p>
</blockquote>
<p>This makes me wonder, actually, how common would it be for some to be const but others not be const?</p>
<p>If one would need to have <code>#[derive(const Debug, const PartialEq, const Eq, const Hash, const Copy, const Clone)]</code> much of the time, I think it'd be nice to just have <code>#[const_derive(Debug, PartialEq, Eq, Hash, Copy, Clone)]</code> anyway.</p>
<p>(And then two attributes if you need some const and some non-const.)</p>



<a name="267624554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/267624554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#267624554">(Jan 11 2022 at 18:26)</a>:</h4>
<p>I personally think we shouldn't be separating non-const derives from const derives if we were to stabilize it that way. what about <code>#[derive(const(Debug, PartialEq, Eq, Hash, Clone, Copy), Default)]</code>?</p>



<a name="267670684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/267670684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#267670684">(Jan 12 2022 at 01:11)</a>:</h4>
<p>For what it's worth my viewpoint is now in favor of arbitrary tokens as a second parameter. I don't see having to repeat <code>const</code> as a huge cost, particularly given that each derive is its own logical item.</p>



<a name="267670750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/syntax/grammar%3A%20deriving%20const%20traits/near/267670750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/syntax.2Fgrammar.3A.20deriving.20const.20traits.html#267670750">(Jan 12 2022 at 01:12)</a>:</h4>
<p>Arbitrary tokens seems to be the simplest solution that provides const derives and <em>literally</em> anything else we might want in the future derive-wise.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>