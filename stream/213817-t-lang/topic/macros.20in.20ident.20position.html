<html>
<head><meta charset="utf-8"><title>macros in ident position · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html">macros in ident position</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264615699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264615699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264615699">(Dec 12 2021 at 10:30)</a>:</h4>
<p>What would it take to permit macros in an ident position? As far as I am aware this is the sole blocker to <code>concat_idents!</code>, and similar macros would certainly be useful.</p>



<a name="264615707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264615707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264615707">(Dec 12 2021 at 10:30)</a>:</h4>
<p>I just checked and it doesn't look like it even gets built into an AST.</p>



<a name="264647528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264647528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264647528">(Dec 12 2021 at 22:33)</a>:</h4>
<p>That might require some thought about forward compatibility and follow sets.</p>



<a name="264647994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264647994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264647994">(Dec 12 2021 at 22:45)</a>:</h4>
<p>Note that a <code>#[rename]</code> attribute would circumvent this issue altogether</p>



<a name="264648060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264648060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264648060">(Dec 12 2021 at 22:47)</a>:</h4>
<p>Because then <code>#[rename(concat_idents!(foo, bar))] fn whatever</code> or <code>#[rename(concat_idents!(foo, bar))] let whatever = …;</code> would Just Work (for the <code>let</code> bindings it should ensure there is only one free binding being created)</p>



<a name="264648117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264648117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264648117">(Dec 12 2021 at 22:48)</a>:</h4>
<p>It would, but that would also not naturally work with other things that parse a declaration and expect an ident.</p>



<a name="264648122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264648122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264648122">(Dec 12 2021 at 22:48)</a>:</h4>
<p>It doesn't nest, in particular.</p>



<a name="264648134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264648134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264648134">(Dec 12 2021 at 22:49)</a>:</h4>
<p>The ideal solution would allow two or more levels of nested "parse this declaration and create a new identifier based on the existing identifier".</p>



<a name="264648543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264648543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264648543">(Dec 12 2021 at 22:59)</a>:</h4>
<p>Fair enough; but being friendly to other macros is yet another big undertaking (eager expansion etc.): the preprocessor / callback style like <code>paste</code> or <a href="https://docs.rs/with_builtin_macros/latest/with_builtin_macros/macro.with_builtin.html">https://docs.rs/with_builtin_macros/latest/with_builtin_macros/macro.with_builtin.html</a> would likely be the simplest ways to achieve such a thing</p>



<a name="264650732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264650732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264650732">(Dec 12 2021 at 23:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/macros.20in.20ident.20position/near/264647528">said</a>:</p>
<blockquote>
<p>That might require some thought about forward compatibility and follow sets.</p>
</blockquote>
<p>Follow set? And what forward compatibility concerns would there be?</p>



<a name="264654454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264654454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264654454">(Dec 13 2021 at 01:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/213817-t-lang/topic/macros.20in.20ident.20position/near/264615699">said</a>:</p>
<blockquote>
<p>What would it take to permit macros in an ident position?</p>
</blockquote>
<p>Everything?<br>
Suppose you are in parser position to consume an identifier (that itself may be followed by <code>!</code> or <code>::</code>), how do you proceed?<br>
(I'm pretty sure it's possible to come up with somethin, either limit macro expansions to a subset of identifier positions, or come up with some disambiguation rules, but the point is that there's many more questions about how do you support this, than about what prevents supporting this.)</p>



<a name="264655336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264655336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264655336">(Dec 13 2021 at 01:38)</a>:</h4>
<p>and that's why I ask, because I hadn't considered edge cases like that. I presume permitting it everywhere would require infinite lookahead given the <code>!</code> possibility? And at least for <code>::</code>, I thought a path was parsed differently than an ident (no idea if this is actually the case)</p>



<a name="264655352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264655352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264655352">(Dec 13 2021 at 01:39)</a>:</h4>
<p>Limiting it to certain places would still be incredibly useful. I would imagine by far the most common is naming something such as <code>fn concat_idents!(…)</code>, <code>struct concat_idents!(…)</code>, and similar.</p>



<a name="264655440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264655440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264655440">(Dec 13 2021 at 01:41)</a>:</h4>
<p>My presumption is that a path is parsed as a sequence of idents, separated by <code>::</code>. I'm not certain this is the case though.</p>



<a name="264658337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264658337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264658337">(Dec 13 2021 at 02:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/213817-t-lang/topic/macros.20in.20ident.20position/near/264655440">said</a>:</p>
<blockquote>
<p>My presumption is that a path is parsed as a sequence of idents, separated by <code>::</code>. I'm not certain this is the case though.</p>
</blockquote>
<p>This is correct (there also may be some generic arguments in there).</p>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/213817-t-lang/topic/macros.20in.20ident.20position/near/264655352">said</a>:</p>
<blockquote>
<p>I would imagine by far the most common is naming something such as <code>fn concat_idents!(…)</code>, <code>struct concat_idents!(…)</code>, and similar.</p>
</blockquote>
<p>I think this specific subset shouldn't cause problems (at least during parsing) since it doesn't involve paths and <code>$ident</code> matchers in macros.</p>



<a name="264665794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264665794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264665794">(Dec 13 2021 at 05:36)</a>:</h4>
<p>Would an RFC/MCP be necessary to permit macros in that position? Or can I attempt to permit this (unstably) with just a PR?</p>



<a name="264674749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264674749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264674749">(Dec 13 2021 at 08:22)</a>:</h4>
<p>This is a large change deserving an RFC, IMO.</p>
<p>I'd also suggest prototyping identifier expansion in at least one position (e.g. function names) before submitting the RFC.<br>
One additional implementation complexity that I see here is macro expansion order, items are "planted" into modules after all their macro attributes are expanded, and expansion of all nested nodes in those items happen after that.<br>
However, to "plant" an item, its name must be known, which is not the case if we can have macros in the item name position.<br>
Perhaps this can be solved by treating macros in item name position in the same way as attributes, instead of treating them as nested nodes.</p>



<a name="264676711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264676711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264676711">(Dec 13 2021 at 08:47)</a>:</h4>
<p>I had an rfc for eager expansion a few years back. I think we considered ident position macros as an alternative (either in the rfc or discussion)</p>



<a name="264796203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264796203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264796203">(Dec 14 2021 at 01:44)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> not sure I follow. I've never worked with that part of the compiler.</p>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> You see this as an alternative to eager expansion?</p>



<a name="264858247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264858247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264858247">(Dec 14 2021 at 13:41)</a>:</h4>
<p>Yeah, one of the motivators for eager expansion iirc is to permit macro expansion of identifiers</p>



<a name="264870585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/macros%20in%20ident%20position/near/264870585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/macros.20in.20ident.20position.html#264870585">(Dec 14 2021 at 15:03)</a>:</h4>
<p>Well... At least now I know what I'm up against <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>