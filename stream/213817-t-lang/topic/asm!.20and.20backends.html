<html>
<head><meta charset="utf-8"><title>asm! and backends · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html">asm! and backends</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270223767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270223767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270223767">(Feb 01 2022 at 14:57)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> That kind of two-phase compilation without knowledge of code generation isn't something that Rust currently contemplates, given the need to handle cfg and similar very early.</p>



<a name="270223902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270223902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270223902">(Feb 01 2022 at 14:58)</a>:</h4>
<p>It would, as you note, require full knowledge of certain features in the first compile.</p>



<a name="270223938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270223938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270223938">(Feb 01 2022 at 14:58)</a>:</h4>
<p>Anything rust has a cfg for.</p>



<a name="270224159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224159">(Feb 01 2022 at 15:00)</a>:</h4>
<p>That's why xlang_target handles all of the target specific information. It has all of the cfgs rustc sets, a few more than lccc sets with a flag (<code>target_int_width</code>, <code>target_long_width</code> via <code>-Z set-cfg-properties-widths</code>), and basically all the information that it needs to be consistent.</p>



<a name="270224443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224443">(Feb 01 2022 at 15:01)</a>:</h4>
<p>(It knows about int/long/long long/long double width because the C frontend needs to know this)</p>



<a name="270224618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224618">(Feb 01 2022 at 15:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270201381">said</a>:</p>
<blockquote>
<p>Maybe a <code>#[cfg(compiler_asm_supported)]</code> could quickly be introduced for the optimization case?</p>
</blockquote>
<p><code>asm!</code> is target-specific, and I'd expect it to be supported on a target-by-target basis. People won't use it on a target that Rust doesn't support it on, but once Rust supports it on a target, I'd expect it to work on any backend for that target. We did carefully define it in a way that made it possible for any backend to support, so I don't think we should start adding a mechanism for backends to opt out and expecting crates to use that (which I don't expect them to do).</p>



<a name="270224708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224708">(Feb 01 2022 at 15:02)</a>:</h4>
<blockquote>
<p>carefully define it in a way that made it possible for any backend to support</p>
</blockquote>
<p>Heh.</p>



<a name="270224746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224746">(Feb 01 2022 at 15:03)</a>:</h4>
<p>I didn't say "support in the way that backend would prefer to support". :)</p>



<a name="270224776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224776">(Feb 01 2022 at 15:03)</a>:</h4>
<p>It's always <em>possible</em> to spawn an external assembler, even if it isn't preferable.</p>



<a name="270224806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270224806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270224806">(Feb 01 2022 at 15:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270224776">said</a>:</p>
<blockquote>
<p>It's always <em>possible</em> to spawn an external assembler, even if it isn't preferable.</p>
</blockquote>
<p>Unless you don't <em>have</em> one that is compatible.</p>



<a name="270225002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225002">(Feb 01 2022 at 15:04)</a>:</h4>
<p>If I'm on msvc host/target, I at best know I have <code>ml.exe</code>. Which is definately not GNU as compatible in the slightest.</p>



<a name="270225167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225167">(Feb 01 2022 at 15:05)</a>:</h4>
<p>And it is more than preferable that lccc not introduce any additional non-vendored runtime dependencies that the C compiler for a particular platform itself has - it's basically necessary to compete in that space.</p>



<a name="270225310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225310">(Feb 01 2022 at 15:06)</a>:</h4>
<p>You could always emit an error if and only if someone uses <code>asm!</code> saying that they need to install llvm-as.</p>



<a name="270225338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225338">(Feb 01 2022 at 15:06)</a>:</h4>
<p>Again, not saying it's ideal, just that it's <em>possible</em>.</p>



<a name="270225435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225435">(Feb 01 2022 at 15:07)</a>:</h4>
<p>You could also ship a separate binary that links to LLVM and internally uses its asm support, if you prefer to put it in your own wrapper interface.</p>



<a name="270225504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225504">(Feb 01 2022 at 15:07)</a>:</h4>
<p>That also means that asm requires to be run on a host that supports either llvm or gnu as.</p>



<a name="270225700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225700">(Feb 01 2022 at 15:08)</a>:</h4>
<p>Why is it called <code>asm!</code> instead of <code>llvm_asm!</code>? It's apparently still tied up with LLVM</p>



<a name="270225812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225812">(Feb 01 2022 at 15:08)</a>:</h4>
<p>at least if <code>llvm_asm!</code> got stabilized then it would make sense for it to be explicitly non-portable to other backends</p>



<a name="270225830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225830">(Feb 01 2022 at 15:08)</a>:</h4>
<p>The platform I can think of that being the case on is wasm, which I definately do want to support hosting on.</p>



<a name="270225909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225909">(Feb 01 2022 at 15:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270225830">said</a>:</p>
<blockquote>
<p>The platform I can think of that being the case on is wasm, which I definately do want to support hosting on.</p>
</blockquote>
<p>LLVM should run just fine in WebAssembly.</p>



<a name="270225982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270225982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270225982">(Feb 01 2022 at 15:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270225700">said</a>:</p>
<blockquote>
<p>Why is it called <code>asm!</code> instead of <code>llvm_asm!</code>? It's apparently still tied up with LLVM</p>
</blockquote>
<p>Or do what C++ does, which is just say its <em>conditionally-supported</em> with <em>implementation-defined</em> semantics.</p>



<a name="270226146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226146">(Feb 01 2022 at 15:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270225982">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270225700">said</a>:</p>
<blockquote>
<p>Why is it called <code>asm!</code> instead of <code>llvm_asm!</code>? It's apparently still tied up with LLVM</p>
</blockquote>
<p>Or do what C++ does, which is just say its <em>conditionally-supported</em> with <em>implementation-defined</em> semantics.</p>
</blockquote>
<p>A world of <em>nope</em> to anything "implementation-defined" in Rust.</p>



<a name="270226261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226261">(Feb 01 2022 at 15:10)</a>:</h4>
<p>I'm hoping to make <code>asm!</code> future compatible with a version that is actually backend-portable (by parsing the string and supporting a portable subset); would the C++ word salad enable that?</p>



<a name="270226264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226264">(Feb 01 2022 at 15:10)</a>:</h4>
<p>To the extent we have a Rust spec in the future, I'm very much hoping it's "here's exactly how Rust works, with no wiggle-room and no implementation-specific variation".</p>



<a name="270226405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226405">(Feb 01 2022 at 15:11)</a>:</h4>
<p>A lot of things are already implementation-defined.<br>
Whether or not overflow is panic or wrapping is implementation-defined.<br>
The target is implementation-defined.<br>
Arguably, <code>size_of::&lt;usize&gt;()</code>/pointers is implementation-defined (but constrained on well-known targets).</p>



<a name="270226582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226582">(Feb 01 2022 at 15:12)</a>:</h4>
<p>And even more things are unspecified, which is implementation-defined but not required to be documented:<br>
Layout of repr(Rust) types and of tuples.<br>
ABI of <code>extern "Rust"</code> functions.</p>



<a name="270226617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226617">(Feb 01 2022 at 15:12)</a>:</h4>
<p>I am deeply concerned about the effect of the current version of <code>asm!</code> wrt the eventual specification. The PR is underspecified regarding the legal syntax in those strings, and I can't see how you would avoid copy-pasting the entire specification of GNU <code>as</code> into rust's spec. Plus I'm not even sure such a GNU <code>as</code> spec even exists</p>



<a name="270226619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226619">(Feb 01 2022 at 15:12)</a>:</h4>
<p>At the moment, <code>size_of::&lt;usize&gt;()</code> is well-defined in one way; we're <em>talking</em> about making it well-defined with a <em>different</em> meaning, but it's not implementation-defined.</p>



<a name="270226712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226712">(Feb 01 2022 at 15:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270226617">said</a>:</p>
<blockquote>
<p>I am deeply concerned about the effect of the current version of <code>asm!</code> wrt the eventual specification. The PR is underspecified regarding the legal syntax in those strings, and I can't see how you would avoid copy-pasting the entire specification of GNU <code>as</code> into rust's spec. Plus I'm not even sure such a GNU <code>as</code> spec even exists</p>
</blockquote>
<p>People actually <em>use</em> those assembler directives in inline assembler; there are important mechanisms you can't achieve without them.</p>



<a name="270226753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226753">(Feb 01 2022 at 15:13)</a>:</h4>
<p>Unless the spec codifies the exhaustive list of targets that an implementation is permitted to support, which I would be very much against, you will necessarily have implementation-defined behaviour.</p>



<a name="270226772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226772">(Feb 01 2022 at 15:13)</a>:</h4>
<p>I'm not saying you can't use directives. I'm saying that you should document what directives are supported</p>



<a name="270226788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226788">(Feb 01 2022 at 15:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270226582">said</a>:</p>
<blockquote>
<p>And even more things are unspecified, which is implementation-defined but not required to be documented:<br>
Layout of repr(Rust) types and of tuples.<br>
ABI of <code>extern "Rust"</code> functions.</p>
</blockquote>
<p>For the purposes of a spec, those are "not a thing you can depend on at all", rather than "implementation-defined".</p>



<a name="270226929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226929">(Feb 01 2022 at 15:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270226772">said</a>:</p>
<blockquote>
<p>I'm not saying you can't use directives. I'm saying that you should document what directives are supported</p>
</blockquote>
<p>We did: "the subset supported by both LLVM and GNU AS". If someone wants to turn that into an exhaustive list of directives, they can, but nobody volunteered to do that. :)</p>



<a name="270226940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270226940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270226940">(Feb 01 2022 at 15:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270226788">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270226582">said</a>:</p>
<blockquote>
<p>And even more things are unspecified, which is implementation-defined but not required to be documented:<br>
Layout of repr(Rust) types and of tuples.<br>
ABI of <code>extern "Rust"</code> functions.</p>
</blockquote>
<p>For the purposes of a spec, those are "not a thing you can depend on at all", rather than "implementation-defined".</p>
</blockquote>
<p>"not a thing you can depend on at all" is not a specification.<br>
For the purposes of the specification, it would be unspecified behaviour.</p>



<a name="270227095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227095">(Feb 01 2022 at 15:15)</a>:</h4>
<p>There's a difference between "this is implementation-defined (but presumably specific and you could count on one implementation's behavior)" and "you can never count on this, it could change arbitrarily and you can't depend on it even within one implementation".</p>



<a name="270227148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227148">(Feb 01 2022 at 15:15)</a>:</h4>
<p>deferring to GNU AS is just kicking the can down the road, and I'm worried we'll realize after it is too late to change that we opted into some horrible edge case by doing so</p>



<a name="270227234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227234">(Feb 01 2022 at 15:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270226753">said</a>:</p>
<blockquote>
<p>Unless the spec codifies the exhaustive list of targets that an implementation is permitted to support, which I would be very much against, you will necessarily have implementation-defined behaviour.</p>
</blockquote>
<p>Rust has target-specific behavior, and a complete spec would necessarily <em>have</em> to document the target-specific behavior for each supported target.</p>



<a name="270227304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227304">(Feb 01 2022 at 15:16)</a>:</h4>
<p>It's not a matter of "targets that an implementation is permitted to support" (though it would have that net effect), it's "what is the target named, what behavior does it have, what choices does it make", etc.</p>



<a name="270227358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227358">(Feb 01 2022 at 15:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270227095">said</a>:</p>
<blockquote>
<p>There's a difference between "this is implementation-defined (but presumably specific and you could count on one implementation's behavior)" and "you can never count on this, it could change arbitrarily and you can't depend on it even within one implementation".</p>
</blockquote>
<p>Yes, there is. The former requires the implementation to document it's choice, and the latter does not require that.</p>



<a name="270227420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227420">(Feb 01 2022 at 15:17)</a>:</h4>
<p>You can't even necessarily rely on implementation-defined behaviour being consistent: The implementation would simply be required to document <em>how</em> it is inconsistent.</p>



<a name="270227432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227432">(Feb 01 2022 at 15:17)</a>:</h4>
<p>Well, Rust does not document the layout of <code>extern "Rust"</code> or the calling ABI, so I think that's consistent with what I said above. :)</p>



<a name="270227479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227479">(Feb 01 2022 at 15:18)</a>:</h4>
<p>Exactly. It's <em>unspecified</em> in terms of C/++.</p>



<a name="270227522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227522">(Feb 01 2022 at 15:18)</a>:</h4>
<p>Hence why for the present I would want some wording that is at least consistent with a future version of <code>asm!</code> that is fully implemented in rust. Switching from <code>llvm_asm</code> to <code>rust_asm</code> could break some things so we need a stability guarantee that accommodates this possibility</p>



<a name="270227543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227543">(Feb 01 2022 at 15:18)</a>:</h4>
<p>C++'s "unspecified" does that</p>



<a name="270227583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227583">(Feb 01 2022 at 15:18)</a>:</h4>
<p>but it might also be a bit too heavy of a hammer</p>



<a name="270227619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227619">(Feb 01 2022 at 15:18)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> There's nothing preventing us from fully implementing <code>asm!</code> in Rust today, it'd just be a great deal of work.</p>



<a name="270227637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227637">(Feb 01 2022 at 15:18)</a>:</h4>
<p>(And an implementation <em>can</em> choose to document it's choices for unspecified behaviour, and commit to allowing users to rely on it)</p>



<a name="270227701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227701">(Feb 01 2022 at 15:19)</a>:</h4>
<p>Sorry if it was already mentioned but <a href="https://github.com/rust-lang/rustc_codegen_gcc/">rustc_codegen_gcc</a> successfully <a href="https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/asm.rs">implemented</a> the new <code>asm!</code>syntax.</p>



<a name="270227722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227722">(Feb 01 2022 at 15:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270227637">said</a>:</p>
<blockquote>
<p>(And an implementation <em>can</em> choose to document it's choices for unspecified behaviour, and commit to allowing users to rely on it)</p>
</blockquote>
<p>And code relying on that would not be Rust code anymore, it'd be some variant of Rust.</p>



<a name="270227731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227731">(Feb 01 2022 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span>  I think you would have huge problems with getting results perfectly compatible with LLVM / GNU as if you actually tried</p>



<a name="270227774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227774">(Feb 01 2022 at 15:19)</a>:</h4>
<p>(I've already chosen to do this with lccc, via the lcrust v0 abi, which specifies the layout/abi choices of lccc and others that choose to support it)</p>



<a name="270227778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227778">(Feb 01 2022 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> LLVM managed to do it.</p>



<a name="270227832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227832">(Feb 01 2022 at 15:19)</a>:</h4>
<p>by definition?</p>



<a name="270227833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227833">(Feb 01 2022 at 15:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270227774">said</a>:</p>
<blockquote>
<p>(I've already chosen to do this with lccc, via the lcrust v0 abi, which specifies the layout/abi choices of lccc and others that choose to support it)</p>
</blockquote>
<p>And while I hope you enjoy working on it, I also hope nobody ever counts on that.</p>



<a name="270227961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227961">(Feb 01 2022 at 15:20)</a>:</h4>
<p>there isn't actually a spec here, you literally said "whatever LLVM and GNU AS" supports. Of course LLVM supports that</p>



<a name="270227965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270227965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270227965">(Feb 01 2022 at 15:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270227832">said</a>:</p>
<blockquote>
<p>by definition?</p>
</blockquote>
<p>No, by continuing to implement their assembler support and add to it as long as they ran into real-world code that used more functionality of it.</p>



<a name="270228114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228114">(Feb 01 2022 at 15:21)</a>:</h4>
<p>Ignoring what Rust <code>asm!</code> supports specifically for the moment, LLVM's assembler support pretty much took GNU AS as a spec and implemented the vast majority of it, because they <em>had</em> to for real-world inline asm compatibility.</p>



<a name="270228131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228131">(Feb 01 2022 at 15:21)</a>:</h4>
<p>but if you want to implement that in a third assembler (like lccc), then that spec is lacking, you need an actual listing of what it can do</p>



<a name="270228206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228206">(Feb 01 2022 at 15:21)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> We have a <em>lot</em> of things for which a "spec" is lacking, and you have to look at what rustc does.</p>



<a name="270228328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228328">(Feb 01 2022 at 15:22)</a>:</h4>
<p>I'm not arguing that that's a feature, necessarily, but asm is not unique or even unusual in that regard.</p>



<a name="270228336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228336">(Feb 01 2022 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270227833">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270227774">said</a>:</p>
<blockquote>
<p>(I've already chosen to do this with lccc, via the lcrust v0 abi, which specifies the layout/abi choices of lccc and others that choose to support it)</p>
</blockquote>
<p>And while I hope you enjoy working on it, I also hope nobody ever counts on that.</p>
</blockquote>
<p>I actually do in lccc (host), in two ways:</p>
<ul>
<li>proc-macros will be implemented via FFI using the extern "Rust" abi (this was the origin of the abi - I refuse to rely on multiple sources of truth for the ABI agreeing)</li>
<li>If I know that the host compiler supports the ABI (by which I mean I ask it nicely), I optimize certain defintions that emulate features to simply rely on that ABI. </li>
</ul>
<p>You can't necessarily even count on it in lccc (absent building with the <code>-Z build-abi</code> option), since it says you can rely on "it or a future version", but you can test the compiler and polyfill when unsupported.</p>



<a name="270228372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228372">(Feb 01 2022 at 15:22)</a>:</h4>
<p>Looking at what rustc does is one thing, looking at rustc, llvm, and gnu AS is quite another</p>



<a name="270228491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228491">(Feb 01 2022 at 15:23)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> The difference here is that instead of "it's completely unspecified", the answer is instead "it's specified somewhere else by another tool", and that seems to be seen as <em>worse</em> than just "unspecified".</p>



<a name="270228565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228565">(Feb 01 2022 at 15:23)</a>:</h4>
<p>at least everything in rust nominally goes through the RFC process. Here we're opting in to a huge spec no one has cared to look into in detail</p>



<a name="270228577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228577">(Feb 01 2022 at 15:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270228491">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> The difference here is that instead of "it's completely unspecified", the answer is instead "it's specified somewhere else by another tool", and that seems to be seen as <em>worse</em> than just "unspecified".</p>
</blockquote>
<p>It is, yes.</p>



<a name="270228600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228600">(Feb 01 2022 at 15:23)</a>:</h4>
<p>it feels like an end-run around the RFC system</p>



<a name="270228861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228861">(Feb 01 2022 at 15:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270228565">said</a>:</p>
<blockquote>
<p>at least everything in rust nominally goes through the RFC process. Here we're opting in to a huge spec no one has cared to look into in detail</p>
</blockquote>
<p>It's also a fun thing for implementors. I didn't even see that this was a thing until mid december (when I was busy with exams, and then the x86 backend for use with the C frontend).</p>



<a name="270228864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270228864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270228864">(Feb 01 2022 at 15:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270228577">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270228491">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> The difference here is that instead of "it's completely unspecified", the answer is instead "it's specified somewhere else by another tool", and that seems to be seen as <em>worse</em> than just "unspecified".</p>
</blockquote>
<p>It is, yes.</p>
</blockquote>
<p>I wasn't using "unspecified" in a spec sense, as in "implementations can do whatever they want". I was using "unspecified' in the sense of "this RFC doesn't document it, so it'll have to get specified when we implement it in Rust".</p>



<a name="270229007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229007">(Feb 01 2022 at 15:26)</a>:</h4>
<p>Which is roughly what we would have ended up doing if we hadn't nailed it down <em>more</em> precisely to "support the common subset of LLVM and GNU AS".</p>



<a name="270229054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229054">(Feb 01 2022 at 15:26)</a>:</h4>
<p>It seems like the RFC documented <em>more</em> than it would need to, and that's being seen as worse than documenting <em>less</em>.</p>



<a name="270229055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229055">(Feb 01 2022 at 15:26)</a>:</h4>
<p>Yeah, and the common subset is great for llvm, and arguably for gcc.</p>



<a name="270229088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229088">(Feb 01 2022 at 15:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270229054">said</a>:</p>
<blockquote>
<p>It seems like the RFC documented <em>more</em> than it would need to, and that's being seen as worse than documenting <em>less</em>.</p>
</blockquote>
<p>Yes, that is exactly the issue here.</p>



<a name="270229132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229132">(Feb 01 2022 at 15:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270229055">said</a>:</p>
<blockquote>
<p>Yeah, and the common subset is great for llvm, and arguably for gcc.</p>
</blockquote>
<p>This seems like it's coming very close to "Rust should have required less, so that an implementation could get away with doing less and not be seen as incompatible with Rust".</p>



<a name="270229165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229165">(Feb 01 2022 at 15:27)</a>:</h4>
<p>To the extent the language in the RFC is preventing that, it's working as intended.</p>



<a name="270229188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229188">(Feb 01 2022 at 15:27)</a>:</h4>
<p>yes... that's the reality</p>



<a name="270229378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229378">(Feb 01 2022 at 15:28)</a>:</h4>
<p><code>asm!</code> as currently implemented does not have neat bounds on when it works, so if when we get around to writing those bounds we find some things in LLVM / GNU AS can't be supported, then we need the flexibility to be able to say that actually it wasn't supported after all and it was just an accident that it happened to work</p>



<a name="270229442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229442">(Feb 01 2022 at 15:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270229165">said</a>:</p>
<blockquote>
<p>To the extent the language in the RFC is preventing that, it's working as intended.</p>
</blockquote>
<p>Yes, I am not disputing that the language in the RFC is not doing what it's supposed to. The defect is in the design itself, rather than the wording.</p>



<a name="270229528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229528">(Feb 01 2022 at 15:29)</a>:</h4>
<p>FWIW, to get a little less abstract, and more concrete about potential next steps: I would be <em>completely</em> sympathetic to a documentation patch that specifically excluded the GNU AS macro directives, as being something we don't support.</p>



<a name="270229622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229622">(Feb 01 2022 at 15:30)</a>:</h4>
<p>I'm <em>not</em> going to say that, if people end up using them anyway because they happen to work, we're going to break that in the future and say "well, we warned you".</p>



<a name="270229651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229651">(Feb 01 2022 at 15:30)</a>:</h4>
<p>But I do think it'd be reasonable to document that those specific directives aren't intended to be supported, and encourage people to not use them.</p>



<a name="270229758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270229758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270229758">(Feb 01 2022 at 15:31)</a>:</h4>
<p>I'm confused. The directives are not supported but we can't stop supporting them?</p>



<a name="270230064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230064">(Feb 01 2022 at 15:32)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> As an analogous situation: We have, in the past, had documentation saying "don't rely on X" in the library documentation. If in the future we actually want to change X, we still very carefully check if anyone is <em>relying</em> on X, and if they are, the existence of the comment does not automatically make that <em>not</em> a breaking change and give us carte blanche to say "we warned you!".</p>



<a name="270230090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230090">(Feb 01 2022 at 15:33)</a>:</h4>
<p>Yeah, that's a common problem with rust. Hyrum's law is taken as gospel instead of a reason to break some legs.</p>



<a name="270230128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230128">(Feb 01 2022 at 15:33)</a>:</h4>
<p>Saying "X is unsupported" is valid, it would fall back to "assembler-specific behaviour"</p>



<a name="270230153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230153">(Feb 01 2022 at 15:33)</a>:</h4>
<p>Why even write specs if people can just force hands by making a popular lib relying on implementation details</p>



<a name="270230159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230159">(Feb 01 2022 at 15:33)</a>:</h4>
<p>Sometimes we very carefully change X anyway, either because we don't think anyone will actually break, or because it's extremely important and <em>very few</em> projects will break.</p>



<a name="270230292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230292">(Feb 01 2022 at 15:34)</a>:</h4>
<p>But we don't consider a comment or doc saying "don't rely on X" to be a complete defense against anyone relying on X <em>anyway</em>.</p>



<a name="270230389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230389">(Feb 01 2022 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270230153">said</a>:</p>
<blockquote>
<p>Why even write specs if people can just force hands by making a popular lib relying on implementation details</p>
</blockquote>
<p>That's an <em>excellent</em> question, and I find myself asking forms of that question every time the concept of a "Rust spec" comes up. ;)</p>



<a name="270230458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230458">(Feb 01 2022 at 15:35)</a>:</h4>
<p>That's kind to users, but it might be unkind to other implementations because they'd have to reproduce implementation details rather than matching the spec.</p>



<a name="270230559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230559">(Feb 01 2022 at 15:35)</a>:</h4>
<p>Indeed.</p>



<a name="270230577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230577">(Feb 01 2022 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270230458">said</a>:</p>
<blockquote>
<p>That's kind to users, but it might be unkind to other implementations because they'd have to reproduce implementation details rather than matching the spec.</p>
</blockquote>
<p>On balance, I'd prefer to be kind to users we actually have, and strict (strictness is not inherently unkind) with other implementations.</p>



<a name="270230657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230657">(Feb 01 2022 at 15:36)</a>:</h4>
<p>Which is to say, I'd prefer a hypothetical spec to say "do exactly this" with as little wiggle-room as possible.</p>



<a name="270230744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230744">(Feb 01 2022 at 15:36)</a>:</h4>
<p>I would actually much prefer that in this particular case</p>



<a name="270230756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230756">(Feb 01 2022 at 15:36)</a>:</h4>
<p>there should just be an asm grammar</p>



<a name="270230864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230864">(Feb 01 2022 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> other implementations is also a future rustc ;)</p>



<a name="270230868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230868">(Feb 01 2022 at 15:36)</a>:</h4>
<p>In my case, my decision when it's docuemented as "X is not stable" is that I won't necessarily break X, but I won't necessarily adhere to X either.<br>
In some cases, I will introduce an option to deliberately break X.</p>



<a name="270230876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270230876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270230876">(Feb 01 2022 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> FWIW, if someone were to write up an asm grammar for the intersection-of-GNU-AS-and-LLVM that we support, I'd be <em>thrilled</em> to merge that.</p>



<a name="270231026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231026">(Feb 01 2022 at 15:37)</a>:</h4>
<p>Suppose that we did that, but then LLVM and/or GNU AS got better behind our backs. Would we need to change the spec?</p>



<a name="270231127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231127">(Feb 01 2022 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270230864">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> other implementations is also a future rustc ;)</p>
</blockquote>
<p>Or rustc w/ future target.</p>



<a name="270231210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231210">(Feb 01 2022 at 15:38)</a>:</h4>
<p>Or, in this case, rustc w/ !LLVM backend.</p>



<a name="270231241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231241">(Feb 01 2022 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231127">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270230864">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> other implementations is also a future rustc ;)</p>
</blockquote>
<p>Or rustc w/ future target.</p>
</blockquote>
<p>Yes, when we make design decisions we have to think about future targets that might be supported, and whether we're closing off such targets. We do that regularly now.</p>



<a name="270231349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231349">(Feb 01 2022 at 15:39)</a>:</h4>
<p>Sure, now. <em>Stares at usize</em>.</p>



<a name="270231359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231359">(Feb 01 2022 at 15:39)</a>:</h4>
<p>Example: we currently make it harder to write code that assumes 32-bit or 64-bit, because we <em>support</em> 16-bit and 128-bit; I'd love to see <code>let x: u64 = some_usize.into()</code> Just Work, but we are deferring that until we have the portability lint.</p>



<a name="270231441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231441">(Feb 01 2022 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270230876">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> FWIW, if someone were to write up an asm grammar for the intersection-of-GNU-AS-and-LLVM that we support, I'd be <em>thrilled</em> to merge that.</p>
</blockquote>
<p>This would be great, but it needs a lot of requirements gathering and design work and I don't think it's possible to get done before the next stable</p>



<a name="270231459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231459">(Feb 01 2022 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231349">said</a>:</p>
<blockquote>
<p>Sure, now. <em>Stares at usize</em>.</p>
</blockquote>
<p>Yes, that's an example. We have to make exactly that kind of decision there, where there are tradeoffs either way.</p>



<a name="270231508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231508">(Feb 01 2022 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231441">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270230876">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> FWIW, if someone were to write up an asm grammar for the intersection-of-GNU-AS-and-LLVM that we support, I'd be <em>thrilled</em> to merge that.</p>
</blockquote>
<p>This would be great, but it needs a lot of requirements gathering and design work and I don't think it's possible to get done before the next stable</p>
</blockquote>
<p>I agree. But I also don't think it's a blocker.</p>



<a name="270231646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231646">(Feb 01 2022 at 15:40)</a>:</h4>
<p>We're <em>definitely</em> not going to be able to <em>implement</em> anything that parses and restricts <code>asm!</code> before the next stable, or likely before a half-dozen stables from now.</p>



<a name="270231647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231647">(Feb 01 2022 at 15:40)</a>:</h4>
<p>Suppose we did all that work for the <em>next</em> stable. How would it not be a breaking change?</p>



<a name="270231720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231720">(Feb 01 2022 at 15:41)</a>:</h4>
<p>I think that for asm!, either a limited subset is DR'd into the spec in now right before stable, or we need that list.</p>



<a name="270231745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231745">(Feb 01 2022 at 15:41)</a>:</h4>
<p>("DRed"?)</p>



<a name="270231772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231772">(Feb 01 2022 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231647">said</a>:</p>
<blockquote>
<p>Suppose we did all that work for the <em>next</em> stable. How would it not be a breaking change?</p>
</blockquote>
<p>Because we already said "intersection of GNU AS and LLVM", and if we translate that into "specific list of what's supported by that intersection", that's not a breaking change, that's just more complete documentation.</p>



<a name="270231808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231808">(Feb 01 2022 at 15:41)</a>:</h4>
<p>Defect Report. C++ term for "We hecked up on the published standard, so we're retroactively fixing that".</p>



<a name="270231913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231913">(Feb 01 2022 at 15:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231026">said</a>:</p>
<blockquote>
<p>Suppose that we did that, but then LLVM and/or GNU AS got better behind our backs. Would we need to change the spec?</p>
</blockquote>
<p>If we had a complete list, I'd expect that we'd need to consider updating that list each time there's a new feature supported by both of those.</p>



<a name="270231961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231961">(Feb 01 2022 at 15:42)</a>:</h4>
<p>I don't expect that to actually happen very often, and we could consider it when it happens.</p>



<a name="270231976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231976">(Feb 01 2022 at 15:42)</a>:</h4>
<p>IMO (and clearly not exclusively my opinion) is that the semantics as-specified for asm is a defect because it's too restrictive on implementors.</p>



<a name="270231991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270231991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270231991">(Feb 01 2022 at 15:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231772">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231647">said</a>:</p>
<blockquote>
<p>Suppose we did all that work for the <em>next</em> stable. How would it not be a breaking change?</p>
</blockquote>
<p>Because we already said "intersection of GNU AS and LLVM", and if we translate that into "specific list of what's supported by that intersection", that's not a breaking change, that's just more complete documentation.</p>
</blockquote>
<p>This ties our hands to support <em>everything</em> in GNU AS / LLVM, rather than everything sane that has a nonzero number of uses</p>



<a name="270232073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232073">(Feb 01 2022 at 15:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231976">said</a>:</p>
<blockquote>
<p>IMO (and clearly not exclusively my opinion) is that the semantics as-specified for asm is a defect because it's too restrictive.</p>
</blockquote>
<p>Observation: your use of "restrictive" is using compiler-colored glasses here, because from the <em>user's</em> perspective it's <em>less</em> restrictive and the change you're proposing would be <em>more</em> restrictive.</p>



<a name="270232143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232143">(Feb 01 2022 at 15:43)</a>:</h4>
<p>(just saw that you edited your message to that effect)</p>



<a name="270232169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232169">(Feb 01 2022 at 15:43)</a>:</h4>
<p>Yes, I am speaking as an implementor here, because right now that perspective outweighs my perspective as a user.</p>



<a name="270232239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232239">(Feb 01 2022 at 15:44)</a>:</h4>
<p>Counterpoint: It gives the user more certainty that their code will actually be portable</p>



<a name="270232350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232350">(Feb 01 2022 at 15:44)</a>:</h4>
<p>In the case of a more restrictive (from a users perspective) subset, I can always switch to using outline assembly, which I already do anyways (even in languages that have inline asm support, or that have inline asm "support").</p>



<a name="270232354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232354">(Feb 01 2022 at 15:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231991">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231772">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270231647">said</a>:</p>
<blockquote>
<p>Suppose we did all that work for the <em>next</em> stable. How would it not be a breaking change?</p>
</blockquote>
<p>Because we already said "intersection of GNU AS and LLVM", and if we translate that into "specific list of what's supported by that intersection", that's not a breaking change, that's just more complete documentation.</p>
</blockquote>
<p>This ties our hands to support <em>everything</em> in GNU AS / LLVM, rather than everything sane that has a nonzero number of uses</p>
</blockquote>
<p>Or "everything that has a nonzero number of users by the time we finish documenting it", which is a different statement.</p>



<a name="270232432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232432">(Feb 01 2022 at 15:45)</a>:</h4>
<p>Oh, is this a tree falls in the forest thing? It's not a spec break if no one noticed</p>



<a name="270232483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232483">(Feb 01 2022 at 15:45)</a>:</h4>
<p>Probably the easiest set to stabilize now is "labels+instructions in target-specific format", though that may be too restrictive on users.</p>



<a name="270232489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232489">(Feb 01 2022 at 15:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232432">said</a>:</p>
<blockquote>
<p>Oh, is this a tree falls in the forest thing? It's not a spec break if no one noticed</p>
</blockquote>
<p>Lovely thing about not actually having a Rust spec; we <em>do</em> sometimes use a combination of crater and code searches to give ourselves confidence that nobody will notice a change. ;)</p>



<a name="270232566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232566">(Feb 01 2022 at 15:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232483">said</a>:</p>
<blockquote>
<p>Probably the easiest set to stabilize is now "labels+instructions in target-specific format", though that may be too restrictive on users.</p>
</blockquote>
<p>Substantially too restrictive, yes; there are quite a few directives people actually need.</p>



<a name="270232569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232569">(Feb 01 2022 at 15:46)</a>:</h4>
<p>That's the upside of hyrum's law I suppose. But I don't like that tradeoff.</p>



<a name="270232586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232586">(Feb 01 2022 at 15:46)</a>:</h4>
<p>Yeah, same.</p>



<a name="270232597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232597">(Feb 01 2022 at 15:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232569">said</a>:</p>
<blockquote>
<p>That's the upside of hyrum's law I suppose. But I don't like that tradeoff.</p>
</blockquote>
<p>I'm not suggesting it's ideal, it's just where we're at.</p>



<a name="270232646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232646">(Feb 01 2022 at 15:46)</a>:</h4>
<p>Even if we <em>had</em> a spec, I still have no intention of using the spec to hit users over the head and say "you're doing Rust wrong, it's OK that we broke you!".</p>



<a name="270232709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232709">(Feb 01 2022 at 15:47)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> FWIW, I also don't think we need a complete specification of asm grammar in order to improve anything here.</p>



<a name="270232731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232731">(Feb 01 2022 at 15:47)</a>:</h4>
<p>I think it'd help to just say "here's the list of directives we support".</p>



<a name="270232794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232794">(Feb 01 2022 at 15:47)</a>:</h4>
<p>If it turns out someone relied on the one thing that is nearly impossible to implement, then we have the same situtation as it is now: You need llvm or GNU as, and if neither exists or can exist, you're SOL.</p>



<a name="270232819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232819">(Feb 01 2022 at 15:48)</a>:</h4>
<p>that seems fine to me, assuming that we can rely on the base grammar being reasonably sane and specifiable at a future date</p>



<a name="270232928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232928">(Feb 01 2022 at 15:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232794">said</a>:</p>
<blockquote>
<p>If it turns out someone relied on the one thing that is nearly impossible to implement, then we have the same situtation as it is now: You need llvm or GNU as, and if neither exists or can exist, you're SOL.</p>
</blockquote>
<p>Or someone would need to implement a new assembler-implementation library, and use that. Which on balance doesn't seem <em>harder</em> than implementing a complete Rust implementation...</p>



<a name="270232953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232953">(Feb 01 2022 at 15:48)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> If you wanted to look at the docs for LLVM and for GNU AS, and write down the subset of directives supported by both (and then we can prune out a couple like macro syntax), that seems like the primary issue here.</p>



<a name="270232999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270232999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270232999">(Feb 01 2022 at 15:48)</a>:</h4>
<p>Well, hitting users for its own sake is silly of course. But if there's a desirable implementation change permitted by a spec and the only thing that's blocking it is some non-spec-compliant user code... then yeah, that's what a spec is for and breaking legs should be ok. Being nice in my book means warning people about it, not not doing the thing.</p>



<a name="270233061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233061">(Feb 01 2022 at 15:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232646">said</a>:</p>
<blockquote>
<p>Even if we <em>had</em> a spec, I still have no intention of using the spec to hit users over the head and say "you're doing Rust wrong, it's OK that we broke you!".</p>
</blockquote>
<p>IDK, people will rely on things that are explicitly said to not be stable. There are users that rely on repr(Rust), either deliberately or by accident.</p>



<a name="270233133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233133">(Feb 01 2022 at 15:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232999">said</a>:</p>
<blockquote>
<p>Well, hitting users for its own sake is silly of course. But if there's a desirable implementation change permitted by a spec and the only thing that's blocking it is some non-spec-compliant user code... then yeah, that's what a spec is for and breaking legs should be ok.</p>
</blockquote>
<p>People thinking a spec is an excuse to break people are <em>exactly</em> why I hope we don't have a spec anytime soon. ;)</p>



<a name="270233349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233349">(Feb 01 2022 at 15:50)</a>:</h4>
<p>It's not an excuse. It's part of the purpose! Imo.<br>
You rely on users not doing things. Users rely on you doing what the spec says. Mutual obligations.</p>



<a name="270233382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233382">(Feb 01 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270233061">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270232646">said</a>:</p>
<blockquote>
<p>Even if we <em>had</em> a spec, I still have no intention of using the spec to hit users over the head and say "you're doing Rust wrong, it's OK that we broke you!".</p>
</blockquote>
<p>IDK, people will rely on things that are explicitly said to not be stable. There are users that rely on repr(Rust), either deliberately or by accident.</p>
</blockquote>
<p>Right, and if that's the case, we'll take care when changing it and make a <em>deliberate</em> decision based on the tradeoffs of breaking people vs improving something, rather than either saying "we can't change it, people counted on it even though they shouldn't" <em>or</em> saying "we can just change it without worrying about it, they shouldn't have relied on it".</p>



<a name="270233457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233457">(Feb 01 2022 at 15:51)</a>:</h4>
<p>C++ doesn't even think that a spec is on-its-own an excuse to break people.<br>
C++ actively tries to avoid breaking things it even doesn't guarantee, such as ABI.<br>
However, it can be combined with a rationale purpose for breaking it.</p>



<a name="270233460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233460">(Feb 01 2022 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270233349">said</a>:</p>
<blockquote>
<p>It's not an excuse. It's part of the purpose!</p>
</blockquote>
<p>I think you're making my point for me. ;)</p>



<a name="270233542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233542">(Feb 01 2022 at 15:51)</a>:</h4>
<p>(For example, when <code>std::string</code> was barred in C++11 from being CoW because C++ decided it wanted the stdlib to be thread safe)</p>



<a name="270233744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233744">(Feb 01 2022 at 15:52)</a>:</h4>
<p>(Or when <code>noexcept</code> became type-level in C++17, and broke name mangling)</p>



<a name="270233960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270233960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270233960">(Feb 01 2022 at 15:53)</a>:</h4>
<p>It's not in-and-of itself an excuse, but it's a justification for when the breakage results in something that is <em>more</em> desirable than the status quo.</p>



<a name="270234028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234028">(Feb 01 2022 at 15:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270233960">said</a>:</p>
<blockquote>
<p>It's not in-and-of itself an excuse, but it's a justification for when the breakage results in something that is <em>more</em> desirable than the status quo.</p>
</blockquote>
<p>That I agree with entirely; that's exactly what we try to do in Rust.</p>



<a name="270234223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234223">(Feb 01 2022 at 15:54)</a>:</h4>
<p>Even if we've said "don't count on X", when we see a reason we may want to change X, we'll look at the degree to which people are counting on X and make a <em>deliberate</em> decision, rather than just writing off any uses of X because we said "don't count on X".</p>



<a name="270234312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234312">(Feb 01 2022 at 15:55)</a>:</h4>
<p>Sometimes we <em>do</em> go ahead and make the change, even if crater turns up half-a-dozen crates; we go work with the authors of those crates to get them fixed.</p>



<a name="270234398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234398">(Feb 01 2022 at 15:55)</a>:</h4>
<p>Sometimes we don't, not just because something has been widely used, but even if it's used in a few places and we say "yeah, that seems completely reasonable for someone to have done".</p>



<a name="270234407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234407">(Feb 01 2022 at 15:55)</a>:</h4>
<p>If we say that the spec limits the guaranteed-to-be-supported directives and excludes a particular directive, then it becomes desirable that specific directive is definately <em>not</em> supported in a certain case (IE. because implementing it is unreasonable), then it should be reasonable to not support it.</p>



<a name="270234526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234526">(Feb 01 2022 at 15:56)</a>:</h4>
<p>I think that seems quite reasonable for asm!; we'd be going from "LLVM / GNU AS" to "this explicit list of directives and grammar", and it should presumably be possible to calibrate the list until it covers all the major players</p>



<a name="270234537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234537">(Feb 01 2022 at 15:56)</a>:</h4>
<p>Well, I guess it's a difference between only assessing the desirability of the change vs. also assessing the impact of the breakage.<br>
I'm concerned about the latter part because it creates some odd incentives, to get implementation-dependent code into more places so it becomes part of the spec.</p>



<a name="270234611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234611">(Feb 01 2022 at 15:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270234537">said</a>:</p>
<blockquote>
<p>Well, I guess it's a difference between only assessing the desirability of the change vs. also assessing the impact of the breakage.<br>
I'm concerned about the latter part because it creates some odd incentives, to get implementation-dependent code into more places so it becomes part of the spec.</p>
</blockquote>
<p>I acknowledge the incentives there, but generally speaking we're not assuming our users are <em>trying</em> to exploit things like that. ;)</p>



<a name="270234654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234654">(Feb 01 2022 at 15:57)</a>:</h4>
<p>And if it seemed like someone was doing so intentionally, we'd likely ignore them for the purposes of evaluating breakage.</p>



<a name="270234660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234660">(Feb 01 2022 at 15:57)</a>:</h4>
<p>Yes, when it's a close decision, the spec becomes the deciding vote, so to say. "It's not supported, so we'll defer to breaking it here".</p>



<a name="270234801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234801">(Feb 01 2022 at 15:58)</a>:</h4>
<p>So, for the issue at hand here: does someone feel like they have the time and inclination to make a complete list of the intersection of directives supported by both GNU AS and LLVM AS? (Or, for that matter, a complete list of the directives supported by each would actually be more useful, and then it's not hard to intersect the two.)</p>



<a name="270234868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234868">(Feb 01 2022 at 15:58)</a>:</h4>
<p>I would not want to do a complete list, nor do I think that the basic subset should support a complete list.</p>



<a name="270234873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234873">(Feb 01 2022 at 15:59)</a>:</h4>
<p>We don't need a complete spec for each directive; I think it's reasonably safe to assume that if LLVM AS supports a directive that it supports all of that directive, to a first approximation.</p>



<a name="270234876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234876">(Feb 01 2022 at 15:59)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> that's not the only example, just the most extreme one. If it creates a general culture of reading the source and forming implicit assumptions on that it's bad too.</p>



<a name="270234968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270234968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270234968">(Feb 01 2022 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270234868">said</a>:</p>
<blockquote>
<p>I would not want to do a complete list, nor do I think that the basic subset should support a complete list.</p>
</blockquote>
<p>I didn't say that what we put in the docs would <em>be</em> the complete list; I asked if someone was willing to compile a complete list, from which we can deliberately decide what we want to exclude.</p>



<a name="270235111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235111">(Feb 01 2022 at 16:00)</a>:</h4>
<p>In asking that way, I'm specifically saying "the person who compiles the complete list should not be editorializing by removing items as they go; we'll do that after we have the list".</p>



<a name="270235194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235194">(Feb 01 2022 at 16:00)</a>:</h4>
<p><a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops">https://sourceware.org/binutils/docs/as/Pseudo-Ops.html#Pseudo-Ops</a></p>



<a name="270235259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235259">(Feb 01 2022 at 16:00)</a>:</h4>
<p>We can probably start from that list.</p>



<a name="270235371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235371">(Feb 01 2022 at 16:01)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="270235453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235453">(Feb 01 2022 at 16:01)</a>:</h4>
<p>I do think that's a complete list of the <em>portable</em> ones for GNU AS, though I think there may also be target-specific ones that we need to know, too.</p>



<a name="270235464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235464">(Feb 01 2022 at 16:01)</a>:</h4>
<p>hah, there's a deprecated list at the bottom</p>



<a name="270235560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235560">(Feb 01 2022 at 16:02)</a>:</h4>
<p>so the subset might not even be monotonically increasing over time</p>



<a name="270235674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235674">(Feb 01 2022 at 16:02)</a>:</h4>
<p><a href="https://sourceware.org/binutils/docs/as/Machine-Dependencies.html#Machine-Dependencies">https://sourceware.org/binutils/docs/as/Machine-Dependencies.html#Machine-Dependencies</a><br>
Has all of the machine-specific directives and more.</p>



<a name="270235770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270235770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270235770">(Feb 01 2022 at 16:03)</a>:</h4>
<p>Note that some of the common directives aren't even totally portable, insofar as they have different behaviour depending on the target.</p>



<a name="270236170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270236170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270236170">(Feb 01 2022 at 16:05)</a>:</h4>
<p>I guess <code>.intel_syntax</code> is going to be among the supported directives? That will make grammar parsing <em>fun</em> (to borrow a phrase)</p>



<a name="270236303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270236303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270236303">(Feb 01 2022 at 16:06)</a>:</h4>
<p>Yes. Ideally, we don't necessarily support turning it off.</p>



<a name="270236533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270236533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270236533">(Feb 01 2022 at 16:07)</a>:</h4>
<p>would it end up having side effects on any compiler generated code placed after the asm! block?</p>



<a name="270236601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270236601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270236601">(Feb 01 2022 at 16:07)</a>:</h4>
<p>like, it might cause those compiler lines to be interpreted in the wrong syntax mode</p>



<a name="270236789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270236789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270236789">(Feb 01 2022 at 16:08)</a>:</h4>
<p>I might have the wrong mental model for how asm blocks are concatenated with compiler asm though</p>



<a name="270236867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270236867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270236867">(Feb 01 2022 at 16:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270236601">said</a>:</p>
<blockquote>
<p>like, it might cause those compiler lines to be interpreted in the wrong syntax mode</p>
</blockquote>
<p>Imagine even having assembly produced by the compiler.</p>



<a name="270237211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270237211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270237211">(Feb 01 2022 at 16:10)</a>:</h4>
<p>(So, in my case, no, it wouldn't. IDK about llvm, though <span aria-label="sunglasses" class="emoji emoji-1f60e" role="img" title="sunglasses">:sunglasses:</span>)</p>



<a name="270237520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270237520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270237520">(Feb 01 2022 at 16:12)</a>:</h4>
<p>(<code>-s</code>? Nah, I'll just codegen then disassemble, what could go wrong)</p>



<a name="270239691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270239691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270239691">(Feb 01 2022 at 16:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270236170">said</a>:</p>
<blockquote>
<p>I guess <code>.intel_syntax</code> is going to be among the supported directives? That will make grammar parsing <em>fun</em> (to borrow a phrase)</p>
</blockquote>
<p>I don't actually think we fully support <code>.intel_syntax</code> or <code>.att_syntax</code>, insofar as using those won't affect how we substitute in placeholders, so they're likely to break things if used in any asm block that has placeholders.</p>



<a name="270239727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270239727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270239727">(Feb 01 2022 at 16:25)</a>:</h4>
<p>So those would be good examples of what we should document as not working.</p>



<a name="270240854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270240854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270240854">(Feb 01 2022 at 16:32)</a>:</h4>
<p>Heh. That actually seems easier to support the way I want to implement asm, if I choose to support multiple asm dialects (which I will eventually need).</p>



<a name="270241019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241019">(Feb 01 2022 at 16:33)</a>:</h4>
<p>(Since I ideally want to fill in placeholders <em>after</em> parsing the assembly into instructions)</p>



<a name="270241190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241190">(Feb 01 2022 at 16:34)</a>:</h4>
<p>I was wondering about whether <code>".asciz \"{}\""</code> is supposed to work (for, say, substituting a register class)</p>



<a name="270241271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241271">(Feb 01 2022 at 16:34)</a>:</h4>
<p>which would make things like the casing convention of registers observable</p>



<a name="270241297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241297">(Feb 01 2022 at 16:34)</a>:</h4>
<p>cursed, tbh.</p>



<a name="270241340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241340">(Feb 01 2022 at 16:35)</a>:</h4>
<p>Agreed on "cursed". Valid, but ow.</p>



<a name="270241346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241346">(Feb 01 2022 at 16:35)</a>:</h4>
<p>or worse, <code>".{}"</code></p>



<a name="270241378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241378">(Feb 01 2022 at 16:35)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> My understanding is that <code>label_{}:</code> would work, for that matter.</p>



<a name="270241559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241559">(Feb 01 2022 at 16:36)</a>:</h4>
<p>(Tbh, I could probably still support that, by just printing the register name if it appears outside of an instruction as a direct (or indirect) operand.</p>



<a name="270241582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241582">(Feb 01 2022 at 16:36)</a>:</h4>
<p>(Cursed af, though)</p>



<a name="270241590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241590">(Feb 01 2022 at 16:36)</a>:</h4>
<p>I think that in an ideal fully parsed version of <code>asm!</code> these would work but only in certain approved positions (like that label interpolation)</p>



<a name="270241658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241658">(Feb 01 2022 at 16:37)</a>:</h4>
<p>the directive interpolation definitely shouldn't work</p>



<a name="270241707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241707">(Feb 01 2022 at 16:37)</a>:</h4>
<p>and the string interpolation should not support SQL injection ideally</p>



<a name="270241764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241764">(Feb 01 2022 at 16:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270241707">said</a>:</p>
<blockquote>
<p>and the string interpolation should not support SQL injection ideally</p>
</blockquote>
<p>Heh</p>



<a name="270241872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241872">(Feb 01 2022 at 16:38)</a>:</h4>
<p>I do use <code>.asciiz</code> with args like that for SystemTap SDT probes:<br>
<a href="https://github.com/cuviper/rust-libprobe/blob/85202324218eae152d1c9dffa5ce37dfdc2a0e9b/src/platform/systemtap.rs#L116">https://github.com/cuviper/rust-libprobe/blob/85202324218eae152d1c9dffa5ce37dfdc2a0e9b/src/platform/systemtap.rs#L116</a></p>



<a name="270241991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270241991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270241991">(Feb 01 2022 at 16:38)</a>:</h4>
<p>I don't think it does, unless you're on some weird architecture where the register names are ";.abort or something.</p>



<a name="270242061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242061">(Feb 01 2022 at 16:39)</a>:</h4>
<p>Well, in that case you are using <code>concat!</code> so I guess asm doesn't have to worry about it</p>



<a name="270242164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242164">(Feb 01 2022 at 16:39)</a>:</h4>
<p>indeed that seems like a good way to allow for applications that require the more cursed kinds of interpolation</p>



<a name="270242177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242177">(Feb 01 2022 at 16:39)</a>:</h4>
<p>(Side note, among the directives I'd like to <em>not</em> be supported: <code>.abort</code> and <code>.error</code>)</p>



<a name="270242307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242307">(Feb 01 2022 at 16:40)</a>:</h4>
<p>Why <code>.error</code>? That sounds useful</p>



<a name="270242408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242408">(Feb 01 2022 at 16:41)</a>:</h4>
<p>Sounds like a great way to ICE.</p>



<a name="270242427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242427">(Feb 01 2022 at 16:41)</a>:</h4>
<p>well, the user asked for it</p>



<a name="270242464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242464">(Feb 01 2022 at 16:41)</a>:</h4>
<p>it should be a linker(?) error</p>



<a name="270242491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242491">(Feb 01 2022 at 16:41)</a>:</h4>
<p>Not a linker error.</p>



<a name="270242513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242513">(Feb 01 2022 at 16:41)</a>:</h4>
<p><code>.error</code> is an assembler error.</p>



<a name="270242676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242676">(Feb 01 2022 at 16:42)</a>:</h4>
<p>It should be roughly the same kind of error that you would get if the assembly string used nonexistent instructions</p>



<a name="270242744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242744">(Feb 01 2022 at 16:43)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">error</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">arch</span>::<span class="fm">asm!</span><span class="p">(</span><span class="s">".error </span><span class="se">\"</span><span class="s">foo</span><span class="se">\"</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">foo</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;</span>:<span class="mi">3</span>:<span class="mi">31</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">arch</span>::<span class="fm">asm!</span><span class="p">(</span><span class="s">".error </span><span class="se">\"</span><span class="s">foo</span><span class="se">\"</span><span class="s">"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w">                               </span><span class="o">^</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">instantiated</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">assembly</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="o">&lt;</span><span class="n">inline</span><span class="w"> </span><span class="n">asm</span><span class="o">&gt;</span>:<span class="mi">2</span>:<span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="s">"foo"</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">^</span><span class="w"></span>

<span class="n">error</span>: <span class="nc">aborting</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">error</span><span class="w"></span>
</code></pre></div>



<a name="270242773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242773">(Feb 01 2022 at 16:43)</a>:</h4>
<p>that's not a bad error</p>



<a name="270242890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242890">(Feb 01 2022 at 16:44)</a>:</h4>
<p>This is roughly how all errors (including syntax errors) in inline asm reported by llvm are formatted.</p>



<a name="270242917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270242917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270242917">(Feb 01 2022 at 16:44)</a>:</h4>
<p>does that happen in cargo check or cargo build?</p>



<a name="270243247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270243247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270243247">(Feb 01 2022 at 16:46)</a>:</h4>
<p>I've probably tossed span information by that point (although I may want to keep a reduced version arround for plugins anyways, just so that SFINAE errors from C++ don't look like</p>
<div class="codehilite"><pre><span></span><code>add
^^^ Cannot add types `Foo` and `Bar`. ADL-overload resolution on `operator+` failed
</code></pre></div>



<a name="270243397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270243397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270243397">(Feb 01 2022 at 16:47)</a>:</h4>
<p>Oh, I just noticed that it's pointing to the character in the string literal, that's cool</p>



<a name="270245325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270245325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270245325">(Feb 01 2022 at 16:56)</a>:</h4>
<p>Only during <code>cargo build</code>. <code>cargo check</code> doesn't pass any code to llvm.</p>



<a name="270245449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270245449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270245449">(Feb 01 2022 at 16:57)</a>:</h4>
<p>I'd assume even with <code>--emit mir</code> (or higher) it wouldn't produce those errors either.</p>



<a name="270246130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270246130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270246130">(Feb 01 2022 at 17:00)</a>:</h4>
<p>Correct. <code>--emit mir</code> and <code>--emit metadata</code> both produce MIR, but don't pass it to the codegen backend.</p>



<a name="270246308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270246308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270246308">(Feb 01 2022 at 17:01)</a>:</h4>
<p><code>--emit llvm-ir</code> on the other hand probably would produce the error.</p>



<a name="270246464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270246464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270246464">(Feb 01 2022 at 17:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270243397">said</a>:</p>
<blockquote>
<p>Oh, I just noticed that it's pointing to the character in the string literal, that's cool</p>
</blockquote>
<p>Yeah, I'm <em>really</em> impressed with the asm errors doing that.</p>



<a name="270246965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270246965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270246965">(Feb 01 2022 at 17:05)</a>:</h4>
<p>That was implemented in <a href="https://github.com/rust-lang/rust/pull/72625">https://github.com/rust-lang/rust/pull/72625</a>.</p>



<a name="270250624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270250624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270250624">(Feb 01 2022 at 17:25)</a>:</h4>
<p>So, looking at the list at <a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html">https://sourceware.org/binutils/docs/as/Pseudo-Ops.html</a> (ignoring the architecture-specific ones for the moment, and ignoring which ones LLVM already doesn't support), I think it'd be reasonable to disallow <code>.altmacro</code>/<code>.noaltmacro</code>, <code>.list</code>/<code>.nolist</code>/<code>.sbttl</code>/<code>.title</code>/<code>.eject</code>, <code>.macro</code>/<code>.exitm</code>, <code>.mri</code>. And <em>maybe</em> also <code>.if</code>/<code>.else</code>/<code>.endif</code>/etc though I think those are fine.</p>



<a name="270250855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270250855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270250855">(Feb 01 2022 at 17:26)</a>:</h4>
<p>Not going to fully commit to my answer here, but I <em>think</em> I can reasonably support the remaining ones. <br>
Ideally, <code>.if</code> et. al would be excluded.</p>



<a name="270251282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251282">(Feb 01 2022 at 17:29)</a>:</h4>
<p>I can probably give a final answer if not later today, then sometime tomorrow.</p>



<a name="270251338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251338">(Feb 01 2022 at 17:29)</a>:</h4>
<p><code>.eject</code>, <code>.title</code> and <code>.sbttl</code> can all be ignored without changing semantics, so disallowing them doesn't really add much.</p>



<a name="270251646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251646">(Feb 01 2022 at 17:31)</a>:</h4>
<p><code>.section</code> directives are also <em>fun</em>, since currently I only hand an output stream for <code>.text</code> to the function codegen (for simplying JIT vs. AOT interface reasons).</p>



<a name="270251732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251732">(Feb 01 2022 at 17:32)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> <code>.section</code> is definitely in the short list of directives I expect people to actively use and depend on.</p>



<a name="270251780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251780">(Feb 01 2022 at 17:32)</a>:</h4>
<p>It's very common, for instance, to switch to another section, emit a chunk of data, and <code>.popsection</code> or <code>.text</code> back.</p>



<a name="270251792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251792">(Feb 01 2022 at 17:32)</a>:</h4>
<p><code>.section</code> is needed for SystemTap as an example. (or rather <code>.pushsection</code>)</p>



<a name="270251802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270251802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270251802">(Feb 01 2022 at 17:32)</a>:</h4>
<p>For instance, a section full of pointers to things.</p>



<a name="270252280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270252280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270252280">(Feb 01 2022 at 17:35)</a>:</h4>
<p>Yeah, it's possible I could redesign that. It's just a question of how do I do that without needing to split the codegen for JIT vs. AOT.</p>



<a name="270253241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270253241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270253241">(Feb 01 2022 at 17:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270250624">said</a>:</p>
<blockquote>
<p>So, looking at the list at <a href="https://sourceware.org/binutils/docs/as/Pseudo-Ops.html">https://sourceware.org/binutils/docs/as/Pseudo-Ops.html</a> (ignoring the architecture-specific ones for the moment, and ignoring which ones LLVM already doesn't support), I think it'd be reasonable to disallow <code>.altmacro</code>/<code>.noaltmacro</code>, <code>.list</code>/<code>.nolist</code>/<code>.sbttl</code>/<code>.title</code>/<code>.eject</code>, <code>.macro</code>/<code>.exitm</code>, <code>.mri</code>. And <em>maybe</em> also <code>.if</code>/<code>.else</code>/<code>.endif</code>/etc though I think those are fine.</p>
</blockquote>
<p>of this list I can see that we're already using <code>.macro</code> in our codebase: <a href="https://github.com/enarx/enarx/blob/91d79e35b29f68ddffa60a305421fdc355ac424c/internal/shim-sev/src/main.rs#L189">https://github.com/enarx/enarx/blob/91d79e35b29f68ddffa60a305421fdc355ac424c/internal/shim-sev/src/main.rs#L189</a></p>



<a name="270255660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270255660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270255660">(Feb 01 2022 at 17:54)</a>:</h4>
<p><span class="user-mention" data-user-id="256342">@bstrie</span> Ouch.</p>



<a name="270255766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270255766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270255766">(Feb 01 2022 at 17:54)</a>:</h4>
<p>Hypothetically (not saying we're going to do this), if we ended up documenting <code>.macro</code> as not supported, 1) how likely would you be to stop using it, and 2) how painful would it be in your codebase overall?</p>



<a name="270255935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270255935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270255935">(Feb 01 2022 at 17:56)</a>:</h4>
<p>In my case, macros were one of the explicit things I contemplated as being the <em>most</em> difficult to support, along with conditional assembly.</p>



<a name="270256174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270256174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270256174">(Feb 01 2022 at 17:57)</a>:</h4>
<p>Yeah, I agree that if we're going to not-support anything for reasons of implementation complexity, <code>.macro</code> is on the <em>top</em> of that list.</p>



<a name="270256196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270256196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270256196">(Feb 01 2022 at 17:57)</a>:</h4>
<p>if it was the sole difference between being on nightly and being on stable, I'm confident that we would stop using it (though I haven't asked the person who owns this code). notably this is the one and only usage of any item in that list that I can find in this repo</p>



<a name="270256354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270256354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270256354">(Feb 01 2022 at 17:58)</a>:</h4>
<p><span class="user-mention" data-user-id="256342">@bstrie</span> I think by (1) I'm asking the question of "if we documented it as not supported, but it still worked, would you consider that motivating enough to change it if it didn't come with a personal ask". ;)</p>



<a name="270258479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270258479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270258479">(Feb 01 2022 at 18:09)</a>:</h4>
<p>"documented" here means with a warning?</p>



<a name="270258652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270258652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270258652">(Feb 01 2022 at 18:11)</a>:</h4>
<p>Probably documentation-only.</p>



<a name="270258718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270258718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270258718">(Feb 01 2022 at 18:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270258479">said</a>:</p>
<blockquote>
<p>"documented" here means with a warning?</p>
</blockquote>
<p>Maybe not out of the gate.</p>
<p>Might be a good idea to eventually have at least a portability warning for unsupported constructs, though.</p>



<a name="270258923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270258923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270258923">(Feb 01 2022 at 18:13)</a>:</h4>
<p>Well, I think that depends on the precise definition of "unsupported". This is an application, not a library, and I think that distinction is worth calling out. Because if "unsupported" means "nonportable", then that's much more of a concern for a library than an application, since a library can assume much less about the contexts in which it is used than an application. Likewise, a nonportable library can cause forks in the ecosystem, but a nonportable application just causes annoyances for users of that application. And because as the developers of the application we're directly in touch with our users, that puts us closer to the problem than a library developer who might be several steps removed from the end-users, so we have more ability to respond if it turns out to be a problem in practice. So I can't say that we would necessarily remove it if it just meant "your code might not be portable to other Rust implementations".</p>
<p>However, if "unsupported" meant "undefined behavior", then we would remove it, since our domain is security adjacent, and we care about passing code audits.</p>



<a name="270259241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270259241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270259241">(Feb 01 2022 at 18:15)</a>:</h4>
<p>I brought this topic up in the <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> meeting just now, and the general consensus was "if someone writes up a list of directives, we'd be willing to review and merge a PR that adds that list to the reference or <code>asm!</code> docs".</p>



<a name="270259355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270259355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270259355">(Feb 01 2022 at 18:16)</a>:</h4>
<p>If someone else does the work to prepare the full list of directives in one place (ideally checking what the intersection of LLVM and GNU supports), I'm willing to do the work to review the list of directives and consider exclusions from that list.</p>



<a name="270259361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270259361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270259361">(Feb 01 2022 at 18:16)</a>:</h4>
<p>And then I'd review the resulting PR.</p>



<a name="270260891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270260891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270260891">(Feb 01 2022 at 18:27)</a>:</h4>
<p>I can probably prepare the full list by tomorrow, though I'm too busy with uni to be able to compile that list today.</p>



<a name="270261164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270261164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270261164">(Feb 01 2022 at 18:29)</a>:</h4>
<p>Not a huge rush, just ideally need to do it before stabilization.</p>



<a name="270261181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270261181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270261181">(Feb 01 2022 at 18:29)</a>:</h4>
<p>And thank you.</p>



<a name="270261294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270261294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270261294">(Feb 01 2022 at 18:29)</a>:</h4>
<p>Please feel free to include a separate list of what you don't think we should support (whether because you don't personally want to implement it or because you think it's a bad idea even if you <em>can</em> easily implement it), but please keep that list separate to allow for evaluation.</p>



<a name="270261413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270261413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270261413">(Feb 01 2022 at 18:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270261294">said</a>:</p>
<blockquote>
<p>Please feel free to include a separate list of what you don't think we should support (whether because you don't personally want to implement it or because you think it's a bad idea even if you <em>can</em> easily implement it), but please keep that list separate to allow for evaluation.</p>
</blockquote>
<p>Yes, I will give them separately.</p>



<a name="270269783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270269783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270269783">(Feb 01 2022 at 19:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270236170">said</a>:</p>
<blockquote>
<p>I guess <code>.intel_syntax</code> is going to be among the supported directives? That will make grammar parsing <em>fun</em> (to borrow a phrase)</p>
</blockquote>
<p><code>.intel_syntax</code> is only partially supported by LLVM. LLVM AS don't support <code>.intel_syntax prefix</code>.</p>



<a name="270271011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270271011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270271011">(Feb 01 2022 at 19:30)</a>:</h4>
<p><code>.intel_syntax</code> and <code>.att_syntax</code> would also lead to unspecified behavior if not reset before the end of the asm block. For example llvm concatenates all global_asm!() blocks, which would leak the syntax specifier from one global asm block to another. Gcc directly adds inline asm to the emitted asm next to the codegened function contents.</p>



<a name="270271146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270271146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270271146">(Feb 01 2022 at 19:31)</a>:</h4>
<p>Huh, I was under the impression that GCC at least reset some state at the end of inline asm blocks.</p>



<a name="270271211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270271211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270271211">(Feb 01 2022 at 19:31)</a>:</h4>
<p>Maybe it does? I can check.</p>



<a name="270272606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270272606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270272606">(Feb 01 2022 at 19:40)</a>:</h4>
<p>It doesn't. Adding <code>__asm__ volatile(".intel_syntax");</code> caused a compile error due to the following instructions not being recognized.</p>



<a name="270272653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270272653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270272653">(Feb 01 2022 at 19:40)</a>:</h4>
<p><a href="https://gcc.godbolt.org/z/v1v8vjhz8">https://gcc.godbolt.org/z/v1v8vjhz8</a></p>



<a name="270272742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270272742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270272742">(Feb 01 2022 at 19:41)</a>:</h4>
<p>(sorry for the funky layout. compiler explorer doesn't really work well on mobile)</p>



<a name="270272752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270272752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270272752">(Feb 01 2022 at 19:41)</a>:</h4>
<p>I don't think GCC actually look at the asm. It just passes the text verbatim to GAS.</p>



<a name="270273009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270273009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270273009">(Feb 01 2022 at 19:42)</a>:</h4>
<p>I recall an lwn article about gcc using the line count of inline asm to estimate inlining costs. I believe it resulted in adding a comment to an inline asm block in the linux kernel regressing performance due to a different inlining decision.</p>



<a name="270273427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270273427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270273427">(Feb 01 2022 at 19:45)</a>:</h4>
<p>Wow, somehow I was attributing more semantic value to the comments GCC emits that show the start and end of inline assembly.</p>



<a name="270273448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270273448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270273448">(Feb 01 2022 at 19:45)</a>:</h4>
<p>I didn't know it'd just break due to statefulness.</p>



<a name="270296085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270296085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270296085">(Feb 01 2022 at 22:07)</a>:</h4>
<p>The asm RFC specifically states that behavior is undefined if you don't reset the assembler to its original state.</p>



<a name="270300865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/270300865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#270300865">(Feb 01 2022 at 22:45)</a>:</h4>
<p>TBH, seems like it should be IFNDR.</p>



<a name="271719392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271719392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271719392">(Feb 13 2022 at 01:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/270260891">said</a>:</p>
<blockquote>
<p>I can probably prepare the full list by tomorrow, though I'm too busy with uni to be able to compile that list today.</p>
</blockquote>
<p>Appologies, took longer than I thought.  I have a list of the GNU directives, but I need to check each of their validity in llvm.</p>



<a name="271719705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271719705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271719705">(Feb 13 2022 at 01:17)</a>:</h4>
<p>Fortunately the reverse direction should be easier: there aren't that many LLVM-specific directives to check. :)</p>



<a name="271719710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271719710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271719710">(Feb 13 2022 at 01:17)</a>:</h4>
<p>Thanks for working on this!</p>



<a name="271725112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271725112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271725112">(Feb 13 2022 at 03:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271719705">said</a>:</p>
<blockquote>
<p>Fortunately the reverse direction should be easier: there aren't that many LLVM-specific directives to check. :)</p>
</blockquote>
<p>The issue is that it's <em>very</em> hard to find them. They aren't documented anywhere that either myself or someone else who I've had helping me could find.</p>



<a name="271725466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271725466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271725466">(Feb 13 2022 at 03:58)</a>:</h4>
<p>They all appear to be on <a href="https://llvm.org/docs/Extensions.html">https://llvm.org/docs/Extensions.html</a> .</p>



<a name="271725477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271725477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271725477">(Feb 13 2022 at 03:59)</a>:</h4>
<p>That includes both LLVM-specific directives, and LLVM-specific extensions to existing directives.</p>



<a name="271779802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271779802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ray Redondo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271779802">(Feb 14 2022 at 02:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271725466">said</a>:</p>
<blockquote>
<p>They all appear to be on <a href="https://llvm.org/docs/Extensions.html">https://llvm.org/docs/Extensions.html</a> .</p>
</blockquote>
<p>Hello, I'm the person who ended up compiling the list. Unfortunately, this page is next to useless; in fact, there is one easy way to prove no comprehensive list exists: <code>grep</code> for <code>intel_syntax</code> in the docs and you'll get exactly one hit, and it's in a completely unrelated area.</p>



<a name="271779815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271779815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ray Redondo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271779815">(Feb 14 2022 at 02:41)</a>:</h4>
<p>I have a filtered list of directives that probably exist in both GAS and LLVM-AS, but it is not fully verified. It is, however, down to &lt;250 directives, so it should be easier to manually verify.</p>



<a name="271779861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271779861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ray Redondo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271779861">(Feb 14 2022 at 02:42)</a>:</h4>
<p>I leave it with you for your consideration: <a href="/user_uploads/4715/hzSwQCg2KpIpt6wANgQlx4_z/result2.txt">result2.txt</a></p>



<a name="271779873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271779873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ray Redondo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271779873">(Feb 14 2022 at 02:42)</a>:</h4>
<p>(naming due to me doing a serious of automated passes on text globbed from the docs by <span class="user-mention" data-user-id="257758">@Connor Horman</span>)</p>



<a name="271785945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271785945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271785945">(Feb 14 2022 at 05:21)</a>:</h4>
<p><span class="user-mention" data-user-id="396093">@Ray Redondo</span> I was making the assumption that that page listed <em>only</em> the directives unique to LLVM and <em>not</em> in GAS, which would explain it not having <code>intel_syntax</code>.</p>



<a name="271787256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271787256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ray Redondo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271787256">(Feb 14 2022 at 05:52)</a>:</h4>
<p>Right; that doesn't help to get a master list, it only helps to widdle down a nonexistent LLVM list.</p>



<a name="271818375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271818375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271818375">(Feb 14 2022 at 12:18)</a>:</h4>
<p>Alright. I've filtered the list of directives by invoking the assembler and checking which directives yield "unknown directive" (on llvm-mc) or "unknown pseudo-op" (on GAS), then using some bash magic to get the intersection of the files<br>
The list is <a href="/user_uploads/4715/5pWy8AvAQDBLkdIcYFIQuxrY/both-valid.txt">both-valid.txt</a>. </p>
<p>This may not be an exhausitve list, but it should be close to one. Note that this covers only directives available on x86 gas, as those were the only ones I could check. Notably, the <code>.thumb*</code> directives aren't included, because I don't have an arm assembler.</p>



<a name="271821642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271821642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271821642">(Feb 14 2022 at 12:53)</a>:</h4>
<p>Side note, I realised a potential problem with doing <code>.intel_syntax noprefix</code>, but I'd like input from someone knowledgeable in gcc codegen (either gcc-rs or cg_gcc especially or otherwise). GNU AS does <em>not</em> support the <code>noprefix</code> option IIRC, so if the assembler in use <em>is</em> actually GNU AS, it would require translation on top of the emission of the directive.</p>



<a name="271823511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271823511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271823511">(Feb 14 2022 at 13:11)</a>:</h4>
<p>wrt. lccc's xlangcodegen_x86 (and likely other direct code generators, which will share a lot of machinery), this is a preliminary categorized list based on an initial pass. I may amend this when I do a more comprehensive check, and as development progresses (it may become easier to support certain directives - this is a defensive ). <br>
<a href="https://hackmd.io/@wSaA8OrrSQ2SlegMvA6e6A/BkBQQ0w19">https://hackmd.io/@wSaA8OrrSQ2SlegMvA6e6A/BkBQQ0w19</a></p>



<a name="271826582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271826582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271826582">(Feb 14 2022 at 13:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271821642">said</a>:</p>
<blockquote>
<p>Side note, I realised a potential problem with doing <code>.intel_syntax noprefix</code>, but I'd like input from someone knowledgeable in gcc codegen (either gcc-rs or cg_gcc especially or otherwise). GNU AS does <em>not</em> support the <code>noprefix</code> option IIRC, so if the assembler in use <em>is</em> actually GNU AS, it would require translation on top of the emission of the directive.</p>
</blockquote>
<p>cg_clif uses <code>.intel_syntax noprefix</code> just fine with gnu afaik: <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/d4594457993600987b4370ab5b258d4276e12b37/src/inline_asm.rs#L405">https://github.com/bjorn3/rustc_codegen_cranelift/blob/d4594457993600987b4370ab5b258d4276e12b37/src/inline_asm.rs#L405</a></p>



<a name="271827116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271827116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271827116">(Feb 14 2022 at 13:43)</a>:</h4>
<p>Ah yeah. I also just found out I tested this at some point (or was doing something else).<br>
Weirdly, I can't find this at all in the documentation. Or <code>.intel_syntax</code> at all for that matter.</p>



<a name="271827642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271827642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271827642">(Feb 14 2022 at 13:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271823511">said</a>:</p>
<blockquote>
<p>wrt. lccc's xlangcodegen_x86 (and likely other direct code generators, which will share a lot of machinery), this is a preliminary categorized list based on an initial pass. I may amend this when I do a more comprehensive check, and as development progresses (it may become easier to support certain directives - this is a defensive ). <br>
<a href="https://hackmd.io/@wSaA8OrrSQ2SlegMvA6e6A/BkBQQ0w19">https://hackmd.io/@wSaA8OrrSQ2SlegMvA6e6A/BkBQQ0w19</a></p>
</blockquote>
<p><code>.code16</code> and <code>.code32</code> are required by <a href="https://github.com/rust-osdev/bootloader">https://github.com/rust-osdev/bootloader</a> for bios support. It only uses them in <code>global_asm!()</code> if that helps. I think the <code>.bundle_*</code> directives wouldn't be too hard to implement. Especially as you may need to use an equivalent for loops to get better performance. <code>.incbin</code> may be nice to have for some use cases, though I suspect LTO breaks it anyway due to the current working directory of different rustc invocations being different. If so it should probably not be supported. <code>.abort</code> I also agree as the gnu as documentation mentions that it may not be supported one day. <code>.error</code> is not useful without <code>.if</code> or <code>.macro</code> I think. <code>.rept</code> could be emulated using a rust macro and <code>concat_str!()</code> I think.</p>



<a name="271827899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271827899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271827899">(Feb 14 2022 at 13:49)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/91728">https://github.com/rust-lang/rust/pull/91728</a> has already hit beta by the way FYI. Beta will be promoted to stable on the 24th, so only 10 days left for a decision I think.</p>



<a name="271828095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271828095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271828095">(Feb 14 2022 at 13:51)</a>:</h4>
<p>Wait, 10 days? <br>
FCP is what, 10 days? That's <em>fun</em>.</p>



<a name="271829658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271829658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271829658">(Feb 14 2022 at 14:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271827642">said</a>:</p>
<blockquote>
<p><code>.code16</code> and <code>.code32</code> are required by <a href="https://github.com/rust-osdev/bootloader">https://github.com/rust-osdev/bootloader</a> for bios support. It only uses them in <code>global_asm!()</code> if that helps. </p>
</blockquote>
<p>Yeah, that's <em>fun</em>. Currently my lists for global_asm vs. asm are the same, but they could easily be different.<br>
The main issue I have with <code>.code16</code> and <code>.code32</code> is that instruction collection and actual generation is two separate steps, and I'd have to track mode switches interleaved with instructions, labels, and raw bytes (from <code>.byte</code> et. al directives in assembly). For global_asm, which would presumably use a more primitive assembler, it would be easier to support the mode switch. For that matter, sections would be easier in that context, since it would be tied directly to the binary file emitter, rather than to a codegen that prepares the instructions, then is given a text section to encode it into.</p>



<a name="271829747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271829747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271829747">(Feb 14 2022 at 14:03)</a>:</h4>
<p>(It's also not as easy as <em>just</em> tracking <code>.code16</code> vs. <code>.code32</code>in the generator as it has to switch addressing modes <em>for</em> the generation of instructions)</p>



<a name="271829859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271829859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271829859">(Feb 14 2022 at 14:04)</a>:</h4>
<p>It may make sense to restrict <code>.code16</code> and <code>.code32</code> to <code>global_asm!()</code>, though it would probably seem like an arbitrary restriction to most people.</p>



<a name="271830159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271830159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271830159">(Feb 14 2022 at 14:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271821642">said</a>:</p>
<blockquote>
<p>Side note, I realised a potential problem with doing <code>.intel_syntax noprefix</code>, but I'd like input from someone knowledgeable in gcc codegen (either gcc-rs or cg_gcc especially or otherwise). GNU AS does <em>not</em> support the <code>noprefix</code> option IIRC, so if the assembler in use <em>is</em> actually GNU AS, it would require translation on top of the emission of the directive.</p>
</blockquote>
<p>GNU AS supports <code>.intel_syntax noprefix</code>. I am not sure how you reached this conclusion but <code>noprefix</code> is the default if intel syntax is used (e.g. <code>-masm=intel</code>), and <code>prefix</code> is the default if AT&amp;T syntax is used. In fact, <code>.intel_syntax noprefix</code> and <code>.att_syntax prefix</code> are the common subset between GNU AS and LLVM AS, as LLVM as does not support <code>.intel_syntax prefix</code> or <code>.att_syntax noprefix</code>.</p>



<a name="271830441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271830441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271830441">(Feb 14 2022 at 14:08)</a>:</h4>
<p>I was mostly checking from documentation: as I noted, I could not find <code>.intel_syntax [options]</code>.</p>



<a name="271830699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271830699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271830699">(Feb 14 2022 at 14:10)</a>:</h4>
<p>A v. quick google gives: <a href="https://sourceware.org/binutils/docs/as/i386_002dVariations.html">https://sourceware.org/binutils/docs/as/i386_002dVariations.html</a></p>



<a name="271830840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271830840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271830840">(Feb 14 2022 at 14:10)</a>:</h4>
<p>(And another part of the GNU AS documentation states "Register operands are always prefixed with ‘%’.")<br>
Huh. Well designed documentation.</p>



<a name="271843701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271843701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271843701">(Feb 14 2022 at 15:42)</a>:</h4>
<p>I'm going to prepare a reference PR, taking from my first two lists, plus <code>.code16</code> and <code>.code32</code>. The PR can be changed, but getting this done quickly is probably a good idea.</p>



<a name="271846122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271846122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271846122">(Feb 14 2022 at 15:55)</a>:</h4>
<p>Filed as a draft: <a href="https://github.com/rust-lang/reference/pull/1168">https://github.com/rust-lang/reference/pull/1168</a></p>



<a name="271879185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271879185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271879185">(Feb 14 2022 at 19:49)</a>:</h4>
<p>I don't think your hackmd doc contains all directives? E.g. <code>.fill</code> seems to be missing.</p>



<a name="271879451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271879451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271879451">(Feb 14 2022 at 19:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271879185">said</a>:</p>
<blockquote>
<p>I don't think your hackmd doc contains all directives? E.g. <code>.fill</code> seems to be missing.</p>
</blockquote>
<p>Yeah, it's not exhaustive: anything I don't list is defensively under the last section. Although <code>.fill</code> is a silly omission <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>.</p>



<a name="271879578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271879578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271879578">(Feb 14 2022 at 19:52)</a>:</h4>
<p>(Note that it's my opinion wrt. my implementation - the unseparated list is linked above)</p>



<a name="271880198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271880198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271880198">(Feb 14 2022 at 19:57)</a>:</h4>
<p>BTW <a href="#narrow/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86">https://rust-lang.zulipchat.com/#narrow/stream/216763-project-inline-asm/topic/esi.20register.20on.20x86</a> currently has a scenario that requires the use of <code>.set</code> and <code>.if</code>.</p>



<a name="271880293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271880293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271880293">(Feb 14 2022 at 19:58)</a>:</h4>
<p>Yeah... Heh.</p>



<a name="271880429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271880429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271880429">(Feb 14 2022 at 19:59)</a>:</h4>
<p>For my personal use cases I think I need <code>.extern</code> and <code>.global</code> (only in global_asm), and a RISC-V arch specific <code>.option</code>.</p>



<a name="271880880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271880880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271880880">(Feb 14 2022 at 20:03)</a>:</h4>
<p>Yeah, <code>.option</code> came up in the #os-dev channel of the community server: I'd find it has the same issues as <code>.code16</code>/<code>.code32</code>, in my case, I have to maintain that state twice, and getting them to agree is <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span>.</p>



<a name="271880981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271880981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271880981">(Feb 14 2022 at 20:04)</a>:</h4>
<p>Without <code>.option</code> it is impossible to write some RISC-V code.</p>



<a name="271881018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881018">(Feb 14 2022 at 20:04)</a>:</h4>
<p>(It's very important even in non-global asm)</p>



<a name="271881037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881037">(Feb 14 2022 at 20:04)</a>:</h4>
<p>Oh fun. I hate having two sources of truth.</p>



<a name="271881184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881184">(Feb 14 2022 at 20:06)</a>:</h4>
<p>(lccc is designed over avoiding the left-hand/right-hand problem by never having more than one source of truth)</p>



<a name="271881255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881255">(Feb 14 2022 at 20:06)</a>:</h4>
<p>I'll go through the list you posted above, and see if there's any omissions that people will need in common assembly.</p>



<a name="271881268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881268">(Feb 14 2022 at 20:06)</a>:</h4>
<p>Thank you for working on this.</p>



<a name="271881338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881338">(Feb 14 2022 at 20:07)</a>:</h4>
<p>For example if you are trying to create some jump table with duff's device, you'll need to tell the assembler to not generate compressed instructions with <code>.option push; .option norvc</code> and then reset the state later with <code>.option pop</code></p>



<a name="271881544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271881544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271881544">(Feb 14 2022 at 20:09)</a>:</h4>
<p>RISC-V (and some other archs) also have linker relaxation, which permits the linker to change your code after assembly (e.g. replace a two-instruction symbol address loading with a single offset from global pointer, if the symbol is placed into .sdata). And this sometimes need to be turned off via <code>.option push; .option norelax</code>. So it's kinda critical.</p>



<a name="271882950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271882950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271882950">(Feb 14 2022 at 20:21)</a>:</h4>
<p>Yeah, I don't dispute that it's necessary... It's just... <em>fun</em>.</p>



<a name="271887384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271887384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271887384">(Feb 14 2022 at 20:59)</a>:</h4>
<p>I just grepped through a crate that I'm working on and here's the list of asm directives I'm using:</p>
<div class="codehilite"><pre><span></span><code>.alt_entry
.balign
.cfi_endproc
.cfi_escape
.cfi_offset
.cfi_sections
.cfi_signal_frame
.cfi_startproc
.def
.endef
.equ
.fnend
.fnstart
.globl
.hidden
.movsp
.private_extern
.save
.scl
.seh_endproc
.seh_endprologue
.seh_proc
.seh_pushreg
.seh_savereg
.seh_setframe
.seh_stackalloc
.size
.thumb
.thumb_func
.type
</code></pre></div>



<a name="271887499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271887499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271887499">(Feb 14 2022 at 21:00)</a>:</h4>
<p>Most of these are only used in <code>global_asm!</code> though.</p>



<a name="271887962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271887962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271887962">(Feb 14 2022 at 21:03)</a>:</h4>
<p>Never heard of some of them. I assume many are platform-dependent?</p>



<a name="271888276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271888276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271888276">(Feb 14 2022 at 21:05)</a>:</h4>
<p>Yea the seh_* ones are for x86_64 Windows. <code>fnstart</code>,<code>fnend</code>,<code>save</code>,<code>movsp</code>,<code>thumb</code>,<code>thumb_func</code> are ARM-specific. <code>scl</code>, <code>def</code> and <code>endef</code> are for specifying attributes of symbols on COFF (Windows) object files. <code>private_extern</code> and <code>alt_entry</code> are Darwin-specific.</p>



<a name="271892105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271892105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271892105">(Feb 14 2022 at 21:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271888276">said</a>:</p>
<blockquote>
<p>Yea the seh_* ones are for x86_64 Windows. </p>
</blockquote>
<p>The seh_* ones were already excluded, where they not? I don't believe GNU AS supports them at all, thus they were excluded from the original Common Subset that was previously guaranteed support.</p>



<a name="271893522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271893522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271893522">(Feb 14 2022 at 21:43)</a>:</h4>
<p>They are definitely supported: GCC emits them on win64.</p>



<a name="271893721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271893721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271893721">(Feb 14 2022 at 21:45)</a>:</h4>
<p>It's not anywhere in the GNU AS documentation. I just grepped for <code>.seh_endproc</code> in my main list of all things that look like directives.</p>



<a name="271893852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271893852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271893852">(Feb 14 2022 at 21:46)</a>:</h4>
<p><a href="https://sourceware.org/bugzilla/show_bug.cgi?id=20344">https://sourceware.org/bugzilla/show_bug.cgi?id=20344</a></p>



<a name="271893892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271893892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271893892">(Feb 14 2022 at 21:46)</a>:</h4>
<p>As I said before, well designed documentation.</p>



<a name="271893960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271893960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271893960">(Feb 14 2022 at 21:47)</a>:</h4>
<p>(I can't find directives that aren't documented)</p>



<a name="271894082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271894082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271894082">(Feb 14 2022 at 21:48)</a>:</h4>
<p>In any case, I'd imagine the seh stuff would be functionally equivalent to the cfi stuff, in terms of implementability.</p>



<a name="271897845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271897845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271897845">(Feb 14 2022 at 22:19)</a>:</h4>
<p>Most of the ARM ones are also for CFI (ARM doesn't use DWARF CFI for unwinding).</p>



<a name="271897976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271897976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271897976">(Feb 14 2022 at 22:20)</a>:</h4>
<p>Anything of the like is probably going to be the same or similar.</p>



<a name="271989384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271989384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271989384">(Feb 15 2022 at 15:22)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> are you ok with <code>.thumb</code>, <code>.thumb_func</code>,  <code>.alt_entry</code> being global_asm! only?</p>
<p>I can't find any documentation at all on <code>.private_extern</code>, so I can't make any statements there.</p>



<a name="271991469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271991469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271991469">(Feb 15 2022 at 15:37)</a>:</h4>
<p>I don't understand the motivation for special-casing global_asm!.</p>



<a name="271991566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271991566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271991566">(Feb 15 2022 at 15:38)</a>:</h4>
<p>In normal inline asm you can use <code>.pushsection</code>/<code>.popsection</code> and write stuff to arbitrary sections. That gives you the same power as <code>global_asm!</code>.</p>



<a name="271992515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/271992515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#271992515">(Feb 15 2022 at 15:45)</a>:</h4>
<p>I've noted how differently I handle <code>global_asm</code> vs. <code>asm</code> above. I have to generate asm when building a function, and I don't even have a binary file at that point (in fact, the current system, the IR is lowered into instructions before the output stream is even available)</p>



<a name="272015795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272015795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272015795">(Feb 15 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/271991566">said</a>:</p>
<blockquote>
<p>In normal inline asm you can use <code>.pushsection</code>/<code>.popsection</code> and write stuff to arbitrary sections. That gives you the same power as <code>global_asm!</code>.</p>
</blockquote>
<p>Also, that's not quite true.<br>
<code>global_asm!</code>, you can assume will be generated exactly once.<br>
<code>asm!</code> gives you no such power (in fact, it's possible that the output of <code>asm!</code> may not even exist at all)</p>



<a name="272017100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272017100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272017100">(Feb 15 2022 at 18:26)</a>:</h4>
<p>This means that you can't emit global symbols via <code>asm!</code>, so directives like <code>.globl</code>/<code>.global</code>/<code>.private_extern</code>, etc. are mostly nonsensical.</p>



<a name="272017754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272017754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272017754">(Feb 15 2022 at 18:31)</a>:</h4>
<p>I've updated the proposal to include more directives. I've also made the target-specific stuff and the asm vs. global_asm specific stuff more explicit.</p>



<a name="272018977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272018977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272018977">(Feb 15 2022 at 18:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272017100">said</a>:</p>
<blockquote>
<p>This means that you can't emit global symbols via <code>asm!</code>, so directives like <code>.globl</code>/<code>.global</code>/<code>.private_extern</code>, etc. are mostly nonsensical.</p>
</blockquote>
<p>And yet, people will, and it'll mostly work.</p>



<a name="272019079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272019079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272019079">(Feb 15 2022 at 18:41)</a>:</h4>
<p>Also, directives like <code>pushsection</code>/<code>popsection</code> can still be valid even if things are duplicated. For instance, if the issue is "put the address of a label from this asm block into this special section", if there are 5 copies of the asm block, you just add five addresses into the special section.</p>



<a name="272019589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272019589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272019589">(Feb 15 2022 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272018977">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272017100">said</a>:</p>
<blockquote>
<p>This means that you can't emit global symbols via <code>asm!</code>, so directives like <code>.globl</code>/<code>.global</code>/<code>.private_extern</code>, etc. are mostly nonsensical.</p>
</blockquote>
<p>And yet, people will, and it'll mostly work.</p>
</blockquote>
<p>"Mostly"</p>



<a name="272020193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272020193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272020193">(Feb 15 2022 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272019079">said</a>:</p>
<blockquote>
<p>Also, directives like <code>pushsection</code>/<code>popsection</code> can still be valid even if things are duplicated. For instance, if the issue is "put the address of a label from this asm block into this special section", if there are 5 copies of the asm block, you just add five addresses into the special section.</p>
</blockquote>
<p>Sure, and those are <em>fun</em>.</p>



<a name="272022240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272022240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272022240">(Feb 15 2022 at 19:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272019589">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272018977">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272017100">said</a>:</p>
<blockquote>
<p>This means that you can't emit global symbols via <code>asm!</code>, so directives like <code>.globl</code>/<code>.global</code>/<code>.private_extern</code>, etc. are mostly nonsensical.</p>
</blockquote>
<p>And yet, people will, and it'll mostly work.</p>
</blockquote>
<p>"Mostly"</p>
</blockquote>
<p>The same issue exists in C code, where it's <em>possible</em> the compiler could duplicate an asm block.</p>



<a name="272022353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272022353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272022353">(Feb 15 2022 at 19:04)</a>:</h4>
<p>People do it anyway and get the compiler to cooperate.</p>



<a name="272023043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272023043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272023043">(Feb 15 2022 at 19:09)</a>:</h4>
<p><em>makes note to make option to make the compiler not cooperate</em></p>



<a name="272023670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272023670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272023670">(Feb 15 2022 at 19:14)</a>:</h4>
<p><code>-Zhostile</code></p>



<a name="272027798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272027798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272027798">(Feb 15 2022 at 19:44)</a>:</h4>
<p>In any case, it's already explicitly unsupported to rely on an <code>asm!</code> block being emitted exactly once, and implicitly unsupported to define any kind of symbols, especially symbols with external linkage.</p>



<a name="272028649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272028649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272028649">(Feb 15 2022 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> taking a look at your list, here are the directives that we use that you haven't included:</p>
<div class="codehilite"><pre><span></span><code>.align
</code></pre></div>



<a name="272028782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272028782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272028782">(Feb 15 2022 at 19:52)</a>:</h4>
<p>though .align is fine because you mention .balign</p>



<a name="272028798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272028798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272028798">(Feb 15 2022 at 19:52)</a>:</h4>
<p>... Why don't I have <code>.align</code> or <code>.short</code>.</p>
<p>For <code>.macro</code>, that's one of the ones I'd really like to avoid, and <code>.set</code> heh...</p>



<a name="272028818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272028818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272028818">(Feb 15 2022 at 19:52)</a>:</h4>
<p>and we've already discussed the infeasability of .macro</p>



<a name="272028945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272028945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272028945">(Feb 15 2022 at 19:53)</a>:</h4>
<p><code>.set</code>/<code>.equ</code> are probably fine.</p>



<a name="272029006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272029006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272029006">(Feb 15 2022 at 19:54)</a>:</h4>
<p>Although I'd expect them not to not be guaranteed escape the <code>asm!</code> block.</p>



<a name="272029387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272029387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272029387">(Feb 15 2022 at 19:57)</a>:</h4>
<p>For example, no:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">(){</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="s">".equ a=2f;</span>
<span class="s">    2:</span>
<span class="s">        ...</span>
<span class="s">"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="s">"jmp a"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272029421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272029421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272029421">(Feb 15 2022 at 19:57)</a>:</h4>
<p>Although that wouldn't be too annoying.</p>



<a name="272030134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272030134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272030134">(Feb 15 2022 at 20:01)</a>:</h4>
<p>Anyways, I've added all of those, except for <code>.macro</code>.</p>



<a name="272031600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272031600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272031600">(Feb 15 2022 at 20:14)</a>:</h4>
<p>cool :)</p>



<a name="272031796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272031796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272031796">(Feb 15 2022 at 20:15)</a>:</h4>
<p>it does sort of suggest that we should do a broader survey of rust crates that use asm to see what directives they use in practice, if anyone has a spare copy of <a href="http://crates.io">crates.io</a> lying around that they want to grep for <code>"\"\.[a-zA-Z_]\+ "</code> on</p>



<a name="272032717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272032717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272032717">(Feb 15 2022 at 20:23)</a>:</h4>
<p>Subsequent characters can also be <code>0-9</code>; e.g. <code>.code16</code>.</p>



<a name="272034222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272034222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272034222">(Feb 15 2022 at 20:36)</a>:</h4>
<p>ah of course, that doesn't change anything in our case though</p>



<a name="272039264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272039264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272039264">(Feb 15 2022 at 21:15)</a>:</h4>
<blockquote>
<p>Although I'd expect them not to not be guaranteed escape the <code>asm!</code> block.</p>
</blockquote>
<p>That would break the fallback scheme for inline asm anyway. If it were to jump to the second block, at the end of the second block it would return to the caller location of the first block as the saved return address hasn't changed.</p>



<a name="272051304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051304">(Feb 15 2022 at 23:08)</a>:</h4>
<p><code>.inst</code> is being used in Rust repo</p>



<a name="272051379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051379">(Feb 15 2022 at 23:09)</a>:</h4>
<p>Stdarch uses it for riscv I believe as some instructions aren't implemented in LLVM yet.</p>



<a name="272051393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051393">(Feb 15 2022 at 23:09)</a>:</h4>
<p>Oh fun.</p>



<a name="272051403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051403">(Feb 15 2022 at 23:09)</a>:</h4>
<p>That's just "write bytes" though, isn't it?</p>



<a name="272051562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051562">(Feb 15 2022 at 23:12)</a>:</h4>
<p>I think you can specify operands in addition to opcode</p>



<a name="272051652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051652">(Feb 15 2022 at 23:12)</a>:</h4>
<p>Ah, fun.</p>



<a name="272051673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051673">(Feb 15 2022 at 23:12)</a>:</h4>
<p>The RISC-V version of <code>.inst</code> can specify the encoding format, opcode, operands, and immediates; although this is not supported by LLVM AS so it couldn't be used in inline asm.</p>



<a name="272051709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051709">(Feb 15 2022 at 23:13)</a>:</h4>
<p>Anyways, it's functionally a "write bytes" directive, so I'd just chuck it in with the "write bytes" directives.</p>



<a name="272051744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051744">(Feb 15 2022 at 23:13)</a>:</h4>
<p>I guess you would need it if e.g. you used rust-level operands (instead of encoding them directly)</p>



<a name="272051855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272051855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272051855">(Feb 15 2022 at 23:15)</a>:</h4>
<p><code>.db 0x31, 0xC0</code>&gt; <code>xor eax, eax</code></p>



<a name="272052297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272052297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272052297">(Feb 15 2022 at 23:20)</a>:</h4>
<p>not really, you can encode relocation with <code>.inst</code></p>



<a name="272052335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272052335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272052335">(Feb 15 2022 at 23:21)</a>:</h4>
<p>Hmm... True. Although, you can encode relocations with <code>.long</code> as well.</p>



<a name="272052696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272052696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272052696">(Feb 15 2022 at 23:25)</a>:</h4>
<p>I think with <code>.inst</code> you can let the linker perform relaxation as well, so it's probably more powerful. But you are correct, just "write bytes" would need relocation.</p>



<a name="272129019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272129019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272129019">(Feb 16 2022 at 15:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272052696">said</a>:</p>
<blockquote>
<p>I think with <code>.inst</code> you can let the linker perform relaxation as well, so it's probably more powerful. But you are correct, just "write bytes" would need relocation.</p>
</blockquote>
<p>relaxations are just another form of relocation.</p>



<a name="272332851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272332851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272332851">(Feb 17 2022 at 22:21)</a>:</h4>
<p>Global assembly seems pretty useless without ability to use many of the directives useful for function definitions (<code>.size</code>, <code>.type</code>, <code>.p2align</code>, though for the last one I guess <code>.align</code> is a good enough of a replacement). OTOH some of the directives (<code>.cfi_startproc</code> for example) are only useful when defining a function (can this be readily done outside of <code>global_asm!</code>?)</p>



<a name="272333023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272333023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272333023">(Feb 17 2022 at 22:22)</a>:</h4>
<p>/me looks at <code>.cantunwind</code> in their arm assembly and wonders if it has any value...</p>



<a name="272427290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272427290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272427290">(Feb 18 2022 at 17:00)</a>:</h4>
<p>If there are no other directives to add, would it be a good idea to get it approved?</p>



<a name="272428338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272428338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272428338">(Feb 18 2022 at 17:07)</a>:</h4>
<p>I suppose it's reasonable, in practical terms it's not like any code will stop compiling, at least not until alternative Rust backends start becoming feasible. And the list can always be expanded.</p>



<a name="272428832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272428832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272428832">(Feb 18 2022 at 17:11)</a>:</h4>
<p>Yes, it's easier to expand this list than to shrink it.</p>



<a name="272430919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272430919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272430919">(Feb 18 2022 at 17:29)</a>:</h4>
<p>I'll take a look at the list today, see if anything seems missing, and see about getting an approval started.</p>



<a name="272433488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272433488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272433488">(Feb 18 2022 at 17:49)</a>:</h4>
<p>I've checked through some of my older code and found uses of <code>.previous</code> which work in a similar way to <code>.popsection</code>.</p>



<a name="272436870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272436870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272436870">(Feb 18 2022 at 18:12)</a>:</h4>
<p>yes i would expect .previous to work</p>



<a name="272504136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272504136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272504136">(Feb 19 2022 at 08:45)</a>:</h4>
<p>I've now posted all the comments I think I need to post to the reference PR.</p>



<a name="272504156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272504156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272504156">(Feb 19 2022 at 08:45)</a>:</h4>
<p>Some additions to the directives list, some details about how we should list directives, and a couple of questions about whether LLVM supports certain directives.</p>



<a name="272531437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272531437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272531437">(Feb 19 2022 at 17:40)</a>:</h4>
<p>As soon as those additions are processed, I'm happy to start an FCP. We should cover that in the next lang meeting, and once we've confirmed consensus we should go ahead and merge it. We can always adjust it later.</p>



<a name="272532385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532385">(Feb 19 2022 at 17:58)</a>:</h4>
<p>I haven't been following this discussion very closely so forgive me if the subject has already been discussed. Are there any plans to have a lint in <code>rustc</code> based on the pre-compiled list?</p>



<a name="272532425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532425">(Feb 19 2022 at 17:59)</a>:</h4>
<p><span class="user-mention" data-user-id="327095">@Urgau</span> That would require doing a substantial amount of parsing of the <code>asm!</code> block, which we don't have plans to do in the short term. At the moment this list is just intended as documentation of what's supported.</p>



<a name="272532866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532866">(Feb 19 2022 at 18:07)</a>:</h4>
<p>Okay but why substantial ? Aren't they always on a separate line ? And always begin with a "." ?<br>
The lint wouldn't need to understand the asm syntax it just need to recognize without ambiguity directives, no ?</p>



<a name="272532940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532940">(Feb 19 2022 at 18:08)</a>:</h4>
<p>You can use <code>;</code> to separate instructions on the same line. In addition there is <code>//</code> for comments on all platforms in LLVM and also architecture dependent comment characters.</p>



<a name="272532974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532974">(Feb 19 2022 at 18:09)</a>:</h4>
<p><span class="user-mention" data-user-id="327095">@Urgau</span> asm syntax has more complexity than that. Comments, line continuation, string constants, many ways that a . at the start of a line might not be a directive.</p>



<a name="272532976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532976">(Feb 19 2022 at 18:09)</a>:</h4>
<p>So for example <code>.db 1 // .illegal_directive</code> is fine, but <code>nop; .illegal_directive</code> is not.</p>



<a name="272532996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272532996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272532996">(Feb 19 2022 at 18:09)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> Ah, right, I forgot about <code>;</code> as well.</p>



<a name="272533072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272533072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272533072">(Feb 19 2022 at 18:11)</a>:</h4>
<p>I knew I was missing something obvious. Thanks.</p>



<a name="272533736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272533736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272533736">(Feb 19 2022 at 18:24)</a>:</h4>
<p>For extra fun, some assembly dialects use <code>;</code> to indicate the start of a comment like <code>//</code>.</p>



<a name="272534071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272534071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272534071">(Feb 19 2022 at 18:30)</a>:</h4>
<p><span class="user-mention" data-user-id="327095">@Urgau</span> I wouldn't call it obvious; yours was a reasonable suggestion, and it has come up a few times before for the same reason.</p>



<a name="272534178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272534178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272534178">(Feb 19 2022 at 18:32)</a>:</h4>
<p>I think only considering <code>//</code> a comment for the purpose of this lint would be fine. <code>//</code> works on all platforms in LLVM. I'm not sure it also works with gnu as, but cg_clif has code to strip it: <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/f606a5807cc954dc9f01f5a943f8479bdee96e09/src/driver/aot.rs#L350-L355">https://github.com/bjorn3/rustc_codegen_cranelift/blob/f606a5807cc954dc9f01f5a943f8479bdee96e09/src/driver/aot.rs#L350-L355</a></p>



<a name="272534291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272534291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272534291">(Feb 19 2022 at 18:34)</a>:</h4>
<p><code>/*</code> comments also work, and span lines.</p>



<a name="272534487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272534487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272534487">(Feb 19 2022 at 18:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272532940">said</a>:</p>
<blockquote>
<p>You can use <code>;</code> to separate instructions on the same line. In addition there is <code>//</code> for comments on all platforms in LLVM and also architecture dependent comment characters.</p>
</blockquote>
<p>Not always: Some architectures use <code>;</code> as a comment char.</p>



<a name="272534501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272534501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272534501">(Feb 19 2022 at 18:38)</a>:</h4>
<p>I think my current w65 assembler in GNU AS does, since # is used to indicate immediates.</p>



<a name="272534714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272534714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272534714">(Feb 19 2022 at 18:42)</a>:</h4>
<p>(I'm curious how lines would be separated on such platforms, other than newlines)</p>



<a name="272535176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272535176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272535176">(Feb 19 2022 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272504136">said</a>:</p>
<blockquote>
<p>I've now posted all the comments I think I need to post to the reference PR.</p>
</blockquote>
<p>I committed some of the suggestions, and added comments. <br>
I can work on sorting the list either later today or tomorrow (earlier morning, since I plan to stream work on lccc during the day tomorrow).</p>



<a name="272540633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272540633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272540633">(Feb 19 2022 at 20:27)</a>:</h4>
<p>Thank you; will follow up later today or tomorrow.</p>



<a name="272592212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272592212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272592212">(Feb 20 2022 at 13:25)</a>:</h4>
<p>I've sorted the lists and added <code>.intel_syntax</code>/<code>.att_syntax</code>.</p>
<p>One note, I've called it undefined behaviour to leave the asm block in the wrong mode, but this is actually closer to Ill-formed, no diagnostic required (in that it makes running the entire program UB, not just specifically entering and leaving the asm block), because it could actually "leak" outside of the function and to code that can be executed without touching the asm block at all. I wonder if that should be changed for all the "You must revert the state of the assembler back to the default" UB.</p>



<a name="272595974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272595974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272595974">(Feb 20 2022 at 14:34)</a>:</h4>
<p>One thing I thought of that might be nice to explore, but not right away, is making "assembler-specific behaviour" to "implementation-defined behaviour" from what it is currently (which I would assume is "unspecified behaviour).<br>
This would require implementations to document any additional directives or additional syntax it supports (Note: rustc+llvm saying "whatever llvm does" would be valid documentation, albeit vague). I thought of this because, realistically, an implementation (if we define it as the tuple of: driver opetions, frontend+version, backend+version) likely would differ wildly between uses in what directives it supports.<br>
We could also call the behaviour of using operands in the wrong assembler mode implementation-defined, since I don't really see more than two options: syntactic interpolation(which breaks, but may be fixable), and semantic interpolation (which doesn't).</p>



<a name="272602557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602557">(Feb 20 2022 at 16:38)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> I had been thinking of it as compile-time undefined, not runtime.</p>



<a name="272602610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602610">(Feb 20 2022 at 16:39)</a>:</h4>
<p>As in, it's undefined what the emitted code does.</p>



<a name="272602624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602624">(Feb 20 2022 at 16:39)</a>:</h4>
<p>Yeah, which, in C++ terms is usually called ill-formed, no diagnostic required.</p>



<a name="272602678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602678">(Feb 20 2022 at 16:40)</a>:</h4>
<p>(In particular, it implies that a diagnostic is permitted)</p>



<a name="272602701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602701">(Feb 20 2022 at 16:40)</a>:</h4>
<p>Sounds accurate, but also, in general I want to define whatever terms we're using, and not just borrow them from the C++ spec.</p>



<a name="272602780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602780">(Feb 20 2022 at 16:42)</a>:</h4>
<p>And in the absence of a need for a different term, I had been just using things like "must" vs "should".</p>



<a name="272602781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602781">(Feb 20 2022 at 16:42)</a>:</h4>
<p>Sure. This can probably be changed for an actual spec (I don't believe any documentation currently uses ill-formed in general anyways) just a note of how I've been thinking about it.</p>



<a name="272602844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272602844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272602844">(Feb 20 2022 at 16:43)</a>:</h4>
<p>Fair enough. Definitely nothing wrong with learning from other specs. I just expect that our spec process will want to give careful consideration to how we want to relate to our community and similar, in the phrasings it uses and the strategies of definitions it uses.</p>



<a name="272603032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272603032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272603032">(Feb 20 2022 at 16:46)</a>:</h4>
<p>(Which, I also recognize, is a trade-off with familiarity from other specs. But one to consider, because I expect on balance the primary audience of our spec will be Rust people, more so than spec people.)</p>



<a name="272603266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272603266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272603266">(Feb 20 2022 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> Regarding the syntax directives, I wanted to make sure: do you have any other reason not to add them, other than supporting the syntaxes they switch to (which we already have an option for)? Because they don't seem especially critical, I just added them because we effectively support them anyway and it didn't seem like it would hurt to document that.</p>



<a name="272603395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272603395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272603395">(Feb 20 2022 at 16:53)</a>:</h4>
<p>Unrelated: commit <a href="https://github.com/rust-lang/reference/pull/1168/commits/d5ded80d639536a61009cedcb8f129c06b7ea14e">https://github.com/rust-lang/reference/pull/1168/commits/d5ded80d639536a61009cedcb8f129c06b7ea14e</a> seems to have reverted a bunch of other changes.</p>



<a name="272603405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272603405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272603405">(Feb 20 2022 at 16:53)</a>:</h4>
<p>No, I have no issues, as long as I'm not required to error on <code>{}</code> intel interpolations when switched to <code>.att_syntax prefix</code>.<br>
The main issue was not wanting to have to support at&amp;t syntax.</p>



<a name="272603434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272603434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272603434">(Feb 20 2022 at 16:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272603395">said</a>:</p>
<blockquote>
<p>Unrelated: commit <a href="https://github.com/rust-lang/reference/pull/1168/commits/d5ded80d639536a61009cedcb8f129c06b7ea14e">https://github.com/rust-lang/reference/pull/1168/commits/d5ded80d639536a61009cedcb8f129c06b7ea14e</a> seems to have reverted a bunch of other changes.</p>
</blockquote>
<p>Yeah, I'll fix that later. I've been using <a href="http://github.dev">github.dev</a>, and it normally works fine, but apparently it does that.</p>



<a name="272604162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272604162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272604162">(Feb 20 2022 at 17:06)</a>:</h4>
<p>As much as I would <em>like</em> it to be the case that other Rust compilers error in every case rustc does, in practice that isn't always going to be feasible, and this particular case doesn't seem especially harmful. :)</p>



<a name="272604202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272604202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272604202">(Feb 20 2022 at 17:07)</a>:</h4>
<p>I would certainly like to <em>minimize</em> cases where error behavior diverges.</p>



<a name="272604219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272604219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272604219">(Feb 20 2022 at 17:07)</a>:</h4>
<p>But it's less important than other things, most of the time, unless it actually meaningfully extends the language.</p>



<a name="272604238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272604238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272604238">(Feb 20 2022 at 17:07)</a>:</h4>
<p>(TBH, erroring here would actually be not that much more difficult, in fact, it's more fiesible, since I could issue an error for <code>mov ${}, rax</code> in <code>.att_syntax</code> mode, whereas syntactic interpolations could not)</p>



<a name="272624051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272624051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272624051">(Feb 20 2022 at 23:25)</a>:</h4>
<p>I think I've fixed the mess up in d5ded80.</p>



<a name="272722262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722262">(Feb 21 2022 at 18:34)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> TIL that <code>.intel_syntax</code> seems to default to <code>noprefix</code>, and <code>.intel_syntax noprefix</code> seems to be redundant.</p>



<a name="272722502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722502">(Feb 21 2022 at 18:37)</a>:</h4>
<p>It is, yes. It's also technically noted as unsupported (in the current form). Should I remove that reference from earlier in the document, then (or should that be left to a different reference pr)?</p>



<a name="272722764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722764">(Feb 21 2022 at 18:40)</a>:</h4>
<p>Which reference?</p>



<a name="272722917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722917">(Feb 21 2022 at 18:42)</a>:</h4>
<p>Oh, do you mean the line <code> On x86, the `.intel_syntax noprefix` mode of GAS is used by default.</code>?</p>



<a name="272722934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722934">(Feb 21 2022 at 18:42)</a>:</h4>
<p>Yeah, that one.</p>



<a name="272722940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722940">(Feb 21 2022 at 18:42)</a>:</h4>
<p>I think that line should perhaps get tweaked to help people know that <code>noprefix</code> is the default for <code>.intel_syntax</code>, but not in this PR.</p>



<a name="272722971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272722971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272722971">(Feb 21 2022 at 18:42)</a>:</h4>
<p>I think the only other question to settle in this PR is the current separation between directives valid in all asm and directives valid in global_asm.</p>



<a name="272723005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723005">(Feb 21 2022 at 18:43)</a>:</h4>
<p>When I read that section it wasn't clear to me which one was the default and how to set it back to the original behavior as required</p>



<a name="272723073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723073">(Feb 21 2022 at 18:44)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> I don't think I understand your objection to limiting <code>asm</code> directives on the basis of two-pass assembly.</p>



<a name="272723080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723080">(Feb 21 2022 at 18:44)</a>:</h4>
<p>The above section? Or the one indicating how it's supported in the PR?</p>



<a name="272723085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723085">(Feb 21 2022 at 18:44)</a>:</h4>
<p>I assume there isn't any convenient <code>.reset_asm_state</code> directive to call</p>



<a name="272723092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723092">(Feb 21 2022 at 18:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272723085">said</a>:</p>
<blockquote>
<p>I assume there isn't any convenient <code>.reset_asm_state</code> directive to call</p>
</blockquote>
<p>Unfortunately no.</p>



<a name="272723120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723120">(Feb 21 2022 at 18:44)</a>:</h4>
<p>the section in the PR about <code>.intel_syntax</code> and <code>.att_syntax</code></p>



<a name="272723128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723128">(Feb 21 2022 at 18:44)</a>:</h4>
<p>If there was such a reset directive, we'd probably auto-insert that at the end of every <code>.asm</code> block.</p>



<a name="272723159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723159">(Feb 21 2022 at 18:45)</a>:</h4>
<p>if <code>.att_syntax</code> is the default, we could just auto insert that</p>



<a name="272723185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723185">(Feb 21 2022 at 18:45)</a>:</h4>
<p>along with any other directives where we can definitely determine the default state</p>



<a name="272723314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723314">(Feb 21 2022 at 18:47)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> <code>.intel_syntax</code> is the default, unless you use <code>options(att_syntax)</code>. But it seems a little painful to insert an additional amount of text for the assembler to process on the off chance that someone changed a setting that almost nobody changes.</p>



<a name="272723346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723346">(Feb 21 2022 at 18:47)</a>:</h4>
<p>If we had a single reset, that would be worth doing, but without that, there are enough things to reset that we'd have to insert quite a few directives. And some of them aren't resettable in an "absolute" sense (e.g. which section we're in).</p>



<a name="272723354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723354">(Feb 21 2022 at 18:47)</a>:</h4>
<p>also I've been resisting the urge to point out that <code>.</code> is asm state that isn't reset</p>



<a name="272723413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723413">(Feb 21 2022 at 18:48)</a>:</h4>
<p>As in, having a trailing <code>.</code> at the end of an asm block?</p>



<a name="272723430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723430">(Feb 21 2022 at 18:48)</a>:</h4>
<p>no, <code>.</code> meaning the asm instruction pointer</p>



<a name="272723446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723446">(Feb 21 2022 at 18:48)</a>:</h4>
<p>Ah.</p>



<a name="272723488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723488">(Feb 21 2022 at 18:49)</a>:</h4>
<p>True, and that probably needs to get addressed. Advancing the instruction pointer by inserting instructions seems fine, using <code>.org</code> seems likely to wreak havoc though.</p>



<a name="272723820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272723820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272723820">(Feb 21 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272723073">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> I don't think I understand your objection to limiting <code>asm</code> directives on the basis of two-pass assembly.</p>
</blockquote>
<p>So, the way I'd translate inline asm in xlangcodegen-x86 (et. al) is to parse the assembly string when building the instruction stream and doing codegen on the other xir isntructions. This is the early pass, and doesn't have a few things, namely:</p>
<ul>
<li>It doesn't encode the instruction yet,</li>
<li>It doesn't have a binary file or section to write to. Currently, a there's a vec of <code>Instruction(X86Instruction)</code> and <code>Label(String)</code>, where the former is an abstract representation of an x86 instruction, and the latter is a named label. There would also be <code>RawBytes(Vec&lt;u8&gt;)</code>. <br>
After the early pass, the instruction stream produced from writing all of the blocks, expressions, targets, etc. is encoded where the output stream is known. One issue with, e.g. <code>.code16</code>, is that <code>.code16</code> needs to agree when the instruction is built vs. when it's generated, or you'd swap uses of 66h and 67h prefixes, then suddenly <code>.code16; mov ax, word ptr [bx+si]</code> gets encoded as <code>mov eax, dword ptr [rax]</code>.</li>
</ul>



<a name="272724332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272724332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272724332">(Feb 21 2022 at 18:59)</a>:</h4>
<p>Would it be possible to have an inline asm "instruction" where the inline asm is parsed only when actually emitting this instruction?</p>



<a name="272725108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272725108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272725108">(Feb 21 2022 at 19:05)</a>:</h4>
<p>There is an inline asm instruction in xir, but like the other xir instructions, it would be handled during the early pass.</p>



<a name="272726070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272726070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272726070">(Feb 21 2022 at 19:15)</a>:</h4>
<p>Why not treat the whole inline assembly as an opaque instruction all the way to the late pass. Then, after register allocation, substitute in register names and run an assembler separately over the inline assembly. That should get you a set of raw bytes that you can insert back in the original instruction stream.</p>



<a name="272726251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272726251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272726251">(Feb 21 2022 at 19:17)</a>:</h4>
<p>Allows me to mark registers as "Allocated" for the length of the asm block and insert saving code before and after the assembly.</p>



<a name="272726565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272726565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272726565">(Feb 21 2022 at 19:21)</a>:</h4>
<p>Sure, but you can do that at the granularity of a whole inline asm block at once. That's what all the <code>in</code>/<code>out</code> constraints are for.</p>



<a name="272730188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272730188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272730188">(Feb 21 2022 at 20:03)</a>:</h4>
<p>Well, one of the main things is that it gets parsed into <code>X86Instruction</code>s anyways, since the output needs a <code>Section</code> (to write addresses). The labels would also be easier to handle in the first pass.</p>



<a name="272738423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272738423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272738423">(Feb 21 2022 at 21:53)</a>:</h4>
<p>One other thing I also considered is that carrying the asm block into the writer requires carrying more information that's nominally useless (Specifically, it requires carrying expression stack information to satisfy unbounded constraints, and I think that's the kind of information that could very easily desync from pass 2).</p>



<a name="272738573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272738573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272738573">(Feb 21 2022 at 21:55)</a>:</h4>
<p>Stack Desyncs are <em>fun</em>, and compound quickly arround opaque bounderies, such as jumps, and I'd also assume asm expressions (can you enter one asm block, jmp to a different one, then exit the second one, as long as you don't cross a function boundary?)</p>



<a name="272739654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739654">(Feb 21 2022 at 22:10)</a>:</h4>
<p>no, jumping between asm blocks is not allowed. gcc and clang have a way to do this for as long as you explicitly specify which asm block jumps to which. rust doesn't provide a way to allow this. it would also be hard to implement with the external assembler fallback implementation of inline asm.</p>



<a name="272739669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739669">(Feb 21 2022 at 22:11)</a>:</h4>
<p>Ight.</p>



<a name="272739688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739688">(Feb 21 2022 at 22:11)</a>:</h4>
<p>(Which means I can propagate stack values past an assembly block)</p>



<a name="272739693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739693">(Feb 21 2022 at 22:11)</a>:</h4>
<p><em>nod</em>, you can.</p>



<a name="272739744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739744">(Feb 21 2022 at 22:12)</a>:</h4>
<p>Though they might get modified by the asm block, for instance.</p>



<a name="272739756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739756">(Feb 21 2022 at 22:12)</a>:</h4>
<p>Long-term, I do hope we provide a simple version of what GCC/clang use <code>asm goto</code> for.</p>



<a name="272739767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739767">(Feb 21 2022 at 22:12)</a>:</h4>
<p>But in a less general fashion.</p>



<a name="272739770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739770">(Feb 21 2022 at 22:12)</a>:</h4>
<p>Less of an <code>asm goto</code>, more of an <code>asm if</code> or <code>asm match</code>.</p>



<a name="272739813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739813">(Feb 21 2022 at 22:13)</a>:</h4>
<p>Well, I doubt it, since 90% of the stack is magic constant values (stack here is a virtual expression stack used by xir to pass operands to xir instructions, not the actual physical stack).</p>



<a name="272739964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739964">(Feb 21 2022 at 22:15)</a>:</h4>
<p>I see. That's a bit of a confusing conflation there. :)</p>



<a name="272739967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272739967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272739967">(Feb 21 2022 at 22:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272739744">said</a>:</p>
<blockquote>
<p>Though they might get modified by the asm block, for instance.</p>
</blockquote>
<p>Also, correct me if I'm wrong, but IIRC, asm blocks are only allowed to modify inputs to the block, and globals.</p>



<a name="272740070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740070">(Feb 21 2022 at 22:17)</a>:</h4>
<p>If you don't pass <code>nostack</code>, you can modify things on the stack; you'd have to pass in an address or similar to <em>find</em> it with, but the compiler may not be tracking that you've done so.</p>



<a name="272740121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740121">(Feb 21 2022 at 22:18)</a>:</h4>
<p>Or more generally, the compiler isn't doing full alias analysis to find out what you <em>might</em> access from an <code>asm</code> block.</p>



<a name="272740143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740143">(Feb 21 2022 at 22:18)</a>:</h4>
<p>Well, the locals might not <em>be</em> on the hardware stack.</p>



<a name="272740147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740147">(Feb 21 2022 at 22:18)</a>:</h4>
<p>(Unless you've passed a pointer to them)</p>



<a name="272740175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740175">(Feb 21 2022 at 22:19)</a>:</h4>
<p>I'm not suggesting that <code>asm</code> can magically walk up the stack and modify something, just that we don't rule out that <code>asm</code> can get an address in a way that the compiler doesn't know about and use it for writing.</p>



<a name="272740179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740179">(Feb 21 2022 at 22:19)</a>:</h4>
<p>Unless you pass <code>options(nostack)</code>.</p>



<a name="272740282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740282">(Feb 21 2022 at 22:20)</a>:</h4>
<p>As one random example, you <em>could</em> have a raw pointer to something on the stack, that you cast to an integer and stuff in a location somewhere, then run an asm block, then the thing on the stack is modified.</p>



<a name="272740310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740310">(Feb 21 2022 at 22:21)</a>:</h4>
<p>Sure, but the asm block needs to have access to the address.</p>



<a name="272740317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740317">(Feb 21 2022 at 22:21)</a>:</h4>
<p>Right, but the compiler might not have enough analysis to <em>know</em> that.</p>



<a name="272740334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740334">(Feb 21 2022 at 22:21)</a>:</h4>
<p>So it has to assume that such an access might happen, and not cache things in registers across an asm block.</p>



<a name="272740385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740385">(Feb 21 2022 at 22:22)</a>:</h4>
<p>That just goes to provenance, which is a whole can of worms, but suffice it to say, I think any good compiler already knows how to deal with escaped provenance.</p>



<a name="272740506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740506">(Feb 21 2022 at 22:24)</a>:</h4>
<p>But I highly doubt a compiler is unable to vaporise <code>x</code> entirely in the following code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="fm">asm!</span><span class="p">(</span><span class="s">"/*do some shenanigans*/"</span><span class="p">);</span><span class="w"></span>
<span class="n">x</span><span class="w"></span>
</code></pre></div>
<p>Otherwise, that turns into a huge problem in that <code>asm</code> could be used inside a black_box function the compiler can't analyze. And in that case, we compiler devs love to be spooky and say that kills alias analysis entirely.</p>



<a name="272740564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740564">(Feb 21 2022 at 22:25)</a>:</h4>
<p>I agree in principle; the compiler <em>can</em> at least tell that a pointer to <code>x</code> has been passed somewhere-or-other and thus it can't make assumptions about <code>x</code> anymore across certain types of boundaries, even if it doesn't know that the somewhere-or-other is the <code>asm</code> block.</p>



<a name="272740656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740656">(Feb 21 2022 at 22:27)</a>:</h4>
<p>So in some manner, the asm block does need to get access to the address. Either:</p>
<ul>
<li>it's a global variable that isn't internal linkage (which basically doesn't happen for rust), or it's the same TU, which compilers already are ware can change,</li>
<li>A pointer was given to the asm block, possibly indirectly, or</li>
<li>A pointer to the local escaped (IE. was cast to an integer)<br>
So, there's nothing at all new here.</li>
</ul>



<a name="272740785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740785">(Feb 21 2022 at 22:29)</a>:</h4>
<p>Any good optimizing compiler already knows how to deal with code it can't analyze.</p>



<a name="272740908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272740908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272740908">(Feb 21 2022 at 22:30)</a>:</h4>
<p>I'm aware. I just didn't want to ignore the statement "can propagate stack values past an assembly block" without noting the unstated assumptions of what the compiler <em>does</em> have to handle.</p>



<a name="272741013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741013">(Feb 21 2022 at 22:32)</a>:</h4>
<p>Well, it can propagate vstack values past an assembly block as long as the assembly block isn't a control flow destination.</p>



<a name="272741061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741061">(Feb 21 2022 at 22:33)</a>:</h4>
<p>Just to clarify, all <code>option(nostack)</code> does is allow the function to use the stack red zone on some platforms. Basically if you <em>don't</em> use <code>option(nostack)</code> then the asm block is allowed to allocate temporary stack space (the stack pointer must be restored before exiting the asm block).</p>



<a name="272741065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741065">(Feb 21 2022 at 22:33)</a>:</h4>
<p>It has nothing to do with arbitrary access to locals on the stack.</p>



<a name="272741332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741332">(Feb 21 2022 at 22:37)</a>:</h4>
<p>Which is the main thing I care about, because vstack desyncs issues compound at points where stack values are forced go from transparent (constant, temporary value, global/label/local address, etc.) to opaque. At those points I want to minimize the number of places that have to agree about the contents of the vstack, which would be very annoying if I have to handle assigning registers/constraints at output time (when the vstack is otherwise basically erased).</p>



<a name="272741460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741460">(Feb 21 2022 at 22:39)</a>:</h4>
<p>Honestly the simplest thing to do is to just treat an asm block like an opaque function call with a custom calling convention. This is what rustc does and also what LLVM does for the entire middle-end and most of the back-end.</p>



<a name="272741564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741564">(Feb 21 2022 at 22:40)</a>:</h4>
<p>I just attempted to poke rfcbot for an FCP, but it doesn't seem to have heard me: <a href="https://github.com/rust-lang/reference/pull/1168#issuecomment-1047274739">https://github.com/rust-lang/reference/pull/1168#issuecomment-1047274739</a></p>



<a name="272741724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741724">(Feb 21 2022 at 22:43)</a>:</h4>
<p>I don't think a full FCP is needed here. This is mainly clarifying the specification of asm!, not making an actual language/compiler change.</p>



<a name="272741751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741751">(Feb 21 2022 at 22:43)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> I've nominated it for tomorrow's lang meeting, and in practice I'm hoping it's a fast signoff with minimal objection.</p>



<a name="272741807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741807">(Feb 21 2022 at 22:44)</a>:</h4>
<p>I do think, in principle, that it's a small and reasonably reversible change.</p>



<a name="272741818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741818">(Feb 21 2022 at 22:44)</a>:</h4>
<p>So I don't think it has a hard requirement of an FCP.</p>



<a name="272741824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741824">(Feb 21 2022 at 22:44)</a>:</h4>
<p>It just seemed like the easiest solution to make sure this gets handled. :)</p>



<a name="272741851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272741851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272741851">(Feb 21 2022 at 22:45)</a>:</h4>
<p>Unrelated: <span class="user-mention" data-user-id="257758">@Connor Horman</span> Could you trim trailing whitespace so that CI passes, please?</p>



<a name="272742051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742051">(Feb 21 2022 at 22:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272741460">said</a>:</p>
<blockquote>
<p>Honestly the simplest thing to do is to just treat an asm block like an opaque function call with a custom calling convention. This is what rustc does and also what LLVM does for the entire middle-end and most of the back-end.</p>
</blockquote>
<p>Even opaque function calls have to interact with the vstack, to recieve parameters, and push results. This is functionally doing exactly what llvm is doing, except I have ideas down the road to look at the asm and set hint attributes that soft-assume the asm block isn't doing things (soft-assume meaning the codegen may be pessimized if it does, rather than it being hard UB).</p>



<a name="272742064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742064">(Feb 21 2022 at 22:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272741851">said</a>:</p>
<blockquote>
<p>Unrelated: <span class="user-mention silent" data-user-id="257758">Connor Horman</span> Could you trim trailing whitespace so that CI passes, please?</p>
</blockquote>
<p>Probably. I have no clue where the trailing whitespace is, but I'll look.</p>



<a name="272742079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742079">(Feb 21 2022 at 22:49)</a>:</h4>
<p>Yeah, style-check should really print line numbers.</p>



<a name="272742088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742088">(Feb 21 2022 at 22:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272723820">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272723073">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> I don't think I understand your objection to limiting <code>asm</code> directives on the basis of two-pass assembly.</p>
</blockquote>
<p>So, the way I'd translate inline asm in xlangcodegen-x86 (et. al) is to parse the assembly string when building the instruction stream and doing codegen on the other xir isntructions. This is the early pass, and doesn't have a few things, namely:</p>
<ul>
<li>It doesn't encode the instruction yet,</li>
<li>It doesn't have a binary file or section to write to. Currently, a there's a vec of <code>Instruction(X86Instruction)</code> and <code>Label(String)</code>, where the former is an abstract representation of an x86 instruction, and the latter is a named label. There would also be <code>RawBytes(Vec&lt;u8&gt;)</code>. <br>
After the early pass, the instruction stream produced from writing all of the blocks, expressions, targets, etc. is encoded where the output stream is known. One issue with, e.g. <code>.code16</code>, is that <code>.code16</code> needs to agree when the instruction is built vs. when it's generated, or you'd swap uses of 66h and 67h prefixes, then suddenly <code>.code16; mov ax, word ptr [bx+si]</code> gets encoded as <code>mov eax, dword ptr [rax]</code>.</li>
</ul>
</blockquote>
<p>So, I'm trying to process this, and I'm still not seeing why <code>.code16</code> is <em>more</em> an issue with asm than global_asm. It's additional state to track, certainly.</p>



<a name="272742123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742123">(Feb 21 2022 at 22:49)</a>:</h4>
<p>It doesn't seem like a problem to leave instructions un-encoded, and wait to encode them until later.</p>



<a name="272742195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742195">(Feb 21 2022 at 22:50)</a>:</h4>
<p>global_asm is handled different. It could basically pass right through to the output, whereas <code>asm!</code> can intervene in the xir expression stream and can have all the fun stuff.</p>



<a name="272742236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742236">(Feb 21 2022 at 22:51)</a>:</h4>
<p>Would it be possible to explain this in terms that don't assume I know anything about lccc's architecture, without having to explain lccc's architecture as a prerequisite? :)</p>



<a name="272742308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742308">(Feb 21 2022 at 22:52)</a>:</h4>
<p>Deferring encoding of instructions <em>seems</em> like it addresses the issue.</p>



<a name="272742362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742362">(Feb 21 2022 at 22:53)</a>:</h4>
<p>If anything, doing this in two passes rather than one seems <em>easier</em>, not harder.</p>



<a name="272742971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742971">(Feb 21 2022 at 23:02)</a>:</h4>
<p>Well, it's caused by defferring. Basically, I have to ensure that I track the state changes like <code>.code16</code> twice - when I'm parsing the instructions and generating the abstract form where it produces 16-bit addresses, and then again when encoding and decides what prefixes to apply.</p>



<a name="272742986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272742986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272742986">(Feb 21 2022 at 23:02)</a>:</h4>
<p>Tracking state changes in two places is a great way to have those two places disagree.</p>



<a name="272743041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743041">(Feb 21 2022 at 23:03)</a>:</h4>
<p>(Avoiding redundant state that can disagree is a design principle of lccc, and the many layers of the system are currently designed in that manner)</p>



<a name="272743094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743094">(Feb 21 2022 at 23:04)</a>:</h4>
<p>I definitely agree with only tracking it once.</p>



<a name="272743098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743098">(Feb 21 2022 at 23:04)</a>:</h4>
<p>So, why isn't it something that gets included <em>in</em> the abstract form?</p>



<a name="272743179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743179">(Feb 21 2022 at 23:05)</a>:</h4>
<p>Calculating REX/VEX/EVEX/66/67 prefixes in general is a fun task in x86.</p>



<a name="272743245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743245">(Feb 21 2022 at 23:06)</a>:</h4>
<p>That general group is mostly something that the encoder needs to handle.</p>



<a name="272743306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743306">(Feb 21 2022 at 23:07)</a>:</h4>
<p>I think I understood that already. But that still doesn't tell me why you can't include "this is in code16 mode" as state attached to the abstract instructions.</p>



<a name="272743316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743316">(Feb 21 2022 at 23:08)</a>:</h4>
<p>Well really, it needs to be handled all at once.<br>
The encoder is the best place for that handling.</p>



<a name="272743573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743573">(Feb 21 2022 at 23:10)</a>:</h4>
<p>So, let me back up a step. I'm sure that there's a pile of reasoning you've already done about lccc that explains how "The encoder is the best place for that handling." gives some obvious indication of what the problem is or where the impedance mismatch is. I don't have access to any of that reasoning, though, so from my perspective, that doesn't actually answer my question in any way.</p>



<a name="272743611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743611">(Feb 21 2022 at 23:11)</a>:</h4>
<p>My response to "I want to handle that state in one place, not two" is "that sounds like a good idea, so could you record code16 as state and handle it in one place, not two?"</p>



<a name="272743982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272743982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272743982">(Feb 21 2022 at 23:16)</a>:</h4>
<p>Well, this part of the infrastructure (the X86Instruction type, and the encoder) is actually in a different project, which is designed to be more generalized.<br>
The encoder needs to know mode information in the general case (some instructions are encoded differently, some can't be encoded, some do <em>fun</em> things the encoder needs to handle), and the way an out-of-line assembler (which would use the same infrastructure) or global_asm would work would be by setting the mode while producing and encoding the instructions. This works because the steps are interleaved.</p>



<a name="272744004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272744004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272744004">(Feb 21 2022 at 23:17)</a>:</h4>
<p>(x86 is generally a mess, so generalizing stuff about it is a pain)</p>



<a name="272744126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272744126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272744126">(Feb 21 2022 at 23:19)</a>:</h4>
<p>(Although, on the same infrastructure, one might wonder how the heck I'd deal with w65... and I'll cross that bridge when I come to it, which is either in the next couple of weeks, or next year)</p>



<a name="272744346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272744346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272744346">(Feb 21 2022 at 23:23)</a>:</h4>
<p>TBH... It probably could. It just would make it annoying to construct the instructions in the majority of cases... Which it already is. And easily cause problems if you created an instruction in a mode it can't be encoded in, but eh.</p>



<a name="272744541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272744541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272744541">(Feb 21 2022 at 23:27)</a>:</h4>
<p>Ok, I withdraw my objections regarding attribute control directives in <code>asm</code>.</p>



<a name="272745353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272745353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272745353">(Feb 21 2022 at 23:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272744346">said</a>:</p>
<blockquote>
<p>And easily cause problems if you created an instruction in a mode it can't be encoded in, but eh.</p>
</blockquote>
<p>Which can arise today with existing assemblers as well, they just complain in weirder ways or give bad code. If your compiler can reliably say "hey, I can't assemble this instruction in this mode" rather than emitting garbage, that'll make it above average. ;)</p>



<a name="272745388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272745388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272745388">(Feb 21 2022 at 23:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272744541">said</a>:</p>
<blockquote>
<p>Ok, I withdraw my objections regarding attribute control directives in <code>asm</code>.</p>
</blockquote>
<p>I really appreciate you taking the time to think through it and how it would work. If there was some critical issue where it created a fundamental limitation on otherwise reasonable compiler design, I'd very much want to know it; I just wasn't seeing it, and wasn't in the position to be able to.</p>



<a name="272745524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272745524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272745524">(Feb 21 2022 at 23:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272745353">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272744346">said</a>:</p>
<blockquote>
<p>And easily cause problems if you created an instruction in a mode it can't be encoded in, but eh.</p>
</blockquote>
<p>Which can arise today with existing assemblers as well, they just complain in weirder ways or give bad code. If your compiler can reliably say "hey, I can't assemble this instruction in this mode" rather than emitting garbage, that'll make it above average. ;)</p>
</blockquote>
<p>Wow...  Low bar. That could probably be implemented in maybe about 2 hours.. That being said, I do have other things to use said 2 hours on, so that's probably a "Would be nice" feature that I'd look into either in the next couple weeks or next year.</p>



<a name="272745568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272745568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272745568">(Feb 21 2022 at 23:45)</a>:</h4>
<p>I mean, in general, even if you don't implement <code>.code16</code> at all, you'll compile 99.9% of Rust code; you just wouldn't be able to compile some random bits of firmware or kernels or similar.</p>



<a name="272745579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272745579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272745579">(Feb 21 2022 at 23:46)</a>:</h4>
<p>So, in adding support for it, the amount of handling for "you've used it wrong" doesn't need to be <em>that</em> high.</p>



<a name="272745650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272745650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272745650">(Feb 21 2022 at 23:47)</a>:</h4>
<p>Well, I also want to support i86-pc-elf (generally). Because that's a productive use of my time.</p>



<a name="272746146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746146">(Feb 21 2022 at 23:56)</a>:</h4>
<p>Unrelated to the above: I've fixed the trailing whitespace.</p>



<a name="272746172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746172">(Feb 21 2022 at 23:57)</a>:</h4>
<p>(And also unified the lists. I don't see anything else that's more complicated)</p>



<a name="272746203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746203">(Feb 21 2022 at 23:57)</a>:</h4>
<p>I've resolved the concern (which rfcbot should notice Any Day Now).</p>



<a name="272746243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746243">(Feb 21 2022 at 23:58)</a>:</h4>
<p>And I'll make sure we take a look at this tomorrow.</p>



<a name="272746300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746300">(Feb 21 2022 at 23:59)</a>:</h4>
<p>Thanks again for working on this.</p>



<a name="272746431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746431">(Feb 22 2022 at 00:00)</a>:</h4>
<p>Indeed. Thanks for helping get it in from the procedural side.<br>
Hopefully this is the last time something like this happens, and I only need to complain about how proposed rust features will be annoying to implement normally.</p>



<a name="272746463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272746463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272746463">(Feb 22 2022 at 00:01)</a>:</h4>
<p>/me chuckles.</p>



<a name="272749608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272749608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272749608">(Feb 22 2022 at 01:00)</a>:</h4>
<p>I mean you already have to handle all sorts of "fun" details like encoding disjoint between x86 and x86-64, tbh.</p>



<a name="272753167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272753167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272753167">(Feb 22 2022 at 02:17)</a>:</h4>
<p>Yeah. Can't wait to support 32-bit outputs or 16-bit outputs.</p>



<a name="272753382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272753382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272753382">(Feb 22 2022 at 02:21)</a>:</h4>
<p>Doing it uniformly is easy, though (just need to make sure to not use <code>RipRel</code> mode for loading global/label addresses <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span> outside of long mode).</p>



<a name="272754296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272754296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272754296">(Feb 22 2022 at 02:41)</a>:</h4>
<p>But yeah, yall rustc devs dodged quite a bullet by just using llvm.</p>



<a name="272895221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272895221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272895221">(Feb 23 2022 at 02:01)</a>:</h4>
<p>BTW, what would the process be to add something to the list?<br>
I was actually just informed of one that was missed that would be in a similar category as others listed: <code>.weak_reference</code> on Apple platforms.<br>
Obviously not a "Oh heck, scramble everything" problem, since it will still work, just curious, though.</p>



<a name="272911155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272911155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272911155">(Feb 23 2022 at 06:55)</a>:</h4>
<p>File a PR I think.</p>



<a name="272969601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272969601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272969601">(Feb 23 2022 at 16:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272911155">said</a>:</p>
<blockquote>
<p>File a PR I think.</p>
</blockquote>
<p>I assume against the reference, with an fcp?</p>



<a name="272970265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272970265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272970265">(Feb 23 2022 at 16:09)</a>:</h4>
<p>Against the reference, yeah.</p>



<a name="272970387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272970387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272970387">(Feb 23 2022 at 16:10)</a>:</h4>
<p>I do think this is the kind of thing for which an FCP is somewhat overkill. Really wishing we had the new rustbot process available.</p>



<a name="272970624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272970624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272970624">(Feb 23 2022 at 16:12)</a>:</h4>
<p>The only thing I can really think is that adding to the list is irreversible, since it's stabilizing new guarantees. It also would be interesting in that it's instastable effectively - correct me if I'm wrong but T-lang doesn't currently have anything that becomes instastable.</p>



<a name="272970727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272970727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272970727">(Feb 23 2022 at 16:13)</a>:</h4>
<p>(Lexical stuff, maybe?)</p>



<a name="272971969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272971969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272971969">(Feb 23 2022 at 16:22)</a>:</h4>
<p>Nominally, it's not a huge deal how it's done from my end. Though I would like for there to be a way for interested parties (including myself) to know what's going on in that regard. Until then, though, I guess it's just another repo to check.</p>



<a name="272973216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272973216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272973216">(Feb 23 2022 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> It's not especially instant to add things, though; people have to notice. It seems like the FCP is more important if we add to the list of directives that aren't linted, for instance.</p>



<a name="272973587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272973587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272973587">(Feb 23 2022 at 16:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/asm!.20and.20backends/near/272973216">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> It's not especially instant to add things, though; people have to notice. It seems like the FCP is more important if we add to the list of directives that aren't linted, for instance.</p>
</blockquote>
<p>Instant here is "when it's added that's it, it's stable (no unstable feature, no buffer, except the nightly-stable buffer)", not that it takes zero time to add.</p>



<a name="272974032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/272974032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#272974032">(Feb 23 2022 at 16:36)</a>:</h4>
<p>That's really the main thing, I'm concerned about if the process is something else: That it's basically irreversible to add to the list.</p>



<a name="273830506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/273830506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#273830506">(Mar 02 2022 at 16:07)</a>:</h4>
<p><a href="https://github.com/rust-lang/reference/pull/1174">https://github.com/rust-lang/reference/pull/1174</a><br>
Uh oh.</p>



<a name="273839339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/273839339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#273839339">(Mar 02 2022 at 16:59)</a>:</h4>
<p>Argh.</p>



<a name="273861799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/asm%21%20and%20backends/near/273861799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/asm!.20and.20backends.html#273861799">(Mar 02 2022 at 19:16)</a>:</h4>
<p>argh</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>