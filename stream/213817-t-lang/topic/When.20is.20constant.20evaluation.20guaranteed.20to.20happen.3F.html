<html>
<head><meta charset="utf-8"><title>When is constant evaluation guaranteed to happen? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html">When is constant evaluation guaranteed to happen?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269640621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269640621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alan Wu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269640621">(Jan 27 2022 at 21:28)</a>:</h4>
<p>Hello! I recently ran into some <a href="https://github.com/rust-lang/rust/issues/91877">corner cases</a> with constant evaluation and <code>const_panic</code> and through working with folks to document things I've realized that it's unclear in what situations CTFE is guaranteed to happen and whether the guarantees are stabilized. Ralf Jung <a href="https://github.com/rust-lang/reference/pull/1147#issuecomment-1023622753">encouraged</a> me to ask here.</p>
<p>As implemented it currently looks like:</p>
<p>1. Unnamed free constants (<code>const _: () = ...;</code>) always trigger CTFE<br>
  2. Named free constants always trigger CTFE, even if unused<br>
  3. For associated constants inside impl blocks, it triggers when it's referenced. Ralf Jung kindly provided some <a href="https://github.com/rust-lang/rust/issues/91877#issuecomment-995026270">details</a> about that</p>
<p>My question is, is the behavior in (1) and (2) actually stabilized? It feels like at least (1) is stabilized since it's used in <a href="https://github.com/rust-lang/rust/issues/89006">the stabilization issue</a> for <code>const_panic</code> and in the release notes,  but I couldn't find explicit mentions.</p>



<a name="269643677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269643677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269643677">(Jan 27 2022 at 21:49)</a>:</h4>
<p>1&amp;2 are only behind a lint, they are not hard errors out of backwards compatibility reasons.</p>



<a name="269643889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269643889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269643889">(Jan 27 2022 at 21:50)</a>:</h4>
<p>Well, for <code>panic</code> specifically they are a hard error, but not for other failures</p>



<a name="269644292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269644292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269644292">(Jan 27 2022 at 21:51)</a>:</h4>
<p>We want to move to always making it a hard error, but the procedure is unclear. We should probably crater it and see if we can just get away with it</p>



<a name="269644469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269644469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269644469">(Jan 27 2022 at 21:52)</a>:</h4>
<p>3 is impossible to do eagerly in general, as it may depend on generic parameters</p>



<a name="269645330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269645330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alan Wu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269645330">(Jan 27 2022 at 21:58)</a>:</h4>
<p>Is (1) always evaluating the right hand side stabilized? If evaluation panics, it's a hard error, but I'm not sure if evaluation is guaranteed to happen at all.</p>



<a name="269702833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269702833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269702833">(Jan 28 2022 at 08:39)</a>:</h4>
<p>The result of it happening successfully and then having its result not used and not happening should be indistinguishable, no?</p>



<a name="269707523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269707523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269707523">(Jan 28 2022 at 09:21)</a>:</h4>
<p>Evaluation is guaranteed for free constants. We have a visitor whose sole purpose is doing this</p>



<a name="269815071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20constant%20evaluation%20guaranteed%20to%20happen%3F/near/269815071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alan Wu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20constant.20evaluation.20guaranteed.20to.20happen.3F.html#269815071">(Jan 28 2022 at 22:58)</a>:</h4>
<p>Thank you oli! I would like to add this guarantee about free constants to the reference. Do you think a FCP is warranted to make sure everyone is onboard with this is being a stable feature of the language like Ralf <a href="https://github.com/rust-lang/reference/pull/1147#issuecomment-1023622753">suggested</a>? I'll need to review again, but I think currently there is nothing about this in the reference.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>