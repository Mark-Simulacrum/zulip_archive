<html>
<head><meta charset="utf-8"><title>Unused impl warnings · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html">Unused impl warnings</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249519537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249519537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249519537">(Aug 15 2021 at 16:05)</a>:</h4>
<p>Currently, we never emit an 'unused' warning for trait impls - since all trait impls are 'public', we can't know if they might be used by a downstream crate.<br>
However, there are some cases where we can guarnatee that a trait impl is unused. If we implement a non-auto-trait for a type that's not reachable outside of the current crate (as determined by <code>privacy::AccessLevels</code>, then we can be sure that the only possible usages of that trait impl occur within our crate.</p>



<a name="249519589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249519589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249519589">(Aug 15 2021 at 16:06)</a>:</h4>
<p>I think it would be useful to extend the <code>dead_code</code> lint to trait impls using the above logic. We would still be unable to detect unused trait impls within a multi-crate workspace (like rustc), but this would still be an improvement over the status quo.</p>



<a name="249519684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249519684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249519684">(Aug 15 2021 at 16:08)</a>:</h4>
<p>The actual tracking of used trait impls would be done during trait selection/projection (the interaction with incr comp will be tricky, unfortunately)</p>



<a name="249579466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249579466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249579466">(Aug 16 2021 at 12:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/213817-t-lang/topic/Unused.20impl.20warnings/near/249519684">said</a>:</p>
<blockquote>
<p>The actual tracking of used trait impls would be done during trait selection/projection (the interaction with incr comp will be tricky, unfortunately)</p>
</blockquote>
<p>I guess we would collect this information in <code>InferCtxt</code> during typeck, so we could put it into the <code>TypeckResults</code> datastructure returned by the typeck query</p>



<a name="249579496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249579496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249579496">(Aug 16 2021 at 12:04)</a>:</h4>
<p>but there may be other places creating their own <code>InferCtxt</code> that we could miss</p>



<a name="249623161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249623161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249623161">(Aug 16 2021 at 17:52)</a>:</h4>
<p>It will need to be stored globally, since many implnusages happen in the <code>evaluate_obligation</code> query, which creates a fresh InferCtxt</p>



<a name="249674184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249674184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249674184">(Aug 17 2021 at 03:06)</a>:</h4>
<p>Implementing this turns out be significantly trickier than I thought it would be. Well-formed checking will cause us to 'use' an <code>ImplCandidate</code> for every trait impl (because we try to evaluate <code>MyType as Trait</code> when we see <code>impl Trait for MyType</code>). This causes us to popualte several caches (the query cache for <code>evaluate_obligation</code>, the evaluation cache, etc.), meaning we won't see another <code>ImplCandidate</code> usage for a 'real' usage of the impl</p>



<a name="249674204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249674204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249674204">(Aug 17 2021 at 03:07)</a>:</h4>
<p>Delaying well-formed checking until after 'unused' checking causes a large number of extra errors (and some ICEs) in the test suite, since compilation normally exits early when wf-checking fails</p>



<a name="249697741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249697741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249697741">(Aug 17 2021 at 09:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/213817-t-lang/topic/Unused.20impl.20warnings/near/249623161">said</a>:</p>
<blockquote>
<p>It will need to be stored globally, since many implnusages happen in the <code>evaluate_obligation</code> query, which creates a fresh InferCtxt</p>
</blockquote>
<p>Right. That's what I was afraid of. I still think we should try to come up with a non-global system. Maybe the queries could return a structure containing their result, plus this information ? then we can have a lint that iterates all the queries and aggregates the info?</p>



<a name="249736189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249736189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249736189">(Aug 17 2021 at 15:34)</a>:</h4>
<p>We can perform trait selection from any query, so I think this would end up being effectively the same as a global approach</p>



<a name="249737731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249737731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249737731">(Aug 17 2021 at 15:45)</a>:</h4>
<p>do we have anything else that is global like this?</p>



<a name="249737864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Unused%20impl%20warnings/near/249737864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Unused.20impl.20warnings.html#249737864">(Aug 17 2021 at 15:46)</a>:</h4>
<p>Diagnostics are the main thing - I did some refactoring around this in <a href="https://github.com/rust-lang/rust/pull/87416">https://github.com/rust-lang/rust/pull/87416</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>