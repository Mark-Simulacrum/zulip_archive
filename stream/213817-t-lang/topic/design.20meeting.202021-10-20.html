<html>
<head><meta charset="utf-8"><title>design meeting 2021-10-20 · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html">design meeting 2021-10-20</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258403842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258403842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258403842">(Oct 20 2021 at 16:59)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> and <span class="user-mention" data-user-id="116458">@Charles Lew</span>! There will be a design meeting to discuss, but held on Zulip! <a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety.html">This is the document</a>, but  I am trying to improve it because I'm finding it doesn't give as much context as I wanted. I'm running slower than I'd like. Can we start the meeting in 10 minutes?</p>
<p><a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ">Here is the hackmd I am working on.</a></p>



<a name="258403865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258403865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258403865">(Oct 20 2021 at 16:59)</a>:</h4>
<p>Sure</p>



<a name="258404090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258404090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258404090">(Oct 20 2021 at 17:00)</a>:</h4>
<p>/me waves</p>



<a name="258404802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258404802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258404802">(Oct 20 2021 at 17:04)</a>:</h4>
<p>(The null pointer note makes me wish that <code>*const</code> and friends were non-nullable too, and we just allowed <code>*</code> on <code>Option&lt;non-null raw pointer&gt;</code>.)</p>



<a name="258405636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405636">(Oct 20 2021 at 17:09)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/object.20upcasting.html#250617911">https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/object.20upcasting.html#250617911</a></p>



<a name="258405790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405790">(Oct 20 2021 at 17:10)</a>:</h4>
<p>Would another option be to put the vtable pointer before the object, and use that for a single-pointer "fat pointer"?</p>



<a name="258405818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405818">(Oct 20 2021 at 17:10)</a>:</h4>
<p>(I'm thinking in particular of the object layout that Haskell uses here.)</p>



<a name="258405848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405848">(Oct 20 2021 at 17:11)</a>:</h4>
<blockquote>
<p>Make raw pointer unsizing unsafe</p>
</blockquote>
<p>I think there's another option: make raw pointer <em>upcasting</em> unsafe.<br>
Isn't that the place where the issue actually occurs?</p>



<a name="258405857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405857">(Oct 20 2021 at 17:11)</a>:</h4>
<p>OK, <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> the doc is ready! Let's start reading: <a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ">https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ</a></p>



<a name="258405870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405870">(Oct 20 2021 at 17:11)</a>:</h4>
<p>I'll send out a ping in 10 minutes</p>



<a name="258405975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405975">(Oct 20 2021 at 17:11)</a>:</h4>
<p>feel free to add questions to the end of the doc please, as normal</p>



<a name="258405987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258405987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258405987">(Oct 20 2021 at 17:11)</a>:</h4>
<p>I can transcribe Josh and Taylor's questions I guess</p>



<a name="258406110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258406110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258406110">(Oct 20 2021 at 17:12)</a>:</h4>
<p>(I don't know if my question directly addresses the issue of upcasting, so feel free to deprioritize it.)</p>



<a name="258406175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258406175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258406175">(Oct 20 2021 at 17:13)</a>:</h4>
<p>oh I was just writing out my own</p>



<a name="258406307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258406307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258406307">(Oct 20 2021 at 17:13)</a>:</h4>
<p>that's fine, feel free to edit; main thing is to create a <code>###</code> section for easier linking etc later :)</p>



<a name="258406782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258406782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258406782">(Oct 20 2021 at 17:16)</a>:</h4>
<p>Sigh, I should have added a few more options that were rejected and why -- but I'll refrain from editing the doc :)</p>



<a name="258407030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407030">(Oct 20 2021 at 17:18)</a>:</h4>
<p>(I decided to drop my question about Haskell layout because the exact layout is entirely unrelated and doesn't help.)</p>



<a name="258407112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407112">(Oct 20 2021 at 17:18)</a>:</h4>
<p>I am wondering now what layout haskell uses!</p>



<a name="258407236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407236">(Oct 20 2021 at 17:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> IIRC, there's a vtable of function pointers for each object, and an object in memory has metadata before it that includes that vtable.</p>



<a name="258407299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407299">(Oct 20 2021 at 17:19)</a>:</h4>
<p>I would guess they just allocate a pair</p>



<a name="258407421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407421">(Oct 20 2021 at 17:20)</a>:</h4>
<p>OK, <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> (we maybe need a meeting alias)... 10 minutes. Folks still reading?</p>



<a name="258407474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407474">(Oct 20 2021 at 17:20)</a>:</h4>
<p><span class="user-mention" data-user-id="261224">@triagebot</span> end-topic reading</p>



<a name="258407480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407480">(Oct 20 2021 at 17:20)</a>:</h4>
<p>Does anyone have something to add on the current topic?<br>
React with <span aria-label="working on it" class="emoji emoji-1f6e0" role="img" title="working on it">:working_on_it:</span> if you have something to say.<br>
React with <span aria-label="all good" class="emoji emoji-2705" role="img" title="all good">:all_good:</span> if not.</p>



<a name="258407505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407505">(Oct 20 2021 at 17:20)</a>:</h4>
<p>( <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> if done)</p>



<a name="258407583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407583">(Oct 20 2021 at 17:21)</a>:</h4>
<p>Okie dokie</p>



<a name="258407607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407607">(Oct 20 2021 at 17:21)</a>:</h4>
<p>I guess let's start by reviewing comments on the doc itself</p>



<a name="258407654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407654">(Oct 20 2021 at 17:21)</a>:</h4>
<p>Felix asks: The expression in <code>/* garbage */ either has an </code>unsafe<code> in it, or uses a value for Metadata that was constructed via </code>unsafe` code, right?</p>



<a name="258407687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407687">(Oct 20 2021 at 17:21)</a>:</h4>
<p>And indeed, that is correct, I realize that the doc was written a bit confusingly on this point</p>



<a name="258407764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407764">(Oct 20 2021 at 17:22)</a>:</h4>
<p>I wrote that "It is unsafe to create a *const dyn Foo. "</p>



<a name="258407790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407790">(Oct 20 2021 at 17:22)</a>:</h4>
<p>but I think that is ... not quite right, it depends on how it is constructed</p>



<a name="258407830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407830">(Oct 20 2021 at 17:22)</a>:</h4>
<p>e.g. <code>from_raw_parts</code> is safe because it takes a <code>T::Metadata</code></p>



<a name="258407870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407870">(Oct 20 2021 at 17:22)</a>:</h4>
<p>and coercing from <code>&amp;dyn Foo</code> to <code>*const dyn Foo</code> ought to be safe (as <span class="user-mention" data-user-id="116122">@simulacrum</span> asked later on)</p>



<a name="258407904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407904">(Oct 20 2021 at 17:22)</a>:</h4>
<p>it would just be that this is an extra safety condition one must prove when transmuting to <code>*const dyn Foo</code> types</p>



<a name="258407919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407919">(Oct 20 2021 at 17:22)</a>:</h4>
<p>Yeah, generally speaking I'd expect a raw pointer to be safe to create in the most common way and just unsafe to <em>use</em>.</p>



<a name="258407922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407922">(Oct 20 2021 at 17:22)</a>:</h4>
<p>"extra" :)</p>



<a name="258407957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407957">(Oct 20 2021 at 17:23)</a>:</h4>
<p>well, it's not <em>safe</em> to create</p>



<a name="258407989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407989">(Oct 20 2021 at 17:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258407957">said</a>:</p>
<blockquote>
<p>well, it's not <em>safe</em> to create</p>
</blockquote>
<p>From a reference, at least.</p>



<a name="258407996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258407996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258407996">(Oct 20 2021 at 17:23)</a>:</h4>
<p>ah, ok</p>



<a name="258408025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408025">(Oct 20 2021 at 17:23)</a>:</h4>
<p>Becasue there’s an invariant that you can never combine a correctly constructed <code>T::Metadata</code> with any <code>*const T</code> and get something invalid out?</p>



<a name="258408038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408038">(Oct 20 2021 at 17:23)</a>:</h4>
<p>it's more that the routes we have for creation are relatively limited and channel you towards valid metadata</p>



<a name="258408052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408052">(Oct 20 2021 at 17:23)</a>:</h4>
<p>something doesn’t sit right with me there</p>



<a name="258408080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408080">(Oct 20 2021 at 17:23)</a>:</h4>
<p>its not unsafe to cast <code>*const T as *const U</code> , right</p>



<a name="258408085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408085">(Oct 20 2021 at 17:23)</a>:</h4>
<p>?</p>



<a name="258408170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408170">(Oct 20 2021 at 17:24)</a>:</h4>
<p>I.e. I don’t know how one enforces the correspondence required at teh type level here</p>



<a name="258408171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408171">(Oct 20 2021 at 17:24)</a>:</h4>
<p>I don't think, <span class="user-mention" data-user-id="116083">@pnkfelix</span>, that there's an assumption that the data pointer is valid</p>



<a name="258408200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408200">(Oct 20 2021 at 17:24)</a>:</h4>
<p>But that does imply that the data pointer is not "used" in upcasts</p>



<a name="258408236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408236">(Oct 20 2021 at 17:24)</a>:</h4>
<p>This could plausibly be relevant for custom dst for example</p>



<a name="258408256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408256">(Oct 20 2021 at 17:24)</a>:</h4>
<p>Okay. I guess we’ll dig into this during the Q’s.</p>



<a name="258408309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408309">(Oct 20 2021 at 17:24)</a>:</h4>
<p>which I guess is what <span class="user-mention" data-user-id="120791">@RalfJ</span> meant when they said:</p>
<blockquote>
<p>Also might imply that size_of_val_raw could be safe (though unlike the Dyn parts, this one also has consequences for potential future user-defined DST)</p>
</blockquote>



<a name="258408317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408317">(Oct 20 2021 at 17:25)</a>:</h4>
<p>(next comment in the doc :)</p>



<a name="258408396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408396">(Oct 20 2021 at 17:25)</a>:</h4>
<p>i.e., I think the idea is that the DST API for size-of could require a valid data pointer</p>



<a name="258408423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408423">(Oct 20 2021 at 17:25)</a>:</h4>
<p>even if for dyn types one can compute sizeof without using the data pointer</p>



<a name="258408444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408444">(Oct 20 2021 at 17:25)</a>:</h4>
<p>(right?)</p>



<a name="258408448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408448">(Oct 20 2021 at 17:25)</a>:</h4>
<p>ok, moving on to other doc comments...</p>



<a name="258408542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408542">(Oct 20 2021 at 17:26)</a>:</h4>
<p>where I wrote</p>
<blockquote>
<p>It is also a rather special rule, since ordinarily upcasts are managed by the CoerceUnsized trait, and we don’t have a mechanism to make trait matching unsafe depending on which impls are used (i.e., this impl would be unsafe to use, which is not a concept the trait system has right now).</p>
</blockquote>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> comments:</p>
<blockquote>
<p>The way I think of it, we'd basically have <code>CoerceUnsizedUnsafe</code> for these unsafe casts. The existing trait would be for casts that are always safe (on the given type).</p>
</blockquote>



<a name="258408593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408593">(Oct 20 2021 at 17:26)</a>:</h4>
<p>The problem I see there is that the existing trait is already implemented for <code>*const</code></p>



<a name="258408603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408603">(Oct 20 2021 at 17:26)</a>:</h4>
<p>but perhaps it's ok because it's unstable?</p>



<a name="258408667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408667">(Oct 20 2021 at 17:26)</a>:</h4>
<p>(i.e., we could remove those impls and add a new trait without breaking back compat)</p>



<a name="258408755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408755">(Oct 20 2021 at 17:27)</a>:</h4>
<p>I'm assuming <span class="user-mention" data-user-id="120791">@RalfJ</span> that's what you meant then</p>



<a name="258408795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408795">(Oct 20 2021 at 17:27)</a>:</h4>
<p>The impls are picked up by coercion rules, so there'll be breakage on existing code in a certain range.</p>



<a name="258408839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408839">(Oct 20 2021 at 17:27)</a>:</h4>
<p>Example?</p>



<a name="258408853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408853">(Oct 20 2021 at 17:27)</a>:</h4>
<p>Ah wait</p>



<a name="258408925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408925">(Oct 20 2021 at 17:28)</a>:</h4>
<p>well, nm</p>



<a name="258408964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408964">(Oct 20 2021 at 17:28)</a>:</h4>
<p>The <code>Unsize</code> trait is the one that is really baked into the compiler</p>



<a name="258408984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258408984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258408984">(Oct 20 2021 at 17:28)</a>:</h4>
<p>i.e., where all impls are synthetically generated</p>



<a name="258409003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409003">(Oct 20 2021 at 17:28)</a>:</h4>
<p>not the <code>CoerceUnsized</code>, is that right?</p>



<a name="258409142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409142">(Oct 20 2021 at 17:29)</a>:</h4>
<p>Both those two traits are used. <code>CoerceUnsized</code> is for non-builtin wrapper types. <code>Unsize</code> is for the outcome, everything included.</p>



<a name="258409370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409370">(Oct 20 2021 at 17:30)</a>:</h4>
<p>If I'm not mistaken, <code>T: CoerceUnsized&lt;U&gt;</code> means "the pointer could be coerced" and the impl is something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">CoerceUnsized</span><span class="o">&lt;*</span><span class="k">const</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nc">Unsize</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>



<a name="258409434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409434">(Oct 20 2021 at 17:30)</a>:</h4>
<p>anyway I think this is a minor point</p>



<a name="258409454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409454">(Oct 20 2021 at 17:30)</a>:</h4>
<p>Next question:</p>
<h1><a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ?view#Just-have-unsafe-upcast">Just have unsafe upcast?</a></h1>



<a name="258409490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409490">(Oct 20 2021 at 17:31)</a>:</h4>
<blockquote>
<p>cramertj: I think there’s another option: make raw pointer upcasting unsafe. Isn’t that the place where the issue actually occurs?</p>
</blockquote>



<a name="258409547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409547">(Oct 20 2021 at 17:31)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="127859">@Taylor Cramer</span> that is tricky because there can be generic code where we don't know the specific kind of coercion taking place</p>



<a name="258409569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409569">(Oct 20 2021 at 17:31)</a>:</h4>
<p>Example:</p>



<a name="258409572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409572">(Oct 20 2021 at 17:31)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(unsize)]</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">Unsize</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">unsize</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">A</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">B</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Unsize</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258409596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409596">(Oct 20 2021 at 17:31)</a>:</h4>
<p>depending on A, B, that can be legal or illegal</p>



<a name="258409618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409618">(Oct 20 2021 at 17:31)</a>:</h4>
<p>I guess this intersects the point of whether we can introduce an "unsafe upcast" rule</p>



<a name="258409691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409691">(Oct 20 2021 at 17:32)</a>:</h4>
<p>It seems hard to me because <code>dyn Foo: Unsize&lt;dyn Bar&gt;</code> wants to be true</p>



<a name="258409737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409737">(Oct 20 2021 at 17:32)</a>:</h4>
<p>so that <code>&amp;dyn Foo: CoerceUnsized&lt;&amp;dyn Bar&gt;</code></p>



<a name="258409767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409767">(Oct 20 2021 at 17:32)</a>:</h4>
<p>but in the cast of <code>*const</code> or <code>*mut</code> it wants to be false...?</p>



<a name="258409809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409809">(Oct 20 2021 at 17:32)</a>:</h4>
<p>I guess we could add an additional trait like <code>Unsize</code> and more impls of <code>CoerceUnsized</code> (making it a marker trait...)</p>



<a name="258409814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409814">(Oct 20 2021 at 17:32)</a>:</h4>
<p>or something like that</p>



<a name="258409918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258409918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258409918">(Oct 20 2021 at 17:33)</a>:</h4>
<p>but I guess the real question is whether we want the <em>act of upcasting</em> to be unsafe or whether we want to generally know we have valid metadata</p>



<a name="258410106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410106">(Oct 20 2021 at 17:34)</a>:</h4>
<p>I can't tell if people just agree or what :)</p>



<a name="258410115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410115">(Oct 20 2021 at 17:34)</a>:</h4>
<p>I guess:</p>



<a name="258410117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410117">(Oct 20 2021 at 17:34)</a>:</h4>
<p><span class="user-mention" data-user-id="261224">@triagebot</span> end-topic this question</p>



<a name="258410121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> triagebot <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410121">(Oct 20 2021 at 17:34)</a>:</h4>
<p>Does anyone have something to add on the current topic?<br>
React with <span aria-label="working on it" class="emoji emoji-1f6e0" role="img" title="working on it">:working_on_it:</span> if you have something to say.<br>
React with <span aria-label="all good" class="emoji emoji-2705" role="img" title="all good">:all_good:</span> if not.</p>



<a name="258410150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410150">(Oct 20 2021 at 17:34)</a>:</h4>
<p>(FWIW, I think most of the questions are hitting this "real question")</p>



<a name="258410181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410181">(Oct 20 2021 at 17:35)</a>:</h4>
<p>I have a potentially more basic question</p>



<a name="258410187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410187">(Oct 20 2021 at 17:35)</a>:</h4>
<p>about an assertion in the doc</p>



<a name="258410209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410209">(Oct 20 2021 at 17:35)</a>:</h4>
<p>K</p>



<a name="258410230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410230">(Oct 20 2021 at 17:35)</a>:</h4>
<p>"Without a data pointer, you don’t know what its metadata should be”</p>



<a name="258410274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410274">(Oct 20 2021 at 17:35)</a>:</h4>
<p>are you speaking there about … how the compiler itself would infer what metadata to inject?</p>



<a name="258410300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410300">(Oct 20 2021 at 17:35)</a>:</h4>
<p>becasue when it comes to <code>from_raw_parts</code></p>



<a name="258410321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410321">(Oct 20 2021 at 17:36)</a>:</h4>
<p>its not hard for me to imagine a user being able to write a vtable</p>



<a name="258410379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410379">(Oct 20 2021 at 17:36)</a>:</h4>
<p>that still <em>works</em> even if the data pointer is null</p>



<a name="258410420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410420">(Oct 20 2021 at 17:36)</a>:</h4>
<p>(right? Or is there some detail of dispatch I’m missing here?)</p>



<a name="258410446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410446">(Oct 20 2021 at 17:36)</a>:</h4>
<p>I think you are correct at least in some cases;</p>



<a name="258410467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410467">(Oct 20 2021 at 17:36)</a>:</h4>
<p>we discussed in a side note the idea of generating a "sentinel" table like this</p>



<a name="258410476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410476">(Oct 20 2021 at 17:36)</a>:</h4>
<p>perhaps one that just aborts when methods are called?</p>



<a name="258410524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410524">(Oct 20 2021 at 17:37)</a>:</h4>
<p>(I think <span class="user-mention" data-user-id="116458">@Charles Lew</span> compared  to C++, which does something like that if you manage to call a pure virtual function)</p>



<a name="258410527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410527">(Oct 20 2021 at 17:37)</a>:</h4>
<p>Yes, it would be our job to specify what the rules are for the vtable structure</p>



<a name="258410594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410594">(Oct 20 2021 at 17:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258408593">said</a>:</p>
<blockquote>
<p>The problem I see there is that the existing trait is already implemented for <code>*const</code></p>
</blockquote>
<p>my thinking was, this allows 'safe' coercions to still be performed below raw ptrs (i.e., the existing ones), but 'unsafe' cercions (dyn upcasts) would query a different trait that is not implemented for raw ptrs... I guess 'unsafe' is a bad term here. 'CoerceUnsizedRequiresValidMetada', or so.^^</p>



<a name="258410608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410608">(Oct 20 2021 at 17:37)</a>:</h4>
<p>I just wanted clarity about why you’d need null pointers for every method?</p>



<a name="258410640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410640">(Oct 20 2021 at 17:37)</a>:</h4>
<p>Again, is that just about a compiler-generated vtable?</p>



<a name="258410771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410771">(Oct 20 2021 at 17:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258410608">said</a>:</p>
<blockquote>
<p>I just wanted clarity about why you’d need null pointers for every method?</p>
</blockquote>
<p>I guess it's more like "we need to define the minimum properties a vtable must hold"</p>



<a name="258410809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410809">(Oct 20 2021 at 17:38)</a>:</h4>
<p>probably that means:</p>



<a name="258410831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410831">(Oct 20 2021 at 17:38)</a>:</h4>
<p>it must have valid pointers to the "parent" vtables</p>



<a name="258410873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410873">(Oct 20 2021 at 17:38)</a>:</h4>
<p>(since everything else is unsafe?)</p>



<a name="258410916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410916">(Oct 20 2021 at 17:39)</a>:</h4>
<p>we'd probably want to say at some point when it's legal to cast from <code>*const dyn Foo</code> to <code>&amp;dyn Foo</code> or whatever, but that's bascially "and all the methods etc are valid too"</p>



<a name="258410972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258410972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258410972">(Oct 20 2021 at 17:39)</a>:</h4>
<p>okay I’m satisifed with that answer</p>



<a name="258411065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411065">(Oct 20 2021 at 17:40)</a>:</h4>
<p>Next question:</p>
<h1><a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ?view#Why-is-it-unsafe-to-create-const-dyn-Foo-if-it-requires-valid-metadata">Why is it unsafe to create *const dyn Foo if it requires valid metadata?</a></h1>
<p>I think we answered this already -- it's not <em>unsafe</em> always, depends on the route you use</p>



<a name="258411114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411114">(Oct 20 2021 at 17:40)</a>:</h4>
<p>Next question:</p>
<h1><a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ?view#Q-Why-is-fn-from_raw_parts-not-an-unsafe-fn">Why is fn from_raw_parts not an unsafe fn?</a></h1>



<a name="258411149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411149">(Oct 20 2021 at 17:40)</a>:</h4>
<p>Did we skip over the question about NULL?</p>



<a name="258411156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411156">(Oct 20 2021 at 17:40)</a>:</h4>
<p>We kind of answered this too? I guess the idea is that the metadata is known to be valid when it is called</p>



<a name="258411168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411168">(Oct 20 2021 at 17:40)</a>:</h4>
<p>Oh, my bad, yes</p>



<a name="258411186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411186">(Oct 20 2021 at 17:40)</a>:</h4>
<p>(I'm fine with handling it later if you prefer.)</p>



<a name="258411224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411224">(Oct 20 2021 at 17:41)</a>:</h4>
<p>And that in general we don't assume data pointer is valid</p>



<a name="258411261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411261">(Oct 20 2021 at 17:41)</a>:</h4>
<p>(I remain unconvinced that its a good idea to rely on the metadata construction being a proof that this call to from_raw_parts is sound)</p>



<a name="258411265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411265">(Oct 20 2021 at 17:41)</a>:</h4>
<p>that said, <span class="user-mention" data-user-id="116083">@pnkfelix</span>, I believe the API is unstable, so we can totally make it unsafe</p>



<a name="258411394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411394">(Oct 20 2021 at 17:42)</a>:</h4>
<p>I feel like I'd prefer to have more progress and agreement on the ... validity properties of values before we stabilize, ina ny case</p>



<a name="258411411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411411">(Oct 20 2021 at 17:42)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> what was the name for that invariant? :)</p>



<a name="258411438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411438">(Oct 20 2021 at 17:42)</a>:</h4>
<p>validity invariant?</p>



<a name="258411460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411460">(Oct 20 2021 at 17:42)</a>:</h4>
<p>ok :)</p>



<a name="258411466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411466">(Oct 20 2021 at 17:42)</a>:</h4>
<p>I did remember correct I guess</p>



<a name="258411471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411471">(Oct 20 2021 at 17:42)</a>:</h4>
<p>Next question:</p>
<h1><a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ?view#Special-case-NULL">Special-case NULL?</a></h1>



<a name="258411497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411497">(Oct 20 2021 at 17:42)</a>:</h4>
<p>(or "language invariant" or "initialization invariant"... we never finalized that naming discussion...)</p>



<a name="258411498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411498">(Oct 20 2021 at 17:42)</a>:</h4>
<blockquote>
<p>Josh Triplett: I don’t know if this would be an excessive performance hit, but could we special-case the NULL pointer, return another NULL pointer in that case, and otherwise look at the metadata? This would effectively treat NULL as None for a raw pointer, and the upcast operation as a .map.</p>
</blockquote>



<a name="258411524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411524">(Oct 20 2021 at 17:43)</a>:</h4>
<p>We certainly <em>could</em> do that</p>



<a name="258411545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411545">(Oct 20 2021 at 17:43)</a>:</h4>
<p>I think we just didn't want upcasting to have a branch</p>



<a name="258411564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411564">(Oct 20 2021 at 17:43)</a>:</h4>
<p>At least I didn't want that :)</p>



<a name="258411572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411572">(Oct 20 2021 at 17:43)</a>:</h4>
<p>wait, does that even resolve the issue?</p>



<a name="258411593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411593">(Oct 20 2021 at 17:43)</a>:</h4>
<p>Not really</p>



<a name="258411601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411601">(Oct 20 2021 at 17:43)</a>:</h4>
<p>that maps the null data pointer to another null data pointer</p>



<a name="258411608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411608">(Oct 20 2021 at 17:43)</a>:</h4>
<p>It just gives you a sentinel value to use for "null"</p>



<a name="258411644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411644">(Oct 20 2021 at 17:43)</a>:</h4>
<p>I think if we were going to go that way, I'd rather we create the "structurally valid but nonsense contents" vtable</p>



<a name="258411647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411647">(Oct 20 2021 at 17:43)</a>:</h4>
<p>but you still need to adjust the metadata part, to point to the parent, right?</p>



<a name="258411706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411706">(Oct 20 2021 at 17:44)</a>:</h4>
<p>this goes back to whether it could be valid to construct metadata that still <em>works</em> with a null data pointer</p>



<a name="258411709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411709">(Oct 20 2021 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258411647">said</a>:</p>
<blockquote>
<p>but you still need to adjust the metadata part, to point to the parent, right?</p>
</blockquote>
<p>So, I'm wondering if we <em>need</em> to support "NULL raw pointer with valid metadata".</p>



<a name="258411743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411743">(Oct 20 2021 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258411706">said</a>:</p>
<blockquote>
<p>this goes back to whether it could be valid to construct metadata that still <em>works</em> with a null data pointer</p>
</blockquote>
<p>What would go wrong if we said that <em>wasn't</em> valid?</p>



<a name="258411781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411781">(Oct 20 2021 at 17:44)</a>:</h4>
<p>And if we declared that invalid, then propagating NULL-&gt;NULL in an upcast should suffice.</p>



<a name="258411832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411832">(Oct 20 2021 at 17:44)</a>:</h4>
<p>I feel like the two are somewhat independent, but maybe I'm missing something</p>



<a name="258411883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411883">(Oct 20 2021 at 17:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258411832">said</a>:</p>
<blockquote>
<p>I feel like the two are somewhat independent, but maybe I'm missing something</p>
</blockquote>
<p>Much of the issue here seems like "what happens if you try to upcast an invalid pointer".</p>



<a name="258411913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411913">(Oct 20 2021 at 17:45)</a>:</h4>
<p>I want to keep us moving because I'd like to have at least some time to discuss the "real question" :)</p>



<a name="258411942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411942">(Oct 20 2021 at 17:45)</a>:</h4>
<p>And I feel like one legitimate answer would be "if you upcast a NULL you get NULL, if you upcast an invalid non-NULL pointer you get a crash".</p>



<a name="258411964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258411964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258411964">(Oct 20 2021 at 17:45)</a>:</h4>
<p>ehhh</p>



<a name="258412005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412005">(Oct 20 2021 at 17:46)</a>:</h4>
<p>/me would be fine moving on, but would like us to consider this option further.</p>



<a name="258412072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412072">(Oct 20 2021 at 17:46)</a>:</h4>
<p>Next question:</p>
<h1><a href="https://hackmd.io/uoG_F8P8S1OC348VbHo7mQ?view#Q-Do-we-need-raw-pointer-upcasting">Do we need raw pointer upcasting?</a></h1>
<blockquote>
<p>Mark: Can we get away with just supporting upcasting for non-raw pointers, and then we “skip” this question? This is similar to Taylor’s unsafe upcast, but is in some sense even simpler (and maybe in practice equivalent, presuming that the guarantees on upcast are equivalent to “needs to be safe to convert into &amp;/&amp;mut dyn temporarily”?).</p>
</blockquote>



<a name="258412079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412079">(Oct 20 2021 at 17:46)</a>:</h4>
<p>(my gut feeling is that we should either support NULL properly, ot not)</p>



<a name="258412115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412115">(Oct 20 2021 at 17:46)</a>:</h4>
<p>To be honest, I hadn't considered that</p>



<a name="258412140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412140">(Oct 20 2021 at 17:46)</a>:</h4>
<p>It's not obvious how to rule it out exactly, I guess this comes back to how we arrange the traits</p>



<a name="258412167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412167">(Oct 20 2021 at 17:46)</a>:</h4>
<p>I was also just now wondering if one could feature gate it</p>



<a name="258412177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412177">(Oct 20 2021 at 17:46)</a>:</h4>
<p>That's a really interesting idea. It seems like this is proposing that people should instead "convert to reference, upcast, convert back to raw pointer", and the requirements of that would solve the problem for us. :)</p>



<a name="258412200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412200">(Oct 20 2021 at 17:47)</a>:</h4>
<p>but I think the presence of generic code might make that hard</p>



<a name="258412220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412220">(Oct 20 2021 at 17:47)</a>:</h4>
<p>not impossible, we could add some hacky code into rustc</p>



<a name="258412240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412240">(Oct 20 2021 at 17:47)</a>:</h4>
<p>so wait, is the expectation in this case that if you <em>do</em> need to upcast a <code>*const dyn Child</code> to <code>*const dyn Parent</code>, that you’d need to cast to <code>&amp;dyn _</code> in the middle?`</p>



<a name="258412253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412253">(Oct 20 2021 at 17:47)</a>:</h4>
<p>I guess I don't lik the idea of throwing more hurdles into the way of people writing unsafe code</p>



<a name="258412287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412287">(Oct 20 2021 at 17:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412253">said</a>:</p>
<blockquote>
<p>I guess I don't lik the idea of throwing more hurdles into the way of people writing unsafe code</p>
</blockquote>
<p>So, this is about what's built into the compiler.</p>



<a name="258412300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412300">(Oct 20 2021 at 17:47)</a>:</h4>
<p>that intermediate cast reminds me of what people have to do today for <code>*AtomicX</code></p>



<a name="258412314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412314">(Oct 20 2021 at 17:47)</a>:</h4>
<p>I'd prefer us to make progress on this question</p>



<a name="258412317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412317">(Oct 20 2021 at 17:47)</a>:</h4>
<p>Suppose we didn't build it into the compiler, and we required the intermediate cast.</p>



<a name="258412385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412385">(Oct 20 2021 at 17:48)</a>:</h4>
<p>We could still provide a method on raw pointers, which does the intermediate cast and has the precondition of validity.</p>



<a name="258412420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412420">(Oct 20 2021 at 17:48)</a>:</h4>
<p>Can I ask a different thing:</p>



<a name="258412445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412445">(Oct 20 2021 at 17:48)</a>:</h4>
<p>What makes people <em>nervous</em> about "just" requiring that metadata is valid</p>



<a name="258412479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412479">(Oct 20 2021 at 17:48)</a>:</h4>
<p>Because I'm thinking about how to address or validate further concerns</p>



<a name="258412501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412501">(Oct 20 2021 at 17:49)</a>:</h4>
<p>I feel a touch nervous, like I'm not sure I know what problems it might cause</p>



<a name="258412561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412561">(Oct 20 2021 at 17:49)</a>:</h4>
<p>Are there currently any requirements on casts of raw pointers? I think my naive assumption is that there are not (i.e., raw pointers are in some sense 'just usize', modulo having an associated object for .add and such)</p>



<a name="258412599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412599">(Oct 20 2021 at 17:49)</a>:</h4>
<p>my worry is that adding requirements complicates that story a lot</p>



<a name="258412600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412600">(Oct 20 2021 at 17:49)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="239881">@Josh Triplett</span> raised a good point that it maybe feels different from thin pointers, whwere we don't assume much, but I'm not sure that's entirely true -- if you think of "thin pointers" as "pointers with metadata of <code>()</code>", then the validity invariant is just trivially satisfied there.</p>



<a name="258412695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412695">(Oct 20 2021 at 17:50)</a>:</h4>
<p>Well, they're not <em>just</em> usize, in that they can carry metadata</p>



<a name="258412757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412757">(Oct 20 2021 at 17:50)</a>:</h4>
<p>One thing I was wondering is:</p>



<a name="258412773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412773">(Oct 20 2021 at 17:50)</a>:</h4>
<p>My feeling is that I could improve the write-up a lot based on the contents here</p>



<a name="258412797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412797">(Oct 20 2021 at 17:50)</a>:</h4>
<p>and maybe it'd be nice to write up an inside rust blog post or something and look for feedback from people</p>



<a name="258412822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412822">(Oct 20 2021 at 17:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412445">said</a>:</p>
<blockquote>
<p>What makes people <em>nervous</em> about "just" requiring that metadata is valid</p>
</blockquote>
<p>To clarify: requiring that metadata is valid in order to upcast?</p>



<a name="258412826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412826">(Oct 20 2021 at 17:51)</a>:</h4>
<p>I <em>feel</em> like <span class="user-mention" data-user-id="132040">@Manish Goregaokar</span> had a strong opinion about this in the past, for example!</p>



<a name="258412847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412847">(Oct 20 2021 at 17:51)</a>:</h4>
<p>though my memory is it was all about the "null pointer" question</p>



<a name="258412888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412888">(Oct 20 2021 at 17:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412822">said</a>:</p>
<blockquote>
<p>To clarify: requiring that metadata is valid in order to upcast?</p>
</blockquote>
<p>No, requiring that metadata is "valid" always -- or "valid enough"</p>



<a name="258412924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412924">(Oct 20 2021 at 17:51)</a>:</h4>
<p>I have to admit I don't like the "unsafe to upcast direction", but maybe I should clarify why</p>



<a name="258412936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412936">(Oct 20 2021 at 17:51)</a>:</h4>
<p>Ah. Even for NULL? (Does that just mean "detectably invalid"?)</p>



<a name="258412944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258412944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258412944">(Oct 20 2021 at 17:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412695">said</a>:</p>
<blockquote>
<p>Well, they're not <em>just</em> usize, in that they can carry metadata</p>
</blockquote>
<p>in particular, we tell LLVM that the vtable ptr is nonnull. so wide raw ptrs are already definitely not just 2 usize.</p>



<a name="258413008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413008">(Oct 20 2021 at 17:52)</a>:</h4>
<p>that's a good point, thanks</p>



<a name="258413020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413020">(Oct 20 2021 at 17:52)</a>:</h4>
<p>I forgot about that</p>



<a name="258413040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413040">(Oct 20 2021 at 17:52)</a>:</h4>
<p>FWIW, I would personally be uncomfortable having any kind of raw pointer that "can't" be NULL.</p>



<a name="258413074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413074">(Oct 20 2021 at 17:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412888">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412822">said</a>:</p>
<blockquote>
<p>To clarify: requiring that metadata is valid in order to upcast?</p>
</blockquote>
<p>No, requiring that metadata is "valid" always -- or "valid enough"</p>
</blockquote>
<p>I can understand “valid with respect to a given concrete data pointer.” I am nervous about valid with respect to all possible data pointers.</p>



<a name="258413083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413083">(Oct 20 2021 at 17:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258412936">said</a>:</p>
<blockquote>
<p>Ah. Even for NULL? (Does that just mean "detectably invalid"?)</p>
</blockquote>
<p>for everything. We can define what "valid enough" means, of course. Detectably invalid might be good enough, or perhaps "must at least have the data upcasts need" :)</p>



<a name="258413129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413129">(Oct 20 2021 at 17:52)</a>:</h4>
<p>I'm thinking that what we are <em>really</em> defining is</p>



<a name="258413157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413157">(Oct 20 2021 at 17:53)</a>:</h4>
<p>For dyn Foo types, what are the validity invariants imposed on the data/metadata</p>



<a name="258413173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413173">(Oct 20 2021 at 17:53)</a>:</h4>
<p>This doesn't necessarily extend to all DST</p>



<a name="258413194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413194">(Oct 20 2021 at 17:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258413040">said</a>:</p>
<blockquote>
<p>FWIW, I would personally be uncomfortable having any kind of raw pointer that "can't" be NULL.</p>
</blockquote>
<p>you can have NULL data ptr together with some correct vtable ptr.<br>
I dont know what NULL means for 2-word-sized ptrs... do you means transmuting 0u128 to a wide raw ptr should be allowed?</p>



<a name="258413242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413242">(Oct 20 2021 at 17:53)</a>:</h4>
<p>(For that reason, I tend to agree with <span class="user-mention" data-user-id="116083">@pnkfelix</span> that <code>from_raw_parts</code> ought to be unsafe, and the safety invariant ought to depend on the type being synthesized)</p>



<a name="258413338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413338">(Oct 20 2021 at 17:54)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="120791">@RalfJ</span> what <span class="user-mention" data-user-id="132040">@Manish Goregaokar</span> for example wanted was: Sometimes I have to create some pointers I know will never be used. What can I put in them?</p>



<a name="258413376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413376">(Oct 20 2021 at 17:54)</a>:</h4>
<p>I know they won't be used beacuse they are going to get overwritten later</p>



<a name="258413391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413391">(Oct 20 2021 at 17:54)</a>:</h4>
<p>one answer would be: use <code>Option</code> :)</p>



<a name="258413431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413431">(Oct 20 2021 at 17:54)</a>:</h4>
<p>another would be: "we have a fn that gives you dummy metadata that is good enough"</p>



<a name="258413439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413439">(Oct 20 2021 at 17:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258413194">said</a>:</p>
<blockquote>
<p>I dont know what NULL means for 2-word-sized ptrs... do you means transmuting 0u128 to a wide raw ptr should be allowed?</p>
</blockquote>
<p>(my own interpretation of it would be: you can still have a vtable, but the concrete methods it points to must not actually ever derefence the data pointer)</p>



<a name="258413459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413459">(Oct 20 2021 at 17:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258413242">said</a>:</p>
<blockquote>
<p>(For that reason, I tend to agree with <span class="user-mention silent" data-user-id="116083">pnkfelix</span> that <code>from_raw_parts</code> ought to be unsafe, and the safety invariant ought to depend on the type being synthesized)</p>
</blockquote>
<p>But it seems like the validity requirement for the dyn metadata is coming from the metadata argument? Maybe it's worth digging in here more, perhaps, because I find this a little confusing</p>



<a name="258413474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413474">(Oct 20 2021 at 17:55)</a>:</h4>
<p>So let's look at <code>from_raw_parts</code>:</p>



<a name="258413507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413507">(Oct 20 2021 at 17:55)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_raw_parts</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">data_address</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="n">metadata</span>: <span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Pointee</span><span class="o">&gt;</span>::<span class="n">Metadata</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"></span>
</code></pre></div>



<a name="258413547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413547">(Oct 20 2021 at 17:55)</a>:</h4>
<p>We're discussing:</p>
<ul>
<li>What is the validity invariant of <code>*const T</code></li>
</ul>



<a name="258413562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413562">(Oct 20 2021 at 17:55)</a>:</h4>
<p>In other words, what can the compiler/language assume is true of <code>*const T</code> <em>always</em></p>



<a name="258413613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413613">(Oct 20 2021 at 17:55)</a>:</h4>
<p>What I'm saying is nothing more than "this depends on T"</p>



<a name="258413707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413707">(Oct 20 2021 at 17:56)</a>:</h4>
<p>as in, the set of assumpions depend on what T is?</p>



<a name="258413725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413725">(Oct 20 2021 at 17:56)</a>:</h4>
<p>for <code>dyn</code> types, it is <em>currently</em> "the metadata is not null"</p>



<a name="258413752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413752">(Oct 20 2021 at 17:56)</a>:</h4>
<p>right, like it should be:</p>



<a name="258413762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413762">(Oct 20 2021 at 17:56)</a>:</h4>
<p>I guess I would prefer the answer to be "this depends on <code>&lt;T as Pointee&gt;::Metadata</code>"</p>



<a name="258413769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413769">(Oct 20 2021 at 17:56)</a>:</h4>
<p>FWIW, another possible point in the design space is to just make the validity part of the <em>safety</em> invariant... so you can have bad metadata in raw ptrs but you cannot give them to unknown safe code, as it can lead to UB in dyn upcasts.<br>
however, having validity != safety for raw ptrs doesnt seem great either.</p>



<a name="258413805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413805">(Oct 20 2021 at 17:57)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Unsafety condition:</span>
<span class="c1">//</span>
<span class="c1">// You cannot call this unless the invariants of T are met for `data_address` and `metadata`</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_raw_parts</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">data_address</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="n">metadata</span>: <span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Pointee</span><span class="o">&gt;</span>::<span class="n">Metadata</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"></span>
</code></pre></div>



<a name="258413918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413918">(Oct 20 2021 at 17:57)</a>:</h4>
<p>I think safe <code>from_raw_parts</code> is fine since <code>&lt;T as Pointee&gt;::Metadata</code> already takes care of these validity invariants -- basically, I agree with <span class="user-mention" data-user-id="116122">@simulacrum</span></p>



<a name="258413920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258413920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258413920">(Oct 20 2021 at 17:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258413762">said</a>:</p>
<blockquote>
<p>I guess I would prefer the answer to be "this depends on <code>&lt;T as Pointee&gt;::Metadata</code>"</p>
</blockquote>
<p>I'm not sure how different this is, really</p>



<a name="258414011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414011">(Oct 20 2021 at 17:58)</a>:</h4>
<p>mmmmm that implies that one can ... never have a metadata whose validity depends on the data pointer?</p>



<a name="258414025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414025">(Oct 20 2021 at 17:58)</a>:</h4>
<p>Every single <code>from_raw_parts</code> that's stable today is <code>unsafe</code>, right?</p>
<p>Part of me just sortof expects that this one would be too.</p>



<a name="258414061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414061">(Oct 20 2021 at 17:58)</a>:</h4>
<p>is that an assumption we <em>want</em>?</p>



<a name="258414123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414123">(Oct 20 2021 at 17:58)</a>:</h4>
<p>(if so, why)</p>



<a name="258414137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414137">(Oct 20 2021 at 17:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414025">said</a>:</p>
<blockquote>
<p>Every single <code>from_raw_parts</code> that's stable today is <code>unsafe</code>, right?</p>
</blockquote>
<p>no, <a href="https://doc.rust-lang.org/nightly/std/ptr/fn.slice_from_raw_parts.html">slice_from_raw_parts</a> is safe</p>



<a name="258414256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414256">(Oct 20 2021 at 17:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414011">said</a>:</p>
<blockquote>
<p>mmmmm that implies that one can ... never have a metadata whose validity depends on the data pointer?</p>
</blockquote>
<p>and thus all metadata must “work" with all possible data pointers? I don’t understand why that is desirable.</p>



<a name="258414257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414257">(Oct 20 2021 at 17:59)</a>:</h4>
<p>Regardless, the distinction isn't particularly important for <em>this specific question</em></p>



<a name="258414261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414261">(Oct 20 2021 at 17:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414011">said</a>:</p>
<blockquote>
<p>mmmmm that implies that one can ... never have a metadata whose validity depends on the data pointer?</p>
</blockquote>
<p>I don't think that's a desirable property. One of the things I think people <em>want</em> to do is to have in-band metadata.</p>



<a name="258414444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414444">(Oct 20 2021 at 18:00)</a>:</h4>
<p>(since, for dyn, the data pointer isn't needed to perform upcasting)</p>



<a name="258414498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414498">(Oct 20 2021 at 18:00)</a>:</h4>
<p>its possible I am confusing the validity conditions with the safety ones here. I am not sure.</p>



<a name="258414507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414507">(Oct 20 2021 at 18:00)</a>:</h4>
<p>but I too would like to know the answer of why that is desirable :)</p>



<a name="258414508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414508">(Oct 20 2021 at 18:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414261">said</a>:</p>
<blockquote>
<p>I don't think that's a desirable property. One of the things I think people <em>want</em> to do is to have in-band metadata.</p>
</blockquote>
<p>that basically means metadata is (). in-band metadata is a different thing from what we are discussing here.</p>



<a name="258414509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414509">(Oct 20 2021 at 18:00)</a>:</h4>
<p>This doesn't prevent in-band metadata, though, right? All this means is that the construction of that metadata must have a safety requirement that's e.g. "must be used only with particular data pointers")</p>



<a name="258414601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414601">(Oct 20 2021 at 18:01)</a>:</h4>
<p>I guess that's true; but it seems sort of "roundabout"</p>



<a name="258414662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414662">(Oct 20 2021 at 18:01)</a>:</h4>
<p>like, if the two are exactly equivalent, then why not make the fn unsafe? I guess just because "a lot of the time" the data pointer won't be important?</p>



<a name="258414676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414676">(Oct 20 2021 at 18:01)</a>:</h4>
<p>Well, it moves the requirement away from compiler (i.e., validity) to safety, right? That seems important</p>



<a name="258414693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414693">(Oct 20 2021 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414509">said</a>:</p>
<blockquote>
<p>This doesn't prevent in-band metadata, though, right? All this means is that the construction of that metadata must have a safety requirement that's e.g. "must be used only with particular data pointers")</p>
</blockquote>
<p>doesn’t that move the safety condition outside of the <code>unsafe</code> block at that point?</p>



<a name="258414859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414859">(Oct 20 2021 at 18:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414676">said</a>:</p>
<blockquote>
<p>Well, it moves the requirement away from compiler (i.e., validity) to safety, right? That seems important</p>
</blockquote>
<p>I don't think I'm being very precise on this distinction.</p>



<a name="258414870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414870">(Oct 20 2021 at 18:02)</a>:</h4>
<p>Maybe we should review :)</p>



<a name="258414882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414882">(Oct 20 2021 at 18:02)</a>:</h4>
<p>But also, we're at time for this meeting</p>



<a name="258414931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414931">(Oct 20 2021 at 18:02)</a>:</h4>
<p>I think I want to do another round of this doc</p>



<a name="258414959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414959">(Oct 20 2021 at 18:02)</a>:</h4>
<p>I'm going to work on that as a follow-up item</p>



<a name="258414968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258414968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258414968">(Oct 20 2021 at 18:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-10-20/near/258414509">said</a>:</p>
<blockquote>
<p>This doesn't prevent in-band metadata, though, right? All this means is that the construction of that metadata must have a safety requirement that's e.g. "must be used only with particular data pointers")</p>
</blockquote>
<p>that is somewhat awkward to reason about... you have to somehow hand down this requirement of how the value must be used through all parties that have access to the value</p>



<a name="258415053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258415053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258415053">(Oct 20 2021 at 18:03)</a>:</h4>
<p>Yeah, I agree it's awkward</p>



<a name="258415097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-10-20/near/258415097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-10-20.html#258415097">(Oct 20 2021 at 18:03)</a>:</h4>
<p>(but it is similar to other recent proposals where unsafety occurs once upfront with a promise about the future, rather than ocurring at use sites -- e.g., the recent discussion around safety for extern statics. I am worried about those proposals for the same reason.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>