<html>
<head><meta charset="utf-8"><title>When is inference fallback important? · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html">When is inference fallback important?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272996676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/272996676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#272996676">(Feb 23 2022 at 19:06)</a>:</h4>
<p>Inspired by the never type meeting, when do people <em>want</em> type variable fallback today?</p>
<p>In what cases are people happier with <code>()</code> fallback than getting an error about it?</p>
<p>(Are things like <code>panic!();</code> or <code>return 4;</code> secretly hitting type variable fallback?)</p>



<a name="272997086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/272997086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#272997086">(Feb 23 2022 at 19:09)</a>:</h4>
<p><code>let _ = panic!();</code> certainly hits inference fallback.</p>



<a name="272997287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/272997287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#272997287">(Feb 23 2022 at 19:11)</a>:</h4>
<p>I think just adding <code>;</code> also hits fallback, yeah.</p>



<a name="272997441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/272997441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#272997441">(Feb 23 2022 at 19:12)</a>:</h4>
<p>If I could turn back the clock my "shiny past" for inference fallback is that it is <code>!</code> always. I have not seen any example where the <code>()</code> fallback looks desirable except from a backward compatibility perspective</p>



<a name="272998677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/272998677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#272998677">(Feb 23 2022 at 19:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F/near/272997287">said</a>:</p>
<blockquote>
<p>I think just adding <code>;</code> also hits fallback, yeah.</p>
</blockquote>
<p>How so?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test</span><span class="p">(</span><span class="n">a</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kc">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="fm">panic!</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>compiles today</p>



<a name="272998975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/272998975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#272998975">(Feb 23 2022 at 19:24)</a>:</h4>
<p>(I've always wondered how that's the case tbh, I guess there's some special rules around this already)</p>



<a name="273341858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273341858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273341858">(Feb 26 2022 at 13:49)</a>:</h4>
<p>A case where the fallback to <code>()</code> really confused me while leading a training:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">demo</span><span class="p">(</span><span class="n">b</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">ok</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">ok</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error[E0277]: cannot add `i32` to `()`
 --&gt; src/lib.rs:4:12
  |
4 |     Some(i + if b { 2 } else { 3 })
  |            ^ no implementation for `() + i32`
  |
  = help: the trait `Add&lt;i32&gt;` is not implemented for `()`

error[E0277]: the trait bound `(): FromStr` is not satisfied
    --&gt; src/lib.rs:2:15
     |
2    |     let i = i.parse().ok()?;
     |               ^^^^^ the trait `FromStr` is not implemented for `()`
     |
note: required by a bound in `core::str::&lt;impl str&gt;::parse`
</code></pre></div>
<p>I would have preferred a "i don't know what type this is" error.</p>



<a name="273342181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273342181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273342181">(Feb 26 2022 at 13:56)</a>:</h4>
<p>I think this is our usual "type inference doesn't work through binary operators problem". At least not in the direction you're working with, it works the other way just fine. If you know the inputs to a binary operator, you can find the output, but not the other way around. This does make sense somewhat, because there can be multiple <code>impl Add for Type</code> for different types, but all of them have the same <code>type Output = i32</code>, so we wouldn't know which input type you'd want to pick</p>



<a name="273342276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273342276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273342276">(Feb 26 2022 at 13:58)</a>:</h4>
<p>We can't change fallback, as that would be a breaking change for the cases where it compiles successfully, but we could at least improve the diagnostic significantly by</p>
<p>a) pointing out why and where we came up with <code>()</code><br>
b) listing all the types that would make it compile</p>



<a name="273343079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273343079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273343079">(Feb 26 2022 at 14:12)</a>:</h4>
<blockquote>
<p>our usual "type inference doesn't work through binary operators problem".</p>
</blockquote>
<p>There's some extra wrinkle from the <code>Option</code> though. Removing it:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">demo</span><span class="p">(</span><span class="n">b</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error[E0282]: type annotations needed
 --&gt; src/lib.rs:2:9
  |
2 |     let i = i.parse().unwrap();
  |         ^ consider giving `i` a type
</code></pre></div>



<a name="273343154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273343154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273343154">(Feb 26 2022 at 14:14)</a>:</h4>
<blockquote>
<p>improve the diagnostic significantly</p>
</blockquote>
<p>This would be nice, yes.</p>
<blockquote>
<p>We can't change fallback, as that would be a breaking change</p>
</blockquote>
<p>To trot out the old question: even on an edition boundary?</p>



<a name="273344492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273344492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273344492">(Feb 26 2022 at 14:43)</a>:</h4>
<p>Reading the sibling thread, I see the edition answer is “it’s complicated”</p>



<a name="273350747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273350747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273350747">(Feb 26 2022 at 16:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F/near/273342276">said</a>:</p>
<blockquote>
<p>We can't change fallback, as that would be a breaking change for the cases where it compiles successfully</p>
</blockquote>
<p>But it's inference breakage, so we're technically allowed.  There's a way to write it that works before and after -- by annotating the types explicitly -- so it's <em>de jure</em> ok.  Obviously the details would greatly impact on whether we'd <em>actually</em> accept it, but it might be worth trying to slowly remove some fallback cases (not that I have any idea how to do that) and see if the breakage is just the "that never made any sense" cases where it'd be tolerable.</p>



<a name="273352072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273352072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273352072">(Feb 26 2022 at 17:15)</a>:</h4>
<p>I like it!</p>



<a name="273352231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/When%20is%20inference%20fallback%20important%3F/near/273352231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/When.20is.20inference.20fallback.20important.3F.html#273352231">(Feb 26 2022 at 17:18)</a>:</h4>
<p>One thing we could try before that is to run probes on each fallback and see if that actually helps and otherwise not do the fallback. That would make the successful cases explicit and we could emit a future incompat warning with a suggestion</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>