<html>
<head><meta charset="utf-8"><title>if-let behavior · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html">if-let behavior</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278460652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278460652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sonntag <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278460652">(Apr 10 2022 at 10:32)</a>:</h4>
<p>When I used <code>if let</code> with locks I ran into a surprise as this is a deadlock:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">RwLock</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RwLock</span>::<span class="n">new</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"X={x}"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">write</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Value {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I know it is transformed into a <code>match</code> statement, but from my opinion it's still not expected.<br>
Would it be possible to fix that, or is this too much effort?</p>



<a name="278460827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278460827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278460827">(Apr 10 2022 at 10:36)</a>:</h4>
<p>It will be a breaking change for people relying on the temporaries to survive (though I'm not sure if this has a real use case).</p>



<a name="278460952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278460952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278460952">(Apr 10 2022 at 10:39)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PrintOnDrop</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"inside `if`"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"inside `else`"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Now prints (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=2816b3f8dd70ddde223ef0dd2ab86e45">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=2816b3f8dd70ddde223ef0dd2ab86e45</a>):</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>inside `else`
PrintOnDrop
</code></pre></div>
<p>With this change will print:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>PrintOnDrop
inside `else`
</code></pre></div>



<a name="278461161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461161">(Apr 10 2022 at 10:45)</a>:</h4>
<p>Dropping temporaries at the end of the <code>if</code> block will change drop order. This is a visible change, and thus breaking change.</p>



<a name="278461239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sonntag <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461239">(Apr 10 2022 at 10:47)</a>:</h4>
<p>But beside of the breaking change, what would be the least surprise behavior?</p>



<a name="278461240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461240">(Apr 10 2022 at 10:47)</a>:</h4>
<p>One way to avoid such issues is to always explicitly <code>drop(a)</code> any locks to make it explicit when they are unlocked</p>



<a name="278461295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461295">(Apr 10 2022 at 10:48)</a>:</h4>
<blockquote>
<p>But beside of the breaking change, what would be the least surprise behavior?</p>
</blockquote>
<p>I'm not saying yours is not better, but being a breaking change, this is pretty much impossible. Maybe in edition 2024, like we did with captures in closures.</p>



<a name="278461310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sonntag <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461310">(Apr 10 2022 at 10:49)</a>:</h4>
<p>Do you know if there is a ticket for that? If not, would it make sense to create one?</p>



<a name="278461320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461320">(Apr 10 2022 at 10:49)</a>:</h4>
<p>there was a discussion about this not too long ago</p>



<a name="278461328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461328">(Apr 10 2022 at 10:49)</a>:</h4>
<p>If you make the algorithm more clever, it will be even harder to guess what it will do</p>



<a name="278461465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461465">(Apr 10 2022 at 10:52)</a>:</h4>
<p><a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/MCP.3A.20Allowing.20the.20compiler.20to.20eagerly.20drop.20val.E2.80.A6.20lang-team.2386">https://rust-lang.zulipchat.com/#narrow/stream/243200-t-lang.2Fmajor-changes/topic/MCP.3A.20Allowing.20the.20compiler.20to.20eagerly.20drop.20val.E2.80.A6.20lang-team.2386</a></p>



<a name="278461731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sonntag <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461731">(Apr 10 2022 at 10:59)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> : I see, thanks.</p>



<a name="278461867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chayim Refael Friedman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461867">(Apr 10 2022 at 11:01)</a>:</h4>
<p>But this is about allowing the compiler to drop at any point, while <span class="user-mention" data-user-id="247323">@Peter Sonntag</span> only wants to drop at the end of the <code>if let</code> block instead of the <code>else</code>, am I wrong?</p>



<a name="278461954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461954">(Apr 10 2022 at 11:03)</a>:</h4>
<p>that's still not lexical scoped drops, you are dropping the guard when it stops being live</p>



<a name="278461959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278461959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278461959">(Apr 10 2022 at 11:03)</a>:</h4>
<p>because there is no way you can write that such that the guard is not in scope at the point you want it to be dropped</p>



<a name="278462006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278462006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278462006">(Apr 10 2022 at 11:04)</a>:</h4>
<p>using <code>drop(guard)</code> sidesteps all these issues and is what I would want to see if I was in code review</p>



<a name="278462381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278462381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sonntag <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278462381">(Apr 10 2022 at 11:13)</a>:</h4>
<p>How would a <code>drop(guard)</code> work in my example?</p>



<a name="278463004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278463004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278463004">(Apr 10 2022 at 11:29)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">RwLock</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RwLock</span>::<span class="n">new</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">guard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">guard</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"X={x}"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">drop</span><span class="p">(</span><span class="n">guard</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">write</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Value {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278463065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278463065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Sonntag <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278463065">(Apr 10 2022 at 11:30)</a>:</h4>
<p>Ah, thanks a lot.</p>



<a name="278463067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278463067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278463067">(Apr 10 2022 at 11:30)</a>:</h4>
<p>Note that the guard is not dropped in the <code>if</code> case, so you still have an outstanding read guard on the last <code>println!</code>  line</p>



<a name="278463082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278463082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278463082">(Apr 10 2022 at 11:31)</a>:</h4>
<p>which is fine for RwLock but you can <code>drop(guard)</code> in the <code>if</code> case as well to avoid this</p>



<a name="278463130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278463130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278463130">(Apr 10 2022 at 11:32)</a>:</h4>
<p>or even hold on to the old read guard like this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">RwLock</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RwLock</span>::<span class="n">new</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">guard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">guard</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"X={x}"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">drop</span><span class="p">(</span><span class="n">guard</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">write</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">guard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Value {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">guard</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278479224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278479224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278479224">(Apr 10 2022 at 17:17)</a>:</h4>
<p>That's not holding onto the old read guard, that's dropping the guard and acquiring a new one, which means the lock is briefly not held. That would be semantically important if the lock were shared.</p>



<a name="278479658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278479658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278479658">(Apr 10 2022 at 17:24)</a>:</h4>
<p>I mean in the <code>if</code> case the guard is held. In the <code>else</code> case we have to drop the guard so we can write to it; you could avoid the possible race while the lock is not held if there was a way to convert a write guard directly into a read guard, but I don't know if that exists</p>



<a name="278485329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278485329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278485329">(Apr 10 2022 at 19:26)</a>:</h4>
<p>parkinglot has an upgradable read guard, but std doesn't</p>



<a name="278485373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278485373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278485373">(Apr 10 2022 at 19:27)</a>:</h4>
<p>TL;DR an upgradable read: acquires a read lock, puts a block on <em>new</em> read locks being acquired. When upgraded, blocks until all outstanding read locks are released.</p>



<a name="278485431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278485431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christopher Durham (CAD97) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278485431">(Apr 10 2022 at 19:29)</a>:</h4>
<p>Basically an optimization of the (read lock) (check) (drop lock) (write lock) (check) (write) to not require waiting for read locks to all drop for the second lock just for the check to skip the write</p>



<a name="278486417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278486417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278486417">(Apr 10 2022 at 19:49)</a>:</h4>
<p>Wow how did I not know that</p>



<a name="278535622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278535622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278535622">(Apr 11 2022 at 10:46)</a>:</h4>
<p>The lock APIs should really have been scoped:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">read_locked</span><span class="p">(</span><span class="o">|</span><span class="n">it</span><span class="o">|</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"X = {x}"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kc">true</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">write_locked</span><span class="p">(</span><span class="o">|</span><span class="n">it</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That way it would be way clearer when the lock is dropped each time (at the end of the <code>})</code> scope).</p>
<hr>
<p>But FWIW, in this instance the very pattern is prone to TOCTOU: you ought to start with a <code>.write()</code> or upgradable-to-<code>write</code> lock to begin with, so as not to release it in between the check and and the overwrite.</p>
<ul>
<li>But I guess for the <code>RefCell</code> equivalent this counter-argument would not hold, so the question still deserves some attention</li>
</ul>



<a name="278535812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278535812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278535812">(Apr 11 2022 at 10:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/if-let.20behavior/near/278461465">said</a>:</p>
<blockquote>
<p><a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/MCP.3A.20Allowing.20the.20compiler.20to.20eagerly.20drop.20val.E2.80.A6.20lang-team.2386">https://rust-lang.zulipchat.com/#narrow/stream/243200-t-lang.2Fmajor-changes/topic/MCP.3A.20Allowing.20the.20compiler.20to.20eagerly.20drop.20val.E2.80.A6.20lang-team.2386</a></p>
</blockquote>
<p>I don't think the arguments against that MCP apply here.</p>
<p>The argument against the MCP was that making drop placement depend on lifetime analysis is non-obvious and introduces spooky action at a distance.</p>



<a name="278535955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278535955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278535955">(Apr 11 2022 at 10:51)</a>:</h4>
<p>In this case, the rules could be a lot more straightforward: "If a match arm binds to the match expression, drop the expression at the beginning of the block, else drop at the end of the block".</p>



<a name="278536446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278536446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278536446">(Apr 11 2022 at 10:57)</a>:</h4>
<p>So:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">get_foobar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">FooBar</span>::<span class="n">Foo</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// early drop</span>
<span class="w">    </span><span class="n">FooBar</span>::<span class="n">Foo</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// late drop</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">FooBar</span>::<span class="n">Foo</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// late drop</span>
<span class="w">    </span><span class="n">FooBar</span>::<span class="n">Bar</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// early drop</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// early drop</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278536537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278536537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278536537">(Apr 11 2022 at 10:58)</a>:</h4>
<p>Thus <code>*a.read().unwrap()</code> is automatically dropped before the else in the initial example.</p>



<a name="278539403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/if-let%20behavior/near/278539403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/if-let.20behavior.html#278539403">(Apr 11 2022 at 11:28)</a>:</h4>
<p>The lock APIs aren't scoped due to the question how the API should look like vis-a-vis lock poisoning</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>