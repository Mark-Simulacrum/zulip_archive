<html>
<head><meta charset="utf-8"><title>RPITIDT · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html">RPITIDT</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276104323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276104323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276104323">(Mar 21 2022 at 19:48)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="239881">@Josh Triplett</span> -- as the "async fn in traits" liaison, do you want to "pre-read" the doc for Wed? <span class="user-mention" data-user-id="116883">@tmandry</span> and I wrote it up here <a href="https://hackmd.io/@nikomatsakis/S1xxjkZGc">https://hackmd.io/@nikomatsakis/S1xxjkZGc</a></p>



<a name="276108231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276108231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276108231">(Mar 21 2022 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Done, thank you. I added several comments.</p>



<a name="276108284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276108284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276108284">(Mar 21 2022 at 20:22)</a>:</h4>
<p>You can probably predict my most substantial feedback: "no, let's not implicitly box by default, that's not a zero-cost abstraction".</p>



<a name="276108341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276108341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276108341">(Mar 21 2022 at 20:23)</a>:</h4>
<p>I'm really appreciating the format here, of stating requirements / design goals up front, because it makes it easier to discuss this in the context of specific requirements, rather than in the context of specific solutions.</p>



<a name="276108486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276108486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276108486">(Mar 21 2022 at 20:24)</a>:</h4>
<p>I feel like there is a design goal of "zero-cost abstraction" missing here, which I would rank higher than some of the other current design goals.</p>



<a name="276108699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276108699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276108699">(Mar 21 2022 at 20:26)</a>:</h4>
<p>FWIW, I am <em>less</em> concerned with performance here (allocation isn't necessarily a massive performance hit), and more concerned with use cases (hidden allocation feels like a loss of control).</p>



<a name="276110380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276110380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276110380">(Mar 21 2022 at 20:41)</a>:</h4>
<p>Boxing be default seems fairly zero cost to me - you don’t pay if you don’t use it and I can’t imagine doing better with something handwritten. It feels kind of more ‘expensive’ than an implicit feature should be maybe, but I don’t think zero cost abstraction is quite the right objection?</p>



<a name="276110908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276110908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276110908">(Mar 21 2022 at 20:46)</a>:</h4>
<p>So, to look at it a slightly different way:</p>



<a name="276110931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276110931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276110931">(Mar 21 2022 at 20:46)</a>:</h4>
<p>If you box, then you're doing an allocation, which means you could fail, which means this operation could panic.</p>



<a name="276110946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276110946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276110946">(Mar 21 2022 at 20:46)</a>:</h4>
<p>That's one of several reasons why it's important to know if your operations allocate.</p>



<a name="276111001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276111001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276111001">(Mar 21 2022 at 20:47)</a>:</h4>
<p>Suppose you're in a context in which you <em>cannot</em> panic on allocation failure, and you instead need to carefully process that and return <code>-ENOMEM</code> from the kernel call you're in?</p>



<a name="276111010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276111010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276111010">(Mar 21 2022 at 20:47)</a>:</h4>
<p>That's not a no_std context.</p>



<a name="276111037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276111037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276111037">(Mar 21 2022 at 20:47)</a>:</h4>
<p>But where's the mechanism to say "no, stop, don't allow code to compile at all if it doesn't handle this correctly".</p>



<a name="276111064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276111064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276111064">(Mar 21 2022 at 20:47)</a>:</h4>
<p>There isn't even an opt-out, let alone a requirement to opt in.</p>



<a name="276114713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276114713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276114713">(Mar 21 2022 at 21:13)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="239881">@Josh Triplett</span> =) I'll read the comments. I think it'd be helpful if we can phrase this as a "requirement" we are trying to meet, then maybe we can iterate on that. </p>
<p>For me, the need to box stems from the requirement that the "easy path should be easy" -- i.e., you should be able to write natural code and have it just work.</p>



<a name="276114870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276114870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276114870">(Mar 21 2022 at 21:14)</a>:</h4>
<p>It'd be good to have more examples of the patterns you are talking about and where you anticipate a problem.</p>



<a name="276115072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276115072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276115072">(Mar 21 2022 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276114713">said</a>:</p>
<blockquote>
<p>Thanks <span class="user-mention silent" data-user-id="239881">Josh Triplett</span> =) I'll read the comments. I think it'd be helpful if we can phrase this as a "requirement" we are trying to meet, then maybe we can iterate on that. </p>
</blockquote>
<p>In particular, I'm wondering if some kind of allow-by-default lint makes sense here. This feels like a case where there are likely a variety of concerns one has to audit for.</p>



<a name="276117553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276117553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276117553">(Mar 21 2022 at 21:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276114713">said</a>:</p>
<blockquote>
<p>For me, the need to box stems from the requirement that the "easy path should be easy" -- i.e., you should be able to write natural code and have it just work.</p>
</blockquote>
<p>Right, and I really appreciated having that requirement written explicitly. I both agree with that requirement and rank it lower than "don't allocate implicitly". :)</p>



<a name="276117587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276117587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276117587">(Mar 21 2022 at 21:39)</a>:</h4>
<p>And I appreciate that having those requirements stated explicitly gets us that much closer to our cruxes. :)</p>



<a name="276117774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276117774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276117774">(Mar 21 2022 at 21:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276115072">said</a>:</p>
<blockquote>
<p>In particular, I'm wondering if some kind of allow-by-default lint makes sense here. This feels like a case where there are likely a variety of concerns one has to audit for.</p>
</blockquote>
<p>Perhaps, but it feels like that's starting from a requirement that it look a certain way, and then working backwards to a mechanism for making the other cases possible, which makes those cases feel second-class.</p>



<a name="276118483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276118483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276118483">(Mar 21 2022 at 21:47)</a>:</h4>
<p>Part of what I'm getting at is -- imagine that we required explicit annotation, e.g., via <code>#[dyn(box)]</code>. Do you think that your use case would be satisfied?</p>



<a name="276118598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276118598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276118598">(Mar 21 2022 at 21:48)</a>:</h4>
<p>I could also imagine wanting other points -- perhaps the coercion that references the boxing vtable -- to be loud. But I'm not sure if I find that convincing, since most any fn call could allocate.</p>



<a name="276119546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276119546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276119546">(Mar 21 2022 at 21:59)</a>:</h4>
<p>The other question is whether "easy to audit allocations if desired" is a better way to phrase your requirement.</p>



<a name="276119766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276119766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276119766">(Mar 21 2022 at 22:01)</a>:</h4>
<p>"easy to audit and prevent allocations if desired"?</p>



<a name="276120089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276120089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276120089">(Mar 21 2022 at 22:04)</a>:</h4>
<p>one thing that bothers me is -- I feel like our lints and things are not "organized" enough here. This feels related to the whole portability design question.</p>



<a name="276120755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276120755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276120755">(Mar 21 2022 at 22:12)</a>:</h4>
<p>hoping not to derail discussion too much, but it would be nice if you could define profiles that enable certain lints and other global things (dyn adaptation strategy, allocator if crate_type = bin, ...)</p>



<a name="276120985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276120985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276120985">(Mar 21 2022 at 22:14)</a>:</h4>
<p>but that feels more like a build system feature</p>



<a name="276121363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276121363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276121363">(Mar 21 2022 at 22:19)</a>:</h4>
<p>this is partly what I am getting at</p>



<a name="276121996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276121996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276121996">(Mar 21 2022 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276118483">said</a>:</p>
<blockquote>
<p>Part of what I'm getting at is -- imagine that we required explicit annotation, e.g., via <code>#[dyn(box)]</code>. Do you think that your use case would be satisfied?</p>
</blockquote>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Explicit annotation where? I was kinda assuming the annotation would just be <code>Box::new</code> in the appropriate place.</p>



<a name="276122031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276122031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276122031">(Mar 21 2022 at 22:27)</a>:</h4>
<p>This seems like something the compiler could catch, and suggest either <code>Box::new</code> or <code>dyner::Something::new</code>.</p>



<a name="276122057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276122057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276122057">(Mar 21 2022 at 22:27)</a>:</h4>
<p>(Bonus if some future work could give a hint of "don't suggest <code>Box::new</code>", but that's optional.)</p>



<a name="276122129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276122129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276122129">(Mar 21 2022 at 22:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> My initial reaction is "this seems like a case where it's correct that Rust and Dada would have different behavior because they have different requirements". :)</p>



<a name="276172715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276172715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276172715">(Mar 22 2022 at 11:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276121996">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> Explicit annotation where? I was kinda assuming the annotation would just be <code>Box::new</code> in the appropriate place.</p>
</blockquote>
<p>It's not that simple-- you only want the box to occur when using dynamic dispatch, not static dispatch. Under the current design, the annotation would be on the impl that is implementing the trait. Or, more specifically, on the async fn within that impl.</p>



<a name="276172751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276172751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276172751">(Mar 22 2022 at 11:17)</a>:</h4>
<p>The allocation is happening inside the "shim" function that goes in the vtable, and the <code>#[dyn(box)]</code> annotation controls how that shim function is generated.</p>



<a name="276178918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276178918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276178918">(Mar 22 2022 at 12:12)</a>:</h4>
<p>The <code>#[dyner::inline_adapter(MyAdapterTrait)]</code> syntax seems mainly designed for the "async iterator" use-case. Would it still work with non-async RPIT-in-traits? With traits that have multiple async methods?</p>



<a name="276191392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276191392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276191392">(Mar 22 2022 at 13:53)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Ah, I think I see! The box goes around the one return value, not the dyn trait.</p>



<a name="276197406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276197406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276197406">(Mar 22 2022 at 14:34)</a>:</h4>
<p>Correct.</p>



<a name="276197584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276197584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276197584">(Mar 22 2022 at 14:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276178918">said</a>:</p>
<blockquote>
<p>The <code>#[dyner::inline_adapter(MyAdapterTrait)]</code> syntax seems mainly designed for the "async iterator" use-case. Would it still work with non-async RPIT-in-traits? With traits that have multiple async methods?</p>
</blockquote>
<p>I don't think there is any specific to async iterator <em>per se</em>-- it works best for <code>&amp;mut self</code> methods, though, and if you have a whole bunch of async fns but you only call 1 or 2 you would waste some stack space. (With <code>&amp;self</code> methods, we have to prevent recursion, and that is a dynamic check; I don't think there's much of a way around <em>that</em>.)</p>
<p>That said, from discussions with folks in an embedded etc space, there are very limited reasons to use <code>dyn</code> and the above conditions mostly apply just fine.</p>



<a name="276247570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276247570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276247570">(Mar 22 2022 at 20:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I don't think <code>&amp;mut self</code> alone is enough to prevent recursion</p>



<a name="276372609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276372609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276372609">(Mar 23 2022 at 17:38)</a>:</h4>
<blockquote>
<p>(With <code>&amp;self</code> methods, we have to prevent recursion, and that is a dynamic check; I don't think there's much of a way around that.)</p>
</blockquote>
<p>You don't just have to prevent recursion, you have to handle this case:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">get_printable</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Display</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">call_three_times</span><span class="p">(</span><span class="n">obj</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">MyTrait</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">get_printable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">get_printable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">get_printable</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{a} {b} {c}"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276373067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276373067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276373067">(Mar 23 2022 at 17:42)</a>:</h4>
<p>I guess you could use refcells to make it fail at runtime, but it seems unexpected</p>



<a name="276376296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376296">(Mar 23 2022 at 18:04)</a>:</h4>
<p>so <span class="user-mention" data-user-id="239881">@Josh Triplett</span> something I wanted to follow up with</p>



<a name="276376297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376297">(Mar 23 2022 at 18:04)</a>:</h4>
<p>yes, we would use something refcell-like</p>



<a name="276376328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376328">(Mar 23 2022 at 18:04)</a>:</h4>
<p>at least right now with rust, if you have <code>dyn AsyncIterator</code>, then this type implements <code>AsyncIterator</code></p>



<a name="276376343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376343">(Mar 23 2022 at 18:04)</a>:</h4>
<p>which implies that you can have</p>



<a name="276376374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376374">(Mar 23 2022 at 18:05)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AsyncIterator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276376382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376382">(Mar 23 2022 at 18:05)</a>:</h4>
<p>which might or might not be dyn</p>



<a name="276376432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376432">(Mar 23 2022 at 18:05)</a>:</h4>
<p>Sure. And we're allowed to change the <code>extern "Rust"</code> calling convention any way we want, so if we need handling for the "may or may not be dyn" case we can do that.</p>



<a name="276376441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376441">(Mar 23 2022 at 18:05)</a>:</h4>
<p>it's not impossible to have opt-in, but it chips away at that composition and so forth</p>



<a name="276376466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376466">(Mar 23 2022 at 18:06)</a>:</h4>
<p>it's not about the ABI</p>



<a name="276376533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376533">(Mar 23 2022 at 18:06)</a>:</h4>
<p>it's that you couldn't write functions like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AsyncIterator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276376544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376544">(Mar 23 2022 at 18:06)</a>:</h4>
<p>maybe fine, just an observation</p>



<a name="276376555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376555">(Mar 23 2022 at 18:06)</a>:</h4>
<p>or rather, you could write them</p>



<a name="276376562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376562">(Mar 23 2022 at 18:06)</a>:</h4>
<p>but they'd have to "opt-in" to some strategy</p>



<a name="276376575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376575">(Mar 23 2022 at 18:06)</a>:</h4>
<p>Right. That seems completely fine to me?</p>



<a name="276376577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376577">(Mar 23 2022 at 18:06)</a>:</h4>
<p>it's very unclear to me that they are in a good position to do that!</p>



<a name="276376668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376668">(Mar 23 2022 at 18:07)</a>:</h4>
<p>Sorry, correction:</p>



<a name="276376701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376701">(Mar 23 2022 at 18:07)</a>:</h4>
<p>i'm still a bit stuck on what bad outcome you are trying to avoid -- or at least, why it's not ok for code that has very particular requirements about allocation to say so (and wouldn't that be an opportunity for us to help that code even further?)</p>



<a name="276376735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376735">(Mar 23 2022 at 18:07)</a>:</h4>
<p>I would expect that someone who has a <code>dyn T</code> who wants to pass that to an <code>impl T + ?Sized</code> has to make the decision at <em>that</em> point about how to handle it.</p>



<a name="276376795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376795">(Mar 23 2022 at 18:08)</a>:</h4>
<p>interesting</p>



<a name="276376816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376816">(Mar 23 2022 at 18:08)</a>:</h4>
<p>so <code>dyn T: T</code> would no longer be true</p>



<a name="276376830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376830">(Mar 23 2022 at 18:08)</a>:</h4>
<p>but there'd be adapters to from <code>dyn T</code> to <code>impl T</code></p>



<a name="276376855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376855">(Mar 23 2022 at 18:08)</a>:</h4>
<p>(mind you, I've thought about lifting that requirement for a lot of reasons, so I think that's ok)</p>



<a name="276376890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376890">(Mar 23 2022 at 18:08)</a>:</h4>
<p>(regardless, I still think we should make the simple code work)</p>



<a name="276376907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376907">(Mar 23 2022 at 18:09)</a>:</h4>
<p>(and provide a way to say when you don't like box)</p>



<a name="276376961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376961">(Mar 23 2022 at 18:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376907">said</a>:</p>
<blockquote>
<p>(and provide a way to say when you don't like box)</p>
</blockquote>
<p>(insert ongoing objection to "say when you <em>don't</em> like" here)</p>



<a name="276376990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276376990">(Mar 23 2022 at 18:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376816">said</a>:</p>
<blockquote>
<p>so <code>dyn T: T</code> would no longer be true</p>
</blockquote>
<p>The fact that that's true today does seem like a painful limitation, yes.</p>



<a name="276377037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377037">(Mar 23 2022 at 18:10)</a>:</h4>
<p>(For the longest time I wasn't aware that that <em>was</em> true.)</p>



<a name="276377103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377103">(Mar 23 2022 at 18:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276376961">said</a>:</p>
<blockquote>
<p>(insert ongoing objection to "say when you <em>don't</em> like" here)</p>
</blockquote>
<p>what exactly is it? you don't like opting out in general?</p>



<a name="276377140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377140">(Mar 23 2022 at 18:10)</a>:</h4>
<p>or specific to <code>Box</code></p>



<a name="276377207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377207">(Mar 23 2022 at 18:11)</a>:</h4>
<p>/me tries to formulate that objection.</p>



<a name="276377224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377224">(Mar 23 2022 at 18:11)</a>:</h4>
<p>can you walk me through the scenario you have in mind a bit more closely?</p>



<a name="276377234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377234">(Mar 23 2022 at 18:11)</a>:</h4>
<p>I think it's something like this</p>



<a name="276377242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377242">(Mar 23 2022 at 18:11)</a>:</h4>
<p>I am a kernel developer</p>



<a name="276377249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377249">(Mar 23 2022 at 18:11)</a>:</h4>
<p>(deleted)</p>



<a name="276377264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377264">(Mar 23 2022 at 18:11)</a>:</h4>
<p>I am manually reading my code</p>



<a name="276377270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377270">(Mar 23 2022 at 18:11)</a>:</h4>
<p>to look for boxes :)</p>



<a name="276377334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377334">(Mar 23 2022 at 18:12)</a>:</h4>
<p>to the point, I have to be very careful about where I allocate</p>



<a name="276377366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377366">(Mar 23 2022 at 18:12)</a>:</h4>
<p>I see</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">SomeTrait</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">method</span><span class="p">().</span><span class="k">await</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276377379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377379">(Mar 23 2022 at 18:12)</a>:</h4>
<p>that code on its own is fine</p>



<a name="276377389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377389">(Mar 23 2022 at 18:12)</a>:</h4>
<p>then elsewhere I see</p>



<a name="276377412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377412">(Mar 23 2022 at 18:12)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">something</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="276377413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377413">(Mar 23 2022 at 18:12)</a>:</h4>
<p>Trying to roughly capture the feeling, here: I don't like code that looks <em>exactly like</em> other code patterns but makes allocations behind the scenes in order to not change the interface.</p>



<a name="276377415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377415">(Mar 23 2022 at 18:12)</a>:</h4>
<p>where <code>something: T</code></p>



<a name="276377432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377432">(Mar 23 2022 at 18:12)</a>:</h4>
<p>so I go read the impl for <code>T</code> to be sure that its impl doesn't box</p>



<a name="276377438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377438">(Mar 23 2022 at 18:12)</a>:</h4>
<p>I don't see any boxes, so I am happy</p>



<a name="276377462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377462">(Mar 23 2022 at 18:13)</a>:</h4>
<p>but one is injected by the shim at the coercion site that I didn't realize</p>



<a name="276377482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377482">(Mar 23 2022 at 18:13)</a>:</h4>
<p>That's getting much closer to the feeling, yes.</p>



<a name="276377487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377487">(Mar 23 2022 at 18:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377379">said</a>:</p>
<blockquote>
<p>that code on its own is fine</p>
</blockquote>
<p>"on its own is fine" is actually getting closer to the feeling I'm concerned about, yes.</p>



<a name="276377515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377515">(Mar 23 2022 at 18:13)</a>:</h4>
<p>I mean, I see that as a key feature</p>



<a name="276377527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377527">(Mar 23 2022 at 18:13)</a>:</h4>
<p>that's "separation of concerns"</p>



<a name="276377548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377548">(Mar 23 2022 at 18:13)</a>:</h4>
<p>Right now, we're getting close to the point where I just mentally add <code>dyn</code> to the "don't ever do that" list in contexts where I care at all about allocation.</p>



<a name="276377560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377560">(Mar 23 2022 at 18:13)</a>:</h4>
<p>I'd like to not do that.</p>



<a name="276377562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377562">(Mar 23 2022 at 18:13)</a>:</h4>
<p>I want people to be able to write libraries that don't have to think about their caller's requirements and they can still be used by all the callers</p>



<a name="276377648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377648">(Mar 23 2022 at 18:14)</a>:</h4>
<p>I still feel like what you want is a "#[warn(allocation)]` lint</p>



<a name="276377671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377671">(Mar 23 2022 at 18:14)</a>:</h4>
<p>that warns about calls to <code>Box::new</code>, <code>vec.push</code>, etc</p>



<a name="276377686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377686">(Mar 23 2022 at 18:14)</a>:</h4>
<p>but also coercions to dyn that don't use <code>dyn(identity)</code></p>



<a name="276377719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377719">(Mar 23 2022 at 18:14)</a>:</h4>
<p>Right now, I can skim for <code>String</code> or <code>Vec</code> or <code>Box</code> or similar, and be confident allocation doesn't happen. Do I need to add <code>dyn</code> to that list, or can there be something more specific so that <code>dyn</code> in general is not verboten?</p>



<a name="276377750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377750">(Mar 23 2022 at 18:15)</a>:</h4>
<p>One thing that comes to mind is that implicit boxing may be much more acceptable in <code>async</code> contexts than in general RPITIDT contexts. Maybe a middle ground here is to do opt out in async but opt in for other cases. I do think it's sort of unfortunate that Rust loses the "no implicit allocations" claim to fame, but specifically <code>async</code> seems like a domain where this is of less concern</p>



<a name="276377761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377761">(Mar 23 2022 at 18:15)</a>:</h4>
<p>dyn in general is not verboten, dyn without some kind of adapter is</p>



<a name="276377794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377794">(Mar 23 2022 at 18:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377761">said</a>:</p>
<blockquote>
<p>dyn in general is not verboten, dyn without some kind of adapter is</p>
</blockquote>
<p>What do I grep for to find "dyn without some kind of adapter"?</p>



<a name="276377821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377821">(Mar 23 2022 at 18:15)</a>:</h4>
<p>I feel like there's a "code reading" pattern here, of "I shouldn't have to know multiple distant pieces of information to find something".</p>



<a name="276377822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377822">(Mar 23 2022 at 18:15)</a>:</h4>
<p>why would you grep and not let the compiler help you?</p>



<a name="276377843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377843">(Mar 23 2022 at 18:15)</a>:</h4>
<p>like, we could add a crate attr <code>#![no_implicit_dyn_boxing]</code> which removes the auto box feature, don't we?</p>



<a name="276377853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377853">(Mar 23 2022 at 18:15)</a>:</h4>
<p>The compiler isn't helping me, it's boxing "for" me. :P</p>



<a name="276377863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377863">(Mar 23 2022 at 18:15)</a>:</h4>
<p><code>#[warn(...)]</code></p>



<a name="276377881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377881">(Mar 23 2022 at 18:15)</a>:</h4>
<p>I mean: let the compiler help you search</p>



<a name="276377922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377922">(Mar 23 2022 at 18:16)</a>:</h4>
<p>like, if you don't want something, say so</p>



<a name="276377950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377950">(Mar 23 2022 at 18:16)</a>:</h4>
<p>I don't think it's always good</p>



<a name="276377951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377951">(Mar 23 2022 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377863">said</a>:</p>
<blockquote>
<p><code>#[warn(...)]</code></p>
</blockquote>
<p>But I don't want to warn on every allocation. I'm not in no_std. I want to <em>be careful about</em> every allocation.</p>



<a name="276377958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377958">(Mar 23 2022 at 18:16)</a>:</h4>
<p>but in this case it seems like a decent tradeoff</p>



<a name="276377960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377960">(Mar 23 2022 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377843">said</a>:</p>
<blockquote>
<p>like, we could add a crate attr <code>#![no_implicit_dyn_boxing]</code> which removes the auto box feature, don't we?</p>
</blockquote>
<p>and with that we're back at no implicit allocations <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="276377973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377973">(Mar 23 2022 at 18:16)</a>:</h4>
<p>especially given how omnipresent allocations are</p>



<a name="276377995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276377995">(Mar 23 2022 at 18:16)</a>:</h4>
<p>I feel you overestimate your ability to predict that</p>



<a name="276378037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378037">(Mar 23 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377843">said</a>:</p>
<blockquote>
<p>like, we could add a crate attr <code>#![no_implicit_dyn_boxing]</code> which removes the auto box feature, don't we?</p>
</blockquote>
<p>yes, I'm basically saying this feature could be <code>#[deny(allocation)]</code></p>



<a name="276378042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378042">(Mar 23 2022 at 18:17)</a>:</h4>
<p>where this is a new lint group</p>



<a name="276378072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378072">(Mar 23 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378037">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276377843">said</a>:</p>
<blockquote>
<p>like, we could add a crate attr <code>#![no_implicit_dyn_boxing]</code> which removes the auto box feature, don't we?</p>
</blockquote>
<p>yes, I'm basically saying this feature could be <code>#[deny(allocation)]</code></p>
</blockquote>
<p>See above, I don't want to <em>deny</em> allocation, I want to think about every allocation.</p>



<a name="276378096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378096">(Mar 23 2022 at 18:17)</a>:</h4>
<p>no one is stopping you?</p>



<a name="276378122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378122">(Mar 23 2022 at 18:17)</a>:</h4>
<p>It's hard to think about things that aren't visible in the code.</p>



<a name="276378128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378128">(Mar 23 2022 at 18:17)</a>:</h4>
<p>you can <code>#[allow]</code>, or you can use an adapter that allocates (and hence uses <code>dyn(identity)</code>)</p>



<a name="276378138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378138">(Mar 23 2022 at 18:17)</a>:</h4>
<p>I mean, <code>#[deny(allocation)]</code> would be exactly that.</p>



<a name="276378152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378152">(Mar 23 2022 at 18:17)</a>:</h4>
<p>"compiler-added implicit code" has not in the past included allocations.</p>



<a name="276378161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378161">(Mar 23 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378138">said</a>:</p>
<blockquote>
<p>I mean, <code>#[deny(allocation)]</code> would be exactly that.</p>
</blockquote>
<p>see my comment above :)</p>



<a name="276378164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378164">(Mar 23 2022 at 18:17)</a>:</h4>
<blockquote>
<p>But I don't want to warn on every allocation. I'm not in no_std. I want to be careful about every allocation.</p>
</blockquote>
<p>This seems like a good use case for clippy "restriction" lints?</p>



<a name="276378227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378227">(Mar 23 2022 at 18:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378152">said</a>:</p>
<blockquote>
<p>"compiler-added implicit code" has not in the past included allocations.</p>
</blockquote>
<p>that's true, but we are now addressing a wider range of use cases</p>



<a name="276378260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378260">(Mar 23 2022 at 18:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378227">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378152">said</a>:</p>
<blockquote>
<p>"compiler-added implicit code" has not in the past included allocations.</p>
</blockquote>
<p>that's true, but we are now addressing a wider range of use cases</p>
</blockquote>
<p>Right, and I'm trying to advocate for the requirement of "don't ever do that, find another way to solve those use cases".</p>



<a name="276378273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378273">(Mar 23 2022 at 18:18)</a>:</h4>
<p>I'm trying to install that at the requirements level. :)</p>



<a name="276378316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378316">(Mar 23 2022 at 18:18)</a>:</h4>
<p>yes, I realize that, and I'm pushing back :)</p>



<a name="276378348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378348">(Mar 23 2022 at 18:19)</a>:</h4>
<p>I think what I'm saying is:</p>
<ul>
<li>this concern is niche</li>
<li>it's ok to ask people with this concern to say so</li>
</ul>



<a name="276378363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378363">(Mar 23 2022 at 18:19)</a>:</h4>
<p>it takes one line</p>



<a name="276378372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378372">(Mar 23 2022 at 18:19)</a>:</h4>
<p>and it makes your life better in other ways too</p>



<a name="276378376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378376">(Mar 23 2022 at 18:19)</a>:</h4>
<p>you don't have to be the compiler</p>



<a name="276378378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378378">(Mar 23 2022 at 18:19)</a>:</h4>
<p>I know, and I'd be happy to have a discussion at that level (in addition to the this-instance case of "can we do without").</p>



<a name="276378387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378387">(Mar 23 2022 at 18:19)</a>:</h4>
<p>you can let the compiler be the compiler and help you</p>



<a name="276378411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378411">(Mar 23 2022 at 18:19)</a>:</h4>
<p>SIde note, I think implicit allocation of any kind is a poor idea. C++ has implicit allocation, and it means <code>operator new</code> is a required function, even in freestanding.</p>



<a name="276378464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378464">(Mar 23 2022 at 18:19)</a>:</h4>
<p>I mean, if we were <em>actually</em> adding a feature to the compiler to help with this, it'd be something that looks like unsafe blocks. <code>alloc_ok { ... }</code>. That'd be a <em>fascinating</em> effect-ish thing to add, where any function doing an allocation has to propagate that property upwards.</p>



<a name="276378525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378525">(Mar 23 2022 at 18:20)</a>:</h4>
<p>/me thinks</p>



<a name="276378547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378547">(Mar 23 2022 at 18:20)</a>:</h4>
<p><code>alloc_ok { random_function() }</code> if <code>random_function()</code> wants to write <code>Vec::new()</code> internally.</p>



<a name="276378561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378561">(Mar 23 2022 at 18:20)</a>:</h4>
<p>I think to phrase things in a more positive way, it seems <em>very important</em> to me that people are able to work with dyn trait objects in a natural way</p>



<a name="276378565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378565">(Mar 23 2022 at 18:20)</a>:</h4>
<p>But I don't see us adding that <em>soon</em>. :)</p>



<a name="276378588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378588">(Mar 23 2022 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378561">said</a>:</p>
<blockquote>
<p>I think to phrase things in a more positive way, it seems <em>very important</em> to me that people are able to work with dyn trait objects in a natural way</p>
</blockquote>
<p>I understand and acknowledge that requirement.</p>



<a name="276378594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378594">(Mar 23 2022 at 18:20)</a>:</h4>
<p>having to add box in front of every method call doesn't feel natural to me</p>



<a name="276378617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378617">(Mar 23 2022 at 18:20)</a>:</h4>
<p>Approaching things in similar terms...</p>



<a name="276378619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378619">(Mar 23 2022 at 18:20)</a>:</h4>
<p>I'm not especially keen on the fact that you have to write <code>Box&lt;dyn ...&gt;</code>, I'd like to do better there too</p>



<a name="276378674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378674">(Mar 23 2022 at 18:21)</a>:</h4>
<p>Isn't that what unsized locals are for?</p>



<a name="276378682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378682">(Mar 23 2022 at 18:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378594">said</a>:</p>
<blockquote>
<p>having to add box in front of every method call doesn't feel natural to me</p>
</blockquote>
<p>Having to write <code>box</code> or similar in front of a method call that allocates feels both natural and very Rust to me; it evokes the feeling Rust gives me of "I know what Rust is doing, Rust won't do something unexpected behind my back".</p>



<a name="276378683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378683">(Mar 23 2022 at 18:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378464">said</a>:</p>
<blockquote>
<p>I mean, if we were <em>actually</em> adding a feature to the compiler to help with this, it'd be something that looks like unsafe blocks. <code>alloc_ok { ... }</code>. That'd be a <em>fascinating</em> effect-ish thing to add, where any function doing an allocation has to propagate that property upwards.</p>
</blockquote>
<p>I'm not sure how different that is from what I jsut proposed with a lint</p>



<a name="276378689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378689">(Mar 23 2022 at 18:21)</a>:</h4>
<p>it doesn't seem very different</p>



<a name="276378722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378722">(Mar 23 2022 at 18:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378674">said</a>:</p>
<blockquote>
<p>Isn't that what unsized locals are for?</p>
</blockquote>
<p>Don't work in generators unfortunately</p>



<a name="276378742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378742">(Mar 23 2022 at 18:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378674">said</a>:</p>
<blockquote>
<p>Isn't that what unsized locals are for?</p>
</blockquote>
<p>they don't work in async or... in general :)</p>



<a name="276378756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378756">(Mar 23 2022 at 18:21)</a>:</h4>
<p>but certainly not in async</p>



<a name="276378767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378767">(Mar 23 2022 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> A lint wouldn't actually have the desired property, because you can allow a lint in a random function <em>without</em> having to then allow the same lint whenever calling the function.</p>



<a name="276378769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378769">(Mar 23 2022 at 18:21)</a>:</h4>
<p>also, no, they don't work in general for this case</p>



<a name="276378789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378789">(Mar 23 2022 at 18:21)</a>:</h4>
<p>(well, I guess if you store the szie in the vtable, you can make it work)</p>



<a name="276378841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378841">(Mar 23 2022 at 18:22)</a>:</h4>
<p>(for this particular case)</p>



<a name="276378868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378868">(Mar 23 2022 at 18:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378767">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> A lint wouldn't actually have the desired property, because you can allow a lint in a random function <em>without</em> having to then allow the same lint whenever calling the function.</p>
</blockquote>
<p>same with unsfae?</p>



<a name="276378882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378882">(Mar 23 2022 at 18:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378789">said</a>:</p>
<blockquote>
<p>(well, I guess if you store the szie in the vtable, you can make it work)</p>
</blockquote>
<p>I'd very much like to explore that solution, for this particular case, in addition to discussing the general requirement.</p>



<a name="276378898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378898">(Mar 23 2022 at 18:22)</a>:</h4>
<blockquote>
<p>also, no, they don't work in general for this case</p>
</blockquote>
<p>I want to push back a little on that</p>



<a name="276378930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378930">(Mar 23 2022 at 18:22)</a>:</h4>
<p>I agree, I was mistaken about that</p>



<a name="276378938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378938">(Mar 23 2022 at 18:22)</a>:</h4>
<p>if you store the size of the future in the vtable</p>



<a name="276378961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378961">(Mar 23 2022 at 18:23)</a>:</h4>
<p><em>and</em> you're in an environment that supports alloca</p>



<a name="276378967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378967">(Mar 23 2022 at 18:23)</a>:</h4>
<p>you can do that</p>



<a name="276378992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378992">(Mar 23 2022 at 18:23)</a>:</h4>
<p>Can I quickly make my case?</p>



<a name="276378996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276378996">(Mar 23 2022 at 18:23)</a>:</h4>
<p>it wouldn't work for (e.g.) returning <code>[u32]</code> or something</p>



<a name="276379001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379001">(Mar 23 2022 at 18:23)</a>:</h4>
<p>where the length is computed by the fn</p>



<a name="276379029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379029">(Mar 23 2022 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276378992">said</a>:</p>
<blockquote>
<p>Can I quickly make my case?</p>
</blockquote>
<p>Please do go ahead, I'd like to hear what you're proposing.</p>



<a name="276379105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379105">(Mar 23 2022 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> FWIW, I do agree that "size in the vtable" is not a completely optimal solution either. If you have a function that sometimes returns a tiny future and sometimes returns a huge future then ideally you'd be able to allocate only what's needed for the given call.</p>



<a name="276379178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379178">(Mar 23 2022 at 18:24)</a>:</h4>
<p>AIUI we make that tradeoff today, in that futures are as big as the biggest suspend point requires.</p>



<a name="276379222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379222">(Mar 23 2022 at 18:24)</a>:</h4>
<p>yes, I'd like to have an easy way to "box" cold parts of your future</p>



<a name="276379253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379253">(Mar 23 2022 at 18:24)</a>:</h4>
<p>niko: To make sure I understand your position: Your problem with the "unsized returns" path is that it doesn't work for the use case of embedded developers in a no_alloc environment that nevertheless want to use <code>dyn AsyncIterator</code>. Is that correct?</p>



<a name="276379283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379283">(Mar 23 2022 at 18:25)</a>:</h4>
<p>Isn't the size of the type already in the vtable, because of <code>size_of_val</code>?</p>



<a name="276379303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379303">(Mar 23 2022 at 18:25)</a>:</h4>
<p>I'm pondering -- there's definitely a problem here of "for some people, box is something to be very careful about; for others, it's a huge enabler".</p>



<a name="276379318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379318">(Mar 23 2022 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379283">said</a>:</p>
<blockquote>
<p>Isn't the size of the type already in the vtable, because of <code>size_of_val</code>?</p>
</blockquote>
<p>this is the size of the futures its methods will return</p>



<a name="276379334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379334">(Mar 23 2022 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379253">said</a>:</p>
<blockquote>
<p>niko: To make sure I understand your position: Your problem with the "unsized returns" path is that it doesn't work for the use case of embedded developers in a no_alloc environment that nevertheless want to use <code>dyn AsyncIterator</code>. Is that correct?</p>
</blockquote>
<p>no</p>



<a name="276379354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379354">(Mar 23 2022 at 18:25)</a>:</h4>
<p>Ah ok. That would be annoying.</p>



<a name="276379358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379358">(Mar 23 2022 at 18:25)</a>:</h4>
<p>in async</p>



<a name="276379425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379425">(Mar 23 2022 at 18:26)</a>:</h4>
<p>basically, the way that async fn works is that you return an <code>impl Future</code></p>



<a name="276379439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379439">(Mar 23 2022 at 18:26)</a>:</h4>
<p>which can get embedded in other <code>impl Future</code> types</p>



<a name="276379460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379460">(Mar 23 2022 at 18:26)</a>:</h4>
<p>to yield your final future type, which has a fixed size</p>



<a name="276379467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379467">(Mar 23 2022 at 18:26)</a>:</h4>
<p>FWIW, I absolutely think box is a huge enabler, and I'm glad Rust makes it so easy (with, among other things, Deref).</p>



<a name="276379478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379478">(Mar 23 2022 at 18:26)</a>:</h4>
<p>we allocate that in the heap, and it effectively <em>becomes</em> the stack for that future</p>



<a name="276379491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379491">(Mar 23 2022 at 18:26)</a>:</h4>
<p>I'm also glad Rust makes it as easy as it can without making it disappear.</p>



<a name="276379544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379544">(Mar 23 2022 at 18:27)</a>:</h4>
<p>I'd also like for specifically <code>Box</code> to not become even <em>more</em> magic.</p>



<a name="276379545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379545">(Mar 23 2022 at 18:27)</a>:</h4>
<p>Down the "disappear" path lies Java, where it feels like it takes considerable skill to say "no, really, I just want an integer, not a pointer to an integer".</p>



<a name="276379576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379576">(Mar 23 2022 at 18:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379478">said</a>:</p>
<blockquote>
<p>we allocate that in the heap, and it effectively <em>becomes</em> the stack for that future</p>
</blockquote>
<p>the point being, we can't alloca in that environment</p>



<a name="276379582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379582">(Mar 23 2022 at 18:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379544">said</a>:</p>
<blockquote>
<p>I'd also like for specifically <code>Box</code> to not become even <em>more</em> magic.</p>
</blockquote>
<p><code>#[lang = "Box"]</code>; let's not go down that tangent in <em>this</em> thread please. :)</p>



<a name="276379587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379587">(Mar 23 2022 at 18:27)</a>:</h4>
<p>the stack is a struct allocated in the heap</p>



<a name="276379599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379599">(Mar 23 2022 at 18:27)</a>:</h4>
<p>Right.</p>



<a name="276379630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379630">(Mar 23 2022 at 18:27)</a>:</h4>
<p>But the unsized returns proposal works without alloca</p>



<a name="276379693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379693">(Mar 23 2022 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379587">said</a>:</p>
<blockquote>
<p>the stack is a struct allocated in the heap</p>
</blockquote>
<p>Checking something: in the context of a future, that struct can also be allocated on the caller's stack, right?</p>



<a name="276379700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379700">(Mar 23 2022 at 18:28)</a>:</h4>
<p>there seem to be 2 questions re: box, one (which I think <span class="user-mention" data-user-id="257758">@Connor Horman</span> is alluding to) is that it is well understood by the analyses, the other is the fact that it allocates. lifting the first is relatively easy and orthogonal.</p>



<a name="276379715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379715">(Mar 23 2022 at 18:28)</a>:</h4>
<p>the latter is more fundamental :)</p>



<a name="276379737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379737">(Mar 23 2022 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379693">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379587">said</a>:</p>
<blockquote>
<p>the stack is a struct allocated in the heap</p>
</blockquote>
<p>Checking something: in the context of a future, that struct can also be allocated on the caller's stack, right?</p>
</blockquote>
<p>yes, I was simplifying, but regardless it's a struct of fixed size</p>



<a name="276379762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379762">(Mar 23 2022 at 18:28)</a>:</h4>
<p>Understood.</p>



<a name="276379763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379763">(Mar 23 2022 at 18:28)</a>:</h4>
<p>and the point is that you need to be able to pop that stack frame easily</p>



<a name="276379770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379770">(Mar 23 2022 at 18:28)</a>:</h4>
<p>and jump back into it</p>



<a name="276379780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379780">(Mar 23 2022 at 18:28)</a>:</h4>
<p>so that's kind of the "whole thing"</p>



<a name="276379787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379787">(Mar 23 2022 at 18:28)</a>:</h4>
<blockquote>
<p>But the unsized returns proposal works without alloca</p>
</blockquote>
<p>The idea is that you do <code>Box::new_with(|| function_that_returns_unsized(a, b, c))</code> and with some compiler magic detailed in the RFC, it all works without doing allocas</p>



<a name="276379805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379805">(Mar 23 2022 at 18:29)</a>:</h4>
<p>if we are boxing anyway.....</p>



<a name="276379809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379809">(Mar 23 2022 at 18:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379582">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379544">said</a>:</p>
<blockquote>
<p>I'd also like for specifically <code>Box</code> to not become even <em>more</em> magic.</p>
</blockquote>
<p><code>#[lang = "Box"]</code>; let's not go down that tangent in <em>this</em> thread please. :)</p>
</blockquote>
<p>I mean, at least keeping from gaining more magic is relevant here, since it's an argument against autoboxing. I'm not going to argue making it less magic, I'll save that for deref patterns and deref move.</p>



<a name="276379812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379812">(Mar 23 2022 at 18:29)</a>:</h4>
<p>....I'm not seeing the point :)</p>



<a name="276379824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379824">(Mar 23 2022 at 18:29)</a>:</h4>
<p>but this is getting at exactly the question</p>



<a name="276379847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379847">(Mar 23 2022 at 18:29)</a>:</h4>
<p>of whether it's acceptable to ask people to write <code>box foo.some_method().await</code> or whatever</p>



<a name="276379860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379860">(Mar 23 2022 at 18:29)</a>:</h4>
<p>and whether we expect to ship this year :)</p>



<a name="276379870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379870">(Mar 23 2022 at 18:29)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> So, I think the async fixed-size structs case is actually illuminating here.</p>



<a name="276379872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379872">(Mar 23 2022 at 18:29)</a>:</h4>
<p>I guess it would be <code>foo.some_method().box.await</code></p>



<a name="276379901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379901">(Mar 23 2022 at 18:29)</a>:</h4>
<p>Oooh, not bad.</p>



<a name="276379909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379909">(Mar 23 2022 at 18:29)</a>:</h4>
<p>since <code>box</code> as a prefix has all the wrong precedence</p>



<a name="276379975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379975">(Mar 23 2022 at 18:30)</a>:</h4>
<p>(clearly we need to ship postfix macros so we can experiment with this)</p>



<a name="276379988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276379988">(Mar 23 2022 at 18:30)</a>:</h4>
<p>here's the thing</p>



<a name="276380006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380006">(Mar 23 2022 at 18:30)</a>:</h4>
<p>this is <em>not as good</em> as the design we have, in my opinion</p>



<a name="276380012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380012">(Mar 23 2022 at 18:30)</a>:</h4>
<p>because :</p>



<a name="276380021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380021">(Mar 23 2022 at 18:30)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">count</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">AsyncIterator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276380033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380033">(Mar 23 2022 at 18:30)</a>:</h4>
<p>that function doesn't want to have to decide the strategy</p>



<a name="276380044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380044">(Mar 23 2022 at 18:30)</a>:</h4>
<p>I want people to be able to write libraries</p>



<a name="276380052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380052">(Mar 23 2022 at 18:31)</a>:</h4>
<p>that can be used by clients with different requirements</p>



<a name="276380075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380075">(Mar 23 2022 at 18:31)</a>:</h4>
<p>if the "easy way" to make code work</p>



<a name="276380085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380085">(Mar 23 2022 at 18:31)</a>:</h4>
<p>is that I write <code>foo.next().box.await</code></p>



<a name="276380100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380100">(Mar 23 2022 at 18:31)</a>:</h4>
<p>people will do that, but they are now hardcoding a strategy</p>



<a name="276380103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380103">(Mar 23 2022 at 18:31)</a>:</h4>
<p>and they shouldn't have</p>



<a name="276380117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380117">(Mar 23 2022 at 18:31)</a>:</h4>
<p>I think I have a better answer to that.</p>



<a name="276380142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380142">(Mar 23 2022 at 18:31)</a>:</h4>
<p>here's the <em>other</em> thing</p>



<a name="276380155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380155">(Mar 23 2022 at 18:31)</a>:</h4>
<p>we can transition to that :)</p>



<a name="276380165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380165">(Mar 23 2022 at 18:31)</a>:</h4>
<p>Also, I think "I want people to be able to write libraries that can be used by clients with different requirements" is a requirement I agree much more with than the one written in the current doc.</p>



<a name="276380168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380168">(Mar 23 2022 at 18:31)</a>:</h4>
<p>(but we covered that)</p>



<a name="276380180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380180">(Mar 23 2022 at 18:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380165">said</a>:</p>
<blockquote>
<p>Also, I think "I want people to be able to write libraries that can be used by clients with different requirements" is a requirement I agree much more with than the one written in the current doc.</p>
</blockquote>
<p>that is in the doc</p>



<a name="276380231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380231">(Mar 23 2022 at 18:32)</a>:</h4>
<p>it's called "Separation of concerns"</p>



<a name="276380235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380235">(Mar 23 2022 at 18:32)</a>:</h4>
<p>I saw the requirement for "don't hardcode box".</p>



<a name="276380306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380306">(Mar 23 2022 at 18:32)</a>:</h4>
<blockquote>
<p>It is important that:</p>
<ul>
<li>a library L can write natural-looking traits, impls, and functions that take <code>dyn Trait</code> values;</li>
<li>the library L can be used by a std project with zero annotation overhead;</li>
<li>and the library L can then be used as a dependency by a no-std project with some effort (to specify the alternative memory allocation strategy they want).</li>
</ul>
<p>Put another way, the code with the most information about its requirements should be making the decisions for how things work at runtime.</p>
</blockquote>



<a name="276380314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380314">(Mar 23 2022 at 18:32)</a>:</h4>
<p>seems like it can be phrased more clearly!</p>



<a name="276380317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380317">(Mar 23 2022 at 18:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380231">said</a>:</p>
<blockquote>
<p>it's called "Separation of concerns"</p>
</blockquote>
<p>Ah, sorry, I missed how that covers this; thank you.</p>



<a name="276380372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380372">(Mar 23 2022 at 18:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380314">said</a>:</p>
<blockquote>
<p>seems like it can be phrased more clearly!</p>
</blockquote>
<p>Possibly, but if I'd thought of that text I would have considered it to apply, it just didn't feel indexed by this issue.</p>



<a name="276380396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380396">(Mar 23 2022 at 18:33)</a>:</h4>
<p>(basically I want you to be able to write a library that uses traits + impls + dyn in the obvious way, and then be able to <em>reuse</em> that from any environment, at least a lot of the time)</p>



<a name="276380418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380418">(Mar 23 2022 at 18:33)</a>:</h4>
<p>I want that too!</p>



<a name="276380459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380459">(Mar 23 2022 at 18:34)</a>:</h4>
<p>So, a bit of handwaving I've had pending for a bit:</p>



<a name="276380542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380542">(Mar 23 2022 at 18:34)</a>:</h4>
<p>go for it :)</p>



<a name="276380566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380566">(Mar 23 2022 at 18:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276379870">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> So, I think the async fixed-size structs case is actually illuminating here.</p>
</blockquote>
<p>Expanding on this: if you have a function to call with an unsized return value, you can <em>either</em> box it and then your future is sized, or you can <em>not</em> box it and your future is unsized.</p>



<a name="276380606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380606">(Mar 23 2022 at 18:34)</a>:</h4>
<p>Or in other words, like many things (e.g. Result), you can either handle something or make it your caller's problem.</p>



<a name="276380633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380633">(Mar 23 2022 at 18:35)</a>:</h4>
<p>And if you want to write a library that works for many callers, you make it your caller's problem.</p>



<a name="276380665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380665">(Mar 23 2022 at 18:35)</a>:</h4>
<p>what is the interface to your caller</p>



<a name="276380674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380674">(Mar 23 2022 at 18:35)</a>:</h4>
<p>who decides how much space to allocate for your return value?</p>



<a name="276380686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380686">(Mar 23 2022 at 18:35)</a>:</h4>
<p>is it known before you are invoked, or not</p>



<a name="276380692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380692">(Mar 23 2022 at 18:35)</a>:</h4>
<p>that's kind of the question I'm getting at</p>



<a name="276380715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380715">(Mar 23 2022 at 18:35)</a>:</h4>
<p>I think the design you are sketching requires that it might not be known</p>



<a name="276380729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380729">(Mar 23 2022 at 18:35)</a>:</h4>
<p>since you don't necessarily know which <code>dyn</code> you are invoking, for example</p>



<a name="276380739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380739">(Mar 23 2022 at 18:35)</a>:</h4>
<blockquote>
<p>Expanding on this: if you have a function to call with an unsized return value, you can either box it and then your future is sized, or you can not box it and your future is unsized.</p>
</blockquote>
<p>There's some snags, depending on how the return value is got</p>



<a name="276380855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380855">(Mar 23 2022 at 18:36)</a>:</h4>
<p>and I think if the callee has to allocate a "not known up front" amount of stack space-- well, that's not a stack (by definition)</p>



<a name="276380867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380867">(Mar 23 2022 at 18:36)</a>:</h4>
<p>Or that it may require a bit of work to know it; depends on how much we want to know at compile time vs runtime. Or that some cases will work and others won't, or that the compiler calls <code>max(vtable1.value, vtable2.value)</code>.</p>



<a name="276380886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380886">(Mar 23 2022 at 18:36)</a>:</h4>
<p>That last one is the easiest.</p>



<a name="276380899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380899">(Mar 23 2022 at 18:36)</a>:</h4>
<p>that last one doesn't really work</p>



<a name="276380918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380918">(Mar 23 2022 at 18:36)</a>:</h4>
<p>you could have a <code>Vec&lt;Box&lt;dyn AsyncIterator&gt;&gt;</code></p>



<a name="276380922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380922">(Mar 23 2022 at 18:37)</a>:</h4>
<p>(for example)</p>



<a name="276380939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380939">(Mar 23 2022 at 18:37)</a>:</h4>
<p>and you are calling <code>vec[some_index].next().await</code></p>



<a name="276380951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276380951">(Mar 23 2022 at 18:37)</a>:</h4>
<p>are we going to iterate over the whole vector...automatically...</p>



<a name="276381002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381002">(Mar 23 2022 at 18:37)</a>:</h4>
<p>I am wondering</p>



<a name="276381006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381006">(Mar 23 2022 at 18:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380918">said</a>:</p>
<blockquote>
<p>you could have a <code>Vec&lt;Box&lt;dyn AsyncIterator&gt;&gt;</code></p>
</blockquote>
<p>That's a really good example, thank you; OK, we can't compute <em>that</em> at compile time.</p>



<a name="276381023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381023">(Mar 23 2022 at 18:37)</a>:</h4>
<p>I am wondering</p>



<a name="276381033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381033">(Mar 23 2022 at 18:37)</a>:</h4>
<p>(at least, not without more complex types that put bounds on things, which, maybe not)</p>



<a name="276381043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381043">(Mar 23 2022 at 18:37)</a>:</h4>
<p>the point in our design where the decision to made to box is the coercion to dyn</p>



<a name="276381099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381099">(Mar 23 2022 at 18:38)</a>:</h4>
<p>I agree with <span class="user-mention" data-user-id="116883">@tmandry</span>'s argument that this is the <em>right</em> point</p>



<a name="276381116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381116">(Mar 23 2022 at 18:38)</a>:</h4>
<p>or at least a better point than the individual call site</p>



<a name="276381119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381119">(Mar 23 2022 at 18:38)</a>:</h4>
<p>it's not like there's any one right answer here</p>



<a name="276381142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381142">(Mar 23 2022 at 18:38)</a>:</h4>
<p>but it gives better separation of concerns, and it's often the point with the most information</p>



<a name="276381153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381153">(Mar 23 2022 at 18:38)</a>:</h4>
<p>and you can use generics to control it to some extent</p>



<a name="276381164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381164">(Mar 23 2022 at 18:38)</a>:</h4>
<p>it seems plausible to have a box keyword <em>there</em> somehow</p>



<a name="276381182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381182">(Mar 23 2022 at 18:38)</a>:</h4>
<p>I'm not saying I <em>like</em> it :)</p>



<a name="276381201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381201">(Mar 23 2022 at 18:39)</a>:</h4>
<p>I'm not saying I like it yet either, but: what would that look like, vaguely?</p>



<a name="276381205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381205">(Mar 23 2022 at 18:39)</a>:</h4>
<p>but it's not something we've explored or discussed very much</p>



<a name="276381224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381224">(Mar 23 2022 at 18:39)</a>:</h4>
<p>I mean in our example you wrote <code>count(&amp;mut my_iter)</code></p>



<a name="276381245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381245">(Mar 23 2022 at 18:39)</a>:</h4>
<blockquote>
<p>Or that it may require a bit of work to know it; depends on how much we want to know at compile time vs runtime. Or that some cases will work and others won't, or that the compiler calls max(vtable1.value, vtable2.value).</p>
</blockquote>
<p>If you do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">call_dyn</span><span class="p">(</span><span class="n">my_fn</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Display</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">dyn</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">my_fn</span><span class="p">)()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the function can "guess" ahead of time hom much space you will need to allocate for the return value.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">call_dyn</span><span class="p">(</span><span class="n">my_fns</span>: <span class="p">[</span><span class="o">&amp;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Display</span><span class="p">;</span><span class="w"> </span><span class="mi">100</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">dyn</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">my_fn</span><span class="p">[</span><span class="n">random_number</span><span class="p">()])()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>it gets a lot more complicated</p>



<a name="276381246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381246">(Mar 23 2022 at 18:39)</a>:</h4>
<p>if we just always required an adapter</p>



<a name="276381251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381251">(Mar 23 2022 at 18:39)</a>:</h4>
<p>which I definitely don't love :)</p>



<a name="276381255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381255">(Mar 23 2022 at 18:39)</a>:</h4>
<p>it would be</p>



<a name="276381270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381270">(Mar 23 2022 at 18:39)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">BoxingIter</span>::<span class="n">new</span><span class="p">(</span><span class="n">my_iter</span><span class="p">))</span><span class="w"></span>
</code></pre></div>



<a name="276381311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381311">(Mar 23 2022 at 18:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381245">said</a>:</p>
<blockquote>
<p>it gets a lot more complicated</p>
</blockquote>
<p>yep...</p>



<a name="276381367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381367">(Mar 23 2022 at 18:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381246">said</a>:</p>
<blockquote>
<p>if we just always required an adapter</p>
</blockquote>
<p>Ah, right. I did think about that possibility when you pointed out that it wasn't just <code>Box::new</code>. Having it <em>always</em> be <code>dyner::SomeAdapter</code> even for the box case would be an <em>improvement</em>. I do think it could be more elegant than that, but I would consider that an improvement.</p>



<a name="276381372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381372">(Mar 23 2022 at 18:40)</a>:</h4>
<p>gotta be some way to reduce that to the halting prioblem :)</p>



<a name="276381474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381474">(Mar 23 2022 at 18:40)</a>:</h4>
<p><span class="user-mention" data-user-id="263609">@Olivier FAURE</span> I do want to know if you agreed with my summary of why alloca doesn't work etc? I am hoping I understood what it is you're proposing completely</p>



<a name="276381519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381519">(Mar 23 2022 at 18:41)</a>:</h4>
<blockquote>
<p>gotta be some way to reduce that to the halting prioblem :)</p>
</blockquote>
<p>No, I don't think it's undecidable. But it is "we don't ship this year" complicated.</p>



<a name="276381560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381560">(Mar 23 2022 at 18:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380855">said</a>:</p>
<blockquote>
<p>and I think if the callee has to allocate a "not known up front" amount of stack space-- well, that's not a stack (by definition)</p>
</blockquote>
<p>put the unknown thing at the top of the stack and communicates the size to the caller which can then fix its stack pointer or move things around?</p>



<a name="276381578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381578">(Mar 23 2022 at 18:41)</a>:</h4>
<p>(FWIW I acknowledge that the designs I'm handwaving, assuming they're workable, are also likely to be "don't ship this year" complicated unless we have some <em>very</em> motivated people working on it.)</p>



<a name="276381636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381636">(Mar 23 2022 at 18:42)</a>:</h4>
<blockquote>
<p>I do want to know if you agreed with my summary of why alloca doesn't work etc?</p>
</blockquote>
<p>Sure. That was kinda my starting point</p>



<a name="276381662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381662">(Mar 23 2022 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381519">said</a>:</p>
<blockquote>
<p>No, I don't think it's undecidable. But it is "we don't ship this year" complicated.</p>
</blockquote>
<p>... it's undecidable to do perfectly, obviously ...</p>



<a name="276381671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381671">(Mar 23 2022 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381560">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380855">said</a>:</p>
<blockquote>
<p>and I think if the callee has to allocate a "not known up front" amount of stack space-- well, that's not a stack (by definition)</p>
</blockquote>
<p>put the unknown thing at the top of the stack and communicates the size to the caller which can then fix its stack pointer or move things around?</p>
</blockquote>
<p>That's one of several possibilities I had vaguely in my head when saying in the meeting that the ABI isn't that hard.</p>



<a name="276381700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381700">(Mar 23 2022 at 18:42)</a>:</h4>
<p>that's not really a stack</p>



<a name="276381711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381711">(Mar 23 2022 at 18:42)</a>:</h4>
<p>it's plausible</p>



<a name="276381715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381715">(Mar 23 2022 at 18:42)</a>:</h4>
<blockquote>
<p>put the unknown thing at the top of the stack and communicates the size to the caller which can then fix its stack pointer or move things around?</p>
</blockquote>
<p>That works until you have TWO unknown things</p>



<a name="276381723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381723">(Mar 23 2022 at 18:42)</a>:</h4>
<p>you'll have intermediate values you have to shuffle around</p>



<a name="276381759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381759">(Mar 23 2022 at 18:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381671">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381560">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276380855">said</a>:</p>
<blockquote>
<p>and I think if the callee has to allocate a "not known up front" amount of stack space-- well, that's not a stack (by definition)</p>
</blockquote>
<p>put the unknown thing at the top of the stack and communicates the size to the caller which can then fix its stack pointer or move things around?</p>
</blockquote>
<p>That's one of several possibilities I had vaguely in my head when saying in the meeting that the ABI isn't that hard.</p>
</blockquote>
<p>One issue with that as well, though: it's the same as the "box whether the caller wants it or not" problem but in reverse: it's "don't box whether the caller wants it or not".</p>



<a name="276381805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381805">(Mar 23 2022 at 18:43)</a>:</h4>
<p>You'd have to copy piles of memory into a box if you wanted to box it.</p>



<a name="276381810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381810">(Mar 23 2022 at 18:43)</a>:</h4>
<p>like, right now you have arguments there, you need to compute (dynamically since you don't know statically) how much space you need to displace</p>



<a name="276381818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381818">(Mar 23 2022 at 18:43)</a>:</h4>
<p>do some shifts</p>



<a name="276381820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381820">(Mar 23 2022 at 18:43)</a>:</h4>
<p>etc</p>



<a name="276381827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381827">(Mar 23 2022 at 18:43)</a>:</h4>
<p>it's not <em>impossible</em> but it's not <em>easy</em></p>



<a name="276381869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381869">(Mar 23 2022 at 18:43)</a>:</h4>
<p>(also what josh wrote)</p>



<a name="276381928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381928">(Mar 23 2022 at 18:44)</a>:</h4>
<p>all of this makes me feel that it's the coercion point that is the key decider</p>



<a name="276381942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381942">(Mar 23 2022 at 18:44)</a>:</h4>
<p><code>-&gt; impl Fn(impl Fn(ThingIWantToReturn) -&gt; T) -&gt; T</code></p>



<a name="276381959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381959">(Mar 23 2022 at 18:44)</a>:</h4>
<p>it woudl be useful, josh, to have some example of the kind of code you are thinking of</p>



<a name="276381967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381967">(Mar 23 2022 at 18:44)</a>:</h4>
<p>e.g. some code that might plausibly use dyn</p>



<a name="276381977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381977">(Mar 23 2022 at 18:44)</a>:</h4>
<p>maybe there's code in the kernel that does? etc</p>



<a name="276381993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381993">(Mar 23 2022 at 18:44)</a>:</h4>
<p>that we could try to hypothesize "what if these were async fns"</p>



<a name="276381997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276381997">(Mar 23 2022 at 18:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381715">said</a>:</p>
<blockquote>
<blockquote>
<p>put the unknown thing at the top of the stack and communicates the size to the caller which can then fix its stack pointer or move things around?</p>
</blockquote>
<p>That works until you have TWO unknown things</p>
</blockquote>
<p>Then you need to communicate two sizes to the caller, doesn't seem impossible.</p>



<a name="276382007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382007">(Mar 23 2022 at 18:44)</a>:</h4>
<p>and see the patterns</p>



<a name="276382067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382067">(Mar 23 2022 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381474">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> I do want to know if you agreed with my summary of why alloca doesn't work etc? I am hoping I understood what it is you're proposing completely</p>
</blockquote>
<p>Basically, my big question was "Do we really, <em>really</em> want code to be able to call functions that take <code>&amp;mut dyn AsyncIterator</code> to compile transparently in no_alloc environment?"</p>



<a name="276382092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382092">(Mar 23 2022 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381997">said</a>:</p>
<blockquote>
<p>Then you need to communicate two sizes to the caller, doesn't seem impossible.</p>
</blockquote>
<p>the thing about these designs: it's not that their  not <em>possible</em> (although I'm not sure they are), it's that they're also violating constraints, that our codegen is predictable and efficient. things are getting awfully complex.</p>



<a name="276382109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382109">(Mar 23 2022 at 18:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276381959">said</a>:</p>
<blockquote>
<p>it woudl be useful, josh, to have some example of the kind of code you are thinking of</p>
</blockquote>
<p>I'm not <em>objecting</em> to the ask for specificity, but I do want to observe that I think that's a different ask in the case of the specific problem of RPITIDT than it is for the general requirement of "don't hide allocations in compiler-generated code".</p>



<a name="276382113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382113">(Mar 23 2022 at 18:45)</a>:</h4>
<p>As opposed to "function that take <code>&amp;mut impl AsyncIterator</code>"</p>



<a name="276382245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382245">(Mar 23 2022 at 18:46)</a>:</h4>
<p>The underlying requirement I'm trying to satisfy with "don't hide allocations in compiler-generated code" is very much steeped in "what is it I feel like Rust does much better than any other non-C language, that makes it a credible C replacement".</p>



<a name="276382273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382273">(Mar 23 2022 at 18:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382109">said</a>:</p>
<blockquote>
<p>I'm not <em>objecting</em> to the ask for specificity, but I do want to observe that I think that's a different ask in the case of the specific problem of RPITIDT than it is for the general requirement of "don't hide allocations in compiler-generated code".</p>
</blockquote>
<p>my intent here is not to be like "See, you can't show me anything!", it's more to be able to see whether they fit the patterns I have in my head around how dyn is likely to be used in these sorts of contexts</p>



<a name="276382305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382305">(Mar 23 2022 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382273">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382109">said</a>:</p>
<blockquote>
<p>I'm not <em>objecting</em> to the ask for specificity, but I do want to observe that I think that's a different ask in the case of the specific problem of RPITIDT than it is for the general requirement of "don't hide allocations in compiler-generated code".</p>
</blockquote>
<p>my intent here is not to be like "See, you can't show me anything!", it's more to be able to see whether they fit the patterns I have in my head around how dyn is likely to be used in these sorts of contexts</p>
</blockquote>
<p>Genuine appreciation for your clarification here, thank you.</p>



<a name="276382307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382307">(Mar 23 2022 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382113">said</a>:</p>
<blockquote>
<p>As opposed to "function that take <code>&amp;mut impl AsyncIterator</code>"</p>
</blockquote>
<p>I do think that's important, but I agree that embedded folks use dyn in relatively narrow and limited ways</p>



<a name="276382331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382331">(Mar 23 2022 at 18:47)</a>:</h4>
<p>but they like to control code size like everybody else :)</p>



<a name="276382389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382389">(Mar 23 2022 at 18:47)</a>:</h4>
<blockquote>
<p>I do think that's important, but I agree that embedded folks use dyn in relatively narrow and limited ways</p>
</blockquote>
<p>Right. So my question is: if we fix the "dyn" use-case, would unsized returns become interesting?</p>



<a name="276382447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382447">(Mar 23 2022 at 18:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> While I wasn't ascribing it to you in particular, I definitely have a strong association between "please spell out your exact use case" and "see, I can poke a hole in your exact use case therefore the general concept you're trying to express is invalid".</p>



<a name="276382465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382465">(Mar 23 2022 at 18:48)</a>:</h4>
<p>well, I still don't want users to have to write <code>foo.bar().box.await</code></p>



<a name="276382501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382501">(Mar 23 2022 at 18:48)</a>:</h4>
<blockquote>
<p>"see, I can poke a hole in your exact use case therefore the general concept you're trying to express is invalid".</p>
</blockquote>
<p>I feel like that's a valid way to express disagreements, if done in good faith? (the "I can poke a hole" part, I mean)</p>



<a name="276382502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382502">(Mar 23 2022 at 18:48)</a>:</h4>
<p>this comes back to "learning curve is rust's primary obstacle"</p>



<a name="276382533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382533">(Mar 23 2022 at 18:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382465">said</a>:</p>
<blockquote>
<p>well, I still don't want users to have to write <code>foo.bar().box.await</code></p>
</blockquote>
<p>I would be pretty happy if <em>either</em> they did xor their caller did.</p>



<a name="276382570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382570">(Mar 23 2022 at 18:49)</a>:</h4>
<p>that's the other thing -- it seems wrong</p>



<a name="276382577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382577">(Mar 23 2022 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382501">said</a>:</p>
<blockquote>
<blockquote>
<p>"see, I can poke a hole in your exact use case therefore the general concept you're trying to express is invalid".</p>
</blockquote>
<p>I feel like that's a valid way to express disagreements, if done in good faith?</p>
</blockquote>
<p>Not if you're asking someone to turn a general requirement into a specific example; that's a requirement that the specific example capture absolutely everything important about the general requirement.</p>



<a name="276382586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382586">(Mar 23 2022 at 18:49)</a>:</h4>
<p>not just because of the caller</p>



<a name="276382600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382600">(Mar 23 2022 at 18:49)</a>:</h4>
<p>but because it leaves us a lot less room to optimize</p>



<a name="276382617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382617">(Mar 23 2022 at 18:49)</a>:</h4>
<p>I'd like to be able to (if we thought it useful) modify that default strategy</p>



<a name="276382629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382629">(Mar 23 2022 at 18:49)</a>:</h4>
<p>and if we force people to spell it out... that'll be harder</p>



<a name="276382669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382669">(Mar 23 2022 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382502">said</a>:</p>
<blockquote>
<p>this comes back to "learning curve is rust's primary obstacle"</p>
</blockquote>
<p>I'm <em>not</em> saying we're doing this here, but I am very cautious about an end result of "OK, now we have a language that's easier to learn that no longer is a C replacement; so where's the new language that's harder to learn but is still a C replacement".</p>



<a name="276382673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382673">(Mar 23 2022 at 18:49)</a>:</h4>
<p>I'm trying to think how to summarize this debate</p>



<a name="276382745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382745">(Mar 23 2022 at 18:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382669">said</a>:</p>
<blockquote>
<p>I'm <em>not</em> saying we're doing this here, but I am very cautious about an end result of "OK, now we have a language that's easier to learn that no longer is a C replacement; so where's the new language that's harder to learn but is still a C replacement".</p>
</blockquote>
<p>yes, and i'm glad you're keeping me honest :)</p>



<a name="276382760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382760">(Mar 23 2022 at 18:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I suspect that you and I agree on two or more tenets here but are sorting them in different orders. :)</p>



<a name="276382775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382775">(Mar 23 2022 at 18:50)</a>:</h4>
<p>I just don't think that this is crossing that bridge, or even close it</p>



<a name="276382795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382795">(Mar 23 2022 at 18:50)</a>:</h4>
<p>....yes, which makes it fun...</p>



<a name="276382834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382834">(Mar 23 2022 at 18:51)</a>:</h4>
<p>I have to go, but I think the next step is to try to summarize some what the ideas that were tossed out in this thread overall</p>



<a name="276382855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382855">(Mar 23 2022 at 18:51)</a>:</h4>
<p>and spell out what they would look like, advantages and disadvantages, in more depth</p>



<a name="276382899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382899">(Mar 23 2022 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382775">said</a>:</p>
<blockquote>
<p>I just don't think that this is crossing that bridge, or even close it</p>
</blockquote>
<p>Digging a little deeper here, I feel like there's a set of things that's acceptable for the compiler to hide, and a set of things that isn't, and those things share common properties, and I put "allocation" in the latter set based on those properties.</p>



<a name="276382932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382932">(Mar 23 2022 at 18:52)</a>:</h4>
<p>yeah, I just don't see it as that black and white</p>



<a name="276382949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382949">(Mar 23 2022 at 18:52)</a>:</h4>
<p>I need to figure out a better description of those properties than "things that make C programmers cry".</p>



<a name="276382989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276382989">(Mar 23 2022 at 18:52)</a>:</h4>
<p>I think it very much depends on what you are doing and there won't be one answer</p>



<a name="276383003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383003">(Mar 23 2022 at 18:52)</a>:</h4>
<p>but most every C program I ever wrote called <code>malloc</code> an awful lot</p>



<a name="276383055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383055">(Mar 23 2022 at 18:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382932">said</a>:</p>
<blockquote>
<p>yeah, I just don't see it as that black and white</p>
</blockquote>
<p>Interesting! I I think I had an implicit expectation that you <em>did</em> have that same distinction and just put "allocation" into the former set. But if I'd thought about and questioned that assumption, it makes more sense that you don't have that distinction as a hard line.</p>



<a name="276383056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383056">(Mar 23 2022 at 18:53)</a>:</h4>
<p>I tend more towards: we should make it easier for people to identify what they care about</p>



<a name="276383071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383071">(Mar 23 2022 at 18:53)</a>:</h4>
<p>and define a kind of "common set of things" that most folks care about</p>



<a name="276383074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383074">(Mar 23 2022 at 18:53)</a>:</h4>
<p>kind of like portability etc</p>



<a name="276383097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383097">(Mar 23 2022 at 18:53)</a>:</h4>
<p>Well, chained <code>.box</code> is a lot more ergonomic than a separate <code>malloc()</code> line.</p>



<a name="276383115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383115">(Mar 23 2022 at 18:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382307">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276382113">said</a>:</p>
<blockquote>
<p>As opposed to "function that take <code>&amp;mut impl AsyncIterator</code>"</p>
</blockquote>
<p>I do think that's important, but I agree that embedded folks use dyn in relatively narrow and limited ways</p>
</blockquote>
<p>My point is we could ask developers who want their async code to be maximally portable to write</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">count</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">AsyncIterator</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And also add a special <code>InlineDynAsyncIterator</code> type (one that only works for <code>&amp;mut dyn AsyncIterator</code> and therefore doesn't need the whole dynx machinery).</p>
<p>Embedded developers who want no allocation and also limited code size then do:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">invoke_count</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">AsyncIterator</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">count</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">InlineDynAsyncIterator</span>::<span class="n">new</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>All of this can be done with existing concepts.</p>



<a name="276383132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383132">(Mar 23 2022 at 18:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383056">said</a>:</p>
<blockquote>
<p>I tend more towards: we should make it easier for people to identify what they care about</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383071">said</a>:</p>
<blockquote>
<p>and define a kind of "common set of things" that most folks care about</p>
</blockquote>
<p>I do agree with that principle in general. But my "common set of things" isn't based on "what's the most popular", it's based on "what can Rust do and where can Rust go, that we don't want to lose".</p>



<a name="276383167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383167">(Mar 23 2022 at 18:53)</a>:</h4>
<p>It could even be <code>.box?</code> or something to let the compiler decide?</p>



<a name="276383170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383170">(Mar 23 2022 at 18:53)</a>:</h4>
<p>you might be losing things on the other side :)</p>



<a name="276383246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383246">(Mar 23 2022 at 18:54)</a>:</h4>
<p>/me contemplates overloading edition for this ...</p>



<a name="276383290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383290">(Mar 23 2022 at 18:54)</a>:</h4>
<p>side note that I do like the idea of <code>edition = "2024-core"</code> or something instead of <code>#![no_std]</code></p>



<a name="276383312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383312">(Mar 23 2022 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383170">said</a>:</p>
<blockquote>
<p>you might be losing things on the other side :)</p>
</blockquote>
<p>Acknowledged, and if I <em>have</em> to make that trade I'll make it in favor of "things Rust does that nothing else except C can" rather than "things Go and Python and a hundred other languages can do".</p>



<a name="276383342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383342">(Mar 23 2022 at 18:55)</a>:</h4>
<p>I guess my feeling is that you are not losing</p>



<a name="276383352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383352">(Mar 23 2022 at 18:55)</a>:</h4>
<p>because people who have more extreme requirements are ok with saying so</p>



<a name="276383367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383367">(Mar 23 2022 at 18:55)</a>:</h4>
<p>as long as it's easy to do</p>



<a name="276383410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383410">(Mar 23 2022 at 18:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383352">said</a>:</p>
<blockquote>
<p>because people who have more extreme requirements are ok with saying so</p>
</blockquote>
<p>Request: please don't consider "doing systems programming with Rust" to be "extreme requirements".</p>



<a name="276383432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383432">(Mar 23 2022 at 18:55)</a>:</h4>
<p>maybe it's worth spelling out what an "allocation lint" (or even effect system) might really look like</p>



<a name="276383488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383488">(Mar 23 2022 at 18:56)</a>:</h4>
<p>systems programming is a pretty broad brush</p>



<a name="276383504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383504">(Mar 23 2022 at 18:56)</a>:</h4>
<p>I realize, and I used the broad brush intentionally.</p>



<a name="276383551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383551">(Mar 23 2022 at 18:56)</a>:</h4>
<p>Is there a less judgmental word to "extreme" you'd prefer?</p>



<a name="276383566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383566">(Mar 23 2022 at 18:56)</a>:</h4>
<p>I didn't intend it to sound judgmental</p>



<a name="276383596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383596">(Mar 23 2022 at 18:57)</a>:</h4>
<p>what I did intend was to say that -- the more you care, the less you mind saying so (I believe)</p>



<a name="276383623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383623">(Mar 23 2022 at 18:57)</a>:</h4>
<p>I didn't take it as judgmental, it's more that I'm disagreeing with your characterization that it's non-central.</p>



<a name="276383653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383653">(Mar 23 2022 at 18:57)</a>:</h4>
<p>To me, a <em>defining</em> property of Rust is that it never gives that "I'm not in control here, the language is" feeling.</p>



<a name="276383654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383654">(Mar 23 2022 at 18:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383432">said</a>:</p>
<blockquote>
<p>maybe it's worth spelling out what an "allocation lint" (or even effect system) might really look like</p>
</blockquote>
<p>Probably something close to <a href="https://rust-lang.github.io/rust-clippy/master/#panic">the panic lint</a>?</p>



<a name="276383693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383693">(Mar 23 2022 at 18:57)</a>:</h4>
<p>When I'm writing Python, I feel like it'll do whatever it wants as long as it gives me an answer; if I want control I don't write Python.</p>



<a name="276383698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383698">(Mar 23 2022 at 18:57)</a>:</h4>
<p>OK. I think systems programming encompasses a wide variety of things, some of which care deeply about allocaitons, many of which don't -- and of course sometimes it's at a finer granularity than that (this function or module does...)</p>



<a name="276383803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383803">(Mar 23 2022 at 18:58)</a>:</h4>
<p>I think I'm suggesting (and I agree "systems programming" may be the wrong term for the "C refugees" use case I have here) that I'm thinking about the set of users who feel comfortable because Rust keeps them in control.</p>



<a name="276383831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383831">(Mar 23 2022 at 18:58)</a>:</h4>
<p>And who <em>no longer feel in control</em> if something as important as allocation is added in compiler-generated code.</p>



<a name="276383873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276383873">(Mar 23 2022 at 18:58)</a>:</h4>
<p>That requirement is, quite literally, how I got here and in the top three reasons why I'm here, behind "the community is wonderful and caring and welcoming".</p>



<a name="276384131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384131">(Mar 23 2022 at 19:00)</a>:</h4>
<p>That set of people is a <em>superset</em> of the people who actually <em>will</em> have something go horribly wrong in their code if an allocation happens behind their back.</p>



<a name="276384170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384170">(Mar 23 2022 at 19:00)</a>:</h4>
<p>Though in practice I do think that it's a set of people who feel something <em>may</em> go horribly wrong if an allocation happens behind their back.</p>



<a name="276384228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384228">(Mar 23 2022 at 19:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="263609">Olivier FAURE</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383654">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276383432">said</a>:</p>
<blockquote>
<p>maybe it's worth spelling out what an "allocation lint" (or even effect system) might really look like</p>
</blockquote>
<p>Probably something close to <a href="https://rust-lang.github.io/rust-clippy/master/#panic">the panic lint</a>?</p>
</blockquote>
<p>Probably, and for many of the same reasons.</p>



<a name="276384266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384266">(Mar 23 2022 at 19:01)</a>:</h4>
<p>To say it a slightly different way, which I think is a real feeling many people have:</p>



<a name="276384377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384377">(Mar 23 2022 at 19:02)</a>:</h4>
<p>I agree that people with those requirements can say they have those requirements. The declaration that they have those requirements is <code>.rs</code>.</p>



<a name="276384436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384436">(Mar 23 2022 at 19:03)</a>:</h4>
<p>If they have to say it more explicitly, <code>.rs</code> loses something, and many of them go back to saying they have those requirements by writing <code>.c</code>.</p>



<a name="276384527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384527">(Mar 23 2022 at 19:03)</a>:</h4>
<p>hm, does this area have any overlap with placement-new? it feels like having a first-class concept of a place, and letting the caller decide what that place is</p>



<a name="276384537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384537">(Mar 23 2022 at 19:03)</a>:</h4>
<p>allocation would also mean this isn't async-signal-safe</p>



<a name="276384708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384708">(Mar 23 2022 at 19:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384537">said</a>:</p>
<blockquote>
<p>allocation would also mean this isn't async-signal-safe</p>
</blockquote>
<p>That's one of many good examples, yeah. Right now, you have to be careful what syscalls or library functions you call, but you don't have to be careful what bits of the <em>language</em> you use.</p>



<a name="276384740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384740">(Mar 23 2022 at 19:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384527">said</a>:</p>
<blockquote>
<p>hm, does this area have any overlap with placement-new? it feels like having a first-class concept of a place, and letting the caller decide what that place is</p>
</blockquote>
<p>FWIW placement new was one of the use-cases of <a href="https://github.com/rust-lang/rfcs/pull/2884">RFC 2884</a></p>



<a name="276384966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276384966">(Mar 23 2022 at 19:06)</a>:</h4>
<p><span class="user-mention" data-user-id="263609">@Olivier FAURE</span> Oooh, interesting. I haven't read RFC 2884, but the motivation and summary certainly <em>sound</em> relevant here.</p>



<a name="276385052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276385052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276385052">(Mar 23 2022 at 19:07)</a>:</h4>
<p>... No, no, it's fine, I've only been mentioning it in every discussion of async traits for the last six months... :P</p>



<a name="276385117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276385117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Olivier FAURE <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276385117">(Mar 23 2022 at 19:07)</a>:</h4>
<p>(well, to be fair, mostly discussions on IRLO, not on zulip)</p>



<a name="276407644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276407644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276407644">(Mar 23 2022 at 22:09)</a>:</h4>
<p>note to self: </p>
<p>The reason that you can't have a "required adapter" to convert <code>T</code> to a <code>dyn AsyncIterator</code>, at least not without further changes, is that code like this compiles today:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">u</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In other words, we assume that any <code>T: Trait</code> can be converted to a <code>dyn Trait</code>. We'd have to add some kind of concept for making that conditional.</p>



<a name="276407949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276407949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276407949">(Mar 23 2022 at 22:11)</a>:</h4>
<p>In theory, we could make that conditional only in the case of a <code>dyn</code> trait where the trait has methods returning <code>impl Trait</code>, right?</p>



<a name="276408064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276408064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276408064">(Mar 23 2022 at 22:12)</a>:</h4>
<p>(As in, that code would work fine, and we'd only have to block "transparent" <code>dyn</code>-to-<code>impl</code> conversion if the trait has <code>impl Trait</code> return values?)</p>



<a name="276430659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276430659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276430659">(Mar 24 2022 at 04:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276384377">said</a>:</p>
<blockquote>
<p>I agree that people with those requirements can say they have those requirements. The declaration that they have those requirements is <code>.rs</code>.</p>
</blockquote>
<p>I don't think Rust as a language treats all requirements around control of the final binary equally – even requirements for low-level systems programmers. As a real-world example, if my primary constraint is binary size, there's currently no way to see all the places my code is instantiating new monomorphizations that could dramatically increase that binary size.</p>
<p>The language made a decision long ago to make these instantiations silent, probably for good reason. But it's conceivable that tooling or language features could still help with this in the future.</p>



<a name="276430858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276430858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276430858">(Mar 24 2022 at 04:14)</a>:</h4>
<p>And I would guess that applications that <em>do</em> care deeply about auditing allocations probably have other concerns that vary greatly from one use case to the next.</p>



<a name="276431006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431006">(Mar 24 2022 at 04:18)</a>:</h4>
<p>I think what I'm saying is that I don't view it as realistic to say that <code>.rs</code> should automatically mean all of one group's concerns are met – either the language is tailored to very specific use cases at the expense of others, or we expect everyone to make some accommodation for their use case.</p>



<a name="276431021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431021">(Mar 24 2022 at 04:19)</a>:</h4>
<p>As an idea, for this matter I think the "accommodation" could take the form of <code>#![profile(explicit)]</code>, <code>#![profile(embedded)]</code> or similar, for example. You could imagine defining a few standard profiles like this and letting users define their own. That way the customization points are "bundled together" in a way that doesn't require much effort from the user (to use or describe).</p>



<a name="276431095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431095">(Mar 24 2022 at 04:20)</a>:</h4>
<p>I agree that code size expansion isn't one we have prohibited in compiler-generated code.</p>



<a name="276431106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431106">(Mar 24 2022 at 04:21)</a>:</h4>
<p>But that feels like it has a different character. I'm thinking more of things like making syscalls from compiler generated code.</p>



<a name="276431284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431284">(Mar 24 2022 at 04:24)</a>:</h4>
<p>I think both are things that bear on requirements for different (or sometimes the same) users, and working in a domain that cares more about one or the other could cause a person to feel differently about them. But I don't actually think they're all that different in character – in one scenario syscalls are a big deal; in another ~100 bytes of machine code are a big deal.</p>



<a name="276431308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431308">(Mar 24 2022 at 04:25)</a>:</h4>
<p>It's true that one is "binary" (and therefore easy to model with e.g. capabilities) and the other is more "continuous"</p>



<a name="276431323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431323">(Mar 24 2022 at 04:25)</a>:</h4>
<p>That does capture an important difference I think. None of the things I'm imagining that make people feel like they don't have control are on a sliding scale; they're all either true or false.</p>



<a name="276431390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431390">(Mar 24 2022 at 04:27)</a>:</h4>
<p>Still, you could even imagine modeling something like binary size with a static capability-like system, assigning budgets to different modules and so on</p>



<a name="276431491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276431491">(Mar 24 2022 at 04:30)</a>:</h4>
<p>C is a great "natural fit" for certain domains. I'd like Rust to be a great fit for those domains <em>and</em> for others, and am starting to believe that you need these kinds of customization knobs for that to happen. Define how square or round you want your peg to be, so to speak</p>



<a name="276482397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276482397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276482397">(Mar 24 2022 at 14:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/RPITIDT/near/276431323">said</a>:</p>
<blockquote>
<p>That does capture an important difference I think. None of the things I'm imagining that make people feel like they don't have control are on a sliding scale; they're all either true or false.</p>
</blockquote>
<p>I disagree with this -- allocation can be binary, but I think for a lot of users <em>a few allocations</em> are not a problem but a <em>lot of them</em> are</p>



<a name="276482444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276482444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276482444">(Mar 24 2022 at 14:23)</a>:</h4>
<p>also, thank you <span class="user-mention" data-user-id="116883">@tmandry</span>, you expressed very well my feeling :)</p>



<a name="276484158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276484158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276484158">(Mar 24 2022 at 14:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> If you're talking about performance or memory usage, sure. But in terms of the user feeling in control, one allocation hidden in compiler-generated code is too many.</p>



<a name="276503561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276503561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276503561">(Mar 24 2022 at 16:38)</a>:</h4>
<p>I'm arguing that this depends on the user and their needs.</p>



<a name="276503611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276503611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276503611">(Mar 24 2022 at 16:38)</a>:</h4>
<p>I think that, for some users, they feel out of control when the compiler is making them "jump through hoops" for something they don't care about.</p>



<a name="276503632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276503632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276503632">(Mar 24 2022 at 16:39)</a>:</h4>
<p>e.g., "I just want to call a function, why do I have to talk about box?"</p>



<a name="276506209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276506209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276506209">(Mar 24 2022 at 16:54)</a>:</h4>
<p>I think there's a meaningful difference between "too much control / too low-level" and "not enough control". I agree that both are unpleasant, though.<br>
I agree that we should strive to make Rust usable for both, but in the spirit of tenets, I think it's important that we order "don't lose the critical property and feeling of control that provides a primary advantage of Rust" above "let the user ignore or leave out considerations they don't care about".</p>



<a name="276506371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276506371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276506371">(Mar 24 2022 at 16:55)</a>:</h4>
<p>Defaults are really important, and there's a difference between trying to extend Rust to new users and stepping away from the ones we have. Especially because the new users we're talking about here have many options, and the ones we have often don't.</p>



<a name="276507752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276507752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276507752">(Mar 24 2022 at 17:02)</a>:</h4>
<p>I'm genuinely excited about making Rust easier to use. Especially so because we have a history of taking things that are hard and making them easier without hiding them entirely. Lifetimes make it possible to get automatic memory management <em>without</em> GC and its associated loss of control over timing of important operations (e.g. <a href="https://openjdk.java.net/jeps/421">https://openjdk.java.net/jeps/421</a> ).</p>



<a name="276538748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276538748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276538748">(Mar 24 2022 at 21:00)</a>:</h4>
<p>I have no fucking idea what this acronym means.</p>



<a name="276541731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/RPITIDT/near/276541731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/RPITIDT.html#276541731">(Mar 24 2022 at 21:27)</a>:</h4>
<p>continued as <a href="#narrow/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/return.20position.20impl.20Trait.20in.20dyn.20Trait</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>