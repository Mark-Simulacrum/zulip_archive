<html>
<head><meta charset="utf-8"><title>&amp;unsafe · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html">&amp;unsafe</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="215113282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113282">(Oct 30 2020 at 15:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> do you know where the majority discussion of <code>&amp;unsafe</code> has taken place?</p>



<a name="215113304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113304">(Oct 30 2020 at 15:53)</a>:</h4>
<p>I don't think there's been one place, maybe some UCG issues?</p>



<a name="215113311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113311">(Oct 30 2020 at 15:53)</a>:</h4>
<p>I'd like to have a better understanding of the proposed payoff for adding it</p>



<a name="215113366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113366">(Oct 30 2020 at 15:53)</a>:</h4>
<p>I think the idea is that <em>in practice</em> you almost never want <code>*const/*mut</code> in some sense</p>



<a name="215113391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113391">(Oct 30 2020 at 15:53)</a>:</h4>
<p>so adding a third variant is the answer?</p>



<a name="215113455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113455">(Oct 30 2020 at 15:54)</a>:</h4>
<p>(with, what, some sort of subtype relation?)</p>



<a name="215113464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113464">(Oct 30 2020 at 15:54)</a>:</h4>
<p>I believe the idea is that we would overtime deprecate raw pointers almost entirely</p>



<a name="215113485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215113485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215113485">(Oct 30 2020 at 15:54)</a>:</h4>
<p>hmm</p>



<a name="215189818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215189818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215189818">(Oct 31 2020 at 12:38)</a>:</h4>
<p>I don't know of any structured discussion or document for this</p>



<a name="215189827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215189827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215189827">(Oct 31 2020 at 12:38)</a>:</h4>
<p>Just some ideas floating around for, basically, a more ergonomic built-in version of <code>NonNull</code></p>



<a name="215207684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215207684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215207684">(Oct 31 2020 at 19:24)</a>:</h4>
<p>Might be an interesting opportunity to do more things with alignment too.  Either an alignment validity option on pointers (so you could have a 4-aligned u8 pointer, or a 1-aligned i32 pointer for <code>repr(packed)</code>), or an erased thing that works more like a lint kind like I understand zig has for its pointers.</p>



<a name="215209471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215209471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215209471">(Oct 31 2020 at 20:04)</a>:</h4>
<p>the zig thing is a lint? so far I was under the impression that it is enforced? that's how people in /r/rust seem to tout it anyways^^</p>



<a name="215209487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215209487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215209487">(Oct 31 2020 at 20:05)</a>:</h4>
<p>but yes, &amp;unsafe should either make no alignment requirements (so reads/writes are implicitly unaligned) or should have fine-grained alignment control</p>



<a name="215211575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215211575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215211575">(Oct 31 2020 at 20:54)</a>:</h4>
<p>"lint" was probably a poor word, though it might be a "lint" in the way that <code>*mut</code>-vs-<code>*const</code> is a "lint".  I haven't looked to see whether Zig actually monomorphizes differently by alignment of the pointer, or whether it's erased after the compile-time check.</p>



<a name="215223605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215223605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215223605">(Nov 01 2020 at 02:58)</a>:</h4>
<p>One issue with <code>&amp;unsafe</code> syntax: <code>&amp;unsafe { 1 }</code> is valid already and is equivalent to <code>&amp;1</code></p>



<a name="215223689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215223689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215223689">(Nov 01 2020 at 03:00)</a>:</h4>
<p>I think using only <code>&amp;unsafe const</code> or <code>&amp;unsafe mut</code> could work, though</p>



<a name="215225247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215225247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215225247">(Nov 01 2020 at 03:47)</a>:</h4>
<p>Zig erases the alignments at runtime, but there's an alignment cast which has a safety check in debug.</p>



<a name="215234227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215234227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215234227">(Nov 01 2020 at 08:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303115">Quy Nguyen</span> <a href="#narrow/stream/213817-t-lang/topic/.26unsafe/near/215225247">said</a>:</p>
<blockquote>
<p>Zig erases the alignments at runtime</p>
</blockquote>
<p>Sure, but Rust also erases lifetimes at runtime and they are very much not a lint ;)</p>



<a name="215234231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215234231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215234231">(Nov 01 2020 at 08:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/.26unsafe/near/215211575">said</a>:</p>
<blockquote>
<p>"lint" was probably a poor word, though it might be a "lint" in the way that <code>*mut</code>-vs-<code>*const</code> is a "lint".  I haven't looked to see whether Zig actually monomorphizes differently by alignment of the pointer, or whether it's erased after the compile-time check.</p>
</blockquote>
<p>I get that, but that is not the impression I had of Zig. But I never used Zig, my impression is based on the posts that occasionally come up in TWiR.</p>



<a name="215234272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215234272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215234272">(Nov 01 2020 at 08:48)</a>:</h4>
<p>Namely I thought the point was that Zig <em>guarantees</em> correctness of these alignment annotations.<br>
Now <span class="user-mention" data-user-id="303115">@Quy Nguyen</span> says there are alignment casts, so I wonder -- are those considered "unsafe" in some sense?</p>



<a name="215247830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215247830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215247830">(Nov 01 2020 at 15:02)</a>:</h4>
<p>Remember, Zig is not a safe language. Alignment casts are a type of safety check described here. <a href="https://ziglang.org/#Performance-and-Safety-Choose-Two">https://ziglang.org/#Performance-and-Safety-Choose-Two</a></p>



<a name="215255071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215255071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215255071">(Nov 01 2020 at 18:09)</a>:</h4>
<p>So, just to make sure I understood things correctly, would non-null-ness be the only difference between the suggested <code>&amp;unsafe</code> and <code>&amp;raw</code>?</p>
<ul>
<li>Given the whole thread, an <code>&amp;'unsafe</code> lifetime to represent a non-null and well-aligned but not <code>dereferenceable</code> reference would seem to solve most of the issues, be clearer about the meaning (we are lying about the <em>lifetime</em> and thus area of usability and validity of the reference), and would combine better with nested types <code>Foo&lt;'unsafe&gt;</code>). Such a reference, at the primitive level, could be constructed using<code>&amp;raw</code> It would also help when trying to easily remove lifetime params, like self-referential helper cates do (they often use <code>'static</code> for this <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span>)</li>
</ul>
<p>Also, one old proposal that was quite technical but thus also detailed, about "expired references", that may then be related / worth reading would be: <a href="https://internals.rust-lang.org/t/proposal-about-expired-references/11675">https://internals.rust-lang.org/t/proposal-about-expired-references/11675</a></p>



<a name="215256880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215256880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215256880">(Nov 01 2020 at 18:55)</a>:</h4>
<p>If <code>'unsafe</code> is a lifetime, then what should happen when you call a (safe) <code>Foo&lt;'a&gt;</code> function on a <code>Foo&lt;'unsafe&gt;</code>? Presumably this should be unsafe but then how do the <code>unsafe</code> blocks work?</p>



<a name="215259473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215259473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215259473">(Nov 01 2020 at 19:59)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I'd guess the language would need to provide an <code>unsafe</code> cast: <code>as Foo&lt;'_&gt;</code>, to inject an arbitrary lifetime there, whereby asserting the validity of the involved reference(s) for the duration of that lifetime. Obviously that would have the drawback of dealing with potentially unbounded lifetimes, but we do know how to write shims to get that under control (connect an unbounded lifetime parameter with that of a reference to some dummy local (<code>&amp;'local ()</code>), or use higher-order lifetimes to ensure the lifetime does not escape the syntactically visible scope of the provided closure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">with_assume_valid</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span>: <span class="nc">Foo</span><span class="o">&lt;'</span><span class="na">unsafe</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">with</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">Foo</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">with</span><span class="p">(</span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// Usage:</span>
<span class="kd">let</span><span class="w"> </span><span class="n">foo</span>: <span class="nc">Foo</span><span class="o">&lt;'</span><span class="na">unsafe</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">with_assume_valid</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">foo</span>: <span class="nc">Foo</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">safe_fn</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">})};</span><span class="w"> </span><span class="c1">// &lt;- we assume / Rust knows `foo` is `dereferenceable` during this whole scope.</span>
</code></pre></div>
<hr>
<p>Anyways, I am not making an RFC or even a pre-RFC here, so I haven't thought of the ways <code>Foo&lt;'unsafe&gt;</code> stuff could work; it just seems, at first glance, that such design could at least have some hope of interacting with these complex types, whereas <code>&amp;unsafe</code>-forged raw pointers wouldn't. For a more full-fledged proposal, the internals thread I linked to does mention some interesting ideas, and contrary to me, they seem to have done their theorycrafting homework <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
<p>So feel free to dismiss my brainstormed <code>&amp;'unsafe</code> idea; I am more interested in knowing an actually meaningful difference between <code>&amp;raw</code> and <code>&amp;unsafe</code> other than <code>NonNull</code>-ness;</p>



<a name="215260802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215260802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215260802">(Nov 01 2020 at 20:28)</a>:</h4>
<blockquote>
<p>So, just to make sure I understood things correctly, would non-null-ness be the only difference between the suggested &amp;unsafe and &amp;raw?</p>
</blockquote>
<p>There is no concrete proposal yet, so there is no definite answer. Also, <code>&amp;raw</code> is not a type, it is an operation, so I do not understand the comparison.<br>
in terms of validity, non-null-ness was the proposed main difference between <code>&amp;unsafe</code> and <code>*mut</code>. but the proposal also involves ergonomic differences (which coercions etc are applied). I am not sure what exactly the ideas here were, <span class="user-mention" data-user-id="256759">@boats</span> might remember more.</p>



<a name="215262564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215262564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215262564">(Nov 01 2020 at 21:14)</a>:</h4>
<p>Thanks for the answer <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<blockquote>
<p>Also, &amp;raw is not a type, it is an operation, so I do not understand the comparison.</p>
</blockquote>
<p>IIUC, understood <code>&amp;unsafe</code> would be (at least) an operation too, since I saw somewhere some talk of it being ambiguous with <code>&amp;unsafe {</code>.</p>
<p>I guess the idea then would be to have, similar to <code>&amp;</code> and <code>&amp;mut</code>, a "common" syntax for both the <code>&amp;raw</code>-as-a-nonnull operation and the <code>ptr::NonNull</code> type itself? (with a special <code>ptr::NonNullInvariant&lt;T&gt;</code> type for the <code>&amp;unsafe mut</code> case?)</p>
<p>* In that case, is there a specific motivation for not including alignment among the validity invariants?</p>



<a name="215264898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215264898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215264898">(Nov 01 2020 at 22:10)</a>:</h4>
<blockquote>
<p>IIUC, understood &amp;unsafe would be (at least) an operation too, since I saw somewhere some talk of it being ambiguous with &amp;unsafe {.</p>
</blockquote>
<p>once we have a new type <code>&amp;unsafe T</code> we need an operation to create elements of the type. :)<br>
but the key point is that it is a new type.</p>



<a name="215265007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215265007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215265007">(Nov 01 2020 at 22:12)</a>:</h4>
<p>also I am not the one making the proposal so I am probably ill-suited to answer all these questions :D<br>
the goal is to solve some problems around raw pointers:</p>
<ul>
<li>the mut/const distinction is mostly just annoying</li>
<li>NonNull should be used most of the time but is very unergonomic</li>
<li>field accesses to raw pointers are also rather annoying... <code>(*(*x).field.ptr).nested_field</code> is awful. [this is the "postfix deref" part of the plan, which is orthogonal to <code>&amp;unsafe</code> but part of the larger "unsafe/raw ptr ergnomic" issue]</li>
</ul>



<a name="215266532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215266532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215266532">(Nov 01 2020 at 22:49)</a>:</h4>
<p>Could we instead make NonNull and the like more ergonomic? One thing I'd want for example is implementing stuff for *T and not just &amp;T.</p>



<a name="215494917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215494917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> boats <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215494917">(Nov 03 2020 at 18:43)</a>:</h4>
<p>Ralf's summary is accurate to my memory. This never advanced to the point of a fleshed out proposal.</p>



<a name="215495040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215495040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> boats <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215495040">(Nov 03 2020 at 18:44)</a>:</h4>
<p>One thing we wanted to do I remember was e.g. making the cast between target type and the cast from const to mut syntactically different, instead of both being with <code>as</code>, to help readers understand better what was happening.</p>



<a name="215952270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215952270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215952270">(Nov 07 2020 at 12:11)</a>:</h4>
<p>we also considered entirely killing the const/mut distinction</p>



<a name="215959717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215959717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215959717">(Nov 07 2020 at 15:26)</a>:</h4>
<p>What would be the default variance, then? Invariant would make it <em>impossible</em> to define covariant wrappers around it, and covariant would make it quite easy to accidentally construct unsound covariant  abstractions… (the issue coming from the "auto-trait nature" of variance). If we were to speculate about potential future additions, I'd love to see variance involved at use-site rather than tied to the type. That is, something involving <code>&amp;unsafe T</code> would be invariant, but something (such as a function or a wrapper type definition) involving <code>#[covariant] &amp;unsafe T</code> would get to be covariant, at least <em>w.r.t.</em> that specific usage:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Iter</span><span class="o">&lt;'</span><span class="na">iter</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span>: <span class="o">'</span><span class="na">iter</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">remaining_slice</span>: <span class="cp">#[covariant]</span><span class="w"> </span><span class="o">&amp;</span><span class="k">unsafe</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="n">_lifetime</span>: <span class="nc">PhantomData</span><span class="o">&lt;&amp;'</span><span class="na">iter</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">IterMut</span><span class="o">&lt;'</span><span class="na">iter</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span>: <span class="o">'</span><span class="na">iter</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">remaining_slice</span>: <span class="kp">&amp;</span><span class="nc">unsafe</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="n">_lifetime</span>: <span class="nc">PhantomData</span><span class="o">&lt;&amp;'</span><span class="na">iter</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This is way, the default choice is the conservative invariant design, butt hat doesn't prevent users from opting into covariance.</p>



<a name="215960603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215960603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215960603">(Nov 07 2020 at 15:47)</a>:</h4>
<blockquote>
<p>Invariant would make it impossible to define covariant wrappers around it</p>
</blockquote>
<p>not if we allow something like <code>unsafe impl Covariant for ...</code> (this does not make sense as a trait because the "subject" of variance is not a type but a type constructor... but you get the idea).<br>
I guess attributes also work like you suggested.</p>



<a name="215960610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215960610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215960610">(Nov 07 2020 at 15:47)</a>:</h4>
<p>I don't think manual variance annotations should be attached to fields</p>



<a name="215960616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215960616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215960616">(Nov 07 2020 at 15:47)</a>:</h4>
<p>they should be attached to parameters, because those are the things that have variance</p>



<a name="215960634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215960634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215960634">(Nov 07 2020 at 15:48)</a>:</h4>
<p>so more like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Iter</span><span class="o">&lt;'</span><span class="na">iter</span><span class="p">,</span><span class="w"> </span><span class="cp">#[covariant]</span><span class="w"> </span><span class="n">T</span><span class="w"> </span>: <span class="o">'</span><span class="na">iter</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">remaining_slice</span>: <span class="cp">#[covariant]</span><span class="w"> </span><span class="o">&amp;</span><span class="k">unsafe</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="n">_lifetime</span>: <span class="nc">PhantomData</span><span class="o">&lt;&amp;'</span><span class="na">iter</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="215960915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215960915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215960915">(Nov 07 2020 at 15:54)</a>:</h4>
<p>I agree with that, but the current necessary-<code>PhantomData</code>-or-other-usage-to-infer-variance-from-it design kind of leans the other way around.</p>
<p>But past "mistakes" should not dictate future design choices: I agree that explicit covariance annotations affecting a type constructor is what makes most sense / is less error-prone. When/If these are added, it would free us from the obligation to "use" the type somewhere, and get rid of many <code>PhantomData</code> usages altogether.</p>
<p>And given that it can't be a trait (at least until we get HKT), using <code>#[attributes]</code> is the next most logical syntax, and adding the annotations when introducing the parameters looks quite nice indeed.</p>



<a name="215962888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215962888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215962888">(Nov 07 2020 at 16:43)</a>:</h4>
<p>A big +1 from me for marking <code>#[covariant]</code> on struct parameters, independently from <code>&amp;unsafe</code>. However, that attribute needs to be unsafe; where would the <code>unsafe</code> go?</p>



<a name="215963059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215963059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215963059">(Nov 07 2020 at 16:46)</a>:</h4>
<p>hm... this reminds me we really need a story for unsafe attributes...</p>



<a name="215963063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215963063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215963063">(Nov 07 2020 at 16:46)</a>:</h4>
<p>(e.g., <code>link_name</code>, or <code>no_mangle</code>)</p>



<a name="215963257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215963257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215963257">(Nov 07 2020 at 16:50)</a>:</h4>
<p>(<a href="https://github.com/rust-lang/rust/pull/72209">https://github.com/rust-lang/rust/pull/72209</a> fwiw)</p>



<a name="215963398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215963398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215963398">(Nov 07 2020 at 16:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/.26unsafe/near/215963257">said</a>:</p>
<blockquote>
<p>(<a href="https://github.com/rust-lang/rust/pull/72209">https://github.com/rust-lang/rust/pull/72209</a> fwiw)</p>
</blockquote>
<p>that's nice, but only useful for people that set <code>deny(unsafe_code)</code>.<br>
it seems somewhat unfortunate that we should allow unsafe attributes by default unless one opts out; that is not how we usually handle unsafety ;)</p>



<a name="215963482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215963482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215963482">(Nov 07 2020 at 16:55)</a>:</h4>
<p>yeah</p>



<a name="215967109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215967109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215967109">(Nov 07 2020 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/213817-t-lang/topic/.26unsafe/near/215963398">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/213817-t-lang/topic/.26unsafe/near/215963257">said</a>:</p>
<blockquote>
<p>(<a href="https://github.com/rust-lang/rust/pull/72209">https://github.com/rust-lang/rust/pull/72209</a> fwiw)</p>
</blockquote>
<p>that's nice, but only useful for people that set <code>deny(unsafe_code)</code>.<br>
it seems somewhat unfortunate that we should allow unsafe attributes by default unless one opts out; that is not how we usually handle unsafety ;)</p>
</blockquote>
<p>could we add a separate <code>unsafe_attributes</code> lint that's warn by default?</p>



<a name="215967122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215967122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215967122">(Nov 07 2020 at 18:23)</a>:</h4>
<p>or even error-by-default if you want people to have to opt-in</p>



<a name="215967305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215967305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215967305">(Nov 07 2020 at 18:28)</a>:</h4>
<p>I am imagining something like <code>#[unsafe(....)]</code>, with a lint for existing attributes that fail to be wrapped in <code>unsafe</code>. the lint should be warn-by-default on current editions and err-by-default on future editions.</p>



<a name="215967310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/215967310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#215967310">(Nov 07 2020 at 18:28)</a>:</h4>
<p>unfortunately I have no bandwidth to push for something like this^^</p>



<a name="216004013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/216004013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#216004013">(Nov 08 2020 at 12:01)</a>:</h4>
<p>Note that having <code>#[unsafe(…)]</code> would be a nice way to, for instance, assert that the declarations of functions inside an <code>extern "ABI" { … }</code> block do not need to be <code>unsafe</code>-to-call, which I know is a feature desired by some people:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[unsafe(assume_safe)]</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="s">"ABI"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">wrapping_add</span><span class="w"> </span><span class="p">(</span><span class="n">x</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="216004355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/216004355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#216004355">(Nov 08 2020 at 12:08)</a>:</h4>
<p>yeah there are probably more ways this is useful than just fixing the existing soundness holes</p>



<a name="216004372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/216004372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#216004372">(Nov 08 2020 at 12:09)</a>:</h4>
<p>if someone wants to take the lead on this I'd be happy to give feedback for an RFC or whatever the right process might be ;)</p>



<a name="216587569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/216587569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#216587569">(Nov 13 2020 at 09:41)</a>:</h4>
<p>Also see <a href="https://github.com/image-rs/image/pull/1358">https://github.com/image-rs/image/pull/1358</a> for a case where <code>*mut</code> vs <code>*const</code> actually could have helped identify a bug, if const-to-mut casts required special syntax</p>



<a name="216671400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%26unsafe/near/216671400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.26unsafe.html#216671400">(Nov 13 2020 at 20:52)</a>:</h4>
<p>Also <a href="https://blog.rust-lang.org/2017/02/09/Rust-1.15.1.html#whats-in-1151-stable">https://blog.rust-lang.org/2017/02/09/Rust-1.15.1.html#whats-in-1151-stable</a>, of course.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>