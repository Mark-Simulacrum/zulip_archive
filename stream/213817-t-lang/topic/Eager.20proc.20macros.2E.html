<html>
<head><meta charset="utf-8"><title>Eager proc macros. Â· t-lang Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html">Eager proc macros.</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261297876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261297876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261297876">(Nov 12 2021 at 19:14)</a>:</h4>
<p>Hello i wonder what people think about the idea of a general mechanism for "eager proc macros", which:</p>
<ul>
<li>Registered to enable only from command line parameters like <code>rustc --eager-macro concat_idents = std::concat_idents</code></li>
<li>Invoked for all tokentree sequences of the form <code>identifier ! group</code> where identifier is registered.</li>
<li>NOT AST-typed, performs <code>TokenStream -&gt; TokenStream</code> inline replacement conceptually BEFORE AST tree is formed.</li>
<li><code>concat_idents</code>, <code>include</code> and maybe others be migrated into this mechanism, and be registered as builtin macros.</li>
</ul>



<a name="261298428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261298428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261298428">(Nov 12 2021 at 19:19)</a>:</h4>
<blockquote>
<p>concat_idents, include and maybe others be migrated into this mechanism, and be registered as builtin macros.</p>
</blockquote>
<p>That would be a breaking change for <code>foo!(include!("a"))</code> where currently <code>foo!</code> would get<code>include!("a")</code> as raw input instead of it's expansion.</p>



<a name="261299061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261299061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261299061">(Nov 12 2021 at 19:24)</a>:</h4>
<p>Yes, it is. Though in practice this is quite rare. Actually if the <code>included!()</code> is used as a <code>$expr</code>, the current behavior in this example -  <code>include!</code> macro reading the first expression and discarding rest silently - is not a very well-behaved behavior and potentially surprising to users...</p>



<a name="261301366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301366">(Nov 12 2021 at 19:43)</a>:</h4>
<p>Whatâ€™s the motivation?</p>



<a name="261301386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301386">(Nov 12 2021 at 19:43)</a>:</h4>
<p>And in what sense are they eager?</p>



<a name="261301388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301388">(Nov 12 2021 at 19:43)</a>:</h4>
<p>Fixing <code>concat_idents!</code> behavior.</p>



<a name="261301478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301478">(Nov 12 2021 at 19:44)</a>:</h4>
<p>Currently  <code>let concat_idents!(foo, bar) = 5;</code> doesn't work.</p>



<a name="261301591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301591">(Nov 12 2021 at 19:45)</a>:</h4>
<p>because it's an expression macro.</p>



<a name="261301598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301598">(Nov 12 2021 at 19:45)</a>:</h4>
<p>I feel like I wrote an rfc for this 4 or 5 years ago? But I canâ€™t remember it at all ðŸ¤£</p>



<a name="261301625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261301625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261301625">(Nov 12 2021 at 19:45)</a>:</h4>
<p>Maybe itâ€™s a different kind of eager?</p>



<a name="261309107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Eager%20proc%20macros./near/261309107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Eager.20proc.20macros.2E.html#261309107">(Nov 12 2021 at 20:53)</a>:</h4>
<p>While eager expansions could solve stuff, the approach you suggest, for <code>concat_idents!</code>, would not work, since the meaningful usages of that macro are with at least one metavariable argument, which could thus not be handled by a "dummy syntactical preprocessor".</p>
<p>In the case of <code>concat_idents</code>, the issue is the call-site rather than the eagerness of the call. In that regard, we could imagine a <code>#[rename_concat]</code> attribute that could be applicable to <code>fn</code> defs and <code>let</code> bindings:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[rename_concat($foo, _test)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">__</span><span class="p">(</span><span class="n">arg</span>: <span class="nc">Arg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Ret</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>Back to the topic of eager expansion (to chain macros), there seem to be significant issues in the general case, but a simpler experimental <code>expand_expr</code> <code>TokenStream</code> helper is about to be added to nightly: <a href="https://github.com/rust-lang/rust/pull/87264">https://github.com/rust-lang/rust/pull/87264</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>