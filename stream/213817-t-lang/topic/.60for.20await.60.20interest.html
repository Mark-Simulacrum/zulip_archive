<html>
<head><meta charset="utf-8"><title>`for await` interest · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html">`for await` interest</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="238517687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238517687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238517687">(May 12 2021 at 18:01)</a>:</h4>
<p>It seems like there's renewed interest in <code>for await</code> and I'd love to hear more</p>



<a name="238517709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238517709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238517709">(May 12 2021 at 18:01)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="119031">@Esteban Küber</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="238517818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238517818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238517818">(May 12 2021 at 18:01)</a>:</h4>
<p>I think the example being given was that it's nice for writing <code>async gen fn</code>s  that just pass through values from child streams which have been modified somehow?</p>



<a name="238517918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238517918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238517918">(May 12 2021 at 18:02)</a>:</h4>
<p>That is one case, but it isn't <em>necessary</em> for it</p>



<a name="238517932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238517932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238517932">(May 12 2021 at 18:02)</a>:</h4>
<p>e.g. you could write a map as <code>async gen { for await x in child { yield x + 1 } }</code></p>



<a name="238517978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238517978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238517978">(May 12 2021 at 18:02)</a>:</h4>
<p>right, you could do this with a <code>while let Some(x) = child.next().await { ... }</code></p>



<a name="238518056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518056">(May 12 2021 at 18:03)</a>:</h4>
<p>Which I think is true generally of <code>for await</code>'s usage from what I've seen</p>



<a name="238518088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518088">(May 12 2021 at 18:03)</a>:</h4>
<p>For me the main impetus is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zip</span><span class="p">(</span><span class="n">foo</span><span class="p">(),</span><span class="w"> </span><span class="n">bar</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?} {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>which could be written as</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zip</span><span class="p">(</span><span class="n">foo</span><span class="p">(),</span><span class="w"> </span><span class="n">bar</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?} {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="238518223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518223">(May 12 2021 at 18:04)</a>:</h4>
<p>so auto-pinning and a more familiar syntax than <code>while let</code>, which is what a naïve programmer trying async/await would do</p>



<a name="238518315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518315">(May 12 2021 at 18:05)</a>:</h4>
<p>Could that be written as <code>for await (a, b) in zip(foo(), bar())</code>, or is there any reason that wouldn't work and you need a separate <code>let</code>?</p>



<a name="238518317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518317">(May 12 2021 at 18:05)</a>:</h4>
<p>We could instead just _parse_ and suggest the right code</p>



<a name="238518327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518327">(May 12 2021 at 18:05)</a>:</h4>
<p>you can already write that today as </p>
<div class="codehilite"><pre><span></span><code>   zip(foo(), bar()).for_each(|a, b| async move {
       println!(&quot;{:?} {:?}&quot;, a, b)
    }).await;
</code></pre></div>



<a name="238518418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518418">(May 12 2021 at 18:05)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> yes, it could be, which we can't with the <code>while let</code> version (was trying to keep the changes minimal to compare directly)</p>



<a name="238518432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518432">(May 12 2021 at 18:05)</a>:</h4>
<p>but that is one of the potential benefits</p>



<a name="238518469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518469">(May 12 2021 at 18:06)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> You can write almost any for loop as a <code>for_each</code>, but if you do, you lose the ability to do things like early-return or break or <code>?</code>.</p>



<a name="238518488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518488">(May 12 2021 at 18:06)</a>:</h4>
<p>or replace <code>Pin::new_unchecked</code> with <code>pin_mut!(s)</code> if you're just saving characters</p>



<a name="238518531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518531">(May 12 2021 at 18:06)</a>:</h4>
<p>i thought the point was more that you didn’t want to have to think about pin in the first place</p>



<a name="238518587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518587">(May 12 2021 at 18:06)</a>:</h4>
<p><code>pin_mut!</code> is yet another crate people have to learn about it, and it's "interaction with <code>Pin</code>", which I'mtrying to minimize</p>



<a name="238518590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518590">(May 12 2021 at 18:06)</a>:</h4>
<p>Suppose the body of the loop is <code>println!("{:?} {:?} =&gt; {:?}", a, b, somefunc(a, b)?)</code>.</p>



<a name="238518600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518600">(May 12 2021 at 18:06)</a>:</h4>
<p>(which it sounds like <code>for_each</code> accomplishes, at other costs)</p>



<a name="238518603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518603">(May 12 2021 at 18:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I do think that seems to be the trend, but I'm not convinced it's a good idea</p>



<a name="238518627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518627">(May 12 2021 at 18:07)</a>:</h4>
<p>I think people need to learn about and understand <code>Pin</code></p>



<a name="238518663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518663">(May 12 2021 at 18:07)</a>:</h4>
<p>If they're writing async code, they will need to use / interact with it</p>



<a name="238518752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518752">(May 12 2021 at 18:07)</a>:</h4>
<p>I've written a lot of async code over the last year or so. I didn't understand Pin at all (other than conceptually) until very recently, when I read <a href="https://fasterthanli.me/articles/pin-and-suffering">https://fasterthanli.me/articles/pin-and-suffering</a> .</p>



<a name="238518762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518762">(May 12 2021 at 18:08)</a>:</h4>
<p>I dunno, it seems like there is a middle tier audience that could get away with not interacting with it (Pin) if we provided enough sugar</p>



<a name="238518913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518913">(May 12 2021 at 18:08)</a>:</h4>
<p>For me, seeing <code>Pin</code> in a type was the warning sign for "you have delved too deep, look for a higher-level function".</p>



<a name="238518920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518920">(May 12 2021 at 18:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> Possibly? But I think that's the same audience that I don't want to trick into writing accidentally-serialized code via offering <code>for await</code></p>



<a name="238518956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518956">(May 12 2021 at 18:09)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I think that's bad and that we should work to change that</p>



<a name="238518985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238518985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238518985">(May 12 2021 at 18:09)</a>:</h4>
<p>People are scared of <code>Pin</code> and there's a culture around it that it's some kind of demon</p>



<a name="238519027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519027">(May 12 2021 at 18:09)</a>:</h4>
<p>I wouldn't go that far. But it's definitely something I didn't understand, and that didn't stop me from writing lots of async code.</p>



<a name="238519033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519033">(May 12 2021 at 18:09)</a>:</h4>
<p>and we need to make it more friendly and welcoming rather than tell people that they've gone down a wrong path</p>



<a name="238519062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519062">(May 12 2021 at 18:09)</a>:</h4>
<p>there are lots of things in rust that have "fame" of being hard to use whether deservedly or not, <code>Pin</code> deserves it</p>



<a name="238519084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519084">(May 12 2021 at 18:09)</a>:</h4>
<p>(at the very least it seems like we risk Monad:Haskell::Pin:Rust, in terms of perception from outside communty, and perhaps beginners...)</p>



<a name="238519132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519132">(May 12 2021 at 18:10)</a>:</h4>
<p>not because it is hard on its own, but in how it interacts with the rest of the language</p>



<a name="238519151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519151">(May 12 2021 at 18:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238519084">said</a>:</p>
<blockquote>
<p>(at the very least it seems like we risk Monad:Haskell::Pin:Rust)</p>
</blockquote>
<p>"A Pin is like a burrito"</p>



<a name="238519181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519181">(May 12 2021 at 18:10)</a>:</h4>
<p>"learning pin" here can just be "know that you need to type .boxed() sometimes"</p>



<a name="238519189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519189">(May 12 2021 at 18:10)</a>:</h4>
<p>The async ecosystem has done an excellent job of providing higher-level functions that let people use async without thinking about Pin at all.</p>



<a name="238519283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519283">(May 12 2021 at 18:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238519151">said</a>:</p>
<blockquote>
<p>"A Pin is like a burrito"</p>
</blockquote>
<p>you may be onto something here...</p>



<a name="238519288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519288">(May 12 2021 at 18:11)</a>:</h4>
<p>That's great, I guess? That hasn't been at all my experience</p>



<a name="238519315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519315">(May 12 2021 at 18:11)</a>:</h4>
<p>And when I say that Pin was a sign I was looking at the wrong function, I mean things like "Ah, I don't want to be looking at <code>AsyncRead::poll_read</code>, I want to be looking at <code>AsyncReadExt::read</code>".</p>



<a name="238519332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519332">(May 12 2021 at 18:11)</a>:</h4>
<p>Every Rust developer using <code>async</code> I've spoken with has some story about "oh yeah there's this weird pin thing I had to go figure out"</p>



<a name="238519339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519339">(May 12 2021 at 18:11)</a>:</h4>
<p>Poll was also a sign I was at the wrong level.</p>



<a name="238519491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519491">(May 12 2021 at 18:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238519332">said</a>:</p>
<blockquote>
<p>Every Rust developer using <code>async</code> I've spoken with has some story about "oh yeah there's this weird pin thing I had to go figure out"</p>
</blockquote>
<p>I'm not suggesting we shouldn't fix that, but it isn't "fixing" that to say "let's force everyone to learn Pin sooner".</p>



<a name="238519519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519519">(May 12 2021 at 18:12)</a>:</h4>
<p>If you never write your own futures or streams by hand, or use <code>select</code>, or use methods like <code>next</code>, then I can see how you would avoid it a lot of the time I  guess?</p>



<a name="238519546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519546">(May 12 2021 at 18:13)</a>:</h4>
<p>I'm not arguing to force people to learn it</p>



<a name="238519573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519573">(May 12 2021 at 18:13)</a>:</h4>
<p>I know you're not. I'm making the point that many people get by <em>without</em> touching it, and that's not a bug.</p>



<a name="238519594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519594">(May 12 2021 at 18:13)</a>:</h4>
<p>I'm arguing that adding a language feature that guides people in the wrong direction is not worth it if the payoff is just "you don't have to write <code>pin_mut!(x)</code> now"</p>



<a name="238519720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519720">(May 12 2021 at 18:14)</a>:</h4>
<p>In particular, a major use case for generators here would be "here's a way to write and process streams without thinking about pin", and it seems like one of your arguments against that is that people <em>could</em> write it if they learn about pin.</p>



<a name="238519727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519727">(May 12 2021 at 18:14)</a>:</h4>
<p>esp. since I think the case that <em>is</em> more ergonomic today (e.g. <code>.for_each_concurrent</code>) is the type of thing we want to point people towards</p>



<a name="238519776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519776">(May 12 2021 at 18:14)</a>:</h4>
<p>Sorry, to clarify, this conversation is not about generators, but about <code>for await</code> syntax</p>



<a name="238519831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519831">(May 12 2021 at 18:15)</a>:</h4>
<p>I think the same argument applies there; <code>for await</code> has the same benefit.</p>



<a name="238519882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519882">(May 12 2021 at 18:15)</a>:</h4>
<p>The two are related, but I think my opinions are being confused: I think we <em>do</em> want generator syntax at some point, but I think we <em>should not ever</em> have <code>for await</code> syntax</p>



<a name="238519896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519896">(May 12 2021 at 18:15)</a>:</h4>
<p>Clarifying question:<br>
<span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238519594">said</a>:</p>
<blockquote>
<p>I'm arguing that adding a language feature that guides people in the wrong direction is not worth it if the payoff is just "you don't have to write <code>pin_mut!(x)</code> now"</p>
</blockquote>
<p>By "wrong direction" here, you're talking about "serial rather than parallel", rather than "not thinking about pin"?</p>



<a name="238519912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519912">(May 12 2021 at 18:15)</a>:</h4>
<p>Correct</p>



<a name="238519951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519951">(May 12 2021 at 18:16)</a>:</h4>
<p>Just out of curiosity, doesnt <code>.for_each_concurrent</code> treat a <code>Stream</code> as a <code>Vec&lt;impl Future&gt;</code>?</p>



<a name="238519965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238519965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238519965">(May 12 2021 at 18:16)</a>:</h4>
<p>I think that iterating over streams serially is usually the wrong choice</p>



<a name="238520000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520000">(May 12 2021 at 18:16)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> So, on a different note, what do you think of the idea of us having a future <code>parallel for</code> syntax?</p>



<a name="238520002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520002">(May 12 2021 at 18:16)</a>:</h4>
<p>^^ I'm not sure what you mean by <code>Vec&lt;impl Future&gt;</code>, sorry</p>



<a name="238520099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520099">(May 12 2021 at 18:17)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> if we had a native syntax for expressing concurrent async processing of streams, I would be much less concerned about also having <code>for await</code></p>



<a name="238520134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520134">(May 12 2021 at 18:17)</a>:</h4>
<p>/me would love to be able to write (specifics of syntax aside) <code>parallel for x in some_iter { let y = func(x)?; otherfunc(y)?; }</code></p>



<a name="238520169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520169">(May 12 2021 at 18:17)</a>:</h4>
<p>That said, I do think there are a lot of thorny questions around how <code>concurrent for</code> would work (but I'd love to discuss them!)</p>



<a name="238520241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520241">(May 12 2021 at 18:18)</a>:</h4>
<p>It's really painful today to deal with the interaction between iterator combinators and <code>?</code>.</p>



<a name="238520259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520259">(May 12 2021 at 18:18)</a>:</h4>
<p>That sounds really nice, yes!</p>



<a name="238520289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520289">(May 12 2021 at 18:18)</a>:</h4>
<p>Though there're a lot of details (where does the threadpool / task pool come from etc.)</p>



<a name="238520303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520303">(May 12 2021 at 18:18)</a>:</h4>
<p>Oh, <em>absolutely</em>.</p>



<a name="238520317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520317">(May 12 2021 at 18:18)</a>:</h4>
<p>No argument there.</p>



<a name="238520347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520347">(May 12 2021 at 18:18)</a>:</h4>
<p>but yes, if we had that feature then I'd feel much less wary about <code>for await</code></p>



<a name="238520408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520408">(May 12 2021 at 18:19)</a>:</h4>
<p>So, let me ask a different question:</p>



<a name="238520500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520500">(May 12 2021 at 18:19)</a>:</h4>
<p>Many <code>for</code> loops today could be written to go faster using Rayon and <code>.par_iter()</code>. Is it bad that the most natural language syntax is <code>for</code>, which processes things serially?</p>



<a name="238520571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520571">(May 12 2021 at 18:20)</a>:</h4>
<p>Why is <code>for await</code> different than <code>for</code> in this way?</p>



<a name="238520586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520586">(May 12 2021 at 18:20)</a>:</h4>
<p>(other than the inertia of "we already have <code>for</code> but we don't have <code>for await</code>")</p>



<a name="238520625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520625">(May 12 2021 at 18:20)</a>:</h4>
<p>If we had <code>while let</code> today, but somehow didn't have <code>for</code> yet, would you argue against adding <code>for</code>?</p>



<a name="238520670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520670">(May 12 2021 at 18:21)</a>:</h4>
<p>Great question! I actually do think there's a significant difference between async and non-async code here</p>



<a name="238520864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520864">(May 12 2021 at 18:22)</a>:</h4>
<p>most of the synchronous code I write is not expected to be long-running or interestingly-blocking</p>



<a name="238520879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238520879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238520879">(May 12 2021 at 18:22)</a>:</h4>
<p>FWIW, C# recently added <code>IAsyncEnumerable</code> and corresponding <code>await foreach</code>: <a href="https://docs.microsoft.com/en-us/archive/msdn-magazine/2019/november/csharp-iterating-with-async-enumerables-in-csharp-8">https://docs.microsoft.com/en-us/archive/msdn-magazine/2019/november/csharp-iterating-with-async-enumerables-in-csharp-8</a></p>



<a name="238521052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521052">(May 12 2021 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> That's helpful precedent-- do you know how it interacts with folks <code>await</code>ing inside the body of the loop?</p>



<a name="238521069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521069">(May 12 2021 at 18:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238520864">said</a>:</p>
<blockquote>
<p>most of the synchronous code I write is not expected to be long-running or interestingly-blocking</p>
</blockquote>
<p>That's definitely a difference between our experiences. Much of my synchronous code <em>is</em>, and most of my asynchronous code is more event-driven quick-response.</p>



<a name="238521179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521179">(May 12 2021 at 18:25)</a>:</h4>
<blockquote>
<p>event-driven quick-response</p>
</blockquote>
<p>right, this is exactly the model I"m talking about: you want things to run concurrently because it's likely that you'll get events spread out over a wide range of time, with not much "work" to do in the middle</p>



<a name="238521287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521287">(May 12 2021 at 18:25)</a>:</h4>
<p>Can you say more about that? I feel like your offhand mention of "<code>await</code>ing inside the body of the loop" is a critical insight; that's starting to make much more sense.</p>



<a name="238521294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521294">(May 12 2021 at 18:25)</a>:</h4>
<p>contrasted with synchronous code, which is usually not blocked on external events. it happens sometimes, but certainly the vast majority of the synchronous <code>for</code> loops I've written do not reach out to the internet</p>



<a name="238521299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521299">(May 12 2021 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238521052">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> That's helpful precedent-- do you know how it interacts with folks <code>await</code>ing inside the body of the loop?</p>
</blockquote>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="k">await</span> <span class="nf">foreach</span> <span class="p">(</span><span class="kt">int</span> <span class="n">item</span> <span class="k">in</span> <span class="n">RangeAsync</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">item</span> <span class="p">+</span> <span class="s">" "</span><span class="p">);</span> <span class="c1">// Prints 10 11 12</span>
</code></pre></div>
<p>desugars to</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="n">IAsyncEnumerator</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">e</span> <span class="p">=</span> <span class="n">RangeAsync</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">3</span><span class="p">).</span><span class="n">GetAsyncEnumerator</span><span class="p">();</span>
<span class="k">try</span>
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="k">await</span> <span class="n">e</span><span class="p">.</span><span class="n">MoveNextAsync</span><span class="p">())</span> <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Current</span> <span class="p">+</span> <span class="s">" "</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">finally</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="k">await</span> <span class="n">e</span><span class="p">.</span><span class="n">DisposeAsync</span><span class="p">();</span> <span class="p">}</span>
</code></pre></div>
<p>and <code>await e</code> in the body is part of the same state machine.</p>



<a name="238521453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521453">(May 12 2021 at 18:26)</a>:</h4>
<p>oh, sorry, to clarify, I mean if there were an <code>await Console.Write(...);</code></p>



<a name="238521524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521524">(May 12 2021 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> Would it be accurate to say your biggest concern here is that if the body of the loop has an <code>await</code>, you want multiple iterations to be waiting in parallel rather than in series?</p>



<a name="238521528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521528">(May 12 2021 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Yeah, the <code>.await</code> in the body of the loop is the critical reason why I don't want <code>for await</code>-- (or possibly I want a version which always lints on an <code>.await</code> in its body?).</p>



<a name="238521628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521628">(May 12 2021 at 18:28)</a>:</h4>
<p>^^ right, if I'm iterating over an async stream of websites to <code>GET</code> request from, I want to make each <code>GET</code> request as soon as the website name is available</p>



<a name="238521693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521693">(May 12 2021 at 18:28)</a>:</h4>
<p>I don't want to wait for the <code>GET</code> request for the previous website to finish before I start on the next element</p>



<a name="238521695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521695">(May 12 2021 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238521453">said</a>:</p>
<blockquote>
<p>oh, sorry, to clarify, I mean if there were an <code>await Console.Write(...);</code></p>
</blockquote>
<p>Then it'd be</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="k">while</span> <span class="p">(</span><span class="k">await</span> <span class="n">e</span><span class="p">.</span><span class="n">MoveNextAsync</span><span class="p">())</span> <span class="p">{</span> <span class="k">await</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Current</span> <span class="p">+</span> <span class="s">" "</span><span class="p">);</span> <span class="p">}</span>
</code></pre></div>
<p>(and yes, it wouldn't pull the next thing from the async iterator until the body finished.)</p>



<a name="238521787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521787">(May 12 2021 at 18:29)</a>:</h4>
<p>So, I definitely agree that's an issue. I also think it's an issue in <em>most</em> async code. I'd love to not have to write <code>join</code> or similar to be able to do something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">xv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">yv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="n">func</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="w"> </span><span class="n">yv</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="238521843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521843">(May 12 2021 at 18:29)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> ah, okay, shucks-- I was hoping maybe there was something clever. I'd be curious to hear user reports about the feature (positive or negative) especaily if they mention that</p>



<a name="238521848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521848">(May 12 2021 at 18:29)</a>:</h4>
<p>I'd love to be able to automatically translate that into a graph-based parallel execution that awaits <code>x()</code> and <code>y()</code> in parallel before running <code>func</code>.</p>



<a name="238521879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521879">(May 12 2021 at 18:29)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> that sounds fancy!</p>



<a name="238521923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521923">(May 12 2021 at 18:29)</a>:</h4>
<p>I've seen research languages that could do exactly that.</p>



<a name="238521944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238521944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238521944">(May 12 2021 at 18:29)</a>:</h4>
<p>Dependency graphs from seemingly linear control-flow.</p>



<a name="238522023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522023">(May 12 2021 at 18:30)</a>:</h4>
<p>Oh yeah, I think it's possible, and it seems like the kind of thing I would like, but I don't quite know how to make it work in Rust today</p>



<a name="238522032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522032">(May 12 2021 at 18:30)</a>:</h4>
<p>I'd love to chat more about that idea</p>



<a name="238522033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522033">(May 12 2021 at 18:30)</a>:</h4>
<p>If you ignore the issue of side effects, it's really straightforward. :)</p>



<a name="238522047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522047">(May 12 2021 at 18:30)</a>:</h4>
<p>lol</p>



<a name="238522101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522101">(May 12 2021 at 18:30)</a>:</h4>
<p>And one way to ignore the issue of side-effects is to let the programmer <em>tell</em> you that they don't care if things run in parallel.</p>



<a name="238522139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522139">(May 12 2021 at 18:31)</a>:</h4>
<p>Rust is already way better than C# for that, actually, since <code>let (xy, yv) = join!(x(), y()).await;</code> works.</p>
<p>(The C# version of <code>join!</code> is <code>Task.WhenAll</code>, which isn't variadic so is a pain to use if the futures return non-unit.)</p>



<a name="238522211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522211">(May 12 2021 at 18:31)</a>:</h4>
<p>So, rather than (or in addition to) <code>parallel for</code>, I'd love to have:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">parallel</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">xv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">yv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">func</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span><span class="w"> </span><span class="n">yv</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="238522260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522260">(May 12 2021 at 18:31)</a>:</h4>
<p>that sounds cool!</p>



<a name="238522281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522281">(May 12 2021 at 18:31)</a>:</h4>
<p>And because it appears in a <code>parallel</code> block, you're <em>telling</em> the compiler that it's allowed to run anything in parallel that doesn't have a data dependency.</p>



<a name="238522388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522388">(May 12 2021 at 18:32)</a>:</h4>
<p>That would be the moral equivalent of rising <code>join!</code> to a lang construct, right?</p>



<a name="238522436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522436">(May 12 2021 at 18:32)</a>:</h4>
<p><span class="user-mention" data-user-id="119031">@Esteban Küber</span> That plus compiler-assisted data-dependency analysis, yeah.</p>



<a name="238522456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522456">(May 12 2021 at 18:32)</a>:</h4>
<p>also to super nitpick: I think we're talking about concurrency, not parallelism in the <code>async</code> case</p>



<a name="238522633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522633">(May 12 2021 at 18:33)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> Heh. I completely understand that nitpick, but I'd also say that it's the job of your async runtime to make sure your concurrent code <em>is</em> parallel whenever doing so would be a performance improvement. ;)</p>



<a name="238522765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522765">(May 12 2021 at 18:34)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> oh but that's an important distinction here! whether or not the code runs as part of the current async task vs. spawning a new task</p>



<a name="238522811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522811">(May 12 2021 at 18:34)</a>:</h4>
<p><code>.for_each_concurrent</code> does not spawn new tasks</p>



<a name="238522826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522826">(May 12 2021 at 18:34)</a>:</h4>
<p>it executes within the current task, concurrently</p>



<a name="238522841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522841">(May 12 2021 at 18:34)</a>:</h4>
<p>so you will get concurrency, but not parallelism</p>



<a name="238522899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238522899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238522899">(May 12 2021 at 18:35)</a>:</h4>
<p>That is, generally speaking, almost never going to be what I want. :)</p>



<a name="238523018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523018">(May 12 2021 at 18:35)</a>:</h4>
<p>Interesting! Do you feel the same way about <code>join!</code>? (that it isn't what you want?)</p>



<a name="238523140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523140">(May 12 2021 at 18:36)</a>:</h4>
<p>or <code>select</code> or any of the other "do two things at once" primitives that don't spawn separate tasks</p>



<a name="238523150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523150">(May 12 2021 at 18:36)</a>:</h4>
<p>With respect to <code>join!</code>, what I more often feel is "I should really use join, but I'm not going to bother, because it's much easier to just write straight-line code that runs <code>.await</code> repeatedly".</p>



<a name="238523305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523305">(May 12 2021 at 18:37)</a>:</h4>
<p>But to answer your actual question: I <em>wish</em> that I didn't have to make the distinction, and that I could more transparently run things in parallel.</p>



<a name="238523336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523336">(May 12 2021 at 18:37)</a>:</h4>
<p>It's interesting to me that your use-case doesn't care about whether or not tasks run concurrently, but you would care that they run in parallel?</p>



<a name="238523419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523419">(May 12 2021 at 18:38)</a>:</h4>
<p>Something I was doing in C# the other day:</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="k">await</span> <span class="nf">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">tracker</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskTracker</span><span class="p">(</span><span class="n">Concurrency</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">fileNames</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">tracker</span><span class="p">.</span><span class="n">TrackAsync</span><span class="p">(</span><span class="n">ProcessSingleEntry</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Delegating the "finish waiting on everything" to the <code>IAsyncDisposable</code>, and <code>TrackAsync</code> only blocks when there are "too many" futures running already, to avoid one such loop starving others.  (And would be fine if the loop were <code>await foreach</code>.)</p>
<p>But that's of course way easier in C# where tasks run in the background and everything is always boxed so types aren't an issue either :P</p>
<p>How does one do that kind of thing in Rust today, Taylor?</p>



<a name="238523420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523420">(May 12 2021 at 18:38)</a>:</h4>
<p>I didn't say I don't care, I said that I sometimes can't be bothered until a profile tells me that I should bother, because it's syntactically noisy. :)</p>



<a name="238523527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523527">(May 12 2021 at 18:39)</a>:</h4>
<p>For some of my async code, there's enough complexity there already that simplicity is more important than concurrency.</p>



<a name="238523555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523555">(May 12 2021 at 18:39)</a>:</h4>
<p>oh interesting-- I think we have very different defaults there</p>



<a name="238523737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523737">(May 12 2021 at 18:40)</a>:</h4>
<p>This is a recent development for me: <a href="https://mobile.twitter.com/josh_triplett/status/1316634750669344768">https://mobile.twitter.com/josh_triplett/status/1316634750669344768</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://mobile.twitter.com/josh_triplett/status/1316634750669344768"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/0e87f45dbbd509b633dff4f4364ee0d54a2ef45e/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313136303234393937303231353039363332312f61367873334f6f475f6e6f726d616c2e6a7067"></a><p>I love TWiR's quote of the week this week: "Just because Rust allows you to write super cool non-allocating zero-copy algorithms safely, doesn’t mean every algorithm you write should be super cool, zero-copy and non-allocating."

This resonates with me in <a href="https://twitter.com/rustlang">@rustlang</a> lately. 🧵 <a href="https://t.co/0X2jIMXbbG">https://twitter.com/ThisWeekInRust/status/1316600316356247554</a></p><span>- Josh Triplett (@josh_triplett)</span></div></div>



<a name="238523752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523752">(May 12 2021 at 18:40)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> <code>FuturesUnordered</code> is the building block for all of that kind of thing today. You can append futures to it, and it will act as a stream of all the results as they are available</p>



<a name="238523814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523814">(May 12 2021 at 18:40)</a>:</h4>
<p>that's how <code>.for_each_concurrent(MAX_NUMBER_OF_CONCURRENT_TASKS, |item| async move { ... }).await</code> works</p>



<a name="238523887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523887">(May 12 2021 at 18:41)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> So, how today would you write the equivalent of <code>for_each_parallel</code>?</p>



<a name="238523945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238523945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238523945">(May 12 2021 at 18:42)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> you mean how would I write that <code>for-each_concurrent</code> loop, but with the children actually running in separate tasks?</p>



<a name="238524046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524046">(May 12 2021 at 18:42)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> I want to ask that question slightly more generally, because "separate tasks" is an implementation detail. How would you write that if you want to make sure they <em>can</em> take advantage of a multi-core CPU?</p>



<a name="238524137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524137">(May 12 2021 at 18:43)</a>:</h4>
<p>where "can take advantage of" means "the bodies of my loop can run on multiple cores at once"</p>



<a name="238524151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524151">(May 12 2021 at 18:43)</a>:</h4>
<p>Yes, precisely.</p>



<a name="238524186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524186">(May 12 2021 at 18:43)</a>:</h4>
<p>I'd use <code>spawn_with_handle</code> inside the bodies of the <code>for_each_concurrent</code></p>



<a name="238524201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524201">(May 12 2021 at 18:43)</a>:</h4>
<p><a href="https://docs.rs/futures/0.3.15/futures/task/trait.SpawnExt.html#method.spawn_with_handle">https://docs.rs/futures/0.3.15/futures/task/trait.SpawnExt.html#method.spawn_with_handle</a></p>



<a name="238524277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524277">(May 12 2021 at 18:44)</a>:</h4>
<p>(Was just searching for that.)</p>



<a name="238524284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524284">(May 12 2021 at 18:44)</a>:</h4>
<p>(or whatever the version is for <code>tokio</code> or <code>async-std</code> or whatever I'm using-- these APIs are all duplicated all over the place like crazy right now, which makes this all a mess)</p>



<a name="238524322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524322">(May 12 2021 at 18:44)</a>:</h4>
<p>Yeah, I'd really love to see some of the common bits standardized at this point, but that's another topic.</p>



<a name="238524438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524438">(May 12 2021 at 18:45)</a>:</h4>
<p>So, effectively, you'd have a bunch of bits of the <em>same</em> task running concurrently, that are each awaiting values from separate tasks running in parallel?</p>



<a name="238524481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524481">(May 12 2021 at 18:45)</a>:</h4>
<p>Yes</p>



<a name="238524710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524710">(May 12 2021 at 18:46)</a>:</h4>
<p>I think that's roughly how I'd have written it as well, modulo spelling <code>spawn_with_handle</code> as <a href="https://docs.rs/smol/1.2.5/smol/fn.unblock.html"><code>unblock</code></a> iff I'm doing non-trivial computation as well.</p>



<a name="238524712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524712">(May 12 2021 at 18:46)</a>:</h4>
<p>Though in practice, I rarely care that these loops run in parallel when I'm writing async code: non-blocking is much more important to my uses of <code>async</code> than "this loop body must be able to run on multiple CPUs at once"</p>



<a name="238524813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524813">(May 12 2021 at 18:47)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> yes, there's a difference between how you'd treat CPU-blocking code, for sure</p>



<a name="238524869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524869">(May 12 2021 at 18:47)</a>:</h4>
<p>My <code>async</code> usages have rarely involved CPU-intensive code</p>



<a name="238524987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238524987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238524987">(May 12 2021 at 18:48)</a>:</h4>
<p>I generally find that I'm mixing both in one program.</p>



<a name="238525030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525030">(May 12 2021 at 18:48)</a>:</h4>
<p>Or rather, CPU-intensive code was always delegated to a separate blocking pile of code in a separate module or something</p>



<a name="238525044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525044">(May 12 2021 at 18:48)</a>:</h4>
<p>^^ interesting</p>



<a name="238525071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525071">(May 12 2021 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238525030">said</a>:</p>
<blockquote>
<p>Or rather, CPU-intensive code was always delegated to a separate blocking pile of code in a separate module or something</p>
</blockquote>
<p>Right, that doesn't tend to be the case for me.</p>



<a name="238525123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525123">(May 12 2021 at 18:49)</a>:</h4>
<p>I also currently have some cases where I'm mixing threads with async code, the former for blocking and the latter for non-blocking.</p>



<a name="238525189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525189">(May 12 2021 at 18:49)</a>:</h4>
<p>Yeah, it sounds like <code>unblock</code> is what you'd want in those cases, then</p>



<a name="238525197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525197">(May 12 2021 at 18:50)</a>:</h4>
<p>It's been really useful to me that <code>flume</code> has both sync and async versions of its send and recv functions.</p>



<a name="238525283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525283">(May 12 2021 at 18:50)</a>:</h4>
<p>I sometimes have a thread calling <code>send</code> and a task calling <code>recv_async</code>.</p>



<a name="238525292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525292">(May 12 2021 at 18:50)</a>:</h4>
<p>but still <code>for_each_concurrent(... unblock...)</code>, not <code>for_each(...unblock...)</code></p>



<a name="238525327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525327">(May 12 2021 at 18:50)</a>:</h4>
<p>Right, that makes sense.</p>



<a name="238525393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525393">(May 12 2021 at 18:50)</a>:</h4>
<p>Okay, I've gotta hop off for now, but thanks for chatting-- this was interesting!</p>



<a name="238525419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525419">(May 12 2021 at 18:51)</a>:</h4>
<p>Likewise!</p>



<a name="238525701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238525701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238525701">(May 12 2021 at 18:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238520571">said</a>:</p>
<blockquote>
<p>Why is <code>for await</code> different than <code>for</code> in this way?</p>
</blockquote>
<p>The other piece I'd add to this is whether <code>for.await</code> being not what you want (because it should use <code>.for_each_concurrent</code>) is substantially different from <code>let x = x().await; let y = y().await;</code> being not what (because it should use <code>join!</code>).</p>
<p>It seems to me like <code>.await</code> is pretty blatantly "behave non-concurrently for _this_ function", and thus that happening for the loop as well is par for the course, even if it's sometimes (or often) not what's actually wanted.</p>



<a name="238529604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238529604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238529604">(May 12 2021 at 19:19)</a>:</h4>
<p>I started a thread for <code>parallel { ... }</code> at <a href="#narrow/stream/213817-t-lang/topic/parallel.2Fconcurrent.20blocks.20for.20async">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/parallel.2Fconcurrent.20blocks.20for.20async</a> .</p>



<a name="238531358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238531358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238531358">(May 12 2021 at 19:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/.60for.20await.60.20interest/near/238521923">said</a>:</p>
<blockquote>
<p>I've seen research languages that could do exactly that.</p>
</blockquote>
<p>also with Simon Marlow's Haxl in Haskell (e.g. <a href="https://youtu.be/sT6VJkkhy0o?t=805">https://youtu.be/sT6VJkkhy0o?t=805</a>)</p>
<div class="youtube-video message_inline_image"><a data-id="sT6VJkkhy0o" href="https://youtu.be/sT6VJkkhy0o?t=805"><img src="https://uploads.zulipusercontent.net/efdbb5c7c8fcc55eda5f44c441305f9dd40c86af/68747470733a2f2f692e7974696d672e636f6d2f76692f735436564a6b6b6879306f2f64656661756c742e6a7067"></a></div>



<a name="238541298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238541298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238541298">(May 12 2021 at 20:43)</a>:</h4>
<blockquote>
<p>It seems to me like .await is pretty blatantly "behave non-concurrently for _this_ function", and thus that happening for the loop as well is par for the course, even if it's sometimes (or often) not what's actually wanted.</p>
</blockquote>
<p>It's possible that folks would intuit that behavior correctly, but it might not occur to them why it isn't actually the thing that they want. I think we should try to design APIs that push folks to think about which version they want (<code>for await</code> vs. <code>for await concurrent</code> or whatever), rather than offering an easy, more discoverable built-in language feature for the option that (I think) is less likely to be what users want.</p>



<a name="238541488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238541488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238541488">(May 12 2021 at 20:45)</a>:</h4>
<p>It's possible that a common option would be to <code>for await</code> with a body that is just a <code>task_pool.push(async move { ... });</code>, and we would recommend that as a pattern, but I personally think that is less ergonomic than <code>my_stream.for_each_concurrent(...)</code>.</p>



<a name="238541523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238541523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238541523">(May 12 2021 at 20:45)</a>:</h4>
<p>^ <span class="user-mention" data-user-id="125270">@scottmcm</span></p>



<a name="238541968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238541968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238541968">(May 12 2021 at 20:48)</a>:</h4>
<p>Of course, we also still have to deal with the separate question of syntax and <code>?</code>-handling</p>



<a name="238547512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60for%20await%60%20interest/near/238547512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60for.20await.60.20interest.html#238547512">(May 12 2021 at 21:29)</a>:</h4>
<p>I think, unfortunately, that</p>
<blockquote>
<p>but it might not occur to them why it isn't actually the thing that they want.</p>
</blockquote>
<p>is just part of <code>await</code>.  It's not uncommon at all for me to give PR feedback saying things like "you probably don't want <code>(await FooAsync(), await BarAsync())</code>".  So I'm not sure this is really a <em>new</em> problem to <code>for.await</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>