<html>
<head><meta charset="utf-8"><title>IndexGet · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html">IndexGet</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261298174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261298174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261298174">(Nov 12 2021 at 19:17)</a>:</h4>
<p>I keep hitting cases where something like <code>IndexGet</code> (which doesn't always return a <code>&amp;T</code>) would be useful. I wonder if GATs changes the nature of the game here, actually, as we could offer a generalization of Index and IndexGet?</p>



<a name="261299351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261299351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Wrenn <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261299351">(Nov 12 2021 at 19:26)</a>:</h4>
<p>(What's <code>IndexGet</code>?)</p>



<a name="261300556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261300556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261300556">(Nov 12 2021 at 19:37)</a>:</h4>
<p>I did some similar thinking experiments before.  The most important use cases can be covered with a <code>DerefTake</code> and a <code>IndexTake</code> trait, without GAT actually needed. something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">IndexTake</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">index_take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span>: <span class="nc">Idx</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IndexTake</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="k">fn</span> <span class="nf">index_take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                 </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="261300795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261300795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261300795">(Nov 12 2021 at 19:39)</a>:</h4>
<p>We'll need to arrange this to take priority over <code>Index</code> during lookup though.</p>



<a name="261306065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261306065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261306065">(Nov 12 2021 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="219211">@Jack Wrenn</span> IndexGet is a theoretical trait for when you do <code>obj[index]</code> and get a by-value thing returned to you (T instead of a &amp;T or &amp;mut T)</p>



<a name="261306122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261306122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261306122">(Nov 12 2021 at 20:23)</a>:</h4>
<p>don't forget the discussions in rust-lang/rfcs:</p>
<ul>
<li><a href="https://github.com/rust-lang/rfcs/issues/997">https://github.com/rust-lang/rfcs/issues/997</a></li>
<li><a href="https://github.com/rust-lang/rfcs/pull/2953">https://github.com/rust-lang/rfcs/pull/2953</a></li>
<li>and more...</li>
</ul>



<a name="261306340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261306340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261306340">(Nov 12 2021 at 20:25)</a>:</h4>
<p>it might also return a different borrowed type, like <code>Ref&lt;'a, T&gt;</code></p>



<a name="261306515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261306515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261306515">(Nov 12 2021 at 20:27)</a>:</h4>
<p>I would like both Deref and Index to allow by-value returns</p>



<a name="261321033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261321033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261321033">(Nov 12 2021 at 22:44)</a>:</h4>
<p>Hmm, how would this overload the <code>&amp;</code> and <code>&amp;mut</code> versions?  With <code>[]</code> syntax giving back a place, returning something not a borrow is a bit awkward to merge in.</p>



<a name="261335620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261335620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261335620">(Nov 13 2021 at 03:05)</a>:</h4>
<p>A GAT version of <code>Borrow</code> would also be useful, for e.g. borrowed forms of enums:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">BorrowGat</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">borrow</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Bar</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span><span class="w"> </span><span class="n">Baz</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">FooBorrowed</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Bar</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">),</span><span class="w"> </span><span class="n">Baz</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">BorrowGat</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FooBorrowed</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">borrow</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="261377975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261377975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261377975">(Nov 13 2021 at 20:16)</a>:</h4>
<p>We would<br>
<strong>really</strong><br>
like that over here.</p>



<a name="261390128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261390128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261390128">(Nov 14 2021 at 01:06)</a>:</h4>
<p>Having worked with this and dropping it solely due to a lack of (perceived or maybe real) interest, I was wondering what use cases there are for this?</p>
<p>The SIMD case would want a by-value IndexMove, rather than a by-ref IndexGet copy right? Or is that one of those things that the by-ref one is fine as long as it can be optimized?</p>



<a name="261579771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261579771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261579771">(Nov 16 2021 at 00:07)</a>:</h4>
<p>Uhhh... all the names feel arbitrary to me and nomenclature gets confusing so I am just gonna explain my use case.</p>
<p>Our <code>Simd</code> type is functionally a Copy array that contains Copy values, but indexing into <code>Simd</code> returns references to the values in the SIMD type, when we should be able to return copies. This is actually somewhat Bad as we would like there to only rarely be a reference to these values, as ideally the values should live essentially entirely in registers and never <strong>have</strong> to touch the stack.</p>



<a name="261579928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/261579928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#261579928">(Nov 16 2021 at 00:09)</a>:</h4>
<p>Our length is also statically known as a const generic parameter, and we would like to never have to incur bounds checks on valid indexing. That may be too wishlisty but there are a bunch of cases where the proof for the index check would be trivial.</p>



<a name="262256826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/IndexGet/near/262256826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/IndexGet.html#262256826">(Nov 21 2021 at 19:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/213817-t-lang/topic/IndexGet/near/261579771">said</a>:</p>
<blockquote>
<p>Our <code>Simd</code> type is functionally a Copy array that contains Copy values, but indexing into <code>Simd</code> returns references to the values in the SIMD type, when we should be able to return copies. </p>
</blockquote>
<p>I'm guessing right now, you don't have the <code>Index</code> trait implemented for your <code>Simd</code> type? The signature for <code>IndexGet</code> would be something like <code>fn index_get(&amp;self, index: Idx) -&gt; Self::Output;</code>, which would still take a reference (but I assume we could mir-opt or compiler magic that out)?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>