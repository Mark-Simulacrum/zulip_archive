<html>
<head><meta charset="utf-8"><title>Exact semantics for match and drop glue emitted · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exact.20semantics.20for.20match.20and.20drop.20glue.20emitted.html">Exact semantics for match and drop glue emitted</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266517903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exact%20semantics%20for%20match%20and%20drop%20glue%20emitted/near/266517903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exact.20semantics.20for.20match.20and.20drop.20glue.20emitted.html#266517903">(Dec 31 2021 at 18:40)</a>:</h4>
<p>This is originated from <code>~const Drop</code>, but is applicable to non-const functions as well. The problem is best seen as the MIR output for two implementations of <code>Result::ok</code> with a minor change: (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=a208ee8b303c7a3cf2685ad9f259c8f8">play</a>)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wildcard</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bind_to_variable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I won't post the whole MIR output here, but let me illustrate this issue with a handwritten control flow graph:</p>
<div class="codehilite"><pre><span></span><code>           wildcard
              |
switch on discriminant for `x` ------------ `Ok`
              |                              |
            `Err`          Move `x` into return value as `Some(x)`
              |                              |
Set return value as `None`                   /
              |------------------------------
              |
switch on discriminant for `x` ------------ `Ok`
              |                              |
            `Err`                            |
              |                              |
    `drop(x: Result&lt;T, E&gt;)`                  /
              |------------------------------
              |
            return



       bind_to_variable
              |
switch on discriminant for `x` ------------- `Ok`
              |                               |
            `Err`          Move `x` into return value as `Some(x)`
              |                               |
   Move value in `Err` to `_x`                |
              |                               |
        `drop(_x: E)`                         |
              |                               |
    Set return value as `None`                /
              |-------------------------------
              |
            return
</code></pre></div>
<p><code>wildcard</code> is unexpectedly more complex and performs <code>switchInt</code> on <code>x</code> for two times instead of one. Are there are previous discussions/documentation for this behavior? It could be a breaking change but wouldn't it be better if we just generated code as the second graph instead?</p>



<a name="266518221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exact%20semantics%20for%20match%20and%20drop%20glue%20emitted/near/266518221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exact.20semantics.20for.20match.20and.20drop.20glue.20emitted.html#266518221">(Dec 31 2021 at 18:49)</a>:</h4>
<p>This does not look like a breaking change to me</p>



<a name="266518294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Exact%20semantics%20for%20match%20and%20drop%20glue%20emitted/near/266518294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Exact.20semantics.20for.20match.20and.20drop.20glue.20emitted.html#266518294">(Dec 31 2021 at 18:51)</a>:</h4>
<p>Any type that takes the place of <code>Result</code> in this sort of thing can't be <code>Drop</code>, because it's being destructured, so dropping <code>Err(e)</code> is exactly equivalent to dropping <code>e</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>