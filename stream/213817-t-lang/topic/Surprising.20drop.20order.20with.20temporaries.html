<html>
<head><meta charset="utf-8"><title>Surprising drop order with temporaries · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html">Surprising drop order with temporaries</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274744768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274744768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274744768">(Mar 09 2022 at 20:06)</a>:</h4>
<p>This example was recently shared on the subreddit, OP was surprised by the drop order: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=51d25e15b77bb5a1589dc92b325be80b">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=51d25e15b77bb5a1589dc92b325be80b</a><br>
That's a bit subtle, but I <em>thought</em> that this would fix the problem:</p>
<div class="codehilite"><pre><span></span><code>let s = S {
    a: { *cell.borrow_mut() + 1 },
    b: { *cell.borrow_mut() + 2 },
};
</code></pre></div>
<p>It doesn't, there is still a panic. What you need to do is something like this:</p>
<div class="codehilite"><pre><span></span><code>let s = S {
    a: { let t = *cell.borrow_mut() + 1; t },
    b: { let t = *cell.borrow_mut() + 2; t },
};
</code></pre></div>
<p>I'm not concerned with the ergonomics of this, but I am concerned about how to teach this. I have some pretty considerable experience with Rust and I just read the section on drop scopes, but I can't figure out why the <code>RefMut</code> created in those braces persists past the close brace.</p>



<a name="274745209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274745209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274745209">(Mar 09 2022 at 20:09)</a>:</h4>
<p>This is, I think, because the last expression in a block actually gets it's lifetime extended to the block itself. Or something like that. Basically there's something special here.</p>



<a name="274745321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274745321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274745321">(Mar 09 2022 at 20:10)</a>:</h4>
<p>From <a href="https://doc.rust-lang.org/reference/destructors.html?highlight=drop#temporary-scopes">https://doc.rust-lang.org/reference/destructors.html?highlight=drop#temporary-scopes</a>, isn't it " A statement"?</p>



<a name="274745438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274745438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274745438">(Mar 09 2022 at 20:11)</a>:</h4>
<p>The former is one big expression with no sub-statements, while the latter has multiple sub-statements.  I assume that's part of it.</p>



<a name="274745440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274745440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274745440">(Mar 09 2022 at 20:11)</a>:</h4>
<p>in the first, the smallest statement is the entire <code>let s</code>. In the second it's the <code>let t</code></p>



<a name="274747636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274747636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274747636">(Mar 09 2022 at 20:26)</a>:</h4>
<p>So it sounds like the problem here is misunderstanding that the braces themselves have any meaning</p>



<a name="274747811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274747811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274747811">(Mar 09 2022 at 20:28)</a>:</h4>
<p>Which is worse because the braces <em>do</em> have meaning different from parens sometimes (&lt;<a href="https://bluss.github.io/rust/fun/2015/10/11/stuff-the-identity-function-does/#rust-has-dedicated-syntax-for-this">https://bluss.github.io/rust/fun/2015/10/11/stuff-the-identity-function-does/#rust-has-dedicated-syntax-for-this</a>&gt;), just not here.</p>



<a name="274747981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274747981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274747981">(Mar 09 2022 at 20:29)</a>:</h4>
<p>This just seems nightmarish to teach, because apparently (unlike C++? Or maybe they're also wrong?) we can't talk about how the close brace is what causes destructors to run. It's the end of a...<br>
statement, <code>if</code>, <code>else</code>, <code>if</code> condition, match arm, <code>loop</code>, <code>for</code>, <code>while</code>, the <em>second</em> operand of a lazy boolean expression...</p>



<a name="274749194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274749194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274749194">(Mar 09 2022 at 20:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120827">Ben Kimock (Saethlin)</span> <a href="#narrow/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries/near/274744768">said</a>:</p>
<blockquote>
<p>That's a bit subtle, but I <em>thought</em> that this would fix the problem:</p>
<p><div class="codehilite"><pre><span></span><code>let s = S {
    a: { *cell.borrow_mut() + 1 },
    b: { *cell.borrow_mut() + 2 },
};
</code></pre></div><br>
</p>
</blockquote>
<p>A thought: maybe open an issue to add a lint for this?  It would make sense to me to have a lint for "you used braces but could just use parens because they'd do the same thing".</p>
<p>That doesn't solve the core issue, but might at least have helped you know that the change to braces wouldn't help.</p>



<a name="274755359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274755359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274755359">(Mar 09 2022 at 21:32)</a>:</h4>
<p>In the same vein as that lint would be one for replacing the <code>{}</code> with <code>()</code> (or removing altogether):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_x</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">{</span><span class="o">*</span><span class="n">s</span><span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>Note the same happens with <code>unsafe {}</code> and I'd bet <code>async</code> or <code>try</code>, although it's less likely someone would try those.</p>



<a name="274842125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274842125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274842125">(Mar 10 2022 at 14:30)</a>:</h4>
<p>I personally would rather lean towards having scoped APIs on locks than trying to perform breaking changes on drop of temporaries: when drop order matters that much, then a scope ought to be used:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">cell</span><span class="p">.</span><span class="n">with_borrow_mut</span><span class="p">(</span><span class="o">|</span><span class="n">it</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">cell</span><span class="p">.</span><span class="n">with_borrow_mut</span><span class="p">(</span><span class="o">|</span><span class="n">it</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="274842692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274842692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274842692">(Mar 10 2022 at 14:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries/near/274747811">said</a>:</p>
<blockquote>
<p>Which is worse because the braces <em>do</em> have meaning different from parens sometimes (&lt;<a href="https://bluss.github.io/rust/fun/2015/10/11/stuff-the-identity-function-does/#rust-has-dedicated-syntax-for-this">https://bluss.github.io/rust/fun/2015/10/11/stuff-the-identity-function-does/#rust-has-dedicated-syntax-for-this</a>&gt;), just not here.</p>
</blockquote>
<p>It's not that inconsistent: <code>{ … }</code> acts like <code>identity(…)</code>, and I don't really see any "end of statement" for these two things:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="o">*</span><span class="n">cell</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="nc">identity</span><span class="p">(</span><span class="o">*</span><span class="n">cell</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I've personally found that a nice rule of thumb is that temporaries are dropped at <code>;</code>, or at the end of a <em>function body</em>; that the popular belief of "at the end of any block" is wrong.</p>
<hr>
<p>(now, the <code>false || &lt;expr&gt;</code> case, on the other hand, is <em>very</em> surprising (no <code>;</code>) ; I guess it was made to avoid the need for drop flags)</p>



<a name="274901434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274901434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274901434">(Mar 10 2022 at 22:01)</a>:</h4>
<blockquote>
<p>I personally would rather lean towards having scoped APIs on locks than trying to perform breaking changes on drop of temporaries: when drop order matters that much, then a scope ought to be used:</p>
</blockquote>
<p>I like those APIs (but breaking changes have AFAIK not been proposed above, just lints)</p>



<a name="274908013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274908013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274908013">(Mar 10 2022 at 22:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries/near/274842692">said</a>:</p>
<blockquote>
<p>(now, the <code>false || &lt;expr&gt;</code> case, on the other hand, is <em>very</em> surprising (no <code>;</code>) ; I guess it was made to avoid the need for drop flags)</p>
</blockquote>
<p>Why would it be surprising? It seems to act the same as <code>if false { &lt;expr&gt; } else { false }</code>, which has the same drop behavior. You can't lift the temporary out of the if statement without making it evaluate too early, so having the destructor being delayed past the scope seems very wrong to me.</p>



<a name="274910794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/Surprising%20drop%20order%20with%20temporaries/near/274910794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries.html#274910794">(Mar 10 2022 at 23:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/Surprising.20drop.20order.20with.20temporaries/near/274908013">said</a>:</p>
<blockquote>
<p>You can't lift the temporary out of the if statement without making it evaluate too early</p>
</blockquote>
<p>There's <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=eae18f56dfc1ed5710a2c3ba53142fd1">this</a> trick:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">s</span>: <span class="nb">String</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">something</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">s</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"something else"</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>But it does make sense to me that a <code>let</code> inside the <code>then</code> block doesn't do that automatically.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>