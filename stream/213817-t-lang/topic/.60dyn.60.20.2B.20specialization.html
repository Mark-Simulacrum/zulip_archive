<html>
<head><meta charset="utf-8"><title>`dyn` + specialization · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html">`dyn` + specialization</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264038310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264038310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264038310">(Dec 07 2021 at 17:35)</a>:</h4>
<p>Hey all, I wrote <a href="https://blog.yoshuawuyts.com/uninit-read-write/">a post</a> on writing into uninitialized memory across trait boundaries. It got me wondering: what are the limitations between dynamic dispatch and specialization, if there are any?</p>
<p>I found <a href="https://paper.dropbox.com/doc/IO-Buffer-Initialization--BXrMP0u_xTZ5lGsyqSiNHxCsAg-MvytTgjIOTNpJAS6Mvw38">these notes</a> from a while back which alludes to specialization and <code>dyn</code> being mutually exclusive. I asked colleagues what the state of this is in C++, and it appears <a href="https://paper.dropbox.com/doc/IO-Buffer-Initialization--BXrMP0u_xTZ5lGsyqSiNHxCsAg-MvytTgjIOTNpJAS6Mvw38">it is possible to combine the two</a>.</p>
<p>My knowledge of both specialization and dynamic dispatch is limited. So I wanted to ask here if folks might be able to explain what restrictions exist, and whether those could potentially be lifted in the future. Thanks!</p>



<a name="264042696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264042696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264042696">(Dec 07 2021 at 17:52)</a>:</h4>
<p>Seems to be the wrong link for the C++ notes</p>



<a name="264042858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264042858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264042858">(Dec 07 2021 at 17:53)</a>:</h4>
<p>I think C++ folks talking about specialisation mean argument overloading? I don’t know what specialisation in the rust sense would look like in c++</p>



<a name="264042879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264042879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264042879">(Dec 07 2021 at 17:53)</a>:</h4>
<p>I don't see any particular conflict between dyn and specialization.</p>



<a name="264043022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264043022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264043022">(Dec 07 2021 at 17:54)</a>:</h4>
<p>At the point where you create the vtable, you have all the info you need to reliably resolve to a particular set of functions</p>



<a name="264043359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264043359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264043359">(Dec 07 2021 at 17:56)</a>:</h4>
<p>That said, there are <em>some</em> potential interactions. For example, I have been working with <span class="user-mention" data-user-id="116883">@tmandry</span> on this "dyner" idea, basically finding ways to lift some of the limitations around dyn-safety, and some of those could interact with specialization.</p>
<p>Example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Debug</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'd like to make that trait dyn safe, but the way that would work is that the <code>impl Debug</code> would wind up "casted" to a <code>&amp;dyn Debug</code>, essentially, for dynamic dispatch. In that case, some things you might try with specialization on the other side might not work, since they would observe the type as <code>&amp;dyn Debug</code> instead of the original type.</p>



<a name="264152106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264152106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264152106">(Dec 08 2021 at 13:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization/near/264042858">said</a>:</p>
<blockquote>
<p>I think C++ folks talking about specialisation mean argument overloading? I don’t know what specialisation in the rust sense would look like in c++</p>
</blockquote>
<p>Isn't C++ template specialization basically the same thing as rust specialization?</p>



<a name="264152311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264152311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264152311">(Dec 08 2021 at 13:13)</a>:</h4>
<p>Yeah, it's fairly close, though the former is currently (and probably will remain) more powerful.</p>



<a name="264153422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264153422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264153422">(Dec 08 2021 at 13:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization/near/264042696">said</a>:</p>
<blockquote>
<p>Seems to be the wrong link for the C++ notes</p>
</blockquote>
<p>oops, fixed!</p>



<a name="264155188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264155188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264155188">(Dec 08 2021 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization/near/264042858">said</a>:</p>
<blockquote>
<p>I think C++ folks talking about specialisation mean argument overloading? I don’t know what specialisation in the rust sense would look like in c++</p>
</blockquote>
<p><a href="https://godbolt.org/z/zKcss4sd6">The example</a> dispatches to a different function in the v-table depending on which class it's called on, and the type of the data passed. It also also includes "default" semantics, using <code>std::span&lt;char&gt;</code> as the default implementation. Even though the ergonomics aren't as nice as Rust's, the semantics should roughly map to <code>dyn</code> + specialization in Rust.</p>



<a name="264156896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264156896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264156896">(Dec 08 2021 at 13:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization/near/264043359">said</a>:</p>
<blockquote>
<p>I'd like to make that trait dyn safe, but the way that would work is that the <code>impl Debug</code> would wind up "casted" to a <code>&amp;dyn Debug</code>, essentially, for dynamic dispatch. In that case, some things you might try with specialization on the other side might not work, since they would observe the type as <code>&amp;dyn Debug</code> instead of the original type.</p>
</blockquote>
<p>I seee!</p>



<a name="264157515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264157515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264157515">(Dec 08 2021 at 13:52)</a>:</h4>
<p>It sounds like specialization could maybe use an attribute to the effect of: "This specialization is load-bearing; warn / error if it becomes unreachable."</p>



<a name="264157588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/%60dyn%60%20%2B%20specialization/near/264157588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/.60dyn.60.20.2B.20specialization.html#264157588">(Dec 08 2021 at 13:53)</a>:</h4>
<p>But overall this is really cool though; I'm happy to hear that <code>dyn</code> + specialization is not inherently incompatible! :D</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>