<html>
<head><meta charset="utf-8"><title>design meeting 2021-11-24 · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html">design meeting 2021-11-24</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262618462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262618462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262618462">(Nov 24 2021 at 17:28)</a>:</h4>
<p>I am not going to be able to make the design meeting today <span class="user-group-mention" data-user-group-id="1977">@T-lang</span>.</p>



<a name="262621941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262621941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262621941">(Nov 24 2021 at 18:00)</a>:</h4>
<p>I cannot make it either</p>



<a name="262622489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622489">(Nov 24 2021 at 18:04)</a>:</h4>
<p>Looks like the zoom meeting hasn't been started?</p>



<a name="262622512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622512">(Nov 24 2021 at 18:05)</a>:</h4>
<p>I'm in the meeting as well, and it doesn't look like it has started.</p>



<a name="262622547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622547">(Nov 24 2021 at 18:05)</a>:</h4>
<p>/me is wondering if the problem is that I don't have the requisite permissions to kick off the meeting whose link is in the calendar invite.</p>



<a name="262622812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622812">(Nov 24 2021 at 18:07)</a>:</h4>
<p>/me will make a new meeting room.</p>



<a name="262622827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622827">(Nov 24 2021 at 18:07)</a>:</h4>
<p>Hmm, so what do we do now?</p>



<a name="262622923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622923">(Nov 24 2021 at 18:08)</a>:</h4>
<p><a href="https://meet.jit.si/BvELIHv4KtF4rBLO">https://meet.jit.si/BvELIHv4KtF4rBLO</a></p>



<a name="262622965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622965">(Nov 24 2021 at 18:08)</a>:</h4>
<p>The one in the calendar invite just started.</p>



<a name="262622981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262622981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262622981">(Nov 24 2021 at 18:08)</a>:</h4>
<p>Oh! Going back and joining that then.</p>



<a name="262623106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262623106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262623106">(Nov 24 2021 at 18:10)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="127859">@Taylor Cramer</span></p>



<a name="262623359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262623359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262623359">(Nov 24 2021 at 18:11)</a>:</h4>
<p><a href="https://gist.github.com/Amanieu/e30b9d6ad36b011125d8d3a01e0e622b">https://gist.github.com/Amanieu/e30b9d6ad36b011125d8d3a01e0e622b</a></p>



<a name="262624063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262624063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262624063">(Nov 24 2021 at 18:18)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="1977">@T-lang</span> folks, while I can't attend, I did want to point out one interesting data point:</p>
<p>The <a href="https://www.micahlerner.com/assets/papers/rudra.pdf">Rudra project</a> -- great paper! -- pointed out that panic safety is a particular source of problems in unsafe code:</p>
<blockquote>
<p>Due to their subtlety, panic safety violations have caused several memory safety bugs in popular Rust packages [1, 4, 5] and the Rust standard library [7, 10, 12]</p>
</blockquote>
<p>My experience with Rayon was that while it was plausible for me to audit the sources of panics from explicit closure calls or generic operations, identifying panics that might result from drops was beyond my capabilities. I wound up just adding a "abort on panic" guard. It's possible that a lint against "possible panics" would have helped, but I think that in general such a lint + disallowing panic in drop would help even more.</p>



<a name="262624385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262624385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262624385">(Nov 24 2021 at 18:21)</a>:</h4>
<p>Are folks done reading? <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> for done, <span aria-label="book" class="emoji emoji-1f4d6" role="img" title="book">:book:</span> for still reading.</p>



<a name="262629335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262629335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262629335">(Nov 24 2021 at 19:06)</a>:</h4>
<p>Thank you, <span class="user-mention" data-user-id="143274">@Amanieu</span>!  Great meeting.</p>



<a name="262634173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262634173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262634173">(Nov 24 2021 at 19:58)</a>:</h4>
<p>Capturing the hackmd link so we can find it later: <a href="https://hackmd.io/bTzkjcODSDWREJSRAEhRlQ">https://hackmd.io/bTzkjcODSDWREJSRAEhRlQ</a></p>



<a name="262636272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262636272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262636272">(Nov 24 2021 at 20:21)</a>:</h4>
<p>Regarding <code>drain_filter</code>, there currently doesn't seem much momentum towards stabilization or people discussing new designs. There are several tracking issues for the different collections, not a central one for drain_filter in general, I think. A new ticket stating the need that they all need their drop behavior changed would help.</p>



<a name="262636641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262636641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262636641">(Nov 24 2021 at 20:24)</a>:</h4>
<blockquote>
<p>Amanieu: Yes, we call the panic hook. But then we eventually abort before we escape the drop.</p>
</blockquote>
<p>Could someone put a <code>while (!waiting_for_other_threads()) {thread::yield();}</code>into the panic hook for the webserver case? And would it be a good idea?</p>



<a name="262636692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262636692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262636692">(Nov 24 2021 at 20:25)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> That's roughly what we outlined in the meeting as something people might want to do (modulo implementation details).</p>



<a name="262637074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262637074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262637074">(Nov 24 2021 at 20:29)</a>:</h4>
<p>Yeah, that is the obvious followup question but it seems iffy, e.g. code might deadlock because something is frozen in what would normally drop a lock guard for example.</p>



<a name="262637442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262637442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262637442">(Nov 24 2021 at 20:33)</a>:</h4>
<p>Something that percolated up in my brain: does more usage of <code>ManuallyDrop</code> help any of these scenarios?</p>
<p>Certainly writing code that "pre-leaks" by putting something into a <code>ManuallyDrop</code> is less UB-prone than something that needs to get to a <code>forget</code> call.</p>
<p>For example, we could deprecate <code>catch_unwind</code> in favour of something that's <code>-&gt; Result&lt;ManuallyDrop&lt;R&gt;&gt;</code> instead of <code>-&gt; Result&lt;R&gt;</code> to defuse that particular bomb.</p>



<a name="262639248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262639248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262639248">(Nov 24 2021 at 20:54)</a>:</h4>
<p>It might help in some cases but not where unsafe code interacts with "normal" safe stuff that isn't tailored for the extra carefulness that unsafe needs.<br>
Especially when the thing the unsafe code does is dropping something</p>



<a name="262640185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262640185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262640185">(Nov 24 2021 at 21:03)</a>:</h4>
<p>Code using <code>ManuallyDrop</code> is more leak-prone since it doesn't benefit from the automatic "continue trying to drop the next member on unwind" behavior that normal struct fields have.</p>



<a name="262696004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262696004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262696004">(Nov 25 2021 at 11:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-11-24/near/262637442">said</a>:</p>
<blockquote>
<p>Certainly writing code that "pre-leaks" by putting something into a <code>ManuallyDrop</code> is less UB-prone than something that needs to get to a <code>forget</code> call.</p>
<p>For example, we could deprecate <code>catch_unwind</code> in favour of something that's <code>-&gt; Result&lt;ManuallyDrop&lt;R&gt;&gt;</code> instead of <code>-&gt; Result&lt;R&gt;</code> to defuse that particular bomb.</p>
</blockquote>
<p>Yes, <code>forget</code> is an anti-pattern, imho (if anything, because of Stacked Borrows). Anecdotically, I once wrote a custom lint that guarded against it when when toying with <code>dylint</code>, precisely to suggest using  <code>ManuallyDrop</code> instead.</p>
<ol>
<li><code>forget</code> -&gt; <code>ManuallyDrop::new()</code> can always be done</li>
<li>At that point moving the <code>ManuallyDrop</code> "as up as possible" becomes easier, leading to less error-prone code.</li>
</ol>
<hr>
<p>In the case of <code>catch_unwind</code>, however, <code>ManuallyDrop</code> isn't really the tool (it would kind of leak unnecessarily). For that I'd rather use a <code>-&gt; … DropCantUnwind&lt;R&gt;</code> instead:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(transparent)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DropCantUnwind</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MD</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Deref</span><span class="p">{,</span><span class="n">Mut</span><span class="p">}</span><span class="err">…</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="err">…</span><span class="w"> </span><span class="k">fn</span> <span class="nf">into_inner</span><span class="p">()</span><span class="err">…</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DropCantUnwind</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="nc">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>::<span class="n">scopeguard</span>::<span class="n">defer_on_unwind</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">"Aborting"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">MD</span>::<span class="nb">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But the <code>catch_unwind</code> situation had already been discussed, right? Because of retro-compat the hands are kind of tied. Although for that particual case the <code>repr(transparent)</code> could be abused to either lie about the <code>TypeId</code>, or to overwrite the virtual destructor.</p>



<a name="262696171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/design%20meeting%202021-11-24/near/262696171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/design.20meeting.202021-11-24.html#262696171">(Nov 25 2021 at 11:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/design.20meeting.202021-11-24/near/262624063">said</a>:</p>
<blockquote>
<p>It's possible that a lint against "possible panics" would have helped, but I think that in general such a lint + disallowing panic in drop would help even more.</p>
</blockquote>
<p>Such a lint would be very useful in <em>many</em> places, unwind safety being a no small one! I'd start off that and see how the situation evolves</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>