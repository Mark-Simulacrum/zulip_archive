<html>
<head><meta charset="utf-8"><title>poor no_mangle and deny(unsafe_code) lint interaction. · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html">poor no_mangle and deny(unsafe_code) lint interaction.</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263106464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263106464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263106464">(Nov 30 2021 at 06:34)</a>:</h4>
<p>If you have <code>deny(unsafe_code)</code> on a module, but you want to have a single unmangled function within it, then <code>no_mangle</code> on that function requires also <code>allow(unsafe_code)</code> on that function. However, because the allow lint applies to the <em>entire</em> function contents, not just the one usage of the attribute, you're now allowing in potentially quite a bit more unsafe code than you intended.</p>
<p>I don't really have a suggested fix here, I just encountered this for the first time right now and thought it was something worth pondering.</p>



<a name="263106680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263106680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263106680">(Nov 30 2021 at 06:39)</a>:</h4>
<p>I can see two possible paths towards a solution there.</p>



<a name="263106729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263106729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263106729">(Nov 30 2021 at 06:40)</a>:</h4>
<p>1) Support more narrowly scoping<code>allow</code> around an attribute without the thing the attribute is attached to.</p>



<a name="263106740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263106740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263106740">(Nov 30 2021 at 06:41)</a>:</h4>
<p>2) Support separating the attribute, such as <code>#[no_mangle] pub use name_that_will_be_mangled as unmangled_name;</code></p>



<a name="263107119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107119">(Nov 30 2021 at 06:48)</a>:</h4>
<p>3) <code>#[unsafe_no_mangle]</code> which works within <code>deny(unsafe_code)</code> but not <code>forbid(unsafe_code)</code></p>



<a name="263107135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107135">(Nov 30 2021 at 06:49)</a>:</h4>
<p>4) write the unmangled function to be just a single call to a mangled function without an allow attribute</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="cp">#[allow(unsafe_code)]</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">main_</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main_</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// actual program here</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="263107264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107264">(Nov 30 2021 at 06:52)</a>:</h4>
<p>For (4) I think you might want <code>#[inline(always)]</code> but sure, that seems reasonable.</p>



<a name="263107274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107274">(Nov 30 2021 at 06:52)</a>:</h4>
<p>For (3) I don't think we want a way to bust out of <code>deny(unsafe_code)</code> without writing <code>allow(unsafe_code)</code>.</p>



<a name="263107457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107457">(Nov 30 2021 at 06:57)</a>:</h4>
<p>yeah, my thought was that by putting the word "unsafe" still in the attribute name it'd still be visible to people, and greppable</p>



<a name="263107621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107621">(Nov 30 2021 at 07:00)</a>:</h4>
<p>6) Consider <code>#[allow(unsafe_code(no_mangle))]</code> being an allowed form (bikeshed the exact way you write it down)</p>



<a name="263107837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107837">(Nov 30 2021 at 07:04)</a>:</h4>
<p>Your (6) is roughly my (1).</p>



<a name="263107914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107914">(Nov 30 2021 at 07:06)</a>:</h4>
<p>(I think I'd spell it roughly <code>#[bikeshed(allow(unsafe_code), no_mangle)]</code>, where <code>bikeshed</code> evokes "scope" and "attr".)</p>



<a name="263107922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263107922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263107922">(Nov 30 2021 at 07:06)</a>:</h4>
<p>(In a spirit vaguely similar to <code>cfg_attr</code>.)</p>



<a name="263137572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/poor%20no_mangle%20and%20deny%28unsafe_code%29%20lint%20interaction./near/263137572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/poor.20no_mangle.20and.20deny(unsafe_code).20lint.20interaction.2E.html#263137572">(Nov 30 2021 at 12:36)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow_attr(unsafe_code, no_mangle)]</span><span class="w"></span>
</code></pre></div>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> </p>
<p>There is always the option of writing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unsafe_code)]</span><span class="w"></span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[deny(unsafe_code)]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// …</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>(But I'll admit that the rightward drift ain't nice, and that a macro may be a bit overkill for this. But FWIW, <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7123bc9e5a2b2edc6dff66ef7663c067">here is a macro</a> one could use with <a href="https://docs.rs/macro_rules_attribute"><code>#[apply(allowed_unsafe_no_mangle!)]</code></a>).</li>
</ul>
<p>Which now makes me think of:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unsafe_code)]</span><span class="w"></span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="cp">#[deny(unsafe_code)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// …</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That one seems like it would be the nicer way to achieve this, although I could imagine it being hard to implement in practice?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>