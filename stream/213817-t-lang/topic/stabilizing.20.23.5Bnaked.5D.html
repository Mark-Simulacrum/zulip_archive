<html>
<head><meta charset="utf-8"><title>stabilizing #[naked] · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html">stabilizing #[naked]</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269720064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/269720064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#269720064">(Jan 28 2022 at 11:15)</a>:</h4>
<p>I'm currently writing up a proposal to stabilize the <code>#[naked]</code> attribute. One thing that I'd like to make note of is that this feature has some overlap with the soon-to-be-stable <code>global_asm!</code>, and I'm wondering whether there's anyone who feels like these two features are so similar that they would object to the stabilization of <code>#[naked]</code>. <span class="user-mention" data-user-id="143274">@Amanieu</span> , any thoughts?</p>



<a name="269720214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/269720214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#269720214">(Jan 28 2022 at 11:17)</a>:</h4>
<p>I'm happy to stabilize <code>#[naked]</code> as it is. It has several advantages over <code>global_asm!</code>, such as the ability to have generic naked functions (though currently that's not too useful due to the lack of <code>sym</code> and <code>const</code>).</p>



<a name="269720440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/269720440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#269720440">(Jan 28 2022 at 11:19)</a>:</h4>
<p>And in general it's much easier to use than <code>global_asm!</code> since it avoids the need to use <a href="https://gist.github.com/Amanieu/b7523fa69adf5cefab3ab5269602d4db">this</a> when defining functions.</p>



<a name="269720510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/269720510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#269720510">(Jan 28 2022 at 11:19)</a>:</h4>
<p>(which is in fact still incomplete since it doesn't handle the leading underscore on 32-bit windows)</p>



<a name="270140173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270140173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeremiah Senkpiel <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270140173">(Feb 01 2022 at 02:09)</a>:</h4>
<p>Is there no clearer name for this feature?</p>



<a name="270140388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270140388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270140388">(Feb 01 2022 at 02:12)</a>:</h4>
<p><code>naked</code> is what LLVM calls it, FWIW: <a href="https://llvm.org/docs/LangRef.html#function-attributes">https://llvm.org/docs/LangRef.html#function-attributes</a></p>



<a name="270142202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270142202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270142202">(Feb 01 2022 at 02:37)</a>:</h4>
<p>I wonder if it should be held off while <a class="stream" data-stream-id="216763" href="/#narrow/stream/216763-project-inline-asm">#project-inline-asm</a> is in debate.</p>



<a name="270150427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270150427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270150427">(Feb 01 2022 at 04:20)</a>:</h4>
<p>if i were to pick a different name, i might pick <code>#[asm]</code> or <code>#[only_asm]</code> or <code>#[asm_fn]</code></p>



<a name="270151265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270151265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270151265">(Feb 01 2022 at 04:31)</a>:</h4>
<p>from an ergonomics perspective, it might be nice to write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[asm]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">my_add</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s">"lea rax, [rsi + rdi]"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">"ret"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">options</span><span class="p">(</span><span class="n">pure</span><span class="p">,</span><span class="w"> </span><span class="n">nomem</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>rather than:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[naked]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">my_add</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s">"lea rax, [rsi + rdi]"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">"ret"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">options</span><span class="p">(</span><span class="n">pure</span><span class="p">,</span><span class="w"> </span><span class="n">nomem</span><span class="p">,</span><span class="w"> </span><span class="n">noreturn</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270160827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270160827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270160827">(Feb 01 2022 at 06:52)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> "in debate"? It's shipped in stable at this point.</p>



<a name="270173648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270173648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270173648">(Feb 01 2022 at 09:10)</a>:</h4>
<p>The use of comma terminated lines in a braced block looks off to me. Using <code>;</code> instead would make sense from some points of view, although it's not great edit-distance-wise from the asm block</p>



<a name="270189346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270189346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270189346">(Feb 01 2022 at 11:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270160827">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> "in debate"? It's shipped in stable at this point.</p>
</blockquote>
<p>It's not on stable for another 4 weeks as far as I know. If you see the channel I've been trying to get certain promises reversed before that happens, and rust stabilizes the existance of the LLVM Assembler, to the detriment of <em>anything other than llvm</em>.</p>



<a name="270196106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270196106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270196106">(Feb 01 2022 at 11:56)</a>:</h4>
<blockquote>
<p>Assembly code that does not conform to the GAS syntax will result in assembler-specific behavior.</p>
</blockquote>



<a name="270197251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270197251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270197251">(Feb 01 2022 at 12:07)</a>:</h4>
<p>I overall agree with the sentiment that <code>asm!()</code> will make life harder for non-llvm based rust compilers. The same applies to <code>core::arch</code> which unlike <code>asm!()</code> can't be polyfilled using gas as external assembler, but requires implementing almost every single individual intrinsic. The vendor intrinsics in <code>core::arch</code> implemented using <code>extern "platform-intrinsic"</code> have been easy to support as these use only a couple of intrinsics internally. However those implemented using LLVM intrinsics require a lot of effort. This is a lot harder than writing a couple hundred lines of code to produce assembly gas can compile.</p>



<a name="270199128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270199128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270199128">(Feb 01 2022 at 12:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270197251">said</a>:</p>
<blockquote>
<p>I overall agree with the sentiment that <code>asm!()</code> will make life harder for non-llvm based rust compilers. The same applies to <code>core::arch</code> which unlike <code>asm!()</code> can't be polyfilled using gas as external assembler, but requires implementing almost every single individual intrinsic. The vendor intrinsics in <code>core::arch</code> implemented using <code>extern "platform-intrinsic"</code> have been easy to support as these use only a couple of intrinsics internally. However those implemented using LLVM intrinsics require a lot of effort. This is a lot harder than writing a couple hundred lines of code to produce assembly gas can compile.</p>
</blockquote>
<p>TBH, those are less difficult than having to implement a full on macro assembler. At worst, they can be implemented using <code>asm</code>.</p>



<a name="270199609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270199609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270199609">(Feb 01 2022 at 12:23)</a>:</h4>
<p>Maybe, but there are already two assemblers you can use in non-llvm backends (gcc's gas and llvm's llvm-as), while each vendor intrinsics need to be individually implemented for each backend.</p>



<a name="270200136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270200136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270200136">(Feb 01 2022 at 12:26)</a>:</h4>
<p>Both of those have issues I've extensively detailed in the relavant threads. The TL;DR is: GAS can't be built on or for an msvc host, and llvm-as carries with it a massive dependency (all of llvm) and has problems with host cross-compilation (which, in my case, are both non-starters).</p>



<a name="270200155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270200155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270200155">(Feb 01 2022 at 12:26)</a>:</h4>
<p>By the way x86 alone uses 1031 llvm intrinsics with x86_64 adding another 31. For arm32 you need 1090 (shared between arm32 and aarch64) + 96 (arm32 specific) and for aarch64 you need 1090 + 468 (aarch64 specific). Mips: 536 llvm intrinsics.</p>



<a name="270200556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270200556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270200556">(Feb 01 2022 at 12:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270200136">said</a>:</p>
<blockquote>
<p>Both of those have issues I've extensively detailed in the relavant threads. The TL;DR is: GAS can't be built on or for an msvc host, and llvm-as carries with it a massive dependency (all of llvm) and has problems with host cross-compilation (which, in my case, are both non-starters).</p>
</blockquote>
<p>I would expect <code>asm!()</code> to mostly be used for implementing kernels and similar which probably isn't going to work with msvc anyway (at least if you use ELF rather than PE executables). It may also be used for performance reasons, but in that case there would probably be a fallback implementation for unsupported architectures. Finally it may be used for syscalls, but those should be easy to polyfill directly in your compiler.</p>



<a name="270200944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270200944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270200944">(Feb 01 2022 at 12:34)</a>:</h4>
<p>There may already get some pressure to support missing <code>asm!()</code> support due to cg_clif not enabling it in the configuration that will hopefully be shipped with rustup in the future and isn't supported on non-linux targets yet anyway. (Windows is missing gas most of the time and on macOS <code>ld -r</code> doesn't work.)</p>



<a name="270200973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270200973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270200973">(Feb 01 2022 at 12:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270200556">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270200136">said</a>:</p>
<blockquote>
<p>Both of those have issues I've extensively detailed in the relavant threads. The TL;DR is: GAS can't be built on or for an msvc host, and llvm-as carries with it a massive dependency (all of llvm) and has problems with host cross-compilation (which, in my case, are both non-starters).</p>
</blockquote>
<p>I would expect <code>asm!()</code> to mostly be used for implementing kernels and similar which probably isn't going to work with msvc anyway (at least if you use ELF rather than PE executables). It may also be used for performance reasons, but in that case there would probably be a fallback implementation for unsupported architectures. Finally it may be used for syscalls, but those should be easy to polyfill directly in your compiler.</p>
</blockquote>
<p>You can cross to a non-msvc target from an msvc host, though.</p>



<a name="270201060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201060">(Feb 01 2022 at 12:35)</a>:</h4>
<p>(Also, if the fallback is anything like ordinary platform-specific config in rust, it's not checking the host, so it will assume it available on an x86_64 target, for example)</p>



<a name="270201064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201064">(Feb 01 2022 at 12:35)</a>:</h4>
<p>Cross-compiling an ELF kernel to a non-msvc target would require getting gnu binutils for handling ELF files. Binutils contains gas already.</p>



<a name="270201118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201118">(Feb 01 2022 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270201060">said</a>:</p>
<blockquote>
<p>(Also, if the fallback is anything like ordinary platform-specific config in rust, it's not checking the host, so it will assume it available on an x86_64 target, for example)</p>
</blockquote>
<p>Right</p>



<a name="270201381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201381">(Feb 01 2022 at 12:37)</a>:</h4>
<p>Maybe a <code>#[cfg(compiler_asm_supported)]</code> could quickly be introduced for the optimization case?</p>



<a name="270201459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201459">(Feb 01 2022 at 12:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270201064">said</a>:</p>
<blockquote>
<p>Cross-compiling an ELF kernel to a non-msvc target would require getting gnu binutils for handling ELF files. Binutils contains gas already.</p>
</blockquote>
<p>Couldn't you just have an ELF compatible linker + objcopy?</p>



<a name="270201557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201557">(Feb 01 2022 at 12:38)</a>:</h4>
<p>The easiest way to get that is probably getting the entirety of binutils.</p>



<a name="270201626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270201626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270201626">(Feb 01 2022 at 12:38)</a>:</h4>
<p>(objcopy is fairly easy to write once you have the ability to read and write elf files, and mold exists)</p>



<a name="270204327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270204327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270204327">(Feb 01 2022 at 12:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270201381">said</a>:</p>
<blockquote>
<p>Maybe a <code>#[cfg(compiler_asm_supported)]</code> could quickly be introduced for the optimization case?</p>
</blockquote>
<p>Imagine having any knowledge at all of the backend from the frontend.</p>



<a name="270204540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270204540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270204540">(Feb 01 2022 at 13:00)</a>:</h4>
<p>(There may not even <em>be</em> a backend loaded, in the case of lccc, for example because the user used -fwrite-xir or <code>--emit mir</code>, which emits xir because what else)</p>



<a name="270210722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270210722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270210722">(Feb 01 2022 at 13:41)</a>:</h4>
<p>The backend already tells the frontend certain things. For example if you use <code>-Ctarget-cpu</code> which target features are enabled for the specified target cpu: <a href="https://github.com/rust-lang/rust/blob/547f2ba06bc4aa93a375c54e1af3fd1216eeaf62/compiler/rustc_codegen_llvm/src/lib.rs#L318-L320">https://github.com/rust-lang/rust/blob/547f2ba06bc4aa93a375c54e1af3fd1216eeaf62/compiler/rustc_codegen_llvm/src/lib.rs#L318-L320</a> Rustc also has several <code>--print</code> arguments that are forwarded to the codegen backend and <code>--version --verbose</code> asks the codegen backend to prints it's own version.</p>



<a name="270211046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270211046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270211046">(Feb 01 2022 at 13:42)</a>:</h4>
<p>Those are driver options, not frontend options.</p>
<p><code>-C target-cpu</code> is also handled outside of the backend in lccc (xlang_target::properties).</p>



<a name="270211543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270211543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270211543">(Feb 01 2022 at 13:45)</a>:</h4>
<p>The backend in lccc also depends on the target and command line options. It can also change in between default invocations, if the user chooses to install a new backend with higher priority that supports the default target.</p>



<a name="270211686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270211686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270211686">(Feb 01 2022 at 13:46)</a>:</h4>
<p>Target features enabled by <code>-Ctarget-cpu</code> show up as <code>#[cfg(target_feature = "...")]</code>. A codegen backend probably shouldn't enable target features it does not support.</p>



<a name="270211805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270211805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270211805">(Feb 01 2022 at 13:47)</a>:</h4>
<p>This would also be the case with a rustc backend using xlang, where the rustc backend acts as the driver for xlang purposes.</p>



<a name="270211878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270211878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270211878">(Feb 01 2022 at 13:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270211543">said</a>:</p>
<blockquote>
<p>The backend in lccc also depends on the target and command line options. It can also change in between default invocations, if the user chooses to install a new backend with higher priority that supports the default target.</p>
</blockquote>
<p>So can they in rustc. A user can use a different <code>-Zcodegen-backend</code> for different invocations. Cg_llvm and cg_clif are (almost completely) abi compatible with each other. In rustc however every compilation session has a codegen backend loaded even for <code>--emit mir</code>.</p>



<a name="270214633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270214633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270214633">(Feb 01 2022 at 14:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270211878">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270211543">said</a>:</p>
<blockquote>
<p>The backend in lccc also depends on the target and command line options. It can also change in between default invocations, if the user chooses to install a new backend with higher priority that supports the default target.</p>
</blockquote>
<p>So can they in rustc. A user can use a different <code>-Zcodegen-backend</code> for different invocations. Cg_llvm and cg_clif are (almost completely) abi compatible with each other. In rustc however every compilation session has a codegen backend loaded even for <code>--emit mir</code>.</p>
</blockquote>
<p>Unlike mir in rustc, xir in lccc is intended to be a long-surviving format, used for LTO (and not just <code>#[inline]</code>/generics/const eval). Thus, xir could be generated with one codegen enabled, and then the file used later, possibly with an vastly different codegen chosen by the user (possibly without the user recognizing it). Thus, the codegens need to agree on certain things, like the alignment of types, the names of target features, and what features are enabled by default on what targets. xlang_target is the location that provides the single source of truth for target properties (technically, it comes from <code>libxlang_interface.so</code> which provides <code>xlang_get_target_properties</code>, but the user-facing interface is in xlang_target).</p>



<a name="270265262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270265262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270265262">(Feb 01 2022 at 18:54)</a>:</h4>
<p>only_asm is not a good name. Naked means that the function has a specific calling convention/ABI while no prologue and epilogue should be generated for it.</p>



<a name="270266648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270266648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270266648">(Feb 01 2022 at 19:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270173648">said</a>:</p>
<blockquote>
<p>The use of comma terminated lines in a braced block looks off to me. Using <code>;</code> instead ...</p>
</blockquote>
<p>maybe allow either <code>,</code> or <code>;</code>? it would make asm writing macros and editing from <code>asm!</code> easier if <code>,</code> is allowed.</p>



<a name="270267480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270267480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270267480">(Feb 01 2022 at 19:08)</a>:</h4>
<p>Wouldn't allowing <code>,</code>  there require changes to the parser just for this? Since attributes require well-formed AST items.</p>



<a name="270270727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270270727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270270727">(Feb 01 2022 at 19:28)</a>:</h4>
<p>We definitely still want an <code>asm!</code> in there so that asm isn't part of the syntax.</p>



<a name="270288323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270288323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270288323">(Feb 01 2022 at 21:18)</a>:</h4>
<p>Agreed, I don't think this feature is so fundamental that it deserves dedicated syntax. If people want to suggest a better name I don't mind, "naked" is kind of jargony, but I can't really think of something especially intuitive. And being jargony might be an advantage here since this is a pretty advanced feature, and being familiar to advanced users who understand the term from C/C++ might be more valuable than putting a friendly face on this feature</p>



<a name="270291484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270291484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270291484">(Feb 01 2022 at 21:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/270288323">said</a>:</p>
<blockquote>
<p>Agreed, I don't think this feature is so fundamental that it deserves dedicated syntax. If people want to suggest a better name I don't mind, "naked" is kind of jargony, but I can't really think of something especially intuitive. And being jargony might be an advantage here since this is a pretty advanced feature, and being familiar to advanced users who understand the term from C/C++ might be more valuable than putting a friendly face on this feature</p>
</blockquote>
<p>Yeah, the danger of a non-jargony name is that people might accidentally think they know what it means without the fairly specific background that the feature requires</p>



<a name="270453836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270453836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270453836">(Feb 02 2022 at 20:40)</a>:</h4>
<p>I have filed a stabilization proposal for <code>#[naked]</code> at <a href="https://github.com/rust-lang/rust/issues/90957#issuecomment-1028297041">https://github.com/rust-lang/rust/issues/90957#issuecomment-1028297041</a> . <span class="user-mention" data-user-id="239881">@Josh Triplett</span> , may I nominate this for lang team discussion?</p>



<a name="270455874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270455874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270455874">(Feb 02 2022 at 20:55)</a>:</h4>
<p>FCP started.</p>



<a name="270455919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270455919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270455919">(Feb 02 2022 at 20:55)</a>:</h4>
<p>Though I expect that this FCP may depend on the other ongoing FCP to close unconstrained naked functions.</p>



<a name="270458066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/270458066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#270458066">(Feb 02 2022 at 21:10)</a>:</h4>
<p>Sure, I don't think there's any particular rush, just as long as it isn't totally stagnating :)</p>



<a name="272335288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272335288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272335288">(Feb 17 2022 at 22:44)</a>:</h4>
<p>Circling back to naming… I wonder if we are happy with it in context of our general refrain in having potentially divisive names for other things in the past (e.g. white/black list vs allow/deny list; main/master and probably some others?) Naked seems like it could be similarly contentious. Though I do agree that jargon and having similar naming as in the other compilers has a fair amount of value too.</p>



<a name="272407844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272407844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272407844">(Feb 18 2022 at 14:27)</a>:</h4>
<p>I wouldn't say "naked" is objectionable/divisive so much as it's vaguely eyebrow-raising or not strictly "professional" in the buttoned-up traditional corporate environment sense. I don't think it will be a problem since this is a relatively rare and advanced feature, and there's some benefit to using the standard terminology, but if someone has a better name I'm not opposed to considering it</p>



<a name="272500148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272500148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272500148">(Feb 19 2022 at 07:21)</a>:</h4>
<p>It's not as descriptive as it could be. It seems more accurate that this is something like "calling convention = none", so some notation that unifies it with the syntax used for custom calling conventions seems good</p>



<a name="272500255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272500255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272500255">(Feb 19 2022 at 07:23)</a>:</h4>
<p>(Correct me if I'm wrong, but <code>#[naked]</code> is incompatible with other calling convention syntaxes like <code>extern "C" fn foo() { ... }</code>, right? At least, it's not clear what it would mean)</p>



<a name="272500619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272500619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272500619">(Feb 19 2022 at 07:31)</a>:</h4>
<p>It is. Which <em>does</em> make it tempting to call it something like <code>extern "none"</code>.</p>



<a name="272500649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272500649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272500649">(Feb 19 2022 at 07:32)</a>:</h4>
<p>harder to google though</p>



<a name="272500866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272500866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272500866">(Feb 19 2022 at 07:37)</a>:</h4>
<p>umm... I'm not sure googling "naked" is better</p>



<a name="272500938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272500938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272500938">(Feb 19 2022 at 07:39)</a>:</h4>
<p><code>extern "none"</code> would mean that attempting to call the naked function from rust would be impossible as the abi is unknown.</p>



<a name="272501001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501001">(Feb 19 2022 at 07:40)</a>:</h4>
<p>you could cast the function pointer to <code>extern "C" fn</code> if you want to call it with a specific calling convention</p>



<a name="272501044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501044">(Feb 19 2022 at 07:41)</a>:</h4>
<p>but at first blush it seems correct to say that a naked function can't be called by rust since you made up your own calling convention</p>



<a name="272501086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501086">(Feb 19 2022 at 07:42)</a>:</h4>
<p>or at least rust has no idea what it is</p>



<a name="272501106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501106">(Feb 19 2022 at 07:43)</a>:</h4>
<p>if you google "naked function" you get appropriate clang and msvc docs</p>



<a name="272501183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501183">(Feb 19 2022 at 07:44)</a>:</h4>
<p>That is just ugly. In addition it wouldn't be possible for cg_clif to optimize the indirect call into a direct call. Cranelift requires knowing the full signature when defining a function.</p>



<a name="272501184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501184">(Feb 19 2022 at 07:44)</a>:</h4>
<p><code>#[naked] extern "win64" fn</code> has the win64 abi. <code>#[naked] extern "sysv" fn</code> has the sysv abi.</p>



<a name="272501185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272501185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272501185">(Feb 19 2022 at 07:44)</a>:</h4>
<p>Naked functions do not have a made up calling convention.</p>



<a name="272519616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272519616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272519616">(Feb 19 2022 at 13:47)</a>:</h4>
<p>They could, in theory.</p>



<a name="272526016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272526016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272526016">(Feb 19 2022 at 15:57)</a>:</h4>
<p>not on eg wasm as the function signature is part of the executable file there rather than implicit like on most systems.</p>



<a name="272530601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272530601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272530601">(Feb 19 2022 at 17:23)</a>:</h4>
<p>Right, but on other platforms, the assembly can do basically w/e it wants.</p>



<a name="272531482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272531482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272531482">(Feb 19 2022 at 17:40)</a>:</h4>
<p>The caller still has abi expectations though, including saved registers and such</p>



<a name="272531814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272531814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272531814">(Feb 19 2022 at 17:47)</a>:</h4>
<p>right but those expectations might not actually match any nameable ABI</p>



<a name="272575611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272575611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> asquared31415 <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272575611">(Feb 20 2022 at 08:10)</a>:</h4>
<p>I have wanted an <code>extern "none"</code> sort of ABI for naked functions before.  I think it would useful to be able to encode "this must not be called by rust" in a way that can be enforced.  "there will be some convention but it's not a well known or stable to the compiler convention" is something I have seen in FFI and kernel level code as well.</p>



<a name="272594124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272594124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272594124">(Feb 20 2022 at 14:00)</a>:</h4>
<p>I think that's kinda orthogonal to naked functions.</p>



<a name="272594204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272594204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272594204">(Feb 20 2022 at 14:02)</a>:</h4>
<p>Since having <code>extern "none"</code> that's defined externally and imported via extern block is also reasonable.</p>



<a name="272606036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272606036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272606036">(Feb 20 2022 at 17:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D/near/272500255">said</a>:</p>
<blockquote>
<p>(Correct me if I'm wrong, but <code>#[naked]</code> is incompatible with other calling convention syntaxes like <code>extern "C" fn foo() { ... }</code>, right? At least, it's not clear what it would mean)</p>
</blockquote>
<p>can you elaborate? using naked functions all but <em>requires</em> you to specify an extern ABI. the calling convention isn't unknown, it's still handled automatically on the caller side, it's just handled manually on the callee side</p>



<a name="272647086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272647086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272647086">(Feb 21 2022 at 06:36)</a>:</h4>
<p>Yeah, I see now. <code>extern</code> controls calling convention on both sides, and <code>#[naked]</code> opts out only on the caller side but the callee side calling convention is still important. <code>extern "none"</code> might still be useful for reasons like what <span class="user-mention silent" data-user-id="384759">asquared31415</span> mentioned but it's orthogonal to <code>#[naked]</code></p>



<a name="272647206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272647206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272647206">(Feb 21 2022 at 06:38)</a>:</h4>
<p>On the subject of less sensational and more descriptive names: <code>#{no_prologue]</code></p>



<a name="272647315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272647315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272647315">(Feb 21 2022 at 06:40)</a>:</h4>
<p>although this leads to the obvious question "but what about the epilogue", and of course this attribute would control both</p>



<a name="272647421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272647421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272647421">(Feb 21 2022 at 06:42)</a>:</h4>
<p>Although epilogue handling is seemingly quite different, I mean if I have <code>asm!("ret")</code> I assume that's a plain <code>ret</code> regardless of whether the function has a compiler generated prologue or not</p>



<a name="272649552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272649552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272649552">(Feb 21 2022 at 07:14)</a>:</h4>
<p>spitballing: on the theme of "it's being called by the caller using <em>some</em> ABI, but it's not automatically handled", <code>#[manual_abi]</code>?</p>



<a name="272657947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272657947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272657947">(Feb 21 2022 at 08:51)</a>:</h4>
<p>Are you allowed to write a <code>#[naked]</code> function with regular code in it? It seems like the syntax should somehow enforce that you put an <code>asm!</code> block because rust can't really do anything sensible if it just skips the prologue but codegens everything else as normal</p>



<a name="272658698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272658698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272658698">(Feb 21 2022 at 08:58)</a>:</h4>
<p>IIRC those updates were <a href="https://github.com/rust-lang/rfcs/pull/2972">https://github.com/rust-lang/rfcs/pull/2972</a></p>



<a name="272659915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272659915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272659915">(Feb 21 2022 at 09:09)</a>:</h4>
<p>I'm playing with naked functions now without having read the documentation prior, and it is surprisingly hard to write something that compiles. I tried the obvious thing with an <code>asm!("ret")</code> but it wants me to mark the function noreturn, which I didn't know was syntax?</p>



<a name="272661246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272661246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272661246">(Feb 21 2022 at 09:21)</a>:</h4>
<p>oh, it wants the asm block to be noreturn. This compiles, but the noreturn looks like a lie:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(naked_functions)]</span><span class="w"></span>
<span class="cp">#[naked]</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">arch</span>::<span class="fm">asm!</span><span class="p">(</span><span class="s">"mov rax, 4</span><span class="se">\n</span><span class="s">ret"</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">(</span><span class="n">noreturn</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Shouldn't the requirement go the other way? In a naked function, rust itself can't be trusted to do the epilogue right so the asm block should have a required <code>ret</code></p>



<a name="272661505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272661505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272661505">(Feb 21 2022 at 09:23)</a>:</h4>
<p>oh, I guess the noreturn changes the return type of the asm block to <code>!</code> instead of <code>()</code>, so an asm block with <code>ret</code> is actually noreturn... that's confusing</p>



<a name="272664291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272664291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272664291">(Feb 21 2022 at 09:49)</a>:</h4>
<p>Yes, it's UB to actually fall out of the bottom of a noreturn asm block.</p>



<a name="272668375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272668375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272668375">(Feb 21 2022 at 10:21)</a>:</h4>
<p>so it's more of a "mustreturn" then, at least in this case</p>



<a name="272668453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272668453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272668453">(Feb 21 2022 at 10:22)</a>:</h4>
<p>I mean I get how it ended up like this but the terminology is unfortunate</p>



<a name="272681361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272681361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272681361">(Feb 21 2022 at 12:25)</a>:</h4>
<p>It's the asm block that must not return</p>



<a name="272698424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272698424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272698424">(Feb 21 2022 at 14:56)</a>:</h4>
<p>More like "must-diverge"</p>



<a name="272719031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272719031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272719031">(Feb 21 2022 at 17:56)</a>:</h4>
<p>here I'd say it's more like "nocleanup". From the asm docs: "noreturn: The asm! block never returns, and its return type is defined as ! (never). Behavior is undefined if execution falls through past the end of the asm code. A noreturn asm block behaves just like a function which doesn't return; notably, local variables in scope are not dropped before it is invoked."</p>



<a name="272721435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272721435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272721435">(Feb 21 2022 at 18:24)</a>:</h4>
<p>the analogy is reasonable, but flawed: it's not like calling a function that doesn't return because it's not in a new call frame - <code>ret</code> returns from the function, not the asm block</p>



<a name="272721546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272721546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272721546">(Feb 21 2022 at 18:25)</a>:</h4>
<p>"diverge" is definitely better terminology. Would you say that the expression <code>return 2 + 2</code> is noreturn? The word "return" seems overloaded here, expressions "return" values but not <code>return</code> return</p>



<a name="272728098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/stabilizing%20%23%5Bnaked%5D/near/272728098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/stabilizing.20.23.5Bnaked.5D.html#272728098">(Feb 21 2022 at 19:39)</a>:</h4>
<p>I started a topic on internals about deprecating <code>noreturn</code> and naming the replacement <code>diverges</code> or similar: <a href="https://internals.rust-lang.org/t/rename-asm-noreturn-and-deprecate-old-option/16190?u=programmerjake">https://internals.rust-lang.org/t/rename-asm-noreturn-and-deprecate-old-option/16190?u=programmerjake</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>