<html>
<head><meta charset="utf-8"><title>lazy tait PR #94081 · t-lang · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/index.html">t-lang</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html">lazy tait PR #94081</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275523054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523054">(Mar 16 2022 at 15:00)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="124288">@oli</span>, so I'm working on a write-up of the semantics of the new inference algorithm:</p>
<p><a href="https://hackmd.io/T4kshpcWRSK5hiymLGAMPA">https://hackmd.io/T4kshpcWRSK5hiymLGAMPA</a></p>
<p>My hope is to include some version of this on the impl trait explainer and for the Rust reference. I do have some questions though.</p>



<a name="275523102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523102">(Mar 16 2022 at 15:00)</a>:</h4>
<p>In your PR, you write:</p>



<a name="275523115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523115">(Mar 16 2022 at 15:00)</a>:</h4>
<blockquote>
<p>user visible change 2: divergence between RPIT and TAIT in return statements</p>
</blockquote>



<a name="275523321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523321">(Mar 16 2022 at 15:01)</a>:</h4>
<p>I think what is going on here is that:</p>



<a name="275523360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523360">(Mar 16 2022 at 15:01)</a>:</h4>
<ul>
<li>Each time you constrain the TAIT, you get an "independent" constraint (which is different than something I wrote in the hackmd above)</li>
</ul>



<a name="275523377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523377">(Mar 16 2022 at 15:01)</a>:</h4>
<p>therefore:</p>



<a name="275523390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523390">(Mar 16 2022 at 15:01)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">b</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">42</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">iter</span>::<span class="n">empty</span><span class="p">().</span><span class="n">collect</span><span class="p">()</span><span class="w"> </span><span class="c1">//~ ERROR `Foo` cannot be built from an iterator</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275523466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523466">(Mar 16 2022 at 15:02)</a>:</h4>
<p>the <code>Vec&lt;i32&gt;</code> from the <code>return</code> doesn't influence the <code>collect()</code> call later</p>



<a name="275523521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523521">(Mar 16 2022 at 15:02)</a>:</h4>
<p>is that .. correct?</p>



<a name="275523537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523537">(Mar 16 2022 at 15:02)</a>:</h4>
<p>I'm also a bit confused as to why this code doesn't compile, is it the same reason?</p>



<a name="275523552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523552">(Mar 16 2022 at 15:02)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">b</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">42_</span><span class="k">i32</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span>::<span class="n">iter</span>::<span class="n">empty</span><span class="p">().</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="c1">//~^ ERROR `Foo` cannot be built from an iterator over elements of type `_`</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275523571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523571">(Mar 16 2022 at 15:02)</a>:</h4>
<p>(that is "user visible change 3")</p>



<a name="275523604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523604">(Mar 16 2022 at 15:02)</a>:</h4>
<p>I remember us discussing this at various points, i.e., where the "merge" happens exactly.</p>



<a name="275523676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523676">(Mar 16 2022 at 15:03)</a>:</h4>
<p>(Also, if you already had such a write-up, d'oh! I debated about asking you to write it, but then I thought I had a fairly clear vision for how to express it, so I took a stab at it)</p>



<a name="275523843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523843">(Mar 16 2022 at 15:04)</a>:</h4>
<p>Also, you're alluding to some kind of hack for RPIT, I'm curious what that is, exactly</p>



<a name="275523939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523939">(Mar 16 2022 at 15:04)</a>:</h4>
<p>user visible change 2 and 3 are different. We can easily support 3 (revert <a href="https://github.com/rust-lang/rust/commit/a721052457cf513487fb4266e3ade65c29b272d2">https://github.com/rust-lang/rust/commit/a721052457cf513487fb4266e3ade65c29b272d2</a>, which removes support for it). Supporting 2 reintroduces the inference-var system that RPIT had, albeit in a more limited manner.</p>



<a name="275523998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275523998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275523998">(Mar 16 2022 at 15:05)</a>:</h4>
<p>it seems a bit different to me</p>



<a name="275524101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524101">(Mar 16 2022 at 15:05)</a>:</h4>
<p>what happens today with this case?</p>



<a name="275524168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524168">(Mar 16 2022 at 15:06)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Constraints `Foo = Result&lt;u32, i32&gt;`</span>
<span class="k">fn</span> <span class="nf">sufficient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">22_</span><span class="k">u32</span><span class="p">);</span><span class="w">  </span><span class="c1">// Requires `Result&lt;u32, _&gt;`</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="mi">22_</span><span class="k">i32</span><span class="p">);</span><span class="w"> </span><span class="c1">// Requires `Result&lt;_, i32&gt;`</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275524253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524253">(Mar 16 2022 at 15:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081/near/275523998">said</a>:</p>
<blockquote>
<p>it seems a bit different to me</p>
</blockquote>
<p>(to clarify, I think that the old RPIT scheme and the things required to support case 2 are different)</p>



<a name="275524314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524314">(Mar 16 2022 at 15:07)</a>:</h4>
<p>that should work even with the lazy TAIT PR as written now, as these types can be unified</p>



<a name="275524355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524355">(Mar 16 2022 at 15:07)</a>:</h4>
<p>what about</p>



<a name="275524358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524358">(Mar 16 2022 at 15:07)</a>:</h4>
<p>it's only problematic if you don't actually end up with a type that you can merge into the hidden type</p>



<a name="275524380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524380">(Mar 16 2022 at 15:07)</a>:</h4>
<p>inference vars get merged with the opaque type, not the hidden one</p>



<a name="275524431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524431">(Mar 16 2022 at 15:08)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">b</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">42</span><span class="p">];</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">c</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">iter</span>::<span class="n">empty</span><span class="p">().</span><span class="n">collect</span><span class="p">(;</span><span class="w"></span>
</code></pre></div>



<a name="275524508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524508">(Mar 16 2022 at 15:08)</a>:</h4>
<p>that won't work</p>



<a name="275524526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524526">(Mar 16 2022 at 15:08)</a>:</h4>
<p>I don't follow why doesn't work but the above one does</p>



<a name="275524545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524545">(Mar 16 2022 at 15:08)</a>:</h4>
<p>Perhaps it has to do with <em>when</em> the merging occurs</p>



<a name="275524554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524554">(Mar 16 2022 at 15:08)</a>:</h4>
<p><code>Foo</code> does not implement <code>Extend</code></p>



<a name="275524591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524591">(Mar 16 2022 at 15:08)</a>:</h4>
<p>or what the trait is ^^, sec I got an <del>example</del> test for this</p>



<a name="275524608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524608">(Mar 16 2022 at 15:08)</a>:</h4>
<p>OK, OK, I see</p>



<a name="275524612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524612">(Mar 16 2022 at 15:08)</a>:</h4>
<p>interesting</p>



<a name="275524821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524821">(Mar 16 2022 at 15:10)</a>:</h4>
<p>so--- case 3 can be made to work because the merge happens before it "hits" the <code>Foo</code></p>



<a name="275524839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524839">(Mar 16 2022 at 15:10)</a>:</h4>
<p>(which I remember us discussing at some point)</p>



<a name="275524872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524872">(Mar 16 2022 at 15:10)</a>:</h4>
<p>there is, I think, a missing section then</p>



<a name="275524891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524891">(Mar 16 2022 at 15:10)</a>:</h4>
<p>what happens with auto-traits within defining scope exactly</p>



<a name="275524915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524915">(Mar 16 2022 at 15:10)</a>:</h4>
<p>does this code work?</p>



<a name="275524920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524920">(Mar 16 2022 at 15:10)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">is_send</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Send</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Constrain `Foo = u32`</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22_</span><span class="k">u32</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// No problem `Foo = u32` and `u32: Send`</span>
<span class="w">    </span><span class="n">is_send</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275524997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275524997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275524997">(Mar 16 2022 at 15:11)</a>:</h4>
<p>I'm guessing no</p>



<a name="275525000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275525000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275525000">(Mar 16 2022 at 15:11)</a>:</h4>
<p>uh... that probably causes a cycle error</p>



<a name="275525081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275525081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275525081">(Mar 16 2022 at 15:11)</a>:</h4>
<p>Yeah, ok. This seems ok. I will adjust the write-up. I think we can do better in the future, but I don't see why it should block this PR from landing (nor stabilization).</p>



<a name="275525670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275525670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275525670">(Mar 16 2022 at 15:15)</a>:</h4>
<p>ah found the test I was looking for: <a href="https://github.com/rust-lang/rust/pull/94081/files#diff-0e96334fc7ab7eea8178318d13179eefa841abfb448fd66c2d5a33d635ebfa7b">https://github.com/rust-lang/rust/pull/94081/files#diff-0e96334fc7ab7eea8178318d13179eefa841abfb448fd66c2d5a33d635ebfa7b</a> if there is a <code>FromIterator</code> bound on the opaque type, we can collect into it</p>



<a name="275525874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275525874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275525874">(Mar 16 2022 at 15:16)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> and do we indeed have a "special case hack" for RPIT to support this case?</p>



<a name="275526150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275526150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275526150">(Mar 16 2022 at 15:18)</a>:</h4>
<p>yes, <a href="https://github.com/rust-lang/rust/pull/94081/commits/d2850ee9fb05b2f76be0502e7f30141dffcb8bd6">https://github.com/rust-lang/rust/pull/94081/commits/d2850ee9fb05b2f76be0502e7f30141dffcb8bd6</a> shows most of the sites, but basically the final PR has 3 call sites for replace_opaque_types_with_inference_vars that are all such backwards compat hacks</p>



<a name="275526275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275526275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275526275">(Mar 16 2022 at 15:19)</a>:</h4>
<p>I documented these in <a href="https://hackmd.io/5t8pLdJcRDmqbfN9ZXje3g#Backwards-compatibility-hacks">https://hackmd.io/5t8pLdJcRDmqbfN9ZXje3g#Backwards-compatibility-hacks</a></p>



<a name="275526668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275526668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275526668">(Mar 16 2022 at 15:21)</a>:</h4>
<p>Hmm, ok.</p>



<a name="275526719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275526719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275526719">(Mar 16 2022 at 15:22)</a>:</h4>
<p>So we have to decide how we want to handle those for TAIT in the future.</p>



<a name="275526783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275526783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275526783">(Mar 16 2022 at 15:22)</a>:</h4>
<p>sg, I'll adjust the write-up</p>



<a name="275527196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275527196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275527196">(Mar 16 2022 at 15:25)</a>:</h4>
<p>yes, I just chose the most forward compatible thing at each of them. So we can become more permissive later</p>



<a name="275624272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275624272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275624272">(Mar 17 2022 at 09:17)</a>:</h4>
<p>I edited the hackmd, there's just one open point I believe (left a FIXME, as I need to write more tests first)</p>



<a name="275624455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275624455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275624455">(Mar 17 2022 at 09:19)</a>:</h4>
<p>We should also make sure that the <code>fudge_inference_if_ok</code> thing does not behave differently between RPIT and TAIT. I've been digging into it to try to avoid it, but I haven't grokked it yet, so I can't even tell all the edge cases that are avoided by it compared with just doing <code>commit_if_ok</code></p>



<a name="275657938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275657938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275657938">(Mar 17 2022 at 14:09)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> this example yields a cycle in your branch, right?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">is_send</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Send</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">not_good</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Error: this function does not constrain `Foo` to any particular</span>
<span class="w">    </span><span class="c1">// hidden type, so it cannot rely on `Send` being true.</span>
<span class="w">    </span><span class="n">is_send</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Constrain `Foo = u32`</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22_</span><span class="k">u32</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// No problem `Foo = u32` and `u32: Send`</span>
<span class="w">    </span><span class="n">is_send</span>::<span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275658686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658686">(Mar 17 2022 at 14:14)</a>:</h4>
<p>uh</p>



<a name="275658693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658693">(Mar 17 2022 at 14:14)</a>:</h4>
<p>nope ^^</p>



<a name="275658723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658723">(Mar 17 2022 at 14:14)</a>:</h4>
<p>ok, I thought you said it did</p>



<a name="275658731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658731">(Mar 17 2022 at 14:14)</a>:</h4>
<p>I have to look at what happens with auto-traits</p>



<a name="275658856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658856">(Mar 17 2022 at 14:15)</a>:</h4>
<p><code>not_good</code> works because it never constrains the opaque type, thus is not searched for the opaque type (yea this logic is a bit roundabout), so we can reveal the opaque type by asking <code>type_of</code> to give us the hidden type</p>



<a name="275658875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658875">(Mar 17 2022 at 14:15)</a>:</h4>
<p>the thing I'm surprised about is <code>ok</code></p>



<a name="275658959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658959">(Mar 17 2022 at 14:16)</a>:</h4>
<p>I'm a bit surprised that <code>not_good</code> works</p>



<a name="275658963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658963">(Mar 17 2022 at 14:16)</a>:</h4>
<p>I don't know how that actually works</p>



<a name="275658974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275658974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275658974">(Mar 17 2022 at 14:16)</a>:</h4>
<p>We're smarter than I thought, I guess</p>



<a name="275659031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659031">(Mar 17 2022 at 14:16)</a>:</h4>
<p>/me thinks</p>



<a name="275659067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659067">(Mar 17 2022 at 14:17)</a>:</h4>
<p>during the type-checking of <code>not_good</code>, we need to determine that <code>Foo: Send</code>...</p>



<a name="275659083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659083">(Mar 17 2022 at 14:17)</a>:</h4>
<p>...which requires knowing its hidden type...</p>



<a name="275659106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659106">(Mar 17 2022 at 14:17)</a>:</h4>
<p>hold up</p>



<a name="275659114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659114">(Mar 17 2022 at 14:17)</a>:</h4>
<p>...to know the hidden type, we have to look at the typeck-results (right?) to see whether <code>Foo</code> is constrained...</p>



<a name="275659122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659122">(Mar 17 2022 at 14:17)</a>:</h4>
<p>I may have messed up testing</p>



<a name="275659133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659133">(Mar 17 2022 at 14:17)</a>:</h4>
<p>...which we are computing?</p>



<a name="275659268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659268">(Mar 17 2022 at 14:18)</a>:</h4>
<p>so</p>



<a name="275659289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659289">(Mar 17 2022 at 14:18)</a>:</h4>
<p>both ok and not_good fail</p>



<a name="275659315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659315">(Mar 17 2022 at 14:18)</a>:</h4>
<p>ok, that's what I expected</p>



<a name="275659320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659320">(Mar 17 2022 at 14:18)</a>:</h4>
<p>I was expecting <code>ok</code>, but not <code>not_good</code>, but it does seem obvious in hindsight</p>



<a name="275659331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659331">(Mar 17 2022 at 14:18)</a>:</h4>
<p>based on your earlier comments</p>



<a name="275659342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659342">(Mar 17 2022 at 14:18)</a>:</h4>
<p>I expect <code>not_good</code> to fail with a cycle</p>



<a name="275659351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659351">(Mar 17 2022 at 14:18)</a>:</h4>
<p>I guess I expect both to fail with a cycle</p>



<a name="275659396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659396">(Mar 17 2022 at 14:19)</a>:</h4>
<p>the "lesson" seems to be that when you are <em>inside</em> the defining scope, at least with the current impl, you should prefer to work with the "hidden type"</p>



<a name="275659409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659409">(Mar 17 2022 at 14:19)</a>:</h4>
<p>and only use the type alias at the "end"</p>



<a name="275659481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659481">(Mar 17 2022 at 14:19)</a>:</h4>
<p>basically, you have the power to assert <em>arbitrary</em> traits (not just auto traits) by constraining the hidden type and testing <em>that</em></p>



<a name="275659485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659485">(Mar 17 2022 at 14:19)</a>:</h4>
<p>and that's what you should do</p>



<a name="275659582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659582">(Mar 17 2022 at 14:20)</a>:</h4>
<p>uh</p>



<a name="275659591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659591">(Mar 17 2022 at 14:20)</a>:</h4>
<p>so <span class="user-mention" data-user-id="124288">@oli</span> in terms of RPIT, is the idea that we are currently doing the "rewrite the return type to an inference variable" thing eagerly in the code?</p>



<a name="275659651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659651">(Mar 17 2022 at 14:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081/near/275659481">said</a>:</p>
<blockquote>
<p>basically, you have the power to assert <em>arbitrary</em> traits (not just auto traits) by constraining the hidden type and testing <em>that</em></p>
</blockquote>
<p>ah yes, took me a moment. Not revealing, but constraining and testing the known hidden type</p>



<a name="275659679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659679">(Mar 17 2022 at 14:21)</a>:</h4>
<p>right</p>



<a name="275659704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659704">(Mar 17 2022 at 14:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081/near/275659591">said</a>:</p>
<blockquote>
<p>so <span class="user-mention silent" data-user-id="124288">oli</span> in terms of RPIT, is the idea that we are currently doing the "rewrite the return type to an inference variable" thing eagerly in the code?</p>
</blockquote>
<p>yes, we rewrite the return type as seen from <em>inside</em> the function</p>



<a name="275659720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659720">(Mar 17 2022 at 14:21)</a>:</h4>
<p>which is essentially what we used to do before, too</p>



<a name="275659731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275659731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275659731">(Mar 17 2022 at 14:21)</a>:</h4>
<p>you don't "reveal" inside the scope, you constrain</p>



<a name="275660247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275660247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275660247">(Mar 17 2022 at 14:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081/near/275659591">said</a>:</p>
<blockquote>
<p>so <span class="user-mention silent" data-user-id="124288">oli</span> in terms of RPIT, is the idea that we are currently doing the "rewrite the return type to an inference variable" thing eagerly in the code?</p>
</blockquote>
<p><span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> <span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="275660467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275660467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275660467">(Mar 17 2022 at 14:25)</a>:</h4>
<p>yea, we do this rewrite, but only in the FnCtxt used to typeck functions. when we get to mir borrowck, we trust all the types that are around (though these are influenced by the FnCtxt)</p>



<a name="275660742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275660742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275660742">(Mar 17 2022 at 14:27)</a>:</h4>
<p>ok. so that's why the <code>if { } else { }</code> case behaves differently? The expected type is an inference variable, essentially?</p>



<a name="275660802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275660802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275660802">(Mar 17 2022 at 14:27)</a>:</h4>
<p>yes</p>



<a name="275661026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275661026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275661026">(Mar 17 2022 at 14:29)</a>:</h4>
<p>this also has an effect on generic function calls where typeck flows information from the return type to the arguments (<code>fudge_inference_if_ok</code> being the keyword to search in the source for)</p>



<a name="275661057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275661057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275661057">(Mar 17 2022 at 14:29)</a>:</h4>
<p>Though I patched that to make them behave the same</p>



<a name="275661335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275661335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275661335">(Mar 17 2022 at 14:31)</a>:</h4>
<p>yeah, I remember that function vaguely, have to recall the details :)</p>



<a name="275661504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/213817-t-lang/topic/lazy%20tait%20PR%20%2394081/near/275661504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/213817-t-lang/topic/lazy.20tait.20PR.20.2394081.html#275661504">(Mar 17 2022 at 14:32)</a>:</h4>
<blockquote>
<div class="codehilite"><pre><span></span><code>    // HACK(oli-obk): This is a hack to keep RPIT and TAIT in sync wrt their behaviour.
    // Without it, the inference
    // variable will get instantiated with the opaque type. The inference variable often
    // has various helpful obligations registered for it that help closures figure out their
    // signature. If we infer the inference var to the opaque type, the closure won&#39;t be able
    // to find those obligations anymore, and it can&#39;t necessarily find them from the opaque
    // type itself. We could be more powerful with inference if we *combined* the obligations
    // so that we got both the obligations from the opaque type and the ones from the inference
    // variable. That will accept more code than we do right now, so we need to carefully consider
    // the implications.
    // Note: this check is pessimistic, as the inference type could be matched with something other
    // than the opaque type, but then we need a new `TypeRelation` just for this specific case and
    // can&#39;t re-use `sup` below.
    // See src/test/ui/impl-trait/hidden-type-is-opaque.rs and
    // src/test/ui/impl-trait/hidden-type-is-opaque-2.rs for examples that hit this path.
</code></pre></div>

</blockquote>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>