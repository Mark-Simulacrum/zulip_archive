<html>
<head><meta charset="utf-8"><title>`StableHasher` hashing algorithm · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html">`StableHasher` hashing algorithm</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263819958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263819958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263819958">(Dec 06 2021 at 08:28)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Four years ago you <a href="https://github.com/rust-lang/rust/issues/41215#issuecomment-307149200">suggested</a> testing <code>seahash</code> for <code>StableHasher</code>, which seems like a good suggestion given the <a href="https://gitlab.redox-os.org/redox-os/seahash/-/blob/master/src/lib.rs#L41-53">claims</a> that's it's more than 10x faster than SipHash.</p>



<a name="263820001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263820001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263820001">(Dec 06 2021 at 08:29)</a>:</h4>
<p>So I tried it today. For <code>incr-full</code> builds it increased rustc instruction counts by up to 29%!</p>



<a name="263820342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263820342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263820342">(Dec 06 2021 at 08:33)</a>:</h4>
<p>This might be explained by the fact that I sped up SipHasher128 (used by StableHasher) quite a bit last year: <a href="https://github.com/rust-lang/rust/pull/68914">https://github.com/rust-lang/rust/pull/68914</a></p>



<a name="263820349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263820349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263820349">(Dec 06 2021 at 08:33)</a>:</h4>
<p>Still, disappointing.</p>



<a name="263820407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263820407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263820407">(Dec 06 2021 at 08:34)</a>:</h4>
<p>My impression from having looked at a bunch of the hashing implementations is that every one of them claims to be faster and better than all the others, more or less.</p>



<a name="263820490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263820490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263820490">(Dec 06 2021 at 08:35)</a>:</h4>
<p>I also tried <code>wyhash</code>, but I got build errors when building <code>std</code>. I had to add a <code>finish128</code> method, I just took the <code>u64</code> result from the <code>finish</code> method and duplicated the value into the high bits. (I did the same thing for <code>seahash</code>, and it worked ok.)</p>



<a name="263824681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263824681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263824681">(Dec 06 2021 at 09:22)</a>:</h4>
<p>I'm genuinely surprised. I appreciate you testing the hypothesis, though.</p>



<a name="263824753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263824753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263824753">(Dec 06 2021 at 09:22)</a>:</h4>
<p>Do you think it likely that even an optimized seahash will fail to beat siphash?</p>



<a name="263824785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263824785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263824785">(Dec 06 2021 at 09:23)</a>:</h4>
<p>I'm surprised that their benchmarks would be off by <em>that</em> much.</p>



<a name="263855884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263855884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263855884">(Dec 06 2021 at 14:19)</a>:</h4>
<p>FWIW, I tried highwayhigh and it was also slower (<a href="https://github.com/rust-lang/rust/issues/51054#issuecomment-933603794">https://github.com/rust-lang/rust/issues/51054#issuecomment-933603794</a>).</p>



<a name="263925910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263925910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263925910">(Dec 06 2021 at 21:17)</a>:</h4>
<p>My takeaway: take all hashing performance claims with a grain, nay, a bucket of salt</p>



<a name="263933973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263933973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263933973">(Dec 06 2021 at 22:27)</a>:</h4>
<p>Do you have a diff of these changes somewhere? I'd love to try some hash algos and see how they work on these inputs.</p>



<a name="263941054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263941054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263941054">(Dec 06 2021 at 23:47)</a>:</h4>
<p>Diff for rustc:</p>
<div class="codehilite"><pre><span></span><code>diff --git a/compiler/rustc_data_structures/Cargo.toml b/compiler/rustc_data_structures/Cargo.toml
index e3395df3590..36eddcc6e63 100644
--- a/compiler/rustc_data_structures/Cargo.toml
+++ b/compiler/rustc_data_structures/Cargo.toml
@@ -27,6 +27,7 @@ measureme = &quot;10.0.0&quot;
 libc = &quot;0.2&quot;
 stacker = &quot;0.1.14&quot;
 tempfile = &quot;3.2&quot;
+seahash = { path = &quot;/home/njn/dev/seahash&quot; }

 [dependencies.parking_lot]
 version = &quot;0.11&quot;
diff --git a/compiler/rustc_data_structures/src/stable_hasher.rs b/compiler/rustc_data_structures/sr
c/stable_hasher.rs
index f800ec6a6a1..2eb88448a0f 100644
--- a/compiler/rustc_data_structures/src/stable_hasher.rs
+++ b/compiler/rustc_data_structures/src/stable_hasher.rs
@@ -1,4 +1,4 @@
-use crate::sip128::SipHasher128;
+use seahash::SeaHasher;
 use rustc_index::bit_set;
 use rustc_index::vec;
 use smallvec::SmallVec;
@@ -15,13 +15,16 @@
 /// To that end we always convert integers to little-endian format before
 /// hashing and the architecture dependent `isize` and `usize` types are
 /// extended to 64 bits if needed.
+//
+// njn: I think seahash is endian-independent
 pub struct StableHasher {
-    state: SipHasher128,
+    state: SeaHasher,
 }

 impl ::std::fmt::Debug for StableHasher {
-    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
-        write!(f, &quot;{:?}&quot;, self.state)
+    fn fmt(&amp;self, _f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
+        //write!(f, &quot;{:?}&quot;, self.state)
+        panic!(&quot;njn: todo&quot;);
     }
 }

@@ -32,7 +35,7 @@ pub trait StableHasherResult: Sized {
 impl StableHasher {
     #[inline]
     pub fn new() -&gt; Self {
-        StableHasher { state: SipHasher128::new_with_keys(0, 0) }
+        StableHasher { state: SeaHasher::new() }
     }

     #[inline]
</code></pre></div>



<a name="263941131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263941131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263941131">(Dec 06 2021 at 23:48)</a>:</h4>
<p>I had to use a modified version of <code>seahash</code> to add a <code>finish128</code> method. Here's the diff:</p>
<div class="codehilite"><pre><span></span><code>diff --git a/src/stream.rs b/src/stream.rs
index cf35ebc..6b0fa4d 100644
--- a/src/stream.rs
+++ b/src/stream.rs
@@ -220,6 +220,26 @@ impl Hasher for SeaHasher {
     }
 }

+impl SeaHasher {
+    /// njn: docs
+    pub fn finish128(&amp;self) -&gt; (u64, u64) {
+        /*
+        let a = if self.ntail &gt; 0 {
+            let tail = helper::read_int(&amp;self.tail.to_le_bytes()[..self.ntail])
;
+            helper::diffuse(self.state.0 ^ tail)
+        } else {
+            self.state.0
+        };
+        (
+            helper::diffuse(a ^ self.state.1 ^ self.written),
+            helper::diffuse(self.state.2 ^ self.state.3 + self.ntail as u64),
+        )
+        */
+        let x = self.finish();
+        (x, x)
+    }
+}
+
 #[cfg(test)]
 mod tests {
     use super::*;
</code></pre></div>



<a name="263941181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/263941181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#263941181">(Dec 06 2021 at 23:49)</a>:</h4>
<p>The commented out code there was my first attempt to produce a 128 bit value, the compiler failed to build <code>std</code> with that. So then I changed it to the <code>(x, x)</code> thing, which is stupid and not what you would do for real but was enough for benchmarking purposes, and successfully built <code>std</code>.</p>



<a name="264352525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/264352525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#264352525">(Dec 09 2021 at 19:18)</a>:</h4>
<p>I am guessing everyone is running all the benchmarks and picking the ones they like most to advertise their performance on.</p>



<a name="264393263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/264393263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#264393263">(Dec 10 2021 at 01:41)</a>:</h4>
<p>most of the hashing algorithms also aren't optimized for the incremental hash case, and Rust's Hash trait (nor rustc's StableHasher trait afaict) doesn't give us a good way to distinguish — I discussed the issue <a href="https://github.com/rust-lang/rust/issues/86161#issuecomment-916577133">https://github.com/rust-lang/rust/issues/86161#issuecomment-916577133</a> some.</p>



<a name="264393364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60StableHasher%60%20hashing%20algorithm/near/264393364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60StableHasher.60.20hashing.20algorithm.html#264393364">(Dec 10 2021 at 01:43)</a>:</h4>
<p>I'd expect this to matter a lot for the discrepancy between c++ hash algo benchmarks and rust ones. Depending on what kind of workload stablehasher uses, it might be worth tweaking the trait for this (a la <code>BuildHasher::hash_one</code>) and seeing if that makes a difference.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>