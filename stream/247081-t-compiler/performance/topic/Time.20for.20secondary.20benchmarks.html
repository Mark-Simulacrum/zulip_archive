<html>
<head><meta charset="utf-8"><title>Time for secondary benchmarks · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html">Time for secondary benchmarks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276974062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/276974062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#276974062">(Mar 29 2022 at 08:41)</a>:</h4>
<p>We're still finishing up adding/removing primary benchmarks, but I still wanted to kick off a conversation about the time it takes to run secondary benchmarks. As of right now it takes ~43 minutes to run primary benchmarks and ~39 minutes to run secondary. Since secondary are by definition less important than primary, is there anything we can do to reduce time in queue? Are there any situations where running secondary benchmarks is not necessary?</p>



<a name="276975913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/276975913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#276975913">(Mar 29 2022 at 08:59)</a>:</h4>
<p>In particular it feels wrong that we spend ~1m18s on every perf run checking for issue-46449 which is simply a regression test making sure we don't reintroduce an issue seen long ago. Do we really need to run this for try runs?</p>



<a name="276982137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/276982137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#276982137">(Mar 29 2022 at 10:01)</a>:</h4>
<blockquote>
<p>is there anything we can do to reduce time in queue? </p>
</blockquote>
<p>Run two of them in parallel with CPU-pinning? I'll likely increase noise and change results but that might be acceptable for secondary?</p>



<a name="276982906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/276982906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#276982906">(Mar 29 2022 at 10:08)</a>:</h4>
<ul>
<li>maybe separate them into two "runs", if there's a significant regression in a primary benchmark don't even run the secondary ones ?</li>
<li>maybe we try and see how slow the regression tests are when parallelism shouldn't matter much eg with cachegrind (if we also don't gather self-profile times or switch to gathering hw counters for that I don't know) and where we could pin and saturate all the cores for the leaf crates ?</li>
</ul>



<a name="277067421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277067421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277067421">(Mar 29 2022 at 21:32)</a>:</h4>
<p>issue-46449 has a <code>.patch</code> file which probably isn't useful, and could be removed. I'd argue that no secondary benchmarks need <code>.patch</code> files. Other ones that currently do: coercions, deep-vector, tuple-stress, unify-linearly, unused-warnings</p>



<a name="277067601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277067601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277067601">(Mar 29 2022 at 21:34)</a>:</h4>
<p>ctfe-stress-4 takes 2 minutes, I have shrinking that on the todo list</p>



<a name="277067707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277067707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277067707">(Mar 29 2022 at 21:35)</a>:</h4>
<p>So there is some trimming possible, but if we really want to reduce times, we should consider removing stm32f4 as <span class="user-mention" data-user-id="266526">@Jakub Beránek</span> suggested; it takes almost 10 minutes</p>



<a name="277068178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277068178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277068178">(Mar 29 2022 at 21:40)</a>:</h4>
<p>I only meant to use stm32f4 for rustdoc originally; changing it to only be Doc Full will probably cut down on the time tremendously</p>



<a name="277068189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277068189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277068189">(Mar 29 2022 at 21:40)</a>:</h4>
<p>I'd really prefer not to get rid of it altogether</p>



<a name="277068873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277068873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277068873">(Mar 29 2022 at 21:48)</a>:</h4>
<p>Oh, issue-46449 has <em>four</em> .patch files, that really seems unnecessary</p>



<a name="277068975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277068975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277068975">(Mar 29 2022 at 21:49)</a>:</h4>
<p>Though some of them are fiddling with a buffer size, perhaps that is an important part of what is measured</p>



<a name="277069085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277069085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277069085">(Mar 29 2022 at 21:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Time.20for.20secondary.20benchmarks/near/277068178">said</a>:</p>
<blockquote>
<p>I only meant to use stm32f4 for rustdoc originally; changing it to only be Doc Full will probably cut down on the time tremendously</p>
</blockquote>
<p>We don't currently have a way to mark a test as Doc only</p>



<a name="277098432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277098432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277098432">(Mar 30 2022 at 06:16)</a>:</h4>
<p>Happy to add that if you'll take the PR :)</p>



<a name="277099571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277099571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277099571">(Mar 30 2022 at 06:36)</a>:</h4>
<p>yeah I think that shouldn't be that hard. another way could just be to downgrade <code>stm</code> to the older version, which was faster to compile?</p>



<a name="277102328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277102328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277102328">(Mar 30 2022 at 07:13)</a>:</h4>
<p>Sure, or enable fewer features - I think it feature gates nearly everything</p>



<a name="277103530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277103530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277103530">(Mar 30 2022 at 07:26)</a>:</h4>
<p>it does, but already currently we only enable a single feature (it doesn't build without any features enabled)</p>



<a name="277103558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277103558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277103558">(Mar 30 2022 at 07:27)</a>:</h4>
<p>maybe there's some STM architecture/feature that is smaller/faster to compile than the one that we currently use though</p>



<a name="277103736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277103736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277103736">(Mar 30 2022 at 07:29)</a>:</h4>
<p>I did a quick check. All of the subparts of the crate (<code>stm32f405</code>, <code>stm32f401</code>, etc.) have a lot of code. The one that we currently use (...405) has 270k lines of code. the largest one has around 320k, the smallest one has 125k. so we could change the used feature to <code>stm32f410</code> (the smallest one), that should help</p>



<a name="277104230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277104230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277104230">(Mar 30 2022 at 07:34)</a>:</h4>
<p>Full debug build:<br>
current feature: 19.5s<br>
stm32f410 feature: 12s</p>
<p>Only last crate debug build:<br>
current feature: 13.3s<br>
stm32f410 feature: 6s</p>



<a name="277104249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277104249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277104249">(Mar 30 2022 at 07:34)</a>:</h4>
<p>so it's about 2x faster for the crate itself (which corresponds to having 2x less code)</p>



<a name="277263998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277263998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277263998">(Mar 31 2022 at 11:07)</a>:</h4>
<p>I opened a PR to switch this rustdoc benchmark to the less costly feature <a href="https://github.com/rust-lang/rustc-perf/pull/1265">https://github.com/rust-lang/rustc-perf/pull/1265</a> </p>
<p>the roughly 50% reduction is probably going to look weird on the perf report, graphs, etc but probably worth it.</p>



<a name="277380928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277380928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277380928">(Apr 01 2022 at 07:49)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> any objection to merging <span class="user-mention" data-user-id="116113">@lqd</span>'s PR? This makes comparisons for this benchmark a bit wonky for a little bit, and I just want to make sure we're all on board.</p>



<a name="277381327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277381327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277381327">(Apr 01 2022 at 07:54)</a>:</h4>
<p>I'm in favour of merging it!</p>



<a name="277381676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277381676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277381676">(Apr 01 2022 at 07:59)</a>:</h4>
<p>Done!</p>



<a name="277387206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277387206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277387206">(Apr 01 2022 at 08:54)</a>:</h4>
<p>maybe the benchmark should be renamed to avoid tainting the summary stats?</p>



<a name="277388593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277388593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277388593">(Apr 01 2022 at 09:07)</a>:</h4>
<p>this version has only been there for a few days</p>



<a name="277389481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277389481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277389481">(Apr 01 2022 at 09:15)</a>:</h4>
<p>This will likely cause whatever PR is benchmarked next as showing a huge perf improvement, but we'll have to just tell whoever is looking at the report to ignore this particular benchmark.</p>



<a name="277389787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277389787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277389787">(Apr 01 2022 at 09:19)</a>:</h4>
<p>exactly, that's why I mentioned this on the PR and here and waited for everyone to see it before merging. thankfully it's only going to be a one-time annoyance, compared to the more complex alternatives of removing the benchmark, having rustdoc only benchmarks, splitting primary and secondary runs for faster turnaround, etc</p>



<a name="277443886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277443886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277443886">(Apr 01 2022 at 16:27)</a>:</h4>
<p>Here's a try run that run into this: <a href="https://github.com/rust-lang/rust/pull/95562#issuecomment-1086098290">https://github.com/rust-lang/rust/pull/95562#issuecomment-1086098290</a></p>



<a name="277480619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Time%20for%20secondary%20benchmarks/near/277480619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Time.20for.20secondary.20benchmarks.html#277480619">(Apr 01 2022 at 21:34)</a>:</h4>
<p>It'll affect a handful of results this week, but then it'll stop being a problem. The time on <a href="https://perf.rust-lang.org/status.html">https://perf.rust-lang.org/status.html</a> has dropped from almost 10 minutes to 4m16s, which is great.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>