<html>
<head><meta charset="utf-8"><title>Caching debug info type names · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html">Caching debug info type names</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252641006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252641006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252641006">(Sep 09 2021 at 15:00)</a>:</h4>
<p>I’ve posted this around, but haven’t gotten any responses so I’ll try my luck here. No worries if I don’t get any here either.</p>
<p>I’m working on <a href="https://github.com/rust-lang/rust/issues/86431">#86431</a> and have a question about the uniqueness of TyKinds.</p>
<p>My idea is to add a <code>hashmap&lt;TyKind, String&gt;</code> field to The <code>Codegencx&lt;'ll, 'tcx&gt;</code> struct; and then use this hashmap in the various metadata functions in <code>rustc_codegen_llvm/src/debuginfo/metadata.rs</code> that call <code>compute_debuginfo_name()</code>.</p>
<p>Every time we compute a string for a type kind, we map the string to that kind, and cache the string. This avoids us to avoid recomputing repeat strings.</p>
<p>My only concern is that I don’t know enough about the compiler in general to know if there will be a 1:1 relationship between a given <code>TyKind</code> and and it’s “debuginfo type name”.</p>
<p>Also, as for how to analyze redundant work, my only solution is to profile the compiler before and after I’ve made changes, and observe differences. Is there a better way to go about this?</p>



<a name="252643015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252643015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252643015">(Sep 09 2021 at 15:13)</a>:</h4>
<p>I don't know this code well enough to really be of help, but it would be useful to know how often repeat debuginfo names are computed. That might start giving an small idea of how much make this change could help. Also is computing the name expensive or is this just an attempt to save allocations?</p>



<a name="252645385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252645385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252645385">(Sep 09 2021 at 15:28)</a>:</h4>
<p>Computing the name _can_ be expensive,  I think? Not sure how to define expensive.</p>
<p>Type names can get pretty long, and since the main method that does the work is recursive, caching repeat names would also eliminate redundant stack frames. This is what I mean by I think it’s expensive.</p>



<a name="252645593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252645593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252645593">(Sep 09 2021 at 15:29)</a>:</h4>
<p>I’m going to try and count how many times we add to the cache vs find something from it and then just take a ratio of those numbers.</p>



<a name="252645981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252645981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252645981">(Sep 09 2021 at 15:32)</a>:</h4>
<p>It might also be interesting to guestimate how often we're allocating during this process - for each string we find in the cache calculate how many allocations it takes to create that string (which I believe we can guess to be around the square root of the length of the string)</p>



<a name="252646040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252646040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252646040">(Sep 09 2021 at 15:32)</a>:</h4>
<p>Oooo that’s a good one. Gonna use that.</p>



<a name="252646173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252646173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252646173">(Sep 09 2021 at 15:34)</a>:</h4>
<p>Could you clarify what you mean by “allocations”?</p>



<a name="252646376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252646376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252646376">(Sep 09 2021 at 15:35)</a>:</h4>
<p>I mean the number of memory allocations we do to build the string debug info names</p>



<a name="252661297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252661297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252661297">(Sep 09 2021 at 17:11)</a>:</h4>
<p>Since a <code>TyKind</code> contains the substitutions "substs" which are the actual types, lifetimes and const values the type is instantiated with, it should be 1:1 with the type name.</p>



<a name="252787105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252787105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252787105">(Sep 10 2021 at 13:32)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> do you know if the relationship between a UniqueTypeId and its type name is also 1:1?</p>



<a name="252787959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252787959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252787959">(Sep 10 2021 at 13:37)</a>:</h4>
<p>Based on this line, I believe that is true <a href="https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/compiler/rustc_codegen_llvm/src/debuginfo/metadata.rs#L103-L104">https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/compiler/rustc_codegen_llvm/src/debuginfo/metadata.rs#L103-L104</a></p>



<a name="252789315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/252789315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#252789315">(Sep 10 2021 at 13:47)</a>:</h4>
<p>That’s what I assumed, just wanted to make sure I understand correctly. Thank you!</p>



<a name="253177914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Caching%20debug%20info%20type%20names/near/253177914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Caching.20debug.20info.20type.20names.html#253177914">(Sep 13 2021 at 23:50)</a>:</h4>
<p>Is there an ideal approach for tracking how many times we are accessing an arbitrary map using the profiler?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>