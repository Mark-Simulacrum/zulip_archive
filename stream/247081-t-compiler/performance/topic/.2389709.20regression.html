<html>
<head><meta charset="utf-8"><title>#89709 regression · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html">#89709 regression</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257088870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257088870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257088870">(Oct 11 2021 at 16:40)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/89709">https://github.com/rust-lang/rust/pull/89709</a> had negative perf impact of almost 3% on some benchmarks, should we revert?</p>



<a name="257088905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257088905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257088905">(Oct 11 2021 at 16:40)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="249967">@Clemens Wasser</span></p>



<a name="257089087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257089087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257089087">(Oct 11 2021 at 16:42)</a>:</h4>
<p>I wonder if it is somehow salvageable...?<br>
There was one <code>debug_assert</code> turned into an actual <code>assert</code>, I wonder how much of an impact that had...<br>
<a href="https://github.com/rust-lang/rust/pull/89709/files#diff-39dc2906167489754ec214d1c9375ae076b3e70193c40daa00ee702ff658b006L615">https://github.com/rust-lang/rust/pull/89709/files#diff-39dc2906167489754ec214d1c9375ae076b3e70193c40daa00ee702ff658b006L615</a></p>



<a name="257089139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257089139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Clemens Wasser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257089139">(Oct 11 2021 at 16:42)</a>:</h4>
<p>Yeah also think it's the assert</p>



<a name="257090043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257090043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257090043">(Oct 11 2021 at 16:49)</a>:</h4>
<p>some of the iterator changes are suspicious too, e.g. the <code>by_ref</code> ones tend to optimize less well. Or changing a range to an enumerate.</p>



<a name="257090859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257090859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257090859">(Oct 11 2021 at 16:57)</a>:</h4>
<p>Checking with cachegrind where the extra instructions are may help, but with so many changes spread across the compiler it'll be pretty hard I'd guess.</p>



<a name="257093376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257093376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257093376">(Oct 11 2021 at 17:19)</a>:</h4>
<p>we could start with reverting the assert change and do another perf run on the new pr to see if that fixes it..? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="257429105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257429105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257429105">(Oct 13 2021 at 20:06)</a>:</h4>
<p>I reverted two changes that looked suspicious to me in <a href="https://github.com/rust-lang/rust/pull/89855">https://github.com/rust-lang/rust/pull/89855</a></p>



<a name="257429151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257429151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257429151">(Oct 13 2021 at 20:07)</a>:</h4>
<p>could I get a perf-run to see if that fixes it (or at least a part of it?)</p>



<a name="257429409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257429409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257429409">(Oct 13 2021 at 20:08)</a>:</h4>
<p>ok Oli already launched the perf run &lt;3</p>



<a name="257468922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%2389709%20regression/near/257468922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.2389709.20regression.html#257468922">(Oct 14 2021 at 02:14)</a>:</h4>
<p>no perf change from that pr</p>
<p>cachegrind diff shows that the regression is definitely in <code>compress</code> though</p>
<div class="codehilite"><pre><span></span><code># from `cargo +nightly run --release --bin collector -- diff_local cachegrind --include keccak --builds Check --runs Full +86d6d2b7389fe1b339402c1798edae8b695fc9ef +6ae8912a3e7d2c4c775024f58a7ba4b1aedc4073`
--------------------------------------------------------------------------------
Ir           file:function
--------------------------------------------------------------------------------
802,108,819  ???:rustc_data_structures::obligation_forest::ObligationForest&lt;O&gt;::compress
 -3,521,355  ???:hashbrown::map::RawEntryBuilderMut&lt;K,V,S,A&gt;::from_hash
   -979,456  ???:rustc_middle::ty::context::CtxtInterners::intern_predicate
   -854,829  obj/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/build/tikv-jemalloc-sys-fde45a9a697cc078/out/build/src/extent.c:extent_recycle
</code></pre></div>
<p>so it's likely caused by the change from manual indexing -&gt; iter_mut + enumerate in that loop</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>