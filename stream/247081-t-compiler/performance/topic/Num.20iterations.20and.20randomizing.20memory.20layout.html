<html>
<head><meta charset="utf-8"><title>Num iterations and randomizing memory layout · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html">Num iterations and randomizing memory layout</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249369895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/249369895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#249369895">(Aug 13 2021 at 14:51)</a>:</h4>
<p>I'd like to talk about the amount of iterations we're doing per test run and the effects of memory layout on performance.</p>
<p>There's a great talk about how to control for the effects of memory <a href="https://www.youtube.com/watch?v=r-TLSBdHe1A">layout</a> along with a corresponding <a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.363.802&amp;rep=rep1&amp;type=pdf">paper</a>. The tl;dr is that uninteresting factors such as environment variables, linker arg order, etc. can cause pretty large performance impacts because they shift things in memory.</p>
<div class="youtube-video message_inline_image"><a data-id="r-TLSBdHe1A" href="https://www.youtube.com/watch?v=r-TLSBdHe1A"><img src="https://uploads.zulipusercontent.net/06bee759c1dbe2c4354c820cedf34a8b3c178c93/68747470733a2f2f692e7974696d672e636f6d2f76692f722d544c534264486531412f64656661756c742e6a7067"></a></div><p>The talk and paper introduce a <a href="https://github.com/ccurtsinger/stabilizer">tool</a> called Stabilizer which randomly lays out programs in memory and continuously re-randomizes the layout during execution to try to control for these effects. Unfortunately, the tool isn't usable today as it only works with LLVM 3.0 and it's missing many features that Rust uses (like handling stack unwinding).</p>
<p>I do wonder if we could try to control more for things like memory layout by running more iterations and doing some things like randomizing linker arg order. Ultimately it would be good if we could produce normal distributions for at least some test cases, but that might be a pipe dream because even under perfect conditions we'd likely have to run a test case ~30 times or so which we might not have the resources for. </p>
<p>Any thoughts on number of iterations of test runs and how to control for the effects of memory layout in our benchmarking?</p>



<a name="249373135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/249373135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#249373135">(Aug 13 2021 at 15:14)</a>:</h4>
<p>My memory is that "Rigorous benchmarking in reasonable time” by Kalibera and Jones is a good paper on the subject of determining an appropriate number of iterations, though its been a while since I looked at it.</p>



<a name="249378005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/249378005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#249378005">(Aug 13 2021 at 15:54)</a>:</h4>
<p>What "things" are being shifted? stacks? dynamic libs? allocator calls? ...?</p>



<a name="249378844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/249378844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#249378844">(Aug 13 2021 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="224872">@rylev</span> FWIW, it's pretty easy for us to queue up a one-off run to collect 30x repetitions on some benchmarks (or doing so locally). For some benchmarks we could plausibly do that for all runs, too, though I personally am not sure we're quite at that level of precision yet.</p>
<p>My impression historically has been that the benchmarks we call noisy (e.g., coercions-debug) are not such due to perturbations of memory layout and such, rather, it's hashmaps or other such sources that aren't really external actors, it's built in noise we can't eliminate without changes to program structure.</p>



<a name="249379372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/249379372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#249379372">(Aug 13 2021 at 16:05)</a>:</h4>
<blockquote>
<p>My impression historically has been that the benchmarks we call noisy (e.g., coercions-debug) are not such due to perturbations of memory layout and such, rather, it's hashmaps or other such sources that aren't really external actors, it's built in noise we can't eliminate</p>
</blockquote>
<p>To be clear, I think the utility of doing more runs is to build distributions for test cases for a given artifact that we could use to more accurately compare against runs for a different artifact. This would allow us to more accurately tell when differences between two artifacts are actually significant. Right now the 0.2% significance threshold is completely arbitrary</p>



<a name="249380631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/249380631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#249380631">(Aug 13 2021 at 16:17)</a>:</h4>
<p>This is all likely to not be feasible but it’s just something I wanted us to think about</p>



<a name="258333368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/258333368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#258333368">(Oct 20 2021 at 08:52)</a>:</h4>
<p>Has the new <a href="https://github.com/rust-lang/rust/pull/87868">-Z randomize-layout</a> feature been discussed as a way to improve perf run fidelity?</p>



<a name="258417187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/258417187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#258417187">(Oct 20 2021 at 18:17)</a>:</h4>
<p>how would it help?</p>



<a name="258492544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/258492544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#258492544">(Oct 21 2021 at 06:04)</a>:</h4>
<p>it would introduce perturbation of memory layout. But I think it would be small compared to what we want…?</p>



<a name="258604100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Num%20iterations%20and%20randomizing%20memory%20layout/near/258604100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Num.20iterations.20and.20randomizing.20memory.20layout.html#258604100">(Oct 21 2021 at 19:34)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> they posted this <a href="https://youtu.be/r-TLSBdHe1A">video</a> awhile back on this thread. </p>
<div class="youtube-video message_inline_image"><a data-id="r-TLSBdHe1A" href="https://youtu.be/r-TLSBdHe1A"><img src="https://uploads.zulipusercontent.net/06bee759c1dbe2c4354c820cedf34a8b3c178c93/68747470733a2f2f692e7974696d672e636f6d2f76692f722d544c534264486531412f64656661756c742e6a7067"></a></div><p>FWIW I had the same question and thought the video did a good job of explaining it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>