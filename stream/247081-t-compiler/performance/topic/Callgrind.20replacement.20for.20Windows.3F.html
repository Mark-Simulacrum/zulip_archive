<html>
<head><meta charset="utf-8"><title>Callgrind replacement for Windows? · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html">Callgrind replacement for Windows?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266039045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266039045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266039045">(Dec 25 2021 at 03:28)</a>:</h4>
<p>There's a bunch of sampling profilers for Windows, but they are not very suitable for analyzing small differences like the regression in <a href="https://github.com/rust-lang/rust/issues/92245">#92245</a> on helloworld - the relevant code just doesn't get covered by samples.</p>
<p>I need something working like callgrind - converting everything into IR and interpreting it, thus taking all executed code into account.<br>
Maybe something based on Qemu or DynamoRIO? (Both work on Windows, more or less.)<br>
A quick search didn't give any results.</p>



<a name="266039059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266039059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266039059">(Dec 25 2021 at 03:29)</a>:</h4>
<hr>
<p>Also, a side question - is there any tool for producing diffs for callgrind outputs?</p>



<a name="266050032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266050032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266050032">(Dec 25 2021 at 08:59)</a>:</h4>
<blockquote>
<p>Also, a side question - is there any tool for producing diffs for callgrind outputs?</p>
</blockquote>
<p>cg_diff, right?</p>



<a name="266050922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266050922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266050922">(Dec 25 2021 at 09:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Callgrind.20replacement.20for.20Windows.3F/near/266050032">said</a>:</p>
<blockquote>
<blockquote>
<p>Also, a side question - is there any tool for producing diffs for callgrind outputs?</p>
</blockquote>
<p>cg_diff, right?</p>
</blockquote>
<p>Doesn't work on callgrind outputs, unfortunately, only on cachegrind.</p>



<a name="266056519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266056519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266056519">(Dec 25 2021 at 12:02)</a>:</h4>
<p>I found where I've seen it - <a href="https://blog.mozilla.org/nnethercote/2010/06/30/cg_diff-a-differential-profiling-tool/">https://blog.mozilla.org/nnethercote/2010/06/30/cg_diff-a-differential-profiling-tool/</a><br>
So you have to use a larger hammer an run with cachegrind instead of callgrind, but it also collects all the relevant information allowing to count instructions, and the output can be used with cg_diff.</p>



<a name="266058620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266058620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266058620">(Dec 25 2021 at 13:02)</a>:</h4>
<p>If WSL is acceptable, it can run callgrind IIRC; I don’t remember if WSL can run the perf collector though, but if so and if cachegrind is also acceptable to you to get the diff: the collector does support cg_diff as one of the local benchmarking tools with the "diff_local  cachegrind" command</p>



<a name="266058766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266058766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266058766">(Dec 25 2021 at 13:07)</a>:</h4>
<p>(Otherwise tracy can also compute diffs between profiles, and could be interesting to look at; marking the zones manually eg with nagisa’s client, to avoid using sampling)</p>



<a name="266059707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266059707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266059707">(Dec 25 2021 at 13:35)</a>:</h4>
<blockquote>
<p>If WSL is acceptable, it can run callgrind IIRC</p>
</blockquote>
<p>Yeah, that's what I ended up doing.</p>



<a name="266059911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266059911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266059911">(Dec 25 2021 at 13:41)</a>:</h4>
<hr>
<p>The next problem with the diff is that <a href="https://github.com/rust-lang/rust/issues/92245">#92245</a> changes function signatures which seems to change hashes in symbol names (with legacy mangling), breaking the diff entirely. Sigh, I guess I'll have to enable v0 mangling an lose demangled names if I want the diff.</p>



<a name="266061996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266061996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266061996">(Dec 25 2021 at 14:41)</a>:</h4>
<p>If you compile valgrind locally from master it should support v0 mangling now, fwiw</p>



<a name="266062721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266062721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266062721">(Dec 25 2021 at 15:01)</a>:</h4>
<blockquote>
<p>I don’t remember if WSL can run the perf collector though</p>
</blockquote>
<p>WSL2 on Windows 10 supports only software events for <code>perf</code> but with Windows 11 hardware events support has been added.</p>



<a name="266063138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266063138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266063138">(Dec 25 2021 at 15:14)</a>:</h4>
<p>For sampling / hardware events the native WPA is fine, don't even need WSL.</p>



<a name="266741221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266741221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266741221">(Jan 03 2022 at 21:56)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> There's an old attempt at a callgrind_diff at <a href="https://bugs.kde.org/show_bug.cgi?id=399355">https://bugs.kde.org/show_bug.cgi?id=399355</a>, might still work, but no promises.</p>



<a name="266741262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266741262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266741262">(Jan 03 2022 at 21:56)</a>:</h4>
<p>From what I remember, it worked for the Callgrind invocation I used, but had some problems with some other invocations. The Callgrind file format is <em>very</em> complicated, alas</p>



<a name="266741401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266741401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266741401">(Jan 03 2022 at 21:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Callgrind.20replacement.20for.20Windows.3F/near/266056519">said</a>:</p>
<blockquote>
<p>So you have to use a larger hammer an run with cachegrind instead of callgrind, but it also collects all the relevant information allowing to count instructions, and the output can be used with cg_diff.</p>
</blockquote>
<p>I don't understand this comment. Cachegrind is simpler and collects less information than Callgrind, so I would describe <em>Callgrind</em> as the larger hammer. Have I misunderstood?</p>



<a name="266763914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266763914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266763914">(Jan 04 2022 at 02:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Callgrind.20replacement.20for.20Windows.3F/near/266741401">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Callgrind.20replacement.20for.20Windows.3F/near/266056519">said</a>:</p>
<blockquote>
<p>So you have to use a larger hammer an run with cachegrind instead of callgrind, but it also collects all the relevant information allowing to count instructions, and the output can be used with cg_diff.</p>
</blockquote>
<p>I don't understand this comment. Cachegrind is simpler and collects less information than Callgrind, so I would describe <em>Callgrind</em> as the larger hammer. Have I misunderstood?</p>
</blockquote>
<p>Looks like a wrong analogy from my side.<br>
I didn't use cachegrind myself and assumed that cache simulation slows down valgrind significantly after recalling enabling cache simulation in other simulators.</p>



<a name="266764495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266764495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266764495">(Jan 04 2022 at 03:06)</a>:</h4>
<p>perf collector runs cachegrind without cache simulation</p>



<a name="266772945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266772945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266772945">(Jan 04 2022 at 06:06)</a>:</h4>
<p>And callgrind also has a cache simulator. Callgrind is just cachegrind with a bunch of extra stuff, basically.</p>



<a name="266772953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Callgrind%20replacement%20for%20Windows%3F/near/266772953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Callgrind.20replacement.20for.20Windows.3F.html#266772953">(Jan 04 2022 at 06:06)</a>:</h4>
<p>(rustc-perf also runs Callgrind with the cache simulation disabled, too)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>