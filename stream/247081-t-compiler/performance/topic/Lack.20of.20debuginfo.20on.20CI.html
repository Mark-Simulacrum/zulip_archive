<html>
<head><meta charset="utf-8"><title>Lack of debuginfo on CI · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html">Lack of debuginfo on CI</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270672909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270672909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270672909">(Feb 04 2022 at 06:22)</a>:</h4>
<p>I just tried downloading some compilers built on CI and running Cachegrind on them and I see they aren't built with debuginfo, so they don't have filenames and line numbers, which greatly reduces the usefulness of the Cachegrind profiles.</p>



<a name="270672921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270672921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270672921">(Feb 04 2022 at 06:23)</a>:</h4>
<p>I think we need to add <code>[rust] debuginfo.level = 1</code> somewhere, maybe <a href="https://github.com/rust-lang/rust/blob/5e57faa78aa7661c6000204591558f6665f11abc/src/ci/run.sh#L46">here</a>?</p>



<a name="270707832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270707832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270707832">(Feb 04 2022 at 12:34)</a>:</h4>
<p>I'd love to see this, but I think it needs to wait until we have split debug info support (which I think is actually nearly ready) so we avoid a greatly larger binary/library for everyone - but I haven't actually measured this recently.</p>
<p>I think librustc_driver today is roughly 50% debug info by size, even without having really enabled it. (I might be misremembering though).</p>



<a name="270726116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270726116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270726116">(Feb 04 2022 at 15:01)</a>:</h4>
<p>Any chace split debuginfo will let us go to <code>[rust] debuginfo.level = 2</code>, <span class="user-mention" data-user-id="116122">@simulacrum</span> ?</p>



<a name="270726176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270726176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270726176">(Feb 04 2022 at 15:02)</a>:</h4>
<p>Hm, well, I mean <em>maybe</em>?</p>



<a name="270726252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270726252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270726252">(Feb 04 2022 at 15:02)</a>:</h4>
<p>I'm not sure if you can effectively subset (e.g., dropping a section from your binary or something)</p>



<a name="270726285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270726285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270726285">(Feb 04 2022 at 15:02)</a>:</h4>
<p>I'd want to avoid a multi-GB .so file being distributed</p>



<a name="270726856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270726856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270726856">(Feb 04 2022 at 15:06)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ du -ah *.so
97M     libLLVM-13-rust-1.60.0-nightly.so
114M    librustc_driver-90a6e5ec2da8350e.so
8.6M    libstd-a734ee5340eb75e5.so
2.7M    libtest-c40098a0cd66f731.so
$ strip *.so
$ du -ah *.so
77M     libLLVM-13-rust-1.60.0-nightly.so
59M     librustc_driver-90a6e5ec2da8350e.so
5.1M    libstd-a734ee5340eb75e5.so
920K    libtest-c40098a0cd66f731.so
</code></pre></div>
<p>So a pretty big chunk already in debuginfo (this is the libraries rustc links to, so modulo ICE backtraces it's entirely useless I think)</p>



<a name="270727025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270727025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270727025">(Feb 04 2022 at 15:07)</a>:</h4>
<p>FWIW, I have heard complaints about Rust's install size, and shipping stripped binaries could help with that. We'd presumably need some kind of separate debuginfo copy like what Firefox does to recover symbols, I guess</p>



<a name="270727051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270727051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270727051">(Feb 04 2022 at 15:07)</a>:</h4>
<p>(to deal with in the wild ICEs)</p>



<a name="270729601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270729601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270729601">(Feb 04 2022 at 15:26)</a>:</h4>
<p>41% of the size of <a href="http://librustc_driver.so">librustc_driver.so</a> is <code>.strtab</code> which contains symbol names. While probably not strictly abi conforming, maybe it would be possible to compress this section the same way debuginfo sections can be compressed and then have backtrace-rs decompress it on the fly if a panic happens? Or alternatively move the symbols to a separate elf file that is gzip compressed and can be manually decompressed when trying to use a debugger.</p>



<a name="270729943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270729943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270729943">(Feb 04 2022 at 15:29)</a>:</h4>
<p>Could compress symbols like Fedora does: <a href="https://fedoraproject.org/wiki/Features/MiniDebugInfo">https://fedoraproject.org/wiki/Features/MiniDebugInfo</a></p>



<a name="270729980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270729980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270729980">(Feb 04 2022 at 15:29)</a>:</h4>
<p><a href="https://sourceware.org/gdb/onlinedocs/gdb/MiniDebugInfo.html">https://sourceware.org/gdb/onlinedocs/gdb/MiniDebugInfo.html</a></p>



<a name="270730391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270730391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270730391">(Feb 04 2022 at 15:32)</a>:</h4>
<p>Also, if we split debuginfo in a post-processing step like rpms do, they could be served for download by elfutils-debuginfod</p>



<a name="270730667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270730667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270730667">(Feb 04 2022 at 15:35)</a>:</h4>
<p>I presume many people will not be happy if an ICE will suddenly result in downloading debuginfo from the internet though.</p>



<a name="270730918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270730918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270730918">(Feb 04 2022 at 15:36)</a>:</h4>
<p>Sure, probably not by default, but the server setting can be suggested as an environment variable, just like we do for <code>RUST_BACKTRACE</code>.</p>



<a name="270731034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270731034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270731034">(Feb 04 2022 at 15:37)</a>:</h4>
<p>I am afraid that will significantly reduce the quality of the <em>average</em> ICE reported.</p>



<a name="270731243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270731243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270731243">(Feb 04 2022 at 15:39)</a>:</h4>
<p>well, my hope would be that we'd report the addresses and symbolicate on a server or something we run</p>



<a name="270731261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270731261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270731261">(Feb 04 2022 at 15:39)</a>:</h4>
<p>I'm suggesting both: mini-debuginfo for compressed symbols to keep the status quo, and full debuginfo as a download.</p>



<a name="270731400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270731400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270731400">(Feb 04 2022 at 15:40)</a>:</h4>
<blockquote>
<p>well, my hope would be that we'd report the addresses and symbolicate on a server or something we run</p>
</blockquote>
<p>I would be fine with this provided we get a bot automatically symbolicating reported ice's and posting the results on the respective issue.</p>



<a name="270731525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270731525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270731525">(Feb 04 2022 at 15:41)</a>:</h4>
<p>We'd need this though: <a href="https://github.com/rust-lang/backtrace-rs/issues/430">https://github.com/rust-lang/backtrace-rs/issues/430</a></p>



<a name="270734672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270734672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270734672">(Feb 04 2022 at 16:02)</a>:</h4>
<p>could debug info be distributed as a separate rustup component?</p>



<a name="270745344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270745344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270745344">(Feb 04 2022 at 17:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Lack.20of.20debuginfo.20on.20CI/near/270707832">said</a>:</p>
<blockquote>
<p>I'd love to see this, but I think it needs to wait until we have split debug info support (which I think is actually nearly ready) so we avoid a greatly larger binary/library for everyone - but I haven't actually measured this recently.</p>
<p>I think librustc_driver today is roughly 50% debug info by size, even without having really enabled it. (I might be misremembering though).</p>
</blockquote>
<p>Split debug info support lets us natively generate split debug info directly, but even without that support, we can split debug info <em>after</em> the fact, using <code>objcopy</code>.</p>



<a name="270746314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270746314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270746314">(Feb 04 2022 at 17:29)</a>:</h4>
<p>There also is <code>unstrip</code> to merge them back in</p>



<a name="270746425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270746425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270746425">(Feb 04 2022 at 17:30)</a>:</h4>
<p>Well, when I say support I also mean in our backtrace generation and such.</p>
<p>I agree objcopy or similar are fine for our purposes (and may even work better given our need to split out debug info from c/c++ compilation too)</p>



<a name="270748377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270748377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270748377">(Feb 04 2022 at 17:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Lack.20of.20debuginfo.20on.20CI/near/270746425">said</a>:</p>
<blockquote>
<p>Well, when I say support I also mean in our backtrace generation and such.</p>
</blockquote>
<p>Ah, right.</p>



<a name="270748514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270748514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270748514">(Feb 04 2022 at 17:46)</a>:</h4>
<p>Also, objcopy has a <code>--compress-debug-section</code> option that uses zlib.</p>



<a name="270748547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Lack%20of%20debuginfo%20on%20CI/near/270748547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Lack.20of.20debuginfo.20on.20CI.html#270748547">(Feb 04 2022 at 17:46)</a>:</h4>
<p>So if we can add support for that in our backtraces, we could ship something smaller.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>