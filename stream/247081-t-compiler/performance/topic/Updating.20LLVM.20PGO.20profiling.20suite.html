<html>
<head><meta charset="utf-8"><title>Updating LLVM PGO profiling suite · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html">Updating LLVM PGO profiling suite</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274385620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Updating%20LLVM%20PGO%20profiling%20suite/near/274385620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html#274385620">(Mar 07 2022 at 12:45)</a>:</h4>
<p>While experimenting with BOLT, I noticed that when PGO profiles for LLVM are being gathered on CI, only <code>libcore</code> is compiled (although both in debug and release modes). I tried to expand this to run <code>rustc-perf</code> with <code>syn</code>, <code>cargo</code> and <code>serde</code>and the results looks quite good: <a href="https://github.com/rust-lang/rust/pull/94677#issuecomment-1060628780">https://github.com/rust-lang/rust/pull/94677#issuecomment-1060628780</a>.</p>
<p>I think that it could be worthwhile to land this change and gather LLVM profiles from more crates. The question then becomes what crates, of course :) Rust PGO is gathered on <code>externs,ctfe-stress-4,inflate,cargo,token-stream-stress,match-stress-enum</code>, which are mostly synthetic benchmarks (apart from <code>cargo</code> of course). Maybe the new primary/secondary benchmark split could be used to guide this? <span class="user-mention" data-user-id="120989">@nnethercote</span> <span class="user-mention" data-user-id="116122">@simulacrum</span></p>



<a name="274385738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Updating%20LLVM%20PGO%20profiling%20suite/near/274385738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html#274385738">(Mar 07 2022 at 12:46)</a>:</h4>
<p>We should be careful about increasing the CI time of that builder; in general I would probably go for some of the more llvm heavy benchmarks and just try things out.</p>



<a name="274386945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Updating%20LLVM%20PGO%20profiling%20suite/near/274386945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html#274386945">(Mar 07 2022 at 12:56)</a>:</h4>
<p>The new build took 1h 18 minutes, which is on par with what it took previously I think (e.g. <a href="https://github.com/rust-lang-ci/rust/runs/5445521363?check_suite_focus=true">https://github.com/rust-lang-ci/rust/runs/5445521363?check_suite_focus=true</a>). This will get much worse with BOLT though, but that's a different topic.</p>



<a name="274387120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Updating%20LLVM%20PGO%20profiling%20suite/near/274387120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html#274387120">(Mar 07 2022 at 12:58)</a>:</h4>
<p>Yeah, I think today it's closer to 1.5 hours typically, but could easily be noise</p>



<a name="274435932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Updating%20LLVM%20PGO%20profiling%20suite/near/274435932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html#274435932">(Mar 07 2022 at 18:25)</a>:</h4>
<p>I created a separate PR for updating the PGO profiles: <a href="https://github.com/rust-lang/rust/pull/94704">https://github.com/rust-lang/rust/pull/94704</a>. It seemed to help a lot, so I think that it would be worthwhile to merge it, as it doesn't even seem that there are regressions.</p>



<a name="274461229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Updating%20LLVM%20PGO%20profiling%20suite/near/274461229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Updating.20LLVM.20PGO.20profiling.20suite.html#274461229">(Mar 07 2022 at 21:33)</a>:</h4>
<p>Yeah, the benchmark selection for PGO looks pretty bad! Definitely should revisit this once we've upgraded the benchmarks</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>