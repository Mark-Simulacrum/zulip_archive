<html>
<head><meta charset="utf-8"><title>PRs #91230 and #91318 · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html">PRs #91230 and #91318</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263577639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263577639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263577639">(Dec 03 2021 at 13:17)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/91318">#91318</a> was a follow-up PR to <a href="https://github.com/rust-lang/rust/issues/91230">#91230</a> (on which this topic was originally focused).  Some minor perf regressions were reported after merge.  I've posted a cg_diff in <a href="https://github.com/rust-lang/rust/pull/91318#issuecomment-985506557">a comment on the PR</a>; as mentioned there, I'm not too sure whether it's (again) just LLVM/PGO optimisations or whether perhaps a lack of inlining some of the new cross-crate methods (that merely delegate to others, namely those in the blanket impl of <code>FallibleTypeFolder</code> for infallible folders) might be at fault.  Mostly this is my unfamiliarity with reading/interpreting cachegrind diffs however, so any pointers much appreciated!</p>



<a name="263580638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263580638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263580638">(Dec 03 2021 at 13:39)</a>:</h4>
<p>I think this is just a change in inlining. Not sure there's anything to do.</p>



<a name="263580969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263580969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263580969">(Dec 03 2021 at 13:42)</a>:</h4>
<p>We could mark those methods in the blanket impl <code>#[inline]</code> though, and then if the foldable and folder are in the same crate the whole thing can be locally optimized without calling across to <code>rustc_middle</code>?  (I <em>think</em>, at least).</p>



<a name="263581000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263581000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263581000">(Dec 03 2021 at 13:42)</a>:</h4>
<p>Perhaps I'll open a PR so that can be perf tested?</p>



<a name="263584179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263584179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263584179">(Dec 03 2021 at 14:06)</a>:</h4>
<p>Also quite interesting how the post-merge perf of <a href="https://github.com/rust-lang/rust/issues/91230">#91230</a> was so different from that discussed above.  See <a href="https://github.com/rust-lang/rust/pull/91230#issuecomment-985547210">https://github.com/rust-lang/rust/pull/91230#issuecomment-985547210</a></p>



<a name="263594319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263594319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263594319">(Dec 03 2021 at 15:21)</a>:</h4>
<p>I wonder, did the profile used by CI for PGO get updated between the two runs (25th vs 28th November)?</p>



<a name="263602262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263602262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263602262">(Dec 03 2021 at 16:19)</a>:</h4>
<p>PGO info regenerated on every build</p>



<a name="263602450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PRs%20%2391230%20and%20%2391318/near/263602450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PRs.20.2391230.20and.20.2391318.html#263602450">(Dec 03 2021 at 16:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile#L125">https://github.com/rust-lang/rust/blob/master/src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile#L125</a><br>
<a href="https://github.com/rust-lang/rust/blob/master/src/ci/pgo.sh">https://github.com/rust-lang/rust/blob/master/src/ci/pgo.sh</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>