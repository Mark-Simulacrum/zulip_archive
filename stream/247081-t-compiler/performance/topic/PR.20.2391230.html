<html>
<head><meta charset="utf-8"><title>PR #91230 · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html">PR #91230</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262786079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262786079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262786079">(Nov 26 2021 at 11:23)</a>:</h4>
<p>I'm looking into the perf regression arising from this PR, but this is my first foray into using rustc-perf/collector.  I've pulled the toolchains with <code>rustup-toolchain-install-master</code>, but on running <code>collector profile_local cachegrind</code> rustup complains that it cannot find <code>cargo</code>:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>$ rustup which cargo
/usr/local/rustup/toolchains/1.56.0-x86_64-unknown-linux-gnu/bin/cargo
$ ./collector profile_local cachegrind +862962b90e59c5c1e217df74de80d3a81eee42f4 before --builds Check --include diesel --runs Full
collector error: `rustup which cargo` exited with status exit status: 101
stderr=thread 'main' panicked at 'binary not found', src/cli/rustup_mode.rs:1053:6
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>
<p>Do I need to install cargo for the rustc toolchains that are to be benchmarked and, if so, how (<code>rustup component add --toolchain ... cargo</code> complains that <code>... is a custom toolchain</code>)?</p>



<a name="262788003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262788003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262788003">(Nov 26 2021 at 11:45)</a>:</h4>
<p>Ah.  Installing a nightly toolchain fixed it.  I'll open a PR shortly to provide a better error message in this case.</p>



<a name="262788124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262788124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262788124">(Nov 26 2021 at 11:47)</a>:</h4>
<p>there's a recently added command that does it automatically</p>
<div class="codehilite"><pre><span></span><code>collector diff_local cachegrind +commitID1 +commitID2
</code></pre></div>
<p>Automatically downloads the appropriate versions if you have rustup-toolchain-installer-master installed.</p>



<a name="262788288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262788288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262788288">(Nov 26 2021 at 11:49)</a>:</h4>
<p>Aye, I was using that at first and got the same error so delved deeper and tried with <code>profile_local</code> directly.  The problem was that (in this container) I didn't have a nightly toolchain installed.</p>



<a name="262794589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262794589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262794589">(Nov 26 2021 at 13:01)</a>:</h4>
<p>I've posted the cg_diff in <a href="https://github.com/rust-lang/rust/pull/91230#issuecomment-979960152">a comment on the PR</a> (click to expand details).  Nothing obvious is readily jumping out at me so I'll continue investigating, but maybe someone more familiar with the compiler might readily notice something I've missed?  Grateful if anyone has 30 seconds to take a quick peek.</p>



<a name="262797002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262797002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262797002">(Nov 26 2021 at 13:26)</a>:</h4>
<p>hmm, the regressions there look mostly balanced with the improvements, but in different functions - I wonder if LLVM just made different optimization decisions?</p>



<a name="262797027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262797027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262797027">(Nov 26 2021 at 13:26)</a>:</h4>
<p>(having PGO on makes this hard to diagnose IMO)</p>



<a name="262798521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262798521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262798521">(Nov 26 2021 at 13:41)</a>:</h4>
<p>Hmmmm... is PGO enabled?  The compilers themselves aren't emitting <code>.profraw</code> files so I guess they weren't compiled with instrumentation; and I don't see any PGO args amongst those passed to the invocations?</p>



<a name="262798728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262798728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262798728">(Nov 26 2021 at 13:43)</a>:</h4>
<p>not locally, but in CI</p>



<a name="262798812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262798812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262798812">(Nov 26 2021 at 13:44)</a>:</h4>
<p>Ah, CI feeds in some profile when the compilers were built?  Gotcha.</p>



<a name="262799497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262799497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eggyal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262799497">(Nov 26 2021 at 13:51)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="232957">@Jack Huey</span> FYI</p>



<a name="262799876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262799876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262799876">(Nov 26 2021 at 13:55)</a>:</h4>
<p>I somewhat expected this might just be "noise" from llvm</p>



<a name="262799982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391230/near/262799982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391230.html#262799982">(Nov 26 2021 at 13:57)</a>:</h4>
<p>I don't think it's worth looking deeper into it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>