<html>
<head><meta charset="utf-8"><title>Inter crate sharing · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html">Inter crate sharing</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275974246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275974246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vikram Pal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275974246">(Mar 20 2022 at 16:12)</a>:</h4>
<p>Topic for inter crate sharing aspirations as defined on this <a href="https://blog.rust-lang.org/inside-rust/2022/02/22/compiler-team-ambitions-2022.html">page</a></p>



<a name="275974429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275974429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vikram Pal <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275974429">(Mar 20 2022 at 16:16)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="116113">@lqd</span> , <span class="user-mention" data-user-id="120989">@nnethercote</span> </p>
<ul>
<li>as I see on this <a href="https://blog.rust-lang.org/inside-rust/2022/02/22/compiler-team-ambitions-2022.html">page</a>, "For example, the metadata from libstd is read and decoded on every single crate compile." - does this metadata reading take up a significant portion of the compile time?</li>
<li>Also is there anywhere where I can see which stage of the compiler takes how much time? Or a page with instructions how to profile rustc myself?</li>
</ul>



<a name="275974674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275974674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275974674">(Mar 20 2022 at 16:22)</a>:</h4>
<p>Crate metadata loading takes ~5-10% I would expect as a wild guess. Hard to estimate as it is lazily decoded as the OS also lazily reads mmaped files.</p>



<a name="275984772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275984772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275984772">(Mar 20 2022 at 19:57)</a>:</h4>
<p>the easiest way to profile rustc is to use the perf collector locally, it's very well <a href="https://github.com/rust-lang/rustc-perf/tree/master/collector">documented here</a>, lots of instructions to profile with different tools</p>



<a name="275987128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987128">(Mar 20 2022 at 20:52)</a>:</h4>
<p><span class="user-mention" data-user-id="366040">@Vikram Pal</span> Hi, and welcome!</p>



<a name="275987144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987144">(Mar 20 2022 at 20:52)</a>:</h4>
<p>So, this inter-crate sharing idea is very embryonic; the paragraph you quoted is about as much detail as we have on it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="275987259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987259">(Mar 20 2022 at 20:54)</a>:</h4>
<p>Metadata decoding's impact varies greatly depending on the input. For very small programs, it's a non-trivial fraction. For larger programs, it's less important. Search for "metadata decoding" in the <a href="https://hackmd.io/mxdn4U58Su-UQXwzOHpHag?view">analysis</a> doc for more details.</p>



<a name="275987271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987271">(Mar 20 2022 at 20:55)</a>:</h4>
<p><code>&lt;rustc_span::SourceFile as rustc_serialize::serialize::Decodable&lt;rustc_metadata::rmeta::decoder::DecodeContext&gt;&gt;::decode</code> is one key function.</p>



<a name="275987370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987370">(Mar 20 2022 at 20:57)</a>:</h4>
<p>The sharing idea is basically just this: when compiling a multi-crate Rust programs, <code>rustc</code> is invoked separately on each crate. And almost every rustc invocation will decode the metadata for <code>std</code> and <code>alloc</code> and <code>core</code>. (The only exception would be <code>no_std</code> programs that don't use those libraries, but those are relatively rare.) Could we somehow avoid this repeated work, e.g. with some kind of compiler server that decodes that metadata once and then subsequent rustc invocations would use shared memory to access the data?</p>



<a name="275987420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987420">(Mar 20 2022 at 20:58)</a>:</h4>
<p>I'm not sure it's even worthwhile, TBH, it was just a brainstorming idea that made its way into the Compiler Ambitions document. It's also a big challenge, especially for a newcomer.</p>



<a name="275987441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987441">(Mar 20 2022 at 20:59)</a>:</h4>
<p>As for benchmarking and profiling, @lqd gave you the link to the relevant docs. I think they are pretty good, but please ask if anything is unclear.</p>



<a name="275987494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275987494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275987494">(Mar 20 2022 at 21:00)</a>:</h4>
<p>They are heavily oriented towards Linux users, with some Windows stuff.</p>



<a name="275993419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275993419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275993419">(Mar 20 2022 at 23:29)</a>:</h4>
<p>A big part of metadata decoding is remapping things like Span's and CrateNum's to match the local compilation session. This is not something that can be shared between rustc invocations.</p>



<a name="275995485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/275995485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#275995485">(Mar 21 2022 at 00:26)</a>:</h4>
<p>Interesting... maybe it's not a feasible idea, then. Though it might be worth thinking whether there are any other things shareable between rustc invocations.</p>



<a name="276067978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/276067978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#276067978">(Mar 21 2022 at 15:26)</a>:</h4>
<p>it would be really nice to have some insight into what metadata is stored in .rlib's; if we can decrease the size of the file, it would make all loading faster I think, as well as not needing to load as much data</p>



<a name="276069914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Inter%20crate%20sharing/near/276069914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Inter.20crate.20sharing.html#276069914">(Mar 21 2022 at 15:38)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/051d1176b786aadd7d7c048f822cb6bfab00fe03/compiler/rustc_metadata/src/rmeta/mod.rs#L192-L237">https://github.com/rust-lang/rust/blob/051d1176b786aadd7d7c048f822cb6bfab00fe03/compiler/rustc_metadata/src/rmeta/mod.rs#L192-L237</a> and <a href="https://github.com/rust-lang/rust/blob/051d1176b786aadd7d7c048f822cb6bfab00fe03/compiler/rustc_metadata/src/rmeta/mod.rs#L277-L328">https://github.com/rust-lang/rust/blob/051d1176b786aadd7d7c048f822cb6bfab00fe03/compiler/rustc_metadata/src/rmeta/mod.rs#L277-L328</a> list everything in the crate metadata.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>