<html>
<head><meta charset="utf-8"><title>spurious changes in non-noisy benchmarks · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html">spurious changes in non-noisy benchmarks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261521095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521095">(Nov 15 2021 at 16:23)</a>:</h4>
<p>I've been seeing several cases of spurious perf changes in non-noisy benchmarks. <a href="https://github.com/rust-lang/rust/pull/90757">Here's</a> a good example. The final change is just removing two docs in librustdoc but the perf results show fairly significance changes in three test cases (not even with the "doc" profile). This is definitely concerning, and ideally, we wouldn't see this ever.</p>



<a name="261521573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521573">(Nov 15 2021 at 16:26)</a>:</h4>
<p>Yeah, it happened again on <a href="https://github.com/rust-lang/rust/pull/90684#issuecomment-968619765">https://github.com/rust-lang/rust/pull/90684#issuecomment-968619765</a></p>



<a name="261521627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521627">(Nov 15 2021 at 16:26)</a>:</h4>
<p>Maybe you just need to change "non-noisy" to exclude those benchmarks?</p>



<a name="261521675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521675">(Nov 15 2021 at 16:27)</a>:</h4>
<p>Since the distinction seems kind of artificial in the first place; the way you determined non noisy was by finding exactly these sorts of spurious changes</p>



<a name="261521696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521696">(Nov 15 2021 at 16:27)</a>:</h4>
<p>I have the suspicion that PGO increases noise due to spooky-at-a-distance inlining changes.</p>



<a name="261521699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521699">(Nov 15 2021 at 16:27)</a>:</h4>
<p>html5ever-check got a lot noisier recently:</p>
<p><a href="/user_uploads/4715/hTZL1Y7CQ_mUK5npfLLhfS7I/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/hTZL1Y7CQ_mUK5npfLLhfS7I/image.png" title="image.png"><img src="/user_uploads/4715/hTZL1Y7CQ_mUK5npfLLhfS7I/image.png"></a></div>



<a name="261521772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521772">(Nov 15 2021 at 16:27)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> but there are <em>no</em> changes at all to the compiler in either of those PRs</p>



<a name="261521777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521777">(Nov 15 2021 at 16:27)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/90596">https://github.com/rust-lang/rust/pull/90596</a> seems plausibly suspicious here</p>



<a name="261521839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521839">(Nov 15 2021 at 16:28)</a>:</h4>
<p>So I would be shocked if this is "small changes are being amplified"</p>



<a name="261521870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521870">(Nov 15 2021 at 16:28)</a>:</h4>
<p>since the paths we're hashing comparing for things will often contain remapped debuginfo, which contains commit hashes</p>



<a name="261521922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521922">(Nov 15 2021 at 16:28)</a>:</h4>
<p>so we'll have "random noise" from how many leading bytes happen to match commit/commit, for example</p>



<a name="261521946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261521946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261521946">(Nov 15 2021 at 16:29)</a>:</h4>
<p>maybe not actually what's happening here, but it's not impossible</p>



<a name="261522056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522056">(Nov 15 2021 at 16:29)</a>:</h4>
<p>you mean the comparison, not the hashing? because hashing always examines the full length of the path.</p>



<a name="261522079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522079">(Nov 15 2021 at 16:30)</a>:</h4>
<p>Have we checked whether the same sort of noise happens if you measure the same commit twice?</p>



<a name="261522124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522124">(Nov 15 2021 at 16:30)</a>:</h4>
<p>oh, sure</p>



<a name="261522136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522136">(Nov 15 2021 at 16:30)</a>:</h4>
<p>but then after hashing there should be few comparisons so variable-length comparisons shouldn't matter...</p>



<a name="261522149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522149">(Nov 15 2021 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/spurious.20changes.20in.20non-noisy.20benchmarks/near/261521675">said</a>:</p>
<blockquote>
<p>Since the distinction seems kind of artificial in the first place; the way you determined non noisy was by finding exactly these sorts of spurious changes</p>
</blockquote>
<p>This is no longer true. We have a statistical basis for what we define as noise. See the <a href="https://github.com/rust-lang/rustc-perf/blob/master/docs/glossary.md">glossary</a>'s definition of noise.</p>



<a name="261522258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522258">(Nov 15 2021 at 16:31)</a>:</h4>
<p>what determines the <code>?</code> though?</p>



<a name="261522281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522281">(Nov 15 2021 at 16:31)</a>:</h4>
<p>How large that statistical threshold is</p>



<a name="261522505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261522505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261522505">(Nov 15 2021 at 16:32)</a>:</h4>
<p>We do arbitrarily pick the statistical threshold (at 0.2% I believe) but that's applied evenly to every <del>benchmark</del> test case</p>



<a name="261524531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261524531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261524531">(Nov 15 2021 at 16:47)</a>:</h4>
<p>Going back to my theory, it's also worth noting we run benchmarks in randomly-named /tmp/.tmpxxxxx directories</p>



<a name="261524618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261524618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261524618">(Nov 15 2021 at 16:48)</a>:</h4>
<p>so optimizations to the path comparison code can cause us to be more sensitive there.</p>



<a name="261525478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261525478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261525478">(Nov 15 2021 at 16:54)</a>:</h4>
<p>hrrm, maybe. the one big regression in <a href="https://github.com/rust-lang/rust/issues/90596">#90596</a> (which didn't show up in the initial perf run though...) is tuple-stress debug    incr-unchanged, which has most of its time increase in <code>incr_comp_query_cache_promotion</code>.<br>
<a href="https://github.com/rust-lang/rust/issues/90684">#90684</a>'s top regression spends a little more time in <code>incr_comp_persist_dep_graph</code></p>
<p>Maybe path optimizations impacted about incremental comp persistence? I don't know how it would though.</p>



<a name="261526844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261526844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261526844">(Nov 15 2021 at 17:04)</a>:</h4>
<p>maybe if there's a subtle bug that sometimes causes hash misses... but then i'd expect other things to blow up too</p>



<a name="261526889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261526889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261526889">(Nov 15 2021 at 17:04)</a>:</h4>
<p>regression in tuple-stress seems genuine based on cachegrind results</p>



<a name="261526904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261526904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261526904">(Nov 15 2021 at 17:04)</a>:</h4>
<div class="codehilite"><pre><span></span><code>200,187,078  ???:&lt;rustc_data_structures::sip128::SipHasher128&gt;::short_write_process_buffer::&lt;u64&gt;
104,399,557  ???:&lt;rustc_span::caching_source_map_view::CachingSourceMapView&gt;::span_data_to_lines_and_cols
</code></pre></div>



<a name="261526955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261526955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261526955">(Nov 15 2021 at 17:05)</a>:</h4>
<p>(amongst other regressions in other functions, but less interesting)</p>



<a name="261527211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527211">(Nov 15 2021 at 17:06)</a>:</h4>
<p>well, actually, I expected some paths to be involved there but they're not at a first glance</p>



<a name="261527552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527552">(Nov 15 2021 at 17:08)</a>:</h4>
<p>this all seems to be happening while stable-hashing spans for various other data structures (basic blocks, etc)</p>



<a name="261527759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527759">(Nov 15 2021 at 17:10)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> so maybe we're seeing that at least in tuple-stress the paths are short enough(?) or something to cause a large overhead from name hashing?</p>



<a name="261527768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527768">(Nov 15 2021 at 17:10)</a>:</h4>
<p>seems weird though.</p>



<a name="261527859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527859">(Nov 15 2021 at 17:11)</a>:</h4>
<p>The hashing shouldn't do more work, certainly not process more bytes, microbenchmarks showed it doing less. Maybe inlining changed in a detrimental way?</p>



<a name="261527951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527951">(Nov 15 2021 at 17:11)</a>:</h4>
<p>well, we pre-hash files and store a u128 hash for them and then truncate that to u64 which is fed into future hashes</p>



<a name="261527966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261527966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261527966">(Nov 15 2021 at 17:11)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/eab2d7519a3f1c11ddaff3d19f8b7727354c6362/compiler/rustc_span/src/lib.rs#L1330-L1331">https://github.com/rust-lang/rust/blob/eab2d7519a3f1c11ddaff3d19f8b7727354c6362/compiler/rustc_span/src/lib.rs#L1330-L1331</a></p>



<a name="261528025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261528025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261528025">(Nov 15 2021 at 17:12)</a>:</h4>
<p>Or updates to hash state are somehow less efficient in some edge-cases that weren't covered by the benchmarks. But again, I don't see how. Before it was hashing slices which do a length + the bytes. Now it's just doing the bytes directly which should be strictly less work.</p>



<a name="261528075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261528075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261528075">(Nov 15 2021 at 17:12)</a>:</h4>
<p>I agree it seems hard to imagine this being bad in some way</p>



<a name="261528330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261528330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261528330">(Nov 15 2021 at 17:14)</a>:</h4>
<p>the regression in tuple-stress debug though has definitely persisted</p>



<a name="261531102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261531102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261531102">(Nov 15 2021 at 17:33)</a>:</h4>
<p>If I interpret these <code>perf diff</code> results correctly it does mean some inlining changed, note the rows which have no corresponding baseline.</p>
<div class="codehilite"><pre><span></span><code># Event &#39;instructions:u&#39;
#
# Baseline  Delta Abs  Symbol                                                                                                                                                                                                                                                                                               &gt;
# ........  .........  .....................................................................................................................................................................................................................................................................................................&gt;
#
     1.90%     +3.09%  [.] &lt;rustc_data_structures::sip128::SipHasher128&gt;::short_write_process_buffer::&lt;u64&gt;
     1.28%     +2.25%  [.] &lt;rustc_span::caching_source_map_view::CachingSourceMapView&gt;::span_data_to_lines_and_cols
    12.02%     -1.43%  [.] 0x0000000000005bf6
               +1.24%  [.] &lt;rustc_index::vec::IndexVec&lt;rustc_middle::mir::BasicBlock, rustc_middle::mir::BasicBlockData&gt; as rustc_data_structures::stable_hasher::HashStable&lt;rustc_query_system::ich::hcx::StableHashingContext&gt;&gt;::hash_stable
               +0.91%  [.] &lt;&amp;rustc_middle::ty::list::List&lt;rustc_middle::mir::ProjectionElem&lt;rustc_middle::mir::Local, &amp;rustc_middle::ty::TyS&gt;&gt; as rustc_data_structures::stable_hasher::HashStable&lt;rustc_query_system::ich::hcx::StableHashingContext&gt;&gt;::hash_stable
               +0.83%  [.] &lt;&amp;rustc_middle::ty::consts::Const as rustc_data_structures::stable_hasher::HashStable&lt;rustc_query_system::ich::hcx::StableHashingContext&gt;&gt;::hash_stable
     0.21%     +0.79%  [.] &lt;rustc_data_structures::sip128::SipHasher128&gt;::short_write_process_buffer::&lt;u32&gt;
               +0.71%  [.] _RINvMs1_NtNtCskzSMKXuqLld_18rustc_query_system9dep_graph5graphINtB6_8DepGraphNtNtNtCscEF2Ad04ChB_12rustc_middle9dep_graph8dep_node7DepKindE23try_mark_previous_greenNtNtCsjzL1g3wEYIK_16rustc_query_impl8plumbing9QueryCtxtEB2G_.llvm.2919872465733405639
</code></pre></div>



<a name="261532017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261532017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261532017">(Nov 15 2021 at 17:38)</a>:</h4>
<p>I can definitely believe it, but it's also the case that we see dramatically more instructions in total</p>



<a name="261539747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261539747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261539747">(Nov 15 2021 at 18:33)</a>:</h4>
<p>Before the PR <code>path::Components::parse_next_component</code> is only called by <code>&lt;rustc_span::FileName as core::hash::Hash&gt;::hash::&lt;rustc_data_structures::stable_hasher::StableHasher&gt;</code> and that shows up as 0.0411% instructions:u (inclusive)</p>
<p>After the PR <code>&lt;rustc_span::FileName as core::hash::Hash&gt;::hash::&lt;rustc_data_structures::stable_hasher::StableHasher&gt;</code> shows 0.0301%</p>
<p>On the assumptions a) that there is no other data structure containing path that gets hashed - because I'd expect them to show up as caller of some std::path things, at least in the old profile - and b) the instructions spent on hashing don't get misattributed somewhere else, it then does look like path hashing itself did get faster and something else got affected.</p>
<p>The strange thing is that it only affects tuple stress incr unchanged negatively. But many other incr unchanged benchmarks did get faster. <span aria-label="oh no" class="emoji emoji-1f615" role="img" title="oh no">:oh_no:</span><br>
Wouldn't that mean it's data-dependent or some hashing only exercised by tuple-stress gets worse?</p>



<a name="261540588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261540588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261540588">(Nov 15 2021 at 18:40)</a>:</h4>
<p>Which spans we're hashing (and so, which files) is going to be benchmark dependent</p>



<a name="261541540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261541540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261541540">(Nov 15 2021 at 18:48)</a>:</h4>
<p>ahhh... I found a big difference.</p>
<p><code>rustc_query_system::query::plumbing::try_load_from_disk_and_cache_in_memory::&lt;rustc_query_impl::plumbing::QueryCtxt, rustc_span::def_id::DefId, &amp;rustc_middle::mir::Body&gt;</code> is dominated by <code>&lt;rustc_query_impl::on_disk_cache::OnDiskCache&gt;::try_load_query_result::&lt;&amp;rustc_middle::mir::Body&gt;</code> before the PR.</p>
<p>After the PR its instructions are split between <code>&lt;rustc_query_impl::on_disk_cache::OnDiskCache&gt;::try_load_query_result::&lt;&amp;rustc_middle::mir::Body&gt;</code> and <code>rustc_query_system::query::plumbing::incremental_verify_ich::&lt;rustc_query_impl::plumbing::QueryCtxt, rustc_span::def_id::DefId, &amp;rustc_middle::mir::Body&gt;</code></p>
<p>That's the new hash-based incremental verification, isn't it? That'd explain it.</p>



<a name="261542490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542490">(Nov 15 2021 at 18:56)</a>:</h4>
<p>hm, yeah, though I wouldn't expect such a large delta...</p>



<a name="261542573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542573">(Nov 15 2021 at 18:57)</a>:</h4>
<p>unless my probabilistic thing is just wrong somehow (quite possible)</p>



<a name="261542604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542604">(Nov 15 2021 at 18:57)</a>:</h4>
<p>we shouldn't ~ever go from "no hashing at all" to "lots of hashing", or at least, it would be somewhat unexpected</p>



<a name="261542610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542610">(Nov 15 2021 at 18:57)</a>:</h4>
<p>it's incr-unchanged, so I assume it just happened to not hash before and now it does.</p>



<a name="261542701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542701">(Nov 15 2021 at 18:58)</a>:</h4>
<p>yeah, I suppose it's possible. seems pretty surprising but not entirely impossible.</p>



<a name="261542830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542830">(Nov 15 2021 at 18:59)</a>:</h4>
<p>I mean it might just be hashing one item but it's significant enough because it doesn't have much else to do. Or because it's a stress test and it ends up being big.</p>



<a name="261542842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/spurious%20changes%20in%20non-noisy%20benchmarks/near/261542842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/spurious.20changes.20in.20non-noisy.20benchmarks.html#261542842">(Nov 15 2021 at 18:59)</a>:</h4>
<p>sure.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>