<html>
<head><meta charset="utf-8"><title>cachegrind perf triage · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html">cachegrind perf triage</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253521471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253521471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253521471">(Sep 16 2021 at 03:03)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> <span class="user-mention" data-user-id="224872">@rylev</span> <a href="https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189">https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189</a></p>



<a name="253521529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253521529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253521529">(Sep 16 2021 at 03:04)</a>:</h4>
<p>happy to answer questions of course :)</p>



<a name="253538850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253538850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253538850">(Sep 16 2021 at 07:12)</a>:</h4>
<p>could be cool to add this to perf.rlo ? :) if queries haven’t changed (or even if they have) run cachegrind on one, or a limited number since it’s going to be slower than running perf, of the significant regressions and show the head of the diff on the site</p>



<a name="253568163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253568163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253568163">(Sep 16 2021 at 11:48)</a>:</h4>
<p>Cachegrind is unfortunately quite slow, though it doesn't need to be run on dedicated hardware (since it's essentially an emulator), so we could have a separate machine (s) for this. It's probably a good bit of work to write the code to do that though.</p>



<a name="253630837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253630837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253630837">(Sep 16 2021 at 18:47)</a>:</h4>
<p>oh I'm well aware of the valgrind tools' overhead ^^ I was hoping it wasn't prohibitively slow on a single profile of a significant regression, but you can always imagine a worst case where a really slow PR + the cachegrind overhead conspire to completely block the queue. And if there were enough capacity in the queue, it'd probably be more interesting to use it to run more iterations instead of cachegrind, I presume ?</p>



<a name="253631696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253631696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253631696">(Sep 16 2021 at 18:53)</a>:</h4>
<p>I think it may be viable for us to do something like perf record (which is near-native speed) and get diffs based on that. Cachegrind is useful because it's diffs can be one the order of thousands of instructions -- which is difficult or impossible for perf record to catch.</p>



<a name="253631824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253631824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253631824">(Sep 16 2021 at 18:54)</a>:</h4>
<p>It's worth noting it's not as simple as a single profile -- you need to do at least two, probably, for the parent commit and the current one</p>



<a name="253635338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253635338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253635338">(Sep 16 2021 at 19:15)</a>:</h4>
<p>yeah, true. probably better to keep doing it manually for the short and medium term then. <code>perf diff</code> on perf.rlo also sounds worth investigating</p>



<a name="253636499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253636499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253636499">(Sep 16 2021 at 19:23)</a>:</h4>
<p>I have used perf diff before and it's hard to get it to spit out useful results. If inling changes then the property that it takes the left side as baseline and doesn't display stuff on the right side that's not in the baseline means it just displays noise because it omits one chunk and shows instructions shuffled to other methods as entirely new stuff.</p>



<a name="253636584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253636584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253636584">(Sep 16 2021 at 19:24)</a>:</h4>
<p>at least for local builds that's really problematic</p>



<a name="253636705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253636705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253636705">(Sep 16 2021 at 19:25)</a>:</h4>
<p>it's better with CI builds since they use 1CGU and aren't incremental but still leaves <code>perf diff</code>'s crazy notion of baseline.</p>



<a name="253636810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253636810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253636810">(Sep 16 2021 at 19:25)</a>:</h4>
<p>Yeah, I've had a similar experience too. Never sure if it's just my environment / bad docs or fundamental incompatibility.</p>



<a name="253638796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253638796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253638796">(Sep 16 2021 at 19:39)</a>:</h4>
<p>perf docs are the worst. It honestly feels like lore: "use these options when running perf because they give the best results"</p>



<a name="253640647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253640647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253640647">(Sep 16 2021 at 19:52)</a>:</h4>
<p>for perf it might be useful to run a benchmark in a loop to get more samples</p>



<a name="253688713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253688713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253688713">(Sep 17 2021 at 04:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/cachegrind.20perf.20triage/near/253521471">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <span class="user-mention silent" data-user-id="224872">rylev</span> <a href="https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189">https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189</a></p>
</blockquote>
<p>it might be useful to link to this on rustc-dev-guide :)</p>



<a name="253730532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/253730532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#253730532">(Sep 17 2021 at 11:58)</a>:</h4>
<p>I would not link to it -- feel free to steal it though and rewrite it :)</p>



<a name="255214991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/cachegrind%20perf%20triage/near/255214991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/cachegrind.20perf.20triage.html#255214991">(Sep 28 2021 at 13:22)</a>:</h4>
<p>With recent changes to rustc-perf in <a href="https://github.com/rust-lang/rustc-perf/issues/1025">rustc-perf#1025</a> &amp; <a href="https://github.com/rust-lang/rustc-perf/issues/1028">rustc-perf#1028</a>, this work flow is now directly incorporated into perf collector. Following command automatically installs the toolchains, runs the benchmarks, generates and annotates the cachegrind diff:</p>
<div class="codehilite"><pre><span></span><code>cargo run --release --bin collector -- diff_local cachegrind --builds Check --runs Full --include stm32f4 \
  +718d53b0cb7dde93499cb92950d60b412f5a3d05 \
  +da7d405357600a76f2b93b8aa41fe5ee5da7885d
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>