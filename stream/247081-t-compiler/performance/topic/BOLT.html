<html>
<head><meta charset="utf-8"><title>BOLT · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html">BOLT</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272881979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272881979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272881979">(Feb 22 2022 at 23:35)</a>:</h4>
<p>If you want a somewhat 'different' task, it might be a fun project to integrate BOLT into the src/ci/pgo.sh script -- it recently landed in LLVM 14. It'll likely require some work to wire everything up, though.</p>



<a name="272882084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882084">(Feb 22 2022 at 23:36)</a>:</h4>
<p>I actually tried that a few days ago, but failed rather quickly because I have an AMD processor :( It seemed to me that BOLT requires Intel LBR. well I couldn't get it to work properly with AMD.</p>



<a name="272882105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882105">(Feb 22 2022 at 23:36)</a>:</h4>
<p>Huh, interesting</p>



<a name="272882193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882193">(Feb 22 2022 at 23:37)</a>:</h4>
<p>It looks like they support perf-record mode with LBR, but also instrumenting a binary directly?</p>



<a name="272882202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882202">(Feb 22 2022 at 23:37)</a>:</h4>
<p>The latter might be something we can use</p>



<a name="272882232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882232">(Feb 22 2022 at 23:38)</a>:</h4>
<p><a href="https://github.com/llvm/llvm-project/commit/4c106cfdf7cf7eec861ad3983a3dd9a9e8f3a8ae#diff-b00163f1bb0908d1d4b83db158ee13e330dd13877b3b292ea9883e10efd59d25R138-R149">https://github.com/llvm/llvm-project/commit/4c106cfdf7cf7eec861ad3983a3dd9a9e8f3a8ae#diff-b00163f1bb0908d1d4b83db158ee13e330dd13877b3b292ea9883e10efd59d25R138-R149</a></p>



<a name="272882295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882295">(Feb 22 2022 at 23:38)</a>:</h4>
<p>But disregarding the fact that I can't run BOLT locally with perf, there are some changes that need to be done to rustc to make it work with BOLT, I think that one of them was adding supoprt for relocations, I can try to look at that.</p>



<a name="272882394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882394">(Feb 22 2022 at 23:39)</a>:</h4>
<p>You're right, that is an alternative. I think that I tried that and got an error that some linker parameter was not used when building <code>rustc</code>, so I guess that could be the next step on what to investigate.</p>



<a name="272882552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882552">(Feb 22 2022 at 23:41)</a>:</h4>
<p>BTW I suppose that we want to "BOLTify" the shared libraries, not the main <code>rustc</code> executable, since that just contains some thin driver wrapper?</p>



<a name="272882620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882620">(Feb 22 2022 at 23:42)</a>:</h4>
<p>Yeah, probably. I'm not sure the extent to which those are separable or not, but the shared libraries are were the bulk of the work is.</p>



<a name="272882673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882673">(Feb 22 2022 at 23:42)</a>:</h4>
<p>FWIW, one thing that I have found is sometimes easier is starting with the LLVM part of this -- if we can BOLT just LLVM, that'll already be a good win I suspect</p>



<a name="272882686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882686">(Feb 22 2022 at 23:42)</a>:</h4>
<p>and since it's C++ code and in the same project, it may be much easier to do that.</p>



<a name="272882710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882710">(Feb 22 2022 at 23:42)</a>:</h4>
<p>(i.e., just configuring LLVM's build system, for example)</p>



<a name="272882890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272882890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272882890">(Feb 22 2022 at 23:44)</a>:</h4>
<p>So currently on CI when a build is performed, LLVM is first instrumented with PGO (while being invoked by rustc), then LLVM is rebuilt with the profiling data and then this optimized LLVM build is used for <code>rustc</code>?</p>



<a name="272883042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272883042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272883042">(Feb 22 2022 at 23:46)</a>:</h4>
<p>(I assume that's how it would work with BOLT, so I want to confirm whether I understand the current situation, I seem to recall that PGO is being used currently for both LLVM and rustc on CI)</p>



<a name="272888316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272888316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272888316">(Feb 23 2022 at 00:49)</a>:</h4>
<p>LLVM and rustc are both built with instrumentation, then we run some benchmarks to collect data, then both are rebuilt</p>



<a name="272913588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272913588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272913588">(Feb 23 2022 at 07:39)</a>:</h4>
<p>Ok, I will start with BOLTifying LLVM then and see how far I get. Do I remember correctly that the custom Rust CI machines use Ryzen, therefore we won't be able to use LBR on CI?</p>



<a name="272915215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272915215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272915215">(Feb 23 2022 at 08:03)</a>:</h4>
<p>I seem to recall the perf collector server being a zen2, and for CI: if we're still using the regular hosted GHA runners, dv2 or dsv2, those are intel only IIRC</p>



<a name="272915743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/272915743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#272915743">(Feb 23 2022 at 08:11)</a>:</h4>
<p>GHA doesn't allow perf I believe.</p>



<a name="273290762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/273290762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#273290762">(Feb 25 2022 at 22:04)</a>:</h4>
<p>So far I have managed to instrument <a href="http://libLLVM.so">libLLVM.so</a> with BOLT and then apply the generated profiling data to create an optimized library. Further progress is probably blocked until LLVM 14 is released (and used in CI scripts), to avoid the hassle of building BOLT separately on CI (it will be in tree with LLVM 14).</p>



<a name="273290926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/273290926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#273290926">(Feb 25 2022 at 22:06)</a>:</h4>
<p>Although I'm probably mixing up LLVM used for bootstrap in CI and the LLVM built by <code>x.py build/dist</code>, because the LLVM submodule that is inside the <code>rust</code> repo already has the <code>bolt</code> directory.</p>



<a name="273292682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/273292682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#273292682">(Feb 25 2022 at 22:21)</a>:</h4>
<p><span class="user-mention" data-user-id="266526">@Jakub Beránek</span> It might be possible to do a draft PR that points to a different LLVM, and test it (including perf) that way.</p>



<a name="273292740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/273292740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#273292740">(Feb 25 2022 at 22:22)</a>:</h4>
<p>And also, yeah, you want to be using the LLVM submodule from the Rust repo, I think.</p>



<a name="273293208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/273293208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#273293208">(Feb 25 2022 at 22:26)</a>:</h4>
<p>Yes, we already use LLVM 14 for rust's own bootstrap</p>



<a name="274317337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/274317337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#274317337">(Mar 06 2022 at 17:13)</a>:</h4>
<p><a href="https://perf.rust-lang.org/compare.html?start=5d9d1e88910f2c7f58e8258b87d30b1340b647fa&amp;end=2e6d9eaae77560cdad01ed7836ae6ceb0f0cc988">https://perf.rust-lang.org/compare.html?start=5d9d1e88910f2c7f58e8258b87d30b1340b647fa&amp;end=2e6d9eaae77560cdad01ed7836ae6ceb0f0cc988</a> First promising results of applying BOLT to an already PGOed LLVM. Instructions counts are largely the same, but cycles reduced by up to 10 %, Max RSS by up to 20 % and bootstrap down by ~24 seconds.</p>



<a name="274318243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/274318243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#274318243">(Mar 06 2022 at 17:31)</a>:</h4>
<p>Although, I should check how much of that is caused by BOLT and how much by upgrading bootstrap LLVM <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="274319632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/274319632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#274319632">(Mar 06 2022 at 18:02)</a>:</h4>
<p>Let's check: <a href="https://github.com/rust-lang/rust/pull/94677">https://github.com/rust-lang/rust/pull/94677</a></p>



<a name="277288844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/277288844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#277288844">(Mar 31 2022 at 14:22)</a>:</h4>
<p><a href="https://research.facebook.com/publications/vespa-static-profiling-for-binary-optimization/">https://research.facebook.com/publications/vespa-static-profiling-for-binary-optimization/</a> Uhh. Meta keeps producing these papers and optimizers faster than we can integrate them into Rust :D</p>



<a name="277289589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/277289589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#277289589">(Mar 31 2022 at 14:26)</a>:</h4>
<p>and there was another PGO-without-actually-profiling paper that looked nice if you want more of those :3</p>



<a name="277290165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/277290165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#277290165">(Mar 31 2022 at 14:30)</a>:</h4>
<p>I'll be happy if we manage to integrate BOLT first :D</p>



<a name="277290625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/277290625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#277290625">(Mar 31 2022 at 14:33)</a>:</h4>
<p>same :)</p>



<a name="277290841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/277290841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#277290841">(Mar 31 2022 at 14:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/BOLT/near/277289589">said</a>:</p>
<blockquote>
<p>and there was another PGO-without-actually-profiling paper that looked nice if you want more of those :3</p>
</blockquote>
<p><a href="https://arxiv.org/abs/2112.14679">https://arxiv.org/abs/2112.14679</a> you mean?</p>



<a name="277290894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/BOLT/near/277290894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/BOLT.html#277290894">(Mar 31 2022 at 14:35)</a>:</h4>
<p>yes, also from FB</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>