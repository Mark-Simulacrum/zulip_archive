<html>
<head><meta charset="utf-8"><title>LTO · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html">LTO</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260878731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260878731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260878731">(Nov 09 2021 at 23:38)</a>:</h4>
<p>Is rustc itself built with LTO?</p>



<a name="260879156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260879156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260879156">(Nov 09 2021 at 23:43)</a>:</h4>
<p>x86_64-unknown-linux-gnu currently has std built with CGU=1, LLVM is ThinLTO'd and PGO'd, and rustc itself is PGO'd and I think ThinLTO'd (like all rust compilations) within each crate's codegen units but not across crates</p>



<a name="260879174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260879174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260879174">(Nov 09 2021 at 23:43)</a>:</h4>
<p>src/ci/pgo.sh may be a helpful reference</p>



<a name="260879900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260879900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260879900">(Nov 09 2021 at 23:51)</a>:</h4>
<p>Lovely, thanks</p>



<a name="260880153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260880153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260880153">(Nov 09 2021 at 23:53)</a>:</h4>
<p>Wait, ThinLTO is on by default? Is that new?</p>



<a name="260880259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260880259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260880259">(Nov 09 2021 at 23:54)</a>:</h4>
<p>Hm. I think it's always been the case within a crate</p>



<a name="260880266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260880266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260880266">(Nov 09 2021 at 23:54)</a>:</h4>
<p>after we moved the cgu default to 16</p>



<a name="260880335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260880335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260880335">(Nov 09 2021 at 23:55)</a>:</h4>
<p>I have worked a bit on getting rustc built with (cross-crate) thin LTO (not PR ready yet) and preliminary results are promising. Of course rustc and rustdoc are about ~150MiB with LTO. I can open a draft PR (without proper rustbuild integration) so we can do a perf run.</p>



<a name="260880343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260880343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260880343">(Nov 09 2021 at 23:55)</a>:</h4>
<p>yeah, so this PR implies <a href="https://github.com/rust-lang/rust/pull/46910">https://github.com/rust-lang/rust/pull/46910</a></p>



<a name="260880638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260880638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260880638">(Nov 09 2021 at 23:58)</a>:</h4>
<p>I'm confused by the conflicting answers</p>



<a name="260881026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260881026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260881026">(Nov 10 2021 at 00:01)</a>:</h4>
<p>Rust does "thin-local LTO" so that it can optimize across cgu boundaries within a crate. That is what we use for rustc. We don't do any cross-crate LTO at the moment.</p>



<a name="260881229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260881229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260881229">(Nov 10 2021 at 00:03)</a>:</h4>
<p>Ah, "thin LTO" != "thin-local LTO", thanks</p>



<a name="260881341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260881341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260881341">(Nov 10 2021 at 00:04)</a>:</h4>
<p>So rustc uses thin-local LTO, but not thin LTO, sounds like</p>



<a name="260881351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/LTO/near/260881351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/LTO.html#260881351">(Nov 10 2021 at 00:04)</a>:</h4>
<p>yeah, I think that's right</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>