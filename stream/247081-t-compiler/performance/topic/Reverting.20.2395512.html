<html>
<head><meta charset="utf-8"><title>Reverting #95512 · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html">Reverting #95512</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278531577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278531577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278531577">(Apr 11 2022 at 10:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95512">#95512</a> was a caused of a <a href="https://github.com/rust-lang/rust/pull/95667#issuecomment-1088748929">serious perf regression</a> (note the PR was merged through a rollup). Do we want to revert this PR until we can land it with less of a perf impact?</p>



<a name="278531735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278531735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278531735">(Apr 11 2022 at 10:04)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116107">@davidtwco</span></p>



<a name="278531824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278531824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278531824">(Apr 11 2022 at 10:05)</a>:</h4>
<p>Unfortunately, there are no clear and obvious ways to improve the perf here both bootstrapping wise and compiler perf.</p>



<a name="278532162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278532162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278532162">(Apr 11 2022 at 10:08)</a>:</h4>
<p>(as a note I did make <a href="https://github.com/zbraniecki/unic-locale/issues/66">an issue</a> which would get rid of the <code>proc_macro_hack</code> dependency but I'm pretty sure this won't help bootstrapping very much)</p>



<a name="278532383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278532383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278532383">(Apr 11 2022 at 10:11)</a>:</h4>
<p>I think we can improve the impact on compiler performance:</p>
<p>Most of what the pull request does should be neutral, it's just changing APIs and macros that generate calls to those APIs, the thing that's likely causing the impact is that we're now loading the Fluent resources (the file with the diagnostic messages in it) for the default locale at the start of every compilation session. I should be able to find a way to avoid doing that and just load it the first time that we need it - when there's definitely going to be an error, so happy path compilation sessions shouldn't have any performance impact.</p>
<p>Bootstrapping performance is tougher, I introduce new dependencies, that's inherently going to add bootstrapping time, I've tried to avoid adding anything that wasn't strictly necessary, but there are transitive dependencies and I've not spent time trying to trim those down in the upstream projects - might be possible, might not.</p>



<a name="278532498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278532498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278532498">(Apr 11 2022 at 10:12)</a>:</h4>
<p>If there's no major rush here then I should be able to have a pull request up with that change within a day or two and we can see if it helps.</p>



<a name="278532534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278532534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278532534">(Apr 11 2022 at 10:12)</a>:</h4>
<p>Sounds good. My only worry is that if we ultimately need to rollback, the longer we wait the harder it becomes which means there's a tiny bit of urgency, but I think a day or two is fine.</p>



<a name="278532639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278532639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278532639">(Apr 11 2022 at 10:13)</a>:</h4>
<p>If I'm right about where the slow down is and can't fix it easily, then I could probably write a patch that stops translation working but avoids that performance hit without having to roll it all back.</p>



<a name="278532828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278532828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278532828">(Apr 11 2022 at 10:15)</a>:</h4>
<p>That might be a good stop gap</p>



<a name="278664334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278664334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278664334">(Apr 12 2022 at 08:50)</a>:</h4>
<p><span class="user-mention" data-user-id="224872">@rylev</span> was slightly trickier than I anticipated, but <a href="https://github.com/rust-lang/rust/issues/95968">#95968</a> will hopefully help</p>



<a name="278664625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278664625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278664625">(Apr 12 2022 at 08:53)</a>:</h4>
<p>Cool! Thanks. I'll kick off a perf run.</p>



<a name="278683247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Reverting%20%2395512/near/278683247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Reverting.20.2395512.html#278683247">(Apr 12 2022 at 12:10)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/95968#issuecomment-1096609796">Perf result</a> looks really great!  <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> If we <a href="https://perf.rust-lang.org/compare.html?start=949b98cab8a186b98bf87e64374b8d0848c55271&amp;end=9dc3dee37922f95ff26fc636c1692ebabd993816&amp;stat=instructions%3Au">compare this change to the perf right before the fluent change was added</a> we're at a slight perf improvement overall, and when only primary benchmarks are looked at, the improvements are even better. I definitely think we're going to want to ship this.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>