<html>
<head><meta charset="utf-8"><title>why no perf runs on rollup PRs before merge? · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html">why no perf runs on rollup PRs before merge?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274753484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274753484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274753484">(Mar 09 2022 at 21:16)</a>:</h4>
<blockquote>
<p>(Also, can someone remind me: Do we not do perf runs on rollups ahead of time because ... it would overload the perf runner? Because people doing rollups would not know what to do with the results? I'm having difficulty understanding why we wouldn't do this safeguard <em>ahead</em> of time here.)</p>
</blockquote>
<p>To be clear, there are three interesting outcomes I can foresee if we started doing the perf run ahead of time:</p>
<ul>
<li>pre-merge run says no regression, and merge run says regression. We would investigate but it would definitely provide some initial evidence that noise/nondeterminism is to blame.</li>
<li>pre-merge run says regression, but it is deemed acceptable. Merge run will either register a less-or-equal regression (which we will then continue to treat as acceptable), or the merge run will say it had greater regression. Which would again yield an investigation, but hopefully a more informed one. (and also, it would provide some rough idea that <em>some</em> amount of regression was considered acceptable.)</li>
<li>pre-merge run says regression, and it is deemed inacceptable. Thus, PR doesn't land in that state. That's a win, in my opinion.</li>
</ul>



<a name="274756478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274756478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274756478">(Mar 09 2022 at 21:42)</a>:</h4>
<p>It takes at minimum ~3 hours for a perf run to complete with current CI and perf hardware (both parts could be made faster with extra resources, probably; some people/engineering cost involved too), so by the time that would have finished the rollup has spent enough time that there's probably a larger rollup <em>possible</em></p>



<a name="274756498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274756498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274756498">(Mar 09 2022 at 21:42)</a>:</h4>
<p>(And the person making the rollup has gone on and is doing other things).</p>



<a name="274756875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274756875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274756875">(Mar 09 2022 at 21:46)</a>:</h4>
<p>okay. I can understand that reasoning. (And of course, sequencing the perf runs on actual merges to master ensures that there is a sensible queue dictating that workload)</p>



<a name="274757219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274757219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274757219">(Mar 09 2022 at 21:49)</a>:</h4>
<p>it does lead to this state where when a rollup PR <em>is</em> associated with a performance regression, there's some amount of work attached to "is there any PR here that can be readily identified as the cause", and then if that fails, it turns into "okay, so do I just chalk this up to the usual random noise caused by code placement, inlining decisions, etc..."</p>



<a name="274757315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274757315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274757315">(Mar 09 2022 at 21:50)</a>:</h4>
<p>(a question which would arise regardless of <em>when</em> the perf runs are done)</p>



<a name="274757424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274757424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274757424">(Mar 09 2022 at 21:51)</a>:</h4>
<p>Absolutely. I think there's a lot of value in making CI fast enough to where rollups aren't necessary -- or at least, much more infrequent -- and I am pretty confident we could get there with some (not insignificant, but not <em>enormous</em> investment).</p>



<a name="274757456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274757456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274757456">(Mar 09 2022 at 21:51)</a>:</h4>
<p>(The problem you describe is not all that unique to rollups, just exacerbated by the larger amount of changes and diffusion of responsibility).</p>



<a name="274757475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274757475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274757475">(Mar 09 2022 at 21:51)</a>:</h4>
<p>yes exactly; I'm coming around to that viewpoint that this is <em>not really</em> about rollups</p>



<a name="274818477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274818477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274818477">(Mar 10 2022 at 10:53)</a>:</h4>
<p>could we start the ci for the merge and a perf run at the same time and fail the merge if there is a noticeable perf impact?</p>



<a name="274818834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/274818834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#274818834">(Mar 10 2022 at 10:57)</a>:</h4>
<p>I don't think so. Doing a perf run will first require a try build. By the time both the try build and the perf run are done I am pretty sure a regular r+ would have already finished for like an hour. Also the perf run may not be able to start immediately due to still benchmarking the previous merged PR.</p>



<a name="276421599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/276421599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#276421599">(Mar 24 2022 at 00:50)</a>:</h4>
<p>This may just be my perspective but I think one of the more common friction points nowadays is "something that works on x86 doesn't work on aarch64" or vice versa, and I think we might significantly reduce thrash in PRs if one of the initial builders (alongside the tool check, etc.) was an aarch64 one, but I don't know about the spare resources for that.</p>
<p>This isn't really about performance per se or even rollups but about making the PR queue "smoother" so that less clogging events happen that require rollups to address.</p>



<a name="276436501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/276436501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#276436501">(Mar 24 2022 at 06:18)</a>:</h4>
<p>This may be my perspective and the kinds of PRs I primarily review, but I've noticed few failures due to CPU differences, and far more due to OS differences; for instance, code that fails on WebAssembly, or Android, or macOS.</p>



<a name="276519707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/why%20no%20perf%20runs%20on%20rollup%20PRs%20before%20merge%3F/near/276519707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/why.20no.20perf.20runs.20on.20rollup.20PRs.20before.20merge.3F.html#276519707">(Mar 24 2022 at 18:21)</a>:</h4>
<p>Yeah, I was thinking aarch64-android might be nice, actually (aarch64-darwin honestly would be my first choice but uhhhhhhhh, finding spare builders for that...?).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>